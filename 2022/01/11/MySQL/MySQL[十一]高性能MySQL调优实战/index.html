<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MySQL[十一]高性能MySQL调优实战 | 二十</title><meta name="keywords" content="MySQL"><meta name="author" content="二十"><meta name="copyright" content="二十"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="高性能MySQL调优实战">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL[十一]高性能MySQL调优实战">
<meta property="og:url" content="https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E5%8D%81%E4%B8%80]%E9%AB%98%E6%80%A7%E8%83%BDMySQL%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="二十">
<meta property="og:description" content="高性能MySQL调优实战">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yinhuidong.github.io/images/cover/mysql.png">
<meta property="article:published_time" content="2022-01-10T16:00:00.000Z">
<meta property="article:modified_time" content="2022-01-12T00:42:24.249Z">
<meta property="article:author" content="二十">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yinhuidong.github.io/images/cover/mysql.png"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E5%8D%81%E4%B8%80]%E9%AB%98%E6%80%A7%E8%83%BDMySQL%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":800},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL[十一]高性能MySQL调优实战',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-01-12 08:42:24'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="referrer" content="no-referrer" /><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">119</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/%E5%85%B3%E4%BA%8E%E6%88%91/"><i class="fa-fw fas fa-user"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/cover/mysql.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">二十</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/%E5%85%B3%E4%BA%8E%E6%88%91/"><i class="fa-fw fas fa-user"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MySQL[十一]高性能MySQL调优实战</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-01-10T16:00:00.000Z" title="发表于 2022-01-11 00:00:00">2022-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-01-12T00:42:24.249Z" title="更新于 2022-01-12 08:42:24">2022-01-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/MySQL/">MySQL</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MySQL[十一]高性能MySQL调优实战"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一，数据库应该如何优化"><a href="#一，数据库应该如何优化" class="headerlink" title="一，数据库应该如何优化"></a>一，数据库应该如何优化</h1><p>数据库优化有很多层面。</p>
<h2 id="1-SQL与索引"><a href="#1-SQL与索引" class="headerlink" title="1.SQL与索引"></a>1.SQL与索引</h2><p>因为 SQL 语句是在我们的应用端编写的，所以第一步，我们可以在程序中对 SQL 语句进行优化，最终的目标是用到索引。这个是容易的也是最常用的优化手段。</p>
<h2 id="2-表与存储引擎"><a href="#2-表与存储引擎" class="headerlink" title="2.表与存储引擎"></a>2.表与存储引擎</h2><p>数据是存放在表里面的，表又是以不同的格式存放在存储引擎中的，所以我们可以选用特定的存储引擎，或者对表进行分区，对表结构进行拆分或者冗余处理，或者对表结构比如字段的定义进行优化。</p>
<h2 id="3-架构"><a href="#3-架构" class="headerlink" title="3.架构"></a>3.架构</h2><p>对于数据库的服务，我们可以对它的架构进行优化。如果只有一台数据库的服务器，我们可以运行多个实例，做集群的方案，做负载均衡。或者基于主从复制实现读写分离，让写的服务都访问 master 服务器，读的请求都访问从服务器，slave 服务器自动 master 主服务器同步数据。或者在数据库前面加一层缓存，达到减少数据库的压力，提升访问速度的目的。为了分散数据库服务的存储压力和访问压力，我们也可以把不同的数据分布到不同的服务节点，这个就是分库分表（scale out）。</p>
<p>注意主从（replicate）和分片（shard）的区别：</p>
<ol>
<li> 主从通过数据冗余实现高可用，和实现读写分离。 </li>
<li> 分片通过拆分数据分散存储和访问压力。 </li>
</ol>
<h2 id="4-配置"><a href="#4-配置" class="headerlink" title="4.配置"></a>4.配置</h2><p>数据库配置的优化，比如连接数，缓冲区大小等等，优化配置的目的都是为了更高效地利用硬件。</p>
<h2 id="5-操作系统与硬件"><a href="#5-操作系统与硬件" class="headerlink" title="5.操作系统与硬件"></a>5.操作系统与硬件</h2><p>从上往下，成本收益比慢慢地在增加。所以肯定不是查询一慢就堆硬件，堆硬件叫做向上的扩展（scale up）。</p>
<h1 id="二，慢日志查询"><a href="#二，慢日志查询" class="headerlink" title="二，慢日志查询"></a>二，慢日志查询</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h2><p>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过<code>long_query_time</code>值的SQL，则会被记录到慢查询日志中。<code>long_query_time</code>的默认值为10，意思是运行10秒以上的语句。由他来查看哪些SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql，结合explain进行全面分析。</p>
<h2 id="2-实操"><a href="#2-实操" class="headerlink" title="2.实操"></a>2.实操</h2><p>默认情况下，MySQL数据库没有开启慢查询日志，需要我们手动来设置这个参数。</p>
<p>当然，如果不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件。</p>
<h3 id="2-1查看及开启"><a href="#2-1查看及开启" class="headerlink" title="2.1查看及开启"></a>2.1查看及开启</h3><h4 id="①日志"><a href="#①日志" class="headerlink" title="①日志"></a>①日志</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#x27;%slow_query_log%&#x27;;</span><br></pre></td></tr></table></figure>


<p>默认情况下slow_query_log的值为OFF，表示慢查询日志是禁用的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global slow_query_log=1;</span><br></pre></td></tr></table></figure>


<p>只对窗口生效，重启服务失效。</p>
<h4 id="②时间"><a href="#②时间" class="headerlink" title="②时间"></a>②时间</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#x27;%long_query_time%&#x27;;</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL long_query_time=0.1;</span><br></pre></td></tr></table></figure>


<p>全局变量设置，对所有客户端有效。但必须是设置后进行登录的客户端。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET SESSION long_query_time=0.1; #session可省略</span><br></pre></td></tr></table></figure>


<p>对当前会话连接立即生效，对其他客户端无效。</p>
<p><strong>假如运行时间正好等于long_query_time的情况，并不会被记录下来。也就是说，在mysql源码里是判断大于long_query_time，而非大于等于。</strong></p>
<h4 id="③永久生效"><a href="#③永久生效" class="headerlink" title="③永久生效"></a>③永久生效</h4><p>修改配置文件my.cnf（其它系统变量也是如此）</p>
<p>[mysqld]下增加或修改参数</p>
<p>slow_query_log 和slow_query_log_file后，然后重启MySQL服务器。也即将如下两行配置进my.cnf文件 <a href="#fn1">[1]</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">slow_query_log =1</span><br><span class="line">slow_query_log_file=/var/lib/mysql/yhd-slow.log </span><br><span class="line">long_query_time=3</span><br><span class="line">log_output=FILE</span><br></pre></td></tr></table></figure>


<h3 id="2-2Case"><a href="#2-2Case" class="headerlink" title="2.2Case"></a>2.2Case</h3><p>记录慢SQL并后续分析</p>
<p>查询当前系统中有多少条慢查询记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW GLOBAL STATUS LIKE &#x27;%Slow_queries%&#x27;;</span><br></pre></td></tr></table></figure>


<h2 id="3-日志分析工具-mysqldumpslow"><a href="#3-日志分析工具-mysqldumpslow" class="headerlink" title="3.日志分析工具-mysqldumpslow"></a>3.日志分析工具-mysqldumpslow</h2><p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具<code>mysqldumpslow</code>。</p>
<p>查看mysqldumpslow的帮助信息（windows下需要安装perl环境）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow --help</span><br></pre></td></tr></table></figure>


<blockquote>
<p>-a: 不将数字抽象成N，字符串抽象成S<br>-s: 是表示按照何种方式排序；<br>c: 访问次数<br>l: 锁定时间<br>r: 返回记录<br>t: 查询时间<br>al:平均锁定时间<br>ar:平均返回记录数<br>at:平均查询时间<br>-t: 即为返回前面多少条的数据；<br>-g: 后边搭配一个正则匹配模式，大小写不敏感的；</p>
</blockquote>
<h3 id="3-1常用SQL"><a href="#3-1常用SQL" class="headerlink" title="3.1常用SQL"></a>3.1常用SQL</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">得到返回记录集最多的10个SQL</span><br><span class="line">mysqldumpslow -s r -t 10 /var/lib/mysql/yhd-slow.log</span><br><span class="line">得到访问次数最多的10个SQL</span><br><span class="line">mysqldumpslow -s c -t 10 /var/lib/mysql/yhd-slow.log</span><br><span class="line">得到按照时间排序的前10条里面含有左连接的查询语句</span><br><span class="line">mysqldumpslow -s t -t 10 -g &quot;left join&quot; /var/lib/mysql/yhd-slow.log</span><br><span class="line">另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现爆屏情况</span><br><span class="line">mysqldumpslow -s r -t 10 /var/lib/mysql/yhd-slow.log | more</span><br></pre></td></tr></table></figure>


<h2 id="4-SHOW-PROCESSLIST"><a href="#4-SHOW-PROCESSLIST" class="headerlink" title="4.SHOW PROCESSLIST"></a>4.SHOW PROCESSLIST</h2><p>作用：查询所有用户正在干什么。</p>
<p>如果出现不顺眼的：kill [id]</p>
<h1 id="三，EXPLAIN调优实战"><a href="#三，EXPLAIN调优实战" class="headerlink" title="三，EXPLAIN调优实战"></a>三，EXPLAIN调优实战</h1><h2 id="1-准备数据"><a href="#1-准备数据" class="headerlink" title="1.准备数据"></a>1.准备数据</h2><p>员工表插入500w数据，部门表插入10w数据。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `dept`</span><br><span class="line">(</span><br><span class="line">    `id`       <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `deptName` <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `address`  <span class="type">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `ceo`      <span class="type">INT</span>     <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> INNODB</span><br><span class="line">  AUTO_INCREMENT <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `emp`</span><br><span class="line">(</span><br><span class="line">    `id`     <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `empno`  <span class="type">INT</span>     <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `name`   <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `age`    <span class="type">INT</span>(<span class="number">3</span>)      <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `deptId` <span class="type">INT</span>(<span class="number">11</span>)     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">    #<span class="keyword">CONSTRAINT</span> `fk_dept_id` <span class="keyword">FOREIGN</span> KEY (`deptId`) <span class="keyword">REFERENCES</span> `t_dept` (`id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> INNODB</span><br><span class="line">  AUTO_INCREMENT <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line">#生成随机字符串</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> rand_string(n <span class="type">INT</span>) <span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">255</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> chars_str <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> return_str <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">    WHILE i <span class="operator">&lt;</span> n</span><br><span class="line">        DO</span><br><span class="line">            <span class="keyword">SET</span> return_str <span class="operator">=</span> CONCAT(return_str, <span class="built_in">SUBSTRING</span>(chars_str, <span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> RAND() <span class="operator">*</span> <span class="number">52</span>), <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">END</span> WHILE;</span><br><span class="line">    <span class="keyword">RETURN</span> return_str;</span><br><span class="line"><span class="keyword">END</span> $$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#用于随机产生多少到多少的编号</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> rand_num(from_num <span class="type">INT</span>, to_num <span class="type">INT</span>) <span class="keyword">RETURNS</span> <span class="type">INT</span>(<span class="number">11</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">SET</span> i <span class="operator">=</span> <span class="built_in">FLOOR</span>(from_num <span class="operator">+</span> RAND() <span class="operator">*</span> (to_num <span class="operator">-</span> from_num <span class="operator">+</span> <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">RETURN</span> i;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建往emp表中插入数据的存储过程</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> insert_emp(<span class="keyword">START</span> <span class="type">INT</span>, max_num <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>; #设置手动提交事务</span><br><span class="line">    REPEAT</span><br><span class="line">        #循环</span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>; #赋值</span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp (empno, NAME, age, deptid)</span><br><span class="line">        <span class="keyword">VALUES</span> ((<span class="keyword">START</span> <span class="operator">+</span> i), rand_string(<span class="number">6</span>), rand_num(<span class="number">30</span>, <span class="number">50</span>), rand_num(<span class="number">1</span>, <span class="number">10000</span>));</span><br><span class="line">    UNTIL i <span class="operator">=</span> max_num</span><br><span class="line">        <span class="keyword">END</span> REPEAT;</span><br><span class="line">    <span class="keyword">COMMIT</span>; #提交事务</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建往dept表中插入数据的存储过程</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> `insert_dept`(max_num <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    REPEAT</span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> dept (deptname, address, ceo) <span class="keyword">VALUES</span> (rand_string(<span class="number">8</span>), rand_string(<span class="number">10</span>), rand_num(<span class="number">1</span>, <span class="number">500000</span>));</span><br><span class="line">    UNTIL i <span class="operator">=</span> max_num</span><br><span class="line">        <span class="keyword">END</span> REPEAT;</span><br><span class="line">    <span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#执行存储过程，往dept表添加<span class="number">10</span>万条数据</span><br><span class="line"><span class="keyword">CALL</span> insert_dept(<span class="number">100000</span>);</span><br><span class="line">#执行存储过程，往emp表添加<span class="number">500</span>万条数据</span><br><span class="line"><span class="keyword">CALL</span> insert_emp(<span class="number">100000</span>, <span class="number">5000000</span>);</span><br></pre></td></tr></table></figure>


<h2 id="2-批量删除索引"><a href="#2-批量删除索引" class="headerlink" title="2.批量删除索引"></a>2.批量删除索引</h2><p><strong>建立好的索引在哪里？</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> t_emp ; <span class="comment">-- 只能查看索引，但不能删除。</span></span><br><span class="line">information_schema.STATISTICS <span class="comment">-- 存储索引的表（元数据库，统计表），我们可以对表数据进行删除操作。</span></span><br></pre></td></tr></table></figure>


<p><strong>知识点</strong></p>
<ol>
<li>删除某一个索引</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP INDEX idx_xxx ON emp</span><br></pre></td></tr></table></figure>


<ol start="2">
<li>查出该表有哪些索引，索引名–&gt;集合</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> t_emp</span><br><span class="line"><span class="comment">-- 元数据：meta DATA  描述数据的数据</span></span><br><span class="line"><span class="keyword">SELECT</span> index_name</span><br><span class="line"><span class="keyword">FROM</span> information_schema.STATISTICS</span><br><span class="line"><span class="keyword">WHERE</span> table_name <span class="operator">=</span> <span class="string">&#x27;t_emp&#x27;</span></span><br><span class="line">  <span class="keyword">AND</span> table_schema <span class="operator">=</span> <span class="string">&#x27;mydb&#x27;</span></span><br><span class="line">  <span class="keyword">AND</span> index_name <span class="operator">&lt;&gt;</span> <span class="string">&#x27;PRIMARY&#x27;</span></span><br><span class="line">  <span class="keyword">AND</span> seq_in_index <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>


<h2 id="3-单表使用索引"><a href="#3-单表使用索引" class="headerlink" title="3.单表使用索引"></a>3.单表使用索引</h2><p>建立索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_age_deptid_name <span class="keyword">ON</span> emp(age,deptid,NAME);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name <span class="keyword">ON</span> emp(NAME);</span><br></pre></td></tr></table></figure>


<h3 id="3-1-全值匹配"><a href="#3-1-全值匹配" class="headerlink" title="3.1 全值匹配"></a>3.1 全值匹配</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 单表查询<span class="operator">-</span>全值匹配</span><br><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> emp</span><br><span class="line"><span class="keyword">WHERE</span> emp.age <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> emp</span><br><span class="line"><span class="keyword">WHERE</span> emp.age <span class="operator">=</span> <span class="number">30</span></span><br><span class="line">  <span class="keyword">and</span> deptid <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> emp</span><br><span class="line"><span class="keyword">WHERE</span> emp.age <span class="operator">=</span> <span class="number">30</span></span><br><span class="line">  <span class="keyword">and</span> deptid <span class="operator">=</span> <span class="number">4</span></span><br><span class="line">  <span class="keyword">AND</span> emp.name <span class="operator">=</span> <span class="string">&#x27;abcd&#x27;</span>;</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491456170-c377987c-20e4-48d3-8c57-1c281333f915.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=u99be6438&margin=%5Bobject%20Object%5D&name=1.png&originHeight=669&originWidth=1627&originalType=binary&ratio=1&rotation=0&showTitle=false&size=72502&status=done&style=none&taskId=u55d8c0c7-c4a1-426d-9c8a-ac028ee5610&title=" alt="1.png"></p>
<h3 id="3-2-最左前缀法则"><a href="#3-2-最左前缀法则" class="headerlink" title="3.2 最左前缀法则"></a>3.2 最左前缀法则</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 单表查询-左前缀法则</span><br><span class="line">EXPLAIN SELECT * FROM emp WHERE age=1 AND deptid=1 AND NAME=&#x27;aaa&#x27;;</span><br><span class="line"></span><br><span class="line">EXPLAIN SELECT * FROM emp WHERE age=1 AND deptid=1;</span><br><span class="line"></span><br><span class="line">EXPLAIN SELECT * FROM emp WHERE age=1 AND NAME=&#x27;aaa&#x27; AND deptid=1;</span><br><span class="line"></span><br><span class="line">EXPLAIN SELECT * FROM emp WHERE deptid=1 AND NAME =&#x27;aaa&#x27;;</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491464294-700567fe-de9c-4bec-a160-19f057af9664.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=uad589f02&margin=%5Bobject%20Object%5D&name=2.png&originHeight=370&originWidth=1675&originalType=binary&ratio=1&rotation=0&showTitle=false&size=77031&status=done&style=none&taskId=u84a1a60b-a4c9-431b-aab3-390a731d305&title=" alt="2.png"></p>
<p><strong>过滤条件要使用索引必须按照索引建立时的顺序，依次满足，一旦跳过某个字段，索引后面的字段都无法被使用。</strong></p>
<h3 id="3-3-索引列上计算-函数导致索引失效"><a href="#3-3-索引列上计算-函数导致索引失效" class="headerlink" title="3.3 索引列上计算/函数导致索引失效"></a>3.3 索引列上计算/函数导致索引失效</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 单表查询-操作索引列导致索引失效</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE emp.name  LIKE &#x27;abc%&#x27;;</span><br><span class="line"></span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE LEFT(emp.name,3) = &#x27;abc&#x27;;</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491470761-e9ab9bf0-b0fd-466b-a22e-78f9db05ac18.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=u0f50ef69&margin=%5Bobject%20Object%5D&name=3.png&originHeight=212&originWidth=1776&originalType=binary&ratio=1&rotation=0&showTitle=false&size=40690&status=done&style=none&taskId=ubc30bbc7-0caa-4576-8310-56d52ce4621&title=" alt="3.png"></p>
<h3 id="3-4-范围查询导致的索引失效"><a href="#3-4-范围查询导致的索引失效" class="headerlink" title="3.4 范围查询导致的索引失效"></a>3.4 范围查询导致的索引失效</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN </span><br><span class="line">SELECT </span><br><span class="line">  SQL_NO_CACHE * </span><br><span class="line">FROM</span><br><span class="line">  emp </span><br><span class="line">WHERE emp.name = &#x27;abc&#x27;</span><br><span class="line">  AND emp.deptId &gt; 20 </span><br><span class="line">  AND  emp.age = 30 ;</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491478562-2407f3a6-238e-4a41-9c40-f13d878a64be.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=u0fd297ca&margin=%5Bobject%20Object%5D&name=4.png&originHeight=278&originWidth=1778&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30777&status=done&style=none&taskId=u447c694d-200e-4a12-9594-cdfab0c4284&title=" alt="4.png"></p>
<p><strong>应用开发中范围查询，例如： 金额查询，日期查询往往都是范围查询。应将查询条件放置where语句最后。</strong></p>
<h3 id="3-5-不等于-或者-lt-gt-索引失效"><a href="#3-5-不等于-或者-lt-gt-索引失效" class="headerlink" title="3.5  不等于(!= 或者&lt;&gt;)索引失效"></a>3.5  不等于(!= 或者&lt;&gt;)索引失效</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE emp.name &lt;&gt;  &#x27;abc&#x27; ;</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491485131-265339c4-634a-4f9d-85ff-425d9bf11bbd.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=ueb6021dc&margin=%5Bobject%20Object%5D&name=5.png&originHeight=83&originWidth=1769&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19058&status=done&style=none&taskId=u795a528f-33c3-4c30-ae8e-f7b4a90376e&title=" alt="5.png"></p>
<h3 id="3-6-is-not-null无法使用索引，is-null可使用索引"><a href="#3-6-is-not-null无法使用索引，is-null可使用索引" class="headerlink" title="3.6 is not null无法使用索引，is null可使用索引"></a>3.6 is not null无法使用索引，is null可使用索引</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE age IS NULL;</span><br><span class="line">#用到索引  </span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE age IS NOT NULL;</span><br><span class="line">#未用到索引</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491492669-05d3cbe9-c4fc-46b6-976d-47d7ad05f8da.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=u63f28bbf&margin=%5Bobject%20Object%5D&name=6.png&originHeight=193&originWidth=1780&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37313&status=done&style=none&taskId=u4db37747-2dc5-4415-accd-910c1ea3e91&title=" alt="6.png"></p>
<h3 id="3-7-like以-开头索引失效"><a href="#3-7-like以-开头索引失效" class="headerlink" title="3.7 like以%开头索引失效"></a>3.7 like以%开头索引失效</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE NAME LIKE &#x27;%aaa&#x27;;</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491500063-fb3c4a33-f97d-4266-a05c-86fde429b288.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=ubdad3760&margin=%5Bobject%20Object%5D&name=7.png&originHeight=216&originWidth=1803&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24797&status=done&style=none&taskId=ub22f6bde-0c42-4eec-b801-c53dbdc66c9&title=" alt="7.png"></p>
<h3 id="3-8-类型转换导致索引失效"><a href="#3-8-类型转换导致索引失效" class="headerlink" title="3.8 类型转换导致索引失效"></a>3.8 类型转换导致索引失效</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE NAME=123;</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491506837-e3685860-d2c5-4f77-894b-268f1612d6e8.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=u969914ec&margin=%5Bobject%20Object%5D&name=8.png&originHeight=224&originWidth=1812&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25560&status=done&style=none&taskId=uda038af4-3c43-413f-a932-5e758817a2c&title=" alt="8.png"></p>
<p><strong>设计实体类属性时，一定要与数据库字段类型相对应，否则会出现类型转换的情况，导致索引失效。</strong></p>
<h2 id="4-关联查询优化"><a href="#4-关联查询优化" class="headerlink" title="4. 关联查询优化"></a>4. 关联查询优化</h2><h3 id="4-1-左外连接"><a href="#4-1-左外连接" class="headerlink" title="4.1 左外连接"></a>4.1 左外连接</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain select * from emp left join dept on emp.deptId=dept.id;</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491513538-f2345fca-602d-43eb-b2fe-5b2e4fe417a0.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=ubd7e078b&margin=%5Bobject%20Object%5D&name=9.png&originHeight=267&originWidth=1765&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27831&status=done&style=none&taskId=ub2ea1fc8-943f-4fe1-a479-e7462d30827&title=" alt="9.png"></p>
<p>这种情况下，驱动表无法避免全表扫描，但是因为被驱动表的主键存在索引并且是两张表关联查询的关联条件，所以可以避免被驱动表的全表扫描。</p>
<h3 id="4-2-内连接-TODO"><a href="#4-2-内连接-TODO" class="headerlink" title="4.2 内连接(TODO)"></a>4.2 内连接(TODO)</h3><p>内连接MySQL会自动为我们选择驱动表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">explain  select * from dept  straight_join emp on emp.deptId=dept.id;</span><br><span class="line">## 1. dept 全表扫描   10w</span><br><span class="line">## 2. emp deptid  ref</span><br><span class="line">explain    select * from dept join emp on emp.deptId=dept.id;</span><br><span class="line">## 1. emp 500w</span><br><span class="line">## 2. dept id ref</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491521056-21c44295-fdf0-48cd-af31-2727388d6406.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=uf7b1a531&margin=%5Bobject%20Object%5D&name=10.png&originHeight=256&originWidth=1768&originalType=binary&ratio=1&rotation=0&showTitle=false&size=47117&status=done&style=none&taskId=u15296664-5f58-4728-9a31-6cf5d2f00e3&title=" alt="10.png"></p>
<ol>
<li> 保证被驱动表的join字段被索引 </li>
<li> left join 时，选择小表作为驱动表，大表作为被驱动表 </li>
<li> inner join 时，mysql会自动将小结果集的表选为驱动表。选择相信mysql优化策略。 </li>
<li> 子查询尽量不要放在被驱动表，衍生表建不了索引。 </li>
<li> 能够直接多表关联的尽量直接关联，不用子查询。 </li>
<li> 两张表的连接查询，比方说 left join  right、inner join 等，他们的连表方式是什么？ </li>
<li> 连表查询一共三种算法：nlj  bnl  bka 算法 。 </li>
<li> right join 底层，会给你转化为left join。 </li>
</ol>
<h3 id="4-3-子查询优化"><a href="#4-3-子查询优化" class="headerlink" title="4.3 子查询优化"></a>4.3 子查询优化</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#①不推荐</span><br><span class="line">explain SELECT</span><br><span class="line">  *</span><br><span class="line">FROM</span><br><span class="line">  emp</span><br><span class="line">WHERE emp.id NOT IN   -- not in 导致无法对in进行优化，用不了exists</span><br><span class="line">  (SELECT</span><br><span class="line">    dept.ceo</span><br><span class="line">  FROM</span><br><span class="line">    dept</span><br><span class="line">  WHERE dept.ceo IS NOT NULL) ; -- is not null 导致索引失效</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#②推荐</span><br><span class="line">explain SELECT</span><br><span class="line">  emp.*</span><br><span class="line">FROM</span><br><span class="line">  emp</span><br><span class="line">  LEFT JOIN dept</span><br><span class="line">    ON emp.id = dept.ceo  -- 如果ceo没有索引，两张表都是全表扫描，如果ceo有索引，被驱动表就是ref级别</span><br><span class="line">WHERE dept.id IS NULL ;</span><br><span class="line"># 尝试在ceo创建索引后，确实是  create index idx_ceo on dept(ceo);</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491529644-b74d14b2-2509-40c7-8b55-901771849bcd.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=u913673e1&margin=%5Bobject%20Object%5D&name=11.png&originHeight=687&originWidth=1774&originalType=binary&ratio=1&rotation=0&showTitle=false&size=66874&status=done&style=none&taskId=ua21a55b1-35c9-405e-96fd-65dc0b7e4de&title=" alt="11.png"></p>
<p><strong>尽量不要使用not in  或者 not exists，会使索引失效。</strong></p>
<p>MySQL自动做出的子查询优化，物化子查询，转为半连接</p>
<p>物化子查询：把子查询的结果查出来后，建立一个临时表，“物化”-&gt;变成一张内存临时表</p>
<p>半连接：把子查询转化为类似连接查询的方式，但又不是真正的连接查询，所以叫 半 连接优化</p>
<h2 id="5-排序分组优化"><a href="#5-排序分组优化" class="headerlink" title="5.排序分组优化"></a>5.排序分组优化</h2><h3 id="5-1-无过滤，不索引"><a href="#5-1-无过滤，不索引" class="headerlink" title="5.1 无过滤，不索引"></a>5.1 无过滤，不索引</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM emp ORDER BY age,deptid; </span><br><span class="line">#没用上索引，Using filesort </span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM emp ORDER BY age,deptid LIMIT 10; </span><br><span class="line">#使用上索引 null</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491536353-0bd6fd69-2673-476c-b248-b2e80fcbffcb.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=u24d10f43&margin=%5Bobject%20Object%5D&name=12.png&originHeight=183&originWidth=1582&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37338&status=done&style=none&taskId=u1edba00b-5e34-4259-95c8-083f2f0c62f&title=" alt="12.png"></p>
<p>因为<code>order by</code>的字段顺序和索引的顺序一样，所以此时会先尝试内存排序，但是因为上面的sql没有limit，导致内存放不下，使用了文件排序（文件系统级别，相当于在磁盘做排序），所以第一条sql效率更低。</p>
<p><strong>order后面的字段想要使用索引，必须要有过滤条件，limit也行。</strong></p>
<h3 id="5-2顺序错，必排序"><a href="#5-2顺序错，必排序" class="headerlink" title="5.2顺序错，必排序"></a>5.2顺序错，必排序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY deptid;</span><br><span class="line"></span><br><span class="line"># Using index condition</span><br><span class="line">EXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY deptid,NAME;</span><br><span class="line"></span><br><span class="line"># Using index condition</span><br><span class="line">EXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY deptid,empno;</span><br><span class="line"></span><br><span class="line"># Using index condition; Using filesort</span><br><span class="line">EXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY NAME,deptid;</span><br><span class="line"></span><br><span class="line"># Using index condition; Using filesort</span><br><span class="line">EXPLAIN SELECT * FROM emp WHERE deptid=45 ORDER BY age;</span><br><span class="line"># Using where; Using filesort</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491544580-01f4c526-3629-4473-a484-3a22cb9faaa0.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=u54b993fc&margin=%5Bobject%20Object%5D&name=13.png&originHeight=419&originWidth=1785&originalType=binary&ratio=1&rotation=0&showTitle=false&size=105747&status=done&style=none&taskId=ubcd427eb-7240-496b-9649-1864b3852cf&title=" alt="13.png">在SQL语句中的顺序一定要和定义索引中的字段顺序完全一致。</p>
<h3 id="5-3-方向反，必排序"><a href="#5-3-方向反，必排序" class="headerlink" title="5.3 方向反，必排序"></a>5.3 方向反，必排序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY deptid DESC, NAME DESC ;</span><br><span class="line">#Using where</span><br><span class="line">EXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY deptid ASC, NAME DESC ;</span><br><span class="line">#Using index condition; Using filesort</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640491551554-8a74b76b-19e2-46fe-a3a3-7035195101c4.png#clientId=u59747a0e-b9d8-4&crop=0&crop=0&crop=1&crop=1&from=ui&id=u8058c6b1&margin=%5Bobject%20Object%5D&name=14.png&originHeight=183&originWidth=1778&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44088&status=done&style=none&taskId=u5310533d-7e53-441e-ae67-7c0797b75c8&title=" alt="14.png"></p>
<p><strong>ORDER BY子句，尽量使用Index方式排序，避免使用FileSort方式排序</strong></p>
<p>要么全升序、要么全降序。有升有降无法使用索引。</p>
<h3 id="5-4-索引的选择"><a href="#5-4-索引的选择" class="headerlink" title="5.4 索引的选择"></a>5.4 索引的选择</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/12610368/1640502174193-eabb2dc2-2270-4142-87a8-15983e19f611.png#clientId=u74e58dfd-b4b5-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u33361d21&margin=%5Bobject%20Object%5D&name=image.png&originHeight=367&originWidth=1779&originalType=binary&ratio=1&rotation=0&showTitle=false&size=79336&status=done&style=shadow&taskId=u89a45289-9231-4915-8ba6-b6af12a6b1b&title=" alt="image.png"></p>
<p><strong>两个索引同时存在，mysql自动选择最优的方案，但是，随着数据量的变化，选择的索引也会随之变化的。</strong></p>
<p>所有的排序都是在条件过滤之后才执行的，所以，如果条件过滤掉大部分数据的话，剩下几百几千条数据进行排序其实并不是很消耗性能，即使索引优化了排序，但实际提升性能很有限。</p>
<p>当【范围条件】和【group by 或者 order by】的字段出现二选一时，优先观察条件字段的过滤数量，如果过滤的数据足够多，而需要排序的数据并不多时，优先把索引放在范围（过滤条件）字段上。反之，亦然。</p>
<p>扫描行数的多少，就是explain里的rows，可以说明一个需要扫描的行数多，一个扫描行数少，扫描行数多，代表成本高，扫描行数少代表成本少。优化器最终是对比成本值的大小来选取索引的。准确的说，是MySQL基于成本，优化器是在server层。</p>
<p>有时候优化器会选择错索引为什么？</p>
<ol>
<li><p>主要是出在优化器预估行数上，这个涉及到了一条sql的执行流程，语法分析，词法分析之后，进入优化阶段，由优化器进行优化，在优化阶段，会尽可能的生成全部的执行计划，然后对比一下哪一个成本值最低，就选它，所以优化器有一个选择索引，选择表的连接顺序的过程，索引不同，成本不同，读表顺序不同，成本不同，索引的选取，需要存储引擎提供统计信息，innodb中，统计信息是随机采样，随机选取8个索引页，取平均值，当做该索引的全部情况，也就是部分代表整体，也就是最终导致rows那里是个预估值，而不是准确的。所以有时候MySQL选错了索引，有一定概率，是由于这个随机采样造成的。而随机采样的不准确，是由于数据不断添加导致索引页的分裂，导致有些页内数据较少。  </p>
<blockquote>
<p>解决方案：</p>
<ol>
<li> 执行一下alter table +表名 就可以使统计信息稍微准确点，他会重新构建索引，使索引页保持紧凑，这个就是B+树的分裂。 </li>
<li> 调整参数，加大InnoDB采样的页数，页数越大越精确，但性能消耗更高。一般不建议这么干。 </li>
</ol>
</blockquote>
</li>
<li><p>在优化阶段，会对表中所有索引进行对比，优化器基于成本的原因，选择成本最低的索引，所以会错过最佳索引。带来的问题便是，执行速度很慢。  </p>
<blockquote>
<p>解决方案：</p>
<ol>
<li>通过explain查看执行计划，结合sql条件查看可以利用哪些索引。</li>
<li>使用 <code>force index(indexName)</code>强制走指定索引。弊端就是后期若索引名发生改变，或索引被删除，该sql语句需要调整。</li>
</ol>
</blockquote>
</li>
</ol>
<h3 id="5-5-双路排序-amp-单路排序"><a href="#5-5-双路排序-amp-单路排序" class="headerlink" title="5.5  双路排序&amp;单路排序"></a>5.5  双路排序&amp;单路排序</h3><p>如果不在索引列上，filesort有两种算法： mysql就要启动双路排序和单路排序。</p>
<p><strong>双路排序</strong></p>
<p>MySQL 4.1之前是使用双路排序，字面意思就是两次扫描磁盘，最终得到数据， 读取行指针和order by列，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出</p>
<p>从磁盘取排序字段，在buffer进行排序，再从磁盘取其他字段。</p>
<p>取一批数据，要对磁盘进行两次扫描，众所周知，I\O是很耗时的，所以在mysql4.1之后，出现了第二种改进的算法，就是单路排序。</p>
<p><strong>单路排序</strong></p>
<p>从磁盘读取查询需要的所有列，按照order by列在buffer对它们进行排序，然后扫描排序后的列表进行输出， 它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO，但是它会使用更多的空间， 因为它把每一行都保存在内存中了。</p>
<p><strong>结论</strong></p>
<p>由于单路是后出的，总体而言好过双路。</p>
<p>但是用单路有问题：</p>
<p>在sort_buffer中，单路比多路要多占用很多空间，因为单路是把所有字段都取出, 所以有可能取出的数据的总大小超出了sort_buffer的容量，导致每次只能取sort_buffer容量大小的数据，进行排序（创建tmp文件，多路合并），排完再取sort_buffer容量大小，再排……从而多次I/O。</p>
<p>单路本来想省一次I/O操作，反而导致了大量的I/O操作，反而得不偿失。</p>
<p><strong>优化策略</strong></p>
<p>增大sort_buffer_size参数的设置</p>
<p>增大max_length_for_sort_data参数的设置</p>
<p>减少select 后面的查询的字段。</p>
<p><strong>提高order by的速度</strong></p>
<ol>
<li>Order by时select * 是一个大忌。只Query需要的字段， 这点非常重要。</li>
</ol>
<blockquote>
<p>当Query的字段大小总和小于max_length_for_sort_data 而且排序字段不是 TEXT|BLOB 类型时，会用改进后的算法——单路排序， 否则用老算法——多路排序。</p>
<p>两种算法的数据都有可能超出sort_buffer的容量，超出之后，会创建tmp文件进行合并排序，导致多次I/O，但是用单路排序算法的风险会更大一些，所以要提高sort_buffer_size。</p>
</blockquote>
<ol start="2">
<li>尝试提高 sort_buffer_size</li>
</ol>
<blockquote>
<p>不管用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对每个进程（connection）的  1M-8M之间调整。 MySQL5.7，InnoDB存储引擎默认值是1048576字节，1MB。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#x27;%sort_buffer_size%&#x27;;</span><br></pre></td></tr></table></figure>


<ol start="3">
<li>尝试提高 max_length_for_sort_data</li>
</ol>
<blockquote>
<p>提高这个参数， 会增加用改进算法的概率。</p>
<p>但是如果设的太高，数据总容量超出sort_buffer_size的概率就增大，明显症状是高的磁盘I/O活动和低的处理器使用率。如果需要返回的列的总长度大于max_length_for_sort_data，使用双路算法，否则使用单路算法。1024-8192字节之间调整。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#x27;%max_length_for_sort_data%&#x27;; #默认1024字节</span><br></pre></td></tr></table></figure>


<h3 id="5-6-分组优化"><a href="#5-6-分组优化" class="headerlink" title="5.6 分组优化"></a>5.6 分组优化</h3><p>group by 使用索引的原则几乎跟order by一致 ，唯一区别：</p>
<p>group by 先排序再分组，遵照索引建的最佳左前缀法则</p>
<p>当无法使用索引列，增大max_length_for_sort_data和sort_buffer_size参数的设置</p>
<p>where高于having,能写在where限定的条件就不要写在having中了</p>
<p>group by没有过滤条件，也可以用上索引。Order By 必须有过滤条件才能使用上索引。</p>
<h2 id="6-覆盖索引"><a href="#6-覆盖索引" class="headerlink" title="6. 覆盖索引"></a>6. 覆盖索引</h2><p>禁止使用select *，禁止查询与业务无关字段，尽量使用覆盖索引，防止回表。</p>
<p><strong>覆盖索引减少了 IO 次数，减少了数据的访问量，可以大大地提升查询效率。</strong></p>
<h1 id="四，追踪优化器"><a href="#四，追踪优化器" class="headerlink" title="四，追踪优化器"></a>四，追踪优化器</h1><p>前面的原理篇详细分析过，在此不再赘述。</p>
<h1 id="五，-分库分表"><a href="#五，-分库分表" class="headerlink" title="五， 分库分表"></a>五， 分库分表</h1><p>从维度来说分成两种，一种是垂直，一种是水平。</p>
<p>垂直切分：基于表或字段划分，表结构不同。我们有单库的分表，也有多库的分库。</p>
<p>水平切分：基于数据划分，表结构相同，数据不同，也有同库的水平切分和多库的切分。</p>
<h2 id="1-垂直切分"><a href="#1-垂直切分" class="headerlink" title="1.垂直切分"></a>1.垂直切分</h2><p>垂直分表有两种，一种是单库的，一种是多库的。</p>
<h3 id="1-1-单库垂直分表"><a href="#1-1-单库垂直分表" class="headerlink" title="1.1 单库垂直分表"></a>1.1 单库垂直分表</h3><p>单库分表，比如：商户信息表，拆分成基本信息表，联系方式表，结算信息表，附件表等等。</p>
<p>可以考虑根据冷热点字段拆分，是否经常发生修改操作拆分，根据字段功能拆分。</p>
<h3 id="1-2-多库垂直分表"><a href="#1-2-多库垂直分表" class="headerlink" title="1.2 多库垂直分表"></a>1.2 多库垂直分表</h3><p>多库垂直分表就是把原来存储在一个库的不同的表，拆分到不同的数据库。</p>
<p>比如电商平台的消费系统：一开始，商品表，商品详情表，订单表，用户表，支付记录表，库存表，风控表都在一个库里面，随着数据的增长和业务的扩张，可以考虑将商品和商品详情表单独放到一个库，订单表单独放到一个库，支付记录单独放到一个库，库存表单独放到一个库，风控表单独放到一个库。</p>
<p>当我们对原来的一张表做了分库的处理，如果某些业务系统的数据还是有一个非常快的增长速度，比如说订单数据库的订单表，数据量达到了几个亿，这个时候硬件限制导致的性能问题还是会出现，所以从这个角度来说垂直切分并没有从根本上解决单库单表数据量过大的问题。在这个时候，我们还需要对我们的数据做一个水平的切分。</p>
<h2 id="2-水平拆分"><a href="#2-水平拆分" class="headerlink" title="2.水平拆分"></a>2.水平拆分</h2><p>当我们的客户表数量已经到达数千万甚至上亿的时候，单表的存储容量和查询效率都会出现问题，我们需要进一步对单张表的数据进行水平切分。水平切分的每个数据库的表结构都是一样的，只是存储的数据不一样，比如每个库存储 1000 万的数据。</p>
<p>水平切分也可以分成两种，一种是单库的，一种是多库的。</p>
<h3 id="2-1-单库水平分表"><a href="#2-1-单库水平分表" class="headerlink" title="2.1 单库水平分表"></a>2.1 单库水平分表</h3><p>银行的交易流水表，所有进出的交易都需要登记这张表，因为绝大部分时候客户都是查询当天的交易和一个月以内的交易数据，所以我们根据使用频率把这张表拆分成三张表：</p>
<p>当天表：只存储当天的数据。</p>
<p>当月表：在夜间运行一个定时任务，前一天的数据，全部迁移到当月表。用的是 insert into select，然后 delete。</p>
<p>历史表：同样是通过定时任务，把登记时间超过 30 天的数据，迁移到 history历史表（历史表的数据非常大，我们按照月度，每个月建立分区）。</p>
<p>跟分区一样，这种方式虽然可以一定程度解决单表查询性能的问题，但是并不能解决单机存储瓶颈的问题。</p>
<h3 id="2-2-多库水平分表"><a href="#2-2-多库水平分表" class="headerlink" title="2.2 多库水平分表"></a>2.2 多库水平分表</h3><p>比如客户表，我们拆分到多个库存储，表结构是完全一样的。</p>
<p><img src="https://img-blog.csdnimg.cn/2021022621260117.jpg#pic_center#crop=0&crop=0&crop=1&crop=1&id=KoEDL&originHeight=171&originWidth=643&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>一般我们说的分库分表都是跨库的分表。</p>
<h2 id="3-分库分表带来的问题"><a href="#3-分库分表带来的问题" class="headerlink" title="3. 分库分表带来的问题"></a>3. 分库分表带来的问题</h2><h3 id="3-1-跨库关联查询"><a href="#3-1-跨库关联查询" class="headerlink" title="3.1 跨库关联查询"></a>3.1 跨库关联查询</h3><p>比如查询合同信息的时候要关联客户数据，由于是合同数据和客户数据是在不同的数据库，那么我们肯定不能直接使用 join 的这种方式去做关联查询。</p>
<p><strong>解决方案</strong></p>
<h4 id="①字段冗余"><a href="#①字段冗余" class="headerlink" title="①字段冗余"></a>①字段冗余</h4><p>比如我们查询合同库的合同表的时候需要关联客户库的客户表，我们可以直接把一些经常关联查询的客户字段放到合同表，通过这种方式避免跨库关联查询的问题。</p>
<h4 id="②数据同步"><a href="#②数据同步" class="headerlink" title="②数据同步"></a>②数据同步</h4><p>比如商户系统要查询产品系统的产品表，我们干脆在商户系统创建一张产品表，通过 ETL 或者其他方式定时同步产品数据。</p>
<h4 id="③全局表（广播表）"><a href="#③全局表（广播表）" class="headerlink" title="③全局表（广播表）"></a>③全局表（广播表）</h4><p>比如行名行号信息被很多业务系统用到，如果我们放在核心系统，每个系统都要去关联查询，这个时候我们可以在所有的数据库都存储相同的基础数据。</p>
<h4 id="④ER表"><a href="#④ER表" class="headerlink" title="④ER表"></a>④ER表</h4><p>我们有些表的数据是存在逻辑的主外键关系的，比如订单表 order_info，存的是汇总的商品数，商品金额；订单明细表 order_detail，是每个商品的价格，个数等等。或者叫做从属关系，父表和子表的关系。他们之间会经常有关联查询的操作，如果父表的数据和子表的数据分别存储在不同的数据库，跨库关联查询也比较麻烦。所以我们能不能把父表的数据和从属于父表的数据落到一个节点上呢？</p>
<p>比如 order_id=1001 的数据在 node1，它所有的明细数据也放到 node1；order_id=1002 的数据在 node2，它所有的明细数据都放到 node2，这样在关联查询的时候依然是在一个数据库。</p>
<p>上面的思路都是通过合理的数据分布避免跨库关联查询，实际上在我们的业务中，也是尽量不要用跨库关联查询，如果出现了这种情况，就要分析一下业务或者数据拆分是不是合理。如果还是出现了需要跨库关联的情况，那我们就只能用最后一种办法。</p>
<h4 id="⑤系统层组装"><a href="#⑤系统层组装" class="headerlink" title="⑤系统层组装"></a>⑤系统层组装</h4><p>在不同的数据库节点把符合条件数据的数据查询出来，然后重新组装，返回给客户端。</p>
<h3 id="3-2-分布式事务"><a href="#3-2-分布式事务" class="headerlink" title="3.2 分布式事务"></a>3.2 分布式事务</h3><p>具体分布式事务会单独写一篇文章</p>
<h3 id="3-3-排序，翻页，函数计算问题"><a href="#3-3-排序，翻页，函数计算问题" class="headerlink" title="3.3 排序，翻页，函数计算问题"></a>3.3 排序，翻页，函数计算问题</h3><p>跨节点多库进行查询时，会出现 limit 分页，order by 排序的问题。比如有两个节点，节点 1 存的是奇数 id=1,3,5,7,9……；节点 2 存的是偶数 id=2,4,6,8,10……</p>
<p>执行 select * from user_info order by id limit 0,10</p>
<p>需要在两个节点上各取出 10 条，然后合并数据，重新排序。</p>
<p>max、min、sum、count 之类的函数在进行计算的时候，也需要先在每个分片上执行相应的函数，然后将各个分片的结果集进行汇总和再次计算，最终将结果返回。</p>
<h3 id="3-4-全局主键避重"><a href="#3-4-全局主键避重" class="headerlink" title="3.4 全局主键避重"></a>3.4 全局主键避重</h3><p>MySQL 的数据库里面字段有一个自增的属性，Oracle 也有 Sequence 序列。如果是一个数据库，那么可以保证 ID 是不重复的，但是水平分表以后，每个表都按照自己的规律自增，肯定会出现 ID 重复的问题，这个时候我们就不能用本地自增的方式了。</p>
<p><strong>解决方案</strong></p>
<h4 id="①UUID"><a href="#①UUID" class="headerlink" title="①UUID"></a>①UUID</h4><p>UUID 标准形式包含 32 个 16 进制数字，分为 5 段，形式为 8-4-4-4-12 的 36 个字符，例如：c4e7956c-03e7-472c-8909-d733803e79a9。</p>
<p>UUID 是主键是最简单的方案，本地生成，性能高，没有网络耗时。但缺点也很明显，由于 UUID 非常长，会占用大量的存储空间；另外，作为主键建立索引和基于索引进行查询时都会存在性能问题，在 InnoDB 中，UUID 的无序性会引起数据位置频繁变动，导致分页。</p>
<h4 id="②数据库"><a href="#②数据库" class="headerlink" title="②数据库"></a>②数据库</h4><p>把序号维护在数据库的一张表中。这张表记录了全局主键的类型、位数、起始值，当前值。当其他应用需要获得全局 ID 时，先 for update 锁行，取到值+1 后并且更新后返回。并发性比较差。</p>
<h4 id="③redis"><a href="#③redis" class="headerlink" title="③redis"></a>③redis</h4><p>基于 Redis 的 INT 自增的特性，使用批量的方式降低数据库的写压力，每次获取一段区间的 ID 号段，用完之后再去数据库获取，可以大大减轻数据库的压力。</p>
<h4 id="④雪花算法"><a href="#④雪花算法" class="headerlink" title="④雪花算法"></a>④雪花算法</h4><p>优点：毫秒数在高位，生成的 ID 整体上按时间趋势递增；不依赖第三方系统，稳定性和效率较高，理论上 QPS 约为 409.6w/s(1000*2^12)，并且整个分布式系统内不会产生 ID 碰撞；可根据自身业务灵活分配 bit 位。</p>
<p>不足就在于：强依赖机器时钟，如果时钟回拨，则可能导致生成 ID 重复。</p>
<h2 id="4-多数据源-读写数据源的解决方案"><a href="#4-多数据源-读写数据源的解决方案" class="headerlink" title="4. 多数据源/读写数据源的解决方案"></a>4. 多数据源/读写数据源的解决方案</h2><p>分析一下 SQL 执行经过的流程：</p>
<p>DAO——Mapper（ORM）——JDBC——代理——数据库服务</p>
<h3 id="4-1-客户端DAO-层"><a href="#4-1-客户端DAO-层" class="headerlink" title="4.1 客户端DAO 层"></a>4.1 客户端DAO 层</h3><p>在我们连接到某一个数据源之前，我们先根据配置的分片规则，判断需要连接到哪些节点，再建立连接。</p>
<p>Spring 中提供了一个抽象类 AbstractRoutingDataSource，可以实现数据源的动态切换。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1）aplication.properties 定义多个数据源</span><br><span class="line">2）创建@TargetDataSource 注解</span><br><span class="line">3）创建 DynamicDataSource 继承 AbstractRoutingDataSource</span><br><span class="line">4）多数据源配置类 DynamicDataSourceConfig</span><br><span class="line">5）创建切面类 DataSourceAspect，对添加了@TargetDataSource 注解的</span><br><span class="line">类进行拦截设置数据源。</span><br><span class="line">6）在 启 动 类 上 自 动 装 配 数 据 源 配 置</span><br><span class="line">@Import(&#123;DynamicDataSourceConfig.class&#125;)</span><br><span class="line">7）在 实 现 类 上 加 上 注 解 ， 如 @TargetDataSource(name =</span><br><span class="line">DataSourceNames.SECOND)，调用</span><br></pre></td></tr></table></figure>


<p>在 DAO 层实现的优势：不需要依赖 ORM 框架，即使替换了 ORM 框架也不受影响。实现简单（不需要解析 SQL 和路由规则），可以灵活地定制。</p>
<p>缺点：不能复用，不能跨语言。</p>
<h3 id="4-2-ORM框架层"><a href="#4-2-ORM框架层" class="headerlink" title="4.2 ORM框架层"></a>4.2 ORM框架层</h3><p>比如我们用 MyBatis 连接数据库，也可以指定数据源。我们可以基于 MyBatis 插件的拦截机制（拦截 query 和 update 方法），实现数据源的选择。</p>
<h3 id="4-3-驱动层"><a href="#4-3-驱动层" class="headerlink" title="4.3 驱动层"></a>4.3 驱动层</h3><p>不管是MyBatis还是Hibernate，还是Spring的JdbcTemplate，本质上都是对JDBC的封装，所以第三层就是驱动层。比如 Sharding-JDBC，就是对 JDBC 的对象进行了封装。JDBC 的核心对象：</p>
<p>DataSource：数据源</p>
<p>Connection：数据库连接</p>
<p>Statement：语句对象</p>
<p>ResultSet：结果集</p>
<p>那我们只要对这几个对象进行封装或者拦截或者代理，就可以实现分片的操作。</p>
<h3 id="4-4-代理层"><a href="#4-4-代理层" class="headerlink" title="4.4 代理层"></a>4.4 代理层</h3><p>前面三种都是在客户端实现的，也就是说不同的项目都要做同样的改动，不同的编程语言也有不同的实现，所以我们能不能把这种选择数据源和实现路由的逻辑提取出来，做成一个公共的服务给所有的客户端使用呢？</p>
<p>这个就是第四层，代理层。比如 Mycat 和 Sharding-Proxy，都是属于这一层。</p>
<h3 id="4-5-数据库服务"><a href="#4-5-数据库服务" class="headerlink" title="4.5 数据库服务"></a>4.5 数据库服务</h3><p>某些特定的数据库或者数据库的特定版本可以实现这个功能。</p>
<h1 id="六，主从复制"><a href="#六，主从复制" class="headerlink" title="六，主从复制"></a>六，主从复制</h1><h2 id="1-基本原理"><a href="#1-基本原理" class="headerlink" title="1. 基本原理"></a>1. 基本原理</h2><p><img src="https://www.yuque.com/api/filetransfer/images?url=https://img-blog.csdnimg.cn/20210226212524335.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTU5NjAyMg==,size_16,color_FFFFFF,t_70%23pic_center&sign=b2cf46d51564b6f2c46bcffc3adcd48b84ede22cae502691d18e85e1cd079c10#crop=0&crop=0&crop=1&crop=1&id=zSBEv&originHeight=282&originWidth=566&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>MySQL复制过程分成三步：</p>
<ol>
<li> master将改变记录到二进制日志（binary log）。这些记录过程叫做二进制日志事件，binary log events； </li>
<li> slave将master的binary log events拷贝到它的中继日志（relay log）； </li>
<li> slave重做中继日志中的事件，将改变应用到自己的数据库中。 MySQL复制是异步的且串行化的，slave会从master读取binlog来进行数据同步。 </li>
</ol>
<h2 id="2-与Redis主从复制的差别"><a href="#2-与Redis主从复制的差别" class="headerlink" title="2.与Redis主从复制的差别"></a>2.与Redis主从复制的差别</h2><ol>
<li> redis主从复制是将主机的所有数据都拷贝给从机，并且是近乎实时的。 </li>
<li> mysql主从复制不会将建立连接以前的数据发送给从机，并且是异步，且串行化的。 </li>
</ol>
<h2 id="3-复制的基本原则"><a href="#3-复制的基本原则" class="headerlink" title="3.复制的基本原则"></a>3.复制的基本原则</h2><p>每个slave只有一个master</p>
<p>每个slave只能有一个唯一的服务器ID</p>
<p>每个master可以有多个salve</p>
<h2 id="4-复制的最大问题"><a href="#4-复制的最大问题" class="headerlink" title="4.复制的最大问题"></a>4.复制的最大问题</h2><p>延时</p>
<p>全同步可以避免，但性能会极差，正常情况下半同步，且容忍一部分数据不一致。如果不容忍数据不一致，只有强制读主。</p>
<h2 id="5-一主一从常见配置"><a href="#5-一主一从常见配置" class="headerlink" title="5.一主一从常见配置"></a>5.一主一从常见配置</h2><ol>
<li>MySQL版本一致且后台以服务运行</li>
<li>主从配置都在【mysqld】节点下，且全部小写</li>
<li>主机修改my.ini文件</li>
</ol>
<blockquote>
<ol>
<li> 主服务器唯一ID server-id=1 </li>
<li> 启用二进制日志  </li>
<li> 设置不要复制的数据库  </li>
<li> 设置需要复制的数据库  </li>
<li> 设置logbin格式  </li>
</ol>
</blockquote>
<blockquote>
<p>log-bin=自己的本地路径/data/mysqlbin</p>
</blockquote>
<blockquote>
<p>binlog-ignore-db=mysql</p>
</blockquote>
<blockquote>
<p>binlog-do-db=需要复制的主数据库名字</p>
</blockquote>
<blockquote>
<p>binlog_fromat=STATEMENT(默认)</p>
</blockquote>
<h1 id="七，硬件层面的配置"><a href="#七，硬件层面的配置" class="headerlink" title="七，硬件层面的配置"></a>七，硬件层面的配置</h1><h2 id="1-选择合适的CPU"><a href="#1-选择合适的CPU" class="headerlink" title="1.选择合适的CPU"></a>1.选择合适的CPU</h2><p>数据库分为两大类，在线事务处理和在线分析处理。</p>
<p>InnoDB储存引擎一般应用于OLTP的数据库应用，这种应用的特点如下：</p>
<ol>
<li> 用户操作的并发量大 </li>
<li> 事务处理时间一般比较短 </li>
<li> 查询的语句较为简单，一般都走索引 </li>
<li> 复杂查询比较少 </li>
</ol>
<p>在当前的MySQL数据库版本中，一条SQL语句只能在一个CPU工作，并不支持多CPU。若cpu支持多核，innodb版本应该选择1.1或者更高。另外如果是多核cpu，可以通过修改参数innodb_read_io_threads和innodb_write_io_threads来增大IO的线程，这样也可以更充分的利用cpu的多核性能。</p>
<h2 id="2-内存的重要性"><a href="#2-内存的重要性" class="headerlink" title="2.内存的重要性"></a>2.内存的重要性</h2><p>内存大小直接反映数据库的性能。Innodb存储引擎既缓存数据，又缓存索引，并且将它们缓存于一个很大的缓冲池中，即InnoDB Buffer Pool。因此，内存的大小直接影像数据库的性能。</p>
<h2 id="3-磁盘对数据库性能的影响"><a href="#3-磁盘对数据库性能的影响" class="headerlink" title="3.磁盘对数据库性能的影响"></a>3.磁盘对数据库性能的影响</h2><h2 id="4-合理设置RAID类型"><a href="#4-合理设置RAID类型" class="headerlink" title="4.合理设置RAID类型"></a>4.合理设置RAID类型</h2><h2 id="5-操作系统的选择"><a href="#5-操作系统的选择" class="headerlink" title="5.操作系统的选择"></a>5.操作系统的选择</h2><h2 id="6-文件系统的选择"><a href="#6-文件系统的选择" class="headerlink" title="6.文件系统的选择"></a>6.文件系统的选择</h2></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">二十</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E5%8D%81%E4%B8%80]%E9%AB%98%E6%80%A7%E8%83%BDMySQL%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98/">https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[十一]高性能MySQL调优实战/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://yinhuidong.github.io" target="_blank">二十</a> 许可协议。转载请注明来自 <a href="https://yinhuidong.github.io" target="_blank">二十</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="post_share"><div class="social-share" data-image="/images/cover/mysql.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat_pay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat_pay.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/01/11/Spring/Spring%5B%E4%B8%80%5D%E5%88%9D%E5%A7%8B%E5%8C%96Web%E4%B8%89%E5%A4%A7%E7%BB%84%E4%BB%B6/"><img class="prev-cover" src="/images/cover/spring.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring[一]初始化WEB组件</div></div></a></div><div class="next-post pull-right"><a href="/2022/01/10/MySQL/MySQL%5B%E5%8D%81%5DExplain&amp;optimizer%20trace/"><img class="next-cover" src="/images/cover/mysql.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL[十]Explain&amp;optimizer trace</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/01/01/MySQL/MySQL%5B%E4%B8%80%5D%E5%85%A5%E9%97%A8/" title="MySQL[一]入门"><img class="cover" src="/images/cover/mysql.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-01</div><div class="title">MySQL[一]入门</div></div></a></div><div><a href="/2022/01/09/MySQL/MySQL%5B%E4%B9%9D%5D%E5%9F%BA%E4%BA%8E%E8%A7%84%E5%88%99%E7%9A%84%E4%BC%98%E5%8C%96&%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/" title="MySQL[九]基于规则的优化&子查询优化"><img class="cover" src="/images/cover/mysql.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-09</div><div class="title">MySQL[九]基于规则的优化&子查询优化</div></div></a></div><div><a href="/2022/01/20/MySQL/MySQL%5B%E4%BA%8C%E5%8D%81%5D%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/" title="MySQL[二十]海量数据处理"><img class="cover" src="/images/cover/mysql.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-20</div><div class="title">MySQL[二十]海量数据处理</div></div></a></div><div><a href="/2022/01/07/MySQL/MySQL%5B%E4%B8%83%5D%E5%9F%BA%E4%BA%8E%E6%88%90%E6%9C%AC%E7%9A%84%E4%BC%98%E5%8C%96/" title="MySQL[七]基于成本的优化"><img class="cover" src="/images/cover/mysql.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-07</div><div class="title">MySQL[七]基于成本的优化</div></div></a></div><div><a href="/2022/01/03/MySQL/MySQL%5B%E4%B8%89%5DInnoDB%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84/" title="MySQL[三]InnoDB索引结构"><img class="cover" src="/images/cover/mysql.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-03</div><div class="title">MySQL[三]InnoDB索引结构</div></div></a></div><div><a href="/2022/01/08/MySQL/MySQL%5B%E5%85%AB%5DInnoDB%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86%E5%8E%9F%E7%90%86/" title="MySQL[八]InnoDB统计数据收集原理"><img class="cover" src="/images/cover/mysql.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-08</div><div class="title">MySQL[八]InnoDB统计数据收集原理</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">二十</div><div class="author-info__description">欢迎来到二十的博客....</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">119</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yinhuidong"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/yinhuidong" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1972039773@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎来到二十的个人博客，联系作者：VX：yinhuidong666</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%EF%BC%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96"><span class="toc-text">一，数据库应该如何优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-SQL%E4%B8%8E%E7%B4%A2%E5%BC%95"><span class="toc-text">1.SQL与索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%A1%A8%E4%B8%8E%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-text">2.表与存储引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9E%B6%E6%9E%84"><span class="toc-text">3.架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%85%8D%E7%BD%AE"><span class="toc-text">4.配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%A1%AC%E4%BB%B6"><span class="toc-text">5.操作系统与硬件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%EF%BC%8C%E6%85%A2%E6%97%A5%E5%BF%97%E6%9F%A5%E8%AF%A2"><span class="toc-text">二，慢日志查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-text">1.概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AE%9E%E6%93%8D"><span class="toc-text">2.实操</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E6%9F%A5%E7%9C%8B%E5%8F%8A%E5%BC%80%E5%90%AF"><span class="toc-text">2.1查看及开启</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E6%97%A5%E5%BF%97"><span class="toc-text">①日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E6%97%B6%E9%97%B4"><span class="toc-text">②时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2%E6%B0%B8%E4%B9%85%E7%94%9F%E6%95%88"><span class="toc-text">③永久生效</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2Case"><span class="toc-text">2.2Case</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7-mysqldumpslow"><span class="toc-text">3.日志分析工具-mysqldumpslow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E5%B8%B8%E7%94%A8SQL"><span class="toc-text">3.1常用SQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-SHOW-PROCESSLIST"><span class="toc-text">4.SHOW PROCESSLIST</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%EF%BC%8CEXPLAIN%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98"><span class="toc-text">三，EXPLAIN调优实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE"><span class="toc-text">1.准备数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-text">2.批量删除索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%8D%95%E8%A1%A8%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="toc-text">3.单表使用索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%85%A8%E5%80%BC%E5%8C%B9%E9%85%8D"><span class="toc-text">3.1 全值匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E6%B3%95%E5%88%99"><span class="toc-text">3.2 最左前缀法则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E7%B4%A2%E5%BC%95%E5%88%97%E4%B8%8A%E8%AE%A1%E7%AE%97-%E5%87%BD%E6%95%B0%E5%AF%BC%E8%87%B4%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">3.3 索引列上计算&#x2F;函数导致索引失效</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2%E5%AF%BC%E8%87%B4%E7%9A%84%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">3.4 范围查询导致的索引失效</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E4%B8%8D%E7%AD%89%E4%BA%8E-%E6%88%96%E8%80%85-lt-gt-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">3.5  不等于(!&#x3D; 或者&lt;&gt;)索引失效</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-is-not-null%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%EF%BC%8Cis-null%E5%8F%AF%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="toc-text">3.6 is not null无法使用索引，is null可使用索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-like%E4%BB%A5-%E5%BC%80%E5%A4%B4%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">3.7 like以%开头索引失效</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%AF%BC%E8%87%B4%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">3.8 类型转换导致索引失效</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-text">4. 关联查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%B7%A6%E5%A4%96%E8%BF%9E%E6%8E%A5"><span class="toc-text">4.1 左外连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%86%85%E8%BF%9E%E6%8E%A5-TODO"><span class="toc-text">4.2 内连接(TODO)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-text">4.3 子查询优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%8E%92%E5%BA%8F%E5%88%86%E7%BB%84%E4%BC%98%E5%8C%96"><span class="toc-text">5.排序分组优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E6%97%A0%E8%BF%87%E6%BB%A4%EF%BC%8C%E4%B8%8D%E7%B4%A2%E5%BC%95"><span class="toc-text">5.1 无过滤，不索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2%E9%A1%BA%E5%BA%8F%E9%94%99%EF%BC%8C%E5%BF%85%E6%8E%92%E5%BA%8F"><span class="toc-text">5.2顺序错，必排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E6%96%B9%E5%90%91%E5%8F%8D%EF%BC%8C%E5%BF%85%E6%8E%92%E5%BA%8F"><span class="toc-text">5.3 方向反，必排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E7%B4%A2%E5%BC%95%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-text">5.4 索引的选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E5%8F%8C%E8%B7%AF%E6%8E%92%E5%BA%8F-amp-%E5%8D%95%E8%B7%AF%E6%8E%92%E5%BA%8F"><span class="toc-text">5.5  双路排序&amp;单路排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-%E5%88%86%E7%BB%84%E4%BC%98%E5%8C%96"><span class="toc-text">5.6 分组优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95"><span class="toc-text">6. 覆盖索引</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%EF%BC%8C%E8%BF%BD%E8%B8%AA%E4%BC%98%E5%8C%96%E5%99%A8"><span class="toc-text">四，追踪优化器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%EF%BC%8C-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-text">五， 分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9E%82%E7%9B%B4%E5%88%87%E5%88%86"><span class="toc-text">1.垂直切分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%8D%95%E5%BA%93%E5%9E%82%E7%9B%B4%E5%88%86%E8%A1%A8"><span class="toc-text">1.1 单库垂直分表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%A4%9A%E5%BA%93%E5%9E%82%E7%9B%B4%E5%88%86%E8%A1%A8"><span class="toc-text">1.2 多库垂直分表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B0%B4%E5%B9%B3%E6%8B%86%E5%88%86"><span class="toc-text">2.水平拆分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%8D%95%E5%BA%93%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8"><span class="toc-text">2.1 单库水平分表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%A4%9A%E5%BA%93%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8"><span class="toc-text">2.2 多库水平分表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">3. 分库分表带来的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E8%B7%A8%E5%BA%93%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="toc-text">3.1 跨库关联查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%AD%97%E6%AE%B5%E5%86%97%E4%BD%99"><span class="toc-text">①字段冗余</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-text">②数据同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2%E5%85%A8%E5%B1%80%E8%A1%A8%EF%BC%88%E5%B9%BF%E6%92%AD%E8%A1%A8%EF%BC%89"><span class="toc-text">③全局表（广播表）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A3ER%E8%A1%A8"><span class="toc-text">④ER表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A4%E7%B3%BB%E7%BB%9F%E5%B1%82%E7%BB%84%E8%A3%85"><span class="toc-text">⑤系统层组装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text">3.2 分布式事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%8E%92%E5%BA%8F%EF%BC%8C%E7%BF%BB%E9%A1%B5%EF%BC%8C%E5%87%BD%E6%95%B0%E8%AE%A1%E7%AE%97%E9%97%AE%E9%A2%98"><span class="toc-text">3.3 排序，翻页，函数计算问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%85%A8%E5%B1%80%E4%B8%BB%E9%94%AE%E9%81%BF%E9%87%8D"><span class="toc-text">3.4 全局主键避重</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0UUID"><span class="toc-text">①UUID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">②数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2redis"><span class="toc-text">③redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A3%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95"><span class="toc-text">④雪花算法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90-%E8%AF%BB%E5%86%99%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">4. 多数据源&#x2F;读写数据源的解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%AE%A2%E6%88%B7%E7%AB%AFDAO-%E5%B1%82"><span class="toc-text">4.1 客户端DAO 层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-ORM%E6%A1%86%E6%9E%B6%E5%B1%82"><span class="toc-text">4.2 ORM框架层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E9%A9%B1%E5%8A%A8%E5%B1%82"><span class="toc-text">4.3 驱动层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E4%BB%A3%E7%90%86%E5%B1%82"><span class="toc-text">4.4 代理层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1"><span class="toc-text">4.5 数据库服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%EF%BC%8C%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text">六，主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-text">1. 基本原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%8ERedis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E5%B7%AE%E5%88%AB"><span class="toc-text">2.与Redis主从复制的差别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%A4%8D%E5%88%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E5%88%99"><span class="toc-text">3.复制的基本原则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%A4%8D%E5%88%B6%E7%9A%84%E6%9C%80%E5%A4%A7%E9%97%AE%E9%A2%98"><span class="toc-text">4.复制的最大问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E%E5%B8%B8%E8%A7%81%E9%85%8D%E7%BD%AE"><span class="toc-text">5.一主一从常见配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%EF%BC%8C%E7%A1%AC%E4%BB%B6%E5%B1%82%E9%9D%A2%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-text">七，硬件层面的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84CPU"><span class="toc-text">1.选择合适的CPU</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%86%85%E5%AD%98%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7"><span class="toc-text">2.内存的重要性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%A3%81%E7%9B%98%E5%AF%B9%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%A7%E8%83%BD%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-text">3.磁盘对数据库性能的影响</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%90%88%E7%90%86%E8%AE%BE%E7%BD%AERAID%E7%B1%BB%E5%9E%8B"><span class="toc-text">4.合理设置RAID类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-text">5.操作系统的选择</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-text">6.文件系统的选择</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/01/20/MySQL/MySQL%5B%E4%BA%8C%E5%8D%81%5D%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/" title="MySQL[二十]海量数据处理"><img src="/images/cover/mysql.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL[二十]海量数据处理"/></a><div class="content"><a class="title" href="/2022/01/20/MySQL/MySQL%5B%E4%BA%8C%E5%8D%81%5D%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/" title="MySQL[二十]海量数据处理">MySQL[二十]海量数据处理</a><time datetime="2022-01-19T16:00:00.000Z" title="发表于 2022-01-20 00:00:00">2022-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/17/MySQL/MySQL%5B%E5%8D%81%E4%B8%83%5D%E9%94%81%E6%A6%82%E8%BF%B0/" title="MySQL[十七]锁概述"><img src="/images/cover/mysql.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL[十七]锁概述"/></a><div class="content"><a class="title" href="/2022/01/17/MySQL/MySQL%5B%E5%8D%81%E4%B8%83%5D%E9%94%81%E6%A6%82%E8%BF%B0/" title="MySQL[十七]锁概述">MySQL[十七]锁概述</a><time datetime="2022-01-16T16:00:00.000Z" title="发表于 2022-01-17 00:00:00">2022-01-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/16/MySQL/MySQL%5B%E5%8D%81%E5%85%AD%5D%E5%B9%B6%E5%8F%91%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6-MVCC/" title="MySQL[十六]并发版本控制-MVCC"><img src="/images/cover/mysql.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL[十六]并发版本控制-MVCC"/></a><div class="content"><a class="title" href="/2022/01/16/MySQL/MySQL%5B%E5%8D%81%E5%85%AD%5D%E5%B9%B6%E5%8F%91%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6-MVCC/" title="MySQL[十六]并发版本控制-MVCC">MySQL[十六]并发版本控制-MVCC</a><time datetime="2022-01-15T16:00:00.000Z" title="发表于 2022-01-16 00:00:00">2022-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/15/MySQL/MySQL%5B%E5%8D%81%E4%BA%94%5Dundo%E6%97%A5%E5%BF%97/" title="MySQL[十五]undo日志"><img src="/images/cover/mysql.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL[十五]undo日志"/></a><div class="content"><a class="title" href="/2022/01/15/MySQL/MySQL%5B%E5%8D%81%E4%BA%94%5Dundo%E6%97%A5%E5%BF%97/" title="MySQL[十五]undo日志">MySQL[十五]undo日志</a><time datetime="2022-01-14T16:00:00.000Z" title="发表于 2022-01-15 00:00:00">2022-01-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/14/MySQL/MySQL%5B%E5%8D%81%E5%9B%9B%5Dredo%E6%97%A5%E5%BF%97/" title="MySQL[十四]redo日志"><img src="/images/cover/mysql.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL[十四]redo日志"/></a><div class="content"><a class="title" href="/2022/01/14/MySQL/MySQL%5B%E5%8D%81%E5%9B%9B%5Dredo%E6%97%A5%E5%BF%97/" title="MySQL[十四]redo日志">MySQL[十四]redo日志</a><time datetime="2022-01-13T16:00:00.000Z" title="发表于 2022-01-14 00:00:00">2022-01-14</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/images/cover/mysql.png')"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By 二十</div><div class="footer_custom_text">树是生活，埋的是我。看花就好，别看我落魄。</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/chocolate.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="二十,二十二十,二十二十二十,二十二十二十二十,二十二十二十二十二十" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>