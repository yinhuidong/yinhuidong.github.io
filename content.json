{"meta":{"title":"äºŒå","subtitle":"å·å°±å®Œäº†","description":"æ¬¢è¿æ¥å·","author":"äºŒå","url":"https://yinhuidong.github.io","root":"/"},"pages":[{"title":"åˆ†ç±»","date":"2022-01-10T12:46:21.418Z","updated":"2021-12-27T12:21:34.000Z","comments":true,"path":"categories/index.html","permalink":"https://yinhuidong.github.io/categories/index.html","excerpt":"","text":""},{"title":"","date":"2022-01-10T12:46:21.415Z","updated":"2021-12-27T12:21:34.000Z","comments":true,"path":"css/custom.css","permalink":"https://yinhuidong.github.io/css/custom.css","excerpt":"","text":"/* æ–‡ç« é¡µH1-H6å›¾æ ‡æ ·å¼æ•ˆæœ */ h1::before, h2::before, h3::before, h4::before, h5::before, h6::before { -webkit-animation: ccc 1.6s linear infinite ; animation: ccc 1.6s linear infinite ; } @-webkit-keyframes ccc { 0% { -webkit-transform: rotate(0deg); transform: rotate(0deg) } to { -webkit-transform: rotate(-1turn); transform: rotate(-1turn) } } @keyframes ccc { 0% { -webkit-transform: rotate(0deg); transform: rotate(0deg) } to { -webkit-transform: rotate(-1turn); transform: rotate(-1turn) } } #content-inner.layout h1::before { color: #ef50a8 ; margin-left: -1.55rem; font-size: 1.3rem; margin-top: -0.23rem; } #content-inner.layout h2::before { color: #fb7061 ; margin-left: -1.35rem; font-size: 1.1rem; margin-top: -0.12rem; } #content-inner.layout h3::before { color: #ffbf00 ; margin-left: -1.22rem; font-size: 0.95rem; margin-top: -0.09rem; } #content-inner.layout h4::before { color: #a9e000 ; margin-left: -1.05rem; font-size: 0.8rem; margin-top: -0.09rem; } #content-inner.layout h5::before { color: #57c850 ; margin-left: -0.9rem; font-size: 0.7rem; margin-top: 0.0rem; } #content-inner.layout h6::before { color: #5ec1e0 ; margin-left: -0.9rem; font-size: 0.66rem; margin-top: 0.0rem; } #content-inner.layout h1:hover, #content-inner.layout h2:hover, #content-inner.layout h3:hover, #content-inner.layout h4:hover, #content-inner.layout h5:hover, #content-inner.layout h6:hover { color: #49b1f5 ; } #content-inner.layout h1:hover::before, #content-inner.layout h2:hover::before, #content-inner.layout h3:hover::before, #content-inner.layout h4:hover::before, #content-inner.layout h5:hover::before, #content-inner.layout h6:hover::before { color: #49b1f5 ; -webkit-animation: ccc 3.2s linear infinite ; animation: ccc 3.2s linear infinite ; } /* é¡µé¢è®¾ç½®iconè½¬åŠ¨é€Ÿåº¦è°ƒæ•´ */ #rightside_config i.fas.fa-cog.fa-spin { animation: fa-spin 5s linear infinite ; } /*--------æ›´æ¢å­—ä½“------------*/ @font-face { font-family: 'tzy'; /* å­—ä½“åè‡ªå®šä¹‰å³å¯ */ src: url('https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/font/ZhuZiAWan.woff2'); /* å­—ä½“æ–‡ä»¶è·¯å¾„ */ font-display: swap; } body, .gitcalendar { font-family: tzy !important; } .categoryBar-list { max-height: 400px; } .clock-row { overflow: hidden; text-overflow: ellipsis; } /*3sä¸ºåŠ è½½åŠ¨ç”»çš„æ—¶é—´ï¼Œ1ä¸ºåŠ è½½åŠ¨ç”»çš„æ¬¡æ•°ï¼Œease-in-outä¸ºåŠ¨ç”»æ•ˆæœ*/ #page-header, #web_bg { -webkit-animation: imgblur 2s 1 ease-in-out; animation: imgblur 2s 1 ease-in-out; } @keyframes imgblur { 0% { filter: blur(5px); } 100% { filter: blur(0px); } } /*é€‚é…ä½¿ç”¨-webkitå†…æ ¸çš„æµè§ˆå™¨ */ @-webkit-keyframes imgblur { 0% { -webkit-filter: blur(5px); } 100% { -webkit-filter: blur(0px); } } .table-wrap img { margin: .6rem auto .1rem !important; } /* æ ‡ç­¾å¤–æŒ‚ ç½‘ç«™å¡ç‰‡ start */ .site-card-group img { margin: 0 auto .1rem !important; } .site-card-group .info a img { margin-right: 10px !important; } [data-theme='dark'] .site-card-group .site-card .info .title { color: #f0f0f0 !important; } [data-theme='dark'] .site-card-group .site-card .info .desc { color: rgba(255, 255, 255, .7) !important; } .site-card-group .info .desc { margin-top: 4px !important; } /* ä»£ç å—é¢œè‰² */ figure.highlight pre .addition { color: #00bf03 !important; }"},{"title":"","date":"2022-01-10T12:46:21.418Z","updated":"2021-12-27T12:21:35.000Z","comments":true,"path":"js/chocolate.js","permalink":"https://yinhuidong.github.io/js/chocolate.js","excerpt":"","text":"/* * @Author: tzy1997 * @Date: 2020-12-15 20:55:25 * @LastEditors: tzy1997 * @LastEditTime: 2021-01-12 19:02:25 */ // å‹æƒ…é“¾æ¥é¡µé¢ å¤´åƒæ‰¾ä¸åˆ°æ—¶ æ›¿æ¢å›¾ç‰‡ if (location.href.indexOf(\"link\") !== -1) { var imgObj = document.getElementsByTagName(\"img\"); for (i = 0; i < imgObj.length; i++) { imgObj[i].onerror = function() { this.src = \"https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/theme_f/friend_404.gif\" } } } $(function() { // æ°”æ³¡ function bubble() { $('#page-header').circleMagic({ radius: 10, density: .2, color: 'rgba(255,255,255,.4)', clearOffset: 0.99 }); }! function(p) { p.fn.circleMagic = function(t) { var o, a, n, r, e = !0, i = [], d = p.extend({ color: \"rgba(255,0,0,.5)\", radius: 10, density: .3, clearOffset: .2 }, t), l = this[0]; function c() { e = !(document.body.scrollTop > a) } function s() { o = l.clientWidth, a = l.clientHeight, l.height = a + \"px\", n.width = o, n.height = a } function h() { if (e) for (var t in r.clearRect(0, 0, o, a), i) i[t].draw(); requestAnimationFrame(h) } function f() { var t = this; function e() { t.pos.x = Math.random() * o, t.pos.y = a + 100 * Math.random(), t.alpha = .1 + Math.random() * d.clearOffset, t.scale = .1 + .3 * Math.random(), t.speed = Math.random(), \"random\" === d.color ? t.color = \"rgba(\" + Math.floor(255 * Math.random()) + \", \" + Math.floor(0 * Math.random()) + \", \" + Math.floor(0 * Math.random()) + \", \" + Math.random().toPrecision(2) + \")\" : t.color = d.color } t.pos = {}, e(), this.draw = function() { t.alpha"},{"title":"ç•™è¨€æ¿","date":"2022-01-10T12:46:21.418Z","updated":"2021-12-27T12:21:35.000Z","comments":true,"path":"message/index.html","permalink":"https://yinhuidong.github.io/message/index.html","excerpt":"","text":"æœ¬é¡µé¢è¿˜åœ¨å¼€å‘ä¸­â€¦â€¦"},{"title":"æ ‡ç­¾","date":"2022-01-10T12:46:21.418Z","updated":"2021-12-27T12:21:35.000Z","comments":true,"path":"tags/index.html","permalink":"https://yinhuidong.github.io/tags/index.html","excerpt":"","text":""},{"title":"æŠ€æœ¯ç¬”è®°","date":"2022-01-10T12:46:21.418Z","updated":"2021-12-27T12:21:35.000Z","comments":true,"path":"æŠ€æœ¯ç¬”è®°/index.html","permalink":"https://yinhuidong.github.io/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/index.html","excerpt":"","text":"æˆ‘æ˜¯æŠ€æœ¯ç¬”è®°"},{"title":"å…³äºæˆ‘","date":"2022-01-11T02:40:01.624Z","updated":"2022-01-11T02:40:01.624Z","comments":true,"path":"å…³äºæˆ‘/index.html","permalink":"https://yinhuidong.github.io/%E5%85%B3%E4%BA%8E%E6%88%91/index.html","excerpt":"","text":"å…³äºæˆ‘åå¹´ç”Ÿæ­»ä¸¤èŒ«èŒ«,å†™ç¨‹åºï¼Œåˆ°å¤©äº®ã€‚åƒè¡Œä»£ç ï¼ŒBugä½•å¤„è—ã€‚çºµä½¿ä¸Šçº¿åˆæ€æ ·ï¼Œæœä»¤æ”¹ï¼Œå¤•æ–­è‚ ã€‚é¢†å¯¼æ¯å¤©æ–°æƒ³æ³•ï¼Œå¤©å¤©æ”¹ï¼Œæ—¥æ—¥å¿™ã€‚ ç›¸é¡¾æ— è¨€ï¼ŒæƒŸæœ‰æ³ªåƒè¡Œã€‚æ¯æ™šç¯ç«é˜‘çŠå¤„ï¼Œç¨‹åºå‘˜ï¼ŒåˆåŠ ç­ï¼Œå·¥ä½œç‹‚~ ğŸ¤£ğŸ¤£ğŸ¤£ åŸºæœ¬ä¿¡æ¯ ç±»åˆ« ä¿¡æ¯ å‡ºç”Ÿå¹´æœˆ 1998å¹´11æœˆ ç°å±…åœ° åŒ—äº¬å¸‚ ç±è´¯ å¤§åº†å¸‚ é‚®ç®± &#49;&#x39;&#x37;&#50;&#x30;&#x33;&#57;&#x37;&#55;&#x33;&#x40;&#113;&#x71;&#x2e;&#x63;&#111;&#109; æ•™è‚²ç»å† æ—¶é—´ å­¦æ ¡ ä¸“ä¸š å¤‡æ³¨ 2017.09~2021.07 é½é½å“ˆå°”å¤§å­¦ è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ ç»Ÿæ‹›æœ¬ç§‘ å·¥ä½œç»å† æ—¶é—´ å…¬å¸ èŒä½ 2021.06~è‡³ä»Š mi Java å¼€å‘å·¥ç¨‹å¸ˆ ä¸“ä¸šæŠ€èƒ½ Java åŸºç¡€æ‰å®ã€æŒæ¡ JVM åŸç†ã€å¤šçº¿ç¨‹ã€ç½‘ç»œåŸç†ã€è®¾è®¡æ¨¡å¼ã€å¸¸ç”¨çš„æ•°æ®ç»“æ„å’Œç®—æ³• ç†Ÿæ‚‰ Windowsã€Macã€Linux æ“ä½œç³»ç»Ÿï¼Œç†Ÿç»ƒä½¿ç”¨ linux å¸¸ç”¨æ“ä½œæŒ‡ä»¤ ç†Ÿç»ƒä½¿ç”¨ IntelliJ IDEA å¼€å‘å·¥å…·(åŠå„ç§æ’ä»¶)ã€ç†Ÿç»ƒä½¿ç”¨ Git ç‰ˆæœ¬åŒæ­¥å·¥å…· é˜…è¯»è¿‡ Springã€SpringMVCã€ç­‰å¼€æºæ¡†æ¶æºç ï¼Œç†è§£å…¶è®¾è®¡åŸç†åŠåº•å±‚æ¶æ„ï¼Œå…·å¤‡æ¡†æ¶å®šåˆ¶å¼€å‘èƒ½åŠ› ç†è§£ Redis çº¿ç¨‹æ¨¡å‹ï¼ŒNetty çº¿ç¨‹æ¨¡å‹ï¼ŒæŒæ¡åŸºäºå“åº”å¼çš„å¼‚æ­¥éé˜»å¡æ¨¡å‹çš„åŸºæœ¬åŸç†ï¼Œäº†è§£ Webflux ç†Ÿç»ƒæŒæ¡åˆ†å¸ƒå¼ç¼“å­˜ Redisã€Elaticsearchï¼Œå¯¹åˆ†å¸ƒå¼é”ï¼Œå¹‚ç­‰ç­‰å¸¸è§é—®é¢˜æœ‰æ·±å…¥ç ”ç©¶åŠå¤šå¹´å®æˆ˜ç»éªŒ ç†Ÿæ‚‰å¸¸è§æ¶ˆæ¯ä¸­é—´ä»¶çš„ä½¿ç”¨ï¼Œæœ‰å¤šå¹´ RabbitMQ çš„å®æˆ˜å¼€å‘ç»éªŒï¼Œå¯¹é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—æœ‰æ·±å…¥ç†è§£ ç†Ÿç»ƒæŒæ¡ Mysql äº‹åŠ¡ï¼Œç´¢å¼•ï¼Œé”ï¼ŒSQL ä¼˜åŒ–ç›¸å…³çŸ¥è¯†ï¼Œå¯æ ¹æ®ä¸šåŠ¡åœºæ™¯ç»™å‡ºè¯¦ç»†åŠé«˜æ€§èƒ½è®¾è®¡æ–¹æ¡ˆ ç†Ÿç»ƒä½¿ç”¨æ•°æ®åº“æ“ä½œæ¡†æ¶ Mybatisã€Mybatsi-plus è¿›è¡Œé«˜æ•ˆä¸šåŠ¡åŠŸèƒ½å¼€å‘ æŒæ¡ springCloud ç›¸å…³æ¡†æ¶ï¼Œå¯¹ SpringBootã€SpringCloud åŸç†æœ‰ä¸€å®šäº†è§£ï¼Œæœ‰æˆç†Ÿé¡¹ç›®ç»éªŒ ç†Ÿæ‚‰å®šæ—¶ä»»åŠ¡åŠå»¶è¿Ÿä»»åŠ¡ç­‰ä¸šåŠ¡ç›¸å…³è®¾è®¡ï¼Œå¦‚ xxl-jobï¼Œå»¶è¿Ÿæ¶ˆæ¯ç­‰ç›¸å…³æŠ€æœ¯æœ‰å¤šå¹´å¼€å‘ç»éªŒ ç†Ÿæ‚‰å¾®æœåŠ¡æ€æƒ³ï¼ŒMVC åˆ†å±‚ï¼ŒDDD ç†è®ºï¼ŒæœåŠ¡æ‹†åˆ†ï¼Œæ²»ç†ï¼Œç›‘æ§ï¼ŒæœåŠ¡ç†”æ–­ï¼Œé™çº§ç­‰ç›¸å…³èƒ½åŠ› ç†Ÿæ‚‰ jvm åŸç†ï¼Œç†Ÿæ‚‰åƒåœ¾å›æ”¶ä»¥ jvm æ€§èƒ½è°ƒä¼˜æŠ€æœ¯ï¼Œæœ‰è¿‡çº¿ä¸ŠæœåŠ¡å™¨æ€§èƒ½ç›‘æµ‹åŠè°ƒä¼˜ç»éªŒ ç†Ÿæ‚‰å¤šçº¿ç¨‹åŠçº¿ç¨‹æ± ä½¿ç”¨ï¼Œæœ‰å¤šå¹´å¤šçº¿ç¨‹ä¸šåŠ¡å¤„ç†ç»éªŒï¼Œå°è£…è¿‡å¤šçº¿ç¨‹æ‰¹å¤„ç†å·¥å…·ç±»ç­‰å…¬ç”¨ç»„å»º äº†è§£ Mysql åˆ†åº“åˆ†è¡¨ç›¸å…³åŸç†ï¼Œå¦‚ Sardingsphereã€Mycat ç­‰æ¡†æ¶æœ‰ç›¸å…³ä½¿ç”¨ç»éªŒ äº†è§£æ“ä½œç³»ç»Ÿåº•å±‚åŸç†ä»¥åŠ Cã€C++ç¨‹åºå¼€å‘ï¼Œå¯¹è®¡ç®—æœºåº•å±‚åŸç†æœ‰åˆæ­¥äº†è§£ äº†è§£å‰ç«¯å¼€å‘ï¼Œäº†è§£ htmlï¼Œcssï¼Œjsï¼Œvue ç­‰å‰ç«¯æŠ€æœ¯ï¼Œå¯¹å‰ç«¯å¼€å‘æœ‰ä¸€å®šçš„äº†è§£ ç ”ç©¶è¿‡å•ç‰‡æœºç­‰ç¡¬ä»¶å¼€å‘ï¼Œå–œæ¬¢ç§‘æŠ€äº§å“ï¼Œå–œæ¬¢è½¯ä»¶ï¼Œå–œæ¬¢æŠ˜è…¾å„ç§ç”µå­äº§å“ä»¥åŠè½¯ä»¶ é¡¹ç›®ç»éªŒâ€‹ è‡ªæˆ‘è¯„ä»·NBã€‚"}],"posts":[{"title":"ThreadLocal","slug":"JUC/ThreadLocal","date":"2022-01-11T11:08:04.200Z","updated":"2022-01-11T11:31:15.889Z","comments":true,"path":"2022/01/11/JUC/ThreadLocal/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/ThreadLocal/","excerpt":"","text":"ä¸€ï¼ŒTLçš„åŸºæœ¬ä½¿ç”¨ä¸åŸç†ä¸ºçº¿ç¨‹åˆ›å»ºç‹¬ä¸€ä»½çš„å‰¯æœ¬æ•°æ®ã€‚ 1.åŸºæœ¬ä½¿ç”¨12345678910111213141516171819202122232425262728293031323334/** * @author äºŒå * @since 2021/8/28 11:19 ä¸‹åˆ */public class TlTest &#123; private static AtomicInteger id = new AtomicInteger(0); private static ThreadLocal&lt;Integer&gt; tl = ThreadLocal.withInitial(()-&gt;id.getAndIncrement()); private static CountDownLatch count = new CountDownLatch(3); public static void main(String[] args)throws Exception &#123; new Thread(()-&gt;&#123; System.out.println(tl.get()+&quot; &quot;+Thread.currentThread().getName()); tl.remove(); count.countDown(); &#125;,&quot;A&quot;).start(); new Thread(()-&gt;&#123; System.out.println(tl.get()+&quot; &quot;+Thread.currentThread().getName()); tl.remove(); count.countDown(); &#125;,&quot;B&quot;).start(); new Thread(()-&gt;&#123; System.out.println(tl.get()+&quot; &quot;+Thread.currentThread().getName()); tl.remove(); count.countDown(); &#125;,&quot;C&quot;).start(); count.await(); &#125;&#125; 2.åŸç†åˆ†æâ€‹ é‡Œé¢ç»´æŠ¤ä¸€ä¸ªThreadLocalMapç»“æ„ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªæ¡¶ä½ã€‚ â€‹ ä½¿ç”¨ThreadLocalå®šä¹‰çš„å˜é‡ï¼Œå°†æŒ‡å‘å½“å‰çº¿ç¨‹æœ¬åœ°çš„ä¸€ä¸ªLocalMapç©ºé—´ã€‚ â€‹ ThreadLocalå˜é‡ä½œä¸ºkeyï¼Œå…¶å†…å®¹ä½œä¸ºvalueï¼Œä¿å­˜åœ¨æœ¬åœ°ã€‚ â€‹ å¤šçº¿ç¨‹å¯¹ThreadLocalå¯¹è±¡è¿›è¡Œæ“ä½œï¼Œå®é™…ä¸Šæ˜¯å¯¹å„è‡ªçš„æœ¬åœ°å˜é‡è¿›è¡Œæ“ä½œï¼Œä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ â€‹ å‡è®¾ä¸€ä¸ªç±»é‡Œé¢å®šä¹‰äº†ä¸‰ä¸ªthreadlocalï¼Œä¸‰ä¸ªçº¿ç¨‹æ¥è®¿é—®è¿™ä¸ªç±»ï¼Œæ¯ä¸ªçº¿ç¨‹æœ¬åœ°ä¼šç»´æŠ¤ä¸€ä¸ªthreadlocalmapï¼Œæ¯ä¸€ä¸ªmapé‡Œé¢ä¼šæœ‰ä¸‰ä¸ªentryï¼Œkeyæ˜¯threadlocalå¯¹è±¡ï¼Œvalueæ˜¯threadlocalé‡Œé¢setçš„å€¼ã€‚ äºŒï¼ŒTLæºç 1.å±æ€§1234567891011121314151617181920212223242526 /** * çº¿ç¨‹è·å–Threadlocal.get()æ—¶ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åœ¨æŸä¸ªthreadlocalå¯¹è±¡ä¸Šgetï¼Œä¼šç»™å½“å‰çº¿ç¨‹åˆ†é…ä¸€ä¸ªvalueï¼Œ * è¿™ä¸ªvalueå’Œå½“å‰çš„threadlocalå¯¹è±¡è¢«åŒ…è£…æˆä¸€ä¸ªentryï¼Œå…¶ä¸­key=threadlocalå¯¹è±¡ï¼Œ * value=threadlocalå¯¹è±¡ç»™å½“å‰çº¿ç¨‹ç”Ÿæˆçš„valueã€‚è¿™ä¸ªentryå­˜æ”¾åˆ°å“ªä¸ªä½ç½®ä¸è¿™ä¸ªvalueæœ‰å…³ã€‚ */private final int threadLocalHashCode = nextHashCode();//åˆ›å»ºthreadlocalå¯¹è±¡æ—¶ä¼šä½¿ç”¨åˆ°ï¼Œæ¯åˆ›å»ºä¸€ä¸ªthreadlocalå¯¹è±¡å°±ä¼šä½¿ç”¨å®ƒåˆ†é…ä¸€ä¸ªhashå€¼ç»™å¯¹è±¡ã€‚private static AtomicInteger nextHashCode = new AtomicInteger();//æ¯åˆ›å»ºä¸€ä¸ªthreadlocalå¯¹è±¡ï¼Œè¿™ä¸ªnextHashCodeå°±ä¼šå¢é•¿0x61c88647ã€‚private static final int HASH_INCREMENT = 0x61c88647;//åˆ›å»ºæ–°çš„threadlocalå¯¹è±¡çš„æ—¶å€™ï¼Œç»™å½“å‰å¯¹è±¡åˆ†é…hashçš„æ—¶å€™ç”¨åˆ°ã€‚private static int nextHashCode() &#123; return nextHashCode.getAndAdd(HASH_INCREMENT);&#125;//ç•™ç»™å­ç±»é‡å†™æ‰©å±•çš„protected T initialValue() &#123; return null;&#125;//å¸¦åˆå§‹åŒ–å€¼å¾—threadlocalpublic static &lt;S&gt; ThreadLocal&lt;S&gt; withInitial(Supplier&lt;? extends S&gt; supplier) &#123; return new SuppliedThreadLocal&lt;&gt;(supplier);&#125;public ThreadLocal() &#123;&#125; 2.get()1234567891011121314151617public T get() &#123; //è·å–å½“å‰çº¿ç¨‹ Thread t = Thread.currentThread(); //æ ¹æ®å½“å‰çº¿ç¨‹è·å–å¯¹åº”çš„map ThreadLocalMap map = getMap(t); if (map != null) &#123; //å·²ç»åˆå§‹åŒ– //æ ¹æ®å½“å‰threadlocalå¯¹è±¡è·å–entryèŠ‚ç‚¹ ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) &#123; //èŠ‚ç‚¹åˆå§‹åŒ–è¿‡ //è·å–entryçš„valueå¹¶è¿”å› T result = (T)e.value; return result; &#125; &#125; //èµ°åˆ°è¿™é‡Œè¯´æ˜mapå°šæœªåˆå§‹åŒ–è·å–entryå°šæœªåˆå§‹åŒ– return setInitialValue();&#125; 2.1 setInitialValue()1234567891011121314151617private T setInitialValue() &#123; //è·å–åˆå§‹å€¼ï¼Œç•™ç»™å­ç±»é‡å†™ T value = initialValue(); //è·å–å½“å‰çº¿ç¨‹ Thread t = Thread.currentThread(); //è·å–å½“å‰çº¿ç¨‹å¯¹åº”çš„map ThreadLocalMap map = getMap(t); //å¦‚æœmapåˆå§‹åŒ–è¿‡ if (map != null) //mapé‡Œé¢æ”¾å…¥å½“å‰å¯¹è±¡å’Œvalue map.set(this, value); else //mapå°šæœªåˆå§‹åŒ–è¿‡ //åˆå§‹åŒ–map--ç›´æ¥newä¸€ä¸ªå¹¶æ”¾å…¥å½“å‰å¯¹è±¡å’Œvalue createMap(t, value); //è¿”å›value return value;&#125; 2.2 getMapï¼ˆï¼‰1234//è¿”å›å½“å‰çº¿ç¨‹çš„threadLocalsThreadLocalMap getMap(Thread t) &#123; return t.threadLocals;&#125; 2.3 createMapï¼ˆï¼‰1234//åˆ©ç”¨æ„é€ å™¨åˆå§‹åŒ–threadLocalså¹¶å°†å½“å‰çº¿ç¨‹å’Œçº¿ç¨‹å¯¹åº”çš„valueè®¾ç½®è¿›å»void createMap(Thread t, T firstValue) &#123; t.threadLocals = new ThreadLocalMap(this, firstValue);&#125; 3.set()12345678public void set(T value) &#123; Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) //å½“å‰çº¿ç¨‹å¯¹åº”çš„mapå·²ç»åˆå§‹åŒ– map.set(this, value); //mapæ”¾å…¥å€¼ else //mapæœªåˆå§‹åŒ– createMap(t, value); //åˆå§‹åŒ–map&#125; 4.remove()12345public void remove() &#123; ThreadLocalMap m = getMap(Thread.currentThread()); if (m != null) //mapå·²ç»åˆå§‹åŒ– m.remove(this); //è°ƒç”¨mapçš„removeç§»é™¤æ‰å½“å‰å¯¹è±¡å¯¹åº”çš„entry&#125; 5.å†…éƒ¨ç±»ThreadLocalMap1234567891011121314151617181920212223242526272829303132333435363738394041424344454647//threadlocalmapé‡Œé¢çš„keyæ˜¯å¼±å¼•ç”¨ ï¼Œkey=threadlocalå¯¹è±¡//valueæ˜¯å¼ºå¼•ç”¨ï¼Œvalueä¿å­˜çš„æ˜¯threadlocalå¯¹è±¡ä¸å½“å‰çº¿ç¨‹å…³è”çš„value//è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜æ³„æ¼static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; &#123; Object value; Entry(ThreadLocal&lt;?&gt; k, Object v) &#123; super(k); value = v; &#125;&#125;//mapçš„åˆå§‹åŒ–å®¹é‡ä¸º16private static final int INITIAL_CAPACITY = 16;//mapé‡Œé¢çš„entryæ¡¶ä½åˆ—è¡¨private Entry[] table;//åˆ—è¡¨å®¹é‡private int size = 0;/** * æ‰©å®¹é˜ˆå€¼ å½“å‰æ•°ç»„é•¿åº¦çš„ä¸‰åˆ†ä¹‹äºŒ */private int threshold; // Default to 0//å°†æ‰©å®¹é˜ˆå€¼è®¾ç½®ä¸ºå½“å‰æ•°ç»„é•¿åº¦çš„ä¸‰åˆ†ä¹‹äºŒprivate void setThreshold(int len) &#123; threshold = len * 2 / 3;&#125;//è·å–ä¸‹ä¸€ä¸ªä½ç½®private static int nextIndex(int i, int len) &#123; return ((i + 1 &lt; len) ? i + 1 : 0);&#125;//è·å–ä¸‹ä¸€ä¸ªä½ç½®private static int prevIndex(int i, int len) &#123; return ((i - 1 &gt;= 0) ? i - 1 : len - 1);&#125;//å…¶å®ä»ä¸Šå±‚çš„apiå¯ä»¥å‘ç°è¿™é‡Œå…¶å®æ˜¯å»¶è¿Ÿåˆå§‹åŒ–ï¼Œåªæœ‰çº¿ç¨‹ç¬¬ä¸€æ¬¡è°ƒç”¨threadlocalçš„//getæˆ–è€…setçš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ã€‚ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123; //åˆå§‹åŒ–æ•£åˆ—è¡¨ï¼Œé•¿åº¦ä¸º16 table = new Entry[INITIAL_CAPACITY]; //è®¡ç®—entryçš„å­˜å‚¨ä½ç½® int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1); //åˆ›å»ºæ–°çš„entry table[i] = new Entry(firstKey, firstValue); //å ç”¨é‡è®¾ç½®ä¸º1 size = 1; //ä¿®æ”¹æ‰©å®¹é˜ˆå€¼ä¸ºåˆå§‹åŒ–é•¿åº¦ setThreshold(INITIAL_CAPACITY);&#125; 5.1 getEntry()123456789private Entry getEntry(ThreadLocal&lt;?&gt; key) &#123; //æ ¹æ®å½“å‰çº¿ç¨‹çš„threadlocalå¯¹è±¡è·å–entryçš„å­˜å‚¨ä½ç½® int i = key.threadLocalHashCode &amp; (table.length - 1); Entry e = table[i]; if (e != null &amp;&amp; e.get() == key) //æ ¡éªŒentryæ˜¯ä¸æ˜¯å·²ç»ä¸¢äº†ï¼Œæˆ–è€…å·²ç»è¢«è¦†ç›– return e; else //æ‰§è¡Œæ‰“è¿™é‡Œè¯´æ˜entryå·²ç»ä¸¢äº†æˆ–è€…è¢«å‘ç”Ÿäº†hashå†²çªï¼Œç»§ç»­å‘åå¯»æ‰¾ return getEntryAfterMiss(key, i, e);&#125; 5.2 getEntryAfterMiss()123456789101112131415161718192021222324private Entry getEntryAfterMiss(ThreadLocal&lt;?&gt; key, int i, Entry e) &#123; //è·å–æ•£åˆ—è¡¨ Entry[] tab = table; //è·å–æ•£åˆ—è¡¨çš„é•¿åº¦ int len = tab.length; //å¦‚æœentryä¸ä¸ºç©ºï¼Œé‚£å°±è¯´æ˜entryhashå†²çªäº† while (e != null) &#123; //è·å–entryå¯¹åº”çš„threadlocalå¯¹è±¡ ThreadLocal&lt;?&gt; k = e.get(); //è¯´æ˜keyå¯¹åº”çš„threadlocalå¯¹è±¡å·²ç»è¢«å›æ”¶äº†ï¼Œå½“å‰entryå±äºè„æ•°æ® if (k == key) //ç›´æ¥è¿”å› return e; //å¦‚æœkey==nullï¼Œè¯´æ˜keyå¯¹åº”çš„threadlocalå¯¹è±¡å·²ç»è¢«å›æ”¶äº†ï¼Œå½“å‰entryå±äºè„æ•°æ® if (k == null) //åšä¸€æ¬¡æ¢æµ‹å¼è¿‡æœŸæ¸…ç† expungeStaleEntry(i); else //æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜å‘ç”Ÿäº†hashå†²çªï¼Œç»§ç»­ä»å½“å‰ä½ç½®å¾€åå¯»æ‰¾ i = nextIndex(i, len); e = tab[i]; &#125; //è¯´æ˜entryè¿‡æœŸäº†ï¼Œç›´æ¥è¿”å›null return null;&#125; 5.3 expungeStaleEntry() æ¢æµ‹å¼è¿‡æœŸæ¸…ç†123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051private int expungeStaleEntry(int staleSlot) &#123; //è·å–æ•£åˆ—è¡¨ Entry[] tab = table; //è·å–æ•£åˆ—è¡¨çš„é•¿åº¦ int len = tab.length; //å› ä¸ºæ­¤å¤„threadlocalå¯¹è±¡å·²ç»è¢«å›æ”¶ï¼Œæ‰€ä»¥ç›´æ¥å°†valueè®¾ç½®ä¸ºnullï¼Œhelp GC tab[staleSlot].value = null; //å†è®²å½“å‰æ¡¶ä½è®¾ç½®ä¸ºç©º tab[staleSlot] = null; /** * ä¸ºä»€ä¹ˆè¿™é‡Œè¦åˆ†ä¸¤æ¬¡è®¾ç½®ä¸ºnullï¼Ÿ * å› ä¸ºkeyæœ¬èº«æ˜¯å¼±å¼•ç”¨ï¼Œä½†æ˜¯valueæ˜¯å¼ºå¼•ç”¨ï¼Œå¦‚æœç›´æ¥å›æ”¶æ¡¶ä½ï¼Œvalueæ— æ³•ç›´æ¥è¢«å›æ”¶ */ //æ•£åˆ—è¡¨çš„å ç”¨é•¿åº¦-1 size--; Entry e; int i; //ä»å½“å‰èŠ‚ç‚¹æ‰€åœ¨ä½ç½®çš„ä¸‹ä¸€ä¸ªä½ç½®ç›´åˆ°æœ€åå¾ªç¯ï¼Œ for (i = nextIndex(staleSlot, len); //åœæ­¢æ¡ä»¶æ˜¯å½“å‰ç´¢å¼•å¯¹åº”æ¡¶ä½=null (e = tab[i]) != null; //å¾ªç¯æ¡ä»¶æ˜¯æ¯æ¬¡ç´¢å¼•+1 i = nextIndex(i, len)) &#123; //è·å–entryçš„threadlocalå¯¹è±¡ ThreadLocal&lt;?&gt; k = e.get(); if (k == null) &#123;//å¦‚æœå¯¹è±¡ä¸ºç©ºï¼Œè¯´æ˜å·²ç»è¿‡æœŸäº†ï¼Œentryæ˜¯è„æ•°æ® //å›æ”¶ e.value = null; tab[i] = null; size--; &#125; else &#123;//æ­¤æ—¶è¯´æ˜entryä¸æ˜¯è„æ•°æ® //è®¡ç®—threadlocalå¯¹è±¡åœ¨æ•£åˆ—è¡¨çš„æ–°ç´¢å¼•ï¼Œä¸ºå•¥é‡æ–°è®¡ç®—ï¼Ÿ //å› ä¸ºå½“å‰getåˆ°äº†è„æ•°æ®ï¼Œåˆšåˆšä»æ•£åˆ—è¡¨ç§»é™¤ï¼Œæ‰€ä»¥æ•£åˆ—è¡¨çš„å ç”¨é‡å·²ç»å‘ç”Ÿäº†å˜åŒ– int h = k.threadLocalHashCode &amp; (len - 1); //å¦‚æœæ²¡æœ‰å‘ç”Ÿhashå†²çª if (h != i) &#123; //å°†åŸæ¥çš„æ¡¶ä½é‡Šæ”¾ tab[i] = null; //å¯»æ‰¾å­˜æ”¾ä½ç½®ï¼Œç›´åˆ°æ‰€åœ¨æ¡¶ä½ä¸ºç©ºï¼Œå› ä¸ºå¯èƒ½è®¡ç®—å‡ºçš„ä½ç½®å‘ç”Ÿäº†hashå†²çªï¼Œ //è¿™ä¸ªæ—¶å€™ï¼Œå°±è¦ç´¢å¼•ä¸‹æ¨åˆ°ä¸‹ä¸€æ¡¶ä½ while (tab[h] != null) h = nextIndex(h, len); //å°†entryæ”¾åˆ°æ–°çš„æ¡¶ä½ tab[h] = e; &#125; &#125; &#125; //è¿”å›æœ€åå¤„ç†çš„ç´¢å¼•å¤„ return i;&#125; 5.4 set()1234567891011121314151617181920212223242526272829private void set(ThreadLocal&lt;?&gt; key, Object value) &#123; Entry[] tab = table; int len = tab.length; int i = key.threadLocalHashCode &amp; (len-1); for (Entry e = tab[i];//å½“å‰threadlocalå¯¹è±¡æ‰€å¯¹åº”çš„èŠ‚ç‚¹ e != null; //ç»ˆæ­¢æ¡ä»¶æ˜¯entryä¸ºç©ºï¼Œè¯´æ˜è¿™ä¸ªæ¡¶ä½èƒ½å­˜æ”¾entry e = tab[i = nextIndex(i, len)]) &#123; //æ¡¶ä½ä¸‹æ¨ ThreadLocal&lt;?&gt; k = e.get(); //å¦‚æœå½“å‰å¯¹è±¡æ‰€å¯¹åº”çš„æ¡¶ä½æœ‰å€¼ï¼Œä¸”å½“å‰æ¡¶ä½çš„keyæ˜¯å½“å‰å¯¹è±¡ï¼Œ //è¯´æ˜è¿™æ˜¯ä¸€æ¬¡å€¼é‡ç½®ï¼Œç›´æ¥è¦†ç›–æ—§çš„å€¼å³å¯ if (k == key) &#123; e.value = value; return; &#125; //å¦‚æœk==nullï¼Œè¯´æ˜å½“å‰ä½ç½®å¯¹åº”çš„entryæ˜¯è¿‡æœŸçš„ï¼Œ if (k == null) &#123; replaceStaleEntry(key, value, i); return; &#125; &#125; //æ¥åˆ°è¿™é‡Œçš„æ¡ä»¶ï¼šè¿™æ¬¡æ“ä½œä¸æ˜¯ä¸€æ¬¡å¯¹å·²ç»æœ‰çš„å€¼å¾—è¦†ç›–ï¼Œæˆ–è€…å·²ç»æ‰¾åˆ°äº†åº”è¯¥å­˜æ”¾å½“å‰entryçš„æ¡¶ä½ tab[i] = new Entry(key, value); int sz = ++size; //å¦‚æœè¾¾åˆ°äº†æ‰©å®¹çš„æ¡ä»¶ï¼Œè¿›è¡Œæ‰©å®¹æ“ä½œ if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold) rehash();&#125; 5.5 replaceStaleEntry()æ›¿æ¢è¿‡æœŸentry123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051//æ›¿æ¢è¿‡æœŸentryprivate void replaceStaleEntry(ThreadLocal&lt;?&gt; key, Object value, int staleSlot) &#123; Entry[] tab = table; int len = tab.length; Entry e; //è¿›å…¥è¿™ä¸ªæ–¹æ³•çš„æ¡ä»¶è¯´æ˜ï¼šå½“å‰ä½ç½®çš„èŠ‚ç‚¹å…¶å®æ˜¯è¿‡æœŸçš„ï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠå›æ”¶ int slotToExpunge = staleSlot; //å½“å‰æ¡¶ä½çš„ç´¢å¼• //ä»å½“å‰ä½ç½®å‘å‰æ¸…ç† for (int i = prevIndex(staleSlot, len); //i=å½“å‰ç´¢å¼•çš„å‰ä¸€ä¸ªç´¢å¼• (e = tab[i]) != null; //ç»ˆæ­¢æ¡ä»¶æ˜¯ç´¢å¼•æ‰€åœ¨çš„æ¡¶ä½æœ‰æ•°æ® i = prevIndex(i, len)) //å¾ªç¯æ¡ä»¶æ˜¯æ¯æ¬¡å¾€å‰ä¸€ä¸ªæ¡¶ä½ //è¯´æ˜æ˜¯è¿‡æœŸçš„ï¼Œé‚£å°±ç»§ç»­å¾€å‰æ¸…ç† if (e.get() == null) slotToExpunge = i; //ä»å½“å‰ä½ç½®å‘åæ¸…ç† for (int i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) &#123; ThreadLocal&lt;?&gt; k = e.get(); //å¦‚æœå½“å‰ä½ç½®çš„keyå’Œå½“å‰threadlocalå¯¹è±¡ä¸€è‡´ if (k == key) &#123; //è¿›è¡Œå€¼è¦†ç›–æ“ä½œ e.value = value; //å°†è¿‡æœŸæ•°æ®æ”¾åˆ°å½“å‰å¾ªç¯åˆ°çš„table[i] tab[i] = tab[staleSlot]; //è¿™é‡Œçš„é€»è¾‘å…¶å®å°±æ˜¯è¿›è¡Œä¸€ä¸‹ä½ç½®ä¼˜åŒ– tab[staleSlot] = e; //è¯´æ˜ä¸Šé¢çš„å¾ªç¯å¹¶æ²¡æœ‰æ‰¾åˆ°è¿‡æœŸæ•°æ® if (slotToExpunge == staleSlot) //å§æ¢æµ‹çš„å¼€å§‹ä½ç½®æ”¹æˆå½“å‰ä½ç½® slotToExpunge = i; //è¿›è¡Œæ¢æµ‹å¼è¿‡æœŸæ¸…ç† cleanSomeSlots(expungeStaleEntry(slotToExpunge), len); return; &#125; //å½“å‰éå†entryæ˜¯ä¸€ä¸ªè¿‡æœŸæ•°æ® &amp;&amp; å¾€å‰æ‰¾è¿‡æœŸæ•°æ®æ²¡æ‰¾åˆ° if (k == null &amp;&amp; slotToExpunge == staleSlot) //æ›´æ–°æ¢æµ‹ä½ç½®ä¸ºå½“å‰ä½ç½® slotToExpunge = i; &#125; //å°†æ–°çš„å€¼æ”¾å…¥å½“å‰èŠ‚ç‚¹ tab[staleSlot].value = null; tab[staleSlot] = new Entry(key, value); //å¦‚æœä¸¤ä¸ªç´¢å¼•ä¸ç›¸ç­‰ï¼Œå°±ç»§ç»­æ¸…ç† if (slotToExpunge != staleSlot) cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);&#125; 5.6 cleanSomeSlots()å¯å‘å¼æ¸…ç†å·¥ä½œ123456789101112131415161718192021//å¯å‘å¼æ¸…ç†å·¥ä½œ i å¼€å§‹æ¸…ç†ä½ç½® n ç»“æŸæ¡ä»¶ï¼Œæ•°ç»„é•¿åº¦private boolean cleanSomeSlots(int i, int n) &#123; boolean removed = false; Entry[] tab = table; int len = tab.length; do &#123; //è·å–å½“å‰içš„ä¸‹ä¸€ä¸ªä¸‹æ ‡ i = nextIndex(i, len); //è·å–å½“å‰ä¸‹æ ‡ä¸ºIçš„å…ƒç´  Entry e = tab[i]; //æ–­å®šä¸ºè¿‡æœŸå…ƒç´  if (e != null &amp;&amp; e.get() == null) &#123; n = len;//æ›´æ–°æ•°ç»„é•¿åº¦ removed = true; //ä»å½“å‰è¿‡æœŸä½ç½®å¼€å§‹ä¸€æ¬¡è°ˆæµ‹è¯•æ¸…ç†å·¥ä½œ i = expungeStaleEntry(i); &#125; &#125; while ( (n &gt;&gt;&gt;= 1) != 0);//å‡è®¾table.length=16 return removed;&#125; 5.7 rehash()12345678private void rehash() &#123; //éå†ï¼Œæ¢æµ‹å¼æ¸…ç†ï¼Œå¹²æ‰æ‰€æœ‰è¿‡æœŸæ•°æ® expungeStaleEntries(); //ä»ç„¶è¾¾åˆ°æ‰©å®¹æ¡ä»¶ if (size &gt;= threshold - threshold / 4) //æ‰©å®¹ resize();&#125; 5.8 resize()123456789101112131415161718192021222324252627private void resize() &#123; Entry[] oldTab = table; int oldLen = oldTab.length; int newLen = oldLen * 2; //æ‰©å®¹ä¸ºåŸæ¥çš„2å€ Entry[] newTab = new Entry[newLen]; int count = 0; for (int j = 0; j &lt; oldLen; ++j) &#123; Entry e = oldTab[j]; //è®¿é—®oldè¡¨æŒ‡å®šä½ç½®çš„data if (e != null) &#123; //dataå­˜åœ¨ ThreadLocal&lt;?&gt; k = e.get(); if (k == null) &#123; //è¿‡æœŸæ•°æ® e.value = null; // Help the GC &#125; else &#123; int h = k.threadLocalHashCode &amp; (newLen - 1);//é‡æ–°è®¡ç®—hashå€¼ while (newTab[h] != null) //è·å–åˆ°ä¸€ä¸ªæœ€è¿‘çš„ï¼Œå¯ä»¥ä½¿ç”¨çš„ä½ç½® h = nextIndex(h, newLen); newTab[h] = e; //æ•°æ®è¿ç§» count++; &#125; &#125; &#125; setThreshold(newLen);//è®¾ç½®ä¸‹ä¸€æ¬¡æ‰©å®¹çš„æŒ‡æ ‡ size = count; table = newTab;&#125; 5.9 remove()12345678910111213141516private void remove(ThreadLocal&lt;?&gt; key) &#123; Entry[] tab = table; int len = tab.length; int i = key.threadLocalHashCode &amp; (len-1); for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) &#123; //ä»å½“å‰ä½ç½®å¼€å§‹ï¼Œå¦‚æœæ¡¶ä½æ˜¯ç©ºï¼Œå°±å»ä¸‹ä¸€ä¸ª //å¦‚æœä¸ä¸ºç©ºçš„æ¡¶ä½ä¸å½“å‰çº¿ç¨‹çš„threadlocalå¯¹è±¡ä¸€è‡´ if (e.get() == key) &#123; e.clear(); //å¹²æ‰keyçš„å¼•ç”¨ expungeStaleEntry(i); //æ¢æµ‹å¼è¿‡æœŸæ¸…ç† return; &#125; &#125;&#125;","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"é˜»å¡é˜Ÿåˆ—","slug":"JUC/é˜»å¡é˜Ÿåˆ—","date":"2022-01-11T11:07:55.302Z","updated":"2022-01-11T11:25:05.613Z","comments":true,"path":"2022/01/11/JUC/é˜»å¡é˜Ÿåˆ—/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97/","excerpt":"","text":"æŠŠå¤šçº¿ç¨‹ç¯å¢ƒæ¯”ä½œæ˜¯åˆ†å¸ƒå¼çš„è¯ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¸çº¿ç¨‹ä¹‹é—´æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ç§æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼è¿›è¡Œæ•°æ®é€šä¿¡å’Œè§£è€¦å‘¢ï¼Ÿâ€‹ ä¸€ï¼Œé˜»å¡é˜Ÿåˆ—ä½¿ç”¨æ¡ˆä¾‹1.æ³¨å†ŒæˆåŠŸåå¢åŠ ç§¯åˆ†å‡å¦‚æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œå°±æ˜¯ç”¨æˆ·æ³¨å†Œçš„æ—¶å€™ï¼Œåœ¨æ³¨å†ŒæˆåŠŸä»¥åå‘æ”¾ç§¯åˆ†ã€‚è¿™ä¸ªåœºæ™¯åœ¨ä¸€èˆ¬æ¥è¯´ï¼Œä¼šè¿™ä¹ˆå»å®ç°ï¼šä½†æ˜¯å®é™…ä¸Šï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸¤ä¸ªé—®é¢˜ï¼š æ€§èƒ½ï¼Œåœ¨æ³¨å†Œè¿™ä¸ªç¯èŠ‚é‡Œé¢ï¼Œå‡å¦‚æ·»åŠ ç”¨æˆ·éœ€è¦èŠ±è´¹ 1 ç§’é’Ÿï¼Œå¢åŠ ç§¯åˆ†éœ€è¦èŠ±è´¹ 1 ç§’é’Ÿï¼Œé‚£ä¹ˆæ•´ä¸ªæ³¨å†Œç»“æœçš„è¿”å›å°±å¯èƒ½éœ€è¦å¤§äº 2 ç§’ï¼Œè™½ç„¶å½±å“ä¸æ˜¯å¾ˆå¤§ï¼Œä½†æ˜¯åœ¨é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åšä¸€äº›ä¼˜åŒ–ã€‚ è€¦åˆï¼Œæ·»åŠ ç”¨æˆ·å’Œå¢åŠ ç§¯åˆ†ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸¤ä¸ªé¢†åŸŸï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¢åŠ ç§¯åˆ†å¹¶ä¸æ˜¯æ³¨å†Œå¿…é¡»è¦å…·å¤‡çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸€æ—¦å¢åŠ ç§¯åˆ†è¿™ä¸ªé€»è¾‘å‡ºç°å¼‚å¸¸ï¼Œå°±ä¼šå¯¼è‡´æ³¨å†Œå¤±è´¥ã€‚è¿™ç§è€¦åˆåœ¨ç¨‹åºè®¾è®¡çš„æ—¶å€™æ˜¯ä¸€å®šè¦è§„é¿çš„ã€‚ å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å¼‚æ­¥çš„æ–¹å¼æ¥å®ç°ã€‚â€‹ 2.æ”¹é€ ä¹‹å‰çš„ä»£ç é€»è¾‘12345678910111213141516171819202122232425262728293031323334353637public class UserService &#123; public boolean register() &#123; User user = new User(); user.setName(&quot;Mic&quot;); addUser(user); sendPoints(user); return true; &#125; public static void main(String[] args) &#123; new UserService().register(); &#125; private void addUser(User user) &#123; System.out.println(&quot; æ·»åŠ ç”¨æˆ·ï¼š&quot; + user); try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; private void sendPoints(User user) &#123; System.out.println(&quot; å‘ é€ ç§¯ åˆ† ç»™ æŒ‡ å®š ç”¨ æˆ·:&quot; + user); try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;&#125;@Dataclass User &#123; private String name;&#125; 3.æ”¹é€ ä¹‹åçš„é€»è¾‘123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960public class UserService &#123; private final ExecutorService single = Executors.newSingleThreadExecutor(); private volatile boolean isRunning = true; ArrayBlockingQueue arrayBlockingQueue = new ArrayBlockingQueue(10); &#123; init(); &#125; public void init() &#123; single.execute(() -&gt; &#123; while (isRunning) &#123; try &#123; User user = (User) arrayBlockingQueue.take();// é˜»å¡çš„æ–¹å¼è·å–é˜Ÿåˆ—ä¸­çš„æ•°æ® sendPoints(user); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;); &#125; public boolean register() &#123; User user = new User(); user.setName(&quot;Mic&quot;); addUser(user); arrayBlockingQueue.add(user);// æ·»åŠ åˆ°å¼‚æ­¥é˜Ÿåˆ— return true; &#125; public static void main(String[] args) &#123; new UserService().register(); &#125; private void addUser(User user) &#123; System.out.println(&quot; æ·»åŠ ç”¨æˆ·ï¼š&quot; + user); try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; private void sendPoints(User user) &#123; System.out.println(&quot; å‘ é€ ç§¯ åˆ† ç»™ æŒ‡ å®š ç”¨ æˆ·:&quot; + user); try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;&#125;@Dataclass User &#123; private String name;&#125; ä¼˜åŒ–ä»¥åï¼Œæ•´ä¸ªæµç¨‹å°±å˜æˆäº†è¿™æ ·æˆ‘ä»¬ä½¿ç”¨äº† ArrayBlockingQueue åŸºäºæ•°ç»„çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¥ä¼˜åŒ–ä»£ç çš„æ‰§è¡Œé€»è¾‘ã€‚ 4.é˜»å¡é˜Ÿåˆ—çš„åº”ç”¨åœºæ™¯é˜»å¡é˜Ÿåˆ—è¿™å—çš„åº”ç”¨åœºæ™¯ï¼Œæ¯”è¾ƒå¤šçš„ä»ç„¶æ˜¯å¯¹äºç”Ÿäº§è€…æ¶ˆè´¹è€…åœºæ™¯çš„åº”ç”¨ï¼Œä½†æ˜¯ç”±äºåˆ†å¸ƒå¼æ¶æ„çš„æ™®åŠï¼Œæ›´å¤šçš„å…³æ³¨åœ¨åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸Šã€‚æ‰€ä»¥å…¶å®å¦‚æœæŠŠé˜»å¡é˜Ÿåˆ—æ¯”ä½œæˆåˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—çš„è¯ï¼Œé‚£ä¹ˆæ‰€è°“çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å…¶å®å°±æ˜¯åŸºäºé˜»å¡é˜Ÿåˆ—çš„è§£è€¦ã€‚ å¦å¤–ï¼Œé˜»å¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ª fifo çš„é˜Ÿåˆ—ï¼Œæ‰€ä»¥å¯¹äºå¸Œæœ›åœ¨çº¿ç¨‹çº§åˆ«éœ€è¦å®ç°å¯¹ç›®æ ‡æœåŠ¡çš„é¡ºåºè®¿é—®çš„åœºæ™¯ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚ äºŒ,J.U.C ä¸­çš„é˜»å¡é˜Ÿåˆ—1.JUCä¸­æä¾›çš„é˜»å¡é˜Ÿåˆ—åœ¨ Java8 ä¸­ï¼Œæä¾›äº† 7 ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚ ArrayBlockingQueue æ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—, æ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ LinkedBlockingQueue é“¾è¡¨å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—, æ­¤é˜Ÿåˆ—çš„é»˜è®¤å’Œæœ€å¤§é•¿åº¦ä¸ºInteger.MAX_VALUEã€‚æ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åº PriorityBlockingQueue æ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—, é»˜è®¤æƒ…å†µä¸‹å…ƒç´ é‡‡å–è‡ªç„¶é¡ºåºå‡åºæ’åˆ—ã€‚ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç±»å®ç° compareTo()æ–¹æ³•æ¥æŒ‡å®šå…ƒç´ æ’åºè§„åˆ™ï¼Œæˆ–è€…åˆå§‹åŒ– PriorityBlockingQueue æ—¶ï¼ŒæŒ‡å®šæ„é€ å‚æ•° Comparator æ¥å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ DelayQueue ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ— SynchronousQueue ä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—, æ¯ä¸€ä¸ª put æ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ª take æ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ã€‚ LinkedTransferQueue é“¾è¡¨å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ— LinkedBlockingDeque é“¾è¡¨å®ç°çš„åŒå‘é˜»å¡é˜Ÿåˆ— 2.é˜»å¡é˜Ÿåˆ—çš„æ“ä½œæ–¹æ³•åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œæä¾›äº†å››ç§å¤„ç†æ–¹å¼ 2.1æ’å…¥æ“ä½œadd(e) ï¼šæ·»åŠ å…ƒç´ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œç»§ç»­æ’å…¥å…ƒç´ ä¼šæŠ¥é”™ï¼ŒIllegalStateExceptionã€‚ offer(e) : æ·»åŠ å…ƒç´ åˆ°é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¼šè¿”å›å…ƒç´ æ˜¯å¦æ’å…¥æˆåŠŸçš„çŠ¶æ€ï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å› trueã€‚ put(e) ï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡äº†ä»¥åï¼Œç”Ÿäº§è€…ç»§ç»­é€šè¿‡ putæ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—å¯ç”¨ã€‚ offer(e,time,unit) ï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡äº†ä»¥åç»§ç»­æ·»åŠ å…ƒç´ ï¼Œç”Ÿäº§è€…çº¿ç¨‹ä¼šè¢«é˜»å¡æŒ‡å®šæ—¶é—´ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™çº¿ç¨‹ç›´æ¥é€€å‡ºã€‚ 2.2ç§»é™¤æ“ä½œremove()ï¼šå½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨ remove ä¼šè¿”å› falseï¼Œå¦‚æœå…ƒç´ ç§»é™¤æˆåŠŸï¼Œåˆ™è¿”å› trueã€‚ poll(): å½“é˜Ÿåˆ—ä¸­å­˜åœ¨å…ƒç´ ï¼Œåˆ™ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å› nullã€‚ take()ï¼šåŸºäºé˜»å¡çš„æ–¹å¼è·å–é˜Ÿåˆ—ä¸­çš„å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ take æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰æ–°çš„æ•°æ®å¯ä»¥æ¶ˆè´¹ã€‚ poll(time,unit)ï¼šå¸¦è¶…æ—¶æœºåˆ¶çš„è·å–æ•°æ®ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¼šç­‰å¾…æŒ‡å®šçš„æ—¶é—´å†å»è·å–å…ƒç´ è¿”å›ã€‚â€‹ ä¸‰ï¼ŒArrayBlockingQueueæºç 1.æ„é€ æ–¹æ³• ArrayBlockingQueue æä¾›äº†ä¸‰ä¸ªæ„é€ æ–¹æ³•ï¼Œåˆ†åˆ«å¦‚ä¸‹ã€‚ capacityï¼š è¡¨ç¤ºæ•°ç»„çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—çš„é•¿åº¦ã€‚ fairï¼šè¡¨ç¤ºæ˜¯å¦ä¸ºå…¬å¹³çš„é˜»å¡é˜Ÿåˆ—ï¼Œé»˜è®¤æƒ…å†µä¸‹æ„é€ çš„æ˜¯éå…¬å¹³çš„é˜»å¡é˜Ÿåˆ—ã€‚ â€‹ 1234567891011121314151617181920212223242526272829303132333435public ArrayBlockingQueue(int capacity) &#123; this(capacity, false);&#125;public ArrayBlockingQueue(int capacity, boolean fair) &#123; if (capacity &lt;= 0) throw new IllegalArgumentException(); this.items = new Object[capacity]; lock = new ReentrantLock(fair);//é‡å…¥é”ï¼Œå‡ºé˜Ÿå’Œå…¥é˜ŸæŒæœ‰è¿™ä¸€æŠŠé” notEmpty = lock.newCondition();//åˆå§‹åŒ–éç©ºç­‰å¾…é˜Ÿåˆ— notFull = lock.newCondition();//åˆå§‹åŒ–éæ»¡ç­‰å¾…é˜Ÿåˆ—&#125;public ArrayBlockingQueue(int capacity, boolean fair, Collection&lt;? extends E&gt; c) &#123; this(capacity, fair); final ReentrantLock lock = this.lock; lock.lock(); // Lock only for visibility, not mutual exclusion try &#123; int i = 0; try &#123; for (E e : c) &#123; checkNotNull(e); items[i++] = e; &#125; &#125; catch (ArrayIndexOutOfBoundsException ex) &#123; throw new IllegalArgumentException(); &#125; count = i; putIndex = (i == capacity) ? 0 : i; &#125; finally &#123; lock.unlock(); &#125;&#125; items æ„é€ ä»¥åï¼Œå¤§æ¦‚æ˜¯ä¸€ä¸ªè¿™æ ·çš„æ•°ç»„ç»“æ„ï¼šâ€‹ 2.addä»¥ add æ–¹æ³•ä½œä¸ºå…¥å£ï¼Œåœ¨ add æ–¹æ³•ä¸­ä¼šè°ƒç”¨çˆ¶ç±»çš„ add æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ AbstractQueue.â€‹ 12345678910public boolean add(E e) &#123; return super.add(e);&#125;======================================================public boolean add(E e) &#123; if (offer(e)) return true; else throw new IllegalStateException(&quot;Queue full&quot;);&#125; ä»çˆ¶ç±»çš„ add æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œåšäº†ä¸€ä¸ªé˜Ÿåˆ—æ˜¯å¦æ»¡äº†çš„åˆ¤æ–­ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ç›´æ¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚â€‹ 3.offerâ€‹ 123456789101112131415161718public boolean offer(E e) &#123; //æ ¡éªŒæ”¾å…¥é˜Ÿåˆ—çš„å…ƒç´ å¦‚æœä¸ºnullï¼ŒæŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ checkNotNull(e); final ReentrantLock lock = this.lock; lock.lock(); try &#123; //å¦‚æœé˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œè¿”å›false if (count == items.length) return false; else &#123; //å¦åˆ™ï¼Œæ‰§è¡Œå…¥é˜Ÿé€»è¾‘ enqueue(e); return true; &#125; &#125; finally &#123; lock.unlock(); &#125;&#125; 4.checkNotNull1234private static void checkNotNull(Object v) &#123; if (v == null) throw new NullPointerException();&#125; 5.enqueue1234567891011121314private void enqueue(E x) &#123; //å½“å‰é˜Ÿåˆ—çš„å¼•ç”¨ final Object[] items = this.items; //å…ƒç´ å…¥é˜Ÿ items[putIndex] = x; //å¦‚æœä¸‹ä¸€ä¸ªå…ƒç´ å­˜æ”¾ä½ç½®å¤§äºé˜Ÿåˆ—é•¿åº¦ï¼ŒæŠŠé˜Ÿåˆ—é•¿åº¦ç½®ä¸º0 if (++putIndex == items.length) putIndex = 0; //å…ƒç´ ä¸ªæ•°+1 count++; //å”¤é†’å¤„äºç­‰å¾…çŠ¶æ€ä¸‹çš„çº¿ç¨‹ï¼Œè¡¨ç¤ºå½“å‰é˜Ÿåˆ—ä¸­çš„å…ƒç´ ä¸ä¸ºç©º,å¦‚æœå­˜åœ¨æ¶ˆè´¹è€…çº¿ç¨‹é˜»å¡ï¼Œå°±å¯ä»¥å¼€å§‹å–å‡ºå…ƒç´  notEmpty.signal();&#125; putIndex ä¸ºä»€ä¹ˆä¼šåœ¨ç­‰äºæ•°ç»„é•¿åº¦çš„æ—¶å€™é‡æ–°è®¾ç½®ä¸º 0ï¼Ÿâ€‹ å› ä¸º ArrayBlockingQueue æ˜¯ä¸€ä¸ª FIFO çš„é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æ·»åŠ å…ƒç´ æ—¶ï¼Œæ˜¯ä»é˜Ÿå°¾è·å– putIndex æ¥å­˜å‚¨å…ƒç´ ï¼Œå½“ putIndexç­‰äºæ•°ç»„é•¿åº¦æ—¶ï¼Œä¸‹æ¬¡å°±éœ€è¦ä»æ•°ç»„å¤´éƒ¨å¼€å§‹æ·»åŠ äº†ã€‚ ä¸‹é¢è¿™ä¸ªå›¾æ¨¡æ‹Ÿäº†æ·»åŠ åˆ°ä¸åŒé•¿åº¦çš„å…ƒç´ æ—¶ï¼ŒputIndex çš„å˜åŒ–ï¼Œå½“ putIndex ç­‰äºæ•°ç»„é•¿åº¦æ—¶ï¼Œä¸å¯èƒ½è®© putIndex ç»§ç»­ç´¯åŠ ï¼Œå¦åˆ™ä¼šè¶…å‡ºæ•°ç»„åˆå§‹åŒ–çš„å®¹é‡å¤§å°ã€‚ å½“å…ƒç´ æ»¡äº†ä»¥åæ˜¯æ— æ³•ç»§ç»­æ·»åŠ çš„ï¼Œå› ä¸ºä¼šæŠ¥é”™ã€‚ é˜Ÿåˆ—ä¸­çš„å…ƒç´ è‚¯å®šä¼šæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹é€šè¿‡ takeæˆ–è€…å…¶ä»–æ–¹æ³•æ¥è·å–æ•°æ®ï¼Œè€Œè·å–æ•°æ®çš„åŒæ—¶å…ƒç´ ä¹Ÿä¼šä»é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚ â€‹ 6.putput æ–¹æ³•å’Œ add æ–¹æ³•åŠŸèƒ½ä¸€æ ·ï¼Œå·®å¼‚æ˜¯ put æ–¹æ³•å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œä¼šé˜»å¡ã€‚ 1234567891011121314public void put(E e) throws InterruptedException &#123; checkNotNull(e); final ReentrantLock lock = this.lock; lock.lockInterruptibly(); try &#123; //å…ƒç´ ä¸ªæ•°å¦‚æœç­‰äºæ•°ç»„çš„é•¿åº¦ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ while (count == items.length) notFull.await(); //å¦åˆ™ï¼Œå…¥é˜Ÿé€»è¾‘ enqueue(e); &#125; finally &#123; lock.unlock(); &#125;&#125; 7.taketake æ–¹æ³•æ˜¯ä¸€ç§é˜»å¡è·å–é˜Ÿåˆ—ä¸­å…ƒç´ çš„æ–¹æ³•ã€‚â€‹ å®ƒçš„å®ç°åŸç†å¾ˆç®€å•ï¼Œæœ‰å°±åˆ é™¤æ²¡æœ‰å°±é˜»å¡ï¼Œæ³¨æ„è¿™ä¸ªé˜»å¡æ˜¯å¯ä»¥ä¸­æ–­çš„ï¼Œå¦‚æœé˜Ÿåˆ—æ²¡æœ‰æ•°æ®é‚£ä¹ˆå°±åŠ å…¥ notEmptyæ¡ä»¶é˜Ÿåˆ—ç­‰å¾…(æœ‰æ•°æ®å°±ç›´æ¥å–èµ°ï¼Œæ–¹æ³•ç»“æŸ)ï¼Œå¦‚æœæœ‰æ–°çš„put çº¿ç¨‹æ·»åŠ äº†æ•°æ®ï¼Œé‚£ä¹ˆ put æ“ä½œå°†ä¼šå”¤é†’ take çº¿ç¨‹ï¼Œæ‰§è¡Œ take æ“ä½œã€‚â€‹ 12345678910111213public E take() throws InterruptedException &#123; final ReentrantLock lock = this.lock; lock.lockInterruptibly(); try &#123; //é˜Ÿåˆ—å…ƒç´ ä¸ªæ•°==0 é˜»å¡ while (count == 0) notEmpty.await(); //å¦åˆ™æ‰§è¡Œå‡ºé˜Ÿé€»è¾‘ return dequeue(); &#125; finally &#123; lock.unlock(); &#125;&#125; å¦‚æœé˜Ÿåˆ—ä¸­æ·»åŠ äº†å…ƒç´ ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œä¼šåœ¨ enqueue ä¸­è°ƒç”¨ notempty.signal å”¤é†’ take çº¿ç¨‹æ¥è·å¾—å…ƒç´  8.dequeueè¿™ä¸ªæ˜¯å‡ºé˜Ÿåˆ—çš„æ–¹æ³•ï¼Œä¸»è¦æ˜¯åˆ é™¤é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ å¹¶å‘è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ 123456789101112131415161718private E dequeue() &#123; //è·å–é˜Ÿåˆ—å¼•ç”¨ final Object[] items = this.items; //æ‹¿å‡ºæ¥ä¸€ä¸ªå…ƒç´  E x = (E) items[takeIndex]; //å°†æ‹¿å‡ºçš„å…ƒç´ çš„ç´¢å¼•ä½ç½®è®¾ç½®ä¸ºnull items[takeIndex] = null; //å¦‚æœåˆ°äº†æ•°ç»„é•¿åº¦ ä»é›¶å¼€å§‹ if (++takeIndex == items.length) takeIndex = 0; //é˜Ÿåˆ—å…ƒç´ ä¸ªæ•°-1 count--; if (itrs != null) itrs.elementDequeued();//æ›´æ–°è¿­ä»£å™¨ä¸­çš„å…ƒç´ ä¸ªæ•° //è§¦å‘ å› ä¸ºé˜Ÿåˆ—æ»¡äº†ä»¥åå¯¼è‡´çš„è¢«é˜»å¡çš„çº¿ç¨‹ notFull.signal(); return x;&#125; 9.elementDequeuedâ€‹ ArrayBlockingQueue ä¸­ï¼Œå®ç°äº†è¿­ä»£å™¨çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥é€šè¿‡è¿­ä»£å™¨æ¥éå†é˜»å¡é˜Ÿåˆ—ä¸­çš„å…ƒç´ ã€‚ æ‰€ä»¥ itrs.elementDequeued() æ˜¯ç”¨æ¥æ›´æ–°è¿­ä»£å™¨ä¸­çš„å…ƒç´ æ•°æ®çš„ã€‚ takeIndex çš„ç´¢å¼•å˜åŒ–å›¾å¦‚ä¸‹ï¼ŒåŒæ—¶éšç€æ•°æ®çš„ç§»é™¤ï¼Œä¼šå”¤é†’å¤„äº put é˜»å¡çŠ¶æ€ä¸‹çš„çº¿ç¨‹æ¥ç»§ç»­æ·»åŠ æ•°æ®ã€‚ 10.removeremove æ–¹æ³•æ˜¯ç§»é™¤ä¸€ä¸ªæŒ‡å®šå…ƒç´ ã€‚çœ‹çœ‹å®ƒçš„å®ç°ä»£ç ï¼š 1234567891011121314151617181920212223242526272829303132public boolean remove(Object o) &#123; //åˆ¤ç©º if (o == null) return false; //è·å–é˜Ÿåˆ—çš„å¼•ç”¨ final Object[] items = this.items; final ReentrantLock lock = this.lock; lock.lock(); try &#123; //å¦‚æœé˜Ÿåˆ—ä¸­å…ƒç´ ä¸ªæ•°å¤§äº0 if (count &gt; 0) &#123; //è·å–ä¸Šä¸€æ¬¡æ”¾å…¥çš„å…ƒç´ çš„ç´¢å¼•ä½ç½® final int putIndex = this.putIndex; //è·å–ä¸Šä¸€æ¬¡å–å‡ºçš„å…ƒç´ çš„ç´¢å¼•çš„ä½ç½® int i = takeIndex; do &#123; //éå†æ¯ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ç§»é™¤å…ƒç´  if (o.equals(items[i])) &#123; removeAt(i); return true; &#125; //è¿™ä¸ªçš„é€»è¾‘æœ‰å•¥ç”¨ï¼Ÿ //å¯èƒ½å­˜åœ¨è¿™æ ·ä¸€ç§æƒ…å†µï¼š // 1 null 2 3 4 if (++i == items.length) i = 0; &#125; while (i != putIndex); &#125; return false; &#125; finally &#123; lock.unlock(); &#125;&#125; 11.removeAt123456789101112131415161718192021222324252627282930313233343536373839404142void removeAt(final int removeIndex) &#123; //è·å–é˜Ÿåˆ—çš„å¼•ç”¨ final Object[] items = this.items; //å¦‚æœè¦åˆ é™¤çš„èŠ‚ç‚¹æ°å¥½æ˜¯ä¸‹ä¸€ä¸ªè·å–å…ƒç´ è¦æ‹¿çš„ç´¢å¼•ä½ç½®ï¼Œç›´æ¥å¹²æ‰å°±ä¸­ if (removeIndex == takeIndex) &#123; // removing front item; just advance items[takeIndex] = null; if (++takeIndex == items.length) takeIndex = 0; count--; if (itrs != null) itrs.elementDequeued(); &#125; else &#123; //è¿™ä¸ªæ—¶å€™å°±éœ€è¦è½®è®­åˆ é™¤ final int putIndex = this.putIndex; //è‡ªæ—‹ for (int i = removeIndex;;) &#123; //åˆ é™¤ç´¢å¼•çš„ä¸‹ä¸€ä¸ªç´¢å¼• int next = i + 1; //å¦‚æœåˆ°å¤´äº† ï¼Œæ„æ€å°±æ˜¯ ï¼Œ é‚£å°±å¾— ä»å¤´å†æ¥ if (next == items.length) next = 0; // æ–­æµäº† å¾—è·³è¿‡å» if (next != putIndex) &#123; items[i] = items[next]; i = next; &#125; else &#123; //æ‰¾åˆ°äº† åˆ é™¤ é€€å‡º items[i] = null; this.putIndex = i; break; &#125; &#125; //å…ƒç´ ä¸ªæ•°-- count--; //å¤„ç†è¿­ä»£å™¨çš„é€»è¾‘ if (itrs != null) itrs.removedAt(removeIndex); &#125; //å°†å¾€é˜Ÿåˆ—æ”¾å…ƒç´ ï¼Œä½†æ˜¯å› ä¸ºé˜Ÿåˆ—æ»¡äº†é˜»å¡çš„çº¿ç¨‹å”¤é†’ä¸€ä¸ªï¼Œå½“ç„¶äº†ï¼Œä¹Ÿå¯èƒ½é˜Ÿåˆ—æ²¡æœ‰çº¿ç¨‹ notFull.signal();&#125;","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"ThreadPoolExecutor","slug":"JUC/ThreadPoolExecutor","date":"2022-01-11T11:07:47.466Z","updated":"2022-01-11T11:31:41.419Z","comments":true,"path":"2022/01/11/JUC/ThreadPoolExecutor/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/ThreadPoolExecutor/","excerpt":"","text":"ä¸€ï¼Œçº¿ç¨‹æ± çš„åŸºæœ¬ä½¿ç”¨1.çº¿ç¨‹æ± çš„ä»‹ç»çº¿ç¨‹å¤ç”¨ï¼Œæ§åˆ¶æœ€å¤§å¹¶å‘æ•°ï¼Œç®¡ç†çº¿ç¨‹ã€‚â€‹ ä¼˜ç‚¹ï¼šæé«˜å“åº”é€Ÿåº¦ï¼Œé¿å…æ¯æ¬¡éƒ½å»åˆ›å»ºçº¿ç¨‹ã€‚ä¾¿äºç®¡ç†ï¼Œé™ä½èµ„æºæ¶ˆè€—ã€‚â€‹ 2.å¸¸ç”¨çš„çº¿ç¨‹æ±  Executors.newFixedThreadPool();æ‰§è¡Œé•¿æœŸä»»åŠ¡æ€§èƒ½å¥½ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¸€æ± æœ‰Nä¸ªå›ºå®šçš„çº¿ç¨‹ï¼Œæœ‰å›ºå®šçš„çº¿ç¨‹æ•°çš„çº¿ç¨‹ Executors.newSingleThreadExecutor();ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œï¼Œä¸€æ± ä¸€çº¿ç¨‹ Executors.newCachedThreadPool();æ‰§è¡Œå¾ˆå¤šçŸ­æœŸå¼‚æ­¥ä»»åŠ¡ï¼Œçº¿ç¨‹æ± æ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹ï¼Œä½†åœ¨å…ˆå‰æ„å»ºçš„çº¿ç¨‹å¯ç”¨æ—¶å°†é‡ç”¨å®ƒä»¬ã€‚å¯æ‰©å®¹ï¼Œé‡å¼ºåˆ™å¼ºã€‚ â€‹ çº¿ç¨‹æ± çš„æ ¸å¿ƒå…¶å®éƒ½æ˜¯åŒä¸€ä¸ªç±»ThreadPoolExecutorã€‚â€‹ æ³¨æ„â€‹ çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨Executorså»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ThreadPoolExecutorçš„æ–¹å¼ï¼Œè§„é¿èµ„æºæ¶ˆè€—ã€‚ è¯´æ˜ï¼šExecutorsè¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š FixedThreadPoolå’ŒSingleThreadPoolï¼›å…è®¸çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸ºIntegerçš„æœ€å¤§å€¼ï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´OOMã€‚ CachedThreadPoolå’ŒScheduledThreadPoolå…è®¸çš„åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸ºIntegeræœ€å¤§å€¼ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´OOMã€‚ 123456789101112131415161718public static void main(String[] args) &#123; ExecutorService pool1 = Executors.newFixedThreadPool(5);//ä¸€ä¸ªé“¶è¡Œç½‘ç‚¹5ä¸ªå—ç†ä¸šåŠ¡çª—å£ ExecutorService pool2 = Executors.newSingleThreadExecutor();//ä¸€ä¸ªé“¶è¡Œç½‘ç‚¹1ä¸ªå—ç†ä¸šåŠ¡çª—å£ ExecutorService pool3 = Executors.newCachedThreadPool();//ä¸€ä¸ªé“¶è¡Œç½‘ç‚¹nä¸ªå—ç†ä¸šåŠ¡çª—å£ //3ä¸ªé¡¾å®¢ try &#123; for (int i = 0; i &lt; 30; i++) &#123; pool3.execute(()-&gt;&#123; System.out.println(Thread.currentThread().getName()+&quot;\\tçº¿ç¨‹åŠç†ä¸šåŠ¡ï¼&quot;); &#125;); //pool1.submit(()-&gt;&#123;&#125;); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; pool3.shutdown(); &#125;&#125; 3.çº¿ç¨‹æ± çš„7å¤§å‚æ•° int corePoolSize, çº¿ç¨‹æ± ä¸­çš„å¸¸é©»æ ¸å¿ƒçº¿ç¨‹æ•° â€‹ int maximumPoolSize, èƒ½å¤Ÿå®¹çº³åŒæ—¶æ‰§è¡Œçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œå¿…é¡»å¤§äº1 â€‹ long keepAliveTime, å¤šä½™ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ â€‹ TimeUnit unit, ä¸Šä¸ªå‚æ•°çš„å•ä½ â€‹ BlockingQueue workQueue, ä»»åŠ¡é˜Ÿåˆ—ï¼Œè¢«æäº¤ä½†æ˜¯å°šæœªæ‰§è¡Œçš„ä»»åŠ¡ â€‹ ThreadFactory threadFactory, è¡¨ç¤ºç”Ÿæˆçº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤ â€‹ RejectedExecutionHandler handlerï¼Œæ‹’ç»ç­–ç•¥ï¼Œè¡¨ç¤ºå½“é˜Ÿåˆ—æ»¡äº†ï¼Œå¹¶ä¸”å·¥ä½œçº¿ç¨‹å¤§äºç­‰äºçº¿ç¨‹æ± çš„æœ€å¤§è¿æ¥æ•°æ—¶ï¼Œå¦‚ä½•æ¥æ‹’ç»è¯·æ±‚æ‰§è¡Œçš„runnableçš„ç­–ç•¥ã€‚3.1 ç”Ÿäº§ä¸­çº¿ç¨‹æ± å‚æ•°å¦‚ä½•è®¾ç½®â€‹ ä¸ºä»€ä¹ˆIO å¯†é›†å‹çš„è®¾ç½®ä¸º 2n, è®¡ç®—å¯†é›†å‹è®¾ç½®ä¸º n+1ä¸å¯¹ï¼Ÿ å› ä¸ºæ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®å¤šå°‘è¦å…·ä½“æƒ…å†µå…·ä½“åˆ†æ,ä½¿ç”¨çº¿ç¨‹æ± çš„ä¸šåŠ¡åœºæ™¯ä¸åŒ,è§£å†³æ–¹æ¡ˆè‡ªç„¶æ˜¯ä¸ä¸€æ ·çš„ã€‚â€‹ åœºæ™¯å‡è®¾â€‹ å‡è®¾ç°åœ¨è¦ç»™ 100w ç”¨æˆ·å‘æ”¾ä¼˜æƒ åˆ¸,é€šè¿‡çº¿ç¨‹æ± å¼‚æ­¥å‘é€ â€‹ å‡è®¾æŸçº¿ç¨‹æ± æ‰§è¡Œå‘ä¼˜æƒ åˆ¸çš„ä»»åŠ¡å…±è€—æ—¶ 50ms,å…¶ä¸­ 45ms åœ¨io, 5ms åœ¨è¿›è¡Œè®¡ç®—(çœŸæ­£çš„ io è€—æ—¶ è®¡ç®—è€—æ—¶å¯ä»¥é€šè¿‡ è®°å½•log åˆ¤æ–­æ—¶é—´å·®å€¼è®¡ç®—å‡ºæ¥ å–å¹³å‡å€¼å³å¯ ) â€‹ å¦‚ä½•è®¾ç½®çº¿ç¨‹æ± çš„å‚æ•°å¿«é€Ÿçš„å°†è¿™ 100w å¼ åˆ¸å‘å®Œï¼Ÿ â€‹ æ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸æ•° * ((Ioè€—æ—¶ / è®¡ç®—è€—æ—¶) + 1) æ ¸å¿ƒçº¿ç¨‹æ•° = 8C * ((45ms / 5ms) +1 ) = 80ä¸ª 45ms / 5ms æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿâ€‹ CPU åœ¨ç­‰å¾… IO è¿”å›æ—¶å®Œå…¨å¯ä»¥å°† CPU æ—¶é—´ç‰‡æ‹¿å‡ºæ¥å»åšå…¶ä»–çš„è®¡ç®—,45ms å¯ä»¥å¤šå¤„ç† 9 ä¸ªè®¡ç®—ä»»åŠ¡,å†åŠ ä¸ŠåŸæœ¬å°±æœ‰ä¸€ä¸ª 5ms åœ¨è®¡ç®—,ä¹Ÿå°±æ˜¯è¯´: ä¸€ä¸ªCPU æ ¸åœ¨æ‰§è¡Œè¿™ä¸ª 50ms å‘åˆ¸ä»»åŠ¡æ—¶,å¯ä»¥å¹¶å‘çš„èµ·10ä¸ªçº¿ç¨‹å»å¤„ç†ä»»åŠ¡ï¼é‚£8C CPU æœ€å¤šåŒæ—¶å¯ä»¥æœ‰ 8ä¸ªæ ¸å¿ƒå¹¶è¡Œçš„å¤„ç†ä»»åŠ¡, 8 _ 10 = 80ï¼Œä¸€ç§’é’Ÿä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç† 1000ms / 50ms = 20ä¸ªä»»åŠ¡å¯ä»¥ç®—å‡ºçº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡çš„å³°å€¼ qps = 20 _ 80 = 1600ï¼Œå‘å®Œ100w å¼ åˆ¸æ‰€éœ€æ—¶é—´: 100w / 1600 = 625S,ä¹Ÿå°±æ˜¯è¯´å¤§æ¦‚ 10åˆ†é’Ÿå·¦å³å°±èƒ½å‘å®Œ 100w å¼ åˆ¸ã€‚â€‹ ä¸å¤ªæ­£ç¡®çš„ç»“è®º: æ ¸å¿ƒçº¿ç¨‹æ•°åœ¨å¤„ç†è¿™ä¸ªä»»åŠ¡çš„æƒ…å†µä¸‹å¯ä»¥è®¾ç½®ä¸º 80 ç”¨æ¥æé™çš„å‹æ¦¨æœºå™¨CPU çš„æ€§èƒ½ã€‚â€‹ æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º 80,è¿™å‡ ä¹åƒå®Œäº†æ‰€æœ‰çš„ CPU æ—¶é—´ç‰‡, CPU çš„è´Ÿè½½å°†ä¼šè¾¾åˆ° 100% ; è¯•æƒ³ä¸€ä¸‹ç”Ÿäº§ç¯å¢ƒå¦‚æœä½ çš„æœºå™¨ CPU è´Ÿè½½æ˜¯ 100% , æ…Œä¸æ…Œï¼Ÿ(CPU è´Ÿè½½æ‰“æ»¡æœºå™¨ä¸ä¼šå®•æœº, ä½†æ²¡æœ‰ CPU èµ„æºæ¥å¤„ç†ç”¨æˆ·çš„è¯·æ±‚,è¡¨ç°ä¸ºæœåŠ¡å‡æ­»/æœºå™¨è¯·æ±‚åŠå¤©æ— ååº”)â€‹ è®¾ç½®çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°è¦è€ƒè™‘ CPU çš„ä½¿ç”¨è¦ç´ â€‹ æ¯å°æœºå™¨æ“ä½œç³»ç»Ÿéœ€è¦æ¶ˆè€—ä¸€äº› CPU èµ„æº; å‡è®¾ç”¨äº† 2% çš„CPU èµ„æº; â€‹ å¦‚æœæ˜¯é¢å‘ç”¨æˆ·çš„æœåŠ¡,å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ä¹Ÿæ˜¯è¦æ¶ˆè€—CPU èµ„æºçš„,å¯ä»¥é€šè¿‡ä¸€äº›ç›‘æ§ç³»ç»Ÿ,çœ‹çœ‹å¹³æ—¶ CPU åœ¨ç¹å¿™æ—¶é—´æ®µçš„è´Ÿè½½æ˜¯å¤šå°‘; å‡è®¾ç”¨äº† 10% çš„èµ„æº; â€‹ å¦‚æœé™¤äº†å‘åˆ¸ä»»åŠ¡çš„çº¿ç¨‹æ± è¿˜æœ‰å…¶ä»–çº¿ç¨‹æ± åœ¨è¿è¡Œ,å°±å¾—æŠŠå…¶ä»–çº¿ç¨‹æ± æ¶ˆè€—çš„CPUèµ„æºä¹Ÿç®—ä¸Š,å‡è®¾ç”¨äº† 13% çš„èµ„æº; â€‹ å®é™…æƒ…å†µä¸€äº›ä¸­é—´ä»¶æ¡†æ¶ä¹Ÿä¼šç”¨çº¿ç¨‹æ± ,ä¹Ÿä¼šåƒä¸€äº›CPU èµ„æºã€‚ â€‹ ä¸ºä»€ä¹ˆç”¨çº¿ç¨‹æ± æ²¡è€ƒè™‘ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Ÿâ€‹ 1ms = 1000us, ä¸€æ¬¡ä¸Šä¸‹æ–‡çš„åˆ‡æ¢å¤§æ¦‚æ˜¯ 1us, ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´è·Ÿæ‰§è¡Œä»»åŠ¡çš„æ—¶é—´æ¯”èµ·æ¥å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚â€‹ ç»“è®º : CPUæ ¸æ•° * ((Ioè€—æ—¶ / è®¡ç®—è€—æ—¶) + 1)â€‹ è¿™æ˜¯æœºå™¨ CPU è´Ÿè½½ 100% æ—¶æé™çš„å€¼, ä¹˜ä»¥æœŸæœ›çš„ CPU è´Ÿè½½ç™¾åˆ†æ¯”å³å¯ç®—å‡ºå®é™…æƒ…å†µæœ€ä½³çš„çº¿ç¨‹æ•°ã€‚â€‹ 3.2 8C16G çš„æœºå™¨éœ€è¦å‡ å°å¯ä»¥æŠ—èµ· 3W çš„qpsï¼Ÿå‡è®¾ä¸€ä¸ª ç”¨æˆ·é¢†åˆ¸ç³»ç»Ÿçš„ qps åœ¨3wå·¦å³å¤§éƒ¨åˆ†æœåŠ¡é€šå¸¸çš„éƒ¨ç½²åœ¨ Tomcat ä¸Š, Tomcat å†…éƒ¨ä¹Ÿæ˜¯é€šè¿‡çº¿ç¨‹æ¥å¤„ç†ç”¨æˆ·çš„è¯·æ±‚,Tomcat ä¹Ÿæ˜¯é€šè¿‡çº¿ç¨‹æ± æ¥ç®¡ç†çº¿ç¨‹, å®é™…ä¸Šç®—å‡º Tomcat å®é™…çš„å¹¶å‘å’Œç†æƒ³çŠ¶æ€èƒ½æ”¯æŒçš„çš„å¹¶å‘å°±å¥½äº†ã€‚â€‹ ä¸Šä¸ªé—®é¢˜åˆ†æå‡ºæ¥å‘åˆ¸æ¥å£ 50ms è€—æ—¶, 8C çš„CPU å ç”¨ 100%, ä¸è€ƒè™‘å†…å­˜ ç£ç›˜ ç½‘ç»œç­‰å…¶ä»–å¼€é”€, çº¿ç¨‹æ± æé™çš„QPS æ˜¯1600, è¿™é‡Œä¹Ÿä¸è€ƒè™‘æœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ± æˆ–è€…ä¸ƒä¸ƒå…«å…«çš„ä¸œè¥¿æ¶ˆè€— CPU èµ„æºäº†ã€‚å‡è®¾ CPU åªèƒ½ç»´æŒåœ¨ 70% å·¦å³çš„è´Ÿè½½ï¼›å•å°æœºå™¨çš„ qps å°±åªèƒ½æœ‰ 1600 * 70% = 1120,å°±ç®— 1100ï¼Œ3w / 1100 = 27.27 å‘ä¸Šå–æ•´ å¤§æ¦‚éœ€è¦ 28 å°æœºå™¨ã€‚ä½œä¸ºä¸€ä¸ªæœ‰ç»éªŒçš„å¼€å‘äººå‘˜å®é™…éƒ¨ç½²çš„æ—¶å€™ç»å¯¹è¦å¤šæ‰©å®¹å‡ å°æœåŠ¡å™¨æ¥å…œåº•, æ¨èéƒ¨ç½² 32 - 36 å°æœºå™¨åˆ†ä¸¤ä¸ªé›†ç¾¤éƒ¨ç½²ã€‚â€‹ 3.3 çº¿ç¨‹æ± å¯ä»¥å…ˆå¯åŠ¨æœ€å¤§çº¿ç¨‹æ•°å†å°†ä»»åŠ¡æ”¾åˆ°é˜»å¡é˜Ÿåˆ—é‡Œä¹ˆï¼Ÿâ€‹ å¯åŠ¨æœ€å¤§çº¿ç¨‹æ•°å†å°†ä»»åŠ¡æ”¾åˆ°é˜»å¡é˜Ÿåˆ—çš„è¯€çªå°±åœ¨ workQueue çš„ offer æ–¹æ³•;æˆ‘ä»¬å¯ä»¥ç”¨è‡ªå·±å®ç°çš„é˜»å¡é˜Ÿåˆ—åœ¨é‡å†™ offer æ–¹æ³•; åœ¨ offer æ–¹æ³•ä¸­åˆ¤æ–­ å½“å‰çº¿ç¨‹æ•°æ˜¯å¦å¤§äºç­‰äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œå¦‚æœä¸å¤§äºå°±è¿”å› false, è¿™æ ·å°±è·³è¿‡äº† execute æ–¹æ³•çš„ç¬¬äºŒæ­¥, æ¥åˆ°äº†ç¬¬ä¸‰æ­¥çš„åˆ›å»ºæœ€å¤§çº¿ç¨‹æ•°çš„é€»è¾‘ã€‚dubboå°±æ˜¯è¿™ä¹ˆå¹²çš„ã€‚â€‹ 4.çº¿ç¨‹æ± çš„å·¥ä½œåŸç† åœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸ºé›¶ã€‚ â€‹ å½“è°ƒç”¨execute ()æ–¹æ³•æ·»åŠ ä¸€ä¸ªè¯·æ±‚ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåšå‡ºå¦‚ä¸‹åˆ¤æ–­: â€‹ å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å°äºcorePoolSize,é‚£ä¹ˆé©¬ä¸Šåˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡; å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºcorePoolSize,é‚£ä¹ˆå°†è¿™ä¸ªä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—; å¦‚æœè¿™ä¸ªæ—¶å€™é˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¿˜å°äºmaximumPoolSizeï¼Œé‚£ä¹ˆè¿˜æ˜¯è¦åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ç«‹åˆ»è¿è¡Œè¿™ä¸ªä»»åŠ¡; å¦‚æœé˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºmax imumPoolSize,é‚£ä¹ˆçº¿ç¨‹æ± ä¼šå¯åŠ¨é¥±å’Œæ‹’ç»ç­–ç•¥æ¥æ‰§è¡Œã€‚ â€‹ å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡æ—¶ï¼Œå®ƒä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚ â€‹ å½“ä¸€ä¸ªçº¿ç¨‹æ— äº‹å¯åšè¶…è¿‡ä¸€å®šçš„æ—¶é—´(keepAliveTime) æ—¶ï¼Œçº¿ç¨‹ä¼šåˆ¤æ–­: â€‹ å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äºcorePoolSize.é‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±è¢«åœæ‰ã€‚æ‰€ä»¥çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œå®ƒæœ€ç»ˆä¼šæ”¶ç¼©åˆ°corePoolSizeçš„å¤§å°ã€‚ â€‹ 4.1 çº¿ç¨‹æ± çš„çŠ¶æ€ 4.2 çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥ AbortPolicy æŠ›å‡ºå¼‚å¸¸ CallerRunsPolicy è°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ DiscardOldestPolicy ä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡ï¼Œå†æ¬¡å°è¯•æäº¤ DiscardPolicy ç›´æ¥ä¸¢å¼ƒ â€‹ 5. è‡ªå®šä¹‰çº¿ç¨‹æ± 1234567891011121314151617181920212223242526public static void main(String[] args) &#123; ExecutorService pool = new ThreadPoolExecutor( 2, 5, 3l, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(3), Executors.defaultThreadFactory(), //new ThreadPoolExecutor.AbortPolicy() //æŠ›å¼‚å¸¸ //new ThreadPoolExecutor.CallerRunsPolicy() //main çº¿ç¨‹åŠç†ä¸šåŠ¡ï¼ //new ThreadPoolExecutor.DiscardOldestPolicy() //å°±å¤„ç†èƒ½å¤„ç†çš„ï¼Œå‰©ä¸‹çš„è€çš„ç›´æ¥ä¸¢äº†ã€‚ new ThreadPoolExecutor.DiscardPolicy() //å¦‚æœæ–°æ¥çš„å¤„ç†ä¸äº†ï¼Œç›´æ¥å°±æ‰”äº†ã€‚ ); try &#123; for (int i = 0; i &lt; 30; i++) &#123; pool.execute(() -&gt; &#123; System.out.println(Thread.currentThread().getName() + &quot;\\tçº¿ç¨‹åŠç†ä¸šåŠ¡ï¼&quot;); &#125;); //pool1.submit(()-&gt;&#123;&#125;); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; pool.shutdown(); &#125;&#125; äºŒï¼Œçº¿ç¨‹æ± æºç  1. æˆå‘˜å±æ€§/é™æ€å±æ€§/æ„é€ æ–¹æ³•123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108//é«˜ä¸‰ä½ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ é™¤å»é«˜ä¸‰ä½ä¹‹åçš„ä½ä½ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± ä¸­æ‰€æ‹¥æœ‰çš„çš„çº¿ç¨‹æ•°é‡ private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));//è¡¨ç¤ºåœ¨ctlä¸­ï¼Œä½COUNT_BITSä½é€‚ç”¨äºå­˜æ”¾å½“å‰çº¿ç¨‹æ•°é‡çš„ä½ã€‚ private static final int COUNT_BITS = Integer.SIZE - 3;//çº¿ç¨‹æ± æ‰€èƒ½å­˜æ”¾çš„æœ€å¤§å®¹é‡ private static final int CAPACITY = (1 &lt;&lt; COUNT_BITS) - 1; //-1å·¦ç§»29ä½ è´Ÿæ•° 111 private static final int RUNNING = -1 &lt;&lt; COUNT_BITS;// 0 000 private static final int SHUTDOWN = 0 &lt;&lt; COUNT_BITS;//001 private static final int STOP = 1 &lt;&lt; COUNT_BITS;//010 private static final int TIDYING = 2 &lt;&lt; COUNT_BITS;//011 private static final int TERMINATED = 3 &lt;&lt; COUNT_BITS; // è·å–å½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ private static int runStateOf(int c) &#123; return c &amp; ~COUNT_MASK; &#125;//è·å–å½“å‰çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡ private static int workerCountOf(int c) &#123; return c &amp; COUNT_MASK; &#125;//ç”¨åœ¨é‡ç½®å½“å‰çº¿ç¨‹ctlå€¼æ—¶ï¼Œä¼šç”¨åˆ° rsè¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ wcè¡¨ç¤ºçº¿ç¨‹æ± workeræ•°é‡ private static int ctlOf(int rs, int wc) &#123; return rs | wc; &#125;//casçš„æ–¹å¼è®©ctlå€¼+1 private boolean compareAndIncrementWorkerCount(int expect) &#123; return ctl.compareAndSet(expect, expect + 1); &#125;//casçš„æ–¹å¼è®©ctl-1 private boolean compareAndDecrementWorkerCount(int expect) &#123; return ctl.compareAndSet(expect, expect - 1); &#125;//å°†ctlå€¼-1 private void decrementWorkerCount() &#123; ctl.addAndGet(-1); &#125;//å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œåœ¨æäº¤ä»»åŠ¡ï¼Œå°±ä¼šæäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ— private final BlockingQueue&lt;Runnable&gt; workQueue; //çº¿ç¨‹æ± ä¸­çš„å…¨å±€é”ï¼Œå¢åŠ workerï¼Œå‡å°‘workerï¼Œä¿®æ”¹çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ private final ReentrantLock mainLock = new ReentrantLock(); //çœŸæ­£å­˜æ”¾worker-&gt;threadçš„åœ°æ–¹ private final HashSet&lt;Worker&gt; workers = new HashSet&lt;&gt;(); /* çº¿ç¨‹æ± ä¸­æä¾›äº†ä¸€ä¸ªå¯¹å¤–æ–¹æ³•ï¼ŒawaitTermination(long time,TimeUnit),è¯¥æ–¹æ³•è°ƒç”¨ä¼šè¢«é˜»å¡ï¼Œ å¹¶ä¸”åœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µä»»æ„ä¸€ç§å‘ç”Ÿæ—¶éƒ½ä¼šå¯¼è‡´è¯¥æ–¹æ³•çš„æ‰§è¡Œ: å³shutdownæ–¹æ³•è¢«è°ƒç”¨ä¹‹åï¼Œ æˆ–è€…å‚æ•°ä¸­å®šä¹‰çš„timeoutæ—¶é—´åˆ°è¾¾æˆ–è€…å½“å‰çº¿ç¨‹è¢«æ‰“æ–­ï¼Œè¿™å‡ ç§æƒ…å†µä»»æ„ä¸€ä¸ªå‘ç”Ÿäº†éƒ½ä¼šå¯¼è‡´è¯¥æ–¹æ³•åœ¨æ‰€æœ‰ä»»åŠ¡å®Œæˆä¹‹åæ‰æ‰§è¡Œã€‚ ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯longç±»å‹çš„è¶…æ—¶æ—¶é—´ï¼Œç¬¬äºŒä¸ªå‚æ•°å¯ä»¥ä¸ºè¯¥æ—¶é—´æŒ‡å®šå•ä½ã€‚*/ private final Condition termination = mainLock.newCondition(); //è®°å½•çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸå†…ï¼Œçº¿ç¨‹æœ€å¤§å€¼ private int largestPoolSize; //è®°å½•çº¿ç¨‹æ± æ‰€å®Œæˆçš„ä»»åŠ¡æ€»æ•°ï¼Œå½“workeré€€å‡ºæ—¶ï¼Œä¼šå°†workerå®Œæˆçš„ä»»åŠ¡ç´¯ç§¯åˆ°è¿™é‡Œ private long completedTaskCount; //åˆ›å»ºçº¿ç¨‹æ± ä¼šä½¿ç”¨åˆ°çº¿ç¨‹å·¥å‚ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨Executor.newFix ... /newCache ... ä½¿ç”¨çš„DefaultThreadFactoryï¼Œ//ç”Ÿæˆçš„çº¿ç¨‹åä¸å®¹æ˜“åˆ†ææ‰§è¡Œçš„æ˜¯å“ªé‡Œçš„ä¸šåŠ¡//ä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨ä½¿ç”¨è‡ªå¸¦çš„ï¼Œæ¨èè‡ªå·±å®ç°è¿™ä¸ªæ¥å£ private volatile ThreadFactory threadFactory; //æ‹’ç»ç­–ç•¥ï¼Œé»˜è®¤æ˜¯é‡‡ç”¨æŠ›å‡ºå¼‚å¸¸ private volatile RejectedExecutionHandler handler; //ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ ï¼šallowCoreThreadTimeOut=falseæ—¶ï¼Œä¼šç»´æŠ¤æ ¸å¿ƒçº¿ç¨‹æ•°é‡å†…çš„çº¿ç¨‹å­˜æ´»ï¼Œè¶…å‡ºéƒ¨åˆ†ä¼šè¶…æ—¶ã€‚//allowCoreThreadTimeOut=trueæ—¶ï¼Œæ ¸å¿ƒæ•°é‡å†…çš„çº¿ç¨‹ä¹Ÿä¼šè¢«å›æ”¶ã€‚ private volatile long keepAliveTime; //æ§åˆ¶æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦å¯ä»¥è¢«å›æ”¶ï¼Œtrueå¯ä»¥ï¼Œfalseä¸å¯ä»¥ã€‚ private volatile boolean allowCoreThreadTimeOut; //æ ¸å¿ƒçº¿ç¨‹æ•°é™åˆ¶ private volatile int corePoolSize; //æœ€å¤§çº¿ç¨‹æ•°é™åˆ¶ private volatile int maximumPoolSize; //é»˜è®¤çš„æ‹’ç»ç­–ç•¥ï¼ŒæŠ›å¼‚å¸¸çš„æ–¹å¼ private static final RejectedExecutionHandler defaultHandler = new AbortPolicy(); public ThreadPoolExecutor(int corePoolSize, //æ ¸å¿ƒçº¿ç¨‹æ•° int maximumPoolSize, //æœ€å¤§çº¿ç¨‹æ•° long keepAliveTime, //ç©ºé—²ç­‰å¾…æ—¶é—´ TimeUnit unit, //æ—¶é—´å•ä½ BlockingQueue&lt;Runnable&gt; workQueue, //ä»»åŠ¡é˜Ÿåˆ— ThreadFactory threadFactory, //çº¿ç¨‹å·¥å‚ RejectedExecutionHandler handler //æ‹’ç»ç­–ç•¥ ) &#123; if (corePoolSize &lt; 0 || maximumPoolSize &lt;= 0 || maximumPoolSize &lt; corePoolSize || keepAliveTime &lt; 0) throw new IllegalArgumentException(); if (workQueue == null || threadFactory == null || handler == null) throw new NullPointerException(); this.corePoolSize = corePoolSize; this.maximumPoolSize = maximumPoolSize; this.workQueue = workQueue; this.keepAliveTime = unit.toNanos(keepAliveTime); this.threadFactory = threadFactory; this.handler = handler; &#125; 2.å†…éƒ¨ç±»workerçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å®é™…ä¸Šéƒ½å°è£…æˆäº†ä¸€ä¸ªä¸ªworkeræ¥æ‰§è¡Œã€‚â€‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667 private final class Worker extends AbstractQueuedSynchronizer implements Runnable &#123; private static final long serialVersionUID = 6138294804551838833L; //workerå†…éƒ¨å°è£…çš„å·¥ä½œçº¿ç¨‹ @SuppressWarnings(&quot;serial&quot;) final Thread thread; //å‡è®¾firstTaskä¸ä¸ºç©ºï¼Œå½“workerå¯åŠ¨åï¼ˆworkerå†…éƒ¨çš„çº¿ç¨‹å¯åŠ¨åï¼‰ä¼šä¼˜å…ˆæ‰§è¡ŒfirstTaskï¼Œ//å½“æ‰§è¡Œå®ŒfirstTaskåï¼Œä¼šå»queueä¸­å»è·å–ä¸‹ä¸€ä¸ªä»»åŠ¡ @SuppressWarnings(&quot;serial&quot;) Runnable firstTask; //è®°å½•å½“å‰workeræ‰€å®Œæˆçš„ä»»åŠ¡æ•°é‡ volatile long completedTasks; //firstTaskå¯ä»¥ä¸ºç©ºï¼Œå¯åŠ¨åä¼šåˆ°queueä¸­è·å– Worker(Runnable firstTask) &#123; setState(-1); // è®¾ç½®aqsç‹¬å æ¨¡å¼ä¸º åˆå§‹åŒ–ä¸­çŠ¶æ€ï¼Œä¸èƒ½è¢«æŠ¢å é” this.firstTask = firstTask; this.thread = getThreadFactory().newThread(this); //ä½¿ç”¨çº¿ç¨‹å·¥å‚åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å½“å‰workeræŒ‡å®šä¸º //runnableï¼Œå¹¶ä¸”è¯´å½“å‰threadå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šä»¥worker.run()ä¸ºå…¥å£ã€‚ &#125; /** */ public void run() &#123; //è°ƒç”¨äº†threadPoolExecutorçš„æ–¹æ³• runWorker(this); &#125; //å½“å‰workerçš„ç‹¬å é”æ˜¯å¦è¢«ç‹¬å  protected boolean isHeldExclusively() &#123; return getState() != 0; &#125;//å°è¯•å»å ç”¨workerçš„ç‹¬å é” protected boolean tryAcquire(int unused) &#123; if (compareAndSetState(0, 1)) &#123; setExclusiveOwnerThread(Thread.currentThread()); return true; &#125; return false; &#125;//å°è¯•å»é‡Šæ”¾workerçš„ç‹¬å é” protected boolean tryRelease(int unused) &#123; setExclusiveOwnerThread(null); setState(0); return true; &#125; public void lock() &#123; acquire(1); &#125; public boolean tryLock() &#123; return tryAcquire(1); &#125; public void unlock() &#123; release(1); &#125; public boolean isLocked() &#123; return isHeldExclusively(); &#125; void interruptIfStarted() &#123; Thread t; if (getState() &gt;= 0 &amp;&amp; (t = thread) != null &amp;&amp; !t.isInterrupted()) &#123; try &#123; t.interrupt(); &#125; catch (SecurityException ignore) &#123; &#125; &#125; &#125; &#125; 3.executeå½“è°ƒç”¨execute()æ¥æäº¤ä¸€ä¸ªä»»åŠ¡çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šåˆ¤æ–­å¦‚æœå½“å‰çº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ­¤æ¬¡æäº¤ä»»åŠ¡ä¼šåˆ›å»ºä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœæäº¤å¤±è´¥ï¼Œä¼šç»§ç»­åˆ¤æ–­ï¼šå¦‚æœå½“å‰çº¿ç¨‹æ± å¤„äºRUNNINGçŠ¶æ€ï¼Œå°è¯•å°†taskæ”¾å…¥åˆ°workQueueä¸­ã€‚å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œä¼šç»§ç»­åˆ¤æ–­ï¼šè¾¾åˆ°äº†æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445public void execute(Runnable command) &#123; //å¦‚æœä»»åŠ¡ä¸ºç©ºï¼ŒæŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ if (command == null) throw new NullPointerException(); //è·å–ctlçš„æœ€æ–°å€¼ï¼Œé«˜ä¸‰ä½è¡¨ç¤ºæ­¤çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œä½ä½è¡¨ç¤ºå½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ int c = ctl.get(); //å¦‚æœå½“å‰çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ­¤ä»»åŠ¡ä¼šäº¤ç»™ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œ if (workerCountOf(c) &lt; corePoolSize) &#123; //åˆ›å»ºworkeræˆåŠŸä»¥åï¼Œä¼šæŠŠè¿™ä¸ªä»»åŠ¡äº¤ç»™workerçš„firstTaskï¼Œç”±workeråŒ…è£…çš„æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œ if (addWorker(command, true)) return; //è·å–ctlçš„æœ€æ–°å€¼ï¼Œé«˜ä¸‰ä½è¡¨ç¤ºæ­¤çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œä½ä½è¡¨ç¤ºå½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ c = ctl.get(); //æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜addworkerå¤±è´¥ /** * 1.å­˜åœ¨å¹¶å‘ * 2.çº¿ç¨‹æ± çš„çŠ¶æ€érunningï¼ŒshutdownçŠ¶æ€ä¸‹ä¹Ÿä¼šåˆ›å»ºæˆåŠŸï¼Œå‰ææ˜¯firsttask==null,é˜Ÿåˆ—ï¼=null */ &#125; /** * æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ï¼Œæ­¤æ—¶çº¿ç¨‹æ± å·²ç»è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•° addworkerå¤±è´¥ */ //å¦‚æœçº¿ç¨‹æ± æ²¡æœ‰è¢«shutdownï¼Œä¹Ÿå°±æ˜¯æ­£å¸¸è¿è¡Œï¼Œè¯´æ˜æ­¤æ—¶å­˜åœ¨å¹¶å‘ï¼Œé‚£å°±æŠŠè¿™ä¸ªä»»åŠ¡æ”¾åˆ°é˜Ÿåˆ— if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; //æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ä»»åŠ¡æäº¤åˆ°é˜Ÿåˆ—æˆåŠŸ //å†æ¬¡è·å–ctl çº¿ç¨‹æ± çš„çŠ¶æ€ å’Œ å·¥ä½œçº¿ç¨‹æ•° int recheck = ctl.get(); //å¦‚æœæ­¤æ—¶çš„çº¿ç¨‹æ± çŠ¶æ€ä¸åœ¨æ˜¯running éœ€è¦åˆ é™¤åˆšåˆšæäº¤çš„ä»»åŠ¡ //åˆ é™¤æˆåŠŸè¯´æ˜æ­¤æ—¶ä»»åŠ¡å°šæœªè¢«æ‰§è¡Œï¼Œåˆ é™¤å¤±è´¥ä»£è¡¨æ­¤æ—¶å·²ç»æœ‰æ ¸å¿ƒçº¿ç¨‹æ­£åœ¨æ‰§è¡Œä»»åŠ¡ if (! isRunning(recheck) &amp;&amp; remove(command)) //è¿›å…¥è¿™é‡Œè¯´æ˜çº¿ç¨‹æ± çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œå¹¶ä¸”ä»»åŠ¡åˆ é™¤æˆåŠŸï¼Œå¯åŠ¨æ‹’ç»ç­–ç•¥ reject(command); //å½“å‰æ˜¯runningçŠ¶æ€ æˆ–è€…å½“å‰æ˜¯érunningçŠ¶æ€ï¼Œå¹¶ä¸”ä»»åŠ¡å·²ç»åœ¨è¢«æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œ else if (workerCountOf(recheck) == 0) //çº¿ç¨‹æ± æ˜¯runningçŠ¶æ€ä½†æ˜¯çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹æ•°==0 addWorker(null, false); &#125; /** * æ‰§è¡Œåˆ°è¿™é‡Œæœ‰å‡ ç§æƒ…å†µï¼š * 1.ä»»åŠ¡å…¥é˜Ÿå¤±è´¥ï¼Œè¯´æ˜é˜Ÿåˆ—æ»¡äº† * 2.å½“å‰çº¿ç¨‹æ± æ˜¯érunningçŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™commondï¼=nullï¼Œaddworkerä¸€å®šè¿”å›false */ else if (!addWorker(command, false)) //è¾¾åˆ°äº†æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥ reject(command);&#125; 4.addWorkerè‡ªæ—‹å»ç”³è¯·ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œç”³è¯·æˆåŠŸä»¥åï¼Œå°†çº¿ç¨‹åŒ…è£…æˆä¸€ä¸ªworkerï¼ŒåŠ å…¥åˆ°workeré˜Ÿåˆ—ä¸­ï¼Œå¹¶å¯åŠ¨ä»»åŠ¡ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465//firstTaskå¯ä»¥ä¸ºç©ºï¼Œè‡ªåŠ¨å–queueæ‹¿ä»»åŠ¡ï¼Œ coreï¼šé‡‡ç”¨çš„çº¿ç¨‹æ•°é™åˆ¶ï¼Œtrueï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œfalseï¼Œéæ ¸å¿ƒçº¿ç¨‹ private boolean addWorker(Runnable firstTask, boolean core) &#123; retry: for (int c = ctl.get();;) &#123;//è·å–å½“å‰ctlä¿å­˜åˆ°c if (runStateAtLeast(c, SHUTDOWN)//å½“å‰çº¿ç¨‹æ± ä¸æ˜¯RUNNING &amp;&amp; (runStateAtLeast(c, STOP) || firstTask != null || workQueue.isEmpty())) //å½“å‰çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWN || ä»»åŠ¡ä¸ä¸ºç©º || é˜Ÿåˆ—ä¸ºç©º return false; //è‡ªæ—‹ï¼šæ¥åˆ°è¿™é‡Œè¯´æ˜çº¿ç¨‹æ± çš„çŠ¶æ€å…è®¸æ‰§è¡Œä»»åŠ¡ for (;;) &#123; //å¦‚æœå½“å‰çº¿ç¨‹æ± çš„æ•°é‡å¤§äºç­‰äºæœ€å¤§çº¿ç¨‹æ•° &amp;&amp; å·¥ä½œçº¿ç¨‹æ•°è¾¾åˆ°5äº¿ if (workerCountOf(c) &gt;= ((core ? corePoolSize : maximumPoolSize) &amp; COUNT_MASK)) return false; //å¦‚æœcasä½¿å·¥ä½œçº¿ç¨‹æ•°+1æˆåŠŸï¼Œç›¸å½“äºç”³è¯·åˆ°äº†ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); //æ¥åˆ°è¿™é‡Œè¯´æ˜ï¼š //1.å¹¶å‘å¯¼è‡´ç”³è¯·å·¥ä½œçº¿ç¨‹å¤±è´¥ //2.çº¿ç¨‹æ± çŠ¶æ€æ”¹å˜ if (runStateAtLeast(c, SHUTDOWN))//å¦‚æœçº¿ç¨‹æ± çŠ¶æ€æ²¡é—®é¢˜ï¼Œå†æ¬¡å°è¯•è·å–å·¥ä½œçº¿ç¨‹ continue retry; &#125; &#125; boolean workerStarted = false;//ä»»åŠ¡æ˜¯å¦å¼€å§‹æ‰§è¡Œ boolean workerAdded = false;//ä»»åŠ¡æ˜¯å¦æ·»åŠ åˆ°æ± å­ä¸­ Worker w = null; try &#123; w = new Worker(firstTask); //åŒ…è£…æˆä¸€ä¸ªworker final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; int c = ctl.get(); //å¦‚æœå½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯RUNNINGï¼Œä»»åŠ¡ä¸ä¸ºç©º if (isRunning(c) || (runStateLessThan(c, STOP) &amp;&amp; firstTask == null)) &#123; //å¦‚æœçº¿ç¨‹çŠ¶æ€ä¸æ˜¯å°±ç»ª if (t.getState() != Thread.State.NEW) throw new IllegalThreadStateException(); workers.add(w);//åŠ å…¥åˆ°é˜Ÿåˆ— workerAdded = true; int s = workers.size(); if (s &gt; largestPoolSize) largestPoolSize = s; &#125; &#125; finally &#123; mainLock.unlock(); &#125; if (workerAdded) &#123; t.start();//å¯åŠ¨ä»»åŠ¡ workerStarted = true; &#125; &#125; &#125; finally &#123; if (! workerStarted) //å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œé‡Šæ”¾æ‰åˆšæ‰è‡ªæ—‹è·å–çš„å·¥ä½œçº¿ç¨‹ addWorkerFailed(w); &#125; return workerStarted; &#125; 5.runworkeræ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å»è·å–ç‹¬å é”æ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆåå°†çº¿ç¨‹å®Œæˆçš„ä»»åŠ¡ä¹¦+1å¹¶é‡Šæ”¾é”ï¼Œç„¶åæ‰§è¡Œé€€å‡ºé€»è¾‘ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041 final void runWorker(Worker w) &#123; Thread wt = Thread.currentThread(); Runnable task = w.firstTask; w.firstTask = null; w.unlock(); //ä¸ºä»€ä¹ˆå…ˆè°ƒç”¨unlock()?ä¸ºäº†å¼ºåˆ¶åˆ·æ–°å½“å‰æŒæœ‰é”çš„çº¿ç¨‹ä¸ºç©ºã€‚ boolean completedAbruptly = true;//æ˜¯å¦çªç„¶é€€å‡ºï¼Ÿtrueè¡¨ç¤ºå‘ç”Ÿå¼‚å¸¸ï¼Œå½“å‰çº¿ç¨‹çªç„¶é€€å‡ºçš„ï¼Œfalseè¡¨ç¤ºæ­£å¸¸é€€å‡ºã€‚ try &#123;//ä»»åŠ¡ä¸ä¸ºç©º || åœ¨queueä¸­è·å–ä»»åŠ¡æˆåŠŸ while (task != null || (task = getTask()) != null) &#123; w.lock();//è®¾ç½®ç‹¬å é”ä¸ºå½“å‰çº¿ç¨‹ //ä¸ºä»€ä¹ˆè¦è®¾ç½®ç‹¬å é”ï¼Ÿé˜²æ­¢shutdownæ—¶ä¼šåˆ¤æ–­å½“å‰workçŠ¶æ€ //å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOP || //ï¼ˆè·å–å½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€å¹¶ç»™å½“å‰çº¿ç¨‹è®¾ç½®ä¸­æ–­ä¿¡å·æœªfalse &amp;&amp; çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOPï¼‰&amp;&amp; çº¿ç¨‹æœªè®¾ç½®ä¸­æ–­çŠ¶æ€ if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); try &#123; //é’©å­æ–¹æ³• beforeExecute(wt, task); try &#123; //æ‰§è¡Œä»»åŠ¡ task.run(); afterExecute(task, null);//é’©å­æ–¹æ³• &#125; catch (Throwable ex) &#123; afterExecute(task, ex);//é’©å­æ–¹æ³• throw ex; &#125; &#125; finally &#123; task = null; w.completedTasks++;//å°†çº¿ç¨‹å®Œæˆçš„ä»»åŠ¡æ•°+1 w.unlock();//é‡Šæ”¾é” &#125; &#125; completedAbruptly = false;//å¼‚å¸¸æ‰“æ–­æ ‡è®°è®¾ç½®ä¸ºfalse &#125; finally &#123;//æ‰§è¡Œé€€å‡ºé€»è¾‘ processWorkerExit(w, completedAbruptly); &#125; &#125; 6.getTaskè‡ªæ—‹çš„æ–¹å¼å»é˜Ÿåˆ—è·å–ä»»åŠ¡ 123456789101112131415161718192021222324252627282930313233343536373839404142private Runnable getTask() &#123; boolean timedOut = false; for (;;) &#123; int c = ctl.get(); //å¦‚æœå½“å‰çº¿ç¨‹æ± æ˜¯éRUNNING &amp;&amp; å½“å‰çŠ¶æ€å¤§äºç­‰äº STOP || queueä¸ºç©º if (runStateAtLeast(c, SHUTDOWN) &amp;&amp; (runStateAtLeast(c, STOP) || workQueue.isEmpty())) &#123; decrementWorkerCount(); //å°†è·å–åˆ°çš„å·¥ä½œçº¿ç¨‹è¿˜å›å» return null; &#125; /* èƒ½å¤Ÿæ¥åˆ°è¿™é‡Œçš„æƒ…å†µï¼š 1.RUNNING 2.SHUTDOWNä½†æ˜¯é˜Ÿåˆ—ä¸ä¸ºç©º */ int wc = workerCountOf(c); //è·å–åˆ°workeræ•°é‡ //å¦‚æœæ˜¯æ ¸å¿ƒçº¿ç¨‹å°±ä¸éœ€è¦è¶…æ—¶æ—¶é—´ boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize; //æ¡ä»¶1è¯´æ˜ å½“å‰å·¥ä½œçº¿ç¨‹æ•°å·²ç»å¤§äºæœ€å¤§çº¿ç¨‹æ•° //æ¡ä»¶2è¯´æ˜ å½“å‰çº¿ç¨‹å¯ä»¥è¢«å›æ”¶ ||wc==1ä¸”ä»»åŠ¡é˜Ÿåˆ—å·²ç»ç©ºäº†ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥æ”¾å¿ƒé€€å‡ºã€‚ if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123; if (compareAndDecrementWorkerCount(c))//å¦‚æœæˆåŠŸå‡å°‘workeræ•°é‡ return null; continue; &#125; try &#123; Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take();//å»é˜Ÿåˆ—è·å–ä»»åŠ¡ if (r != null)//ä»»åŠ¡ä¸ä¸ºç©ºï¼Œè¿”å›ä»»åŠ¡ return r; timedOut = true;//å¦åˆ™æ ‡è®°ä¸ºè¶…æ—¶ &#125; catch (InterruptedException retry) &#123; timedOut = false; &#125; &#125;&#125; 7.shutdownä»–ä¼šå…ˆå°è¯•å»åœæ­¢æ‰€æœ‰ç©ºé—²çš„çº¿ç¨‹ï¼Œç„¶åæ‰§è¡ŒtryTerminate()ï¼ŒtryTerminate()ä¼šé€šè¿‡è‡ªæ—‹çš„æ–¹å¼åˆ¤æ–­ï¼Œå½“é˜Ÿåˆ—é‡Œé¢çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†ï¼Œé”€æ¯æ‰æ‰§è¡Œå®Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œå½“æœ€åä¸€ä¸ªçº¿ç¨‹é€€å‡ºçš„æ—¶å€™ï¼Œå°†çº¿ç¨‹æ± çŠ¶æ€ä¿®æ”¹ä¸ºTIDYINGï¼Œæœ€ç»ˆä¿®æ”¹ä¸ºTERMINATEDã€‚ 12345678910111213public void shutdown() &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock();//è·å–å…¨å±€é” try &#123; checkShutdownAccess();//æƒé™åˆ¤æ–­ advanceRunState(SHUTDOWN);//è‡ªæ—‹è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWN interruptIdleWorkers();//éå†æ‰€æœ‰çš„çº¿ç¨‹ï¼Œä¸­æ–­ç©ºé—²çº¿ç¨‹ onShutdown(); // ç©ºæ–¹æ³•ï¼Œå­ç±»å¯ä»¥æ‰©å±• &#125; finally &#123; mainLock.unlock(); &#125; tryTerminate();&#125; 8.shutdownNowè‡ªæ—‹è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOPï¼Œéå†ä¸­æ–­ï¼ˆinterruptçš„æ–¹å¼ï¼‰çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹ï¼Œå¯¼å‡ºæ‰€æœ‰æœªå¤„ç†çš„ä»»åŠ¡ï¼Œç„¶åæ‰§è¡ŒtryTerminate()ã€‚ 123456789101112131415public List&lt;Runnable&gt; shutdownNow() &#123; List&lt;Runnable&gt; tasks; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; checkShutdownAccess(); advanceRunState(STOP);//è‡ªæ—‹è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOP interruptWorkers();//éå†ä¸­æ–­çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹ tasks = drainQueue();//å¯¼å‡ºæ‰€æœ‰æœªå¤„ç†çš„ä»»åŠ¡ &#125; finally &#123; mainLock.unlock(); &#125; tryTerminate(); return tasks;&#125; 9.tryTerminateé€šè¿‡è‡ªæ—‹çš„æ–¹å¼ï¼Œå½“éç©ºé—²çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ï¼Œå°±ä¼šæ¥åˆ°è¿™é‡Œè¢«ä¸­æ–­ï¼Œæœ€åä¸€ä¸ªé€€å‡ºçš„çº¿ç¨‹ï¼Œè®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºTIDYINGï¼Œæœ€ç»ˆè®¾ç½®ä¸ºè®¾ç½®ä¸ºTERMINATEDï¼Œå¹¶è°ƒç”¨termination.signalAll();å”¤é†’è°ƒç”¨awaitTermination()çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œç¨‹åºã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445final void tryTerminate() &#123; for (;;) &#123;//è‡ªæ—‹ int c = ctl.get(); /* çº¿ç¨‹æ± RUNNING ||çº¿ç¨‹æ± å¤§äºç­‰äºTIDYING(è¯´æ˜å·²ç»æœ‰çº¿ç¨‹åœ¨æ‰§è¡Œè¿™ä¸ªæ–¹æ³•) || çº¿ç¨‹æ± å¤§äºSTOPçŠ¶æ€ ä¸” é˜Ÿåˆ—ä¸ä¸ºç©º */ if (isRunning(c) || runStateAtLeast(c, TIDYING) || (runStateLessThan(c, STOP) &amp;&amp; ! workQueue.isEmpty())) return; /* ä»€ä¹ˆæ—¶å€™æ‰§è¡Œåˆ°è¿™é‡Œï¼Ÿ 1.çº¿ç¨‹æ± çŠ¶æ€å¤§äºç­‰äºSTOP 2.çº¿ç¨‹æ± çŠ¶æ€å¤§äºç­‰äºSTOPå¹¶ä¸”é˜Ÿåˆ—ä¸ºç©º å½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡&gt;0 */ if (workerCountOf(c) != 0) &#123; //éç©ºé—²çº¿ç¨‹å½“æ‰§è¡Œå®Œä»»åŠ¡ï¼Œæœ€ç»ˆä¹Ÿä¼šæ‰§è¡Œåˆ°è¿™é‡Œ interruptIdleWorkers(ONLY_ONE);//ä¸­æ–­ä¸€ä¸ªç©ºé—²çº¿ç¨‹ return; &#125; //æœ€åä¸€ä¸ªé€€å‡ºçš„çº¿ç¨‹ä¼šæ¥åˆ°è¿™é‡Œ final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; //å¼ºåˆ¶è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºTIDYING if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) &#123; try &#123; terminated(); //é’©å­æ–¹æ³• &#125; finally &#123; //è®¾ç½®ä¸ºTERMINATED ctl.set(ctlOf(TERMINATED, 0)); //å”¤é†’è°ƒç”¨awaitTermination()çš„çº¿ç¨‹ termination.signalAll(); &#125; return; &#125; &#125; finally &#123; mainLock.unlock(); &#125; // else retry on failed CAS &#125;&#125;","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"CyclicBarrier","slug":"JUC/CyclicBarrier","date":"2022-01-11T11:07:39.796Z","updated":"2022-01-11T11:28:00.513Z","comments":true,"path":"2022/01/11/JUC/CyclicBarrier/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/CyclicBarrier/","excerpt":"","text":"ä¸€ï¼Œä½¿ç”¨CyclicBarrier çš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆCyclicï¼‰çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å·¥ä½œã€‚CyclicBarrier é»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯ CyclicBarrier(int parties)ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨ await æ–¹æ³•å‘Šè¯‰ CyclicBarrier å½“å‰çº¿ç¨‹å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public class CyclicBarrierTest01 &#123; /** * æ¡ˆä¾‹ï¼š * æ¨¡æ‹Ÿè¿‡æ°”æ¸¸æˆ â€œç‹è€…è£è€€â€ æ¸¸æˆå¼€å§‹é€»è¾‘ */ public static void main(String[] args) &#123; //ç¬¬ä¸€æ­¥ï¼šå®šä¹‰ç©å®¶ï¼Œå®šä¹‰5ä¸ª String[] heros = &#123;&quot;å®‰çªæ‹‰&quot;,&quot;äºšç‘Ÿ&quot;,&quot;é©¬è¶…&quot;,&quot;å¼ é£&quot;, &quot;åˆ˜å¤‡&quot;&#125;; //ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ•°é‡ä¸º5 ExecutorService service = Executors.newFixedThreadPool(5); //ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºbarrierï¼Œparties è®¾ç½®ä¸º5 CyclicBarrier barrier = new CyclicBarrier(5); //ç¬¬å››æ­¥ï¼šé€šè¿‡forå¾ªç¯å¼€å¯5ä»»åŠ¡ï¼Œæ¨¡æ‹Ÿå¼€å§‹æ¸¸æˆï¼Œä¼ é€’ç»™æ¯ä¸ªä»»åŠ¡ è‹±é›„åç§°å’Œbarrier for(int i = 0; i &lt; 5; i++) &#123; service.execute(new Player(heros[i], barrier)); &#125; service.shutdown(); &#125; static class Player implements Runnable &#123; private String hero; private CyclicBarrier barrier; public Player(String hero, CyclicBarrier barrier) &#123; this.hero = hero; this.barrier = barrier; &#125; @Override public void run() &#123; try &#123; //æ¯ä¸ªç©å®¶åŠ è½½è¿›åº¦ä¸ä¸€æ ·ï¼Œè¿™é‡Œä½¿ç”¨éšæœºæ•°æ¥æ¨¡æ‹Ÿï¼ TimeUnit.SECONDS.sleep(new Random().nextInt(10)); System.out.println(hero + &quot;ï¼šåŠ è½½è¿›åº¦100%ï¼Œç­‰å¾…å…¶ä»–ç©å®¶åŠ è½½å®Œæˆä¸­...&quot;); barrier.await(); System.out.println(hero + &quot;ï¼šå‘ç°æ‰€æœ‰è‹±é›„åŠ è½½å®Œæˆï¼Œå¼€å§‹æˆ˜æ–—å§ï¼&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; catch (BrokenBarrierException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125; å¯¹äºæŒ‡å®šè®¡æ•°å€¼ partiesï¼Œè‹¥ç”±äºæŸç§åŸå› ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„çº¿ç¨‹è°ƒç”¨ CyclicBarrier çš„ awaitï¼Œåˆ™æ‰€æœ‰è°ƒç”¨ await çš„çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ï¼› åŒæ ·çš„ CyclicBarrier ä¹Ÿå¯ä»¥è°ƒç”¨ await(timeout, unit)ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œåœ¨è®¾å®šæ—¶é—´å†…ï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿçº¿ç¨‹åˆ°è¾¾ï¼Œåˆ™è§£é™¤é˜»å¡çŠ¶æ€ï¼Œç»§ç»­å·¥ä½œï¼› é€šè¿‡ reset é‡ç½®è®¡æ•°ï¼Œä¼šä½¿å¾—è¿›å…¥ await çš„çº¿ç¨‹å‡ºç°BrokenBarrierExceptionï¼› å¦‚ æœ é‡‡ ç”¨ æ˜¯ CyclicBarrier(int parties, RunnablebarrierAction) æ„é€ æ–¹æ³•ï¼Œæ‰§è¡Œ barrierAction æ“ä½œçš„æ˜¯æœ€åä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹ã€‚ äºŒï¼Œæºç  2.1 æˆå‘˜å˜é‡ å±æ€§ å†…éƒ¨ç±»1234567891011121314151617181920212223/** * æ¯ä¸ªbarrieréƒ½è¡¨ç¤ºä¸ºä¸€ä¸ªgenerationå®ä¾‹ã€‚å½“barrierè§¦å‘tripæ¡ä»¶æˆ–é‡ç½®æ—¶generationéšä¹‹æ”¹å˜ã€‚ * ä½¿ç”¨barrieræ—¶æœ‰å¾ˆå¤šgenerationä¸çº¿ç¨‹å…³è”-ç”±äºä¸ç¡®å®šæ€§çš„æ–¹å¼ï¼Œé”å¯èƒ½åˆ†é…ç»™ç­‰å¾…çš„çº¿ç¨‹ã€‚ * ä½†æ˜¯åœ¨åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæ˜¯æ´»è·ƒçš„generation(é€šè¿‡countå˜é‡ç¡®å®š)ï¼Œå¹¶ä¸”å…¶ä½™çš„è¦ä¹ˆè¢«é”€æ¯ï¼Œè¦ä¹ˆè¢«tripæ¡ä»¶ç­‰å¾…ã€‚ * å¦‚æœæœ‰ä¸€ä¸ªä¸­æ–­ï¼Œä½†æ²¡æœ‰éšåçš„é‡ç½®ï¼Œå°±ä¸éœ€è¦æœ‰æ´»è·ƒçš„generationã€‚ */private static class Generation &#123; boolean broken = false;&#125;//å› ä¸ºbarrierå®ç°æ˜¯ä¾èµ–äºConditionæ¡ä»¶é˜Ÿåˆ—çš„ï¼Œconditionæ¡ä»¶é˜Ÿåˆ—å¿…é¡»ä¾èµ–lockæ‰èƒ½ä½¿ç”¨ã€‚private final ReentrantLock lock = new ReentrantLock();//çº¿ç¨‹æŒ‚èµ·å®ç°ä½¿ç”¨çš„ condition é˜Ÿåˆ—ã€‚æ¡ä»¶ï¼šå½“å‰ä»£æ‰€æœ‰çº¿ç¨‹åˆ°ä½ï¼Œè¿™ä¸ªæ¡ä»¶é˜Ÿåˆ—å†…çš„çº¿ç¨‹ æ‰ä¼šè¢«å”¤é†’ã€‚private final Condition trip = lock.newCondition();//Barrieréœ€è¦å‚ä¸è¿›æ¥çš„çº¿ç¨‹æ•°é‡private final int parties;//å½“å‰ä»£ æœ€åä¸€ä¸ªåˆ°ä½çš„çº¿ç¨‹ éœ€è¦æ‰§è¡Œçš„äº‹ä»¶private final Runnable barrierCommand;//è¡¨ç¤ºbarrierå¯¹è±¡ å½“å‰ â€œä»£â€private Generation generation = new Generation();//è¡¨ç¤ºå½“å‰â€œä»£â€è¿˜æœ‰å¤šå°‘ä¸ªçº¿ç¨‹ æœªåˆ°ä½ã€‚//åˆå§‹å€¼ä¸ºpartiesprivate int count; 2.2 æ„é€ å™¨123456789101112//æ„é€ å‡½æ•°ï¼ŒæŒ‡å®šå‚ä¸çº¿ç¨‹æ•°ï¼Œå¹¶åœ¨æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾barrierä¹‹åæ‰§è¡Œç»™å®šçš„barrierActioné€»è¾‘public CyclicBarrier(int parties, Runnable barrierAction) &#123; if (parties &lt;= 0) throw new IllegalArgumentException(); this.parties = parties; this.count = parties; this.barrierCommand = barrierAction;&#125;//æ„é€ å‡½æ•°ï¼ŒæŒ‡å®šå‚ä¸çº¿ç¨‹æ•°public CyclicBarrier(int parties) &#123; this(parties, null);&#125; 2.3 await12345678//ç­‰å¾…æ‰€æœ‰çš„å‚ä¸è€…åˆ°è¾¾barrierpublic int await() throws InterruptedException, BrokenBarrierException &#123; try &#123; return dowait(false, 0L); &#125; catch (TimeoutException toe) &#123; throw new Error(toe); // cannot happen &#125;&#125; 2.4 dowait123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133/** * Main barrier code, covering the various policies. * timedï¼šè¡¨ç¤ºå½“å‰è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦æŒ‡å®šäº† è¶…æ—¶æ—¶é•¿ï¼Œå¦‚æœtrue è¡¨ç¤º çº¿ç¨‹æ˜¯å“åº”è¶…æ—¶çš„ * nanosï¼šçº¿ç¨‹ç­‰å¾…è¶…æ—¶æ—¶é•¿ çº³ç§’ï¼Œå¦‚æœtimed == false ,nanos == 0 */private int dowait(boolean timed, long nanos) throws InterruptedException, BrokenBarrierException,TimeoutException &#123; //è·å–barrierå…¨å±€é”å¯¹è±¡ final ReentrantLock lock = this.lock; //åŠ é” //ä¸ºä»€ä¹ˆè¦åŠ é”å‘¢ï¼Ÿ //å› ä¸º barrierçš„æŒ‚èµ· å’Œ å”¤é†’ ä¾èµ–çš„ç»„ä»¶æ˜¯ conditionã€‚ lock.lock(); try &#123; //è·å–barrierå½“å‰çš„ â€œä»£â€ final Generation g = generation; //å¦‚æœå½“å‰ä»£æ˜¯å·²ç»è¢«æ‰“ç ´çŠ¶æ€ï¼Œåˆ™å½“å‰è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºBrokenå¼‚å¸¸ if (g.broken) throw new BrokenBarrierException(); //å¦‚æœå½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ä½ ä¸º trueï¼Œåˆ™æ‰“ç ´å½“å‰ä»£ï¼Œç„¶åå½“å‰çº¿ç¨‹æŠ›å‡º ä¸­æ–­å¼‚å¸¸ if (Thread.interrupted()) &#123; //1.è®¾ç½®å½“å‰ä»£çš„çŠ¶æ€ä¸ºbrokençŠ¶æ€ 2.å”¤é†’åœ¨trip æ¡ä»¶é˜Ÿåˆ—å†…çš„çº¿ç¨‹ breakBarrier(); throw new InterruptedException(); &#125; //æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ å½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€æ˜¯æ­£å¸¸çš„ falseï¼Œ å½“å‰ä»£çš„brokenä¸º falseï¼ˆæœªæ‰“ç ´çŠ¶æ€ï¼‰ //æ­£å¸¸é€»è¾‘... //å‡è®¾ parties ç»™çš„æ˜¯ 5ï¼Œé‚£ä¹ˆindexå¯¹åº”çš„å€¼ä¸º 4,3,2,1,0 int index = --count; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯æœ€åä¸€ä¸ªåˆ°è¾¾barrierçš„çº¿ç¨‹ï¼Œæ­¤æ—¶éœ€è¦åšä»€ä¹ˆå‘¢ï¼Ÿ if (index == 0) &#123; // tripped //æ ‡è®°ï¼štrueè¡¨ç¤º æœ€åä¸€ä¸ªçº¿ç¨‹ æ‰§è¡Œcmdæ—¶æœªæŠ›å¼‚å¸¸ã€‚ falseï¼Œè¡¨ç¤ºæœ€åä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œcmdæ—¶æŠ›å‡ºå¼‚å¸¸äº†. //cmdå°±æ˜¯åˆ›å»º barrierå¯¹è±¡æ—¶ æŒ‡å®šçš„ç¬¬äºŒä¸ª Runnableæ¥å£å®ç°ï¼Œè¿™ä¸ªå¯ä»¥ä¸ºnull boolean ranAction = false; try &#123; final Runnable command = barrierCommand; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜åˆ›å»ºbarrierå¯¹è±¡æ—¶ æŒ‡å®š Runnableæ¥å£äº†ï¼Œè¿™ä¸ªæ—¶å€™æœ€åä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹ å°±éœ€è¦æ‰§è¡Œè¿™ä¸ªæ¥å£ if (command != null) command.run(); //command.run()æœªæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¼šæ‰§è¡Œåˆ°è¿™é‡Œã€‚ ranAction = true; //å¼€å¯æ–°çš„ä¸€ä»£ //1.å”¤é†’tripæ¡ä»¶é˜Ÿåˆ—å†…æŒ‚èµ·çš„çº¿ç¨‹ï¼Œè¢«å”¤é†’çš„çº¿ç¨‹ ä¼šä¾æ¬¡ è·å–åˆ°lockï¼Œç„¶åä¾æ¬¡é€€å‡ºawaitæ–¹æ³•ã€‚ //2.é‡ç½®count ä¸º parties //3.åˆ›å»ºä¸€ä¸ªæ–°çš„generationå¯¹è±¡ï¼Œè¡¨ç¤ºæ–°çš„ä¸€ä»£ nextGeneration(); //è¿”å›0ï¼Œå› ä¸ºå½“å‰çº¿ç¨‹æ˜¯æ­¤ ä»£ æœ€åä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹ï¼Œæ‰€ä»¥Index == 0 return 0; &#125; finally &#123; if (!ranAction) //å¦‚æœcommand.run()æ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œä¼šè¿›å…¥åˆ°è¿™é‡Œã€‚ breakBarrier(); &#125; &#125; //æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜å½“å‰çº¿ç¨‹ å¹¶ä¸æ˜¯æœ€åä¸€ä¸ªåˆ°è¾¾Barrierçš„çº¿ç¨‹..æ­¤æ—¶éœ€è¦è¿›å…¥ä¸€ä¸ªè‡ªæ—‹ä¸­. // loop until tripped, broken, interrupted, or timed out //è‡ªæ—‹ï¼Œä¸€ç›´åˆ° æ¡ä»¶æ»¡è¶³ã€å½“å‰ä»£è¢«æ‰“ç ´ã€çº¿ç¨‹è¢«ä¸­æ–­ï¼Œç­‰å¾…è¶…æ—¶ for (;;) &#123; try &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ä¸æŒ‡å®šè¶…æ—¶æ—¶é—´çš„ if (!timed) //å½“å‰çº¿ç¨‹ ä¼š é‡Šæ”¾æ‰lockï¼Œç„¶åè¿›å…¥åˆ°tripæ¡ä»¶é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œç„¶åæŒ‚èµ·è‡ªå·±ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚ trip.await(); else if (nanos &gt; 0L) //è¯´æ˜å½“å‰çº¿ç¨‹è°ƒç”¨awaitæ–¹æ³•æ—¶ æ˜¯æŒ‡å®šäº† è¶…æ—¶æ—¶é—´çš„ï¼ nanos = trip.awaitNanos(nanos); &#125; catch (InterruptedException ie) &#123; //æŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼Œä¼šè¿›æ¥è¿™é‡Œã€‚ //ä»€ä¹ˆæ—¶å€™ä¼šæŠ›å‡ºInterruptedExceptionå¼‚å¸¸å‘¢ï¼Ÿ //NodeèŠ‚ç‚¹åœ¨ æ¡ä»¶é˜Ÿåˆ—å†… æ—¶ æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼ //æ¡ä»¶ä¸€ï¼šg == generation æˆç«‹ï¼Œè¯´æ˜å½“å‰ä»£å¹¶æ²¡æœ‰å˜åŒ–ã€‚ //æ¡ä»¶äºŒï¼š! g.broken å½“å‰ä»£å¦‚æœæ²¡æœ‰è¢«æ‰“ç ´ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±å»æ‰“ç ´ï¼Œå¹¶ä¸”æŠ›å‡ºå¼‚å¸¸.. if (g == generation &amp;&amp; ! g.broken) &#123; breakBarrier(); throw ie; &#125; else &#123; //æ‰§è¡Œåˆ°elseæœ‰å‡ ç§æƒ…å†µï¼Ÿ //1.ä»£å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸éœ€è¦æŠ›å‡ºä¸­æ–­å¼‚å¸¸äº†ï¼Œå› ä¸º ä»£å·²ç»æ›´æ–°äº†ï¼Œè¿™é‡Œå”¤é†’åå°±èµ°æ­£å¸¸é€»è¾‘äº†..åªä¸è¿‡è®¾ç½®ä¸‹ ä¸­æ–­æ ‡è®°ã€‚ //2.ä»£æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯ä»£è¢«æ‰“ç ´äº†ï¼Œæ­¤æ—¶ä¹Ÿä¸ç”¨è¿”å›ä¸­æ–­å¼‚å¸¸ï¼Œæ‰§è¡Œåˆ°ä¸‹é¢çš„æ—¶å€™ä¼šæŠ›å‡º brokenBarrierå¼‚å¸¸ã€‚ä¹Ÿè®°å½•ä¸‹ä¸­æ–­æ ‡è®°ä½ã€‚ // We&#x27;re about to finish waiting even if we had not // been interrupted, so this interrupt is deemed to // &quot;belong&quot; to subsequent execution. Thread.currentThread().interrupt(); &#125; &#125; //å”¤é†’åï¼Œæ‰§è¡Œåˆ°è¿™é‡Œï¼Œæœ‰å‡ ç§æƒ…å†µï¼Ÿ //1.æ­£å¸¸æƒ…å†µï¼Œå½“å‰barrierå¼€å¯äº†æ–°çš„ä¸€ä»£ï¼ˆtrip.signalAll()ï¼‰ //2.å½“å‰Generationè¢«æ‰“ç ´ï¼Œæ­¤æ—¶ä¹Ÿä¼šå”¤é†’æ‰€æœ‰åœ¨tripä¸ŠæŒ‚èµ·çš„çº¿ç¨‹ //3.å½“å‰çº¿ç¨‹tripä¸­ç­‰å¾…è¶…æ—¶ï¼Œç„¶åä¸»åŠ¨è½¬ç§»åˆ° é˜»å¡é˜Ÿåˆ— ç„¶åè·å–åˆ°é” å”¤é†’ã€‚ //æ¡ä»¶æˆç«‹ï¼šå½“å‰ä»£å·²ç»è¢«æ‰“ç ´ if (g.broken) //çº¿ç¨‹å”¤é†’åä¾æ¬¡æŠ›å‡ºBrokenBarrierå¼‚å¸¸ã€‚ throw new BrokenBarrierException(); //å”¤é†’åï¼Œæ‰§è¡Œåˆ°è¿™é‡Œï¼Œæœ‰å‡ ç§æƒ…å†µï¼Ÿ //1.æ­£å¸¸æƒ…å†µï¼Œå½“å‰barrierå¼€å¯äº†æ–°çš„ä¸€ä»£ï¼ˆtrip.signalAll()ï¼‰ //3.å½“å‰çº¿ç¨‹tripä¸­ç­‰å¾…è¶…æ—¶ï¼Œç„¶åä¸»åŠ¨è½¬ç§»åˆ° é˜»å¡é˜Ÿåˆ— ç„¶åè·å–åˆ°é” å”¤é†’ã€‚ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹æŒ‚èµ·æœŸé—´ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹åˆ°ä½äº†ï¼Œç„¶åè§¦å‘äº†å¼€å¯æ–°çš„ä¸€ä»£çš„é€»è¾‘ï¼Œæ­¤æ—¶å”¤é†’tripæ¡ä»¶é˜Ÿåˆ—å†…çš„çº¿ç¨‹ã€‚ if (g != generation) //è¿”å›å½“å‰çº¿ç¨‹çš„indexã€‚ return index; //å”¤é†’åï¼Œæ‰§è¡Œåˆ°è¿™é‡Œï¼Œæœ‰å‡ ç§æƒ…å†µï¼Ÿ //3.å½“å‰çº¿ç¨‹tripä¸­ç­‰å¾…è¶…æ—¶ï¼Œç„¶åä¸»åŠ¨è½¬ç§»åˆ° é˜»å¡é˜Ÿåˆ— ç„¶åè·å–åˆ°é” å”¤é†’ã€‚ if (timed &amp;&amp; nanos &lt;= 0L) &#123; //æ‰“ç ´barrier breakBarrier(); //æŠ›å‡ºè¶…æ—¶å¼‚å¸¸. throw new TimeoutException(); &#125; &#125; &#125; finally &#123; lock.unlock(); &#125;&#125; 2.5 breakBarrieræ‰“ç ´barrierå±éšœï¼Œå†å±éšœå†…çš„çº¿ç¨‹ éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ 123456789private void breakBarrier() &#123; //å°†ä»£ä¸­çš„brokenè®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºè¿™ä¸€ä»£æ˜¯è¢«æ‰“ç ´äº†çš„ï¼Œå†æ¥åˆ°è¿™ä¸€ä»£çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸. generation.broken = true; //é‡ç½®countä¸ºparties count = parties; //å°†åœ¨tripæ¡ä»¶é˜Ÿåˆ—å†…æŒ‚èµ·çš„çº¿ç¨‹ å…¨éƒ¨å”¤é†’ï¼Œå”¤é†’åçš„çº¿ç¨‹ ä¼šæ£€æŸ¥å½“å‰ä»£ æ˜¯å¦æ˜¯æ‰“ç ´çš„ï¼Œ //å¦‚æœæ˜¯æ‰“ç ´çš„è¯ï¼Œæ¥ä¸‹æ¥çš„é€»è¾‘å’Œ å¼€å¯ä¸‹ä¸€ä»£ å”¤é†’çš„é€»è¾‘ä¸ä¸€æ ·. trip.signalAll();&#125; 2.6 nextGenerationå¼€å¯ä¸‹ä¸€ä»£ï¼Œå½“è¿™ä¸€ä»£æ‰€æœ‰çš„çº¿ç¨‹åˆ°ä½åï¼ˆå‡è®¾barrierCommandä¸ä¸ºç©ºï¼Œè¿˜éœ€è¦æœ€åä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œäº‹ä»¶ï¼‰ï¼Œä¼šè°ƒç”¨nextGenerationå¼€å¯æ–°çš„ä¸€ä»£ã€‚ 123456789101112private void nextGeneration() &#123; //å°†åœ¨tripæ¡ä»¶é˜Ÿåˆ—å†…æŒ‚èµ·çš„çº¿ç¨‹ å…¨éƒ¨å”¤é†’ // signal completion of last generation trip.signalAll(); //é‡ç½®countä¸ºparties // set up next generation count = parties; //å¼€å¯æ–°çš„ä¸€ä»£..ä½¿ç”¨ä¸€ä¸ªæ–°çš„ generationå¯¹è±¡ï¼Œè¡¨ç¤ºæ–°çš„ä¸€ä»£ï¼Œæ–°çš„ä¸€ä»£å’Œä¸Šä¸€ä»£ æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚ generation = new Generation();&#125;","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"Semaphore","slug":"JUC/Semaphore","date":"2022-01-11T11:07:31.422Z","updated":"2022-01-11T11:32:49.088Z","comments":true,"path":"2022/01/11/JUC/Semaphore/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/Semaphore/","excerpt":"","text":"ä¸€ï¼Œä½¿ç”¨12345678910111213141516171819202122232425262728293031323334353637383940414243@Testpublic void test3()throws InterruptedException&#123; final Semaphore semaphore = new Semaphore(2,true); new Thread(()-&gt;&#123; try &#123; semaphore.acquire(); System.out.println(&quot;çº¿ç¨‹Aè·å–é€šè¡Œè¯æˆåŠŸï¼&quot;); TimeUnit.SECONDS.sleep(10); &#125;catch (Exception e)&#123; &#125;finally &#123; semaphore.release(); &#125; &#125;).start(); TimeUnit.MICROSECONDS.sleep(200); new Thread(()-&gt;&#123; try &#123; semaphore.acquire(); System.out.println(&quot;çº¿ç¨‹Bè·å–é€šè¡Œè¯æˆåŠŸï¼&quot;); TimeUnit.SECONDS.sleep(10); &#125;catch (Exception e)&#123; &#125;finally &#123; semaphore.release(); &#125; &#125;).start(); TimeUnit.MILLISECONDS.sleep(200); new Thread(() -&gt;&#123; try &#123; semaphore.acquire(); System.out.println(&quot;çº¿ç¨‹Cè·å–é€šè¡Œè¯æˆåŠŸ!&quot;); &#125; catch (InterruptedException e) &#123; &#125;finally &#123; semaphore.release(); &#125; &#125;).start(); while (true)&#123;&#125;&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061public class Pool &#123; /** å¯åŒæ—¶è®¿é—®èµ„æºçš„æœ€å¤§çº¿ç¨‹æ•°*/ private static final int MAX_AVAILABLE = 100; /** ä¿¡å·é‡ è¡¨ç¤ºï¼šå¯è·å–çš„å¯¹è±¡é€šè¡Œè¯*/ private final Semaphore available = new Semaphore(MAX_AVAILABLE, true); /** å…±äº«èµ„æºï¼Œå¯ä»¥æƒ³è±¡æˆ items æ•°ç»„å†…å­˜å‚¨çš„éƒ½æ˜¯Connectionå¯¹è±¡ æ¨¡æ‹Ÿæ˜¯é“¾æ¥æ± */ protected Object[] items = new Object[MAX_AVAILABLE]; /** å…±äº«èµ„æºå ç”¨æƒ…å†µï¼Œä¸itemsæ•°ç»„ä¸€ä¸€å¯¹åº”ï¼Œæ¯”å¦‚ï¼šitems[0]å¯¹è±¡è¢«å¤–éƒ¨çº¿ç¨‹å ç”¨ï¼Œé‚£ä¹ˆ used[0] == trueï¼Œå¦åˆ™used[0] == false*/ protected boolean[] used = new boolean[MAX_AVAILABLE]; /** * è·å–ä¸€ä¸ªç©ºé—²å¯¹è±¡ * å¦‚æœå½“å‰æ± ä¸­æ— ç©ºé—²å¯¹è±¡ï¼Œåˆ™ç­‰å¾…..ç›´åˆ°æœ‰ç©ºé—²å¯¹è±¡ä¸ºæ­¢ */ public Object getItem() throws InterruptedException &#123; available.acquire(); return getNextAvailableItem(); &#125; /** * å½’è¿˜å¯¹è±¡åˆ°æ± ä¸­ */ public void putItem(Object x) &#123; if (markAsUnused(x)) available.release(); &#125; /** * è·å–æ± å†…ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼Œè·å–æˆåŠŸåˆ™è¿”å›Objectï¼Œå¤±è´¥è¿”å›Null * æˆåŠŸåå°†å¯¹åº”çš„ used[i] = true */ private synchronized Object getNextAvailableItem() &#123; for (int i = 0; i &lt; MAX_AVAILABLE; ++i) &#123; if (!used[i]) &#123; used[i] = true; return items[i]; &#125; &#125; return null; &#125; /** * å½’è¿˜å¯¹è±¡åˆ°æ± ä¸­ï¼Œå½’è¿˜æˆåŠŸè¿”å›true * å½’è¿˜å¤±è´¥ï¼š * 1.æ± ä¸­ä¸å­˜åœ¨è¯¥å¯¹è±¡å¼•ç”¨ï¼Œè¿”å›false * 2.æ± ä¸­å­˜åœ¨è¯¥å¯¹è±¡å¼•ç”¨ï¼Œä½†è¯¥å¯¹è±¡ç›®å‰çŠ¶æ€ä¸ºç©ºé—²çŠ¶æ€ï¼Œä¹Ÿè¿”å›false */ private synchronized boolean markAsUnused(Object item) &#123; for (int i = 0; i &lt; MAX_AVAILABLE; ++i) &#123; if (item == items[i]) &#123; if (used[i]) &#123; used[i] = false; return true; &#125; else return false; &#125; &#125; return false; &#125;&#125; äºŒï¼Œæºç  1.æ„é€ å™¨1234567891011121314//é»˜è®¤æ˜¯éå…¬å¹³é”public Semaphore(int permits) &#123; sync = new NonfairSync(permits);&#125;//å¯ä»¥æŒ‡å®šä¸ºå…¬å¹³é”çš„æ„é€ å™¨public Semaphore(int permits, boolean fair) &#123; sync = fair ? new FairSync(permits) : new NonfairSync(permits);&#125;//=======================//Sync(int permits) &#123; setState(permits);&#125; 2.acquire1234public void acquire() throws InterruptedException &#123; //å»æŠ¢å é”ï¼Œé»˜è®¤ä¼ 1ï¼Œå¦‚æœæƒ³è¦ä¼ å…¶ä»–å‚æ•°ï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®š sync.acquireSharedInterruptibly(1);&#125; 3.AQS.acquireSharedInterruptibly1234567891011public final void acquireSharedInterruptibly(int arg) throws InterruptedException &#123; //å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è¢«ä¸­æ–­ æŠ›å‡ºä¸­æ–­å¼‚å¸¸ if (Thread.interrupted()) throw new InterruptedException(); //å°äº0 çš„æƒ…å†µæœ‰ä¸¤ç§ï¼š //é”æ²¡æœ‰è¢«æŒæœ‰ æˆ–è€… æŒæœ‰é”çš„çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ //å½“å‰å‰©ä¸‹çš„è¯ä¹¦ä¸è¶³ä»¥æ”¯æŒå½“å‰çº¿ç¨‹æœ¬æ¬¡è·å– if (tryAcquireShared(arg) &lt; 0) doAcquireSharedInterruptibly(arg);&#125; 4.Semaphore.FairSync.tryAcquireShared123456789101112131415161718protected int tryAcquireShared(int acquires) &#123; for (;;) &#123; // å½“å‰é˜Ÿåˆ—è¿˜æœ‰å…ƒç´ ï¼Œå¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ç©ºèŠ‚ç‚¹&amp;&amp;å½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ if (hasQueuedPredecessors()) //è¿”å›-1 return -1; //è·å–å½“å‰æœ€æ–°çš„stateå€¼ int available = getState(); //ç”¨state-ä¼ å…¥çš„å€¼ int remaining = available - acquires; //æ¡ä»¶1æˆç«‹ ï¼šå½“å‰å‰©ä¸‹çš„è¯ä¹¦ä¸è¶³ä»¥æ”¯æŒå½“å‰çº¿ç¨‹è·å– //æ¡ä»¶2æˆç«‹ï¼šå‰ç½®æ¡ä»¶ï¼šå½“å‰å‰©ä¸‹çš„è¯ä¹¦è¶³å¤Ÿæ”¯æŒå½“å‰çº¿ç¨‹æŒæœ‰ã€‚ //å¦‚æœcaså»è®¾ç½®æ–°çš„stateæˆåŠŸï¼Œè¿”å› if (remaining &lt; 0 || compareAndSetState(available, remaining)) return remaining; &#125;&#125; 5.AQS.hasQueuedPredecessorsåˆ¤æ–­å½“å‰AQSé˜»å¡é˜Ÿåˆ—é‡Œé¢æ˜¯å¦æœ‰ç­‰å¾…çš„çº¿ç¨‹ 123456789101112131415public final boolean hasQueuedPredecessors() &#123; Node t = tail; // Read fields in reverse initialization order Node h = head; Node s; /* 1.h!=t:å¤´èŠ‚ç‚¹ä¸ç­‰äºå°¾ç»“ç‚¹ï¼Œè¯´æ˜å½“å‰é˜Ÿåˆ—è¿˜æœ‰å…ƒç´  2.å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ç©º || å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ç©ºèŠ‚ç‚¹&amp;&amp;å½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ æ€»ç»“ä¸€ä¸‹ï¼šå¦‚æœè¿”å›trueï¼š å½“å‰é˜Ÿåˆ—è¿˜æœ‰å…ƒç´ ï¼Œå¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ç©ºèŠ‚ç‚¹&amp;&amp;å½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ */ return h != t &amp;&amp; ((s = h.next) == null || s.thread != Thread.currentThread());&#125; 6.AQS.doAcquireSharedInterruptibly123456789101112131415161718192021222324252627282930313233private void doAcquireSharedInterruptibly(int arg) throws InterruptedException &#123; //å°†å½“å‰çº¿ç¨‹æ„å»ºæˆä¸€ä¸ªå…±äº«èŠ‚ç‚¹å…¥é˜Ÿ final Node node = addWaiter(Node.SHARED); boolean failed = true; try &#123; for (;;) &#123; //è·å–å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ final Node p = node.predecessor(); //å¦‚æœå‰ç½®èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ if (p == head) &#123; //å°è¯•å»è·å–é” int r = tryAcquireShared(arg); //å¤§äº0è¯´æ˜æˆåŠŸæ‹¿åˆ°äº†é” if (r &gt;= 0) &#123; //è®¾ç½®å¤´èŠ‚ç‚¹å¹¶å‘åä¼ æ’­å”¤é†’ setHeadAndPropagate(node, r); //åŸå¤´èŠ‚ç‚¹å‡ºé˜Ÿ p.next = null; // help GC failed = false; return; &#125; &#125; //å¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œç»™å½“å‰çº¿ç¨‹æ‰¾ä¸€ä¸ªå¥½çˆ¸çˆ¸ if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) throw new InterruptedException(); &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125; 7.AQS.setHeadAndPropagate1234567891011121314private void setHeadAndPropagate(Node node, int propagate) &#123; Node h = head; // Record old head for check below //è®¾ç½®nodeä¸ºå¤´èŠ‚ç‚¹ setHead(node); if (propagate &gt; 0 || h == null || h.waitStatus &lt; 0 || (h = head) == null || h.waitStatus &lt; 0) &#123; Node s = node.next; //å¦‚æœå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©º || å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©ºä¸”å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å…±äº«èŠ‚ç‚¹ if (s == null || s.isShared()) //æ‰§è¡Œå‘åå”¤é†’é€»è¾‘ doReleaseShared(); &#125;&#125; 8.release123public void release() &#123; sync.releaseShared(1);&#125; 9.releaseShared123456789public final boolean releaseShared(int arg) &#123; //å¦‚æœå°è¯•é‡Šæ”¾é”æˆåŠŸ if (tryReleaseShared(arg)) &#123; //æ‰§è¡Œå‘åå”¤é†’é€»è¾‘ doReleaseShared(); return true; &#125; return false;&#125; 10.tryReleaseShared12345678910111213protected final boolean tryReleaseShared(int releases) &#123; for (;;) &#123; //è·å–å½“å‰æœ€æ–°çš„state int current = getState(); //å°†å½“å‰çš„state å’Œé‡Šæ”¾çš„è®¸å¯è¯ä¸ªæ•°ç›¸åŠ  int next = current + releases; if (next &lt; current) // overflow throw new Error(&quot;Maximum permit count exceeded&quot;); //casæˆåŠŸ è¿”å›true if (compareAndSetState(current, next)) return true; &#125;&#125; 11.doReleaseShared1234567891011121314151617181920212223242526272829private void doReleaseShared() &#123; for (;;) &#123; //è·å–å¤´èŠ‚ç‚¹ Node h = head; //å¤´èŠ‚ç‚¹ä¸ä¸ºç©º &amp;&amp; å¤´èŠ‚ç‚¹ä¸æ˜¯å°¾ç»“ç‚¹ if (h != null &amp;&amp; h != tail) &#123; int ws = h.waitStatus; //å¦‚æœå¤´ç»“ç‚¹çš„ç­‰å¾…çŠ¶æ€ æ˜¯ -1 if (ws == Node.SIGNAL) &#123; //å¦‚æœcas è®¾ç½®å¤´èŠ‚ç‚¹ -1 ï¼Œ 0 å¤±è´¥ //ä¸ºå•¥ä¼šå¤±è´¥ï¼Ÿå…¶ä»–çº¿ç¨‹è·å–åˆ°é”ä»¥åæ‰§è¡Œå‘åå”¤é†’é€»è¾‘äº† if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0)) continue; // å”¤é†’èŠ‚ç‚¹çš„çº¿ç¨‹ unparkSuccessor(h); &#125; //å¦‚æœç­‰å¾…çŠ¶æ€ ==0 ä¸”cas è®¾ç½® å¤´èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ä¸ºå‘åä¼ æ’­å¤±è´¥ else if (ws == 0 &amp;&amp; !compareAndSetWaitStatus(h, 0, Node.PROPAGATE)) continue; // loop on failed CAS &#125; //å¦‚æœå¤´èŠ‚ç‚¹æ²¡å˜ ä¹Ÿå°±æ˜¯è¯´ ï¼Œå”¤é†’çš„åé¢çš„èŠ‚ç‚¹ è¿˜æ²¡æ¥å¾—åŠå°†è‡ªå·±è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ ï¼Œè·³å‡ºå¾ªç¯ ã€‚ //ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥è·³å‡ºï¼Ÿä¸æ€•å‘åå”¤é†’ä¸­æ–­ä¹ˆï¼Ÿ ä¸æ€• ï¼Œé¦–å…ˆ ï¼Œæç«¯æƒ…å†µå·²ç»éƒ½åˆ¤æ–­å®Œäº† if (h == head) // loop if head changed break; &#125;&#125;","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"CountDownLatch","slug":"JUC/CountDownLatch","date":"2022-01-11T11:07:22.214Z","updated":"2022-01-11T11:27:37.985Z","comments":true,"path":"2022/01/11/JUC/CountDownLatch/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/CountDownLatch/","excerpt":"","text":"ä¸€ï¼Œæºç â€‹ å¯¹äº CountDownLatchï¼Œæˆ‘ä»¬ä»…ä»…éœ€è¦å…³å¿ƒä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ countDown() æ–¹æ³•ï¼Œå¦ä¸€ä¸ªæ˜¯ await() æ–¹æ³•ã€‚countDown() æ–¹æ³•æ¯æ¬¡è°ƒç”¨éƒ½ä¼šå°† state å‡ 1ï¼Œç›´åˆ°state çš„å€¼ä¸º 0ï¼›è€Œ await æ˜¯ä¸€ä¸ªé˜»å¡æ–¹æ³•ï¼Œå½“ state å‡ä¸º 0 çš„æ—¶å€™ï¼Œawait æ–¹æ³•æ‰ä¼šè¿”å›ã€‚await å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨ï¼Œæ‰€æœ‰è°ƒç”¨äº†await æ–¹æ³•çš„çº¿ç¨‹é˜»å¡åœ¨ AQS çš„é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æ¡ä»¶æ»¡è¶³ï¼ˆstate == 0ï¼‰ï¼Œå°†çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­ä¸€ä¸ªä¸ªå”¤é†’è¿‡æ¥ã€‚ 1.å†…éƒ¨ç±»12345678910111213141516171819202122232425262728293031private static final class Sync extends AbstractQueuedSynchronizer &#123; private static final long serialVersionUID = 4982264981922014374L; //CountDownLatchä¸­çš„è®¡æ•°å…¶å®å°±æ˜¯AQSçš„state Sync(int count) &#123; setState(count); &#125; int getCount() &#123; return getState(); &#125; protected int tryAcquireShared(int acquires) &#123; //å¦‚æœstate =0 è¿”å›1 å¦åˆ™è¿”å› 0 return (getState() == 0) ? 1 : -1; &#125; protected boolean tryReleaseShared(int releases) &#123; for (;;) &#123; //è·å–æœ€æ–°çš„state int c = getState(); //å¦‚æœstate==0 è¿”å›false if (c == 0) return false; int nextc = c-1; //å¦‚æœcasæˆåŠŸï¼Œä¸”c=1ï¼Œè¿”å›true if (compareAndSetState(c, nextc)) return nextc == 0; &#125; &#125;&#125; 2.æ„é€ å‡½æ•°123456789private final Sync sync;//æ„é€ å‡½æ•°public CountDownLatch(int count) &#123; //è¾¹ç•Œå€¼åˆ¤æ–­ if (count &lt; 0) throw new IllegalArgumentException(&quot;count &lt; 0&quot;); //åˆå§‹åŒ–Sync this.sync = new Sync(count);&#125; 3.awaitä½¿å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œç›´åˆ°è®¡æ•°å™¨å‡ä¸º0æˆ–è€…å½“å‰çº¿ç¨‹è¢«ä¸­æ–­ã€‚ 1234public void await() throws InterruptedException &#123; //æ‰§è¡Œaqs.acquireSharedInterruptibly() sync.acquireSharedInterruptibly(1);&#125; 4.AQS.acquireSharedInterruptiblycountdownlatch ä¹Ÿç”¨åˆ°äº† AQSï¼Œåœ¨ CountDownLatch å†…éƒ¨å†™äº†ä¸€ä¸ª Sync å¹¶ä¸”ç»§æ‰¿äº†AQS è¿™ä¸ªæŠ½è±¡ç±»é‡å†™äº† AQSä¸­çš„å…±äº«é”æ–¹æ³•ã€‚é¦–å…ˆçœ‹åˆ°ä¸‹é¢è¿™ä¸ªä»£ç ï¼Œè¿™å—ä»£ç ä¸»è¦æ˜¯ åˆ¤ æ–­ å½“ å‰ çº¿ ç¨‹ æ˜¯ å¦ è· å– åˆ° äº† å…± äº« é” ; ï¼ˆ åœ¨CountDownLatch ä¸­ ï¼Œ ä½¿ ç”¨ çš„æ˜¯ å…± äº« é” æœº åˆ¶ ï¼Œ å›  ä¸ºCountDownLatch å¹¶ä¸éœ€è¦å®ç°äº’æ–¥çš„ç‰¹æ€§ï¼‰ã€‚ 12345678910public final void acquireSharedInterruptibly(long arg) throws InterruptedException &#123; //å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼ŒæŠ›å‡ºä¸­æ–­å¼‚å¸¸ if (Thread.interrupted()) throw new InterruptedException(); //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ­¤æ—¶state&gt;0å°†çº¿ç¨‹å…¥é˜Ÿï¼Œç„¶åç­‰å¾…å”¤é†’ //æ¡ä»¶ä¸æˆç«‹ï¼šè¯´æ˜æ­¤æ—¶state=0ï¼Œè¯´æ˜æ­¤æ—¶é˜»å¡å·²ç»æ”¾å¼€ï¼Œå½“å‰çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ if (tryAcquireShared(arg) &lt; 0) //å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°å…±äº«é”é˜Ÿåˆ— doAcquireSharedInterruptibly(arg);&#125; 5.tryAcquireSharedåˆ¤æ–­stateçŠ¶æ€. 1234protected int tryAcquireShared(int acquires) &#123; //å¦‚æœstate =0 è¿”å›1 å¦åˆ™è¿”å› 0 return (getState() == 0) ? 1 : -1;&#125; 6.AQS.doAcquireSharedInterruptibly addWaiter è®¾ç½®ä¸º shared æ¨¡å¼ã€‚ â€‹ tryAcquire å’Œ tryAcquireShared çš„è¿”å›å€¼ä¸åŒï¼Œå› æ­¤ä¼šå¤šå‡ºä¸€ä¸ªåˆ¤æ–­è¿‡ç¨‹ã€‚ â€‹ åœ¨ åˆ¤ æ–­ å‰ é©± èŠ‚ ç‚¹ æ˜¯ å¤´ èŠ‚ ç‚¹ å ï¼Œ è°ƒ ç”¨ äº†setHeadAndPropagate æ–¹æ³•ï¼Œè€Œä¸æ˜¯ç®€å•çš„æ›´æ–°ä¸€ä¸‹å¤´èŠ‚ç‚¹ã€‚ â€‹ 123456789101112131415161718192021222324252627282930313233343536private void doAcquireSharedInterruptibly(long arg) throws InterruptedException &#123; //å°†å½“å‰çº¿ç¨‹å°è£…æˆèŠ‚ç‚¹å…¥é˜Ÿï¼Œå…±äº«èŠ‚ç‚¹ï¼Œä½¿ç”¨çš„æ˜¯stateçš„é«˜16ä½è¿ç®— final Node node = addWaiter(Node.SHARED); boolean failed = true; try &#123; //è‡ªæ—‹ for (;;) &#123; //è·å–å½“å‰èŠ‚ç‚¹çš„å‰é©± final Node p = node.predecessor(); //å¦‚æœå‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ if (p == head) &#123; //å½“å‰èŠ‚ç‚¹å°±å¯ä»¥å°è¯•å»æŠ¢é” long r = tryAcquireShared(arg); //æ­¤æ—¶è¯´æ˜æŠ¢åˆ°é”äº† if (r &gt;= 0) &#123; //ä¿®æ”¹å¤´èŠ‚ç‚¹çš„å€¼ setHeadAndPropagate(node, r); //å¤´èŠ‚ç‚¹å‡ºé˜Ÿ p.next = null; // help GC //ä»£è¡¨æŠ¢é”æˆåŠŸ failed = false; return; &#125; &#125; //å¦åˆ™çš„è¯ï¼Œçº¿ç¨‹åœ¨è¿™é‡Œparkï¼Œå¦‚æœçº¿ç¨‹ä¸­æ–­ä¿¡å·=trueï¼Œå°±ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) throw new InterruptedException(); &#125; &#125; finally &#123; //å¦‚æœæŠ¢é”å¤±è´¥äº†ï¼Œå°±èµ°å–æ¶ˆç«äº‰é”çš„é€»è¾‘ if (failed) cancelAcquire(node); &#125;&#125; å‡å¦‚è¿™ä¸ªæ—¶å€™æœ‰ 3 ä¸ªçº¿ç¨‹è°ƒç”¨äº† await æ–¹æ³•ï¼Œç”±äºè¿™ä¸ªæ—¶å€™ state çš„å€¼è¿˜ä¸ä¸º 0ï¼Œæ‰€ä»¥è¿™ä¸‰ä¸ªçº¿ç¨‹éƒ½ä¼šåŠ å…¥åˆ° AQSé˜Ÿåˆ—ä¸­ã€‚å¹¶ä¸”ä¸‰ä¸ªçº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ã€‚ 7.countDowné€’å‡é”è®¡æ•°ï¼Œå¦‚æœé”è®¡æ•°ä¸º0ï¼Œé‡Šæ”¾æ‰€æœ‰é˜»å¡çº¿ç¨‹ã€‚ 123public void countDown() &#123; sync.releaseShared(1);&#125; 8.AQS.releaseSharedç”±äºçº¿ç¨‹è¢« await æ–¹æ³•é˜»å¡äº†ï¼Œæ‰€ä»¥åªæœ‰ç­‰åˆ°countdown æ–¹æ³•ä½¿å¾— state=0 çš„æ—¶å€™æ‰ä¼šè¢«å”¤é†’ã€‚ åªæœ‰å½“ state å‡ä¸º 0 çš„æ—¶å€™ï¼ŒtryReleaseShared æ‰è¿”å› true, å¦åˆ™åªæ˜¯ç®€å•çš„ state = state - 1ã€‚ â€‹ å¦‚æœ state=0, åˆ™è°ƒç”¨ doReleaseSharedå”¤é†’å¤„äº await çŠ¶æ€ä¸‹çš„çº¿ç¨‹ã€‚ â€‹ 12345678910public final boolean releaseShared(int arg) &#123; //æ‰§è¡Œå­ç±»é‡å†™çš„æ–¹æ³•ï¼Œstate=0çš„æ—¶å€™ï¼Œæ‰§è¡ŒdoReleaseShared //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰è°ƒç”¨latch.countDown()æ–¹æ³•çš„çº¿ç¨‹ï¼Œæ­£å¥½æ˜¯state-1 == 0 çš„è¿™ä¸ªçº¿ç¨‹ï¼Œéœ€è¦åšè§¦å‘å”¤é†’awaitçŠ¶æ€çš„çº¿ç¨‹ã€‚ if (tryReleaseShared(arg)) &#123; //è°ƒç”¨countDown()æ–¹æ³•çš„çº¿ç¨‹ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè¿›å…¥åˆ°è¿™ä¸ªifå—é‡Œé¢ï¼Œæ‰§è¡Œä¸‹é¢çš„æ–¹æ³• doReleaseShared(); return true; &#125; return false;&#125; 9.tryReleaseSharedè‡ªæ—‹é‡Šæ”¾é”ï¼Œé‡Šæ”¾å®Œäº†è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚ 12345678910111213protected boolean tryReleaseShared(int releases) &#123; for (;;) &#123; //è·å–æœ€æ–°çš„state int c = getState(); //å¦‚æœstate==0 è¿”å›false if (c == 0) return false; int nextc = c-1; //å¦‚æœcasæˆåŠŸï¼Œä¸”c=1ï¼Œè¿”å›true if (compareAndSetState(c, nextc)) return nextc == 0; &#125;&#125; 10.AQS.doReleaseSharedå…±äº«é”çš„é‡Šæ”¾å’Œç‹¬å é”çš„é‡Šæ”¾æœ‰ä¸€å®šçš„å·®åˆ«â€‹ å‰é¢å”¤é†’é”çš„é€»è¾‘å’Œç‹¬å é”æ˜¯ä¸€æ ·ï¼Œå…ˆåˆ¤æ–­å¤´ç»“ç‚¹æ˜¯ä¸æ˜¯SIGNAL çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¿®æ”¹ä¸º 0ï¼Œå¹¶ä¸”å”¤é†’å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚â€‹ PROPAGATE ï¼š æ ‡è¯†ä¸º PROPAGATE çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œæ˜¯å…±äº«é”æ¨¡å¼ä¸‹çš„èŠ‚ç‚¹çŠ¶æ€ï¼Œå¤„äºè¿™ä¸ªçŠ¶æ€ä¸‹çš„èŠ‚ç‚¹ï¼Œä¼šå¯¹çº¿ç¨‹çš„å”¤é†’è¿›è¡Œä¼ æ’­ 123456789101112131415161718192021222324252627282930313233343536373839404142434445private void doReleaseShared() &#123; //è‡ªæ—‹ for (;;) &#123; //è·å–å¤´èŠ‚ç‚¹çš„å¼•ç”¨ Node h = head; //å¦‚æœå¤´èŠ‚ç‚¹ä¸ä¸ºç©º &amp;&amp; å¤´èŠ‚ç‚¹ä¸ç­‰äºå°¾ç»“ç‚¹ //æ¡ä»¶ä¸€æˆç«‹ï¼šè¯´æ˜é˜»å¡é˜Ÿåˆ—ä¸ä¸ºç©º //ä»€ä¹ˆæ—¶å€™ä¸æˆç«‹ï¼Ÿlatchåˆ›å»ºå‡ºæ¥ä»¥åï¼Œæ²¡æœ‰ä»»ä½•çº¿ç¨‹è°ƒç”¨è¿‡awaitæ–¹æ³•ä¹‹å‰ï¼Œå°±æœ‰çº¿ç¨‹è°ƒç”¨countDownæ“ä½œï¼Œå¹¶ä¸”è§¦å‘äº†å”¤é†’é˜»å¡èŠ‚ç‚¹çš„é€»è¾‘ //æ¡ä»¶äºŒæˆç«‹ï¼šè¯´æ˜å½“å‰é˜Ÿåˆ—é™¤äº†å¤´èŠ‚ç‚¹è¿˜æœ‰å…¶ä»–èŠ‚ç‚¹ //ä»€ä¹ˆæ—¶å€™ä¸æˆç«‹ï¼Ÿ //1.æ­£å¸¸å”¤é†’æƒ…å†µï¼šä¾æ¬¡è·å–å…±äº«é”ï¼Œå½“å‰çº¿ç¨‹æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™æ˜¯tailèŠ‚ç‚¹ //2.ç¬¬ä¸€ä¸ªè°ƒç”¨awaitçš„çº¿ç¨‹ä¸è°ƒç”¨countDownçš„çº¿ç¨‹å¹¶å‘äº† if (h != null &amp;&amp; h != tail) &#123; int ws = h.waitStatus; //å¦‚æœå¤´ç»“ç‚¹çš„è½¬æ€=-1 if (ws == Node.SIGNAL) &#123; //casè®¾ç½®å¤´èŠ‚ç‚¹çš„çŠ¶æ€å¤±è´¥ if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0)) continue; //casæˆåŠŸï¼Œå”¤é†’å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unparkSuccessor(h); &#125; //caså¤±è´¥èµ°åˆ°è¿™é‡Œï¼Œ //æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œåˆšå¥½æœ‰ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿï¼Œå…¥é˜Ÿä¼šå°†è¿™ä¸ª ws è®¾ç½®ä¸º -1 else if (ws == 0 &amp;&amp; !compareAndSetWaitStatus(h, 0, Node.PROPAGATE)) continue; &#125; /* æ¡ä»¶æˆç«‹ï¼š 1.è¯´æ˜åˆšåˆšå”¤é†’çš„åç»§èŠ‚ç‚¹ï¼Œè¿˜æ²¡å°†è‡ªå·±è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼Œæ²¡æ‰§è¡Œåˆ°å‘¢.... è¿™ä¸ªæ—¶å€™ï¼Œå½“å‰çº¿ç¨‹ç›´æ¥è·³å‡ºå»ç»“æŸäº† æ­¤æ—¶å¹¶ä¸éœ€è¦æ‹…å¿ƒ å”¤é†’é€»è¾‘ åœ¨è¿™é‡Œæ–­å¼€ ï¼Œå› ä¸ºè¢«å”¤é†’çš„çº¿ç¨‹ï¼Œæ—©æ™šä¼šæ‰§è¡Œåˆ°doReleaseSharedæ–¹æ³• 2.head==null latchåˆ›å»ºå‡ºæ¥ä»¥åï¼Œæ²¡æœ‰ä»»ä½•çº¿ç¨‹è°ƒç”¨è¿‡awaitæ–¹æ³•ä¹‹å‰ï¼Œå°±æœ‰çº¿ç¨‹è°ƒç”¨countDownæ“ä½œï¼Œå¹¶ä¸”è§¦å‘äº†å”¤é†’é˜»å¡èŠ‚ç‚¹çš„é€»è¾‘ 3.h==tail break æ¡ä»¶ä¸æˆç«‹ï¼š æ¡ä»¶æˆç«‹1çš„ç›¸åæƒ…å†µï¼Œæ­¤æ—¶å”¤é†’ä»–çš„èŠ‚ç‚¹ æ‰§è¡Œ h == head ä¸æˆç«‹ï¼Œæ­¤æ—¶ åŸå¤´èŠ‚ç‚¹ä¸ä¼šè·³å‡ºï¼Œä¼šç»§ç»­å”¤é†’æ–°çš„å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚ */ if (h == head) break; &#125;&#125; 11.AQS.doAcquireSharedInterruptiblyä¸€æ—¦ ThreadA è¢«å”¤é†’ï¼Œä»£ç åˆä¼šç»§ç»­å›åˆ°doAcquireSharedInterruptibly ä¸­æ¥æ‰§è¡Œã€‚å¦‚æœå½“å‰ stateæ»¡è¶³=0 çš„æ¡ä»¶ï¼Œåˆ™ä¼šæ‰§è¡Œ setHeadAndPropagate æ–¹æ³•ã€‚ 123456789101112131415161718192021222324252627private void doAcquireSharedInterruptibly(int arg) throws InterruptedException &#123; final Node node = addWaiter(Node.SHARED); //åˆ›å»ºä¸€ä¸ªå…±äº«æ¨¡å¼çš„èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ boolean failed = true; try &#123; for (;;) &#123;//è¢«å”¤é†’çš„çº¿ç¨‹è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ç»§ç»­åˆ¤æ–­ final Node p = node.predecessor(); if (p == head) &#123; int r = tryAcquireShared(arg);//å°±åˆ¤æ–­å°è¯•è·å–é” if (r &gt;= 0) &#123;//r&gt;=0 è¡¨ç¤ºè·å–åˆ°äº†æ‰§è¡Œæƒé™ï¼Œè¿™ä¸ªæ—¶å€™å› ä¸º state!=0ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œè¿™æ®µä»£ç  setHeadAndPropagate(node, r); p.next = null; // help GC æŠŠå½“å‰èŠ‚ç‚¹ç§»é™¤ aqs é˜Ÿåˆ— failed = false; return; &#125; &#125; //é˜»å¡çº¿ç¨‹ if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) throw new InterruptedException(); &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125; 12.setHeadAndPropagateè¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯æŠŠè¢«å”¤é†’çš„èŠ‚ç‚¹ï¼Œè®¾ç½®æˆ head èŠ‚ç‚¹ã€‚ ç„¶åç»§ç»­å”¤é†’é˜Ÿåˆ—ä¸­çš„å…¶ä»–çº¿ç¨‹ã€‚ç”±äºç°åœ¨é˜Ÿåˆ—ä¸­æœ‰ 3 ä¸ªçº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸€æ—¦ ThreadAè¢«å”¤é†’ï¼Œå¹¶ä¸”è®¾ç½®ä¸º head ä¹‹åï¼Œä¼šç»§ç»­å”¤é†’åç»­çš„ThreadBã€‚â€‹ 123456789101112131415private void setHeadAndPropagate(Node node, int propagate) &#123; Node h = head; // Record old head for check below //å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ setHead(node); //1&gt;0 if (propagate &gt; 0 || h == null || h.waitStatus &lt; 0 || (h = head) == null || h.waitStatus &lt; 0) &#123; Node s = node.next; //æ¡ä»¶ä¸€ï¼šs==null ä»€ä¹ˆæ—¶å€™æˆç«‹å‘¢ï¼Ÿ å½“å‰nodeèŠ‚ç‚¹å·²ç»æ˜¯tailèŠ‚ç‚¹äº†ï¼Œ //æ¡ä»¶äºŒçš„å‰ç½®æ¡ä»¶ï¼šs!=null è¦æ±‚sçš„æ¨¡å¼æ˜¯å…±äº«æ¨¡å¼ if (s == null || s.isShared()) //ç»§ç»­å‘åå”¤é†’ doReleaseShared(); &#125;&#125; 13.æµç¨‹å›¾ äºŒï¼Œä½¿ç”¨countdownlatch æ˜¯ä¸€ä¸ªåŒæ­¥å·¥å…·ç±»ï¼Œå®ƒå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹çš„æ“ä½œæ‰§è¡Œå®Œæ¯•å†æ‰§è¡Œã€‚ä»å‘½åå¯ä»¥è§£è¯»åˆ° countdown æ˜¯å€’æ•°çš„æ„æ€ï¼Œç±»ä¼¼äºå€’è®¡æ—¶çš„æ¦‚å¿µã€‚â€‹ countdownlatch æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ countDownï¼Œä¸€ä¸ªæ˜¯ awaitï¼Œ countdownlatch åˆå§‹åŒ–çš„æ—¶å€™éœ€è¦ä¼ å…¥ä¸€ä¸ªæ•´æ•°ï¼Œåœ¨è¿™ä¸ªæ•´æ•°å€’æ•°åˆ° 0 ä¹‹å‰ï¼Œè°ƒç”¨äº† await æ–¹æ³•çš„ç¨‹åºéƒ½å¿…é¡»è¦ç­‰å¾…ï¼Œç„¶åé€šè¿‡ countDown æ¥å€’æ•°ã€‚â€‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687/** * @author äºŒå * @since 2021/9/6 2:00 ä¸‹åˆ */public class DemoA &#123; private static CountDownLatch c = new CountDownLatch(6); private static ThreadPoolExecutor executor = new ThreadPoolExecutor( 6, 6, 1, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(1), new MyDefaultFactory(), new ThreadPoolExecutor.AbortPolicy() ); public static void main(String[] args)throws Exception &#123; for (int i = 0; i &lt; 6; i++) executor.submit(()-&gt;&#123; System.out.println(Thread.currentThread().getName() + &quot;å›½è¢«ç­ï¼&quot;); c.countDown(); &#125;); c.await(); if (Thread.currentThread().getName().equals(&quot;main&quot;)) System.out.println(&quot;mainçº¿ç¨‹æ‰§è¡Œç»“æŸ:&quot; + Thread.currentThread().getName() ); &#125; private static class MyDefaultFactory implements ThreadFactory&#123; private static Queue&lt;String&gt; queue = new LinkedList(); static &#123; for (int i = 1; i &lt;= 6; i++) queue.add(Objects.requireNonNull(Message.foreach_CountryEnum(i)).message); &#125; @Override public Thread newThread(Runnable r) &#123; return new Thread(r,&quot;thread-&quot;+queue.poll() +&quot;-er_shi&quot;); &#125; &#125; enum Message &#123; ONE(1, &quot;é½&quot;), TWO(2, &quot;æ¥š&quot;), THREE(3, &quot;ç‡•&quot;), FOUR(4, &quot;èµµ&quot;), FIVE(5, &quot;é­&quot;), SIX(6, &quot;éŸ©&quot;); private int code; private String message; Message(int code, String message) &#123; this.code = code; this.message = message; &#125; public int getCode() &#123; return code; &#125; public void setCode(int code) &#123; this.code = code; &#125; public String getMessage() &#123; return message; &#125; public void setMessage(String message) &#123; this.message = message; &#125; public static Message foreach_CountryEnum(int index) &#123; Message[] countryEnums = Message.values(); for (Message countryEnum : countryEnums) &#123; if (countryEnum.getCode() == index) &#123; return countryEnum; &#125; &#125; return null; &#125; &#125;&#125;","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"ReentrantReadWriteLock","slug":"JUC/ReentrantReadWriteLock","date":"2022-01-11T11:06:57.592Z","updated":"2022-01-11T11:29:11.743Z","comments":true,"path":"2022/01/11/JUC/ReentrantReadWriteLock/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/ReentrantReadWriteLock/","excerpt":"","text":"è¯»å†™é”ï¼šè¯»é”å’Œå†™é”éƒ½ä¼šå‘ç”Ÿæ­»é”ã€‚è¯»å’Œè¯»ä¹‹é—´å…è®¸å…±äº« ï¼Œè¯»å’Œå†™ä¹‹é—´ç‹¬å ï¼Œå†™å’Œå†™ä¹‹é—´ç‹¬å ã€‚â€‹ ä¸€ï¼Œè¯»å†™é”çš„ä½¿ç”¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public class Demo7 &#123; public static void main(String[] args)throws Exception &#123; MyCache myCache=new MyCache(); for (int i = 1; i &lt;=5; i++) &#123; int num = i ; new Thread(()-&gt;&#123; myCache.put(String.valueOf(num),String.valueOf(num)); &#125;,String.valueOf(i)).start(); &#125; TimeUnit.SECONDS.sleep(3); for (int i = 1; i &lt;=5; i++) &#123; int num = i ; new Thread(()-&gt;&#123; myCache.get(String.valueOf(num)); &#125;,String.valueOf(i)).start(); &#125; &#125;&#125;class MyCache&#123; //volatile:è¡¨ç¤ºç»å¸¸å˜åŒ–çš„ private volatile Map&lt;String,Object&gt; map=new HashMap&lt;&gt;(); private ReadWriteLock lock=new ReentrantReadWriteLock(); public void put(String key,Object val)&#123; try &#123; lock.writeLock().lock(); System.out.println(Thread.currentThread().getName()+&quot;\\t å¼€å§‹å†™å…¥æ•°æ®&quot;+key+&quot;!!!!!!!!!&quot;); TimeUnit.SECONDS.sleep(1); map.put(key,val); System.out.println(Thread.currentThread().getName()+&quot;\\t å®Œæˆå†™å…¥æ•°æ®&quot;+key+&quot;----------&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;finally &#123; lock.writeLock().unlock(); &#125; &#125; public void get(String key)&#123; try &#123; lock.readLock().lock(); System.out.println(Thread.currentThread().getName()+&quot;\\t å¼€å§‹è¯»å–æ•°æ®&quot;+key+&quot;!!!!!!!!!&quot;); TimeUnit.SECONDS.sleep(1); Object result = map.get(key); System.out.println(Thread.currentThread().getName()+&quot;\\t å®Œæˆè¯»å–æ•°æ®&quot;+result+&quot;----------&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;finally &#123; lock.readLock().unlock(); &#125; &#125;&#125; äºŒï¼Œè¯»å†™é”çš„åŸç†è¯»å†™é”ç”¨çš„æ˜¯åŒä¸€ä¸ª Sycn åŒæ­¥å™¨ï¼Œå› æ­¤ç­‰å¾…é˜Ÿåˆ—ã€state ç­‰ä¹Ÿæ˜¯åŒä¸€ä¸ªã€‚â€‹ 1.çº¿ç¨‹1å†™é”åŠ é”çº¿ç¨‹1æˆåŠŸä¸Šé”ï¼Œæµç¨‹ä¸ReentrantLockåŠ é”ç›¸æ¯”æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„ï¼Œä¸åŒçš„æ˜¯å†™é”çŠ¶æ€å äº†stateçš„ä½16ä½ï¼Œè€Œè¯»é”ä½¿ç”¨çš„æ˜¯stateçš„é«˜16ä½ã€‚â€‹ 2.çº¿ç¨‹2è¯»é”åŠ é”t2 æ‰§è¡Œ r.lockï¼Œè¿™æ—¶è¿›å…¥è¯»é”çš„ sync.acquireShared(1) æµç¨‹ï¼Œé¦–å…ˆä¼šè¿›å…¥ tryAcquireShared æµç¨‹ã€‚å¦‚æœæœ‰å†™é”å æ®ï¼Œé‚£ä¹ˆ tryAcquireShared è¿”å› -1 è¡¨ç¤ºå¤±è´¥ã€‚â€‹ tryAcquireShared è¿”å›å€¼è¡¨ç¤º: -1 è¡¨ç¤ºå¤±è´¥ 0 è¡¨ç¤ºæˆåŠŸï¼Œä½†åç»§èŠ‚ç‚¹ä¸ä¼šç»§ç»­å”¤é†’ æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œè€Œä¸”æ•°å€¼æ˜¯è¿˜æœ‰å‡ ä¸ªåç»§èŠ‚ç‚¹éœ€è¦å”¤é†’ï¼Œè¯»å†™é”è¿”å› 1ã€‚ â€‹ è¿™æ—¶ä¼šè¿›å…¥ sync.doAcquireShared(1) æµç¨‹ï¼Œé¦–å…ˆä¹Ÿæ˜¯è°ƒç”¨ addWaiter æ·»åŠ èŠ‚ç‚¹ã€‚â€‹ t2 ä¼šçœ‹çœ‹è‡ªå·±çš„èŠ‚ç‚¹æ˜¯ä¸æ˜¯è€äºŒï¼Œå¦‚æœæ˜¯ï¼Œè¿˜ä¼šå†æ¬¡è°ƒç”¨ tryAcquireShared(1) æ¥å°è¯•è·å–é”ã€‚â€‹ å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œåœ¨ doAcquireShared å†… for (; ; ) å¾ªç¯ä¸€æ¬¡ï¼ŒæŠŠå‰é©±èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º -1ï¼Œå† for (;; ) å¾ªç¯ä¸€æ¬¡å°è¯• tryAcquireShared(1) å¦‚æœè¿˜ä¸æˆåŠŸï¼Œé‚£ä¹ˆåœ¨ parkAndCheckInterrupt() å¤„ parkã€‚â€‹ 3.çº¿ç¨‹3è¯»é”åŠ é”ï¼Œçº¿ç¨‹4å†™é”åŠ é”è¿™ç§çŠ¶æ€ä¸‹ï¼Œå‡è®¾åˆæœ‰ t3 åŠ è¯»é”å’Œ t4 åŠ å†™é”ï¼Œè¿™æœŸé—´ t1 ä»ç„¶æŒæœ‰é”ï¼Œå°±å˜æˆäº†ä¸‹é¢çš„æ ·å­ã€‚â€‹ 4.çº¿ç¨‹1å†™é”é‡Šæ”¾é”è¿™æ—¶ä¼šèµ°åˆ°å†™é”çš„ sync.release(1) æµç¨‹ï¼Œè°ƒç”¨ sync.tryRelease(1) æˆåŠŸï¼Œå˜æˆä¸‹é¢çš„æ ·å­â€‹ æ¥ä¸‹æ¥æ‰§è¡Œå”¤é†’æµç¨‹ sync.unparkSuccessorï¼Œå³è®©è€äºŒæ¢å¤è¿è¡Œï¼Œè¿™æ—¶ t2 åœ¨ doAcquireShared å†…parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œã€‚â€‹ è¿™å›å†æ¥ä¸€æ¬¡ for (;;) æ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€ã€‚â€‹ è¿™æ—¶ t2 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t2 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹ã€‚â€‹ äº‹æƒ…è¿˜æ²¡å®Œï¼Œåœ¨ setHeadAndPropagate æ–¹æ³•å†…è¿˜ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ sharedï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨doReleaseShared() å°† head çš„çŠ¶æ€ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œè¿™æ—¶ t3 åœ¨ doAcquireShared å†…parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œã€‚â€‹ è¿™å›å†æ¥ä¸€æ¬¡ for (;;) æ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€ã€‚â€‹ è¿™æ—¶ t3 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t3 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹ã€‚â€‹ ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ shared äº†ï¼Œå› æ­¤ä¸ä¼šç»§ç»­å”¤é†’ t4 æ‰€åœ¨èŠ‚ç‚¹ã€‚â€‹ 5.çº¿ç¨‹2è¯»é”é‡Šæ”¾é”ï¼Œçº¿ç¨‹3è¯»é”é‡Šæ”¾é”t2 è¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œä½†ç”±äºè®¡æ•°è¿˜ä¸ä¸ºé›¶ã€‚â€‹ t3 è¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œè¿™å›è®¡æ•°ä¸ºé›¶äº†ï¼Œè¿›å…¥doReleaseShared() å°†å¤´èŠ‚ç‚¹ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œå³ï¼šâ€‹ ä¹‹å t4 åœ¨ acquireQueued ä¸­ parkAndCheckInterrupt å¤„æ¢å¤è¿è¡Œï¼Œå†æ¬¡ for (;;) è¿™æ¬¡è‡ªå·±æ˜¯è€äºŒï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–ç«äº‰ï¼ŒtryAcquire(1) æˆåŠŸï¼Œä¿®æ”¹å¤´ç»“ç‚¹ï¼Œæµç¨‹ç»“æŸã€‚â€‹ ä¸‰ï¼Œæºç åˆ†æ1.å†™é”ä¸Šé”æµç¨‹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162static final class NonfairSync extends Sync &#123; // ... çœç•¥æ— å…³ä»£ç  // å¤–éƒ¨ç±» WriteLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ public void lock() &#123; sync.acquire(1); &#125; // AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ public final void acquire(int arg) &#123; if ( // å°è¯•è·å¾—å†™é”å¤±è´¥ !tryAcquire(arg) &amp;&amp; // å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼ // è¿›å…¥ AQS é˜Ÿåˆ—é˜»å¡ acquireQueued(addWaiter(Node.EXCLUSIVE), arg) ) &#123; selfInterrupt(); &#125; &#125; // Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ protected final boolean tryAcquire(int acquires) &#123; // è·å¾—ä½ 16 ä½, ä»£è¡¨å†™é”çš„ state è®¡æ•° Thread current = Thread.currentThread(); int c = getState(); int w = exclusiveCount(c); if (c != 0) &#123; if ( // c != 0 and w == 0 è¡¨ç¤ºæœ‰è¯»é”, æˆ–è€… w == 0 || // å¦‚æœ exclusiveOwnerThread ä¸æ˜¯è‡ªå·± current != getExclusiveOwnerThread() ) &#123; // è·å¾—é”å¤±è´¥ return false; &#125; // å†™é”è®¡æ•°è¶…è¿‡ä½ 16 ä½, æŠ¥å¼‚å¸¸ if (w + exclusiveCount(acquires) &gt; MAX_COUNT) throw new Error(&quot;Maximum lock count exceeded&quot;); // å†™é”é‡å…¥, è·å¾—é”æˆåŠŸ setState(c + acquires); return true; &#125; if ( // åˆ¤æ–­å†™é”æ˜¯å¦è¯¥é˜»å¡, æˆ–è€… writerShouldBlock() || // å°è¯•æ›´æ”¹è®¡æ•°å¤±è´¥ !compareAndSetState(c, c + acquires) ) &#123; // è·å¾—é”å¤±è´¥ return false; &#125; // è·å¾—é”æˆåŠŸ setExclusiveOwnerThread(current); return true; &#125; // éå…¬å¹³é” writerShouldBlock æ€»æ˜¯è¿”å› false, æ— éœ€é˜»å¡ final boolean writerShouldBlock() &#123; return false; &#125;&#125; 2.å†™é”é‡Šæ”¾é”çš„æµç¨‹12345678910111213141516171819202122232425262728293031323334static final class NonfairSync extends Sync &#123; // ... çœç•¥æ— å…³ä»£ç  // WriteLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ public void unlock() &#123; sync.release(1); &#125; // AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ public final boolean release(int arg) &#123; // å°è¯•é‡Šæ”¾å†™é”æˆåŠŸ if (tryRelease(arg)) &#123; // unpark AQS ä¸­ç­‰å¾…çš„çº¿ç¨‹ Node h = head; if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); return true; &#125; return false; &#125; // Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ protected final boolean tryRelease(int releases) &#123; if (!isHeldExclusively()) throw new IllegalMonitorStateException(); int nextc = getState() - releases; // å› ä¸ºå¯é‡å…¥çš„åŸå› , å†™é”è®¡æ•°ä¸º 0, æ‰ç®—é‡Šæ”¾æˆåŠŸ boolean free = exclusiveCount(nextc) == 0; if (free) &#123; setExclusiveOwnerThread(null); &#125; setState(nextc); return free; &#125;&#125; 3.è¯»é”ä¸Šé”æµç¨‹123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151static final class NonfairSync extends Sync &#123; // ReadLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ public void lock() &#123; sync.acquireShared(1); &#125; // AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ public final void acquireShared(int arg) &#123; // tryAcquireShared è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–è¯»é”å¤±è´¥ if (tryAcquireShared(arg) &lt; 0) &#123; doAcquireShared(arg); &#125; &#125; // Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ protected final int tryAcquireShared(int unused) &#123; Thread current = Thread.currentThread(); int c = getState(); // å¦‚æœæ˜¯å…¶å®ƒçº¿ç¨‹æŒæœ‰å†™é”, è·å–è¯»é”å¤±è´¥ if ( exclusiveCount(c) != 0 &amp;&amp; getExclusiveOwnerThread() != current ) &#123; return -1; &#125; int r = sharedCount(c); if ( // è¯»é”ä¸è¯¥é˜»å¡(å¦‚æœè€äºŒæ˜¯å†™é”ï¼Œè¯»é”è¯¥é˜»å¡), å¹¶ä¸” !readerShouldBlock() &amp;&amp; // å°äºè¯»é”è®¡æ•°, å¹¶ä¸” r &lt; MAX_COUNT &amp;&amp; // å°è¯•å¢åŠ è®¡æ•°æˆåŠŸ compareAndSetState(c, c + SHARED_UNIT) ) &#123; // ... çœç•¥ä¸é‡è¦çš„ä»£ç  return 1; &#125; return fullTryAcquireShared(current); &#125; // éå…¬å¹³é” readerShouldBlock çœ‹ AQS é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯å†™é” // true åˆ™è¯¥é˜»å¡, false åˆ™ä¸é˜»å¡ final boolean readerShouldBlock() &#123; return apparentlyFirstQueuedIsExclusive(); &#125; // AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ // ä¸ tryAcquireShared åŠŸèƒ½ç±»ä¼¼, ä½†ä¼šä¸æ–­å°è¯• for (;;) è·å–è¯»é”, æ‰§è¡Œè¿‡ç¨‹ä¸­æ— é˜»å¡ final int fullTryAcquireShared(Thread current) &#123; HoldCounter rh = null; for (; ; ) &#123; int c = getState(); if (exclusiveCount(c) != 0) &#123; if (getExclusiveOwnerThread() != current) return -1; &#125; else if (readerShouldBlock()) &#123; // ... çœç•¥ä¸é‡è¦çš„ä»£ç  &#125; if (sharedCount(c) == MAX_COUNT) throw new Error(&quot;Maximum lock count exceeded&quot;); if (compareAndSetState(c, c + SHARED_UNIT)) &#123; // ... çœç•¥ä¸é‡è¦çš„ä»£ç  return 1; &#125; &#125; &#125; // AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ private void doAcquireShared(int arg) &#123; // å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºå…±äº«æ¨¡å¼ final Node node = addWaiter(Node.SHARED); boolean failed = true; try &#123; boolean interrupted = false; for (; ; ) &#123; final Node p = node.predecessor(); if (p == head) &#123; // å†ä¸€æ¬¡å°è¯•è·å–è¯»é” int r = tryAcquireShared(arg); // æˆåŠŸ if (r &gt;= 0) &#123; // ãˆ  // r è¡¨ç¤ºå¯ç”¨èµ„æºæ•°, åœ¨è¿™é‡Œæ€»æ˜¯ 1 å…è®¸ä¼ æ’­ //ï¼ˆå”¤é†’ AQS ä¸­ä¸‹ä¸€ä¸ª Share èŠ‚ç‚¹ï¼‰ setHeadAndPropagate(node, r); p.next = null; // help GC if (interrupted) selfInterrupt(); failed = false; return; &#125; &#125; if ( // æ˜¯å¦åœ¨è·å–è¯»é”å¤±è´¥æ—¶é˜»å¡ï¼ˆå‰ä¸€ä¸ªé˜¶æ®µ waitStatus == Node.SIGNALï¼‰ shouldParkAfterFailedAcquire(p, node) &amp;&amp; // park å½“å‰çº¿ç¨‹ parkAndCheckInterrupt() ) &#123; interrupted = true; &#125; &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125; &#125; // ãˆ  AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ private void setHeadAndPropagate(Node node, int propagate) &#123; Node h = head; // Record old head for check below // è®¾ç½®è‡ªå·±ä¸º head setHead(node); // propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰ // åŸ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE // ç°åœ¨ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE if (propagate &gt; 0 || h == null || h.waitStatus &lt; 0 || (h = head) == null || h.waitStatus &lt; 0) &#123; Node s = node.next; // å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ if (s == null || s.isShared()) &#123; // è¿›å…¥ ãˆ¡ doReleaseShared(); &#125; &#125; &#125; // ãˆ¡ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ private void doReleaseShared() &#123; // å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark // å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE, ä¸ºäº†è§£å†³ bug, è§åé¢åˆ†æ for (; ; ) &#123; Node h = head; // é˜Ÿåˆ—è¿˜æœ‰èŠ‚ç‚¹ if (h != null &amp;&amp; h != tail) &#123; int ws = h.waitStatus; if (ws == Node.SIGNAL) &#123; if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0)) continue; // loop to recheck cases // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark å¦‚æœæˆåŠŸè·å–è¯»é” // å¹¶ä¸”ä¸‹ä¸‹ä¸ªèŠ‚ç‚¹è¿˜æ˜¯ shared, ç»§ç»­ doReleaseShared unparkSuccessor(h); &#125; else if (ws == 0 &amp;&amp; !compareAndSetWaitStatus(h, 0, Node.PROPAGATE)) continue; // loop on failed CAS &#125; if (h == head) // loop if head changed break; &#125; &#125;&#125; 4.è¯»é”é‡Šæ”¾é”çš„æµç¨‹123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354static final class NonfairSync extends Sync &#123; // ReadLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ public void unlock() &#123; sync.releaseShared(1); &#125; // AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ public final boolean releaseShared(int arg) &#123; if (tryReleaseShared(arg)) &#123; doReleaseShared(); return true; &#125; return false; &#125; // Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ protected final boolean tryReleaseShared(int unused) &#123; // ... çœç•¥ä¸é‡è¦çš„ä»£ç  for (; ; ) &#123; int c = getState(); int nextc = c - SHARED_UNIT; if (compareAndSetState(c, nextc)) &#123; // è¯»é”çš„è®¡æ•°ä¸ä¼šå½±å“å…¶å®ƒè·å–è¯»é”çº¿ç¨‹, ä½†ä¼šå½±å“å…¶å®ƒè·å–å†™é”çº¿ç¨‹ // è®¡æ•°ä¸º 0 æ‰æ˜¯çœŸæ­£é‡Šæ”¾ return nextc == 0; &#125; &#125; &#125; // AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„ private void doReleaseShared() &#123; // å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark // å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE for (; ; ) &#123; Node h = head; if (h != null &amp;&amp; h != tail) &#123; int ws = h.waitStatus; // å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨é‡Šæ”¾è¯»é”ï¼Œé‚£ä¹ˆéœ€è¦å°† waitStatus å…ˆæ”¹ä¸º 0 // é˜²æ­¢ unparkSuccessor è¢«å¤šæ¬¡æ‰§è¡Œ if (ws == Node.SIGNAL) &#123; if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0)) continue; // loop to recheck cases unparkSuccessor(h); &#125; // å¦‚æœå·²ç»æ˜¯ 0 äº†ï¼Œæ”¹ä¸º -3ï¼Œç”¨æ¥è§£å†³ä¼ æ’­æ€§ï¼Œè§åæ–‡ä¿¡å·é‡ bug åˆ†æ else if (ws == 0 &amp;&amp; !compareAndSetWaitStatus(h, 0, Node.PROPAGATE)) continue; // loop on failed CAS &#125; if (h == head) // loop if head changed break; &#125; &#125;&#125;","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"AQS","slug":"JUC/AQS","date":"2022-01-11T11:06:49.064Z","updated":"2022-01-11T11:24:53.300Z","comments":true,"path":"2022/01/11/JUC/AQS/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/AQS/","excerpt":"","text":"ä¸€ï¼ŒLockLockåœ¨jucä¸­æ˜¯æœ€æ ¸å¿ƒçš„ç»„ä»¶â€‹ 1.Lockçš„å®ç°Lock æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒå®šä¹‰äº†é‡Šæ”¾é”å’Œè·å¾—é”çš„æŠ½è±¡æ–¹æ³•ï¼Œå®šä¹‰æˆæ¥å£å°±æ„å‘³ç€å®ƒå®šä¹‰äº†é”çš„ä¸€ä¸ªæ ‡å‡†è§„èŒƒï¼Œä¹ŸåŒæ—¶æ„å‘³ç€é”çš„ä¸åŒå®ç°ã€‚å®ç° Lock æ¥å£çš„ç±»æœ‰å¾ˆå¤šï¼Œä»¥ä¸‹ä¸ºå‡ ä¸ªå¸¸è§çš„é”å®ç°ã€‚â€‹ ReentrantLockï¼šè¡¨ç¤ºé‡å…¥é”ï¼Œå®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªå®ç°äº† Lock æ¥å£çš„ç±»ã€‚é‡å…¥é”æŒ‡çš„æ˜¯çº¿ç¨‹åœ¨è·å¾—é”ä¹‹åï¼Œå†æ¬¡è·å–è¯¥é”ä¸éœ€è¦é˜»å¡ï¼Œè€Œæ˜¯ç›´æ¥å…³è”ä¸€æ¬¡è®¡æ•°å™¨å¢åŠ é‡å…¥æ¬¡æ•°ã€‚â€‹ ReentrantReadWriteLockï¼šé‡å…¥è¯»å†™é”ï¼Œå®ƒå®ç°äº† ReadWriteLock æ¥å£ï¼Œåœ¨è¿™ä¸ªç±»ä¸­ç»´æŠ¤äº†ä¸¤ä¸ªé”ï¼Œä¸€ä¸ªæ˜¯ ReadLockï¼Œä¸€ä¸ªæ˜¯ WriteLockï¼Œä»–ä»¬éƒ½åˆ†åˆ«å®ç°äº† Lockæ¥å£ã€‚è¯»å†™é”æ˜¯ä¸€ç§é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜çš„å·¥å…·ï¼ŒåŸºæœ¬åŸåˆ™æ˜¯ï¼š è¯»å’Œè¯»ä¸äº’æ–¥ã€è¯»å’Œå†™äº’æ–¥ã€å†™å’Œå†™äº’æ–¥ã€‚ä¹Ÿå°±æ˜¯è¯´æ¶‰åŠåˆ°å½±å“æ•°æ®å˜åŒ–çš„æ“ä½œéƒ½ä¼šå­˜åœ¨äº’æ–¥ã€‚â€‹ StampedLockï¼š stampedLock æ˜¯ JDK8 å¼•å…¥çš„æ–°çš„é”æœºåˆ¶ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºæ˜¯è¯»å†™é”çš„ä¸€ä¸ªæ”¹è¿›ç‰ˆæœ¬ï¼Œè¯»å†™é”è™½ç„¶é€šè¿‡åˆ†ç¦»è¯»å’Œå†™çš„åŠŸèƒ½ä½¿å¾—è¯»å’Œè¯»ä¹‹é—´å¯ä»¥å®Œå…¨å¹¶å‘ï¼Œä½†æ˜¯è¯»å’Œå†™æ˜¯æœ‰å†²çªçš„ï¼Œå¦‚æœå¤§é‡çš„è¯»çº¿ç¨‹å­˜åœ¨ï¼Œå¯èƒ½ä¼šå¼•èµ·å†™çº¿ç¨‹çš„é¥¥é¥¿ã€‚stampedLock æ˜¯ä¸€ç§ä¹è§‚çš„è¯»ç­–ç•¥ï¼Œä½¿å¾—ä¹è§‚é”å®Œå…¨ä¸ä¼šé˜»å¡å†™çº¿ç¨‹ã€‚â€‹ 2.Lockçš„ç±»å…³ç³»å›¾Lockæœ‰å¾ˆå¤šçš„å®ç°ï¼Œä½†æ˜¯ç›´è§‚çš„å®ç°æ˜¯ReentrantLocké‡å…¥é”ã€‚â€‹ 12345void lock() // å¦‚æœé”å¯ç”¨å°±è·å¾—é”ï¼Œå¦‚æœé”ä¸å¯ç”¨å°±é˜»å¡ç›´åˆ°é”é‡Šæ”¾void lockInterruptibly() // å’Œlock()æ–¹æ³•ç›¸ä¼¼, ä½†é˜»å¡çš„çº¿ç¨‹ å¯ ä¸­ æ–­ ï¼Œ æŠ› å‡ºjava.lang.InterruptedException å¼‚å¸¸boolean tryLock() // éé˜»å¡è·å–é”;å°è¯•è·å–é”ï¼Œå¦‚æœæˆåŠŸè¿”å› trueboolean tryLock(long timeout, TimeUnit timeUnit) //å¸¦æœ‰è¶…æ—¶æ—¶é—´çš„è·å–é”æ–¹æ³•void unlock() // é‡Šæ”¾é” äºŒï¼ŒReentrantLocké‡å…¥é”ï¼Œè¡¨ç¤ºæ”¯æŒé‡æ–°è¿›å…¥çš„é”ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ t1 é€šè¿‡è°ƒç”¨ lock æ–¹æ³•è·å–äº†é”ä¹‹åï¼Œå†æ¬¡è°ƒç”¨ lockï¼Œæ˜¯ä¸ä¼šå†é˜»å¡å»è·å–é”çš„ï¼Œç›´æ¥å¢åŠ é‡è¯•æ¬¡æ•°å°±è¡Œäº†ã€‚synchronized å’Œ ReentrantLock éƒ½æ˜¯å¯é‡å…¥é”ã€‚â€‹ 1.é‡å…¥é”çš„è®¾è®¡ç›®çš„æ¯”å¦‚è°ƒç”¨ demo æ–¹æ³•è·å¾—äº†å½“å‰çš„å¯¹è±¡é”ï¼Œç„¶ååœ¨è¿™ä¸ªæ–¹æ³•ä¸­å†å»è°ƒç”¨demo2ï¼Œdemo2 ä¸­çš„å­˜åœ¨åŒä¸€ä¸ªå®ä¾‹é”ï¼Œè¿™ä¸ªæ—¶å€™å½“å‰çº¿ç¨‹ä¼šå› ä¸ºæ— æ³•è·å¾—demo2 çš„å¯¹è±¡é”è€Œé˜»å¡ï¼Œå°±ä¼šäº§ç”Ÿæ­»é”ã€‚é‡å…¥é”çš„è®¾è®¡ç›®çš„æ˜¯é¿å…çº¿ç¨‹çš„æ­»é”ã€‚â€‹ 1234567891011121314151617public class ReentrantDemo &#123; public synchronized void demo() &#123; System.out.println(&quot;begin:demo&quot;); demo2(); &#125; public void demo2() &#123; System.out.println(&quot;begin:demo1&quot;); synchronized (this) &#123; &#125; &#125; public static void main(String[] args) &#123; ReentrantDemo rd = new ReentrantDemo(); new Thread(rd::demo).start(); &#125;&#125; 2.ReentrantLockä½¿ç”¨123456789101112131415161718192021222324public class AtomicDemo &#123; private static int count = 0; static Lock lock = new ReentrantLock(); public static void inc() &#123; lock.lock(); try &#123; Thread.sleep(1); count++; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;finally &#123; lock.unlock(); &#125; &#125; public static void main(String[] args) throws InterruptedException &#123; for (int i = 0; i &lt; 1000; i++) &#123; new Thread(() -&gt; AtomicDemo.inc()).start(); &#125; Thread.sleep(3000); System.out.println(&quot;result:&quot; + count); &#125;&#125; 3.ReentrantReadWriteLockâ€‹ ä»¥å‰ç†è§£çš„é”ï¼ŒåŸºæœ¬éƒ½æ˜¯æ’ä»–é”ï¼Œä¹Ÿå°±æ˜¯è¿™äº›é”åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè®¿é—®ï¼Œè€Œè¯»å†™æ‰€åœ¨åŒä¸€æ—¶åˆ»å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯åœ¨å†™çº¿ç¨‹è®¿é—®æ—¶ï¼Œæ‰€æœ‰çš„è¯»çº¿ç¨‹å’Œå…¶ä»–å†™çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ã€‚è¯»å†™é”ç»´æŠ¤äº†ä¸€å¯¹é”ï¼Œä¸€ä¸ªè¯»é”ã€ä¸€ä¸ªå†™é”;ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¯»å†™é”çš„æ€§èƒ½éƒ½ä¼šæ¯”æ’å®ƒé”å¥½ï¼Œå› ä¸ºå¤§å¤šæ•°åœºæ™¯è¯»æ˜¯å¤šäºå†™çš„ã€‚åœ¨è¯»å¤šäºå†™çš„æƒ…å†µä¸‹ï¼Œè¯»å†™é”èƒ½å¤Ÿæä¾›æ¯”æ’å®ƒé”æ›´å¥½çš„å¹¶å‘æ€§å’Œååé‡ã€‚â€‹ 12345678910111213141516171819202122232425262728public class LockDemo &#123; static Map&lt;String, Object&gt; cacheMap = new HashMap&lt;&gt;(); static ReentrantReadWriteLock rwl = new ReentrantReadWriteLock(); static Lock read = rwl.readLock(); static Lock write = rwl.writeLock(); public static final Object get(String key) &#123; System.out.println(&quot; å¼€å§‹è¯»å–æ•°æ®&quot;); read.lock(); // è¯»é” try &#123; return cacheMap.get(key); &#125; finally &#123; read.unlock(); &#125; &#125; public static final Object put(String key, Object value) &#123; System.out.println(&quot; å¼€å§‹å†™æ•°æ®&quot;); write.lock(); try &#123; return cacheMap.put(key, value); &#125; finally &#123; write.unlock(); &#125; &#125;&#125; åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œé€šè¿‡ hashmap æ¥æ¨¡æ‹Ÿäº†ä¸€ä¸ªå†…å­˜ç¼“å­˜ï¼Œç„¶åä½¿ç”¨è¯»å†™é”æ¥ä¿è¯è¿™ä¸ªå†…å­˜ç¼“å­˜çš„çº¿ç¨‹å®‰å…¨æ€§ã€‚å½“æ‰§è¡Œè¯»æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦è·å–è¯»é”ï¼Œåœ¨å¹¶å‘è®¿é—®çš„æ—¶å€™ï¼Œè¯»é”ä¸ä¼šè¢«é˜»å¡ï¼Œå› ä¸ºè¯»æ“ä½œä¸ä¼šå½±å“æ‰§è¡Œç»“æœã€‚â€‹ åœ¨æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹å¿…é¡»è¦è·å–å†™é”ï¼Œå½“å·²ç»æœ‰çº¿ç¨‹æŒæœ‰å†™é”çš„æƒ…å†µä¸‹ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œåªæœ‰å½“å†™é”é‡Šæ”¾ä»¥åï¼Œå…¶ä»–è¯»å†™æ“ä½œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚ä½¿ç”¨è¯»å†™é”æå‡è¯»æ“ä½œçš„å¹¶å‘æ€§ï¼Œä¹Ÿä¿è¯æ¯æ¬¡å†™æ“ä½œå¯¹æ‰€æœ‰çš„è¯»å†™æ“ä½œçš„å¯è§æ€§ã€‚â€‹ è¯»é”ä¸è¯»é”å¯ä»¥å…±äº«â€‹ è¯»é”ä¸å†™é”ä¸å¯ä»¥å…±äº«ï¼ˆæ’ä»–ï¼‰ å†™é”ä¸å†™é”ä¸å¯ä»¥å…±äº«ï¼ˆæ’ä»–ï¼‰â€‹ ä¸‰ï¼ŒReentrantLock çš„å®ç°åŸç†â€‹ é”çš„åŸºæœ¬åŸç†æ˜¯ï¼ŒåŸºäºå°†å¤šçº¿ç¨‹å¹¶è¡Œä»»åŠ¡é€šè¿‡æŸä¸€ç§æœºåˆ¶å®ç°çº¿ç¨‹çš„ä¸²è¡Œæ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°çº¿ç¨‹å®‰å…¨æ€§çš„ç›®çš„ã€‚åœ¨ ReentrantLock ä¸­ï¼Œåœ¨å¤šçº¿ç¨‹ç«äº‰é‡å…¥é”æ—¶ï¼Œç«äº‰å¤±è´¥çš„çº¿ç¨‹æ˜¯å¦‚ä½•å®ç°é˜»å¡ä»¥åŠè¢«å”¤é†’çš„å‘¢ï¼Ÿâ€‹ 1.AQSæ˜¯ä»€ä¹ˆï¼Ÿåœ¨ Lock ä¸­ï¼Œç”¨åˆ°äº†ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ— AQSï¼Œå…¨ç§° AbstractQueuedSynchronizerï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒæ­¥å·¥å…·ä¹Ÿæ˜¯ Lock ç”¨æ¥å®ç°çº¿ç¨‹åŒæ­¥çš„æ ¸å¿ƒç»„ä»¶ã€‚â€‹ 2.AQSçš„ä¸¤ç§åŠŸèƒ½ä½¿ç”¨å±‚é¢ä¸Šæ¥è¯´ï¼ŒAQSçš„åŠŸèƒ½åˆ†ä¸ºä¸¤ç§:ç‹¬å å’Œå…±äº«ã€‚â€‹ ç‹¬å é”ï¼šæ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ã€‚â€‹ å…±äº«é”ï¼šå…è®¸å¤šçº¿ç¨‹åŒæ—¶è·å–é”ï¼Œå¹¶å‘è®¿é—®å…±äº«èµ„æºã€‚â€‹ 3.AQSçš„å†…éƒ¨å®ç°AQSé˜Ÿåˆ—å†…éƒ¨ç»´æŠ¤çš„æ˜¯ä¸€ä¸ªFIFOçš„åŒå‘é“¾è¡¨ï¼Œè¿™ç§ç»“æ„çš„ç‰¹ç‚¹æ˜¯æ¯ä¸ªæ•°æ®ç»“æ„éƒ½æœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘ç›´æ¥çš„åç»§èŠ‚ç‚¹å’Œç›´æ¥çš„å‰é©±ç»“ç‚¹ã€‚æ‰€ä»¥åŒå‘é“¾è¡¨å¯ä»¥ä»ä»»æ„ä¸€ä¸ªç»“ç‚¹å¼€å§‹å¾ˆæ–¹ä¾¿çš„è®¿é—®å‰é©±å’Œåç»§ã€‚æ¯ä¸ªNodeå…¶å®æ˜¯ç”±çº¿ç¨‹å°è£…ï¼Œå½“çº¿ç¨‹äº‰æŠ¢é”å¤±è´¥åä¼šå°è£…æˆNodeåŠ å…¥åˆ°AQSé˜Ÿåˆ—ä¸­å»ï¼Œå½“è·å–é”çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œä¼šä»é˜Ÿåˆ—ä¸­å”¤é†’ä¸€ä¸ªé˜»å¡çš„èŠ‚ç‚¹ï¼ˆçº¿ç¨‹ï¼‰ã€‚â€‹ 4.Nodeçš„ç»„æˆ1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950static final class Node &#123; /** Marker to indicate a node is waiting in shared mode */ static final Node SHARED = new Node(); /** Marker to indicate a node is waiting in exclusive mode */ static final Node EXCLUSIVE = null; static final int CANCELLED = 1; static final int SIGNAL = -1; static final int CONDITION = -2; static final int PROPAGATE = -3; volatile int waitStatus; volatile Node prev; //å‰é©±ç»“ç‚¹ volatile Node next; //åç»§èŠ‚ç‚¹ volatile Thread thread; //å½“å‰çº¿ç¨‹ Node nextWaiter; //å­˜å‚¨åœ¨conditioné˜Ÿåˆ—ä¸­çš„åç»§èŠ‚ç‚¹ //æ˜¯å¦ä¸ºå…±äº«é” final boolean isShared() &#123; return nextWaiter == SHARED; &#125; final Node predecessor() throws NullPointerException &#123; Node p = prev; if (p == null) throw new NullPointerException(); else return p; &#125; Node() &#123; // Used to establish initial head or SHARED marker &#125; Node(Thread thread, Node mode) &#123; // Used by addWaiter this.nextWaiter = mode; this.thread = thread; &#125; Node(Thread thread, int waitStatus) &#123; // Used by Condition this.waitStatus = waitStatus; this.thread = thread; &#125;&#125; 5.é‡Šæ”¾é”ä»¥åŠæ·»åŠ çº¿ç¨‹å¯¹äºé˜Ÿåˆ—çš„å˜åŒ–å½“å‡ºç°é”ç«äº‰ä»¥åŠé‡Šæ”¾é”çš„æ—¶å€™ï¼ŒAQS åŒæ­¥é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ä¼šå‘ç”Ÿå˜åŒ–ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹æ·»åŠ èŠ‚ç‚¹çš„åœºæ™¯ã€‚â€‹ è¿™é‡Œä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªå˜åŒ–ï¼šâ€‹ æ–°çš„çº¿ç¨‹å°è£…æˆNodeèŠ‚ç‚¹è¿½åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œè®¾ç½®prevèŠ‚ç‚¹ä»¥åŠä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„nextèŠ‚ç‚¹æŒ‡å‘è‡ªå·±ã€‚ é€šè¿‡CASçš„æ–¹å¼å°†tailé‡æ–°æŒ‡å‘æ–°çš„å°¾éƒ¨èŠ‚ç‚¹ã€‚ â€‹ headèŠ‚ç‚¹è¡¨ç¤ºè·å–é”æˆåŠŸçš„èŠ‚ç‚¹ï¼Œå½“å¤´ç»“ç‚¹åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€çš„æ—¶å€™ï¼Œä¼šå”¤é†’åç»§èŠ‚ç‚¹ï¼Œå¦‚æœåç»§èŠ‚ç‚¹è·å¾—é”æˆåŠŸï¼Œä¼šæŠŠè‡ªå·±è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„å˜åŒ–è¿‡ç¨‹å¦‚ä¸‹ï¼šâ€‹ â€‹ è¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯æ¶‰åŠåˆ°ä¸¤ä¸ªå˜åŒ–ï¼šâ€‹ ä¿®æ”¹headèŠ‚ç‚¹æŒ‡å‘ä¸‹ä¸€ä¸ªè·å¾—é”çš„èŠ‚ç‚¹ æ–°çš„è·å¾—é”çš„èŠ‚ç‚¹ï¼Œå°†prevçš„æŒ‡é’ˆæŒ‡å‘null â€‹ è®¾ç½®headèŠ‚ç‚¹ä¸éœ€è¦ç”¨CASï¼ŒåŸå› æ˜¯è®¾ç½®headèŠ‚ç‚¹æ˜¯ç”±è·å¾—é”çš„çº¿ç¨‹æ¥å®Œæˆçš„ï¼Œè€ŒåŒæ­¥é”åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æ¥è·å¾—ï¼Œæ‰€ä»¥ä¸éœ€è¦CASä¿è¯ï¼Œåªéœ€è¦æŠŠheadèŠ‚ç‚¹è®¾ç½®ä¸ºåŸé¦–èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ–­å¼€åŸheadèŠ‚ç‚¹çš„nextå¼•ç”¨å³å¯ã€‚ å››ï¼ŒReentrantLock çš„æºç åˆ†æ1.åŠ é”é€»è¾‘ReentrantLock.lock123public void lock() &#123; sync.lock();&#125; â€‹ sync å®é™…ä¸Šæ˜¯ä¸€ä¸ªæŠ½è±¡çš„é™æ€å†…éƒ¨ç±»ï¼Œå®ƒç»§æ‰¿äº† AQS æ¥å®ç°é‡å…¥é”çš„é€»è¾‘ï¼Œå‰é¢è¯´è¿‡ AQS æ˜¯ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼Œå®ƒèƒ½å¤Ÿå®ç°çº¿ç¨‹çš„é˜»å¡ä»¥åŠå”¤é†’ï¼Œä½†å®ƒå¹¶ä¸å…·å¤‡ä¸šåŠ¡åŠŸèƒ½ï¼Œæ‰€ä»¥åœ¨ä¸åŒçš„åŒæ­¥åœºæ™¯ä¸­ï¼Œä¼šç»§æ‰¿ AQS æ¥å®ç°å¯¹åº”åœºæ™¯çš„åŠŸèƒ½ã€‚â€‹ Sync æœ‰ä¸¤ä¸ªå…·ä½“çš„å®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯ï¼š NofairSyncï¼šè¡¨ç¤ºå¯ä»¥å­˜åœ¨æŠ¢å é”çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç®¡å½“å‰é˜Ÿåˆ—ä¸Šæ˜¯å¦å­˜åœ¨å…¶ä»–çº¿ç¨‹ç­‰å¾…ï¼Œæ–°çº¿ç¨‹éƒ½æœ‰æœºä¼šæŠ¢å é”ã€‚ FailSync: è¡¨ç¤ºæ‰€æœ‰çº¿ç¨‹ä¸¥æ ¼æŒ‰ç…§ FIFO æ¥è·å–é”ã€‚â€‹ NonfairSync.lock éå…¬å¹³é”å’Œå…¬å¹³é”æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šéå…¬å¹³é”ä¸­æŠ¢å é”çš„é€»è¾‘æ˜¯ï¼Œä¸ç®¡æœ‰æ²¡æœ‰çº¿ç¨‹æ’é˜Ÿï¼Œå…ˆä¸Šæ¥caså»æŠ¢å ä¸€ä¸‹ casæˆåŠŸï¼Œå°±è¡¨ç¤ºæˆåŠŸè·å¾—äº†é” caså¤±è´¥ï¼Œè°ƒç”¨acquire(1)èµ°é”ç«äº‰é€»è¾‘ â€‹ state æ˜¯ AQS ä¸­çš„ä¸€ä¸ªå±æ€§ï¼Œå®ƒåœ¨ä¸åŒçš„å®ç°ä¸­æ‰€è¡¨è¾¾çš„å«ä¹‰ä¸ä¸€æ ·ï¼Œå¯¹äºé‡å…¥é”çš„å®ç°æ¥è¯´ï¼Œè¡¨ç¤ºä¸€ä¸ªåŒæ­¥çŠ¶æ€ã€‚å®ƒæœ‰ä¸¤ä¸ªå«ä¹‰çš„è¡¨ç¤ºï¼šâ€‹ å½“ state=0 æ—¶ï¼Œè¡¨ç¤ºæ— é”çŠ¶æ€ã€‚ â€‹ å½“ state&gt;0 æ—¶ï¼Œè¡¨ç¤ºå·²ç»æœ‰çº¿ç¨‹è·å¾—äº†é”ï¼Œä¹Ÿå°±æ˜¯ state=1ï¼Œä½†æ˜¯å› ä¸ºReentrantLock å…è®¸é‡å…¥ï¼Œæ‰€ä»¥åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å¾—åŒæ­¥é”çš„æ—¶å€™ï¼Œstate ä¼šé€’å¢ï¼Œæ¯”å¦‚é‡å…¥ 5 æ¬¡ï¼Œé‚£ä¹ˆ state=5ã€‚ è€Œåœ¨é‡Šæ”¾é”çš„æ—¶å€™ï¼ŒåŒæ ·éœ€è¦é‡Šæ”¾ 5 æ¬¡ç›´åˆ° state=0å…¶ä»–çº¿ç¨‹æ‰æœ‰èµ„æ ¼è·å¾—é”ã€‚ â€‹ 1234567final void lock() &#123; //å¦‚æœcasçš„æ–¹å¼ä¿®æ”¹stateçŠ¶æ€æˆåŠŸï¼Œè¯´æ˜è·å–åˆ°äº†é”ï¼Œç›´æ¥è®¾ç½®å½“å‰æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ if (compareAndSetState(0, 1)) setExclusiveOwnerThread(Thread.currentThread()); else //caså¤±è´¥ï¼Œèµ°æŠ¢å é”çš„é€»è¾‘ acquire(1);&#125; \u0000 AQS.acquireacquireæ˜¯AQSä¸­çš„æ–¹æ³•ï¼Œå¦‚æœcasæ“ä½œæœªèƒ½æˆåŠŸï¼Œè¯´æ˜stateå·²ç»ä¸ä¸º0ï¼Œæ­¤æ—¶ç»§ç»­acquire(1)æ“ä½œã€‚â€‹ è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦é€»è¾‘ï¼šâ€‹ é€šè¿‡ tryAcquire å°è¯•è·å–ç‹¬å é”ï¼Œå¦‚æœæˆåŠŸè¿”å› trueï¼Œå¤±è´¥è¿”å› false. å¦‚æœ tryAcquire å¤±è´¥ï¼Œåˆ™ä¼šé€šè¿‡ addWaiter æ–¹æ³•å°†å½“å‰çº¿ç¨‹å°è£…æˆ Node æ·»åŠ åˆ° AQS é˜Ÿåˆ—å°¾éƒ¨. acquireQueuedï¼Œå°† Node ä½œä¸ºå‚æ•°ï¼Œé€šè¿‡è‡ªæ—‹å»å°è¯•è·å–é”ã€‚12345678public final void acquire(int arg) &#123; //å¦‚æœå°è¯•å»æŠ¢å é”å¤±è´¥ å°±è®²å½“å‰çº¿å°¾æ’è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œè®©å½“å‰ç°æˆçš„nodeè‡ªæ—‹çš„æ–¹å¼å»å°è¯•è·å–é” if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) //å“åº”ä¸­æ–­é€»è¾‘ï¼Œè¡¨ç¤ºå¦‚æœå½“å‰çº¿ç¨‹åœ¨ acquireQueued ä¸­è¢«ä¸­æ–­è¿‡ï¼Œåˆ™éœ€è¦äº§ç”Ÿä¸€ä¸ªä¸­æ–­è¯·æ±‚ï¼Œ //åŸå› æ˜¯çº¿ç¨‹åœ¨è°ƒç”¨ acquireQueued æ–¹æ³•çš„æ—¶å€™æ˜¯ä¸ä¼šå“åº”ä¸­æ–­è¯·æ±‚çš„ã€‚ selfInterrupt();&#125; AQS.selfInterrupt è¡¨ç¤ºå¦‚æœå½“å‰çº¿ç¨‹åœ¨ acquireQueued ä¸­è¢«ä¸­æ–­è¿‡ï¼Œåˆ™éœ€è¦äº§ç”Ÿä¸€ä¸ªä¸­æ–­è¯·æ±‚ï¼ŒåŸå› æ˜¯çº¿ç¨‹åœ¨è°ƒç”¨ acquireQueued æ–¹æ³•çš„æ—¶å€™æ˜¯ä¸ä¼šå“åº”ä¸­æ–­è¯·æ±‚çš„ã€‚ 1234//æ‰§è¡Œä¸­æ–­é€»è¾‘static void selfInterrupt() &#123; Thread.currentThread().interrupt();&#125; AQS.tryAcquireè¿™é‡Œé‡‡ç”¨æ¨¡æ¿æ¨¡å¼ï¼Œå…·ä½“çš„é€»è¾‘äº¤ç»™ç»§æ‰¿è¯¥ç±»çš„å­ç±»å®ç°ï¼Œç›´æ¥çœ‹éå…¬å¹³é”çš„é€»è¾‘ã€‚ 123protected boolean tryAcquire(int arg) &#123; throw new UnsupportedOperationException();&#125; NonfairSync.tryAcquireè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯å°è¯•è·å–é”ï¼Œå¦‚æœæˆåŠŸè¿”å›trueï¼Œä¸æˆåŠŸè¿”å›falseã€‚â€‹ å®ƒæ˜¯é‡å†™AQSç±»ä¸­çš„tryAcquireæ–¹æ³•ï¼ŒAQSä¸­çš„tryAcquire()çš„å®šä¹‰ï¼Œå¹¶æ²¡æœ‰å®ç°ï¼Œè€Œæ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚ 123protected final boolean tryAcquire(int acquires) &#123; return nonfairTryAcquire(acquires);&#125; ReentrantLock.nofairTryAcquire è·å–å½“å‰çº¿ç¨‹ï¼Œåˆ¤æ–­å½“å‰çš„é”çš„çŠ¶æ€ å¦‚æœstate=0 è¡¨ç¤ºå½“å‰æ˜¯æ— é”çŠ¶æ€ï¼Œé€šè¿‡casæ›´æ–°stateçŠ¶æ€çš„å€¼ å½“å‰çº¿ç¨‹æ˜¯å±äºé‡å…¥ï¼Œåˆ™å¢åŠ é‡å…¥æ¬¡æ•°12345678910111213141516171819202122232425262728final boolean nonfairTryAcquire(int acquires) &#123; //è·å–å½“å‰çº¿ç¨‹ final Thread current = Thread.currentThread(); //è·å–å½“å‰çš„stateå€¼ int c = getState(); //å¦‚æœæ­¤æ—¶æ²¡æœ‰çº¿ç¨‹æŒæœ‰é” if (c == 0) &#123; //caså»è·å–ä¸€æ¬¡é” if (compareAndSetState(0, acquires)) &#123; //èµ°åˆ°è¿™é‡Œè¯´æ˜casçš„æ–¹å¼è·å–åˆ°äº†é”ï¼Œç›´æ¥è®¾ç½®å½“å‰é”çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¹¶è¿”å›true setExclusiveOwnerThread(current); return true; &#125; &#125; //èµ°åˆ°è¿™é‡Œè¯´æ˜ å½“å‰é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ æˆ–è€… å½“å‰caså¤±è´¥ï¼Œå­˜åœ¨ç«äº‰ else if (current == getExclusiveOwnerThread()) &#123; //å¦‚æœæŒæœ‰é”çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹è‡ªå·± //æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜æ˜¯ä¸€æ¬¡é‡å…¥é”çš„é€»è¾‘ï¼Œç›´æ¥åœ¨åŸæœ‰çŠ¶æ€ä¸Š+å°±å¯ä»¥ int nextc = c + acquires; if (nextc &lt; 0) // overflow throw new Error(&quot;Maximum lock count exceeded&quot;); setState(nextc); return true; &#125; //ä»€ä¹ˆæƒ…å†µä¸‹ä¼šèµ°åˆ°è¿™é‡Œï¼Ÿ //caså¤±è´¥ï¼Œé”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œ //stateã€‹0 return false;&#125; AQS.addWaiter å½“ tryAcquire æ–¹æ³•è·å–é”å¤±è´¥ä»¥åï¼Œåˆ™ä¼šå…ˆè°ƒç”¨ addWaiter å°†å½“å‰çº¿ç¨‹å°è£…æˆNode. å…¥å‚ mode è¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä¼ é€’çš„å‚æ•°æ˜¯ Node.EXCLUSIVEï¼Œè¡¨ç¤ºç‹¬å çŠ¶æ€ã€‚æ„å‘³ç€é‡å…¥é”ç”¨åˆ°äº† AQS çš„ç‹¬å é”åŠŸèƒ½ã€‚â€‹ å°†å½“å‰çº¿ç¨‹å°è£…æˆ Node â€‹ å½“å‰é“¾è¡¨ä¸­çš„ tail èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡ cas æ“ä½œæŠŠå½“å‰çº¿ç¨‹çš„node æ·»åŠ åˆ° AQS é˜Ÿåˆ— â€‹ å¦‚æœä¸ºç©ºæˆ–è€… cas å¤±è´¥ï¼Œè°ƒç”¨ enq å°†èŠ‚ç‚¹æ·»åŠ åˆ° AQS é˜Ÿåˆ—1234567891011121314151617181920private Node addWaiter(Node mode) &#123; //æ„å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ Node node = new Node(Thread.currentThread(), mode); // Try the fast path of enq; backup to full enq on failure Node pred = tail; //å°¾ç»“ç‚¹ä¸ä¸ºç©ºï¼Œè¯´æ˜é˜Ÿåˆ—å·²ç»åˆå§‹åŒ–è¿‡äº† if (pred != null) &#123; //å°†å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘ä¸ºå°¾ç»“ç‚¹ node.prev = pred; //casçš„æ–¹å¼è®¾ç½®å°¾ç»“ç‚¹ if (compareAndSetTail(pred, node)) &#123; //casæˆåŠŸï¼Œè®©å°¾ç»“ç‚¹çš„åç»§æŒ‡é’ˆæŒ‡å‘node pred.next = node; return node; &#125; &#125; //æ‰§è¡Œåˆ°è¿™é‡Œ è¯´æ˜é˜Ÿåˆ—å°šæœªåˆå§‹åŒ–ï¼Œ æˆ–è€…casçš„æ–¹å¼è®¾ç½®å°¾ç»“ç‚¹å¤±è´¥ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å…ˆä¸€æ­¥å…¥é˜Ÿäº†ã€‚ enq(node); return node;&#125; AQS.enq enq å°±æ˜¯é€šè¿‡è‡ªæ—‹æ“ä½œæŠŠå½“å‰èŠ‚ç‚¹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚ 123456789101112131415161718192021private Node enq(final Node node) &#123; //è‡ªæ—‹ï¼š for (;;) &#123; Node t = tail; if (t == null) &#123; // å°¾ç»“ç‚¹ä¸ºç©ºï¼Œè¯´æ˜éœ€è¦åˆå§‹åŒ– if (compareAndSetHead(new Node())) tail = head; //æ³¨æ„ï¼Œè¿™é‡Œåˆå§‹åŒ–å®Œä¹‹åå¹¶æ²¡æœ‰ç›´æ¥é€€å‡ºï¼Œè€Œæ˜¯ç»§ç»­å¾€ä¸‹èµ°ï¼Œä¸ºå•¥å‘¢ï¼Ÿ //å› ä¸ºå½“å‰æ‰§è¡Œçš„æ˜¯åˆå§‹åŒ–æ“ä½œï¼Œé‚£å°±è¯´æ˜ï¼Œå½“å‰è¿™ä¸ªæŠ¢å é”å¤±è´¥çš„çº¿ç¨‹éœ€è¦ç»™å½“å‰æŒæœ‰é”çš„çº¿ç¨‹è¡¥å……ä¸€ä¸ªå¤´èŠ‚ç‚¹ &#125; else &#123;//å°¾ç»“ç‚¹ä¸ä¸ºç©º //è®©å½“å‰èŠ‚ç‚¹çš„å‰é©±æŒ‡é’ˆæŒ‡å‘å°¾ç»“ç‚¹ node.prev = t; //casçš„æ–¹å¼è®¾ç½®å°¾ç»“ç‚¹ if (compareAndSetTail(t, node)) &#123; //è®©å°¾ç»“ç‚¹çš„åç»§æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹ t.next = node; return t; &#125; &#125; &#125;&#125; AQS .acquireQueuedé€šè¿‡ addWaiter æ–¹æ³•æŠŠçº¿ç¨‹æ·»åŠ åˆ°é“¾è¡¨åï¼Œä¼šæ¥ç€æŠŠ Node ä½œä¸ºå‚æ•°ä¼ é€’ç»™acquireQueued æ–¹æ³•ï¼Œå»ç«äº‰é”â€‹ è·å–å½“å‰èŠ‚ç‚¹çš„ prev èŠ‚ç‚¹ å¦‚æœ prev èŠ‚ç‚¹ä¸º head èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒå°±æœ‰èµ„æ ¼å»äº‰æŠ¢é”ï¼Œè°ƒç”¨ tryAcquire æŠ¢å é” â€‹ æŠ¢å é”æˆåŠŸä»¥åï¼ŒæŠŠè·å¾—é”çš„èŠ‚ç‚¹è®¾ç½®ä¸º headï¼Œå¹¶ä¸”ç§»é™¤åŸæ¥çš„åˆå§‹åŒ– headèŠ‚ç‚¹ â€‹ å¦‚æœè·å¾—é”å¤±è´¥ï¼Œåˆ™æ ¹æ® waitStatus å†³å®šæ˜¯å¦éœ€è¦æŒ‚èµ·çº¿ç¨‹ æœ€åï¼Œé€šè¿‡ cancelAcquire å–æ¶ˆè·å¾—é”çš„æ“ä½œ 123456789101112131415161718192021222324252627282930final boolean acquireQueued(final Node node, int arg) &#123; boolean failed = true; try &#123; boolean interrupted = false; for (;;) &#123; //è·å–å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ final Node p = node.predecessor(); //å¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹æ‹¥æœ‰äº†ç«äº‰é”çš„æƒåˆ©ï¼Œå°è¯•casçš„æ–¹å¼å»è·å–ä¸€æ¬¡é” if (p == head &amp;&amp; tryAcquire(arg)) &#123; //æ‰§è¡Œåˆ°è¿™é‡Œè¯´åcasè·å–åˆ°äº†é” //è®¾ç½®å¤´èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œè¿™é‡Œä¸ºå•¥ä¸ç”¨åŠ é”ï¼Œå› ä¸ºè®¾ç½®å¤´èŠ‚ç‚¹çš„çº¿ç¨‹æ˜¯æŒæœ‰é”çš„çº¿ç¨‹ï¼Œç‹¬å æ¨¡å¼ä¸‹ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œæ‰€ä»¥è®¾ç½®å¤´èŠ‚ç‚¹ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ setHead(node); //è®©pçš„åç»§æŒ‡é’ˆæŒ‡å‘null å¸®åŠ©åƒåœ¾å›æ”¶ p.next = null; // help GC //å£°æ˜è·å–é”æˆåŠŸ failed = false; //å½“å‰çº¿ç¨‹ä¸éœ€è¦è¢«ä¸­æ–­ return interrupted; &#125; //å½“å‰æŒæœ‰é”çš„çº¿ç¨‹å¯èƒ½è¿˜æ²¡æœ‰é‡Šæ”¾é”ï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹å°è¯•è·å–é”ä¼šå¤±è´¥ï¼Œè¿™ä¸ªæ—¶å€™å½“å‰çº¿ç¨‹åº”è¯¥park if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) //è¿™é‡Œæ¯”è¾ƒå‹å¥½ï¼Œä»…ä»…æ˜¯æŠŠä¸­æ–­æ ‡è¯†ä½æ”¹æˆtrueï¼Œå¦‚æœæ˜¯å“åº”ä¸­æ–­é€»è¾‘ï¼Œç›´æ¥è¿™é‡ŒæŠ›å¼‚å¸¸äº†ï¼Œç„¶åèµ°cancelAcquire(node)çš„é€»è¾‘ã€‚ interrupted = true; &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125; AQS.shouldParkAfterFailedAcquire å¦‚æœ ThreadA çš„é”è¿˜æ²¡æœ‰é‡Šæ”¾çš„æƒ…å†µä¸‹ï¼ŒThreadB å’Œ ThreadC æ¥äº‰æŠ¢é”è‚¯å®šæ˜¯ä¼šå¤±è´¥ï¼Œé‚£ä¹ˆå¤±è´¥ä»¥åä¼šè°ƒç”¨ shouldParkAfterFailedAcquire æ–¹æ³•â€‹ Node æœ‰ 5 ç§çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯ï¼šCANCELLEDï¼ˆ1ï¼‰ï¼ŒSIGNALï¼ˆ-1ï¼‰ã€CONDITIONï¼ˆ-2ï¼‰ã€PROPAGATE(-3)ã€é»˜è®¤çŠ¶æ€(0) CANCELLED: åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…çš„çº¿ç¨‹ç­‰å¾…è¶…æ—¶æˆ–è¢«ä¸­æ–­ï¼Œéœ€è¦ä»åŒæ­¥é˜Ÿåˆ—ä¸­å–æ¶ˆè¯¥ Node çš„ç»“ç‚¹, å…¶ç»“ç‚¹çš„ waitStatus ä¸º CANCELLEDï¼Œå³ç»“æŸçŠ¶æ€ï¼Œè¿›å…¥è¯¥çŠ¶æ€åçš„ç»“ç‚¹å°†ä¸ä¼šå†å˜åŒ– â€‹ SIGNAL: åªè¦å‰ç½®èŠ‚ç‚¹é‡Šæ”¾é”ï¼Œå°±ä¼šé€šçŸ¥æ ‡è¯†ä¸º SIGNAL çŠ¶æ€çš„åç»­èŠ‚ç‚¹çš„çº¿ç¨‹ â€‹ CONDITIONï¼š å’Œ Condition æœ‰å…³ç³» â€‹ PROPAGATEï¼šå…±äº«æ¨¡å¼ä¸‹ï¼ŒPROPAGATE çŠ¶æ€çš„çº¿ç¨‹å¤„äºå¯è¿è¡ŒçŠ¶æ€ â€‹ 0:åˆå§‹çŠ¶æ€ â€‹ è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯ï¼Œé€šè¿‡ Node çš„çŠ¶æ€æ¥åˆ¤æ–­ï¼ŒThreadA ç«äº‰é”å¤±è´¥ä»¥åæ˜¯å¦åº”è¯¥è¢«æŒ‚èµ·ã€‚â€‹ å¦‚æœ ThreadA çš„ pred èŠ‚ç‚¹çŠ¶æ€ä¸º SIGNALï¼Œé‚£å°±è¡¨ç¤ºå¯ä»¥æ”¾å¿ƒæŒ‚èµ·å½“å‰çº¿ç¨‹ â€‹ é€šè¿‡å¾ªç¯æ‰«æé“¾è¡¨æŠŠ CANCELLED çŠ¶æ€çš„èŠ‚ç‚¹ç§»é™¤ â€‹ ä¿®æ”¹ pred èŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNAL,è¿”å› false. â€‹ è¿”å› false æ—¶ï¼Œä¹Ÿå°±æ˜¯ä¸éœ€è¦æŒ‚èµ·ï¼Œè¿”å› trueï¼Œåˆ™éœ€è¦è°ƒç”¨ parkAndCheckInterruptæŒ‚èµ·å½“å‰çº¿ç¨‹ 1234567891011121314151617181920private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) &#123; //å‰é©±èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ int ws = pred.waitStatus; //å¦‚æœå‰ç½®èŠ‚ç‚¹ä¸º SIGNALï¼Œæ„å‘³ç€åªéœ€è¦ç­‰å¾…å…¶ä»–å‰ç½®èŠ‚ç‚¹çš„çº¿ç¨‹è¢«é‡Šæ”¾ if (ws == Node.SIGNAL) return true; //ws å¤§äº 0ï¼Œæ„å‘³ç€ prev èŠ‚ç‚¹å–æ¶ˆäº†æ’é˜Ÿï¼Œç›´æ¥ç§»é™¤è¿™ä¸ªèŠ‚ç‚¹å°±è¡Œ if (ws &gt; 0) &#123; do &#123;//ç›¸å½“äº: pred=pred.prev; node.prev=pred; node.prev = pred = pred.prev; &#125; while (pred.waitStatus &gt; 0);//è¿™é‡Œé‡‡ç”¨å¾ªç¯ï¼Œä»åŒå‘åˆ—è¡¨ä¸­ç§»é™¤ CANCELLED çš„èŠ‚ç‚¹ pred.next = node; &#125; else &#123; //åˆ©ç”¨ cas è®¾ç½® prev èŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNAL(-1) compareAndSetWaitStatus(pred, ws, Node.SIGNAL); &#125; return false;&#125; AQS.parkAndCheckInterruptâ€‹ ä½¿ç”¨ LockSupport.park æŒ‚èµ·å½“å‰çº¿ç¨‹å˜æˆ WATING çŠ¶æ€â€‹ Thread.interruptedï¼Œè¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹è§¦å‘è¿‡ä¸­æ–­è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯thread.interrupt(); å¦‚æœæœ‰è§¦å‘è¿‡ä¸­æ–­è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¼šè¿”å›å½“å‰çš„ä¸­æ–­æ ‡è¯†trueï¼Œå¹¶ä¸”å¯¹ä¸­æ–­æ ‡è¯†è¿›è¡Œå¤ä½æ ‡è¯†å·²ç»å“åº”è¿‡äº†ä¸­æ–­è¯·æ±‚ã€‚å¦‚æœè¿”å› trueï¼Œæ„å‘³ç€åœ¨ acquire æ–¹æ³•ä¸­ä¼šæ‰§è¡Œ selfInterrupt()ã€‚ 1234private final boolean parkAndCheckInterrupt() &#123; LockSupport.park(this); return Thread.interrupted();&#125; AQS.cancelAcquire123456789101112131415161718192021222324252627282930313233343536373839404142434445464748private void cancelAcquire(Node node) &#123; //å¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å› if (node == null) return; //å°†å½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹è®¾ç½®ä¸ºç©º node.thread = null; //è·å–å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ Node pred = node.prev; //å¾ªç¯åˆ¤æ–­ï¼šå¦‚æœå‰é©±èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå–æ¶ˆçŠ¶æ€ï¼Œé‚£å°±ç»§ç»­å¾€å‰æ‰¾ while (pred.waitStatus &gt; 0) node.prev = pred = pred.prev; //å¯èƒ½æ˜¯å½“å‰èŠ‚ç‚¹ï¼Œå¯èƒ½æ˜¯ws&gt;0çš„èŠ‚ç‚¹ Node predNext = pred.next; //è®¾ç½®å½“å‰èŠ‚ç‚¹çš„waitStatusæ˜¯å–æ¶ˆçŠ¶æ€ node.waitStatus = Node.CANCELLED; /** * å½“å‰å–æ¶ˆæ’é˜Ÿçš„nodeæ‰€åœ¨ é˜Ÿåˆ—çš„ä½ç½®ä¸åŒï¼Œæ‰§è¡Œçš„å‡ºé˜Ÿç­–ç•¥æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸€å…±åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š * 1.å½“å‰nodeæ˜¯é˜Ÿå°¾ tail -&gt; node * 2.å½“å‰node ä¸æ˜¯ head.next èŠ‚ç‚¹ï¼Œä¹Ÿä¸æ˜¯ tail * 3.å½“å‰node æ˜¯ head.nextèŠ‚ç‚¹ã€‚ */ //å°¾ç»“ç‚¹ä¸”cas tailæˆåŠŸ if (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123; //pred.next = null nodeå‡ºé˜Ÿ compareAndSetNext(pred, predNext, null); &#125; else &#123; int ws; /* nodeä¸æ˜¯head.next node ä¸æ˜¯tail nodeçš„å‰é©±èŠ‚ç‚¹æ˜¯å–æ¶ˆçŠ¶æ€ æˆ– å‡è®¾å‰é©±çŠ¶æ€æ˜¯ &lt;= 0 åˆ™è®¾ç½®å‰é©±çŠ¶æ€ä¸º SignalçŠ¶æ€..è¡¨ç¤ºè¦å”¤é†’åç»§èŠ‚ç‚¹ã€‚ ifé‡Œé¢è¦åšçš„å°±æ˜¯è®©node çš„prev è·¨è¿‡node ç›´æ¥æŒ‡å‘ node.next */ if (pred != head &amp;&amp; ((ws = pred.waitStatus) == Node.SIGNAL || (ws &lt;= 0 &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp; pred.thread != null) &#123; Node next = node.next; if (next != null &amp;&amp; next.waitStatus &lt;= 0) compareAndSetNext(pred, predNext, next); &#125; else &#123; //nodeæ˜¯head.next &amp;&amp; node !=tail //é‚£å°±è·¨è¿‡node head.next = node.next node.next.prev=head unparkSuccessor(node); &#125; node.next = node; // help GC &#125;&#125; 2.é‡Šæ”¾é”çš„é€»è¾‘å¦‚æœè¿™ä¸ªæ—¶å€™ ThreadA é‡Šæ”¾é”äº†ï¼Œé‚£ä¹ˆæ¥çœ‹é”è¢«é‡Šæ”¾åä¼šäº§ç”Ÿä»€ä¹ˆæ•ˆæœï¼Ÿâ€‹ ReentrantLock.unlock1234public void unlock() &#123; //æ‰§è¡Œsyncçš„releaseæ–¹æ³•ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œæ‰€ä»¥çœ‹éå…¬å¹³é”çš„é€»è¾‘ sync.release(1);&#125; AQS.release123456789101112public final boolean release(int arg) &#123; //å¦‚æœå°è¯•é‡Šæ”¾é”æˆåŠŸ if (tryRelease(arg)) &#123; //å¦‚æœå¤´ç»“ç‚¹ä¸ä¸ºç©ºï¼Œä¸”å¤´èŠ‚ç‚¹çŠ¶æ€ä¸ç­‰äº0 Node h = head; if (h != null &amp;&amp; h.waitStatus != 0) //å”¤é†’åç»§çº¿ç¨‹ unparkSuccessor(h); return true; &#125; return false;&#125; ReentrantLock.tryReleaseè¿™ä¸ªæ–¹æ³•å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªè®¾ç½®é”çŠ¶æ€çš„æ“ä½œï¼Œé€šè¿‡å°† state çŠ¶æ€å‡æ‰ä¼ å…¥çš„å‚æ•°å€¼ï¼ˆå‚æ•°æ˜¯ 1ï¼‰ï¼Œå¦‚æœç»“æœçŠ¶æ€ä¸º 0ï¼Œå°±å°†æ’å®ƒé”çš„ Owner è®¾ç½®ä¸º nullï¼Œä»¥ä½¿å¾—å…¶å®ƒçš„çº¿ç¨‹æœ‰æœºä¼šè¿›è¡Œæ‰§è¡Œã€‚â€‹ åœ¨æ’å®ƒé”ä¸­ï¼ŒåŠ é”çš„æ—¶å€™çŠ¶æ€ä¼šå¢åŠ  1ï¼ˆå½“ç„¶å¯ä»¥è‡ªå·±ä¿®æ”¹è¿™ä¸ªå€¼ï¼‰ï¼Œåœ¨è§£é”çš„æ—¶å€™å‡æ‰ 1ï¼ŒåŒä¸€ä¸ªé”ï¼Œåœ¨å¯ä»¥é‡å…¥åï¼Œå¯èƒ½ä¼šè¢«å åŠ ä¸º 2ã€3ã€4 è¿™äº›å€¼ï¼Œåªæœ‰ unlock()çš„æ¬¡æ•°ä¸ lock()çš„æ¬¡æ•°å¯¹åº”æ‰ä¼šå°† Owner çº¿ç¨‹è®¾ç½®ä¸ºç©ºï¼Œè€Œä¸”ä¹Ÿåªæœ‰è¿™ç§æƒ…å†µä¸‹æ‰ä¼šè¿”å› trueã€‚ 1234567891011121314protected final boolean tryRelease(int releases) &#123; //å°†å½“å‰å€¼ä¸ä¼ å…¥çš„å€¼è¿›è¡Œç›¸å‡ int c = getState() - releases; //å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯çº¿ç¨‹æ‹¥æœ‰è€…ï¼ŒæŠ›å¼‚å¸¸ if (Thread.currentThread() != getExclusiveOwnerThread()) throw new IllegalMonitorStateException(); boolean free = false; if (c == 0) &#123;//é‡å…¥é”å·²ç»å®Œå…¨é‡Šæ”¾ free = true; setExclusiveOwnerThread(null);//è®¾ç½®å½“å‰çº¿ç¨‹çš„æ‹¥æœ‰è€…ä¸ºnull &#125; setState(c);//ä¿®æ”¹stateçŠ¶æ€ return free;&#125; AQS.unparkSuccessor1234567891011121314151617181920private void unparkSuccessor(Node node) &#123; //è·å–å¤´èŠ‚ç‚¹çš„çŠ¶æ€ int ws = node.waitStatus; if (ws &lt; 0)//å¦‚æœå¤´ç»“ç‚¹çš„çŠ¶æ€å°äº0 //ä¿®æ”¹å¤´èŠ‚ç‚¹çš„çŠ¶æ€ä¸º0 compareAndSetWaitStatus(node, ws, 0); //è·å–å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ Node s = node.next; /å¦‚æœä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸º null æˆ–è€… status&gt;0 è¡¨ç¤º cancelled çŠ¶æ€ if (s == null || s.waitStatus &gt; 0) &#123; s = null; //é€šè¿‡ä»å°¾éƒ¨èŠ‚ç‚¹å¼€å§‹æ‰«æï¼Œæ‰¾åˆ°è·ç¦» head æœ€è¿‘çš„ä¸€ä¸ªwaitStatus&lt;=0 çš„èŠ‚ç‚¹ for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev) if (t.waitStatus &lt;= 0) s = t; &#125; if (s != null)//å”¤é†’è¿™ä¸ªèŠ‚ç‚¹ LockSupport.unpark(s.thread);&#125; é€šè¿‡é”çš„é‡Šæ”¾ï¼ŒåŸæœ¬çš„ç»“æ„å°±å‘ç”Ÿäº†ä¸€äº›å˜åŒ–ã€‚head èŠ‚ç‚¹çš„ waitStatus å˜æˆäº† 0ï¼ŒThreadB è¢«å”¤é†’ã€‚â€‹ ä¸ºä»€ä¹ˆé‡Šæ”¾é”çš„æ—¶å€™æ˜¯ä»å°¾ç»“ç‚¹å¼€å§‹æ‰«æï¼Ÿâ€‹ å†å›åˆ° enqé‚£ä¸ªæ–¹æ³•ã€‚çœ‹ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹æ˜¯å¦‚ä½•åŠ å…¥åˆ°é“¾è¡¨ä¸­çš„â€‹ å°†æ–°çš„èŠ‚ç‚¹çš„ prev æŒ‡å‘ tailã€‚ é€šè¿‡ cas å°† tail è®¾ç½®ä¸ºæ–°çš„èŠ‚ç‚¹ï¼Œå› ä¸º cas æ˜¯åŸå­æ“ä½œæ‰€ä»¥èƒ½å¤Ÿä¿è¯çº¿ç¨‹å®‰å…¨æ€§ã€‚ â€‹ t.next=nodeï¼›è®¾ç½®åŸ tail çš„ next èŠ‚ç‚¹æŒ‡å‘æ–°çš„èŠ‚ç‚¹ã€‚ â€‹ åœ¨ cas æ“ä½œä¹‹åï¼Œt.next=node æ“ä½œä¹‹å‰ã€‚ å­˜åœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨ unlock æ–¹æ³•ä» headå¼€å§‹å¾€åéå†ï¼Œç”±äº t.next=node è¿˜æ²¡æ‰§è¡Œæ„å‘³ç€é“¾è¡¨çš„å…³ç³»è¿˜æ²¡æœ‰å»ºç«‹å®Œæ•´ã€‚å°±ä¼šå¯¼è‡´éå†åˆ° t èŠ‚ç‚¹çš„æ—¶å€™è¢«ä¸­æ–­ã€‚æ‰€ä»¥ä»åå¾€å‰éå†ï¼Œä¸€å®šä¸ä¼šå­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚â€‹ åŸæœ¬è¢«æŒ‚èµ·çš„çº¿ç¨‹åœ¨è¢«å”¤é†’åç»§ç»­æ‰§è¡Œâ€‹ é€šè¿‡ ReentrantLock.unlockï¼ŒåŸæœ¬æŒ‚èµ·çš„çº¿ç¨‹è¢«å”¤é†’ä»¥åç»§ç»­æ‰§è¡Œï¼ŒåŸæ¥è¢«æŒ‚èµ·çš„çº¿ç¨‹æ˜¯åœ¨ acquireQueued æ–¹æ³•ä¸­ï¼Œæ‰€ä»¥è¢«å”¤é†’ä»¥åç»§ç»­ä»è¿™ä¸ªæ–¹æ³•å¼€å§‹æ‰§è¡Œã€‚â€‹ ç”±äº ThreadB çš„ prev èŠ‚ç‚¹æŒ‡å‘çš„æ˜¯ headï¼Œå¹¶ä¸” ThreadA å·²ç»é‡Šæ”¾äº†é”ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™è°ƒç”¨ tryAcquire æ–¹æ³•æ—¶ï¼Œå¯ä»¥é¡ºåˆ©è·å–åˆ°é”ã€‚â€‹ æŠŠ ThreadB èŠ‚ç‚¹å½“æˆ headã€‚ â€‹ æŠŠåŸ head èŠ‚ç‚¹çš„ next èŠ‚ç‚¹æŒ‡å‘ä¸º nullã€‚ â€‹ 3.å…¬å¹³é”å’Œéå…¬å¹³é”çš„åŒºåˆ«é”çš„å…¬å¹³æ€§æ˜¯ç›¸å¯¹äºè·å–é”çš„é¡ºåºè€Œè¨€çš„ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå…¬å¹³é”ï¼Œé‚£ä¹ˆé”çš„è·å–é¡ºåºå°±åº”è¯¥ç¬¦åˆè¯·æ±‚çš„ç»å¯¹æ—¶é—´é¡ºåºï¼Œä¹Ÿå°±æ˜¯ FIFOã€‚ åœ¨ä¸Šé¢åˆ†æçš„ä¾‹å­æ¥è¯´ï¼Œåªè¦CAS è®¾ç½®åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–äº†é”ï¼Œè€Œå…¬å¹³é”åˆ™ä¸ä¸€æ ·ï¼Œå·®å¼‚ç‚¹æœ‰ä¸¤ä¸ªï¼š FairSync.tryAcquire123final void lock() &#123; acquire(1); &#125; éå…¬å¹³é”åœ¨è·å–é”çš„æ—¶å€™ï¼Œä¼šå…ˆé€šè¿‡ CAS è¿›è¡ŒæŠ¢å ï¼Œè€Œå…¬å¹³é”åˆ™ä¸ä¼šã€‚â€‹ FairSync .tryAcquire123456789101112131415161718192021222324252627282930protected final boolean tryAcquire(int acquires) &#123; //è·å–å½“å‰çº¿ç¨‹ final Thread current = Thread.currentThread(); //è·å–å½“å‰stateçŠ¶æ€ int c = getState(); if (c == 0) &#123;//çŠ¶æ€ä¸º0ï¼Œè¯´æ˜æ­¤æ—¶æ²¡æœ‰ç°æˆæŒæœ‰é” //å¦‚æœé˜Ÿåˆ—é‡Œé¢æ²¡æœ‰èŠ‚ç‚¹ ä¸”casçš„æ–¹å¼è·å–é”æˆåŠŸ if (!hasQueuedPredecessors() &amp;&amp; compareAndSetState(0, acquires)) &#123; //è®¾ç½®æŒæœ‰é”çš„çº¿ç¨‹æˆ‘å½“å‰çº¿ç¨‹ setExclusiveOwnerThread(current); return true; &#125; &#125; //å¦‚æœå½“å‰çº¿ç¨‹æ˜¯è·å–é”çš„çº¿ç¨‹ else if (current == getExclusiveOwnerThread()) &#123; //é”é‡å…¥é€»è¾‘ int nextc = c + acquires; if (nextc &lt; 0) throw new Error(&quot;Maximum lock count exceeded&quot;); setState(nextc); return true; &#125; /* è¿”å›falseçš„æƒ…å†µï¼š 1. å½“å‰é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ 2. é˜Ÿåˆ—é‡Œé¢æœ‰èŠ‚ç‚¹æˆ–casäº‰æŠ¢é”å¤±è´¥ */ return false;&#125; è¿™ä¸ªæ–¹æ³•ä¸ nonfairTryAcquire(int acquires)æ¯”è¾ƒï¼Œä¸åŒçš„åœ°æ–¹åœ¨äºåˆ¤æ–­æ¡ä»¶å¤šäº†hasQueuedPredecessors()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯åŠ å…¥äº†[åŒæ­¥é˜Ÿåˆ—ä¸­å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹]çš„åˆ¤æ–­ï¼Œå¦‚æœè¯¥æ–¹æ³•è¿”å› trueï¼Œåˆ™è¡¨ç¤ºæœ‰çº¿ç¨‹æ¯”å½“å‰çº¿ç¨‹æ›´æ—©åœ°è¯·æ±‚è·å–é”ï¼Œå› æ­¤éœ€è¦ç­‰å¾…å‰é©±çº¿ç¨‹è·å–å¹¶é‡Šæ”¾é”ä¹‹åæ‰èƒ½ç»§ç»­è·å–é”ã€‚ hasQueuedPredecessors1234567891011121314//é¦–å…ˆä»€ä¹ˆæ—¶å€™è¿”å›falseï¼Ÿè¿”å›falseä»£è¡¨å½“å‰é˜Ÿåˆ—æ²¡æœ‰çº¿ç¨‹æˆ–è€…å½“å‰é˜Ÿåˆ—å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯å½“å‰çº¿ç¨‹//1.é˜Ÿåˆ—ä¸ºç©º//2.å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹public final boolean hasQueuedPredecessors() &#123; Node t = tail; Node h = head; Node s; //h!=t:å¤´èŠ‚ç‚¹ä¸æ˜¯å°¾ç»“ç‚¹ï¼Œè¯´æ˜é˜Ÿåˆ—é‡Œé¢è¿˜æœ‰å…¶ä»–çš„èŠ‚ç‚¹ //(å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©º||å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹) //å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹æ­£åœ¨æ‹¿åˆ°é” æˆ–è€… å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ return h != t &amp;&amp; ((s = h.next) == null || s.thread != Thread.currentThread()); &#125; äº”ï¼ŒCondition æ¡ä»¶é˜Ÿåˆ—å¯¹æ¯”synchronizedç®¡ç¨‹æ¨¡å‹ï¼šConditionåŸç†å›¾ï¼šâ€‹ 1.AQS.ConditionObject12345678public class ConditionObject implements Condition, java.io.Serializable &#123; private static final long serialVersionUID = 1173984872572414699L; //ç¬¬ä¸€ä¸ªç­‰å¾…çš„èŠ‚ç‚¹ private transient Node firstWaiter; //æœ€åä¸€ä¸ªç­‰å¾…çš„èŠ‚ç‚¹ private transient Node lastWaiter; public ConditionObject() &#123; &#125; 2.Conditionæ¥å£12345678910111213141516public interface Condition &#123; void await() throws InterruptedException; void awaitUninterruptibly(); long awaitNanos(long nanosTimeout) throws InterruptedException; boolean await(long time, TimeUnit unit) throws InterruptedException; boolean awaitUntil(Date deadline) throws InterruptedException; void signal(); void signalAll();&#125; 3.newCondition()åˆ›å»ºä¸€ä¸ªç­‰å¾…æ¡ä»¶ 123public Condition newCondition() &#123; return sync.newCondition();&#125; 123final ConditionObject newCondition() &#123; return new ConditionObject();&#125; å®é™…ä¸Šè¿™é‡Œnewäº†ä¸€ä¸ªAQSçš„ConditionObjectã€‚â€‹ 4.AQS.awaitè¿™ä¸ªæ–¹æ³•çš„é€»è¾‘å°±æ˜¯å…ˆè¿›è¡Œè¾¹ç•Œåˆ¤æ–­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹å·²ç»è¢«ä¸­æ–­ï¼Œå°±æŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚å¦åˆ™å°†å½“å‰çº¿ç¨‹å°è£…æˆèŠ‚ç‚¹åŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—ï¼Œå¹¶é‡Šæ”¾å…¨éƒ¨é”èµ„æºã€‚æ¥ä¸‹æ¥åˆ¤æ–­æ˜¯å¦å½“å‰æŒæœ‰é”çš„çº¿ç¨‹æ‰§è¡Œäº†å½“å‰çº¿ç¨‹çš„signalæ–¹æ³•ï¼š å¦‚æœæ²¡æœ‰æ‰§è¡Œï¼šå½“å‰çº¿ç¨‹å°±è¿˜æ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—ï¼Œæ­¤æ—¶åº”å½“å°†å½“å‰çº¿ç¨‹æŒ‚èµ· å¦‚æœæ‰§è¡Œäº†ï¼šå½“å‰çº¿ç¨‹å°±è¿ç§»åˆ°äº†é˜»å¡é˜Ÿåˆ—ï¼Œå°±èµ°ç«äº‰é”çš„é€»è¾‘â€¦. 1234567891011121314151617181920212223242526272829303132333435363738public final void await() throws InterruptedException &#123; //å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è¢«æŒ‚èµ·ï¼Œç›´æ¥æŠ›å‡ºä¸­æ–­å¼‚å¸¸ if (Thread.interrupted()) throw new InterruptedException(); //å°†å½“å‰çº¿ç¨‹å°è£…æˆèŠ‚ç‚¹åŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ— Node node = addConditionWaiter(); //é‡Šæ”¾çº¿ç¨‹çš„å…¨éƒ¨é”èµ„æº //ä¸ºä»€ä¹ˆè¿™é‡Œè¦é‡Šæ”¾æ‰å…¨éƒ¨çš„é”ï¼Ÿ //å¦‚æœæ­¤æ—¶çº¿ç¨‹ä¸é‡Šæ”¾é”èµ„æºï¼Œå…¶ä»–çº¿ç¨‹æ²¡åŠæ³•æ‹¿åˆ°é”è§¦å‘å½“å‰çº¿ç¨‹çš„å”¤é†’æœºåˆ¶ int savedState = fullyRelease(node); //ä¸­æ–­çŠ¶æ€ï¼š //-1:å½“å‰çº¿ç¨‹åœ¨æ¡ä»¶é˜Ÿåˆ—æ¥æ”¶åˆ°äº†ä¸­æ–­ä¿¡å· //0:å½“å‰çº¿ç¨‹åœ¨æ¡ä»¶é˜Ÿåˆ—æ²¡æœ‰æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å· //1:å½“å‰çº¿ç¨‹åœ¨æ¡ä»¶é˜Ÿåˆ—æ²¡æœ‰æ¥å—åˆ°ä¸­æ–­ä¿¡å·ï¼Œä½†æ˜¯åœ¨é˜»å¡é˜Ÿåˆ—æ¥æ”¶åˆ°äº†ä¸­æ–­ä¿¡å· int interruptMode = 0; //å¦‚æœå½“å‰çº¿ç¨‹ä¸åœ¨é˜»å¡é˜Ÿåˆ— while (!isOnSyncQueue(node)) &#123; //æŒ‚èµ·å½“å‰çº¿ç¨‹ LockSupport.park(this); //åˆ¤æ–­å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…æœŸé—´æ˜¯å¦è¢«ä¸­æ–­è¿‡ï¼Œæ— è®ºæ˜¯å¦å‘ç”Ÿä¸­æ–­ï¼Œæœ€ç»ˆéƒ½ä¼šè¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ— //ä»€ä¹ˆæ—¶å€™ä¼šè¢«å”¤é†’ï¼Ÿéƒ½æœ‰å‡ ç§æƒ…å†µï¼Ÿ //1.å¸¸è§„ï¼šå¤–éƒ¨çº¿ç¨‹è·å–åˆ°lockä¹‹åï¼Œè°ƒç”¨äº†signalæ–¹æ³•ï¼Œè½¬ç§»æ¡ä»¶é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œå½“è¿™ä¸ªèŠ‚ç‚¹è·å–åˆ°é”ä¹‹åï¼Œä¼šå”¤é†’ //2.è½¬ç§»è‡³é˜»å¡é˜Ÿåˆ—åï¼Œå‘ç°é˜»å¡é˜Ÿåˆ—çš„å‰é©±èŠ‚ç‚¹çŠ¶æ€æ˜¯å–æ¶ˆçŠ¶æ€ï¼Œæ­¤æ—¶ä¼šå”¤é†’å½“å‰èŠ‚ç‚¹ //3.å½“å‰èŠ‚ç‚¹æŒ‚èµ·æœŸé—´ï¼Œè¢«å¤–éƒ¨çº¿ç¨‹ä½¿ç”¨ä¸­æ–­å”¤é†’... if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; &#125; //æ¥åˆ°è¿™é‡Œè¯´æ˜å½“å‰çº¿ç¨‹å·²ç»è¢«å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†signalæ–¹æ³•ï¼ŒåŠ å…¥åˆ°äº†é˜»å¡é˜Ÿåˆ— //å¦‚æœå½“å‰çº¿ç¨‹åœ¨ç«äº‰é”çš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ &amp;&amp; ä¸­æ–­æ ‡è¯†ä½ä¸æ˜¯ throw_ie if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) //å°†å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è¯†ä½è®¾ç½®ä¸ºé‡æ–°ä¸­æ–­ interruptMode = REINTERRUPT; if (node.nextWaiter != null) unlinkCancelledWaiters(); if (interruptMode != 0) reportInterruptAfterWait(interruptMode);&#125; 5.Condition.addConditionWaiterçº¿ç¨‹è¿›å…¥æ¡ä»¶é˜Ÿåˆ—æŒ‚èµ·é€»è¾‘ï¼š å¦‚æœé˜Ÿåˆ—æœ‰å…ƒç´ ï¼Œä½†æ˜¯å…ƒç´ çš„çŠ¶æ€ä¸å¯¹ï¼Œåšä¸€æ¬¡å…¨é˜Ÿçš„æ¸…ç†ï¼Œå°†æ‰€æœ‰å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹å¹²æ‰ï¼Œå¹¶é‡æ–°è·å–å°¾ç»“ç‚¹ å°†çº¿ç¨‹å°è£…æˆnodeèŠ‚ç‚¹ï¼Œåˆ¤æ–­å½“å‰æ¡ä»¶é˜Ÿåˆ—æ˜¯å¦æœ‰å…ƒç´  å¦‚æœæ²¡æœ‰å…ƒç´ ï¼Œå°±å°†å½“å‰nodeè®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ å¦‚æœæœ‰å…ƒç´ ï¼Œå°±å°†å½“å‰å°¾ç»“ç‚¹çš„nextæŒ‡é’ˆæŒ‡å‘node æœ€ç»ˆè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹ï¼Œå¹¶è¿”å›å½“å‰çº¿ç¨‹çš„nodeã€‚ 1234567891011121314151617181920212223private Node addConditionWaiter() &#123; //è·å–å°¾ç»“ç‚¹çš„å¼•ç”¨ Node t = lastWaiter; //æ¡ä»¶ä¸€ï¼šå°¾ç»“ç‚¹ï¼=ç©º //æ¡ä»¶äºŒï¼šå°¾ç»“ç‚¹çš„çŠ¶æ€ï¼=-2ï¼Œè¯´æ˜è¢«ä¸­æ–­äº† if (t != null &amp;&amp; t.waitStatus != Node.CONDITION) &#123; //åšä¸€æ¬¡å…¨é˜Ÿåˆ—çš„åƒåœ¾èŠ‚ç‚¹æ¸…ç† unlinkCancelledWaiters(); //é‡æ–°è·å–å°¾ç»“ç‚¹çš„å¼•ç”¨ï¼Œå› ä¸ºåœ¨åˆšæ‰çš„æ¸…ç†ä¸­ï¼Œå°¾ç»“ç‚¹å¯èƒ½æ¢æˆæ–°çš„äº† t = lastWaiter; &#125; //å°è£…æˆnode Node node = new Node(Thread.currentThread(), Node.CONDITION); //å¦‚æœå°¾ç»“ç‚¹ä¸ºç©ºï¼Œè¯´æ˜é˜Ÿåˆ—ä¸ºç©ºï¼Œå½“å‰èŠ‚ç‚¹æ˜¯è¿›å…¥é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´  if (t == null) firstWaiter = node; //é˜Ÿåˆ—ä¸ä¸ºç©º else t.nextWaiter = node; lastWaiter = node; //è¿”å›å½“å‰çº¿ç¨‹å°è£…æˆçš„èŠ‚ç‚¹ return node;&#125; 6.AQS.fullyReleaseé‡Šæ”¾å½“å‰èŠ‚ç‚¹çº¿ç¨‹çš„å…¨éƒ¨é”èµ„æº æ­£å¸¸æƒ…å†µä¸‹æ˜¯ä¼šé‡Šæ”¾æˆåŠŸçš„ï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨æœªæŒæœ‰é”çš„çº¿ç¨‹è°ƒç”¨awaitæ–¹æ³•ï¼Œé”™è¯¯å†™æ³• è¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šå°†å½“å‰çº¿ç¨‹å¯¹åº”çš„nodeçŠ¶æ€ä¿®æ”¹ä¸ºå–æ¶ˆçŠ¶æ€ï¼Œåç»§çº¿ç¨‹åœ¨å‡å¦‚é˜Ÿåˆ—çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠå–æ¶ˆçŠ¶æ€çš„çº¿ç¨‹æ¸…ç†å‡ºå» å¦‚æœæˆåŠŸé‡Šæ”¾äº†é”ï¼Œä¼šè¿”å›å½“å‰çº¿ç¨‹é‡Šæ”¾çš„stateå€¼ï¼Œä¸ºä»€ä¹ˆè¦è¿”å›ï¼Ÿ å› ä¸ºå½“å‰èŠ‚ç‚¹è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—ä»¥åï¼Œå†æ¬¡è¢«å”¤é†’ï¼Œå¹¶ä¸”å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­æ˜¯å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è€Œä¸”stateçŠ¶æ€=0è¡¨ç¤ºæ— é”ï¼Œè¿™ä¸ªæ—¶å€™è¯´æ˜å½“å‰èŠ‚ç‚¹è¦å»ç«äº‰é”ï¼Œæ­¤æ—¶è¦å°†nodeçš„stateè®¾ç½®ä¸ºsavedStated 12345678910111213141516171819202122232425262728293031final int fullyRelease(Node node) &#123; /** * å®Œå…¨é‡Šæ”¾é”æ˜¯å¦æˆåŠŸ * å½“failedå¤±è´¥çš„æ—¶å€™ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯æœªæŒæœ‰é”è°ƒç”¨ await æ–¹æ³•çš„çº¿ç¨‹... é”™è¯¯å†™æ³• * å‡è®¾å¤±è´¥ï¼Œåœ¨finallyä»£ç å—ä¸­ ä¼šå°†åˆšåˆšåŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—çš„ å½“å‰çº¿ç¨‹å¯¹åº”çš„nodeçŠ¶æ€ ä¿®æ”¹ä¸º å–æ¶ˆçŠ¶æ€ * åç»§çº¿ç¨‹å°±ä¼šå°†å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ç»™æ¸…ç†å‡ºå»... */ boolean failed = true; try &#123; //è·å–å½“å‰çº¿ç¨‹æŒæœ‰çš„stateå€¼æ€»æ•° int savedState = getState(); //ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼šreleaseè¿™é‡Œä¼šè¿”å›true if (release(savedState)) &#123; //å¤±è´¥æ ‡è®°è®¾ç½®ä¸ºfalse failed = false; /** * è¿”å›å½“å‰çº¿ç¨‹é‡Šæ”¾çš„stateå€¼ * ä¸ºä»€ä¹ˆè¦è¿”å›ï¼Ÿ * å› ä¸ºå½“èŠ‚ç‚¹è¢«è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—ä»¥åï¼Œå†æ¬¡è¢«å”¤é†’ï¼Œä¸”å½“å‰nodeåœ¨é˜»å¡é˜Ÿåˆ—ä¸­æ˜¯head.next è€Œä¸” * å½“å‰lockçŠ¶æ€æ˜¯state=0 çš„æƒ…å†µä¸‹ å½“å‰node å¯ä»¥è·å–åˆ°é” æ­¤æ—¶éœ€è¦å°†state è®¾ç½®ä¸º savedState */ return savedState; &#125; else &#123; throw new IllegalMonitorStateException(); &#125; &#125; finally &#123; //å¦‚æœå¤±è´¥äº†ï¼Œå°±æŠŠå½“å‰èŠ‚ç‚¹çŠ¶æ€æ”¹æˆå–æ¶ˆ if (failed) node.waitStatus = Node.CANCELLED; &#125;&#125; æ­¤æ—¶ï¼ŒåŒæ­¥é˜Ÿåˆ—ä¼šè§¦å‘é”çš„é‡Šæ”¾å’Œé‡æ–°ç«äº‰ã€‚ThreadB è·å¾—äº†é”ã€‚ 7.isOnSyncQueueåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨é˜»å¡é˜Ÿåˆ— ç¬¬ä¸€ä¸ªifåˆ¤æ–­ï¼š èŠ‚ç‚¹çŠ¶æ€==-2è¯´æ˜å½“å‰èŠ‚ç‚¹ä¸€å®šåœ¨æ¡ä»¶é˜Ÿåˆ— å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸ºç©ºï¼šé¦–å…ˆåˆ†æå‰ç½®æ¡ä»¶ node çš„çŠ¶æ€è‚¯å®šä¸æ˜¯ -2 ï¼Œå¯èƒ½=0æˆ–è€…1ï¼Œç­‰äº1å°±è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯æœªæŒæœ‰é”çš„awaitï¼Œæœ€ç»ˆçŠ¶æ€ä¼šè¢«è®¾ç½®ä¸ºå–æ¶ˆï¼Œç­‰äº0å°±è¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»è¢«æŒæœ‰é”çš„çº¿ç¨‹å”¤é†’ï¼Œä½†æ˜¯å”¤é†’ä¹‹åæ˜¯å…ˆä¿®æ”¹çŠ¶æ€åœ¨å…¥é˜Ÿï¼Œæ‰€ä»¥å‰é©±èŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜æ­¤æ—¶æ˜¯å½“å‰èŠ‚ç‚¹å·²ç»è¢«å”¤é†’ï¼Œä½†æ˜¯è¿˜æœªè¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ã€‚ æ‰§è¡Œåˆ°ç¬¬äºŒä¸ªifï¼Œå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œè¯´æ˜ä¸€å®šåœ¨åŒæ­¥é˜Ÿåˆ—ï¼Œä¸ºå•¥é‚£ï¼Ÿ æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå¯ä»¥æ’é™¤æ‰å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´nodeçš„çŠ¶æ€ä¸€å®šä¸ç­‰äº1ï¼Œä¸ºå•¥ï¼Ÿå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ä¸ä¼šè¢«åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ— å…¥é˜Ÿçš„ä¸¤ä¸ªæ¡ä»¶ï¼šå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºtailï¼Œç„¶åcasè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºtailèŠ‚ç‚¹ï¼Œä¸¤ä¸ªæ¡ä»¶éƒ½æˆåŠŸäº†ï¼Œæ‰æ˜¯çœŸæ­£è¿›å…¥åˆ°äº†é˜»å¡é˜Ÿåˆ— æ‰€ä»¥è¯´ï¼Œå°±ç®—å‰é©±èŠ‚ç‚¹ä¸ç­‰äºç©ºï¼Œä¹Ÿä¸æ˜¯ä¸€å®šå°±æ˜¯è¿›å…¥äº†é˜»å¡é˜Ÿåˆ—ã€‚å¯èƒ½åœ¨è¿‡ç¨‹ä¸­ã€‚ å‰©ä¸‹æœ€åä¸€ç§æƒ…å†µå°±æ˜¯å½“å‰è¿™ä¸ªnodeèŠ‚ç‚¹å¯èƒ½è¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—äº†ï¼Œä½†æ˜¯è¿˜ä¸æ˜¯å°¾ç»“ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä»åå¾€å‰ä¾¿åˆ©æ‰¾åˆ°ä»–æ‰è¡Œï¼Œæ‰¾åˆ°äº†å°±è¿”å›trueï¼Œæ‰¾ä¸åˆ°è¯´æ˜å½“å‰è¿™ä¸ªèŠ‚ç‚¹æ­£åœ¨è¿ç§»ä¸­ï¼Œè¿”å›falseã€‚ 12345678910111213141516171819202122232425262728//åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨é˜»å¡é˜Ÿåˆ—final boolean isOnSyncQueue(Node node) &#123; /** * æ¡ä»¶1ï¼šnode.waitStatus==node.condition * æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰nodeä¸€å®šæ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—ï¼Œå› ä¸ºsignalæ–¹æ³•è¿ç§»èŠ‚ç‚¹åˆ°é˜»å¡é˜Ÿåˆ—å‰ï¼Œä¼šå°†nodeçš„çŠ¶æ€è®¾ç½®ä¸º0 * æ¡ä»¶2ï¼šå‰ç½®æ¡ä»¶ï¼šnode.waitStatus ï¼= Node.CONDITION ====&gt; * node.waitStatus ==0 : è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»è¢«signal * node.waitStatus ==1 : å½“å‰çº¿ç¨‹æ˜¯æœªæŒæœ‰é”è°ƒç”¨await æœ€ç»ˆè¿™ä¸ªèŠ‚ç‚¹å°†è¢«å–æ¶ˆ * node.waitStatus ==0 ä¸ºä»€ä¹ˆè¿˜è¦åˆ¤æ–­ node.prev == null ï¼Ÿ * å› ä¸ºsignalæ–¹æ³•æ˜¯å…ˆä¿®æ”¹çŠ¶æ€åœ¨è¿ç§» */ if (node.waitStatus == Node.CONDITION || node.prev == null) return false; /** * æ‰§è¡Œåˆ°è¿™é‡Œï¼Œ * node.waitStatus !=Condition ä¸” node.prev!=null ====&gt; å¯ä»¥æ’é™¤æ‰ node.waitStatus ==1 å–æ¶ˆçŠ¶æ€ * ä¸ºä»€ä¹ˆå¯ä»¥æ’é™¤æ‰å–æ¶ˆçŠ¶æ€ï¼Ÿå› ä¸ºsignalæ–¹æ³•æ˜¯ä¸ä¼šå§å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹è¿ç§»èµ°çš„ * è®¾ç½®prevå¼•ç”¨çš„é€»è¾‘æ˜¯è¿ç§»é˜»å¡é˜Ÿåˆ— é€»è¾‘çš„è®¾ç½®çš„ engæ–¹æ³• * å…¥é˜Ÿçš„é€»è¾‘ï¼š1.è®¾ç½®node.prev =tail * 2.caså½“å‰nodeä¸º é˜»å¡é˜Ÿåˆ—çš„tailèŠ‚ç‚¹æˆåŠŸæ‰ç®—æ˜¯çœŸæ­£çš„è¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ— * å¯ä»¥æ¨ç®—å‡ºï¼Œå°±ç®—æ˜¯prevä¸æ˜¯nullï¼Œä¹Ÿä¸èƒ½è¯´æ˜å½“å‰nodeå·²ç»æˆåŠŸå…¥é˜Ÿåˆ°é˜»å¡é˜Ÿåˆ—äº†ã€‚ */ if (node.next != null) return true; //æ‰§è¡Œåˆ°è¿™é‡Œä»é˜»å¡é˜Ÿåˆ—çš„å°¾å·´å¼€å§‹å‘å‰éå†æŸ¥æ‰¾nodeï¼Œæ‰¾åˆ°äº†å°±è¿”å›trueï¼Œæ‰¾ä¸åˆ°è¿”å›falseï¼Œ //å½“å‰nodeæœ‰å¯èƒ½æ­£åœ¨è¿ç§»ä¸­ï¼Œè¿˜æœªå®Œæˆã€‚ return findNodeFromTail(node);&#125; 8.signal é¦–å…ˆå½“å‰çº¿ç¨‹æŒæœ‰çš„å¿…é¡»æ˜¯ç‹¬å é”ï¼Œå¦åˆ™æ²¡æœ‰å¿…è¦è¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œæ‰€ä»¥å¦‚æœä¸æ˜¯ç‹¬å é”ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ è·å–åˆ°æ¡ä»¶é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ï¼Œå¦‚æœå¤´èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå°±è¯´æ˜æ¡ä»¶é˜Ÿåˆ—é‡Œé¢æœ‰èŠ‚ç‚¹ï¼Œå»å”¤é†’æ¡ä»¶é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚ 12345678910public final void signal() &#123; //åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯æŒæœ‰çš„ç‹¬å é”ï¼Œå¦‚æœä¸æ˜¯ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ if (!isHeldExclusively()) throw new IllegalMonitorStateException(); //è·å–æ¡ä»¶é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ Node first = firstWaiter; //å¦‚æœé¦–èŠ‚ç‚¹ä¸ä¸ºç©º if (first != null) doSignal(first);//å”¤é†’æ¡ä»¶é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹çº¿ç¨‹&#125; 9.doSignal å¦‚æœå¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜å¤´èŠ‚ç‚¹å‡ºé˜Ÿä¹‹åï¼Œå¤´èŠ‚ç‚¹ï¼Œå°¾ç»“ç‚¹éƒ½ä¼šæ˜¯ç©ºï¼Œä¹Ÿå°±æ˜¯æ¡ä»¶é˜Ÿåˆ—æ²¡æœ‰å…ƒç´ äº†ã€‚ æ–­å¼€å½“å‰å¤´èŠ‚ç‚¹çš„next è°ƒç”¨transferForSignalæ–¹æ³•å»è¿ç§»å¤´èŠ‚ç‚¹åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œå¦‚æœæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›falseã€‚ å¾ªç¯çš„æ¡ä»¶æ˜¯ï¼šå¦‚æœå½“å‰å¤´èŠ‚ç‚¹è¿ç§»å¤±è´¥äº†ï¼Œé‚£å°±å°†å¤´èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç»§ç»­å°è¯•ï¼Œç›´åˆ°è¿ç§»æˆåŠŸæˆ–è€…å¤´èŠ‚ç‚¹ä¸ºç©ºã€‚ 12345678910111213141516private void doSignal(Node first) &#123; do &#123; //å½“å‰firsté©¬ä¸Šè¦å‡ºé˜Ÿäº†ï¼Œæ‰€ä»¥æ›´æ–°firstWaiterä¸ºå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ //å¦‚æœå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯nullï¼Œè¯´æ˜æ¡ä»¶é˜Ÿåˆ—åªæœ‰å½“å‰ä¸€ä¸ªèŠ‚ç‚¹äº†...å½“å‰å‡ºé˜Ÿåï¼Œæ•´ä¸ªé˜Ÿåˆ—å°±ç©ºäº† //æ‰€ä»¥éœ€è¦æ›´æ–°lastWaiter==null if((firstWaiter=first.nextWaiter)==null) lastWaiter=null; //å½“å‰èŠ‚ç‚¹å³å°†å‡ºé˜Ÿåˆ—ï¼Œæ–­å¼€å’Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å…³ç³» first.nextWaiter = null; /** * transferForSignal(first) è¿”å›true å½“å‰firstèŠ‚ç‚¹è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—æˆåŠŸ false è¿ç§»å¤±è´¥ * whileå¾ªç¯ï¼š(first =firstWaiter)!=null å½“å‰first è¿ç§»å¤±è´¥ ï¼Œåˆ™å°†firstæ›´æ–°ä¸ºfirst.next ç»§ç»­å°è¯•è¿ç§» * ç›´è‡³è¿ç§»æŸä¸ªèŠ‚ç‚¹æˆåŠŸï¼Œæˆ–è€…æ¡ä»¶é˜Ÿåˆ—ä¸º null ä¸ºæ­¢ã€‚ */ &#125; while (!transferForSignal(first)&amp;&amp;(first =firstWaiter)!=null);&#125; 10.transferForSignalæ¥æ”¶åˆ°signalä¿¡å·ä»¥åï¼ŒæŠŠèŠ‚ç‚¹è½¬å…¥ç­‰å¾…é˜Ÿåˆ— é¦–å…ˆä¸Šæ¥å…ˆcaså°†nodeçš„çŠ¶æ€ä»-2è®¾ç½®ä¸º0ï¼Œè®¾ç½®æˆåŠŸæ‰ç»§ç»­å¾€ä¸‹ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¼šè®¾ç½®å¤±è´¥å‘¢ï¼Ÿ å½“å‰èŠ‚ç‚¹æ˜¯å–æ¶ˆçŠ¶æ€ï¼Œæˆ–è€…å½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹åœ¨æŒ‚èµ·æœŸé—´è¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨ä¸­æ–­ä¿¡å·å”¤é†’è¿‡ï¼Œè¿™ä¸ªæ—¶å€™èŠ‚ç‚¹ä¼šè¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ—¶å€™èŠ‚ç‚¹çš„çŠ¶æ€ä¹Ÿä¼šä¿®æ”¹æˆ0 ä½¿ç”¨enqæ–¹æ³•æ·»åŠ å½“å‰èŠ‚ç‚¹åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œå¹¶è¿”å›å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ å¦‚æœå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€å¤§äº0å°±è¯´æ˜å‰é©±ç»“ç‚¹çš„çŠ¶æ€æ˜¯å–æ¶ˆçŠ¶æ€ï¼Œ ç¬¬äºŒä¸ªæ¡ä»¶çš„å‰ç½®æ¡ä»¶å°±æ˜¯å‰é©±èŠ‚ç‚¹çŠ¶æ€å°äº0ï¼Œcasè®¾ç½®å‰é©±èŠ‚ç‚¹ä¸ºsignalï¼Œ å¦‚æœæ¡ä»¶ä¸€æˆ–è€…æ¡ä»¶äºŒæˆç«‹ä¸€ä¸ªï¼Œé‚£å°±å”¤é†’å½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹ 12345678910111213141516171819202122232425262728293031//æ¥æ”¶åˆ°signalä¿¡å·åï¼ŒæŠŠèŠ‚ç‚¹è½¬å…¥ç­‰å¾…é˜Ÿåˆ—final boolean transferForSignal(Node node) &#123; /** * casä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä¿®æ”¹ä¸º0ï¼Œå› ä¸ºå½“å‰èŠ‚ç‚¹é©¬ä¸Šè¦è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº† * æˆåŠŸï¼šå½“å‰èŠ‚ç‚¹åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­çŠ¶æ€æ­£å¸¸ * å¤±è´¥ï¼š * 1.å–æ¶ˆçŠ¶æ€ ï¼ˆçº¿ç¨‹awaitæ—¶ï¼ŒæœªæŒæœ‰é”ï¼Œæœ€ç»ˆçº¿ç¨‹å¯¹åº”çš„nodeå°†ä¼šè¢«è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€ï¼‰ * 2.nodeå¯¹åº”çš„çº¿ç¨‹ æŒ‚èµ·æœŸé—´ï¼Œè¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨ä¸­æ–­ä¿¡å·å”¤é†’è¿‡...ï¼ˆå°±ä¼šä¸»åŠ¨è¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œè¿™æ—¶ * ä¹Ÿä¼šä¿®æ”¹çŠ¶æ€ä¸º0ï¼‰ */ if (!compareAndSetWaitStatus(node, Node.CONDITION, 0)) return false; //æ·»åŠ èŠ‚ç‚¹åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶è¿”å›èŠ‚ç‚¹çš„å‰ç»§èŠ‚ç‚¹(prev) Node p = enq(node); //ws:å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ int ws = p.waitStatus; /** * æ¡ä»¶1ï¼šws&gt;0æˆç«‹ï¼šè¯´æ˜å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€åœ¨é˜»å¡é˜Ÿåˆ—ä¸­æ˜¯å–æ¶ˆçŠ¶æ€ï¼Œå”¤é†’å½“å‰èŠ‚ç‚¹ * æ¡ä»¶2ï¼šå‰ç½®æ¡ä»¶ ws&lt;=0 * cas è¿”å›trueè¡¨ç¤ºè®¾ç½®å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºsignalçŠ¶æ€æˆåŠŸ * casè¿”å›falseï¼Œä»€ä¹ˆæ—¶å€™è¿”å›falseï¼Ÿ * å½“å‰é©±nodeå¯¹åº”çš„çº¿ç¨‹æ˜¯lockInterruptå…¥é˜Ÿçš„nodeæ—¶ï¼Œæ˜¯ä¼šå“åº”ä¸­æ–­çš„ï¼Œå¤–éƒ¨çº¿ç¨‹ç»™å‰é©±çº¿ç¨‹ä¸­æ–­ä¿¡å·ä¹‹å * å‰é©±nodeä¼šå°†çŠ¶æ€ä¿®æ”¹ä¸º å–æ¶ˆçŠ¶æ€ï¼Œå¹¶ä¸”æ‰§è¡Œå‡ºé˜Ÿé€»è¾‘... * å‰é©±èŠ‚ç‚¹çŠ¶æ€åªè¦ä¸æ˜¯0 æˆ–è€… -1 ï¼Œé‚£ä¹ˆå°±å”¤é†’å½“å‰çº¿ç¨‹ */ if (ws &gt; 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL)) //å¦‚æœå‰èŠ‚ç‚¹è¢«å–æ¶ˆï¼Œè¯´æ˜å½“å‰ä¸ºæœ€åä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼Œunparkå”¤é†’å½“å‰çº¿ç¨‹ LockSupport.unpark(node.thread); //å¦‚æœ node çš„ prev èŠ‚ç‚¹å·²ç»æ˜¯signal çŠ¶æ€ï¼Œé‚£ä¹ˆè¢«é˜»å¡çš„ ThreadA çš„å”¤é†’å·¥ä½œç”± AQS é˜Ÿåˆ—æ¥å®Œæˆ return true;&#125; æ‰§è¡Œå®Œ doSignal ä»¥åï¼Œä¼šæŠŠ condition é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹è½¬ç§»åˆ° aqs é˜Ÿåˆ—ä¸Šï¼Œé€»è¾‘ç»“æ„å›¾å¦‚ä¸‹ï¼Œè¿™ä¸ªæ—¶å€™ä¼šåˆ¤æ–­ ThreadA çš„ prev èŠ‚ç‚¹ä¹Ÿå°±æ˜¯ head èŠ‚ç‚¹çš„ waitStatusï¼Œå¦‚æœå¤§äº 0 æˆ–è€…è®¾ç½® SIGNAL å¤±è´¥ï¼Œè¡¨ç¤ºèŠ‚ç‚¹è¢«è®¾ç½®æˆäº† CANCELLED çŠ¶æ€ã€‚è¿™ä¸ªæ—¶å€™ä¼šå”¤é†’ThreadA è¿™ä¸ªçº¿ç¨‹ã€‚å¦åˆ™å°±åŸºäº AQS é˜Ÿåˆ—çš„æœºåˆ¶æ¥å”¤é†’ï¼Œä¹Ÿå°±æ˜¯ç­‰åˆ° ThreadB é‡Šæ”¾é”ä¹‹åæ¥å”¤é†’ ThreadAã€‚ å†å¾€ä¸‹å°±æ˜¯è¢«é˜»å¡çš„çº¿ç¨‹å”¤é†’ä¹‹åçš„é€»è¾‘ã€‚â€‹ 11.AQS.awaitâ€‹ å‰é¢åœ¨åˆ†æ await æ–¹æ³•æ—¶ï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚è€Œé€šè¿‡ signalè¢«å”¤é†’ä¹‹ååˆç»§ç»­å›åˆ°ä¸Šæ¬¡æ‰§è¡Œçš„é€»è¾‘ä¸­ã€‚â€‹ checkInterruptWhileWaiting è¿™ä¸ªæ–¹æ³•æ˜¯å¹²å˜›å‘¢ï¼Ÿå…¶å®ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œå°±æ˜¯ ThreadA åœ¨ condition é˜Ÿåˆ—è¢«é˜»å¡çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹è§¦å‘è¿‡ä¸­æ–­è¯·æ±‚ã€‚â€‹ 123456789101112131415161718192021222324252627public final void await() throws InterruptedException &#123; if (Thread.interrupted())//è¡¨ç¤º await å…è®¸è¢«ä¸­æ–­ throw new InterruptedException(); Node node = addConditionWaiter();//åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çŠ¶æ€ä¸º conditionï¼Œé‡‡ç”¨çš„æ•°æ®ç»“æ„ä»ç„¶æ˜¯é“¾è¡¨ int savedState = fullyRelease(node); //é‡Šæ”¾å½“å‰çš„é”ï¼Œå¾—åˆ°é”çš„çŠ¶æ€ï¼Œå¹¶å”¤é†’ AQS é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ int interruptMode = 0; //å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰åœ¨åŒæ­¥é˜Ÿåˆ—ä¸Šï¼Œå³è¿˜æ²¡æœ‰è¢« signalï¼Œåˆ™å°†å½“å‰çº¿ç¨‹é˜»å¡ while (!isOnSyncQueue(node)) &#123;//åˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹æ˜¯å¦åœ¨ AQS é˜Ÿåˆ—ä¸Šï¼Œç¬¬ä¸€æ¬¡åˆ¤æ–­çš„æ˜¯ falseï¼Œå› ä¸ºå‰é¢å·²ç»é‡Šæ”¾é”äº† LockSupport.park(this);//é€šè¿‡ park æŒ‚èµ·å½“å‰çº¿ç¨‹ if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; &#125; // å½“è¿™ä¸ªçº¿ç¨‹é†’æ¥,ä¼šå°è¯•æ‹¿é”, å½“ acquireQueuedè¿”å› false å°±æ˜¯æ‹¿åˆ°é”äº†. // interruptMode != THROW_IE -&gt; è¡¨ç¤ºè¿™ä¸ªçº¿ç¨‹æ²¡æœ‰æˆåŠŸå°† node å…¥é˜Ÿ,ä½† signal æ‰§è¡Œäº† enq æ–¹æ³•è®©å…¶å…¥é˜Ÿäº†. // å°†è¿™ä¸ªå˜é‡è®¾ç½®æˆ REINTERRUPT if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) interruptMode = REINTERRUPT; // å¦‚æœ node çš„ä¸‹ä¸€ä¸ªç­‰å¾…è€…ä¸æ˜¯ null, åˆ™è¿›è¡Œæ¸…ç†,æ¸…ç† Condition é˜Ÿåˆ—ä¸Šçš„èŠ‚ç‚¹. // å¦‚æœæ˜¯ null ,å°±æ²¡æœ‰ä»€ä¹ˆå¥½æ¸…ç†çš„äº†. if (node.nextWaiter != null) // clean up if cancelled unlinkCancelledWaiters(); // å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­äº†,éœ€è¦æŠ›å‡ºå¼‚å¸¸.æˆ–è€…ä»€ä¹ˆéƒ½ä¸åš if (interruptMode != 0) reportInterruptAfterWait(interruptMode);&#125; 12.checkInterruptWhileWaitingâ€‹ å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™è°ƒç”¨transferAfterCancelledWait æ–¹æ³•åˆ¤æ–­åç»­çš„å¤„ç†åº”è¯¥æ˜¯æŠ›å‡º InterruptedException è¿˜æ˜¯é‡æ–°ä¸­æ–­ã€‚â€‹ è¿™é‡Œéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œå¦‚æœç¬¬ä¸€æ¬¡ CAS å¤±è´¥äº†ï¼Œåˆ™ä¸èƒ½åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å…ˆè¿›è¡Œäº†ä¸­æ–­è¿˜æ˜¯å…ˆè¿›è¡Œäº† signal æ–¹æ³•çš„è°ƒç”¨ï¼Œå¯èƒ½æ˜¯å…ˆæ‰§è¡Œäº† signal ç„¶åä¸­æ–­ï¼Œä¹Ÿå¯èƒ½æ˜¯å…ˆæ‰§è¡Œäº†ä¸­æ–­ï¼Œåæ‰§è¡Œäº† signalï¼Œå½“ç„¶ï¼Œè¿™ä¸¤ä¸ªæ“ä½œè‚¯å®šæ˜¯å‘ç”Ÿåœ¨ CAS ä¹‹å‰ã€‚è¿™æ—¶éœ€è¦åšçš„å°±æ˜¯ç­‰å¾…å½“å‰çº¿ç¨‹çš„ nodeè¢«æ·»åŠ åˆ° AQS é˜Ÿåˆ—åï¼Œä¹Ÿå°±æ˜¯ enq æ–¹æ³•è¿”å›åï¼Œè¿”å›false å‘Šè¯‰ checkInterruptWhileWaiting æ–¹æ³•è¿”å›REINTERRUPT(1)ï¼Œåç»­è¿›è¡Œé‡æ–°ä¸­æ–­ã€‚â€‹ ç®€å•æ¥è¯´ï¼Œè¯¥æ–¹æ³•çš„è¿”å›å€¼ä»£è¡¨å½“å‰çº¿ç¨‹æ˜¯å¦åœ¨ park çš„æ—¶å€™è¢«ä¸­æ–­å”¤é†’ï¼Œå¦‚æœä¸º true è¡¨ç¤ºä¸­æ–­åœ¨ signal è°ƒç”¨ä¹‹å‰ï¼Œsignal è¿˜æœªæ‰§è¡Œï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä¼šæ ¹æ® await çš„è¯­ä¹‰ï¼Œåœ¨ await æ—¶é‡åˆ°ä¸­æ–­éœ€è¦æŠ›å‡ºinterruptedExceptionï¼Œè¿”å› true å°±æ˜¯å‘Šè¯‰checkInterruptWhileWaiting è¿”å› THROW_IE(-1)ã€‚å¦‚æœè¿”å› falseï¼Œå¦åˆ™è¡¨ç¤º signal å·²ç»æ‰§è¡Œè¿‡äº†ï¼Œåªéœ€è¦é‡æ–°å“åº”ä¸­æ–­å³å¯ã€‚â€‹ 12345private int checkInterruptWhileWaiting(Node node) &#123; return Thread.interrupted() ? (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) : 0;&#125; 12345678910111213final boolean transferAfterCancelledWait(Node node) &#123; //ä½¿ç”¨ cas ä¿®æ”¹èŠ‚ç‚¹çŠ¶æ€ï¼Œå¦‚æœè¿˜èƒ½ä¿®æ”¹æˆåŠŸï¼Œè¯´æ˜çº¿ç¨‹è¢«ä¸­æ–­æ—¶ï¼Œsignal è¿˜æ²¡æœ‰è¢«è°ƒç”¨ã€‚// è¿™é‡Œæœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œå°±æ˜¯çº¿ç¨‹è¢«å”¤é†’ï¼Œå¹¶ä¸ä¸€å®šæ˜¯åœ¨ java å±‚é¢æ‰§è¡Œäº†locksupport.unparkï¼Œä¹Ÿå¯èƒ½æ˜¯è°ƒç”¨äº†çº¿ç¨‹çš„ interrupt()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæ›´æ–°ä¸€ä¸ªä¸­æ–­æ ‡è¯†ï¼Œå¹¶ä¸”ä¼šå”¤é†’å¤„äºé˜»å¡çŠ¶æ€ä¸‹çš„çº¿ç¨‹ã€‚ if (compareAndSetWaitStatus(node, Node.CONDITION, 0)) &#123; enq(node);//å¦‚æœ cas æˆåŠŸï¼Œåˆ™æŠŠnode æ·»åŠ åˆ° AQS é˜Ÿåˆ— return true; &#125;// å¦‚æœ cas å¤±è´¥ï¼Œåˆ™åˆ¤æ–­å½“å‰ node æ˜¯å¦å·²ç»åœ¨ AQS é˜Ÿåˆ—ä¸Šï¼Œå¦‚æœä¸åœ¨ï¼Œåˆ™è®©ç»™å…¶ä»–çº¿ç¨‹æ‰§è¡Œ// å½“ node è¢«è§¦å‘äº† signal æ–¹æ³•æ—¶ï¼Œ node å°±ä¼šè¢«åŠ åˆ° aqs é˜Ÿåˆ—ä¸Š while (!isOnSyncQueue(node))//å¾ªç¯æ£€æµ‹ node æ˜¯å¦å·²ç»æˆåŠŸæ·»åŠ åˆ° AQS é˜Ÿåˆ—ä¸­ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™é€šè¿‡ yield Thread.yield();//ä½¿å½“å‰çº¿ç¨‹ç”±æ‰§è¡ŒçŠ¶æ€ï¼Œå˜æˆä¸ºå°±ç»ªçŠ¶æ€ï¼Œè®©å‡ºcpuæ—¶é—´ï¼Œåœ¨ä¸‹ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ—¶å€™ï¼Œæ­¤çº¿ç¨‹æœ‰å¯èƒ½è¢«æ‰§è¡Œï¼Œä¹Ÿæœ‰å¯èƒ½æ²¡æœ‰è¢«æ‰§è¡Œã€‚ return false;&#125; 12.AQS.acquireQueuedâ€‹ è¿™ä¸ªæ–¹æ³•æ˜¯å½“å‰è¢«å”¤é†’çš„èŠ‚ç‚¹ThreadA å»æŠ¢å åŒæ­¥é”ã€‚å¹¶ä¸”è¦æ¢å¤åˆ°åŸæœ¬çš„é‡å…¥æ¬¡æ•°çŠ¶æ€ã€‚è°ƒç”¨å®Œè¿™ä¸ªæ–¹æ³•ä¹‹åï¼ŒAQS é˜Ÿåˆ—çš„çŠ¶æ€å¦‚ä¸‹ï¼šâ€‹ å°† head èŠ‚ç‚¹çš„ waitStatus è®¾ç½®ä¸º-1ï¼ŒSignal çŠ¶æ€ã€‚â€‹ 12.reportInterruptAfterWaitæ ¹æ® checkInterruptWhileWaiting æ–¹æ³•è¿”å›çš„ä¸­æ–­æ ‡è¯†æ¥è¿›è¡Œä¸­æ–­ä¸ŠæŠ¥ã€‚ å¦‚æœæ˜¯ THROW_IEï¼Œåˆ™æŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚â€‹ å¦‚æœæ˜¯ REINTERRUPTï¼Œåˆ™é‡æ–°å“åº”ä¸­æ–­ã€‚â€‹ 1234567private void reportInterruptAfterWait(int interruptMode) throws InterruptedException &#123; if (interruptMode == THROW_IE) throw new InterruptedException(); else if (interruptMode == REINTERRUPT) selfInterrupt();&#125; 13.æ€»ç»“ä¸æ¢³ç†çº¿ç¨‹ awaitThread å…ˆé€šè¿‡ lock.lock()æ–¹æ³•è·å–é”æˆåŠŸåè°ƒç”¨äº† condition.await æ–¹æ³•è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹ signalThread é€šè¿‡ lock.lock()æ–¹æ³•è·å–é”æˆåŠŸåè°ƒç”¨äº† condition.signal æˆ–è€… signalAll æ–¹æ³•ï¼Œä½¿å¾—çº¿ç¨‹awaitThread èƒ½å¤Ÿæœ‰æœºä¼šç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå½“å…¶ä»–çº¿ç¨‹é‡Šæ”¾ lock åä½¿å¾—çº¿ç¨‹ awaitThread èƒ½å¤Ÿæœ‰æœºä¼šè·å–lockï¼Œä»è€Œä½¿å¾—çº¿ç¨‹ awaitThread èƒ½å¤Ÿä» await æ–¹æ³•ä¸­é€€å‡ºæ‰§è¡Œåç»­æ“ä½œã€‚å¦‚æœ awaitThread è·å– lock å¤±è´¥ä¼šç›´æ¥è¿›å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ã€‚â€‹ â€‹ é˜»å¡ï¼šawait()æ–¹æ³•ä¸­ï¼Œåœ¨çº¿ç¨‹é‡Šæ”¾é”èµ„æºä¹‹åï¼Œå¦‚æœèŠ‚ç‚¹ä¸åœ¨ AQS ç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ™é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœåœ¨ç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ™è‡ªæ—‹ç­‰å¾…å°è¯•è·å–é”ã€‚â€‹ é‡Šæ”¾ï¼šsignal()åï¼ŒèŠ‚ç‚¹ä¼šä» condition é˜Ÿåˆ—ç§»åŠ¨åˆ° AQSç­‰å¾…é˜Ÿåˆ—ï¼Œåˆ™è¿›å…¥æ­£å¸¸é”çš„è·å–æµç¨‹ã€‚â€‹","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"CompletableFuture","slug":"JUC/CompletableFuture","date":"2022-01-11T11:06:39.043Z","updated":"2022-01-11T11:26:51.313Z","comments":true,"path":"2022/01/11/JUC/CompletableFuture/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/CompletableFuture/","excerpt":"","text":"ä¸€ï¼Œå‰ç½®çŸ¥è¯†1ï¼Œç”¨æˆ·çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹1.æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œç¨‹åºå°±ä¼šé€€å‡ºï¼Œä¸å†ç­‰å¾…å®ˆæŠ¤çº¿ç¨‹ã€‚123public static void main(String[] args) &#123; new Thread(()-&gt; System.out.println(&quot;å½“å‰çº¿ç¨‹&quot;+Thread.currentThread().getName()+&quot;æ˜¯&quot;+(Thread.currentThread().isDaemon()?&quot;å®ˆæŠ¤çº¿ç¨‹&quot;:&quot;ç”¨æˆ·çº¿ç¨‹&quot;))).start();&#125; 2.ç”¨æˆ·çº¿ç¨‹ä¸ç»“æŸï¼Œç¨‹åºå°±ä¸ä¼šé€€å‡º123456789101112public class DemoA &#123; public static void main(String[] args) &#123; Thread thread = new Thread(DemoA::run,&quot;çº¿ç¨‹1&quot;); thread.start(); &#125; private static void run() &#123; System.out.println(&quot;å½“å‰çº¿ç¨‹&quot; + Thread.currentThread().getName() + &quot;æ˜¯&quot; + (Thread.currentThread().isDaemon() ? &quot;å®ˆæŠ¤çº¿ç¨‹&quot; : &quot;ç”¨æˆ·çº¿ç¨‹&quot;)); while (true) ; &#125;&#125; 3.ä¸ç®¡å®ˆæŠ¤çº¿ç¨‹ç»“æŸæ²¡æœ‰ï¼Œåªè¦ç”¨æˆ·çº¿ç¨‹ç»“æŸï¼Œç¨‹åºå°±ä¼šé€€å‡º1234567891011121314public class DemoA &#123; public static void main(String[] args) &#123; Thread thread = new Thread(DemoA::run,&quot;çº¿ç¨‹1&quot;); //å°†çº¿ç¨‹1è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ thread.setDaemon(true); thread.start(); &#125; private static void run() &#123; System.out.println(&quot;å½“å‰çº¿ç¨‹&quot; + Thread.currentThread().getName() + &quot;æ˜¯&quot; + (Thread.currentThread().isDaemon() ? &quot;å®ˆæŠ¤çº¿ç¨‹&quot; : &quot;ç”¨æˆ·çº¿ç¨‹&quot;)); while (true) ; &#125;&#125; 2.å›é¦–FutureTask1.FutureTaskå­˜åœ¨çš„é—®é¢˜123456789101112131415161718192021222324252627public class Demob &#123; public static void main(String[] args)throws Exception &#123; FutureTask&lt;String&gt; futureTask = new FutureTask&lt;&gt;(Demob::call); new Thread(futureTask,&quot;t1&quot;).start(); //å¼‚æ­¥ç»“æœé›†çš„å±•ç° ---- ä¼šé˜»å¡ //System.out.println(futureTask.get()); //è½®è¯¢çš„æ–¹å¼å»é—® --- æ¶ˆè€—cpuèµ„æº while (true) &#123; if (futureTask.isDone())&#123; System.out.println(futureTask.get()); break; &#125; &#125; System.out.println(&quot;mainç»“æŸ&quot;); &#125; private static String call() &#123; try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return &quot;yhd&quot;; &#125;&#125; ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºFutureTaskå­˜åœ¨çš„é—®é¢˜ï¼š get()å¼‚æ­¥ç»“æœé›†çš„å±•ç° â€”- ä¼šé˜»å¡ futureTask.isDone()è½®è¯¢çš„æ–¹å¼å»é—® â€” æ¶ˆè€—cpuèµ„æº 2.æƒ³å®Œæˆä¸€äº›å¤æ‚çš„ä»»åŠ¡ åº”å¯¹Futureçš„å®Œæˆæ—¶é—´ï¼Œå®Œæˆäº†å¯ä»¥å‘Šè¯‰æˆ‘ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„å›è°ƒé€šçŸ¥ã€‚ å°†ä¸¤ä¸ªå¼‚æ­¥è®¡ç®—åˆæˆä¸€ä¸ªå¼‚æ­¥è®¡ç®—ï¼Œè¿™ä¸¤ä¸ªå¼‚æ­¥è®¡ç®—äº’ç›¸ç‹¬ç«‹ï¼ŒåŒæ—¶ç¬¬äºŒä¸ªåˆä¾èµ–ç¬¬ä¸€ä¸ªçš„ç»“æœã€‚ å½“Futureé›†åˆä¸­æŸä¸ªä»»åŠ¡æœ€å¿«ç»“æŸæ—¶ï¼Œè¿”å›ç»“æœã€‚ ç­‰å¾…Futureé›†åˆä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆã€‚ äºŒï¼ŒCompletableFuture1.ä»‹ç» å¼‚æ­¥å‡½æ•°å¼ç¼–ç¨‹ï¼ŒFutureæ¥å£çš„æ‰©å±•ä¸å¢å¼ºç‰ˆã€‚ å¯ä»¥é€šè¿‡å›è°ƒçš„æ–¹å¼å¤„ç†è®¡ç®—ç»“æœï¼Œå¹¶ä¸”æä¾›äº†è½¬æ¢å’Œç»„åˆCompletableFutureçš„æ–¹æ³•ã€‚ å®Œæˆé€šçŸ¥å›è°ƒ ç±»ä¼¼Linuxç®¡é“ç¬¦çš„å½¢å¼ï¼Œå¯ä»¥å¼‚æ­¥çš„è®¡ç®—ï¼Œä¸Šä¸€ä¸ªè®¡ç®—ç»“æœå¯ä»¥ç»™ä¸‹ä¸€ä¸ªï¼Œç»“åˆlambdaè¡¨è¾¾å¼å’Œå‡½æ•°å¼ç¼–ç¨‹ä¸²èµ·æ¥è½¬æ¢å’Œç»„åˆè·å¾—ç»“æœã€‚ 2.å®ä¾‹åŒ–å¦‚æœä¸æŒ‡å®šçº¿ç¨‹æ± ï¼Œé»˜è®¤æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚ 123456789101112public class DemoC &#123; private static ThreadPoolExecutor pool=new ThreadPoolExecutor(1,5,1, TimeUnit.SECONDS,new ArrayBlockingQueue&lt;&gt;(1)); public static void main(String[] args) throws Exception&#123; //åˆ›å»ºä¸€ä¸ªæœ‰è¿”å›ç»“æœçš„å®ä¾‹ CompletableFuture&lt;String&gt; supplyAsync = CompletableFuture.supplyAsync(() -&gt; &quot;yhd&quot;, pool); //åˆ›å»ºä¸€ä¸ªæ²¡æœ‰è¿”å›ç»“æœçš„å®ä¾‹ CompletableFuture&lt;Void&gt; runAsync = CompletableFuture.runAsync(System.out::println); pool.shutdown(); &#125;&#125; 3.å¼‚æ­¥+å›è°ƒwhenComplete å’Œ join çš„åŒºåˆ«ï¼š ä¸€ä¸ªæ˜¯æ‰§è¡Œå®Œè¿”å›ç»“æœï¼Œä¸€ä¸ªæ˜¯ä¸»åŠ¨è·å–ç»“æœã€‚ whenCompleteï¼šæ˜¯æ‰§è¡Œå½“å‰ä»»åŠ¡çš„çº¿ç¨‹æ‰§è¡Œç»§ç»­æ‰§è¡Œ whenComplete çš„ä»»åŠ¡ã€‚whenCompleteAsyncï¼šæ˜¯æ‰§è¡ŒæŠŠ whenCompleteAsync è¿™ä¸ªä»»åŠ¡ç»§ç»­æäº¤ç»™çº¿ç¨‹æ± æ¥è¿›è¡Œæ‰§è¡Œã€‚æ–¹æ³•ä¸ä»¥Asyncç»“å°¾ï¼Œæ„å‘³ç€Actionä½¿ç”¨ç›¸åŒçš„çº¿ç¨‹æ‰§è¡Œï¼Œè€ŒAsyncå¯èƒ½ä¼šä½¿ç”¨å…¶ä»–çº¿ç¨‹æ‰§è¡Œï¼ˆå¦‚æœæ˜¯ä½¿ç”¨ç›¸åŒçš„çº¿ç¨‹æ± ï¼Œä¹Ÿå¯èƒ½ä¼šè¢«åŒä¸€ä¸ªçº¿ç¨‹é€‰ä¸­æ‰§è¡Œï¼‰ 1234567891011121314public class DemoC &#123; private static ThreadPoolExecutor pool=new ThreadPoolExecutor(1,5,1, TimeUnit.SECONDS,new ArrayBlockingQueue&lt;&gt;(1)); public static void main(String[] args) throws Exception&#123; //åˆ›å»ºä¸€ä¸ªæœ‰è¿”å›ç»“æœçš„å®ä¾‹ è®¡ç®—å®Œæˆæ—¶å›è°ƒ å‘ç”Ÿå¼‚å¸¸æ—¶æ‰§è¡Œ CompletableFuture.supplyAsync(() -&gt; &quot;yhd&quot;, pool).whenComplete(DemoC::accept).exceptionally(Throwable::toString); pool.shutdown(); &#125; private static void accept(String result, Throwable e) &#123; System.out.println(result); &#125;&#125; 4.ç»“æœå¤„ç†handle æ˜¯æ‰§è¡Œä»»åŠ¡å®Œæˆæ—¶å¯¹ç»“æœçš„å¤„ç†ã€‚handle æ˜¯åœ¨ä»»åŠ¡å®Œæˆåå†æ‰§è¡Œï¼Œè¿˜å¯ä»¥å¤„ç†å¼‚å¸¸çš„ä»»åŠ¡ã€‚ 12345678910111213141516/** * @author yhd * @createtime 2020/11/15 23:10 */public class DemoB &#123; public static void main(String[] args) &#123; CompletableFuture.supplyAsync(()-&gt;&quot;å°¹ä¼šä¸œ&quot;).handle(DemoB::apply).whenCompleteAsync(((s, throwable) -&gt; System.out.println(s))); &#125; private static String apply(String s, Throwable throwable) &#123; if (null != throwable) return throwable.getMessage(); return s + &quot; ç‰›é€¼ï¼&quot;; &#125;&#125; 5.çº¿ç¨‹ä¸²è¡ŒåŒ–thenApply æ–¹æ³•ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ä¾èµ–å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œè·å–ä¸Šä¸€ä¸ªä»»åŠ¡è¿”å›çš„ç»“æœï¼Œå¹¶è¿”å›å½“å‰ä»»åŠ¡çš„è¿”å›å€¼ã€‚thenAcceptæ–¹æ³•ï¼šæ¶ˆè´¹å¤„ç†ç»“æœã€‚æ¥æ”¶ä»»åŠ¡çš„å¤„ç†ç»“æœï¼Œå¹¶æ¶ˆè´¹å¤„ç†ï¼Œæ— è¿”å›ç»“æœã€‚thenRunæ–¹æ³•ï¼šåªè¦ä¸Šé¢çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå°±å¼€å§‹æ‰§è¡ŒthenRunï¼Œåªæ˜¯å¤„ç†å®Œä»»åŠ¡åï¼Œæ‰§è¡Œ thenRunçš„åç»­æ“ä½œå¸¦æœ‰Asyncé»˜è®¤æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚è¿™é‡Œæ‰€è°“çš„å¼‚æ­¥æŒ‡çš„æ˜¯ä¸åœ¨å½“å‰çº¿ç¨‹å†…æ‰§è¡Œã€‚ 123456789public class DemoE &#123; public static void main(String[] args) &#123; CompletableFuture&lt;Integer&gt; thenApply = CompletableFuture.supplyAsync(() -&gt; 1).thenApply(integer -&gt; 1); CompletableFuture&lt;Void&gt; thenAccept = CompletableFuture.supplyAsync(() -&gt; 1).thenAccept(System.out::println); CompletableFuture&lt;Void&gt; thenRun = CompletableFuture.supplyAsync(() -&gt; 1).thenRun(System.out::println); System.out.println(thenApply.join()); &#125;&#125; 6.ä»»åŠ¡ç»„åˆ1.ä¸¤ä»»åŠ¡ç»„åˆ - éƒ½è¦å®Œæˆä¸¤ä¸ªä»»åŠ¡å¿…é¡»éƒ½å®Œæˆï¼Œè§¦å‘è¯¥ä»»åŠ¡ã€‚ thenCombineï¼šç»„åˆä¸¤ä¸ªfutureï¼Œè·å–ä¸¤ä¸ªfutureä»»åŠ¡çš„è¿”å›ç»“æœï¼Œå¹¶è¿”å›å½“å‰ä»»åŠ¡çš„è¿”å›å€¼thenAcceptBothï¼šç»„åˆä¸¤ä¸ªfutureï¼Œè·å–ä¸¤ä¸ªfutureä»»åŠ¡çš„è¿”å›ç»“æœï¼Œç„¶åå¤„ç†ä»»åŠ¡ï¼Œæ²¡æœ‰è¿”å›å€¼ã€‚runAfterBothï¼šç»„åˆä¸¤ä¸ªfutureï¼Œä¸éœ€è¦è·å–futureçš„ç»“æœï¼Œåªéœ€ä¸¤ä¸ªfutureå¤„ç†å®Œä»»åŠ¡åï¼Œå¤„ç†è¯¥ä»»åŠ¡ã€‚ 12345678910111213141516public class DemoF &#123; public static void main(String[] args) &#123; CompletableFuture .supplyAsync(() -&gt; &quot;hello&quot;) .thenApplyAsync(t -&gt; t + &quot; world!&quot;) .thenCombineAsync( CompletableFuture .completedFuture(&quot; CompletableFuture&quot;), (t, u) -&gt; t + u) .whenComplete(DemoF::accept); &#125; private static void accept(String t, Throwable u) &#123; System.out.println(t); &#125;&#125; 2.ä¸¤ä»»åŠ¡ç»„åˆ - ä¸€ä¸ªå®Œæˆå½“ä¸¤ä¸ªä»»åŠ¡ä¸­ï¼Œä»»æ„ä¸€ä¸ªfutureä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œæ‰§è¡Œä»»åŠ¡ã€‚applyToEitherï¼šä¸¤ä¸ªä»»åŠ¡æœ‰ä¸€ä¸ªæ‰§è¡Œå®Œæˆï¼Œè·å–å®ƒçš„è¿”å›å€¼ï¼Œå¤„ç†ä»»åŠ¡å¹¶æœ‰æ–°çš„è¿”å›å€¼ã€‚acceptEitherï¼šä¸¤ä¸ªä»»åŠ¡æœ‰ä¸€ä¸ªæ‰§è¡Œå®Œæˆï¼Œè·å–å®ƒçš„è¿”å›å€¼ï¼Œå¤„ç†ä»»åŠ¡ï¼Œæ²¡æœ‰æ–°çš„è¿”å›å€¼ã€‚runAfterEitherï¼šä¸¤ä¸ªä»»åŠ¡æœ‰ä¸€ä¸ªæ‰§è¡Œå®Œæˆï¼Œä¸éœ€è¦è·å–futureçš„ç»“æœï¼Œå¤„ç†ä»»åŠ¡ï¼Œä¹Ÿæ²¡æœ‰è¿”å›å€¼ 3.å¤šä»»åŠ¡ç»„åˆallOfï¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®ŒæˆanyOfï¼šåªè¦æœ‰ä¸€ä¸ªä»»åŠ¡å®Œæˆ 7.è®¡ç®—æ¥å£æ€§èƒ½1.ä¸€æ·˜123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566/** * @author yhd * @createtime 2020/11/15 15:11 * æŸ¥è¯¢å¤šä¸ªç”µå•†ç½‘ç«™åŒä¸€ä¸ªå•†å“çš„ä»·æ ¼ * åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼ */public class DemoD &#123; static List&lt;Gmall&gt; gmalls= Arrays.asList( new Gmall(&quot;äº¬ä¸œ&quot;), new Gmall(&quot;æ‹¼å¤šå¤š&quot;), new Gmall(&quot;æ·˜å®&quot;), new Gmall(&quot;å”¯å“ä¼š&quot;), new Gmall(&quot;åˆ†æœŸä¹&quot;)); /** * åŒæ­¥ * @param gmalls * @param productName * @return */ public static List&lt;String&gt; getPriceSync(List&lt;Gmall&gt; gmalls,String productName)&#123; return gmalls.stream().map(gmall-&gt;String.format(productName+&quot;in %s price is %d &quot;,gmall.getGmallName(),gmall.getPriceByProductName(productName))).collect(Collectors.toList()); &#125; /** * å¼‚æ­¥ * @param gmalls * @param productName * @return */ public static List&lt;String&gt; getPriceAsync(List&lt;Gmall&gt; gmalls,String productName)&#123; return gmalls.stream().map(gmall-&gt;CompletableFuture.supplyAsync(()-&gt;String.format(productName+&quot;in %s price is %d &quot;,gmall.getGmallName(),gmall.getPriceByProductName(productName)))).collect(Collectors.toList()).stream().map(CompletableFuture::join).collect(Collectors.toList()); &#125; public static void main(String[] args) &#123; long startTime = System.currentTimeMillis(); getPriceSync(gmalls,&quot;é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©&quot;).forEach(System.out::println); long endTime = System.currentTimeMillis(); System.out.println(&quot;åŒæ­¥&quot;+ (endTime-startTime)); System.out.println(&quot;------------------------&quot;); long s = System.currentTimeMillis(); getPriceAsync(gmalls,&quot;é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©&quot;).forEach(System.out::println); long e = System.currentTimeMillis(); System.out.println(&quot;å¼‚æ­¥&quot;+ (e-s)); &#125;&#125;@Data@NoArgsConstructor@AllArgsConstructorclass Gmall&#123; private String gmallName; public Integer getPriceByProductName(String productName)&#123; try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return (int)(Math.random()*100)+1; &#125;&#125; ç»“æœï¼š 123456789101112131415=================================é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©in äº¬ä¸œ price is 100 é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©in æ‹¼å¤šå¤š price is 12 é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©in æ·˜å® price is 25 é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©in å”¯å“ä¼š price is 35 é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©in åˆ†æœŸä¹ price is 60 åŒæ­¥5081------------------------é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©in äº¬ä¸œ price is 57 é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©in æ‹¼å¤šå¤š price is 68 é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©in æ·˜å® price is 84 é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©in å”¯å“ä¼š price is 16 é‡‘é³å²‚æ˜¯æ± ä¸­ç‰©in åˆ†æœŸä¹ price is 20 å¼‚æ­¥1387================================= 2.æ£€ç´¢123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566/** * @author yhd * @createtime 2020/11/15 23:40 */public class DemoC &#123; //æ¨¡æ‹Ÿæ•°æ®åº“ private static Map&lt;String,Company&gt; db=new HashMap&lt;&gt;(); //æ¨¡æ‹ŸæŸ¥è¯¢æ¡ä»¶ private static List&lt;String&gt; persons; //åˆå§‹åŒ–æ•°æ® static &#123; persons=Arrays.asList(&quot;é©¬äº‘&quot;,&quot;é©¬åŒ–è…¾&quot;,&quot;æå½¦å®&quot;,&quot;å¼ æœé˜³&quot;,&quot;åˆ˜å¼ºä¸œ&quot;,&quot;ç‹å…´&quot;); db.put(&quot;é©¬äº‘&quot;,new Company(&quot;é©¬äº‘&quot;,&quot;é˜¿é‡Œå·´å·´&quot;)); db.put(&quot;é©¬åŒ–è…¾&quot;,new Company(&quot;é©¬åŒ–è…¾&quot;,&quot;è…¾è®¯&quot;)); db.put(&quot;æå½¦å®&quot;,new Company(&quot;æå½¦å®&quot;,&quot;ç™¾åº¦&quot;)); db.put(&quot;å¼ æœé˜³&quot;,new Company(&quot;å¼ æœé˜³&quot;,&quot;æœç‹&quot;)); db.put(&quot;åˆ˜å¼ºä¸œ&quot;,new Company(&quot;åˆ˜å¼ºä¸œ&quot;,&quot;äº¬ä¸œ&quot;)); db.put(&quot;ç‹å…´&quot;,new Company(&quot;ç‹å…´&quot;,&quot;ç¾å›¢&quot;)); &#125; //æ¨¡æ‹Ÿå»æ•°æ®åº“æŸ¥è¯¢ public static Company selectDB(String key)&#123; try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return db.get(key); &#125; public static void main(String[] args) &#123; Sync(); System.out.println(); Async(); System.out.println(); System.out.println(result()); &#125; //åŒæ­¥æŸ¥è¯¢ public static void Sync()&#123; Long startTime=System.currentTimeMillis(); persons.stream().map(key-&gt;selectDB(key).getWorks()).collect(Collectors.toList()).forEach(System.out::println); Long endTime=System.currentTimeMillis(); System.out.println(endTime-startTime); &#125; //å¼‚æ­¥æŸ¥è¯¢ public static void Async()&#123; Long startTime=System.currentTimeMillis(); persons.stream().map(key-&gt;CompletableFuture.supplyAsync(()-&gt;selectDB(key).getWorks())).collect(Collectors.toList()).stream().map(CompletableFuture::join).collect(Collectors.toList()).forEach(System.out::println); Long endTime=System.currentTimeMillis(); System.out.println(endTime-startTime); &#125; //è½¬æ¢æˆmapè¿”å› public static Map&lt;String,String&gt; result()&#123; return persons.stream().map(key -&gt; CompletableFuture.supplyAsync(() -&gt; selectDB(key))).collect(Collectors.toList()).stream().map(CompletableFuture::join).collect(Collectors.toMap(Company::getPerson,Company::getWorks)); &#125;&#125;@Data@NoArgsConstructor@AllArgsConstructorclass Company&#123; private String person; private String works;&#125; ç»“æœ 1234567891011121314151617é˜¿é‡Œå·´å·´è…¾è®¯ç™¾åº¦æœç‹äº¬ä¸œç¾å›¢6053é˜¿é‡Œå·´å·´è…¾è®¯ç™¾åº¦æœç‹äº¬ä¸œç¾å›¢1406&#123;å¼ æœé˜³=æœç‹, é©¬äº‘=é˜¿é‡Œå·´å·´, ç‹å…´=ç¾å›¢, æå½¦å®=ç™¾åº¦, åˆ˜å¼ºä¸œ=äº¬ä¸œ, é©¬åŒ–è…¾=è…¾è®¯&#125; 3.å•†å“è¯¦æƒ…1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889/** * @author äºŒå * @since 2021/8/28 7:54 ä¸‹åˆ */public class CompletableFutureTest &#123; private static ThreadPoolExecutor pool = new ThreadPoolExecutor(1, 5, 1, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(1)); public static void main(String[] args) &#123; Map&lt;String, Result&gt; result = new HashMap&lt;&gt;(4); Long s = System.currentTimeMillis(); CompletableFuture&lt;Result&gt; skuInfoFuture = CompletableFuture.supplyAsync(() -&gt; &#123; Result skuInfo = getSkuInfo(1); result.put(skuInfo.getName(), skuInfo); return skuInfo; &#125;, pool); CompletableFuture&lt;Void&gt; skuPriceFuture = CompletableFuture.runAsync(() -&gt; &#123; Result skuPrice = getSkuPrice(1); result.put(skuPrice.getName(), skuPrice); &#125;, pool); CompletableFuture&lt;Void&gt; skuImgsFuture = skuInfoFuture.thenAcceptAsync(r -&gt; &#123; Result skuImgs = getSkuImgs(r.getId()); result.put(skuImgs.getName(), skuImgs); &#125;, pool); CompletableFuture&lt;Void&gt; spuInfoFuture = skuInfoFuture.thenAcceptAsync(r -&gt; &#123; Result spuInfo = getSpuInfo(r.getId()); result.put(spuInfo.getName(), spuInfo); &#125;, pool); CompletableFuture.allOf(skuInfoFuture, skuPriceFuture, skuImgsFuture, spuInfoFuture).join(); System.out.println(result); Long e = System.currentTimeMillis(); System.out.println(&quot;æŸ¥è©¢ç¸½è¨ˆè€—æ™‚ï¼š&quot; + (e - s)); pool.shutdown(); &#125; /** * æŸ¥è¯¢skuåŸºæœ¬ä¿¡æ¯ */ public static Result getSkuInfo(Integer key) &#123; sleep(); return new Result(1, &quot;skuInfo&quot;); &#125; /** * æŸ¥è¯¢skuå›¾ç‰‡ä¿¡æ¯ */ public static Result getSkuImgs(Integer key) &#123; sleep(); return new Result(1, &quot;skuImgs&quot;); &#125; /** * æŸ¥è¯¢spué”€å”®å±æ€§ */ public static Result getSpuInfo(Integer key) &#123; sleep(); return new Result(1, &quot;spuInfo&quot;); &#125; /** * æŸ¥è¯¢skuä»·æ ¼ */ public static Result getSkuPrice(Integer key) &#123; sleep(); return new Result(1, &quot;skuPrice&quot;); &#125; public static void sleep() &#123; try &#123; TimeUnit.SECONDS.sleep(2); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; @Data @NoArgsConstructor @AllArgsConstructor private static class Result &#123; private Integer id; private String name; &#125;&#125; å“ªæœ‰ä»€ä¹ˆå²æœˆé™å¥½ï¼Œä¸è¿‡æ˜¯åœ¨ä½ çœ‹ä¸è§çš„åœ°æ–¹è´Ÿé‡å‰è¡Œã€‚","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"FutureTask","slug":"JUC/FutureTask","date":"2022-01-11T11:06:27.504Z","updated":"2022-01-11T11:28:34.940Z","comments":true,"path":"2022/01/11/JUC/FutureTask/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/FutureTask/","excerpt":"","text":"ä¸€ï¼ŒFutureå’ŒFutureTaskçš„å…³ç³»1.Future12345678910111213/** * @author äºŒå * @since 2021/8/28 3:50 ä¸‹åˆ */public class FutureTaskTest &#123; public static void main(String[] args) &#123; ThreadPoolExecutor executor = new ThreadPoolExecutor(5, 5, 5, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(1)); Future&lt;String&gt; future = executor.submit(() -&gt; &quot;callable&quot;); Future&lt;?&gt; future1 = executor.submit(() -&gt; System.out.println(&quot;runnable&quot;)); FutureTask&lt;String&gt; futureTask = new FutureTask&lt;&gt;(() -&gt; &quot;hahah&quot;); &#125;&#125; å½“æˆ‘ä»¬è°ƒç”¨çº¿ç¨‹æ± çš„submit()æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šç»™æˆ‘ä»¬è¿”å›ä¸€ä¸ªFutureç±»å‹çš„å¯¹è±¡ã€‚é‚£ä¹ˆè¿™ä¸ªFutureåˆæ˜¯ä»€ä¹ˆï¼Ÿ 12345678910111213141516public interface Future&lt;V&gt; &#123; //å–æ¶ˆä»»åŠ¡ boolean cancel(boolean mayInterruptIfRunning); //æ˜¯å¦å–æ¶ˆäº†ä»»åŠ¡ boolean isCancelled(); //æ˜¯å¦æ‰§è¡Œå®Œäº†ä»»åŠ¡ boolean isDone(); //è·å–çº¿ç¨‹çš„æ‰§è¡Œç»“æœ V get() throws InterruptedException, ExecutionException; //è·å–ç»“æœè¶…æ—¶ V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException;&#125; è¿™ä¸ªæ¥å£ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯å¯ä»¥è·å–åˆ°çº¿ç¨‹æ‰§è¡Œå®Œæˆåçš„ç»“æœã€‚â€‹ 2.ä¸¤è€…çš„å…³ç³» FutureTaskå¯ä»¥çœ‹åšæ˜¯Future å’Œ Runnable ä¸¤ä¸ªæ¥å£çš„å®ç°ç±»ã€‚â€‹ äºŒï¼ŒFutureTaskæºç 1.å±æ€§12345678910111213141516171819202122232425//è¡¨ç¤ºå½“å‰ä»»åŠ¡çš„çŠ¶æ€private volatile int state;//ä»»åŠ¡å°šæœªæ‰§è¡Œprivate static final int NEW = 0;//ä»»åŠ¡è¿˜æœªç»“æŸprivate static final int COMPLETING = 1;//ä»»åŠ¡æ­£å¸¸æ‰§è¡Œç»“æŸprivate static final int NORMAL = 2;//ä»»åŠ¡å‘ç”Ÿäº†å¼‚å¸¸ï¼Œç”±callable.call()å‘ä¸ŠæŠ›å‡ºprivate static final int EXCEPTIONAL = 3;//ä»»åŠ¡è¢«å–æ¶ˆprivate static final int CANCELLED = 4;//ä»»åŠ¡æ­£åœ¨ä¸­æ–­private static final int INTERRUPTING = 5;//ä»»åŠ¡å·²ç»è¢«ä¸­æ–­private static final int INTERRUPTED = 6;//submit(runnable/callable) ä½¿ç”¨è£…é¥°è€…æ¨¡å¼å°†runnableè£…é¥°æˆcallableprivate Callable&lt;V&gt; callable;//æ­£å¸¸æƒ…å†µä¸‹ï¼šç”¨æ¥ä¿å­˜callçš„æ‰§è¡Œç»“æœï¼Œå¼‚å¸¸æƒ…å†µä¸‹ï¼šç”¨æ¥ä¿å­˜callæŠ›å‡ºçš„å¼‚å¸¸private Object outcome; // non-volatile, protected by state reads/writes//æ‰§è¡Œå½“å‰ä»»åŠ¡çš„çº¿ç¨‹private volatile Thread runner;//å› ä¸ºä¼šæœ‰å¾ˆå¤šçº¿ç¨‹å»getå½“å‰ä»»åŠ¡çš„ç»“æœï¼Œæ‰€ä»¥ è¿™é‡Œä½¿ç”¨äº†ä¸€ç§æ•°æ®ç»“æ„ stack å¤´æ’ å¤´å– çš„ä¸€ä¸ªé˜Ÿåˆ—ã€‚private volatile WaitNode waiters; 2.WaitNodeå†…éƒ¨ç±»è¿™ä¸ªç±»é‡Œé¢å°è£…ç€æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªçº¿ç¨‹çš„æŒ‡é’ˆã€‚â€‹ 12345static final class WaitNode &#123; volatile Thread thread; volatile WaitNode next; WaitNode() &#123; thread = Thread.currentThread(); &#125;&#125; 3.æ„é€ å™¨å½“æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªrunnableæ¥å£çš„æ—¶å€™ï¼š 1234public FutureTask(Runnable runnable, V result) &#123; this.callable = Executors.callable(runnable, result); this.state = NEW; // ensure visibility of callable&#125; è°ƒç”¨äº†Executors.callable(runnable, result); 12345public static &lt;T&gt; Callable&lt;T&gt; callable(Runnable task, T result) &#123; if (task == null) throw new NullPointerException(); return new RunnableAdapter&lt;T&gt;(task, result);&#125; å½“ä»»åŠ¡ä¸ä¸ºç©ºï¼Œå®é™…ä¸Šè¿”å›çš„æ˜¯ä¸€ä¸ªRunnableAdapterå¯¹è±¡ã€‚ 123456789101112static final class RunnableAdapter&lt;T&gt; implements Callable&lt;T&gt; &#123; final Runnable task; final T result; RunnableAdapter(Runnable task, T result) &#123; this.task = task; this.result = result; &#125; public T call() &#123; task.run(); return result; &#125;&#125; åœ¨è¿™é‡Œï¼Œå°†runnableè£…é¥°æˆäº†callableã€‚â€‹ 4.run()1234567891011121314151617181920212223242526272829303132public void run() &#123; if(ä»»åŠ¡ä¸æ˜¯åˆšåˆ›å»º||ä»»åŠ¡æ²¡æœ‰è·å–åˆ°æ‰§è¡Œæƒ)&#123; return &#125; try&#123; if(å¦‚æœä»»åŠ¡ä¸ä¸ºç©º&amp;&amp;ä»»åŠ¡æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹æ‰§è¡Œ)&#123; å£°æ˜ result å£°æ˜ ran = true try&#123; è°ƒç”¨callæ–¹æ³•æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶å°†ç»“æœèµ‹å€¼ç»™result ran = true &#125;catch(Exception e)&#123; result=null ran =false è°ƒç”¨setException(ex) &#125; if(ran)&#123; æ‰§è¡Œset(result) &#125; &#125; &#125;catch(Exception e)&#123; &#125;finally&#123; é‡Šæ”¾ä»»åŠ¡æ‰§è¡Œè€… if(ä»»åŠ¡çŠ¶æ€ä¸ºè¢«æ‰“æ–­ä¸­æˆ–è€…å·²ç»è¢«æ‰“æ–­)&#123; æ‰§è¡Œ handlePossibleCancellationInterrupt(s) &#125; &#125;&#125; 5.set()12345678protected void set(V v)&#123; if(casçš„æ–¹å¼è®¾ç½®å½“å‰ä»»åŠ¡çš„çŠ¶æ€ä¸ºå®Œæˆä¸­æˆåŠŸ)&#123; å°†ä»»åŠ¡ç»“æœèµ‹å€¼ç»™outcome è®¾ç½®å½“å‰ä»»åŠ¡çŠ¶æ€ä¸ºæ­£å¸¸ç»“æŸ è°ƒç”¨finishCompletion() &#125;&#125; 6.setException()1234567protected void setException(Throwable t) &#123; if (casçš„æ–¹å¼è®¾ç½®å½“å‰ä»»åŠ¡çš„çŠ¶æ€ä¸ºå®Œæˆä¸­æˆåŠŸ) &#123; å°†å¼‚å¸¸èµ‹å€¼ç»™outcome è®¾ç½®å½“å‰ä»»åŠ¡çŠ¶æ€ä¸ºå¼‚å¸¸ finishCompletion(); &#125;&#125; 7.handlePossibleCancellationInterrupt()12345678private void handlePossibleCancellationInterrupt(int s) &#123; if (å¦‚æœå½“å‰ä»»åŠ¡çŠ¶æ€ä¸ºè¢«æ‰“æ–­) while (å½“å‰ä»»åŠ¡çŠ¶æ€ä¸ºè¢«æ‰“æ–­) Thread.yield(); // é‡Šæ”¾å½“å‰çº¿ç¨‹cpuçš„æ‰§è¡Œæƒ&#125; 8.finishCompletion()123456789101112131415161718192021222324private void finishCompletion() &#123; forå¾ªç¯è®©qæŒ‡å‘å½“å‰é“¾è¡¨çš„å¤´èŠ‚ç‚¹ //è¿™é‡Œçš„æ“ä½œæ˜¯ä¸ºäº†å¯èƒ½ä»»åŠ¡è¿˜æ²¡å¼€å§‹æ‰§è¡Œå°±è¢«å…¶ä»–çº¿ç¨‹å–æ¶ˆäº†ï¼Œè¿™ä¸ªæ—¶å€™å°†ç­‰å¾…ç»“æœçš„çº¿ç¨‹å…¨éƒ¨å”¤é†’ï¼Œå°æ¦‚ç‡äº‹ä»¶ if(ä½¿ç”¨casè®¾ç½®waitersä¸ºnullæˆåŠŸ)&#123; for(;;)&#123; è·å–qåŒ…è£…çš„çº¿ç¨‹ if(å½“å‰èŠ‚ç‚¹åŒ…è£…çš„çº¿ç¨‹ä¸ä¸ºç©º)&#123; ä¸è®©qåœ¨ç»§ç»­åŒ…è£…è¿™ä¸ªçº¿ç¨‹ å”¤é†’qä¹‹å‰åŒ…è£…çš„çº¿ç¨‹ &#125; qæŒ‡å‘é“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ if(ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©º)&#123; break &#125; &#125; break &#125; done() å°†callableè®¾ç½®ä¸ºnullå¸®åŠ©gc&#125; 9.done()1protected void done() &#123; &#125; 10.get()123456public V get() throws InterruptedException, ExecutionException &#123; è·å–å½“å‰ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ if (å½“å‰ä»»åŠ¡å°šæœªæ‰§è¡Œå®Œ) s = awaitDone(false, 0L); return report(s);&#125; 11.awaitDone()123456789101112131415161718192021222324252627282930//å‚æ•°è¯´æ˜ï¼šæ˜¯å¦è®¾ç½®äº†è¶…æ—¶æ—¶é—´ è¶…æ—¶æ—¶é—´private int awaitDone(boolean timed, long nanos) throws InterruptedException &#123; final long deadline = timed ? System.nanoTime() + nanos : 0L; å£°æ˜ å½“å‰çº¿ç¨‹æ˜¯å¦è¿›å…¥è·å–ç»“æœçš„ç­‰å¾…é˜Ÿåˆ— =false for (;;) &#123; if (å¦‚æœå½“å‰çº¿ç¨‹è¢«å…¶ä»–çº¿ç¨‹ç”¨ä¸­æ–­çš„æ–¹å¼å”¤é†’) &#123; å½“å‰èŠ‚ç‚¹å‡ºé˜Ÿåˆ— å¹¶æŠ›å‡ºä¸­æ–­å¼‚å¸¸ &#125; //å‡è®¾å½“å‰çº¿ç¨‹æ˜¯è¢«å…¶ä»–çº¿ç¨‹ä»¥unparkçš„æ–¹å¼æ­£å¸¸å”¤é†’ï¼Œé‚£ä¹ˆå°±ä¼šèµ°ä¸‹é¢çš„é€»è¾‘ è·å–å½“å‰ä»»åŠ¡çŠ¶æ€ //å¤§äºå®Œæˆä¸­æœ‰å¯èƒ½æ­£å¸¸ç»“æŸï¼Œä¹Ÿæœ‰å¯èƒ½å¼‚å¸¸ç»“æŸ if (å¦‚æœå½“å‰ä»»åŠ¡çŠ¶æ€å¤§äºå®Œæˆä¸­) &#123; if (å¦‚æœå½“å‰çº¿ç¨‹åˆ›å»ºè¿‡node) é‡Šæ”¾node return å½“å‰ä»»åŠ¡çŠ¶æ€; &#125; else if (å½“å‰ä»»åŠ¡çŠ¶æ€æ˜¯å®Œæˆä¸­) é‡Šæ”¾çº¿ç¨‹çš„cpuæ‰§è¡Œæƒï¼Œæ¥ç€ç­‰ else if (ç­‰å¾…èŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è‡ªæ—‹ï¼Œè¿˜æ²¡æœ‰åˆ›å»ºèŠ‚ç‚¹) åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ else if (åˆ›å»ºå¥½äº†å¯¹è±¡ä½†æ˜¯è¿˜æ²¡æœ‰å…¥é˜Ÿ) casçš„æ–¹å¼åŠ å…¥é˜Ÿåˆ— else if (æœ‰è¶…æ—¶æ—¶é—´) &#123; èµ°è¶…æ—¶é€»è¾‘ &#125; else é˜»å¡å½“å‰çº¿ç¨‹ &#125;&#125; 12.report(int s)123456789//å‚æ•°è¯´æ˜ï¼šå½“å‰ä»»åŠ¡çŠ¶æ€private V report(int s) throws ExecutionException &#123; if (ä»»åŠ¡æ­£å¸¸ç»“æŸ) return ä»»åŠ¡ç»“æœ; if (ä»»åŠ¡è¢«å–æ¶ˆæˆ–ä¸­æ–­) æŠ›å¼‚å¸¸ å¦åˆ™å°±æ˜¯ä»»åŠ¡å‘ç”Ÿå¼‚å¸¸ï¼Œå°†å¼‚å¸¸å‘ä¸ŠæŠ›å‡º&#125; 13.cancel()1234567891011121314151617181920public boolean cancel(boolean mayInterruptIfRunning) &#123; //è¯´æ˜æ­¤æ—¶ä»»åŠ¡ä¸èƒ½å–æ¶ˆäº†ï¼Œç›´æ¥è¿”å›false if (!(ä»»åŠ¡çŠ¶æ€==åˆšåˆ›å»º &amp;&amp; casä¿®æ”¹ä»»åŠ¡çŠ¶æ€ä¸ºå–æ¶ˆæˆ–ä¸­æ–­æˆåŠŸ))) return false; try &#123; if (å°è¯•æ‰“æ–­æˆåŠŸ) &#123; try &#123; è·å–æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ if (æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼=null) ç»™æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹è®¾ç½®ä¸­æ–­æ ‡è¯† &#125; finally &#123; casçš„æ–¹å¼è®¾ç½®ä»»åŠ¡çš„çŠ¶æ€ä¸ºè¢«æ‰“æ–­ &#125; &#125; &#125; finally &#123; finishCompletion(); &#125; return true;&#125; ä¸‰ï¼Œæµç¨‹æ¢³ç†â€‹ é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œä¸ç®¡æˆ‘ä»¬ä¼ å…¥çš„æ˜¯Runnableè¿˜æ˜¯Callableæ¥å£ï¼Œä»–æœ€ç»ˆç”¨çš„éƒ½æ˜¯Callableï¼ŒRunnableæ¥å£ä¼šè¢«ä»–é€šè¿‡è£…é¥°è€…æ¨¡å¼å°è£…ä¸ºCallableã€‚ â€‹ ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œçš„å…¥å£å…¶å®å°±æ˜¯runæ–¹æ³•ã€‚ â€‹ è¿›å…¥runæ–¹æ³•ï¼Œé¦–å…ˆä»–ä¼šåˆ¤æ–­å½“å‰ä»»åŠ¡æ˜¯å¦å·²ç»è¢«æ‰§è¡Œè¿‡æˆ–è€…å½“å‰çº¿ç¨‹é€šè¿‡casçš„æ–¹å¼å¹¶æ²¡æœ‰æŠ¢åˆ°æ‰§è¡Œå½“å‰ä»»åŠ¡çš„æœºä¼šã€‚å¦‚æœæ˜¯çš„è¯ï¼Œè¯´æ˜å·²ç»æœ‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œæˆ–è€…æ‰§è¡Œå®Œäº†å½“å‰çš„ä»»åŠ¡ï¼Œç›´æ¥è¿”å›å³å¯ã€‚ æ¥ä¸‹æ¥ä»–ä¼šåˆ¤æ–­å½“å‰ä»»åŠ¡æ˜¯å¦ä¸ºç©ºæˆ–è€…å½“å‰ä»»åŠ¡çš„çŠ¶æ€ï¼Œå…¶å®åˆ¤æ–­çŠ¶æ€å°±æ˜¯ä¸ºäº†åˆ¤æ–­å½“å‰ä»»åŠ¡æ˜¯ä¸æ˜¯è¢«å–æ¶ˆäº†ã€‚å¦‚æœä»»åŠ¡ä¸ä¸ºç©ºå¹¶ä¸”æ²¡æœ‰è¢«å–æ¶ˆï¼Œä»–ä¼šæ‰§è¡Œcallæ–¹æ³•ï¼ˆå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡ä»£ç ï¼‰å¹¶å°†ç»“æœè®¾ç½®åˆ°resultå°†ä»»åŠ¡çš„æ˜¯å¦è¢«æ‰§è¡ŒçŠ¶æ€æ”¹æˆtrueè¡¨ç¤ºé¡ºåˆ©æ‰§è¡Œå®Œã€‚ â€‹ callæ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿå¼‚å¸¸äº†ï¼Œä¼šå°†ç»“æœè®¾ç½®ä¸ºnullï¼Œæ˜¯å¦è¢«é¡ºåˆ©æ‰§è¡Œçš„çŠ¶æ€ä¸ºè®¾ç½®ä¸ºfalseï¼Œè¡¨ç¤ºæ‰§è¡Œè¿‡ç¨‹å‘ç”Ÿäº†å¼‚å¸¸ã€‚ â€‹ æ¥ä¸‹æ¥ï¼Œå®ƒä¼šå°†å¼‚å¸¸ä¿¡æ¯å°è£…åˆ°outcomeï¼Œç„¶åè®¾ç½®ä½†è¯¥ä½ ä»»åŠ¡çš„çŠ¶æ€ä¸ºå¼‚å¸¸ç»“æŸï¼Œå¹¶è‡ªæ—‹çš„æ–¹å¼å”¤é†’æ‰€æœ‰ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…è·å–ç»“æœçš„çº¿ç¨‹ã€‚ â€‹ å¦‚æœcallæ­£å¸¸æ‰§è¡Œå®Œäº†ï¼Œä»–ä¼šç”¨casçš„æ–¹å¼è®¾ç½®å½“å‰ä»»åŠ¡çš„å®ŒæˆçŠ¶æ€ä¸ºå®Œæˆä¸­ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œoutcomeæ¥æ¥æ”¶ä»»åŠ¡çš„ç»“æœï¼Œè®¾ç½®å½“å‰ä»»åŠ¡çš„çŠ¶æ€ä¸ºæ­£å¸¸å®ŒæˆçŠ¶æ€ï¼Œå¹¶ä¸”å”¤é†’æ‰€æœ‰ç­‰å¾…ç»“æœçš„çº¿ç¨‹ã€‚ â€‹ æœ€ç»ˆå®ƒä¼šå°†æ‰§è¡Œå½“å‰ä»»åŠ¡çš„çº¿ç¨‹è®¾ç½®ä¸ºnullï¼Œå¹¶åˆ¤æ–­ï¼Œå¦‚æœå½“å‰ä»»åŠ¡çš„çŠ¶æ€æ˜¯è¢«æ‰“æ–­ä¸­æˆ–è€…å·²ç»è¢«æ‰“æ–­ï¼Œä»–å°±ä¼šè‡ªæ—‹åˆ¤æ–­å¦‚æœå½“å‰çº¿ç¨‹çš„çŠ¶æ€ä¸ºè¢«æ‰“æ–­ï¼Œè®©æ‰§è¡Œå½“å‰ä»»åŠ¡çš„çº¿ç¨‹é‡Šæ”¾cpuã€‚ â€‹ getæ–¹æ³•æ˜¯è·å–å½“å‰ä»»åŠ¡çš„ç»“æœã€‚é¦–å…ˆä»–ä¼šè·å–å½“å‰ä»»åŠ¡çš„çŠ¶æ€ï¼Œå¦‚æœçŠ¶æ€å°äºç­‰äºæœªå®Œæˆé¦–å…ˆä»–ä¼šé€šè¿‡è‡ªæ—‹çš„æ–¹å¼ï¼Œç¬¬ä¸€æ¬¡è‡ªæ—‹å°šæœªç»™å½“å‰çº¿ç¨‹åˆ›å»ºwaitNodeå¯¹è±¡ï¼Œæ­¤æ—¶å°±éœ€è¦ä½å½“å‰çº¿ç¨‹åˆ›å»ºwaitNodeå¯¹è±¡ã€‚ç¬¬äºŒæ¬¡è‡ªæ—‹ï¼Œåˆ›å»ºå¥½äº†å¯¹è±¡è¿˜æ²¡æœ‰å…¥é˜Ÿï¼Œcasçš„æ–¹å¼å…¥é˜Ÿã€‚ç¬¬ä¸‰æ¬¡è‡ªæ—‹ï¼Œåˆ¤æ–­æ˜¯å¦è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœæ²¡è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå½“å‰getæ“ä½œçš„çº¿ç¨‹å°±ä¼šè¢«parkäº†ã€‚ çº¿ç¨‹çŠ¶æ€ä¼šå˜ä¸º WAITINGçŠ¶æ€ï¼Œç›¸å½“äºä¼‘çœ äº†..é™¤éæœ‰å…¶å®ƒçº¿ç¨‹å°†ä½ å”¤é†’ æˆ–è€… å°†å½“å‰çº¿ç¨‹ ä¸­æ–­ã€‚ä»–ä¼šè·å–å½“å‰çº¿ç¨‹çš„ä»»åŠ¡çŠ¶æ€ï¼Œå¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œé‡Šæ”¾cpuæ¥ç€ç­‰ã€‚å¦‚æœä»»åŠ¡å·²ç»å®Œæˆï¼Œæ­¤æ—¶éœ€è¦å°†nodeè®¾ç½®ä½null help GCï¼Œç›´æ¥è¿”å›å½“å‰çš„çŠ¶æ€ã€‚é™¤æ­¤ä¹‹å¤–è¿˜è¦åˆ¤æ–­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«å…¶ä»–çº¿ç¨‹ç”¨ä¸­æ–­çš„æ–¹å¼å”¤é†’ï¼Œè¿™ç§å”¤é†’æ–¹å¼ä¼šå°†Threadçš„ä¸­æ–­æ ‡è®°ä½è®¾ç½®ä¸ºfalseï¼Œå½“å‰çº¿ç¨‹å‡ºé˜Ÿï¼Œgetæ–¹æ³•æŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚ â€‹ å¦‚æœçŠ¶æ€è¡¨ç¤ºå·²ç»æœ‰ç»“æœï¼Œä¼šæ‰§è¡Œreportæ–¹æ³•ã€‚ â€‹ reportæ–¹æ³•ï¼Œå¦‚æœä»»åŠ¡æ­£å¸¸æ‰§è¡Œç»“æŸï¼Œè¿”å›ç»“æœï¼Œå¦‚æœä»»åŠ¡è¢«å–æ¶ˆæˆ–è€…ä¸­æ–­äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ç»“æŸäº†ï¼Œè¿”å›å¼‚å¸¸ã€‚ â€‹ æœ€åå°±æ˜¯ä»»åŠ¡çš„å–æ¶ˆæ–¹æ³• cancelã€‚ä»–ä¼šå…ˆåˆ¤æ–­state == NEW æˆç«‹ è¡¨ç¤ºå½“å‰ä»»åŠ¡å¤„äºè¿è¡Œä¸­ æˆ–è€… å¤„äºçº¿ç¨‹æ±  ä»»åŠ¡é˜Ÿåˆ—ä¸­..å¹¶ä¸”casä¿®æ”¹çŠ¶æ€æˆåŠŸï¼Œä»–å°±ä¼šå°è¯•å–æ‰“æ–­ã€‚ â€‹ å¦‚æœå°è¯•æ‰“æ–­æˆåŠŸï¼Œç»™runnerçº¿ç¨‹ä¸€ä¸ªä¸­æ–­ä¿¡å·..å¦‚æœä½ çš„ç¨‹åºæ˜¯å“åº”ä¸­æ–­ ä¼šèµ°ä¸­æ–­é€»è¾‘..å‡è®¾ä½ ç¨‹åºä¸æ˜¯å“åº”ä¸­æ–­çš„..å•¥ä¹Ÿä¸ä¼šå‘ç”Ÿã€‚æœ€åï¼Œè®¾ç½®çº¿ç¨‹çŠ¶æ€ä¸ºä¸­æ–­ï¼Œå”¤é†’è·å–ç»“æœçš„çº¿ç¨‹ã€‚","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"ConcurrentHashMap","slug":"JUC/ConcurrentHashMap","date":"2022-01-11T11:06:18.507Z","updated":"2022-01-11T11:27:21.431Z","comments":true,"path":"2022/01/11/JUC/ConcurrentHashMap/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/ConcurrentHashMap/","excerpt":"","text":"ä¸€ï¼Œä½¿ç”¨ConcurrentHashMap æ˜¯ J.U.C åŒ…é‡Œé¢æä¾›çš„ä¸€ä¸ªçº¿ç¨‹å®‰å…¨å¹¶ä¸”é«˜æ•ˆçš„ HashMapï¼Œæ‰€ä»¥ConcurrentHashMap åœ¨å¹¶å‘ç¼–ç¨‹çš„åœºæ™¯ä¸­ä½¿ç”¨çš„é¢‘ç‡æ¯”è¾ƒé«˜ã€‚ ConcurrentHashMap æ˜¯ Map çš„æ´¾ç”Ÿç±»ï¼Œæ‰€ä»¥ api åŸºæœ¬å’Œ Hashmap æ˜¯ç±»ä¼¼ï¼Œä¸»è¦å°±æ˜¯ putã€get è¿™äº›æ–¹æ³•ï¼Œæ¥ä¸‹æ¥åŸºäº ConcurrentHashMap çš„ put å’Œ get è¿™ä¸¤ä¸ªæ–¹æ³•ä½œä¸ºåˆ‡å…¥ç‚¹æ¥åˆ†æ ConcurrentHashMap çš„æºç å®ç°ã€‚ äºŒï¼Œæºç  1.æˆå‘˜å˜é‡123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147//æ•£åˆ—è¡¨æ•°ç»„çš„æœ€å¤§é™åˆ¶private static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;//æ•£åˆ—è¡¨é»˜è®¤å€¼private static final int DEFAULT_CAPACITY = 16;static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;//å¹¶å‘çº§åˆ«ï¼šjdk7å†å²é—ç•™é—®é¢˜ï¼Œä»…ä»…åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨åˆ°ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„ä»£è¡¨å¹¶å‘çº§åˆ«private static final int DEFAULT_CONCURRENCY_LEVEL = 16;//è´Ÿè½½å› å­ï¼ŒJDK1.8ä¸­ ConcurrentHashMap æ˜¯å›ºå®šå€¼private static final float LOAD_FACTOR = 0.75f;//æ ‘åŒ–é˜ˆå€¼ï¼ŒæŒ‡å®šæ¡¶ä½ é“¾è¡¨é•¿åº¦è¾¾åˆ°8çš„è¯ï¼Œæœ‰å¯èƒ½å‘ç”Ÿæ ‘åŒ–æ“ä½œã€‚static final int TREEIFY_THRESHOLD = 8;//çº¢é»‘æ ‘è½¬åŒ–ä¸ºé“¾è¡¨çš„é˜ˆå€¼static final int UNTREEIFY_THRESHOLD = 6;//è”åˆTREEIFY_THRESHOLDæ§åˆ¶æ¡¶ä½æ˜¯å¦æ ‘åŒ–ï¼Œåªæœ‰å½“tableæ•°ç»„é•¿åº¦è¾¾åˆ°64ä¸” æŸä¸ªæ¡¶ä½ ä¸­çš„é“¾è¡¨é•¿åº¦è¾¾åˆ°8ï¼Œæ‰ä¼šçœŸæ­£æ ‘åŒ–static final int MIN_TREEIFY_CAPACITY = 64;//çº¿ç¨‹è¿ç§»æ•°æ®æœ€å°æ­¥é•¿ï¼Œæ§åˆ¶çº¿ç¨‹è¿ç§»ä»»åŠ¡æœ€å°åŒºé—´ä¸€ä¸ªå€¼private static final int MIN_TRANSFER_STRIDE = 16;//è®¡ç®—æ‰©å®¹æ—¶å€™ç”Ÿæˆçš„ä¸€ä¸ª æ ‡è¯†æˆ³private static int RESIZE_STAMP_BITS = 16;//ç»“æœæ˜¯65535 è¡¨ç¤ºå¹¶å‘æ‰©å®¹æœ€å¤šçº¿ç¨‹æ•°private static final int MAX_RESIZERS = (1 &lt;&lt; (32 - RESIZE_STAMP_BITS)) - 1;//æ‰©å®¹ç›¸å…³private static final int RESIZE_STAMP_SHIFT = 32 - RESIZE_STAMP_BITS;//å½“nodeèŠ‚ç‚¹hash=-1 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»è¢«è¿ç§»äº† ï¼ŒfwdèŠ‚ç‚¹static final int MOVED = -1; // hash for forwarding nodes//node hash=-2 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»æ ‘åŒ– ä¸” å½“å‰èŠ‚ç‚¹ä¸ºtreebinå¯¹è±¡ ï¼Œä»£ç†æ“ä½œçº¢é»‘æ ‘static final int TREEBIN = -2; // hash for roots of treesstatic final int RESERVED = -3; // hash for transient reservations//è½¬åŒ–æˆäºŒè¿›åˆ¶å®é™…ä¸Šæ˜¯ 31ä¸ª 1 å¯ä»¥å°†ä¸€ä¸ªè´Ÿæ•°é€šè¿‡ä½ç§»è¿ç®—å¾—åˆ°ä¸€ä¸ªæ­£æ•°static final int HASH_BITS = 0x7fffffff; // usable bits of normal node hash//å½“å‰ç³»ç»Ÿçš„cpuæ•°é‡static final int NCPU = Runtime.getRuntime().availableProcessors();//ä¸ºäº†å…¼å®¹7ç‰ˆæœ¬çš„chpä¿å­˜çš„ï¼Œæ ¸å¿ƒä»£ç å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°private static final ObjectStreamField[] serialPersistentFields = &#123; new ObjectStreamField(&quot;segments&quot;, Segment[].class), new ObjectStreamField(&quot;segmentMask&quot;, Integer.TYPE), new ObjectStreamField(&quot;segmentShift&quot;, Integer.TYPE)&#125;;//æ•£åˆ—è¡¨ï¼Œé•¿åº¦ä¸€å®šæ˜¯2æ¬¡æ–¹æ•°transient volatile Node&lt;K,V&gt;[] table;//æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œä¼šå°†æ‰©å®¹ä¸­çš„æ–°table èµ‹å€¼ç»™nextTable ä¿æŒå¼•ç”¨ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œè¿™é‡Œä¼šè¢«è®¾ç½®ä¸ºNullprivate transient volatile Node&lt;K,V&gt;[] nextTable;//LongAdder ä¸­çš„ baseCount æœªå‘ç”Ÿç«äº‰æ—¶ æˆ–è€… å½“å‰LongAdderå¤„äºåŠ é”çŠ¶æ€æ—¶ï¼Œå¢é‡ç´¯åˆ°åˆ°baseCountä¸­private transient volatile long baseCount;/** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private transient volatile int sizeCtl;/** * * æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œè®°å½•å½“å‰è¿›åº¦ã€‚æ‰€æœ‰çº¿ç¨‹éƒ½éœ€è¦ä»transferIndexä¸­åˆ†é…åŒºé—´ä»»åŠ¡ï¼Œå»æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ã€‚ */private transient volatile int transferIndex;/** * LongAdderä¸­çš„cellsBuzy 0è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡æ— é”çŠ¶æ€ï¼Œ1è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡åŠ é”çŠ¶æ€ */private transient volatile int cellsBusy;/** * LongAdderä¸­çš„cellsæ•°ç»„ï¼Œå½“baseCountå‘ç”Ÿç«äº‰åï¼Œä¼šåˆ›å»ºcellsæ•°ç»„ï¼Œ * çº¿ç¨‹ä¼šé€šè¿‡è®¡ç®—hashå€¼ å–åˆ° è‡ªå·±çš„cell ï¼Œå°†å¢é‡ç´¯åŠ åˆ°æŒ‡å®šcellä¸­ * æ€»æ•° = sum(cells) + baseCount */private transient volatile CounterCell[] counterCells;// Unsafe mechanicsprivate static final sun.misc.Unsafe U;/**è¡¨ç¤ºsizeCtlå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long SIZECTL;/**è¡¨ç¤ºtransferIndexå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long TRANSFERINDEX;/**è¡¨ç¤ºbaseCountå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long BASECOUNT;/**è¡¨ç¤ºcellsBusyå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLSBUSY;/**è¡¨ç¤ºcellValueå±æ€§åœ¨CounterCellä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLVALUE;/**è¡¨ç¤ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€*/private static final long ABASE;private static final int ASHIFT;static &#123; try &#123; U = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = ConcurrentHashMap.class; SIZECTL = U.objectFieldOffset (k.getDeclaredField(&quot;sizeCtl&quot;)); TRANSFERINDEX = U.objectFieldOffset (k.getDeclaredField(&quot;transferIndex&quot;)); BASECOUNT = U.objectFieldOffset (k.getDeclaredField(&quot;baseCount&quot;)); CELLSBUSY = U.objectFieldOffset (k.getDeclaredField(&quot;cellsBusy&quot;)); Class&lt;?&gt; ck = CounterCell.class; CELLVALUE = U.objectFieldOffset (ck.getDeclaredField(&quot;value&quot;)); Class&lt;?&gt; ak = Node[].class; ABASE = U.arrayBaseOffset(ak); //è¡¨ç¤ºæ•°ç»„å•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°,scale è¡¨ç¤ºNode[]æ•°ç»„ä¸­æ¯ä¸€ä¸ªå•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å° int scale = U.arrayIndexScale(ak); //1 0000 &amp; 0 1111 = 0 if ((scale &amp; (scale - 1)) != 0) throw new Error(&quot;data type scale not a power of two&quot;); //numberOfLeadingZeros() è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›å½“å‰æ•°å€¼è½¬æ¢ä¸ºäºŒè¿›åˆ¶åï¼Œä»é«˜ä½åˆ°ä½ä½å¼€å§‹ç»Ÿè®¡ï¼Œçœ‹æœ‰å¤šå°‘ä¸ª0è¿ç»­åœ¨ä¸€å—ã€‚ //8 =&gt; 1000 numberOfLeadingZeros(8) = 28 //4 =&gt; 100 numberOfLeadingZeros(4) = 29 //ASHIFT = 31 - 29 = 2 ï¼Ÿï¼Ÿ //ABASE + ï¼ˆ5 &lt;&lt; ASHIFTï¼‰ ASHIFT = 31 - Integer.numberOfLeadingZeros(scale); &#125; catch (Exception e) &#123; throw new Error(e); &#125;&#125; 2.åŸºç¡€æ–¹æ³•2.1 spreadé«˜ä½è¿ç®— 123static final int spread(int h) &#123; return (h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS;&#125; 2.2 tabAtè¯¥æ–¹æ³•è·å–å¯¹è±¡ä¸­offsetåç§»åœ°å€å¯¹åº”çš„å¯¹è±¡fieldçš„å€¼ã€‚å®é™…ä¸Šè¿™æ®µä»£ç çš„å«ä¹‰ç­‰ä»·äºtab[i],ä½†æ˜¯ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ tab[i]æ¥è®¡ç®—å‘¢ï¼Ÿ getObjectVolatileï¼Œä¸€æ—¦çœ‹åˆ° volatile å…³é”®å­—ï¼Œå°±è¡¨ç¤ºå¯è§æ€§ã€‚å› ä¸ºå¯¹ volatile å†™æ“ä½œ happen-before äº volatile è¯»æ“ä½œï¼Œå› æ­¤å…¶ä»–çº¿ç¨‹å¯¹ table çš„ä¿®æ”¹å‡å¯¹ get è¯»å–å¯è§ï¼› è™½ç„¶ table æ•°ç»„æœ¬èº«æ˜¯å¢åŠ äº† volatile å±æ€§ï¼Œä½†æ˜¯â€œvolatile çš„æ•°ç»„åªé’ˆå¯¹æ•°ç»„çš„å¼•ç”¨å…·æœ‰volatile çš„è¯­ä¹‰ï¼Œè€Œä¸æ˜¯å®ƒçš„å…ƒç´ â€ã€‚ æ‰€ä»¥å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å¯¹è¿™ä¸ªæ•°ç»„çš„å…ƒç´ è¿›è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æ¥è¯»çš„æ—¶å€™ä¸ä¸€å®šèƒ½è¯»åˆ°æœ€æ–°çš„å€¼ã€‚å‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒDoug Lea ç›´æ¥é€šè¿‡ Unsafe ç±»æ¥å¯¹ table è¿›è¡Œæ“ä½œã€‚ 123static final &lt;K,V&gt; Node&lt;K,V&gt; tabAt(Node&lt;K,V&gt;[] tab, int i) &#123; return (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE);&#125; 2.3 casTabAtcasè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºæ¡¶ä½çš„å¤´èŠ‚ç‚¹ 1234static final &lt;K,V&gt; boolean casTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v) &#123; return U.compareAndSwapObject(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, c, v);&#125; 2.4 setTabAt123static final &lt;K,V&gt; void setTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; v) &#123; U.putObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, v);&#125; 2.5 resizeStampresizeStamp ç”¨æ¥ç”Ÿæˆä¸€ä¸ªå’Œæ‰©å®¹æœ‰å…³çš„æ‰©å®¹æˆ³ï¼Œå…·ä½“æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ 123static final int resizeStamp(int n) &#123; return Integer.numberOfLeadingZeros(n) | (1 &lt;&lt; (RESIZE_STAMP_BITS - 1));&#125; Integer.numberOfLeadingZeros è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›æ— ç¬¦å·æ•´æ•° n æœ€é«˜ä½é 0 ä½å‰é¢çš„ 0 çš„ä¸ªæ•°ã€‚ æ¯”å¦‚ 10 çš„äºŒè¿›åˆ¶æ˜¯ 0000 0000 0000 0000 0000 0000 0000 1010ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•è¿”å›çš„å€¼å°±æ˜¯ 28ã€‚ æ ¹æ® resizeStamp çš„è¿ç®—é€»è¾‘ï¼Œæˆ‘ä»¬æ¥æ¨æ¼”ä¸€ä¸‹ï¼Œå‡å¦‚ n=16ï¼Œé‚£ä¹ˆ resizeStamp(16)=32796è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ˜¯[0000 0000 0000 0000 1000 0000 0001 1100]â€‹ æ¥ç€å†æ¥çœ‹,å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸‹é¢è¿™æ®µä»£ç ï¼š 1U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2) rs å·¦ç§» 16 ä½ï¼Œç›¸å½“äºåŸæœ¬çš„äºŒè¿›åˆ¶ä½ä½å˜æˆäº†é«˜ä½ 1000 0000 0001 1100 0000 0000 00000000 ç„¶åå†+2 =1000 0000 0001 1100 0000 0000 0000 0000+10=1000 0000 0001 1100 0000 00000000 0010 é«˜ 16 ä½ä»£è¡¨æ‰©å®¹çš„æ ‡è®°ã€ä½ 16 ä½ä»£è¡¨å¹¶è¡Œæ‰©å®¹çš„çº¿ç¨‹æ•° è¿™æ ·æ¥å­˜å‚¨æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ 1ï¼Œé¦–å…ˆåœ¨ CHM ä¸­æ˜¯æ”¯æŒå¹¶å‘æ‰©å®¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå½“å‰çš„æ•°ç»„éœ€è¦è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹æ¥å…±åŒè´Ÿè´£ 2ï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡æ‰©å®¹éƒ½ç”Ÿæˆå”¯ä¸€çš„ç”Ÿæˆæˆ³ï¼Œæ¯æ¬¡æ–°çš„æ‰©å®¹ï¼Œéƒ½æœ‰ä¸€ä¸ªä¸åŒçš„ nï¼Œè¿™ä¸ªç”Ÿæˆæˆ³å°±æ˜¯æ ¹æ® n æ¥è®¡ç®—å‡ºæ¥çš„ä¸€ä¸ªæ•°å­—ï¼Œn ä¸åŒï¼Œè¿™ä¸ªæ•°å­—ä¹Ÿä¸åŒ ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•æ‰©å®¹çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆæ˜¯+2 å› ä¸º 1 è¡¨ç¤ºåˆå§‹åŒ–ï¼Œ2 è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹ï¼Œè€Œä¸”å¯¹ sizeCtl çš„æ“ä½œéƒ½æ˜¯åŸºäºä½è¿ç®—çš„ï¼Œæ‰€ä»¥ä¸ä¼šå…³å¿ƒå®ƒæœ¬èº«çš„æ•°å€¼æ˜¯å¤šå°‘ï¼Œåªå…³å¿ƒå®ƒåœ¨äºŒè¿›åˆ¶ä¸Šçš„æ•°å€¼ï¼Œè€Œ sc + 1 ä¼šåœ¨ä½ 16 ä½ä¸ŠåŠ  1ã€‚ 2.6 tableSizeForç»è¿‡å¤šæ¬¡ä½ç§»è¿”å›å¤§äºç­‰äºcçš„æœ€å°çš„äºŒæ¬¡æ–¹æ•° 1234567891011121314151617181920/** * Returns a power of two table size for the given desired capacity. * See Hackers Delight, sec 3.2 * è¿”å›&gt;=cçš„æœ€å°çš„2çš„æ¬¡æ–¹æ•° * c=28 * n=27 =&gt; 0b 11011 * 11011 | 01101 =&gt; 11111 * 11111 | 00111 =&gt; 11111 * .... * =&gt; 11111 + 1 =100000 = 32 */private static final int tableSizeFor(int c) &#123; int n = c - 1; n |= n &gt;&gt;&gt; 1; n |= n &gt;&gt;&gt; 2; n |= n &gt;&gt;&gt; 4; n |= n &gt;&gt;&gt; 8; n |= n &gt;&gt;&gt; 16; return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;&#125; 3. æ„é€ æ–¹æ³•1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public ConcurrentHashMap() &#123;&#125;public ConcurrentHashMap(int initialCapacity) &#123; if (initialCapacity &lt; 0) throw new IllegalArgumentException(); //å¦‚æœæŒ‡å®šçš„å®¹é‡è¶…è¿‡å…è®¸çš„æœ€å¤§å€¼ï¼Œè®¾ç½®ä¸ºæœ€å¤§å€¼ int cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ? MAXIMUM_CAPACITY : tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; 1) + 1)); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125;public ConcurrentHashMap(Map&lt;? extends K, ? extends V&gt; m) &#123; this.sizeCtl = DEFAULT_CAPACITY; putAll(m);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor) &#123; this(initialCapacity, loadFactor, 1);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) &#123; //å‚æ•°æ ¡éªŒ if (!(loadFactor &gt; 0.0f) || initialCapacity &lt; 0 || concurrencyLevel &lt;= 0) throw new IllegalArgumentException(); //å¦‚æœåˆå§‹å®¹é‡å°äºå¹¶å‘çº§åˆ«ï¼Œé‚£å°±è®¾ç½®åˆå§‹å®¹é‡ä¸ºå¹¶å‘çº§åˆ« if (initialCapacity &lt; concurrencyLevel) initialCapacity = concurrencyLevel; //16/0.75 +1 = 22 long size = (long)(1.0 + (long)initialCapacity / loadFactor); // 22 - &gt; 32 int cap = (size &gt;= (long)MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : tableSizeFor((int)size); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125; 4.put1234public V put(K key, V value) &#123; //å¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Œé»˜è®¤æ˜¯false return putVal(key, value, false);&#125; 5 putVal123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129final V putVal(K key, V value, boolean onlyIfAbsent) &#123; //æ§åˆ¶k å’Œ v ä¸èƒ½ä¸ºnull if (key == null || value == null) throw new NullPointerException(); //é€šè¿‡spreadæ–¹æ³•ï¼Œå¯ä»¥è®©é«˜ä½ä¹Ÿèƒ½å‚ä¸è¿›å¯»å€è¿ç®—ã€‚ int hash = spread(key.hashCode()); //binCountè¡¨ç¤ºå½“å‰k-v å°è£…æˆnodeåæ’å…¥åˆ°æŒ‡å®šæ¡¶ä½åï¼Œåœ¨æ¡¶ä½ä¸­çš„æ‰€å±é“¾è¡¨çš„ä¸‹æ ‡ä½ç½® //0 è¡¨ç¤ºå½“å‰æ¡¶ä½ä¸ºnullï¼Œnodeå¯ä»¥ç›´æ¥æ”¾ç€ //2 è¡¨ç¤ºå½“å‰æ¡¶ä½å·²ç»å¯èƒ½æ˜¯çº¢é»‘æ ‘ int binCount = 0; //tab å¼•ç”¨mapå¯¹è±¡çš„table //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //f è¡¨ç¤ºæ¡¶ä½çš„å¤´ç»“ç‚¹ //n è¡¨ç¤ºæ•£åˆ—è¡¨æ•°ç»„çš„é•¿åº¦ //i è¡¨ç¤ºkeyé€šè¿‡å¯»å€è®¡ç®—åï¼Œå¾—åˆ°çš„æ¡¶ä½ä¸‹æ ‡ //fh è¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹çš„hashå€¼ Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼šæˆç«‹ï¼Œè¡¨ç¤ºå½“å‰mapä¸­çš„tableå°šæœªåˆå§‹åŒ–.. if (tab == null || (n = tab.length) == 0) //æœ€ç»ˆå½“å‰çº¿ç¨‹éƒ½ä¼šè·å–åˆ°æœ€æ–°çš„map.tableå¼•ç”¨ã€‚ tab = initTable(); //CASE2ï¼ši è¡¨ç¤ºkeyä½¿ç”¨è·¯ç”±å¯»å€ç®—æ³•å¾—åˆ° keyå¯¹åº” tableæ•°ç»„çš„ä¸‹æ ‡ä½ç½®ï¼ŒtabAt è·å–æŒ‡å®šæ¡¶ä½çš„å¤´ç»“ç‚¹ f else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) &#123; //è¿›å…¥åˆ°CASE2ä»£ç å— å‰ç½®æ¡ä»¶ å½“å‰tableæ•°ç»„iæ¡¶ä½æ˜¯Nullæ—¶ã€‚ //ä½¿ç”¨CASæ–¹å¼ è®¾ç½® æŒ‡å®šæ•°ç»„iæ¡¶ä½ ä¸º new Node&lt;K,V&gt;(hash, key, value, null),å¹¶ä¸”æœŸæœ›å€¼æ˜¯null //casæ“ä½œæˆåŠŸ è¡¨ç¤ºokï¼Œç›´æ¥break forå¾ªç¯å³å¯ //casæ“ä½œå¤±è´¥ï¼Œè¡¨ç¤ºåœ¨å½“å‰çº¿ç¨‹ä¹‹å‰ï¼Œæœ‰å…¶å®ƒçº¿ç¨‹å…ˆä½ ä¸€æ­¥å‘æŒ‡å®šiæ¡¶ä½è®¾ç½®å€¼äº†ã€‚ //å½“å‰çº¿ç¨‹åªèƒ½å†æ¬¡è‡ªæ—‹ï¼Œå»èµ°å…¶å®ƒé€»è¾‘ã€‚ if (casTabAt(tab, i, null, new Node&lt;K,V&gt;(hash, key, value, null))) break; // no lock when adding to empty bin &#125; //CASE3ï¼šå‰ç½®æ¡ä»¶ï¼Œæ¡¶ä½çš„å¤´ç»“ç‚¹ä¸€å®šä¸æ˜¯nullã€‚ //æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ ä¸º FWDç»“ç‚¹ï¼Œè¡¨ç¤ºç›®å‰mapæ­£å¤„äºæ‰©å®¹è¿‡ç¨‹ä¸­.. else if ((fh = f.hash) == MOVED) //çœ‹åˆ°fwdèŠ‚ç‚¹åï¼Œå½“å‰èŠ‚ç‚¹æœ‰ä¹‰åŠ¡å¸®åŠ©å½“å‰mapå¯¹è±¡å®Œæˆè¿ç§»æ•°æ®çš„å·¥ä½œ //å¸®åŠ©æ‰©å®¹ tab = helpTransfer(tab, f); //CASE4ï¼šå½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ é“¾è¡¨ ä¹Ÿå¯èƒ½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else &#123; //å½“æ’å…¥keyå­˜åœ¨æ—¶ï¼Œä¼šå°†æ—§å€¼èµ‹å€¼ç»™oldValï¼Œè¿”å›ç»™putæ–¹æ³•è°ƒç”¨å¤„.. V oldVal = null; //ä½¿ç”¨sync åŠ é”â€œå¤´èŠ‚ç‚¹â€ï¼Œç†è®ºä¸Šæ˜¯â€œå¤´ç»“ç‚¹â€ synchronized (f) &#123; //ä¸ºä»€ä¹ˆåˆè¦å¯¹æ¯”ä¸€ä¸‹ï¼Œçœ‹çœ‹å½“å‰æ¡¶ä½çš„å¤´èŠ‚ç‚¹ æ˜¯å¦ä¸º ä¹‹å‰è·å–çš„å¤´ç»“ç‚¹ï¼Ÿ //ä¸ºäº†é¿å…å…¶å®ƒçº¿ç¨‹å°†è¯¥æ¡¶ä½çš„å¤´ç»“ç‚¹ä¿®æ”¹æ‰ï¼Œå¯¼è‡´å½“å‰çº¿ç¨‹ä»sync åŠ é” å°±æœ‰é—®é¢˜äº†ã€‚ä¹‹åæ‰€æœ‰æ“ä½œéƒ½ä¸ç”¨åœ¨åšäº†ã€‚ if (tabAt(tab, i) == f) &#123;//æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å’±ä»¬ åŠ é” çš„å¯¹è±¡æ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥è¿›æ¥é€ äº†ï¼ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰æ¡¶ä½å°±æ˜¯æ™®é€šé“¾è¡¨æ¡¶ä½ã€‚ if (fh &gt;= 0) &#123; //1.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­æ‰€æœ‰å…ƒç´ çš„keyéƒ½ä¸ä¸€è‡´æ—¶ï¼Œå½“å‰çš„æ’å…¥æ“ä½œæ˜¯è¿½åŠ åˆ°é“¾è¡¨çš„æœ«å°¾ï¼ŒbinCountè¡¨ç¤ºé“¾è¡¨é•¿åº¦ //2.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­çš„æŸä¸ªå…ƒç´ çš„keyä¸€è‡´æ—¶ï¼Œå½“å‰æ’å…¥æ“ä½œå¯èƒ½å°±æ˜¯æ›¿æ¢äº†ã€‚binCountè¡¨ç¤ºå†²çªä½ç½®ï¼ˆbinCount - 1ï¼‰ binCount = 1; //è¿­ä»£å¾ªç¯å½“å‰æ¡¶ä½çš„é“¾è¡¨ï¼Œeæ˜¯æ¯æ¬¡å¾ªç¯å¤„ç†èŠ‚ç‚¹ã€‚ for (Node&lt;K,V&gt; e = f;; ++binCount) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹ key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash æˆç«‹ è¡¨ç¤ºå¾ªç¯çš„å½“å‰å…ƒç´ çš„hashå€¼ä¸æ’å…¥èŠ‚ç‚¹çš„hashå€¼ä¸€è‡´ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­ //æ¡ä»¶äºŒï¼š((ek = e.key) == key ||(ek != null &amp;&amp; key.equals(ek))) // æˆç«‹ï¼šè¯´æ˜å¾ªç¯çš„å½“å‰èŠ‚ç‚¹ä¸æ’å…¥èŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå‘ç”Ÿå†²çªäº† if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å°†å½“å‰å¾ªç¯çš„å…ƒç´ çš„ å€¼ èµ‹å€¼ç»™oldVal oldVal = e.val; if (!onlyIfAbsent) e.val = value; break; &#125; //å½“å‰å…ƒç´  ä¸ æ’å…¥å…ƒç´ çš„keyä¸ä¸€è‡´ æ—¶ï¼Œä¼šèµ°ä¸‹é¢ç¨‹åºã€‚ //1.æ›´æ–°å¾ªç¯å¤„ç†èŠ‚ç‚¹ä¸º å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ //2.åˆ¤æ–­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯nullï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»æ˜¯é˜Ÿå°¾äº†ï¼Œæ’å…¥æ•°æ®éœ€è¦è¿½åŠ åˆ°é˜Ÿå°¾èŠ‚ç‚¹çš„åé¢ã€‚ Node&lt;K,V&gt; pred = e; if ((e = e.next) == null) &#123; pred.next = new Node&lt;K,V&gt;(hash, key, value, null); break; &#125; &#125; &#125; //å‰ç½®æ¡ä»¶ï¼Œè¯¥æ¡¶ä½ä¸€å®šä¸æ˜¯é“¾è¡¨ //æ¡ä»¶æˆç«‹ï¼Œè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //p è¡¨ç¤ºçº¢é»‘æ ‘ä¸­å¦‚æœä¸ä½ æ’å…¥èŠ‚ç‚¹çš„key æœ‰å†²çªèŠ‚ç‚¹çš„è¯ ï¼Œåˆ™putTreeVal æ–¹æ³• ä¼šè¿”å›å†²çªèŠ‚ç‚¹çš„å¼•ç”¨ã€‚ Node&lt;K,V&gt; p; //å¼ºåˆ¶è®¾ç½®binCountä¸º2ï¼Œå› ä¸ºbinCount &lt;= 1 æ—¶æœ‰å…¶å®ƒå«ä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸ºäº†2 binCount = 2; //æ¡ä»¶ä¸€ï¼šæˆç«‹ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„keyä¸çº¢é»‘æ ‘ä¸­çš„æŸä¸ªèŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå†²çªäº† if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key, value)) != null) &#123; //å°†å†²çªèŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal oldVal = p.val; if (!onlyIfAbsent) p.val = value; &#125; &#125; &#125; &#125; //è¯´æ˜å½“å‰æ¡¶ä½ä¸ä¸ºnullï¼Œå¯èƒ½æ˜¯çº¢é»‘æ ‘ ä¹Ÿå¯èƒ½æ˜¯é“¾è¡¨ if (binCount != 0) &#123; //å¦‚æœbinCount&gt;=8 è¡¨ç¤ºå¤„ç†çš„æ¡¶ä½ä¸€å®šæ˜¯é“¾è¡¨ if (binCount &gt;= TREEIFY_THRESHOLD) //è°ƒç”¨è½¬åŒ–é“¾è¡¨ä¸ºçº¢é»‘æ ‘çš„æ–¹æ³• treeifyBin(tab, i); //è¯´æ˜å½“å‰çº¿ç¨‹æ’å…¥çš„æ•°æ®keyï¼Œä¸åŸæœ‰k-vå‘ç”Ÿå†²çªï¼Œéœ€è¦å°†åŸæ•°æ®vè¿”å›ç»™è°ƒç”¨è€…ã€‚ if (oldVal != null) return oldVal; break; &#125; &#125; &#125; //1.ç»Ÿè®¡å½“å‰tableä¸€å…±æœ‰å¤šå°‘æ•°æ® //2.åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æ‰©å®¹é˜ˆå€¼æ ‡å‡†ï¼Œè§¦å‘æ‰©å®¹ã€‚ addCount(1L, binCount); return null;&#125; 6 initTableæ•°ç»„åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªåˆé€‚å¤§å°çš„æ•°ç»„ã€‚ sizeCtl ï¼šè¿™ä¸ªæ ‡å¿—æ˜¯åœ¨ Node æ•°ç»„åˆå§‹åŒ–æˆ–è€…æ‰©å®¹çš„æ—¶å€™çš„ä¸€ä¸ªæ§åˆ¶ä½æ ‡è¯†ï¼Œè´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–è€…æ‰©å®¹æ“ä½œã€‚ -1 ä»£è¡¨æ­£åœ¨åˆå§‹åŒ– -N ä»£è¡¨æœ‰ N-1 ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè¿™é‡Œä¸æ˜¯ç®€å•çš„ç†è§£æˆ n ä¸ªçº¿ç¨‹ï¼ŒsizeCtl å°±æ˜¯-N 0 æ ‡è¯† Node æ•°ç»„è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œæ­£æ•°ä»£è¡¨åˆå§‹åŒ–æˆ–è€…ä¸‹ä¸€æ¬¡æ‰©å®¹çš„å¤§å° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455/** * Initializes table, using the size recorded in sizeCtl. * * sizeCtl &lt; 0 * * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * * * sizeCtl &gt; 0 * * * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private final Node&lt;K,V&gt;[] initTable() &#123; //tab å¼•ç”¨map.table //sc sizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab; int sc; //è‡ªæ—‹ æ¡ä»¶ï¼šmap.table å°šæœªåˆå§‹åŒ– while ((tab = table) == null || tab.length == 0) &#123; if ((sc = sizeCtl) &lt; 0) //å¤§æ¦‚ç‡å°±æ˜¯-1ï¼Œè¡¨ç¤ºå…¶å®ƒçº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆ›å»ºtableçš„è¿‡ç¨‹ï¼Œå½“å‰çº¿ç¨‹æ²¡æœ‰ç«äº‰åˆ°åˆå§‹åŒ–tableçš„é”ã€‚ Thread.yield(); // lost initialization race; just spin //1.sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° //2.å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° //3.å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123; try &#123; //è¿™é‡Œä¸ºä»€ä¹ˆåˆè¦åˆ¤æ–­å‘¢ï¼Ÿ é˜²æ­¢å…¶å®ƒçº¿ç¨‹å·²ç»åˆå§‹åŒ–å®Œæ¯•äº†ï¼Œç„¶åå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–..å¯¼è‡´ä¸¢å¤±æ•°æ®ã€‚ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å…¶å®ƒçº¿ç¨‹éƒ½æ²¡æœ‰è¿›å…¥è¿‡è¿™ä¸ªifå—ï¼Œå½“å‰çº¿ç¨‹å°±æ˜¯å…·å¤‡åˆå§‹åŒ–tableæƒåˆ©äº†ã€‚ if ((tab = table) == null || tab.length == 0) &#123; //scå¤§äº0 åˆ›å»ºtableæ—¶ ä½¿ç”¨ scä¸ºæŒ‡å®šå¤§å°ï¼Œå¦åˆ™ä½¿ç”¨ 16 é»˜è®¤å€¼. int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY; @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n]; //æœ€ç»ˆèµ‹å€¼ç»™ map.table table = tab = nt; //n &gt;&gt;&gt; 2 =&gt; ç­‰äº 1/4 n n - (1/4)n = 3/4 n =&gt; 0.75 * n //sc 0.75 n è¡¨ç¤ºä¸‹ä¸€æ¬¡æ‰©å®¹æ—¶çš„è§¦å‘æ¡ä»¶ã€‚ sc = n - (n &gt;&gt;&gt; 2); &#125; &#125; finally &#123; //1.å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹è¯ï¼Œscè¡¨ç¤ºçš„æ˜¯ ä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼ //2.è¡¨ç¤ºå½“å‰çº¿ç¨‹ å¹¶ä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥åˆ°else if å— æ—¶ï¼Œå°† //sizeCtl è®¾ç½®ä¸ºäº†-1 ï¼Œé‚£ä¹ˆè¿™æ—¶éœ€è¦å°†å…¶ä¿®æ”¹ä¸º è¿›å…¥æ—¶çš„å€¼ã€‚ sizeCtl = sc; &#125; break; &#125; &#125; return tab;&#125; 7 addCount123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124private final void addCount(long x, int check) &#123; //as è¡¨ç¤º LongAdder.cells //b è¡¨ç¤ºLongAdder.base //s è¡¨ç¤ºå½“å‰map.tableä¸­å…ƒç´ çš„æ•°é‡ CounterCell[] as; long b, s; //æ¡ä»¶ä¸€ï¼štrue-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®ç´¯åŠ åˆ° base //æ¡ä»¶äºŒï¼šfalse-&gt;è¡¨ç¤ºå†™baseæˆåŠŸï¼Œæ•°æ®ç´¯åŠ åˆ°baseä¸­äº†ï¼Œå½“å‰ç«äº‰ä¸æ¿€çƒˆï¼Œä¸éœ€è¦åˆ›å»ºcells // true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ if ((as = counterCells) != null || !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) &#123; //æœ‰å‡ ç§æƒ…å†µè¿›å…¥åˆ°ifå—ä¸­ï¼Ÿ //1.true-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® //2.true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ //a è¡¨ç¤ºå½“å‰çº¿ç¨‹hashå¯»å€å‘½ä¸­çš„cell CounterCell a; //v è¡¨ç¤ºå½“å‰çº¿ç¨‹å†™cellæ—¶çš„æœŸæœ›å€¼ long v; //m è¡¨ç¤ºå½“å‰cellsæ•°ç»„çš„é•¿åº¦ int m; //true -&gt; æœªç«äº‰ false-&gt;å‘ç”Ÿç«äº‰ boolean uncontended = true; //æ¡ä»¶ä¸€ï¼šas == null || (m = as.length - 1) &lt; 0 //true-&gt; è¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯é€šè¿‡ å†™baseç«äº‰å¤±è´¥ ç„¶åè¿›å…¥çš„ifå—ï¼Œå°±éœ€è¦è°ƒç”¨fullAddCountæ–¹æ³•å»æ‰©å®¹ æˆ–è€… é‡è¯•.. LongAdder.longAccumulate //æ¡ä»¶äºŒï¼ša = as[ThreadLocalRandom.getProbe() &amp; m]) == null å‰ç½®æ¡ä»¶ï¼šcellså·²ç»åˆå§‹åŒ–äº† //true-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„cellè¡¨æ ¼æ˜¯ä¸ªç©ºï¼Œéœ€è¦å½“å‰çº¿ç¨‹è¿›å…¥fullAddCountæ–¹æ³•å»åˆå§‹åŒ– cellï¼Œæ”¾å…¥å½“å‰ä½ç½®. //æ¡ä»¶ä¸‰ï¼š!(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x) // false-&gt;å–åå¾—åˆ°falseï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellæˆåŠŸ // true-&gt;å–åå¾—åˆ°true,è¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellå¤±è´¥ï¼Œéœ€è¦è¿›å…¥fullAddCountè¿›è¡Œé‡è¯• æˆ–è€… æ‰©å®¹ cellsã€‚ if (as == null || (m = as.length - 1) &lt; 0 || (a = as[ThreadLocalRandom.getProbe() &amp; m]) == null || !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x)) ) &#123; fullAddCount(x, uncontended); //è€ƒè™‘åˆ°fullAddCounté‡Œé¢çš„äº‹æƒ…æ¯”è¾ƒç´¯ï¼Œå°±è®©å½“å‰çº¿ç¨‹ ä¸å‚ä¸åˆ° æ‰©å®¹ç›¸å…³çš„é€»è¾‘äº†ï¼Œç›´æ¥è¿”å›åˆ°è°ƒç”¨ç‚¹ã€‚ return; &#125; if (check &lt;= 1) return; //è·å–å½“å‰æ•£åˆ—è¡¨å…ƒç´ ä¸ªæ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæœŸæœ›å€¼ s = sumCount(); &#125; //è¡¨ç¤ºä¸€å®šæ˜¯ä¸€ä¸ªputæ“ä½œè°ƒç”¨çš„addCount if (check &gt;= 0) &#123; //tab è¡¨ç¤ºmap.table //nt è¡¨ç¤ºmap.nextTable //n è¡¨ç¤ºmap.tableæ•°ç»„çš„é•¿åº¦ //sc è¡¨ç¤ºsizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab, nt; int n, sc; /** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */ //è‡ªæ—‹ //æ¡ä»¶ä¸€ï¼šs &gt;= (long)(sc = sizeCtl) // true-&gt; 1.å½“å‰sizeCtlä¸ºä¸€ä¸ªè´Ÿæ•° è¡¨ç¤ºæ­£åœ¨æ‰©å®¹ä¸­.. // 2.å½“å‰sizeCtlæ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œè¡¨ç¤ºæ‰©å®¹é˜ˆå€¼ // false-&gt; è¡¨ç¤ºå½“å‰tableå°šæœªè¾¾åˆ°æ‰©å®¹æ¡ä»¶ //æ¡ä»¶äºŒï¼š(tab = table) != null // æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š(n = tab.length) &lt; MAXIMUM_CAPACITY // true-&gt;å½“å‰tableé•¿åº¦å°äºæœ€å¤§å€¼é™åˆ¶ï¼Œåˆ™å¯ä»¥è¿›è¡Œæ‰©å®¹ã€‚ while (s &gt;= (long)(sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp; (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123; //æ‰©å®¹æ‰¹æ¬¡å”¯ä¸€æ ‡è¯†æˆ³ //16 -&gt; 32 æ‰©å®¹ æ ‡è¯†ä¸ºï¼š1000 0000 0001 1011 int rs = resizeStamp(n); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰tableæ­£åœ¨æ‰©å®¹ // å½“å‰çº¿ç¨‹ç†è®ºä¸Šåº”è¯¥ååŠ©tableå®Œæˆæ‰©å®¹ if (sc &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼š(nt = nextTable) == null // true-&gt;è¡¨ç¤ºæœ¬æ¬¡æ‰©å®¹ç»“æŸ // false-&gt;æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || (nt = nextTable) == null || transferIndex &lt;= 0) break; //å‰ç½®æ¡ä»¶ï¼šå½“å‰tableæ­£åœ¨æ‰§è¡Œæ‰©å®¹ä¸­.. å½“å‰çº¿ç¨‹æœ‰æœºä¼šå‚ä¸è¿›æ‰©å®¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹æˆåŠŸå‚ä¸åˆ°æ‰©å®¹ä»»åŠ¡ä¸­ï¼Œå¹¶ä¸”å°†scä½16ä½å€¼åŠ 1ï¼Œè¡¨ç¤ºå¤šäº†ä¸€ä¸ªçº¿ç¨‹å‚ä¸å·¥ä½œ //æ¡ä»¶å¤±è´¥ï¼š1.å½“å‰æœ‰å¾ˆå¤šçº¿ç¨‹éƒ½åœ¨æ­¤å¤„å°è¯•ä¿®æ”¹sizeCtlï¼Œæœ‰å…¶å®ƒä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æˆåŠŸäº†ï¼Œå¯¼è‡´ä½ çš„scæœŸæœ›å€¼ä¸å†…å­˜ä¸­çš„å€¼ä¸ä¸€è‡´ ä¿®æ”¹å¤±è´¥ // 2.transfer ä»»åŠ¡å†…éƒ¨çš„çº¿ç¨‹ä¹Ÿä¿®æ”¹äº†sizeCtlã€‚ if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) //ååŠ©æ‰©å®¹çº¿ç¨‹ï¼ŒæŒæœ‰nextTableå‚æ•° transfer(tab, nt); &#125; //1000 0000 0001 1011 0000 0000 0000 0000 +2 =&gt; 1000 0000 0001 1011 0000 0000 0000 0010 //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯è§¦å‘æ‰©å®¹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨transferæ–¹æ³•éœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ else if (U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)) //è§¦å‘æ‰©å®¹æ¡ä»¶çš„çº¿ç¨‹ ä¸æŒæœ‰nextTable transfer(tab, null); s = sumCount(); &#125; &#125;&#125; 8. transferConcurrentHashMap æ”¯æŒå¹¶å‘æ‰©å®¹ï¼Œå®ç°æ–¹å¼æ˜¯ï¼ŒæŠŠ Node æ•°ç»„è¿›è¡Œæ‹†åˆ†ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å¤„ç†è‡ªå·±çš„åŒºåŸŸï¼Œå‡è®¾ table æ•°ç»„æ€»é•¿åº¦æ˜¯ 64ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹å¯ä»¥åˆ†åˆ° 16 ä¸ª bucketã€‚ç„¶åæ¯ä¸ªçº¿ç¨‹å¤„ç†çš„èŒƒå›´ï¼ŒæŒ‰ç…§å€’åºæ¥åšè¿ç§»ã€‚ é€šè¿‡ for è‡ªå¾ªç¯å¤„ç†æ¯ä¸ªæ§½ä½ä¸­çš„é“¾è¡¨å…ƒç´ ï¼Œé»˜è®¤ advace ä¸ºçœŸï¼Œé€šè¿‡ CAS è®¾ç½® transferIndexå±æ€§å€¼ï¼Œå¹¶åˆå§‹åŒ– i å’Œ bound å€¼ï¼Œi æŒ‡å½“å‰å¤„ç†çš„æ§½ä½åºå·ï¼Œbound æŒ‡éœ€è¦å¤„ç†çš„æ§½ä½è¾¹ç•Œï¼Œå…ˆå¤„ç†æ§½ä½ 31 çš„èŠ‚ç‚¹ï¼› ï¼ˆbound,iï¼‰ =(16,31) ä» 31 çš„ä½ç½®å¾€å‰æ¨åŠ¨ã€‚â€‹ æ¯å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ‰©å®¹æ“ä½œï¼Œå°±é€šè¿‡ cas æ‰§è¡Œ sc-1ã€‚ æ¥ç€åˆ¤æ–­(sc-2) !=resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT ; å¦‚æœç›¸ç­‰ï¼Œè¡¨ç¤ºå½“å‰ä¸ºæ•´ä¸ªæ‰©å®¹æ“ä½œçš„ æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæ„å‘³ç€æ•´ä¸ªæ‰©å®¹æ“ä½œå°±ç»“æŸäº†ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜è¿˜å¾—ç»§ç»­ã€‚ è¿™ä¹ˆåšçš„ç›®çš„ï¼Œä¸€æ–¹é¢æ˜¯é˜²æ­¢ä¸åŒæ‰©å®¹ä¹‹é—´å‡ºç°ç›¸åŒçš„ sizeCtlï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œè¿˜å¯ä»¥é¿å…sizeCtl çš„ ABA é—®é¢˜å¯¼è‡´çš„æ‰©å®¹é‡å çš„æƒ…å†µã€‚â€‹ æ‰©å®¹å›¾è§£lastRunæœºåˆ¶åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å½“æ›´æ–°åçš„é”®å€¼å¯¹æ€»æ•° baseCount &gt;= é˜ˆå€¼ sizeCtl æ—¶ï¼Œè¿›è¡Œrehashï¼Œè¿™é‡Œé¢ä¼šæœ‰ä¸¤ä¸ªé€»è¾‘ã€‚ å¦‚æœå½“å‰æ­£åœ¨å¤„äºæ‰©å®¹é˜¶æ®µï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šåŠ å…¥å¹¶ä¸”ååŠ©æ‰©å®¹ã€‚ å¦‚æœå½“å‰æ²¡æœ‰åœ¨æ‰©å®¹ï¼Œåˆ™ç›´æ¥è§¦å‘æ‰©å®¹æ“ä½œã€‚ â€‹ æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹æ•°æ®çš„è½¬ç§»å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯æŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ä½†æ˜¯è¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåœ¨æ‰©å®¹çš„æ—¶å€™å…¶ä»–çº¿ç¨‹ä¹Ÿå¯èƒ½æ­£åœ¨æ·»åŠ å…ƒç´ ï¼Œè¿™æ—¶åˆè§¦å‘äº†æ‰©å®¹æ€ä¹ˆåŠï¼Ÿå¯èƒ½å¤§å®¶æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯åŠ äº’æ–¥é”ï¼ŒæŠŠè½¬ç§»è¿‡ç¨‹é”ä½ï¼Œè™½ç„¶æ˜¯å¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ä¼šå¸¦æ¥è¾ƒå¤§çš„æ€§èƒ½å¼€é”€ã€‚å› ä¸ºäº’æ–¥é”ä¼šå¯¼è‡´æ‰€æœ‰è®¿é—®ä¸´ç•ŒåŒºçš„çº¿ç¨‹é™·å…¥åˆ°é˜»å¡çŠ¶æ€ï¼ŒæŒæœ‰é”çš„çº¿ç¨‹è€—æ—¶è¶Šé•¿ï¼Œå…¶ä»–ç«äº‰çº¿ç¨‹å°±ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œå¯¼è‡´ååé‡è¾ƒä½ã€‚è€Œä¸”è¿˜å¯èƒ½å¯¼è‡´æ­»é”ã€‚ è€Œ ConcurrentHashMap å¹¶æ²¡æœ‰ç›´æ¥åŠ é”ï¼Œè€Œæ˜¯é‡‡ç”¨ CAS å®ç°æ— é”çš„å¹¶å‘åŒæ­¥ç­–ç•¥ï¼Œæœ€ç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ã€‚ å®ƒæŠŠ Node æ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹é”è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingNodeèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹å®ƒçš„æºç å®ç°ã€‚ fwd:è¿™ä¸ªç±»æ˜¯ä¸ªæ ‡è¯†ç±»ï¼Œç”¨äºæŒ‡å‘æ–°è¡¨ç”¨çš„ï¼Œå…¶ä»–çº¿ç¨‹é‡åˆ°è¿™ä¸ªç±»ä¼šä¸»åŠ¨è·³è¿‡è¿™ä¸ªç±»ï¼Œå› ä¸ºè¿™ä¸ªç±»è¦ä¹ˆå°±æ˜¯æ‰©å®¹è¿ç§»æ­£åœ¨è¿›è¡Œï¼Œè¦ä¹ˆå°±æ˜¯å·²ç»å®Œæˆæ‰©å®¹è¿ç§»ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªç±»è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå†è¿›è¡Œæ“ä½œã€‚ advance:è¿™ä¸ªå˜é‡æ˜¯ç”¨äºæç¤ºä»£ç æ˜¯å¦è¿›è¡Œæ¨è¿›å¤„ç†ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ¡¶å¤„ç†å®Œï¼Œå¤„ç†ä¸‹ä¸€ä¸ªæ¡¶çš„æ ‡è¯†ã€‚ finishing:è¿™ä¸ªå˜é‡ç”¨äºæç¤ºæ‰©å®¹æ˜¯å¦ç»“æŸç”¨çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237private final void transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab) &#123; //n è¡¨ç¤ºæ‰©å®¹ä¹‹å‰tableæ•°ç»„çš„é•¿åº¦ //stride è¡¨ç¤ºåˆ†é…ç»™çº¿ç¨‹ä»»åŠ¡çš„æ­¥é•¿ int n = tab.length, stride; // stride å›ºå®šä¸º 16 if ((stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE) stride = MIN_TRANSFER_STRIDE; // subdivide range //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä¸ºè§¦å‘æœ¬æ¬¡æ‰©å®¹çš„çº¿ç¨‹ï¼Œéœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯ååŠ©æ‰©å®¹çš„çº¿ç¨‹.. if (nextTab == null) &#123; // initiating try &#123; //åˆ›å»ºäº†ä¸€ä¸ªæ¯”æ‰©å®¹ä¹‹å‰å¤§ä¸€å€çš„table @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n &lt;&lt; 1]; nextTab = nt; &#125; catch (Throwable ex) &#123; // try to cope with OOME sizeCtl = Integer.MAX_VALUE; return; &#125; //èµ‹å€¼ç»™å¯¹è±¡å±æ€§ nextTable ï¼Œæ–¹ä¾¿ååŠ©æ‰©å®¹çº¿ç¨‹ æ‹¿åˆ°æ–°è¡¨ nextTable = nextTab; //è®°å½•è¿ç§»æ•°æ®æ•´ä½“ä½ç½®çš„ä¸€ä¸ªæ ‡è®°ã€‚indexè®¡æ•°æ˜¯ä»1å¼€å§‹è®¡ç®—çš„ã€‚ transferIndex = n; &#125; //è¡¨ç¤ºæ–°æ•°ç»„çš„é•¿åº¦ int nextn = nextTab.length; //fwd èŠ‚ç‚¹ï¼Œå½“æŸä¸ªæ¡¶ä½æ•°æ®å¤„ç†å®Œæ¯•åï¼Œå°†æ­¤æ¡¶ä½è®¾ç½®ä¸ºfwdèŠ‚ç‚¹ï¼Œå…¶å®ƒå†™çº¿ç¨‹ æˆ–è¯»çº¿ç¨‹çœ‹åˆ°åï¼Œä¼šæœ‰ä¸åŒé€»è¾‘ã€‚ ForwardingNode&lt;K,V&gt; fwd = new ForwardingNode&lt;K,V&gt;(nextTab); //æ¨è¿›æ ‡è®° boolean advance = true; //å®Œæˆæ ‡è®° boolean finishing = false; // to ensure sweep before committing nextTab //i è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡ï¼Œæ‰§è¡Œåˆ°çš„æ¡¶ä½ //bound è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡çš„ä¸‹ç•Œé™åˆ¶ int i = 0, bound = 0; //è‡ªæ—‹ for (;;) &#123; //f æ¡¶ä½çš„å¤´ç»“ç‚¹ //fh å¤´ç»“ç‚¹çš„hash Node&lt;K,V&gt; f; int fh; /** * 1.ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡åŒºé—´ * 2.ç»´æŠ¤å½“å‰çº¿ç¨‹ä»»åŠ¡è¿›åº¦ï¼ˆi è¡¨ç¤ºå½“å‰å¤„ç†çš„æ¡¶ä½ï¼‰ * 3.ç»´æŠ¤mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„è¿›åº¦ */ while (advance) &#123; //åˆ†é…ä»»åŠ¡çš„å¼€å§‹ä¸‹æ ‡ //åˆ†é…ä»»åŠ¡çš„ç»“æŸä¸‹æ ‡ int nextIndex, nextBound; //CASE1: //æ¡ä»¶ä¸€ï¼š--i &gt;= bound //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œè¿˜æœ‰ç›¸åº”çš„åŒºé—´çš„æ¡¶ä½è¦å¤„ç†ï¼Œ--i å°±è®©å½“å‰çº¿ç¨‹å¤„ç†ä¸‹ä¸€ä¸ª æ¡¶ä½. //ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… if (--i &gt;= bound || finishing) advance = false; //CASE2: //å‰ç½®æ¡ä»¶ï¼šå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½éƒ½åˆ†é…å®Œæ¯•äº†ï¼Œæ²¡æœ‰åŒºé—´å¯åˆ†é…äº†ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹çš„iå˜é‡ä¸º-1 è·³å‡ºå¾ªç¯åï¼Œæ‰§è¡Œé€€å‡ºè¿ç§»ä»»åŠ¡ç›¸å…³çš„ç¨‹åº //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½å°šæœªåˆ†é…å®Œæ¯•ï¼Œè¿˜æœ‰åŒºé—´å¯åˆ†é… else if ((nextIndex = transferIndex) &lt;= 0) &#123; i = -1; advance = false; &#125; //CASE3: //å‰ç½®æ¡ä»¶ï¼š1ã€å½“å‰çº¿ç¨‹éœ€è¦åˆ†é…ä»»åŠ¡åŒºé—´ 2.å…¨å±€èŒƒå›´å†…è¿˜æœ‰æ¡¶ä½å°šæœªè¿ç§» //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡æˆåŠŸ //æ¡ä»¶å¤±è´¥ï¼šè¯´æ˜åˆ†é…ç»™å½“å‰çº¿ç¨‹å¤±è´¥ï¼Œåº”è¯¥æ˜¯å’Œå…¶å®ƒçº¿ç¨‹å‘ç”Ÿäº†ç«äº‰å§ else if (U.compareAndSwapInt (this, TRANSFERINDEX, nextIndex, nextBound = (nextIndex &gt; stride ? nextIndex - stride : 0))) &#123; bound = nextBound; i = nextIndex - 1; advance = false; &#125; &#125; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼ši &lt; 0 //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æœªåˆ†é…åˆ°ä»»åŠ¡ if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) &#123; //ä¿å­˜sizeCtl çš„å˜é‡ int sc; if (finishing) &#123; nextTable = null; table = nextTab; sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1); return; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜è®¾ç½®sizeCtl ä½16ä½ -1 æˆåŠŸï¼Œå½“å‰çº¿ç¨‹å¯ä»¥æ­£å¸¸é€€å‡º if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) &#123; //1000 0000 0001 1011 0000 0000 0000 0000 //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹ä¸æ˜¯æœ€åä¸€ä¸ªé€€å‡ºtransferä»»åŠ¡çš„çº¿ç¨‹ if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT) //æ­£å¸¸é€€å‡º return; finishing = advance = true; i = n; // recheck before commit &#125; &#125; //å‰ç½®æ¡ä»¶ï¼šã€CASE2~CASE4ã€‘ å½“å‰çº¿ç¨‹ä»»åŠ¡å°šæœªå¤„ç†å®Œï¼Œæ­£åœ¨è¿›è¡Œä¸­ //CASE2: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½æœªå­˜æ”¾æ•°æ®ï¼Œåªéœ€è¦å°†æ­¤å¤„è®¾ç½®ä¸ºfwdèŠ‚ç‚¹å³å¯ã€‚ else if ((f = tabAt(tab, i)) == null) advance = casTabAt(tab, i, null, fwd); //CASE3: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½å·²ç»è¿ç§»è¿‡äº†ï¼Œå½“å‰çº¿ç¨‹ä¸ç”¨å†å¤„ç†äº†ï¼Œç›´æ¥å†æ¬¡æ›´æ–°å½“å‰çº¿ç¨‹ä»»åŠ¡ç´¢å¼•ï¼Œå†æ¬¡å¤„ç†ä¸‹ä¸€ä¸ªæ¡¶ä½ æˆ–è€… å…¶å®ƒæ“ä½œ else if ((fh = f.hash) == MOVED) advance = true; // already processed //CASE4: //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œè€Œä¸”nodeèŠ‚ç‚¹ ä¸æ˜¯ fwdèŠ‚ç‚¹ï¼Œè¯´æ˜è¿™äº›æ•°æ®éœ€è¦è¿ç§»ã€‚ else &#123; //sync åŠ é”å½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ synchronized (f) &#123; //é˜²æ­¢åœ¨ä½ åŠ é”å¤´å¯¹è±¡ä¹‹å‰ï¼Œå½“å‰æ¡¶ä½çš„å¤´å¯¹è±¡è¢«å…¶å®ƒå†™çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œå¯¼è‡´ä½ ç›®å‰åŠ é”å¯¹è±¡é”™è¯¯... if (tabAt(tab, i) == f) &#123; //ln è¡¨ç¤ºä½ä½é“¾è¡¨å¼•ç”¨ //hn è¡¨ç¤ºé«˜ä½é“¾è¡¨å¼•ç”¨ Node&lt;K,V&gt; ln, hn; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯é“¾è¡¨æ¡¶ä½ if (fh &gt;= 0) &#123; //lastRun //å¯ä»¥è·å–å‡º å½“å‰é“¾è¡¨ æœ«å°¾è¿ç»­é«˜ä½ä¸å˜çš„ node int runBit = fh &amp; n; Node&lt;K,V&gt; lastRun = f; for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º ä½ä½é“¾è¡¨ï¼Œé‚£ä¹ˆå°±è®© ln æŒ‡å‘ ä½ä½é“¾è¡¨ if (runBit == 0) &#123; ln = lastRun; hn = null; &#125; //å¦åˆ™ï¼Œè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º é«˜ä½é“¾è¡¨ï¼Œå°±è®© hn æŒ‡å‘ é«˜ä½é“¾è¡¨ else &#123; hn = lastRun; ln = null; &#125; for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn); &#125; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //è½¬æ¢å¤´ç»“ç‚¹ä¸º treeBinå¼•ç”¨ t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //ä½ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘ä½ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘ä½ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; lo = null, loTail = null; //é«˜ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘é«˜ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘é«˜ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; hi = null, hiTail = null; //lc è¡¨ç¤ºä½ä½é“¾è¡¨å…ƒç´ æ•°é‡ //hc è¡¨ç¤ºé«˜ä½é“¾è¡¨å…ƒç´ æ•°é‡ int lc = 0, hc = 0; //è¿­ä»£TreeBinä¸­çš„åŒå‘é“¾è¡¨ï¼Œä»å¤´ç»“ç‚¹ è‡³ å°¾èŠ‚ç‚¹ for (Node&lt;K,V&gt; e = t.first; e != null; e = e.next) &#123; // h è¡¨ç¤ºå¾ªç¯å¤„ç†å½“å‰å…ƒç´ çš„ hash int h = e.hash; //ä½¿ç”¨å½“å‰èŠ‚ç‚¹ æ„å»ºå‡ºæ¥çš„ æ–°çš„ TreeNode TreeNode&lt;K,V&gt; p = new TreeNode&lt;K,V&gt; (h, e.key, e.val, null, null); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹ å±äºä½ä½é“¾ èŠ‚ç‚¹ if ((h &amp; n) == 0) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰ä½ä½é“¾è¡¨ è¿˜æ²¡æœ‰æ•°æ® if ((p.prev = loTail) == null) lo = p; //è¯´æ˜ ä½ä½é“¾è¡¨å·²ç»æœ‰æ•°æ®äº†ï¼Œæ­¤æ—¶å½“å‰å…ƒç´  è¿½åŠ åˆ° ä½ä½é“¾è¡¨çš„æœ«å°¾å°±è¡Œäº† else loTail.next = p; //å°†ä½ä½é“¾è¡¨å°¾æŒ‡é’ˆæŒ‡å‘ p èŠ‚ç‚¹ loTail = p; ++lc; &#125; //å½“å‰èŠ‚ç‚¹ å±äº é«˜ä½é“¾ èŠ‚ç‚¹ else &#123; if ((p.prev = hiTail) == null) hi = p; else hiTail.next = p; hiTail = p; ++hc; &#125; &#125; ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) : (hc != 0) ? new TreeBin&lt;K,V&gt;(lo) : t; hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) : (lc != 0) ? new TreeBin&lt;K,V&gt;(hi) : t; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; &#125; &#125; &#125; &#125;&#125; é“¾è¡¨è¿ç§»åŸç† 1ï¼‰é«˜ä½ä½åŸç†åˆ†æConcurrentHashMap åœ¨åšé“¾è¡¨è¿ç§»æ—¶ï¼Œä¼šç”¨é«˜ä½ä½æ¥å®ç°ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜è¦åˆ†æä¸€ä¸‹ 1ï¼Œå¦‚ä½•å®ç°é«˜ä½ä½é“¾è¡¨çš„åŒºåˆ† å‡å¦‚æœ‰è¿™æ ·ä¸€ä¸ªé˜Ÿåˆ— ç¬¬ 14 ä¸ªæ§½ä½æ’å…¥æ–°èŠ‚ç‚¹ä¹‹åï¼Œé“¾è¡¨å…ƒç´ ä¸ªæ•°å·²ç»è¾¾åˆ°äº† 8ï¼Œä¸”æ•°ç»„é•¿åº¦ä¸º 16ï¼Œä¼˜å…ˆé€šè¿‡æ‰©å®¹æ¥ç¼“è§£é“¾è¡¨è¿‡é•¿çš„é—®é¢˜ å‡å¦‚å½“å‰çº¿ç¨‹æ­£åœ¨å¤„ç†æ§½ä½ä¸º 14 çš„èŠ‚ç‚¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œåœ¨ä»£ç ä¸­ï¼Œé¦–å…ˆå®šä¹‰ä¸¤ä¸ªå˜é‡èŠ‚ç‚¹ ln å’Œ hnï¼Œå®é™…å°±æ˜¯ lowNode å’Œ HighNodeï¼Œåˆ†åˆ«ä¿å­˜ hash å€¼çš„ç¬¬ x ä½ä¸º 0 å’Œä¸ç­‰äº0 çš„èŠ‚ç‚¹ é€šè¿‡ fn&amp;n å¯ä»¥æŠŠè¿™ä¸ªé“¾è¡¨ä¸­çš„å…ƒç´ åˆ†ä¸ºä¸¤ç±»ï¼ŒA ç±»æ˜¯ hash å€¼çš„ç¬¬ X ä½ä¸º 0ï¼ŒB ç±»æ˜¯ hash å€¼çš„ç¬¬ x ä½ä¸ºä¸ç­‰äº 0ï¼ˆè‡³äºä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåŒºåˆ†ï¼Œç¨ååˆ†æï¼‰ï¼Œå¹¶ä¸”é€šè¿‡ lastRun è®°å½•æœ€åè¦å¤„ç†çš„èŠ‚ç‚¹ã€‚æœ€ç»ˆè¦è¾¾åˆ°çš„ç›®çš„æ˜¯ï¼ŒA ç±»çš„é“¾è¡¨ä¿æŒä½ç½®ä¸åŠ¨ï¼ŒB ç±»çš„é“¾è¡¨ä¸º 14+16(æ‰©å®¹å¢åŠ çš„é•¿åº¦)=30 æŠŠ 14 æ§½ä½çš„é“¾è¡¨å•ç‹¬ä¼¶å‡ºæ¥ï¼Œç”¨è“è‰²è¡¨ç¤º fn&amp;n=0 çš„èŠ‚ç‚¹ï¼Œå‡å¦‚é“¾è¡¨çš„åˆ†ç±»æ˜¯è¿™æ · 1234567for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125;&#125; é€šè¿‡ä¸Šé¢è¿™æ®µä»£ç éå†ï¼Œä¼šè®°å½• runBit ä»¥åŠ lastRunï¼ŒæŒ‰ç…§ä¸Šé¢è¿™ä¸ªç»“æ„ï¼Œé‚£ä¹ˆ runBit åº”è¯¥æ˜¯è“è‰²èŠ‚ç‚¹ï¼ŒlastRun åº”è¯¥æ˜¯ç¬¬ 6 ä¸ªèŠ‚ç‚¹æ¥ç€ï¼Œå†é€šè¿‡è¿™æ®µä»£ç è¿›è¡Œéå†ï¼Œç”Ÿæˆ ln é“¾ä»¥åŠ hn é“¾ 1234567for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn);&#125; æ¥ç€ï¼Œé€šè¿‡ CAS æ“ä½œï¼ŒæŠŠ hn é“¾æ”¾åœ¨ i+n ä¹Ÿå°±æ˜¯ 14+16 çš„ä½ç½®ï¼Œln é“¾ä¿æŒåŸæ¥çš„ä½ç½®ä¸åŠ¨ã€‚å¹¶ä¸”è®¾ç½®å½“å‰èŠ‚ç‚¹ä¸º fwdï¼Œè¡¨ç¤ºå·²ç»è¢«å½“å‰çº¿ç¨‹è¿ç§»å®Œäº†ã€‚ 123setTabAt(nextTab, i, ln);setTabAt(nextTab, i + n, hn);setTabAt(tab, i, fwd); è¿ç§»å®Œæˆä»¥åçš„æ•°æ®åˆ†å¸ƒå¦‚ä¸‹ 2ï¼‰ä¸ºä»€ä¹ˆè¦åšé«˜ä½ä½çš„åˆ’åˆ†è¦æƒ³äº†è§£è¿™ä¹ˆè®¾è®¡çš„ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦ä» ConcurrentHashMap çš„æ ¹æ®ä¸‹æ ‡è·å–å¯¹è±¡çš„ç®—æ³•æ¥çœ‹ï¼Œåœ¨ putVal æ–¹æ³•ä¸­ 1018 è¡Œï¼š 1(f = tabAt(tab, i = (n - 1) &amp; hash)) == null é€šè¿‡(n-1) &amp; hash æ¥è·å¾—åœ¨ table ä¸­çš„æ•°ç»„ä¸‹æ ‡æ¥è·å–èŠ‚ç‚¹æ•°æ®ï¼Œã€&amp;è¿ç®—æ˜¯äºŒè¿›åˆ¶è¿ç®—ç¬¦ï¼Œ1&amp; 1=1ï¼Œå…¶ä»–éƒ½ä¸º 0ã€‘ã€‚ 9.helpTransferå¦‚æœå¯¹åº”çš„èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹çš„ hash æ˜¯ä¸æ˜¯ç­‰äº MOVED(-1)ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ForwardingNode èŠ‚ç‚¹ï¼Œæ„å‘³ç€æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œé‚£ä¹ˆå½“å‰ç°åœ¨ç›´æ¥å¸®åŠ©å®ƒè¿›è¡Œæ‰©å®¹ï¼Œå› æ­¤è°ƒç”¨ helpTransferæ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455final Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123; //nextTab å¼•ç”¨çš„æ˜¯ fwd.nextTable == map.nextTable ç†è®ºä¸Šæ˜¯è¿™æ ·ã€‚ //sc ä¿å­˜map.sizeCtl Node&lt;K,V&gt;[] nextTab; int sc; //æ¡ä»¶ä¸€ï¼štab != null æ’æˆç«‹ true //æ¡ä»¶äºŒï¼š(f instanceof ForwardingNode) æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š((ForwardingNode&lt;K,V&gt;)f).nextTable) != null æ’æˆç«‹ true if (tab != null &amp;&amp; (f instanceof ForwardingNode) &amp;&amp; (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != null) &#123; //æ‹¿å½“å‰æ ‡çš„é•¿åº¦ è·å– æ‰©å®¹æ ‡è¯†æˆ³ å‡è®¾ 16 -&gt; 32 æ‰©å®¹ï¼š1000 0000 0001 1011 int rs = resizeStamp(tab.length); //æ¡ä»¶ä¸€ï¼šnextTab == nextTable //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼š1.nextTableè¢«è®¾ç½®ä¸ºNull äº†ï¼Œæ‰©å®¹å®Œæ¯•åï¼Œä¼šè¢«è®¾ä¸ºNull // 2.å†æ¬¡å‡ºå‘æ‰©å®¹äº†...å’±ä»¬æ‹¿åˆ°çš„nextTab ä¹Ÿå·²ç»è¿‡æœŸäº†... //æ¡ä»¶äºŒï¼štable == tab //æˆç«‹ï¼šè¯´æ˜ æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¿˜æœªå®Œæˆ //ä¸æˆç«‹ï¼šè¯´æ˜æ‰©å®¹å·²ç»ç»“æŸäº†ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œæœ€åé€€å‡ºçš„çº¿ç¨‹ ä¼šè®¾ç½® nextTable ä¸º table //æ¡ä»¶ä¸‰ï¼š(sc = sizeCtl) &lt; 0 //æˆç«‹ï¼šè¯´æ˜æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼šè¯´æ˜sizeCtlå½“å‰æ˜¯ä¸€ä¸ªå¤§äº0çš„æ•°ï¼Œæ­¤æ—¶ä»£è¡¨ä¸‹æ¬¡æ‰©å®¹çš„é˜ˆå€¼ï¼Œå½“å‰æ‰©å®¹å·²ç»ç»“æŸã€‚ while (nextTab == nextTable &amp;&amp; table == tab &amp;&amp; (sc = sizeCtl) &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼štransferIndex &lt;= 0 // true-&gt;è¯´æ˜mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„ä»»åŠ¡å·²ç»åˆ†é…å®Œäº†ï¼Œå½“å‰çº¿ç¨‹è¿›å»ä¹Ÿæ²¡æ´»å¹².. // false-&gt;è¿˜æœ‰ä»»åŠ¡å¯ä»¥åˆ†é…ã€‚ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || transferIndex &lt;= 0) break; if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) &#123; transfer(tab, nextTab); break; &#125; &#125; return nextTab; &#125; return table;&#125; 10.get1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public V get(Object key) &#123; //tab å¼•ç”¨map.table //e å½“å‰å…ƒç´  //p ç›®æ ‡èŠ‚ç‚¹ //n tableæ•°ç»„é•¿åº¦ //eh å½“å‰å…ƒç´ hash //ek å½“å‰å…ƒç´ key Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; int n, eh; K ek; //æ‰°åŠ¨è¿ç®—åå¾—åˆ° æ›´æ•£åˆ—çš„hashå€¼ int h = spread(key.hashCode()); //æ¡ä»¶ä¸€ï¼š(tab = table) != null //true-&gt;è¡¨ç¤ºå·²ç»putè¿‡æ•°æ®ï¼Œå¹¶ä¸”mapå†…éƒ¨çš„tableä¹Ÿå·²ç»åˆå§‹åŒ–å®Œæ¯• //false-&gt;è¡¨ç¤ºåˆ›å»ºå®Œmapåï¼Œå¹¶æ²¡æœ‰putè¿‡æ•°æ®ï¼Œmapå†…éƒ¨çš„tableæ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å†™æ•°æ®æ—¶ä¼šè§¦å‘åˆ›å»ºé€»è¾‘ã€‚ //æ¡ä»¶äºŒï¼š(n = tab.length) &gt; 0 true-&gt;è¡¨ç¤ºtableå·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(e = tabAt(tab, (n - 1) &amp; h)) != null //true-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ æœ‰å€¼ //false-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ä¸­æ˜¯nullï¼Œæ˜¯nullç›´æ¥è¿”å›null if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (e = tabAt(tab, (n - 1) &amp; h)) != null) &#123; //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ® //å¯¹æ¯”å¤´ç»“ç‚¹hashä¸æŸ¥è¯¢keyçš„hashæ˜¯å¦ä¸€è‡´ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹ä¸æŸ¥è¯¢Keyçš„hashå€¼ å®Œå…¨ä¸€è‡´ if ((eh = e.hash) == h) &#123; //å®Œå…¨æ¯”å¯¹ æŸ¥è¯¢key å’Œ å¤´ç»“ç‚¹çš„key //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹å°±æ˜¯æŸ¥è¯¢æ•°æ® if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) return e.val; &#125; //æ¡ä»¶æˆç«‹ï¼š //1.-1 fwd è¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ï¼Œä¸”å½“å‰æŸ¥è¯¢çš„è¿™ä¸ªæ¡¶ä½çš„æ•°æ® å·²ç»è¢«è¿ç§»èµ°äº† //2.-2 TreeBinèŠ‚ç‚¹ï¼Œéœ€è¦ä½¿ç”¨TreeBin æä¾›çš„find æ–¹æ³•æŸ¥è¯¢ã€‚ else if (eh &lt; 0) return (p = e.find(h, key)) != null ? p.val : null; //å½“å‰æ¡¶ä½å·²ç»å½¢æˆé“¾è¡¨çš„è¿™ç§æƒ…å†µ while ((e = e.next) != null) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) return e.val; &#125; &#125; return null;&#125; 11.remove123public V remove(Object key) &#123; return replaceNode(key, null, null);&#125; 12.replaceNode123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143final V replaceNode(Object key, V value, Object cv) &#123; //è®¡ç®—keyç»è¿‡æ‰°åŠ¨è¿ç®—åçš„hash int hash = spread(key.hashCode()); //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //fè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ //nè¡¨ç¤ºå½“å‰tableæ•°ç»„é•¿åº¦ //iè¡¨ç¤ºhashå‘½ä¸­æ¡¶ä½ä¸‹æ ‡ //fhè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ hash Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼štab == null true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶äºŒï¼š(n = tab.length) == 0 true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(f = tabAt(tab, i = (n - 1) &amp; hash)) == null true -&gt; è¡¨ç¤ºå‘½ä¸­æ¡¶ä½ä¸­ä¸ºnullï¼Œç›´æ¥breakï¼Œ ä¼šè¿”å› if (tab == null || (n = tab.length) == 0 || (f = tabAt(tab, i = (n - 1) &amp; hash)) == null) break; //CASE2ï¼š //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ä¸­ï¼Œå½“å‰æ˜¯ä¸ªå†™æ“ä½œï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹éœ€è¦ååŠ©tableå®Œæˆæ‰©å®¹ã€‚ else if ((fh = f.hash) == MOVED) tab = helpTransfer(tab, f); //CASE3: //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //å½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ &quot;é“¾è¡¨&quot; ä¹Ÿå¯èƒ½ æ˜¯ &quot;çº¢é»‘æ ‘&quot; TreeBin else &#123; //ä¿ç•™æ›¿æ¢ä¹‹å‰çš„æ•°æ®å¼•ç”¨ V oldVal = null; //æ ¡éªŒæ ‡è®° boolean validated = false; //åŠ é”å½“å‰æ¡¶ä½ å¤´ç»“ç‚¹ï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šè¿›å…¥ ä»£ç å—ã€‚ synchronized (f) &#123; //åˆ¤æ–­syncåŠ é”æ˜¯å¦ä¸ºå½“å‰æ¡¶ä½ å¤´èŠ‚ç‚¹ï¼Œé˜²æ­¢å…¶å®ƒçº¿ç¨‹ï¼Œåœ¨å½“å‰çº¿ç¨‹åŠ é”æˆåŠŸä¹‹å‰ï¼Œä¿®æ”¹è¿‡ æ¡¶ä½ çš„å¤´ç»“ç‚¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šå½“å‰æ¡¶ä½å¤´ç»“ç‚¹ ä»ç„¶ä¸ºfï¼Œå…¶å®ƒçº¿ç¨‹æ²¡ä¿®æ”¹è¿‡ã€‚ if (tabAt(tab, i) == f) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ¡¶ä½ ä¸º é“¾è¡¨ æˆ–è€… å•ä¸ª node if (fh &gt;= 0) &#123; validated = true; //e è¡¨ç¤ºå½“å‰å¾ªç¯å¤„ç†å…ƒç´  //pred è¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ Node&lt;K,V&gt; e = f, pred = null; for (;;) &#123; //å½“å‰èŠ‚ç‚¹key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash true-&gt;è¯´æ˜å½“å‰èŠ‚ç‚¹çš„hashä¸æŸ¥æ‰¾èŠ‚ç‚¹hashä¸€è‡´ //æ¡ä»¶äºŒï¼š((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) //if æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜key ä¸æŸ¥è¯¢çš„keyå®Œå…¨ä¸€è‡´ã€‚ if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å½“å‰èŠ‚ç‚¹çš„value V ev = e.val; //æ¡ä»¶ä¸€ï¼šcv == null true-&gt;æ›¿æ¢çš„å€¼ä¸ºnull é‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªåˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == ev || (ev != null &amp;&amp; cv.equals(ev)) é‚£ä¹ˆæ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (cv == null || cv == ev || (ev != null &amp;&amp; cv.equals(ev))) &#123; //åˆ é™¤ æˆ–è€… æ›¿æ¢ //å°†å½“å‰èŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal åç»­è¿”å›ä¼šç”¨åˆ° oldVal = ev; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (value != null) //ç›´æ¥æ›¿æ¢ e.val = value; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰èŠ‚ç‚¹éå¤´ç»“ç‚¹ else if (pred != null) //å½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ pred.next = e.next; else //è¯´æ˜å½“å‰èŠ‚ç‚¹å³ä¸º å¤´ç»“ç‚¹ï¼Œåªéœ€è¦å°† æ¡¶ä½è®¾ç½®ä¸ºå¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ setTabAt(tab, i, e.next); &#125; break; &#125; pred = e; if ((e = e.next) == null) break; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šTreeBinèŠ‚ç‚¹ã€‚ else if (f instanceof TreeBin) &#123; validated = true; //è½¬æ¢ä¸ºå®é™…ç±»å‹ TreeBin t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //r è¡¨ç¤º çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ //p è¡¨ç¤º çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾åˆ°å¯¹åº”key ä¸€è‡´çš„node TreeNode&lt;K,V&gt; r, p; //æ¡ä»¶ä¸€ï¼š(r = t.root) != null ç†è®ºä¸Šæ˜¯æˆç«‹ //æ¡ä»¶äºŒï¼šTreeNode.findTreeNode ä»¥å½“å‰èŠ‚ç‚¹ä¸ºå…¥å£ï¼Œå‘ä¸‹æŸ¥æ‰¾keyï¼ˆåŒ…æ‹¬æœ¬èº«èŠ‚ç‚¹ï¼‰ // true-&gt;è¯´æ˜æŸ¥æ‰¾åˆ°ç›¸åº”key å¯¹åº”çš„nodeèŠ‚ç‚¹ã€‚ä¼šèµ‹å€¼ç»™p if ((r = t.root) != null &amp;&amp; (p = r.findTreeNode(hash, key, null)) != null) &#123; //ä¿å­˜p.val åˆ°pv V pv = p.val; //æ¡ä»¶ä¸€ï¼šcv == null æˆç«‹ï¼šä¸å¿…å¯¹valueï¼Œå°±åšæ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == pv ||(pv != null &amp;&amp; cv.equals(pv)) æˆç«‹ï¼šè¯´æ˜â€œå¯¹æ¯”å€¼â€ä¸å½“å‰pèŠ‚ç‚¹çš„å€¼ ä¸€è‡´ if (cv == null || cv == pv || (pv != null &amp;&amp; cv.equals(pv))) &#123; //æ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ oldVal = pv; //æ¡ä»¶æˆç«‹ï¼šæ›¿æ¢æ“ä½œ if (value != null) p.val = value; //åˆ é™¤æ“ä½œ else if (t.removeTreeNode(p)) //è¿™é‡Œæ²¡åšåˆ¤æ–­ï¼Œç›´æ¥æäº†...å¾ˆç–‘æƒ‘ setTabAt(tab, i, untreeify(t.first)); &#125; &#125; &#125; &#125; &#125; //å½“å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡æ¡¶ä½ å¤´ç»“ç‚¹æ—¶ï¼Œå½“å‰çº¿ç¨‹ sync å¤´ç»“ç‚¹ é”é”™å¯¹è±¡æ—¶ï¼Œvalidated ä¸ºfalseï¼Œä¼šè¿›å…¥ä¸‹æ¬¡for è‡ªæ—‹ if (validated) &#123; if (oldVal != null) &#123; //æ›¿æ¢çš„å€¼ ä¸ºnullï¼Œè¯´æ˜å½“å‰æ˜¯ä¸€æ¬¡åˆ é™¤æ“ä½œï¼ŒoldVal ï¼=null æˆç«‹ï¼Œè¯´æ˜åˆ é™¤æˆåŠŸï¼Œæ›´æ–°å½“å‰å…ƒç´ ä¸ªæ•°è®¡æ•°å™¨ã€‚ if (value == null) addCount(-1L, -1); return oldVal; &#125; break; &#125; &#125; &#125; return null;&#125; 13.TreeBin13.1 å±æ€§1234567891011121314151617//çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ TreeNode&lt;K,V&gt; root;//é“¾è¡¨çš„å¤´èŠ‚ç‚¹volatile TreeNode&lt;K,V&gt; first;//ç­‰å¾…è€…çº¿ç¨‹ï¼ˆå½“å‰lockStateæ˜¯è¯»é”çŠ¶æ€ï¼‰volatile Thread waiter;/** * 1.å†™é”çŠ¶æ€ å†™æ˜¯ç‹¬å çŠ¶æ€ï¼Œä»¥æ•£åˆ—è¡¨æ¥çœ‹ï¼ŒçœŸæ­£è¿›å…¥åˆ°TreeBinä¸­çš„å†™çº¿ç¨‹ åŒä¸€æ—¶åˆ» åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚ 1 * 2.è¯»é”çŠ¶æ€ è¯»é”æ˜¯å…±äº«ï¼ŒåŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¿›å…¥åˆ° TreeBinå¯¹è±¡ä¸­è·å–æ•°æ®ã€‚ æ¯ä¸€ä¸ªçº¿ç¨‹ éƒ½ä¼šç»™ lockStat + 4 * 3.ç­‰å¾…è€…çŠ¶æ€ï¼ˆå†™çº¿ç¨‹åœ¨ç­‰å¾…ï¼‰ï¼Œå½“TreeBinä¸­æœ‰è¯»çº¿ç¨‹ç›®å‰æ­£åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå†™çº¿ç¨‹æ— æ³•ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆå°±å°†lockStateçš„æœ€ä½2ä½ è®¾ç½®ä¸º 0b 10 */volatile int lockState;// values for lockStatestatic final int WRITER = 1; // set while holding write lockstatic final int WAITER = 2; // set when waiting for write lockstatic final int READER = 4; // increment value for setting read lock 13.2 æ„é€ å™¨1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586TreeBin(TreeNode&lt;K,V&gt; b) &#123; //è®¾ç½®èŠ‚ç‚¹hashä¸º-2 è¡¨ç¤ºæ­¤èŠ‚ç‚¹æ˜¯TreeBinèŠ‚ç‚¹ super(TREEBIN, null, null, null); //ä½¿ç”¨first å¼•ç”¨ treeNodeé“¾è¡¨ this.first = b; //r çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹å¼•ç”¨ TreeNode&lt;K,V&gt; r = null; //xè¡¨ç¤ºéå†çš„å½“å‰èŠ‚ç‚¹ for (TreeNode&lt;K,V&gt; x = b, next; x != null; x = next) &#123; next = (TreeNode&lt;K,V&gt;)x.next; //å¼ºåˆ¶è®¾ç½®å½“å‰æ’å…¥èŠ‚ç‚¹çš„å·¦å³å­æ ‘ä¸ºnull x.left = x.right = null; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¢é»‘æ ‘ æ˜¯ä¸€ä¸ªç©ºæ ‘ï¼Œé‚£ä¹ˆè®¾ç½®æ’å…¥å…ƒç´  ä¸ºæ ¹èŠ‚ç‚¹ if (r == null) &#123; //æ ¹èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸€å®šä¸º null x.parent = null; //é¢œè‰²æ”¹ä¸ºé»‘è‰² x.red = false; //è®©rå¼•ç”¨xæ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚ r = x; &#125; else &#123; //éç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œéƒ½ä¼šæ¥å¸¦elseåˆ†æ”¯ï¼Œæ­¤æ—¶çº¢é»‘æ ‘å·²ç»æœ‰æ•°æ®äº† //k è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„key K k = x.key; //h è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„hash int h = x.hash; //kc è¡¨ç¤º æ’å…¥èŠ‚ç‚¹keyçš„classç±»å‹ Class&lt;?&gt; kc = null; //p è¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; p = r; for (;;) &#123; //dir (-1, 1) //-1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼å¤§äº å½“å‰pèŠ‚ç‚¹çš„hash //1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰pèŠ‚ç‚¹çš„hash //ph pè¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹çš„hash int dir, ph; //ä¸´æ—¶èŠ‚ç‚¹ key K pk = p.key; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰èŠ‚ç‚¹ if ((ph = p.hash) &gt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å·¦å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = -1; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å¤§äº å½“å‰èŠ‚ç‚¹ else if (ph &lt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å³å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = 1; //å¦‚æœæ‰§è¡Œåˆ° CASE3ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„hash ä¸ å½“å‰èŠ‚ç‚¹çš„hashä¸€è‡´ï¼Œä¼šåœ¨case3 åšå‡ºæœ€ç»ˆæ’åºã€‚æœ€ç»ˆ //æ‹¿åˆ°çš„dir ä¸€å®šä¸æ˜¯0ï¼Œï¼ˆ-1ï¼Œ 1ï¼‰ else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) dir = tieBreakOrder(k, pk); //xp æƒ³è¦è¡¨ç¤ºçš„æ˜¯ æ’å…¥èŠ‚ç‚¹çš„ çˆ¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; xp = p; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰pèŠ‚ç‚¹ å³ä¸ºæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ //æ¡ä»¶ä¸æˆç«‹ï¼šè¯´æ˜pèŠ‚ç‚¹ åº•ä¸‹è¿˜æœ‰å±‚æ¬¡ï¼Œéœ€è¦å°†pæŒ‡å‘ pçš„å·¦å­èŠ‚ç‚¹ æˆ–è€… å³å­èŠ‚ç‚¹ï¼Œè¡¨ç¤ºç»§ç»­å‘ä¸‹æœç´¢ã€‚ if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //è®¾ç½®æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸º å½“å‰èŠ‚ç‚¹ x.parent = xp; //å°äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ if (dir &lt;= 0) xp.left = x; //å¤§äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ else xp.right = x; //æ’å…¥èŠ‚ç‚¹åï¼Œçº¢é»‘æ ‘æ€§è´¨ å¯èƒ½ä¼šè¢«ç ´åï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨ å¹³è¡¡æ–¹æ³• r = balanceInsertion(r, x); break; &#125; &#125; &#125; &#125; //å°†r èµ‹å€¼ç»™ TreeBinå¯¹è±¡çš„ rootå¼•ç”¨ã€‚ this.root = r; assert checkInvariants(root);&#125; 13.3 putTreeVal12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970final TreeNode&lt;K,V&gt; putTreeVal(int h, K k, V v) &#123; Class&lt;?&gt; kc = null; boolean searched = false; for (TreeNode&lt;K,V&gt; p = root;;) &#123; int dir, ph; K pk; if (p == null) &#123; first = root = new TreeNode&lt;K,V&gt;(h, k, v, null, null); break; &#125; else if ((ph = p.hash) &gt; h) dir = -1; else if (ph &lt; h) dir = 1; else if ((pk = p.key) == k || (pk != null &amp;&amp; k.equals(pk))) return p; else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) &#123; if (!searched) &#123; TreeNode&lt;K,V&gt; q, ch; searched = true; if (((ch = p.left) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null) || ((ch = p.right) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null)) return q; &#125; dir = tieBreakOrder(k, pk); &#125; TreeNode&lt;K,V&gt; xp = p; if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹xp å³ä¸º x èŠ‚ç‚¹çš„çˆ¸çˆ¸ //x è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹ //f è€çš„å¤´ç»“ç‚¹ TreeNode&lt;K,V&gt; x, f = first; first = x = new TreeNode&lt;K,V&gt;(h, k, v, f, xp); //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜é“¾è¡¨æœ‰æ•°æ® if (f != null) //è®¾ç½®è€çš„å¤´ç»“ç‚¹çš„å‰ç½®å¼•ç”¨ä¸º å½“å‰çš„å¤´ç»“ç‚¹ã€‚ f.prev = x; if (dir &lt;= 0) xp.left = x; else xp.right = x; if (!xp.red) x.red = true; else &#123; //è¡¨ç¤º å½“å‰æ–°æ’å…¥èŠ‚ç‚¹åï¼Œæ–°æ’å…¥èŠ‚ç‚¹ ä¸ çˆ¶èŠ‚ç‚¹ å½¢æˆ â€œçº¢çº¢ç›¸è¿â€ lockRoot(); try &#123; //å¹³è¡¡çº¢é»‘æ ‘ï¼Œä½¿å…¶å†æ¬¡ç¬¦åˆè§„èŒƒã€‚ root = balanceInsertion(root, x); &#125; finally &#123; unlockRoot(); &#125; &#125; break; &#125; &#125; assert checkInvariants(root); return null;&#125; 13.4 find123456789101112131415161718192021222324252627282930313233343536373839404142434445464748final Node&lt;K,V&gt; find(int h, Object k) &#123; if (k != null) &#123; //e è¡¨ç¤ºå¾ªç¯è¿­ä»£çš„å½“å‰èŠ‚ç‚¹ è¿­ä»£çš„æ˜¯firstå¼•ç”¨çš„é“¾è¡¨ for (Node&lt;K,V&gt; e = first; e != null; ) &#123; //s ä¿å­˜çš„æ˜¯lockä¸´æ—¶çŠ¶æ€ //ek é“¾è¡¨å½“å‰èŠ‚ç‚¹ çš„key int s; K ek; //(WAITER|WRITER) =&gt; 0010 | 0001 =&gt; 0011 //lockState &amp; 0011 != 0 æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰TreeBin æœ‰ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… ç›®å‰æœ‰å†™æ“ä½œçº¿ç¨‹æ­£åœ¨åŠ é” if (((s = lockState) &amp; (WAITER|WRITER)) != 0) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek)))) return e; e = e.next; &#125; //å‰ç½®æ¡ä»¶ï¼šå½“å‰TreeBinä¸­ ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… å†™çº¿ç¨‹ éƒ½æ²¡æœ‰ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ·»åŠ è¯»é”æˆåŠŸ else if (U.compareAndSwapInt(this, LOCKSTATE, s, s + READER)) &#123; TreeNode&lt;K,V&gt; r, p; try &#123; //æŸ¥è¯¢æ“ä½œ p = ((r = root) == null ? null : r.findTreeNode(h, k, null)); &#125; finally &#123; //w è¡¨ç¤ºç­‰å¾…è€…çº¿ç¨‹ Thread w; //U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) //1.å½“å‰çº¿ç¨‹æŸ¥è¯¢çº¢é»‘æ ‘ç»“æŸï¼Œé‡Šæ”¾å½“å‰çº¿ç¨‹çš„è¯»é” å°±æ˜¯è®© lockstate å€¼ - 4 //(READER|WAITER) = 0110 =&gt; è¡¨ç¤ºå½“å‰åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»ï¼Œä¸”â€œæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…â€ //å½“å‰è¯»çº¿ç¨‹ä¸º TreeBinä¸­çš„æœ€åä¸€ä¸ªè¯»çº¿ç¨‹ã€‚ //2.(w = waiter) != null è¯´æ˜æœ‰ä¸€ä¸ªå†™çº¿ç¨‹åœ¨ç­‰å¾…è¯»æ“ä½œå…¨éƒ¨ç»“æŸã€‚ if (U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) &amp;&amp; (w = waiter) != null) //ä½¿ç”¨unpark è®© å†™çº¿ç¨‹ æ¢å¤è¿è¡ŒçŠ¶æ€ã€‚ LockSupport.unpark(w); &#125; return p; &#125; &#125; &#125; return null;&#125; ä¸‰ï¼Œæ€»ç»“åœ¨java8ä¸­ï¼ŒConcurrentHashMapä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„ç»„åˆæ–¹å¼ï¼Œåˆ©ç”¨caså’Œsynchronizedä¿è¯å¹¶å‘å†™çš„å®‰å…¨ã€‚â€‹ å¼•å…¥çº¢é»‘æ ‘çš„åŸå› ï¼šé“¾è¡¨æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸ºOnï¼Œä½†æ˜¯çº¢é»‘æ ‘çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸ºO(log(n)),æ‰€ä»¥åœ¨èŠ‚ç‚¹æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¢é»‘æ ‘å¯ä»¥å¤§å¤§æå‡æ€§èƒ½ã€‚ â€‹ é“¾å¼æ¡¶æ˜¯ä¸€ä¸ªç”±nodeèŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨ã€‚æ ‘çŠ¶æ¡¶æ˜¯ä¸€é¢—ç”±TreeNodeèŠ‚ç‚¹ç»„æˆçš„çº¢é»‘æ ‘ã€‚è¾“çš„æ ¹èŠ‚ç‚¹ä¸ºTreeBinç±»å‹ã€‚â€‹ å½“é“¾è¡¨é•¿åº¦å¤§äº8æ•´ä¸ªhashè¡¨é•¿åº¦å¤§äº64çš„æ—¶å€™ï¼Œå°±ä¼šè½¬åŒ–ä¸ºTreeBinã€‚TreeBinä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œå…¶å®å°±æ˜¯çº¢é»‘æ ‘å¯¹è±¡ã€‚åœ¨ConcurrentHashMapçš„tableæ•°ç»„ä¸­ï¼Œå­˜æ”¾çš„å°±æ˜¯TreeBinå¯¹è±¡ï¼Œè€Œä¸æ˜¯TreeNoeå¯¹è±¡ã€‚â€‹ æ•°ç»„tableæ˜¯æ‡’åŠ è½½çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ï¼Œæ‰€ä»¥initTable()å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚â€‹ é‡è¦çš„å±æ€§å°±æ˜¯sizeCtlï¼Œç”¨æ¥æ§åˆ¶tableçš„åˆå§‹åŒ–å’Œæ‰©å®¹æ“ä½œçš„è¿‡ç¨‹ï¼šâ€‹ -1ä»£è¡¨tableæ­£åœ¨åˆå§‹åŒ–ï¼Œå…¶ä»–çº¿ç¨‹ç›´æ¥joinç­‰å¾…ã€‚ -Nä»£è¡¨æœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œä¸¥æ ¼æ¥è¯´ï¼Œå½“å…¶ä¸ºè´Ÿæ•°çš„æ—¶å€™ï¼Œåªç”¨åˆ°äº†ä½16ä½ï¼Œå¦‚æœä½16ä½ä¸ºMï¼Œæ­¤æ—¶æœ‰M-1ä¸ªçº¿ç¨‹è¿›è¡Œæ‰©å®¹ã€‚ å¤§äº0æœ‰ä¸¤ç§æƒ…å†µï¼šå¦‚æœtableæ²¡æœ‰åˆå§‹åŒ–ï¼Œå¥¹å°±è¡¨ç¤ºtableåˆå§‹åŒ–çš„å¤§å°ï¼Œå¦‚æœtableåˆå§‹åŒ–å®Œäº†ï¼Œå°±è¡¨ç¤ºtableçš„å®¹é‡ï¼Œé»˜è®¤æ˜¯tableå¤§å°çš„å››åˆ†ä¹‹ä¸‰ã€‚ â€‹ Transfer()æ‰©å®¹â€‹ tableæ•°æ®è½¬ç§»åˆ°nextTableã€‚æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼ŒæŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ConcurrentHashMapç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒæŠŠtableæ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹æ‰€è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„ Bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰Bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚â€‹ helpTransfer()å¸®åŠ©æ‰©å®¹â€‹ ConcurrentHashMapå¹¶å‘æ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœæ­£åœ¨æ‰©å®¹ï¼Œå…¶ä»–çº¿ç¨‹ä¼šå¸®åŠ©æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å¤šçº¿ç¨‹æ‰©å®¹ã€‚â€‹ ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œé»˜è®¤åˆå§‹é•¿åº¦ä¸º16ï¼Œå½“å¾€tableä¸­ç»§ç»­æ·»åŠ å…ƒç´ æ—¶ï¼Œé€šè¿‡Hashå€¼è·Ÿæ•°ç»„é•¿åº¦å–ä½™æ¥å†³å®šæ”¾åœ¨æ•°ç»„çš„å“ªä¸ªBucketä½ç½®ï¼Œå¦‚æœå‡ºç°æ”¾åœ¨åŒä¸€ä¸ªä½ç½®ï¼Œå°±ä¼˜å…ˆä»¥é“¾è¡¨çš„å½¢å¼å­˜æ”¾ï¼Œåœ¨åŒä¸€ä¸ªä½ç½®çš„ä¸ªæ•°è¾¾åˆ°äº†8ä¸ªä»¥ä¸Šï¼Œå¦‚æœæ•°ç»„çš„é•¿åº¦è¿˜å°äº64ï¼Œå°±ä¼šæ‰©å®¹æ•°ç»„ã€‚å¦‚æœæ•°ç»„çš„é•¿åº¦å¤§äºç­‰äº64ï¼Œå°±ä¼šå°†è¯¥èŠ‚ç‚¹çš„é“¾è¡¨è½¬æ¢æˆæ ‘ã€‚â€‹ é€šè¿‡æ‰©å®¹æ•°ç»„çš„æ–¹å¼æ¥æŠŠè¿™äº›èŠ‚ç‚¹åˆ†æ•£å¼€ã€‚ç„¶åå°†è¿™äº›å…ƒç´ å¤åˆ¶åˆ°æ‰©å®¹åçš„æ–°æ•°ç»„ä¸­ï¼ŒåŒä¸€ä¸ªBucketä¸­çš„å…ƒç´ é€šè¿‡Hashå€¼çš„æ•°ç»„é•¿åº¦ä½æ¥é‡æ–°ç¡®å®šä½ç½®ï¼Œå¯èƒ½è¿˜æ˜¯æ”¾åœ¨åŸæ¥çš„ä½ç½®ï¼Œä¹Ÿå¯èƒ½æ”¾åˆ°æ–°çš„ä½ç½®ã€‚è€Œä¸”ï¼Œåœ¨æ‰©å®¹å®Œæˆä¹‹åï¼Œå¦‚æœä¹‹å‰æŸä¸ªèŠ‚ç‚¹æ˜¯æ ‘ï¼Œä½†æ˜¯ç°åœ¨è¯¥èŠ‚ç‚¹çš„â€œKey-Valueå¯¹â€æ•°åˆå°äºç­‰äº6ä¸ªï¼Œå°±ä¼šå°†è¯¥æ ‘è½¬ä¸ºé“¾è¡¨ã€‚â€‹ put()â€‹ JDK1.8åœ¨ä½¿ç”¨CASè‡ªæ—‹å®Œæˆæ¡¶çš„è®¾ç½®æ—¶ï¼Œä½¿ç”¨synchronizedå†…ç½®é”ä¿è¯æ¡¶å†…å¹¶å‘æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚å°½ç®¡å¯¹åŒä¸€ä¸ªMapæ“ä½œçš„çº¿ç¨‹äº‰ç”¨ä¼šéå¸¸æ¿€çƒˆï¼Œä½†æ˜¯åœ¨åŒä¸€ä¸ªæ¡¶å†…çš„çº¿ç¨‹äº‰ç”¨é€šå¸¸ä¸ä¼šå¾ˆæ¿€çƒˆï¼Œæ‰€ä»¥ä½¿ç”¨CASè‡ªæ—‹ã€synchronizedä¸ä¼šé™ä½ConcurrentHashMapçš„æ€§èƒ½ã€‚ä¸ºä»€ä¹ˆä¸ç”¨ReentrantLockæ˜¾å¼é”å‘¢?å¦‚æœä¸ºæ¯ ä¸ªæ¡¶éƒ½åˆ›å»ºä¸€ä¸ªReentrantLockå® ä¾‹ï¼Œå°±ä¼šå¸¦æ¥å¤§é‡çš„å†…å­˜æ¶ˆè€—ï¼Œåè¿‡æ¥ï¼Œä½¿ç”¨CASè‡ªæ—‹ã€synchronizedï¼Œå†…å­˜æ¶ˆè€—çš„å¢åŠ æ›´å°ã€‚â€‹ get()â€‹ get()é€šè¿‡UnSafeçš„getObjectVolatile()æ¥è¯»å–æ•°ç»„ä¸­çš„å…ƒç´ ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·åš?è™½ç„¶HashEntryæ•°ç»„çš„å¼•ç”¨æ˜¯volatileç±»å‹ï¼Œä½†æ˜¯æ•°ç»„å†…å…ƒç´ çš„ ç”¨ä¸æ˜¯volatileç±»å‹ï¼Œå› æ­¤å¤šçº¿ç¨‹å¯¹ æ•°ç»„å…ƒç´ çš„ä¿®æ”¹æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šåœ¨æ•°ç»„ä¸­è¯»å–åˆ°å°šæœªæ„é€ å®Œæˆçš„å…ƒç´ å¯¹è±¡ã€‚get()æ–¹æ³•é€šè¿‡UnSafeçš„getObjectVolatileæ–¹æ³•æ¥ä¿è¯å…ƒç´ çš„è¯»å–å®‰å…¨ï¼Œè°ƒç”¨getObjectVolatile()å»è¯»å–æ•°ç»„å…ƒç´ éœ€è¦å…ˆè·å¾—å…ƒç´ åœ¨æ•°ç»„ä¸­çš„åç§»é‡ï¼Œåœ¨è¿™é‡Œï¼Œget()æ–¹æ³•æ ¹æ®å“ˆå¸Œç è®¡ç®—å‡ºåç§»é‡ä¸ºuï¼Œç„¶åé€šè¿‡åç§»é‡uæ¥å°è¯•è¯»å–æ•°å€¼ã€‚â€‹ â€‹ â€‹ â€‹ â€‹ â€‹","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"LongAdder","slug":"JUC/LongAdder","date":"2022-01-11T11:06:11.172Z","updated":"2022-01-11T11:28:53.952Z","comments":true,"path":"2022/01/11/JUC/LongAdder/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/LongAdder/","excerpt":"","text":"ä¸€ï¼Œä¸ºä»€ä¹ˆè¦ç”¨LongAdder ã€å‚è€ƒã€‘volatile è§£å†³å¤šçº¿ç¨‹å†…å­˜ä¸å¯è§é—®é¢˜ã€‚å¯¹äºä¸€å†™å¤šè¯»ï¼Œæ˜¯å¯ä»¥è§£å†³å˜é‡åŒæ­¥é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœå¤šå†™ï¼ŒåŒæ ·æ— æ³•è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚è¯´æ˜ï¼šå¦‚æœæ˜¯ count++ æ“ä½œï¼Œä½¿ç”¨å¦‚ä¸‹ç±»å®ç°ï¼šAtomicInteger count = new AtomicInteger(); count.addAndGet(1); å¦‚æœæ˜¯ JDK8ï¼Œæ¨èä½¿ç”¨ LongAdder å¯¹è±¡ï¼Œæ¯” AtomicLong æ€§èƒ½æ›´å¥½ï¼ˆå‡å°‘ä¹è§‚ é”çš„é‡è¯•æ¬¡æ•°ï¼‰ã€‚ ä»¥ä¸Šå†…å®¹æ¥è‡ªé˜¿é‡Œã€ŠJavaå¼€å‘æ‰‹å†Œã€‹ã€‚â€‹ é‡Œé¢æåˆ°äº†å¤šçº¿ç¨‹è¯»å†™ç¯å¢ƒä¸‹ï¼ŒLongAdderç›¸å¯¹äºAtomicåŸå­ç±»æ‹¥æœ‰æ›´å¥½çš„æ•ˆç‡ã€‚â€‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283public class LongAdderAndAtomicTest &#123; private static AtomicInteger a = new AtomicInteger(0); private static LongAdder b = new LongAdder(); public static void main(String[] args) throws Exception &#123; test(1, 10000000); test(10, 10000000); test(20, 10000000); test(50, 10000000); test(100, 10000000); &#125; /** * æµ‹è¯•LongAdderå’ŒAtomicçš„æ•ˆç‡ * * @param threadNum çº¿ç¨‹æ•° * @param times æ‰§è¡Œæ—¶é—´ */ public static void test(Integer threadNum, Integer times) throws Exception &#123; System.out.println(&quot;çº¿ç¨‹æ•°ä¸ºï¼š&quot; + threadNum); testAtomic(threadNum, times); testLongAdder(threadNum, times); &#125; /** * æµ‹è¯•Atomicçš„æ•ˆç‡ * * @param threadNum * @param times */ public static void testAtomic(Integer threadNum, Integer times) throws InterruptedException &#123; //å¼€å§‹æ—¶é—´ long start = System.currentTimeMillis(); CountDownLatch countDownLatch = new CountDownLatch(threadNum); for (int i = 0; i &lt; threadNum; i++) &#123; new Thread(() -&gt; &#123; for (int j = 0; j &lt; times; j++) &#123; a.incrementAndGet(); &#125; countDownLatch.countDown(); &#125;).start(); &#125; countDownLatch.await(); //ç»“æŸæ—¶é—´ long end = System.currentTimeMillis(); System.out.println(&quot;Atomic æ¶ˆè€—æ—¶é—´ï¼š&quot; + (end - start)); &#125; /** * æµ‹è¯•LongAdderçš„æ•ˆç‡ * * @param threadNum * @param times */ public static void testLongAdder(Integer threadNum, Integer times) throws InterruptedException &#123; //å¼€å§‹æ—¶é—´ long start = System.currentTimeMillis(); CountDownLatch countDownLatch = new CountDownLatch(threadNum); for (int i = 0; i &lt; threadNum; i++) &#123; new Thread(() -&gt; &#123; for (int j = 0; j &lt; times; j++) &#123; b.increment(); &#125; countDownLatch.countDown(); &#125;).start(); &#125; countDownLatch.await(); //ç»“æŸæ—¶é—´ long end = System.currentTimeMillis(); System.out.println(&quot;LongAdder æ¶ˆè€—æ—¶é—´ï¼š&quot; + (end - start)); &#125;&#125; ç”±å›¾å¯ä»¥çœ‹åˆ°ï¼Œçº¿ç¨‹æ•°è¶Šå¤šï¼ŒLongAdderçš„æ•ˆç‡å‹å¯¹äºAtomicè¶Šé«˜ï¼Œç”±æ­¤å¯ä»¥çœ‹å‡ºï¼ŒLongAdderæ›´é€‚åˆäºé«˜å¹¶å‘æƒ…å†µä¸‹ã€‚â€‹ äºŒï¼ŒLongAdderæºç é˜…è¯»çœ‹LongAdderç±»çš„ç»§æ‰¿å…³ç³»ï¼š 1public class LongAdder extends Striped64 implements Serializable LongAdderè¿™ä¸ªç±»ç»§æ‰¿è‡ªStriped64ï¼ŒStriped64é‡Œé¢å£°æ˜äº†ä¸€ä¸ªå†…éƒ¨ç±»Cellã€‚ 1234567891011121314151617181920212223242526@sun.misc.Contended static final class Cell &#123; //æ‹¥æœ‰å†…å­˜å¯è§æ€§çš„value volatile long value; //å¸¦å‚æ•°çš„æ„é€ å™¨ Cell(long x) &#123; value = x; &#125; //è°ƒç”¨unsafeç±»çš„caså¯¹cmpå’Œbalè¿›è¡Œæ¯”è¾ƒäº¤æ¢ï¼Œè¿”å›æ˜¯å¦æˆåŠŸ final boolean cas(long cmp, long val) &#123; return UNSAFE.compareAndSwapLong(this, valueOffset, cmp, val); &#125; //å£°æ˜unsafeç±» private static final sun.misc.Unsafe UNSAFE; //å£°æ˜cellæˆå‘˜å±æ€§çš„å†…å­˜åç§»é‡ private static final long valueOffset; //åˆå§‹åŒ– static &#123; try &#123; UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; ak = Cell.class; valueOffset = UNSAFE.objectFieldOffset (ak.getDeclaredField(&quot;value&quot;)); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125;&#125; 1234567891011//è·å–å½“å‰ç³»ç»Ÿçš„cpuæ•° æ§åˆ¶cellsæ•°ç»„é•¿åº¦çš„ä¸€ä¸ªå…³é”®æ¡ä»¶static final int NCPU = Runtime.getRuntime().availableProcessors();//æ•°ç»„çš„é•¿åº¦ï¼Œåªè¦æ•°ç»„ä¸ä¸ºç©ºï¼Œä¸€å®šæ˜¯2çš„å€æ•°ï¼Œè¿™æ ·-1è½¬åŒ–ä¸ºäºŒè¿›åˆ¶çš„æ—¶å€™ä¸€å®šæ˜¯ä¸€å¤§å †1transient volatile Cell[] cells;//æ²¡æœ‰å‘ç”Ÿè¿‡ç«äº‰æ—¶ï¼Œæ•°æ®ä¼šç´¯åŠ åˆ° baseä¸Š | å½“cellsæ‰©å®¹æ—¶ï¼Œéœ€è¦å°†æ•°æ®å†™åˆ°baseä¸­transient volatile long base;//åˆå§‹åŒ–cellsæˆ–è€…æ‰©å®¹cellséƒ½éœ€è¦è·å–é”ï¼Œ0 è¡¨ç¤ºæ— é”çŠ¶æ€ï¼Œ1 è¡¨ç¤ºå…¶ä»–çº¿ç¨‹å·²ç»æŒæœ‰é”äº†transient volatile int cellsBusy; LongAdderé‡Œé¢ä½¿ç”¨çš„è¿™ä¸¤ä¸ªå±æ€§å®é™…ä¸Šæ˜¯ç»§æ‰¿è‡ªä»–çš„çˆ¶ç±»çš„ã€‚â€‹ 12345678910111213141516171819202122232425262728293031323334353637383940public void add(long x) &#123; /** * as: è¡¨ç¤ºcellsæ•°ç»„çš„å¼•ç”¨ * bï¼š è¡¨ç¤ºè·å–çš„baseå€¼ * v: è¡¨ç¤ºæœŸæœ›å€¼ * m: è¡¨ç¤ºcellsæ•°ç»„çš„é•¿åº¦ * a: è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„cellå•å…ƒæ ¼ */ Cell[] as; long b, v; int m; Cell a; /** * æ¡ä»¶ä¸€ï¼štrue-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–è¿‡ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®å†™å…¥åˆ°å¯¹åº”çš„cellä¸­ * false-&gt;è¡¨ç¤ºcellsæœªåˆå§‹åŒ–ï¼Œå½“å‰æ‰€æœ‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®å†™å…¥åˆ°baseä¸­ * æ¡ä»¶äºŒï¼šfalse-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹casæ›¿æ¢æ•°æ®æˆåŠŸ * true-&gt;è¡¨ç¤ºå‘ç”Ÿç«äº‰äº†ï¼Œå¯èƒ½éœ€è¦é‡è¯•æˆ–è€…æ‰©å®¹ * è¿›å…¥ifçš„æ¡ä»¶ï¼šæ•°ç»„å·²ç»åˆå§‹åŒ– æˆ–è€… casäº¤æ¢æ•°æ®å¤±è´¥ï¼Œè¡¨ç¤ºæœ‰ç«äº‰ * */ if ((as = cells) != null || !casBase(b = base, b + x)) &#123; /** * uncontended: true -&gt; æœªç«äº‰ false-&gt;å‘ç”Ÿç«äº‰ * æ¡ä»¶ä¸€ï¼štrue-&gt;æ•°ç»„æ²¡æœ‰åˆå§‹åŒ– * false-&gt;æ•°ç»„å·²ç»åˆå§‹åŒ– * æ¡ä»¶äºŒï¼štrue-&gt;æ•°ç»„æ²¡æœ‰åˆå§‹åŒ– * false-&gt;æ•°ç»„å·²ç»åˆå§‹åŒ– * * getProbe()ï¼šè·å–å½“å‰çº¿ç¨‹çš„hashå€¼ * æ¡ä»¶ä¸‰ï¼štrue-&gt; å½“å‰çº¿ç¨‹å¯¹åº”çš„cellå¹¶æ²¡æœ‰åˆå§‹åŒ– * false-&gt;å½“å‰çº¿ç¨‹å¯¹åº”çš„cellå·²ç»åˆå§‹åŒ– * æ¡ä»¶å››ï¼štrue-&gt;casäº¤æ¢å¤±è´¥ï¼Œè¡¨ç¤ºæœ‰ç«äº‰ * false-&gt;casäº¤æ¢æˆåŠŸ * è¿›å…¥ifçš„æ¡ä»¶ï¼š * cellsæœªåˆå§‹åŒ–ï¼Œ æˆ–è€… å½“å‰çº¿ç¨‹å¯¹åº”çš„cellæœªåˆå§‹åŒ–ï¼Œ æˆ–è€… casäº¤æ¢å¤±è´¥ */ boolean uncontended = true; if (as == null || (m = as.length - 1) &lt; 0 || (a = as[getProbe() &amp; m]) == null || !(uncontended = a.cas(v = a.value, v + x))) longAccumulate(x, null, uncontended); &#125;&#125; æ¥ä¸‹æ¥çœ‹longAccumulateï¼ˆï¼‰ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178/** * é¦–å…ˆï¼šå“ªäº›æƒ…å†µä¼šè¿›å…¥å½“å‰æ–¹æ³•ï¼Ÿ * cellsæœªåˆå§‹åŒ–ï¼Œ æˆ–è€… å½“å‰çº¿ç¨‹å¯¹åº”çš„cellæœªåˆå§‹åŒ–ï¼Œ æˆ–è€… casäº¤æ¢å¤±è´¥ * @param x æ–°å€¼ * @param fn æ²¡ç”¨ä¸Šã€‚ä¸€ä¸ªæ‰©å±•æ¥å£ * @param wasUncontended åªæœ‰cellsåˆå§‹åŒ–ä¹‹åï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹ ç«äº‰ä¿®æ”¹å¤±è´¥ï¼Œæ‰ä¼šæ˜¯false */final void longAccumulate(long x, LongBinaryOperator fn, boolean wasUncontended) &#123; //hï¼šä»£è¡¨å½“å‰çº¿ç¨‹hashå€¼ int h; /** * å¦‚æœå½“å‰çº¿ç¨‹hashå€¼ç­‰äº0ï¼Œæ¡ä»¶æˆç«‹ * ç»™å½“å‰çº¿ç¨‹åˆ†é…hashå€¼ * å°†å½“å‰çº¿ç¨‹çš„hashå€¼é‡æ–°èµ‹å€¼ç»™h * è®¾ç½®ä¸ºæœªç«äº‰æˆ–è€…ç«äº‰ä¿®æ”¹æˆåŠŸçŠ¶æ€ã€‚ * ä¸ºä»€ä¹ˆï¼Ÿ * å› ä¸ºé»˜è®¤æ‰€æœ‰çº¿ç¨‹è¿›æ¥æ“åšçš„éƒ½æ˜¯cells[0]çš„ä½ç½®ï¼Œæ‰€ä»¥ä¸æŠŠå®ƒå½“ä½œä¸€æ¬¡çœŸæ­£çš„ç«äº‰ã€‚ */ if ((h = getProbe()) == 0) &#123; //ç»™å½“å‰çº¿ç¨‹åˆ†é…hashå€¼ ThreadLocalRandom.current(); // force initialization //å°†å½“å‰çº¿ç¨‹çš„hashå€¼é‡æ–°èµ‹å€¼ç»™h h = getProbe(); wasUncontended = true; &#125; //è¡¨ç¤ºæ‰©å®¹æ„å‘ false ä¸€å®šä¸ä¼šæ‰©å®¹ï¼Œtrue å¯èƒ½ä¼šæ‰©å®¹ã€‚ boolean collide = false; //è‡ªæ—‹ for (;;) &#123; /** * as ä»£è¡¨cellsçš„å¼•ç”¨ * a å½“å‰çº¿ç¨‹å¯¹åº”çš„cell * n cellsçš„é•¿åº¦ * v æœŸæœ›å€¼ */ Cell[] as; Cell a; int n; long v; /** * case1ï¼š * cellså·²ç»åˆå§‹åŒ– * * case1.1ï¼š * if(å½“å‰çº¿ç¨‹å¯¹åº”çš„cellè¿˜æ²¡æœ‰åˆå§‹åŒ– &amp;&amp; å½“å‰å¤„äºæ— é”çŠ¶æ€)&#123; * åˆ›å»ºä¸€ä¸ªæ–°çš„cellå¯¹è±¡ r * * ifï¼ˆå½“å‰é”çŠ¶æ€æœª0å¹¶ä¸”è·å–åˆ°äº†é”ï¼‰&#123; * created : æ ‡è®°æ˜¯å¦åˆ›å»ºæˆåŠŸ * ifï¼ˆcellså·²ç»è¢«åˆå§‹åŒ– &amp;&amp; å½“å‰çº¿ç¨‹å¯¹åº”çš„cellä¸ºç©ºï¼‰&#123; * å°†å½“å‰çº¿ç¨‹å¯¹åº”ä½ç½®çš„cellåˆå§‹åŒ–ä¸ºæ–°åˆ›å»ºçš„cell r * create=true è¡¨ç¤ºåˆ›å»ºæˆåŠŸï¼Œæœ€ç»ˆåœ¨é‡Šæ”¾é”ã€‚ * &#125; * &#125; * å°†æ‰©å®¹æ„å‘æ”¹æˆfalse * &#125; * * case1.2: * if(å¦‚æœå½“å‰çº¿ç¨‹ç«äº‰ä¿®æ”¹å¤±è´¥)&#123; * çŠ¶æ€æ”¹ä¸ºtrueï¼› * //é»˜è®¤æ‰€æœ‰çº¿ç¨‹ä¸€å¼€å§‹éƒ½åœ¨cell[0]çš„ä½ç½®ï¼Œæ‰€ä»¥ä¸€å®šä¼šå‘ç”Ÿç«äº‰ï¼Œ * //è¿™æ¬¡ç«äº‰å°±ä¸å½“ä½œä¸€æ¬¡çœŸæ­£çš„ç«äº‰ã€‚ * &#125; * * case1.3ï¼š * if(å½“å‰çº¿ç¨‹rehashè¿‡hashå€¼ &amp;&amp; æ–°å‘½ä¸­çš„cellä¸ä¸ºç©º)&#123; * å°è¯•casä¸€æ¬¡ * &#125; * * case1.4ï¼š * if(å¦‚æœcellsçš„é•¿åº¦&gt;cpuæ•° || cellså’Œasä¸ä¸€è‡´)&#123; * //cellså’Œasä¸ä¸€è‡´ è¯´æ˜å…¶ä»–çº¿ç¨‹å·²ç»æ‰©å®¹è¿‡äº†ï¼Œå½“å‰çº¿ç¨‹åªéœ€è¦rehashé‡è¯•å³å¯ * æ‰©å®¹æ„å‘å¼ºåˆ¶æ”¹ä¸ºfalseã€‚ * &#125; * * case1.5ï¼š * //!collide = true è®¾ç½®æ‰©å®¹æ„å‘ ä¸ºtrue ä½†æ˜¯ä¸ä¸€å®šçœŸçš„å‘ç”Ÿæ‰©å®¹ * * case1.6ï¼š * if(é”çŠ¶æ€ä¸º0 &amp;&amp; è·å–åˆ°äº†é”)&#123; * //ç¬¬äºŒå±‚åˆ¤æ–­ä¸ºäº†é˜²æ­¢å½“å‰çº¿ç¨‹åœ¨å¯¹ç¬¬ä¸€å±‚idçš„æ¡ä»¶åˆ¤æ–­ä¸€åŠçš„æ—¶å€™ï¼Œåˆè¿›æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œå°†æ‰€æœ‰ä¸šåŠ¡å·²ç»æ‰§è¡Œä¸€éäº†ã€‚ * //åªæœ‰å½“cells==asæ‰èƒ½è¯´æ˜ï¼Œå½“å‰çº¿ç¨‹åœ¨ç¬¬ä¸€å±‚ifæ‰§è¡Œæ¡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹è¿›æ¥ç ´åã€‚ * if(cells==as)&#123; * æ‰©å®¹ä¸ºåŸæ¥çš„äºŒå€ * é‡ç½®å½“å‰çº¿ç¨‹Hashå€¼ * &#125; * &#125; */ if ((as = cells) != null &amp;&amp; (n = as.length) &gt; 0) &#123; if ((a = as[(n - 1) &amp; h]) == null) &#123; if (cellsBusy == 0) &#123; // Try to attach new Cell Cell r = new Cell(x); // Optimistically create if (cellsBusy == 0 &amp;&amp; casCellsBusy()) &#123; //æ ‡è®°æ˜¯å¦åˆ›å»ºæˆåŠŸ boolean created = false; try &#123; /** * rsï¼šcellsçš„å¼•ç”¨ * mï¼šcellsçš„é•¿åº¦ * jï¼šå½“å‰çº¿ç¨‹å¯¹åº”çš„cellsä¸‹æ ‡ */ Cell[] rs; int m, j; if ((rs = cells) != null &amp;&amp; (m = rs.length) &gt; 0 &amp;&amp; rs[j = (m - 1) &amp; h] == null) &#123; rs[j] = r; created = true; &#125; &#125; finally &#123; cellsBusy = 0; &#125; if (created) break; continue; // Slot is now non-empty &#125; &#125; collide = false; &#125; else if (!wasUncontended) // CAS already known to fail wasUncontended = true; // Continue after rehash else if (a.cas(v = a.value, ((fn == null) ? v + x : fn.applyAsLong(v, x)))) break; else if (n &gt;= NCPU || cells != as) collide = false; // At max size or stale else if (!collide) collide = true; else if (cellsBusy == 0 &amp;&amp; casCellsBusy()) &#123; try &#123; if (cells == as) &#123; // Expand table unless stale Cell[] rs = new Cell[n &lt;&lt; 1]; for (int i = 0; i &lt; n; ++i) rs[i] = as[i]; cells = rs; &#125; &#125; finally &#123; cellsBusy = 0; &#125; collide = false; continue; // Retry with expanded table &#125; //é‡ç½®å½“å‰çº¿ç¨‹Hashå€¼ h = advanceProbe(h); &#125; /** * case2ï¼š * cellså¹¶æœªåˆå§‹åŒ– * é”çŠ¶æ€ä¸º0 * cells==as ï¼Ÿ å› ä¸ºå…¶å®ƒçº¿ç¨‹å¯èƒ½ä¼šåœ¨ä½ ç»™asèµ‹å€¼ä¹‹åä¿®æ”¹äº† cells * è·å–é”æˆåŠŸ * é‡Œé¢å†æ¬¡åˆ¤æ–­cells==asæ˜¯å› ä¸ºé˜²æ­¢å…¶ä»–çº¿ç¨‹åœ¨åˆ¤æ–­ç¬¬ä¸€å±‚ifçš„ä¸­é—´è¢«å…¶ä»–çº¿ç¨‹å…ˆè¿›æ¥ä¿®æ”¹äº†ä¸€æ¬¡ * åˆå§‹åŒ–cells */ else if (cellsBusy == 0 &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123; boolean init = false; try &#123; // Initialize table if (cells == as) &#123; Cell[] rs = new Cell[2]; rs[h &amp; 1] = new Cell(x); cells = rs; init = true; &#125; &#125; finally &#123; cellsBusy = 0; &#125; if (init) break; &#125; /** * case3ï¼š * cellsBusyå¤„äºåŠ é”çŠ¶æ€ï¼Œè¡¨ç¤ºå…¶ä»–çº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–cellsï¼Œ * é‚£ä¹ˆå½“å‰çº¿ç¨‹å°±åº”è¯¥å°†æ•°æ®ç´¯åŠ åˆ°base */ else if (casBase(v = base, ((fn == null) ? v + x : fn.applyAsLong(v, x)))) break; // Fall back on using base &#125;&#125; getProbe()è·å–å½“å‰çº¿ç¨‹hashå€¼ã€‚ 123static final int getProbe() &#123; return UNSAFE.getInt(Thread.currentThread(), PROBE);&#125; casCellsBusy()casçš„æ–¹å¼è·å–é”ã€‚ 123final boolean casCellsBusy() &#123; return UNSAFE.compareAndSwapInt(this, CELLSBUSY, 0, 1);&#125; advanceProbe(h)é‡ç½®å½“å‰çº¿ç¨‹hashå€¼ã€‚ 1234567static final int advanceProbe(int probe) &#123; probe ^= probe &lt;&lt; 13; // xorshift probe ^= probe &gt;&gt;&gt; 17; probe ^= probe &lt;&lt; 5; UNSAFE.putInt(Thread.currentThread(), PROBE, probe); return probe;&#125; casBase()casçš„æ–¹å¼æ”¹å˜baseå€¼ã€‚ 123final boolean casBase(long cmp, long val) &#123; return UNSAFE.compareAndSwapLong(this, BASE, cmp, val);&#125; ä¸‰ï¼ŒLongAdderæ‰§è¡Œæµç¨‹â€‹ LongAdderçš„æ‰§è¡Œæµç¨‹å®é™…ä¸Šå°±æ˜¯ï¼šâ€‹ å½“æ²¡æœ‰çº¿ç¨‹ç«äº‰çš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šç›´æ¥æ“åšbaseé‡Œé¢çš„å€¼ã€‚ å½“æœ‰çº¿ç¨‹ç«äº‰çš„æ—¶å€™ï¼Œä¼šå°†baseçš„å€¼æ‹·è´æˆä¸€ä¸ªcellsæ•°ç»„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æ¥æ“ä½œä¸€ä¸ªcellæ•°ç»„ä¸­çš„æ¡¶ä½ï¼Œæœ€ç»ˆå°†cellså„ä¸ªæ¡¶ä½å’Œbaseæ±‚å’Œï¼Œå°±å¯ä»¥å¾—åˆ°LongAdderçš„æœ€ç»ˆå€¼ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192public void add(long x) &#123; if(æ•°ç»„æœªåˆå§‹åŒ–||casçš„æ–¹å¼æŠŠå€¼å†™å…¥baseå¤±è´¥)&#123; if(æ•°ç»„æœªåˆå§‹åŒ–||å½“å‰çº¿ç¨‹å¯¹åº”çš„å•å…ƒæ ¼æœªåˆå§‹åŒ–||æˆ–casçš„æ–¹å¼åœ¨å½“å‰çº¿ç¨‹å¯¹åº”çš„å•å…ƒæ ¼äº¤æ¢æ•°æ®å¤±è´¥ï¼Œè¯´æ˜æœ‰ç«äº‰)&#123; longAccumulate(x, null, uncontended); &#125; &#125;&#125;final void longAccumulate(long x, LongBinaryOperator fn,boolean wasUncontended) &#123; if(å½“å‰çº¿ç¨‹hashå€¼==0)&#123; é‡ç½®å½“å‰çº¿ç¨‹hashå€¼ æ˜¯å¦å‘ç”Ÿç«äº‰æ”¹ä¸ºtrue &#125; å£°æ˜æ‰©å®¹æ„å‘=false for(;;)&#123; if(æ•°ç»„å·²ç»åˆå§‹åŒ–è¿‡)&#123; if(å½“å‰çº¿ç¨‹å‘½ä¸­çš„å•å…ƒæ ¼æœªåˆå§‹åŒ–)&#123; if(å¦‚æœå½“å‰æ•°ç»„ä¸æ˜¯æ­£åœ¨æ‰©å®¹)&#123; åˆ›å»ºä¸€ä¸ªæ–°çš„Cell(x) if(å½“å‰å¹¶æœªæœ‰å…¶ä»–çº¿ç¨‹å¯¹æ•°ç»„è¿›è¡Œæ‰©å®¹&amp;&amp;ä¸”å½“å‰çº¿ç¨‹ç«äº‰æ‰©å®¹æ•°ç»„çš„æƒåˆ©æˆåŠŸ)&#123; å£°æ˜ åˆ›å»ºå®Œæˆ =falseï¼› if(æ•°ç»„ä¸ä¸ºç©º&amp;&amp;å½“å‰æ²¡æœ‰çº¿ç¨‹æ­£åœ¨æ“ä½œæ•°ç»„&amp;&amp;ä¸”å½“å‰çº¿ç¨‹å‘½ä¸­çš„å•å…ƒæ ¼ä¸ºç©º)&#123; å°†å½“å‰çº¿ç¨‹å¯¹åº”çš„å•å…ƒæ ¼åˆå§‹åŒ–ä¸ºåˆšæ‰åˆ›å»ºçš„cell åˆ›å»ºå®Œæˆ =trueï¼› é‡Šæ”¾ æ•°ç»„æ‰©å®¹çš„æƒåˆ© &#125; if(æ•°ç»„å·²ç»åˆ›å»ºå®Œæˆ)&#123; break &#125; continue; &#125; &#125; æ‰©å®¹æ„å‘ =false &#125; else if(å¦‚æœå½“å‰çº¿ç¨‹ç«äº‰ä¿®æ”¹å¤±è´¥)&#123; çŠ¶æ€è®¾ç½®ä¸ºtrue //é»˜è®¤æ‰€æœ‰çº¿ç¨‹1å¼€å§‹éƒ½åœ¨cell[0]çš„ä½ç½®ï¼Œæ‰€ä»¥ä¸€å®šä¼šå‘ç”Ÿç«äº‰ï¼Œè¿™æ¬¡ç«äº‰å°±ä¸å½“åšä¸€æ¬¡çœŸæ­£çš„ç«äº‰ &#125; else if(casçš„æ–¹å¼ä¿®æ”¹å½“å‰çº¿ç¨‹å‘½ä¸­çš„å•å…ƒæ ¼æˆåŠŸ)&#123; break &#125; else if(æ•°ç»„é•¿åº¦å¤§äºcpuæ•°||cellsé•¿åº¦ å’Œå½“å‰æ•°ç»„é•¿åº¦ä¸ä¸€è‡´)&#123; æ‰©å®¹æ„å‘ =false //cellsé•¿åº¦ å’Œå½“å‰æ•°ç»„é•¿åº¦ä¸ä¸€è‡´ï¼šè¯´æ˜å·²ç»æœ‰å…¶ä»–çº¿ç¨‹æ‰©å®¹äº†ï¼Œå½“å‰çº¿ç¨‹åªè¦rehashé‡è¯•å³å¯ã€‚ &#125; else if(æ‰©å®¹æ„å‘==false)&#123; æ‰©å®¹æ„å‘ = true //ä½†æ˜¯ä¸ä¸€å®šçœŸçš„å‘ç”Ÿæ‰©å®¹ &#125; else if(å½“å‰æ²¡æœ‰çº¿ç¨‹æ­£åœ¨åœ¨æ‰©å®¹æ•°ç»„ &amp;&amp; å¹¶ä¸”å½“å‰çº¿ç¨‹ç«äº‰åˆ°äº†æ‰©å®¹æ•°ç»„çš„èµ„æ ¼)&#123; if(åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ²¡æœ‰çº¿ç¨‹æŠŠæ•°ç»„æ‰©å®¹äº†,ä¹Ÿå°±æ˜¯å•¥ä¹Ÿæ²¡å‘ç”Ÿ)&#123; æ•°ç»„æ‰©å®¹ä¸€å€ï¼Œå°†åŸæ•°ç»„çš„å€¼è¿›è¡Œä¸€ä¸ªæ‹·è´ï¼Œå°†æ–°æ•°ç»„çš„åœ°å€æŒ‡å‘åŸæ•°ç»„ &#125; é‡Šæ”¾æ•°ç»„æ‰©å®¹çš„æƒåˆ© æ‰©å®¹æ„å‘æ”¹æˆfalse &#125; æŠŠå½“å‰çº¿ç¨‹çš„hashå€¼rehash &#125; //å½“å‰æ•°ç»„æ²¡æœ‰è¢«åˆå§‹åŒ– else if(å½“å‰æ²¡æœ‰çº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–æ•°ç»„ï¼Œä¹Ÿæ²¡æœ‰çº¿ç¨‹å·²ç»åˆå§‹åŒ–å®Œäº†ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹ç«äº‰åˆ°äº†åˆå§‹åŒ–çš„æƒåˆ©)&#123; å£°æ˜ åˆå§‹åŒ– == false if(å½“å‰æ•°ç»„è¿˜æœªåˆå§‹åŒ–ï¼Œè¯´æ˜æ²¡æœ‰çº¿ç¨‹å·²ç»åˆå§‹åŒ–å®Œäº†)&#123; åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º2 çš„æ•°ç»„ å¹¶æŠŠå½“å‰çº¿ç¨‹å‘½ä¸­çš„å•å…ƒæ ¼åˆå§‹åŒ– åˆå§‹åŒ– == true &#125; é‡Šæ”¾æ•°ç»„æ‰©å®¹æƒåˆ© if(åˆå§‹åŒ–==true)&#123; break &#125; &#125; //å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–æ•°ç»„ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±åº”è¯¥å°†æ•°æ®ç´¯åŠ åˆ°base else if(casçš„æ–¹å¼ä¿®æ”¹baseå€¼æˆåŠŸ)&#123; break &#125; &#125;&#125; 1.ä¸ºä»€ä¹ˆæ¯”casçš„æ•ˆç‡é«˜ï¼Ÿâ€‹ casæ˜¯å¤šçº¿ç¨‹ç«äº‰ï¼Œåªæœ‰æ‹¿åˆ°é”çš„çº¿ç¨‹æ‰èƒ½å»æ“åšèµ„æºï¼Œå…¶ä»–çº¿ç¨‹ä¸æ–­çš„è‡ªæ—‹é‡è¯•ï¼Œç›¸å½“äºçº¿ç¨‹æ’é˜Ÿã€‚ LongAdderæ˜¯å¤šçº¿ç¨‹ç«äº‰çš„æ—¶å€™ï¼Œä»–ä¼šå°†å…±äº«èµ„æºæ‹·è´å¤šä»½ï¼Œé‡‡ç”¨åˆ†æ”¯åˆå¹¶çš„æ€æƒ³ï¼Œæå‡æ•ˆç‡ã€‚","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"AtomicåŸå­ç±»","slug":"JUC/AtomicåŸå­ç±»","date":"2022-01-11T11:06:04.400Z","updated":"2022-01-11T11:24:37.487Z","comments":true,"path":"2022/01/11/JUC/AtomicåŸå­ç±»/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/Atomic%E5%8E%9F%E5%AD%90%E7%B1%BB/","excerpt":"","text":"æ‰€è°“çš„åŸå­æ€§è¡¨ç¤ºä¸€ä¸ªæˆ–è€…å¤šä¸ªæ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå®Œï¼Œè¦ä¹ˆä¸€ä¸ªä¹Ÿä¸æ‰§è¡Œã€‚ä¸èƒ½å‡ºç°æˆåŠŸä¸€éƒ¨åˆ†å¤±è´¥ä¸€éƒ¨åˆ†çš„æƒ…å†µã€‚â€‹ åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶æ›´æ–°ä¸€ä¸ªå…±äº«å˜é‡ï¼Œå¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæ„æ–™ä¹‹å¤–çš„å€¼ã€‚æ¯”å¦‚ i=1 ã€‚A çº¿ç¨‹æ›´æ–° i+1 ã€B çº¿ç¨‹ä¹Ÿæ›´æ–° i+1ã€‚â€‹ é€šè¿‡ä¸¤ä¸ªçº¿ç¨‹å¹¶è¡Œæ“ä½œä¹‹åå¯èƒ½ i çš„å€¼ä¸ç­‰äº 3ã€‚è€Œå¯èƒ½ç­‰äº 2ã€‚å› ä¸º A å’Œ B åœ¨æ›´æ–°å˜é‡ i çš„æ—¶å€™æ‹¿åˆ°çš„ i å¯èƒ½éƒ½æ˜¯ 1è¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„åŸå­æ€§é—®é¢˜ã€‚â€‹ ä» JDK1.5 å¼€å§‹ï¼Œåœ¨ J.U.C åŒ…ä¸­æä¾›äº† Atomic åŒ…ï¼Œæä¾›äº†å¯¹äºå¸¸ç”¨æ•°æ®ç»“æ„çš„åŸå­æ“ä½œã€‚å®ƒæä¾›äº†ç®€å•ã€é«˜æ•ˆã€ä»¥åŠçº¿ç¨‹å®‰å…¨çš„æ›´æ–°ä¸€ä¸ªå˜é‡çš„æ–¹å¼ã€‚â€‹ 1.jucä¸­çš„åŸå­æ“ä½œç±»ç”±äºå˜é‡ç±»å‹çš„å…³ç³»ï¼Œåœ¨ J.U.C ä¸­æä¾›äº† 12 ä¸ªåŸå­æ“ä½œçš„ç±»ã€‚è¿™ 12 ä¸ªç±»å¯ä»¥åˆ†ä¸ºå››å¤§ç±»ï¼šâ€‹ åŸå­æ›´æ–°åŸºæœ¬ç±»å‹ï¼šAtomicBooleanã€AtomicIntegerã€AtomicLong â€‹ åŸå­æ›´æ–°æ•°ç»„ï¼šAtomicIntegerArray ã€ AtomicLongArray ã€AtomicReferenceArray â€‹ åŸå­æ›´æ–°å¼•ç”¨ï¼šAtomicReference ã€ AtomicReferenceFieldUpdater ã€AtomicMarkableReferenceï¼ˆæ›´æ–°å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹ï¼‰ â€‹ åŸå­æ›´æ–°å­—æ®µï¼šAtomicIntegerFieldUpdaterã€AtomicLongFieldUpdaterã€AtomicStampedReference â€‹ 2.AtomicIntergeræºç åˆ†æ2.1å±æ€§&amp;æ„é€ å™¨12345678910111213141516171819202122232425private static final long serialVersionUID = 6214790243416807050L;//è·å–åˆ°Unsafeç±»private static final Unsafe unsafe = Unsafe.getUnsafe();//valueçš„å†…å­˜åç§»é‡private static final long valueOffset;//åˆå§‹åŒ–çš„æ—¶å€™è·å–valueçš„åç§»é‡static &#123; try &#123; valueOffset = unsafe.objectFieldOffset (AtomicInteger.class.getDeclaredField(&quot;value&quot;)); &#125; catch (Exception ex) &#123; throw new Error(ex); &#125;&#125;//å…·ä½“å­˜æ”¾çš„valueå€¼ï¼Œé€šè¿‡volatileä¿è¯å†…å­˜å¯è§æ€§private volatile int value;//åˆ›å»ºä¸€ä¸ªå¸¦æœ‰åˆå§‹å€¼çš„åŸå­ç±»å¯¹è±¡public AtomicInteger(int initialValue) &#123; value = initialValue;&#125;//åˆ›å»ºä¸€ä¸ªé»˜è®¤0å€¼çš„åŸå­ç±»å¯¹è±¡public AtomicInteger() &#123;&#125; 2.2 get()&amp;set()&amp;lazySet()1234567891011121314151617181920212223//è·å–å½“å‰æœ€æ–°å€¼//get æ–¹æ³•åªéœ€è¦ç›´æ¥è¿”å› value çš„å€¼å°±è¡Œï¼Œè¿™é‡Œçš„ value æ˜¯é€šè¿‡ Volatile ä¿®é¥°çš„ï¼Œç”¨æ¥ä¿è¯å¯è§æ€§ã€‚ public final int get() &#123; return value; &#125; //å°†å½“å‰å€¼è®¾ç½®ä¸ºæŒ‡å®šçš„å€¼ public final void set(int newValue) &#123; value = newValue; &#125; /** * lazysetè°ƒç”¨äº†unsafeçš„putOrderedIntæ–¹æ³• * å¯¹æ¯”ä¸€ä¸‹setå’ŒlazySetï¼š * å¯¹æ¯”æ±‡ç¼–æŒ‡ä»¤å·®å¼‚ï¼Œå¯ä»¥çœ‹åˆ°setæ“ä½œåŠ äº†locké”ï¼ŒlazySetæ²¡æœ‰ã€‚ * locké”çš„å«ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ * lazySetæä¾›ä¸€ä¸ªstore storeå±éšœï¼ˆåœ¨å½“ä»£ç³»ç»Ÿä¸­æ˜¯å¾ˆä½æˆæœ¬çš„æ“ä½œï¼Œæˆ–è€…è¯´æ²¡æœ‰æ“ä½œï¼‰ï¼Œ * ä½†æ˜¯æ²¡æœ‰store loadå±éšœï¼ˆè¿™é€šå¸¸æ˜¯volatileå†™å…¥åŠ¨ä½œæœ€æ˜‚è´µçš„éƒ¨åˆ†ï¼‰ã€‚ * @param newValue */ public final void lazySet(int newValue) &#123; unsafe.putOrderedInt(this, valueOffset, newValue); &#125; 2.3 getAndIncrement()â€‹ getAndIncrement å®é™…ä¸Šæ˜¯è°ƒç”¨ unsafe è¿™ä¸ªç±»é‡Œé¢æä¾›çš„æ–¹æ³•ï¼Œè¿™ä¸ªç±»ç›¸å½“äºæ˜¯ä¸€ä¸ªåé—¨ï¼Œä½¿å¾— Java å¯ä»¥åƒ C è¯­è¨€çš„æŒ‡é’ˆä¸€æ ·ç›´æ¥æ“ä½œå†…å­˜ç©ºé—´ã€‚å½“ç„¶ä¹Ÿä¼šå¸¦æ¥ä¸€äº›å¼Šç«¯ï¼Œå°±æ˜¯æŒ‡é’ˆçš„é—®é¢˜ã€‚â€‹ å®é™…ä¸Šè¿™ä¸ªç±»åœ¨å¾ˆå¤šæ–¹é¢éƒ½æœ‰ä½¿ç”¨ï¼Œé™¤äº† J.U.C è¿™ä¸ªåŒ…ä»¥å¤–ï¼Œè¿˜æœ‰ Nettyã€kafka ç­‰ç­‰ï¼Œè¿™ä¸ªç±»æä¾›äº†å¾ˆå¤šåŠŸèƒ½ï¼ŒåŒ…æ‹¬å¤šçº¿ç¨‹åŒæ­¥(monitorEnter)ã€CAS æ“ ä½œ (compareAndSwap) ã€ çº¿ ç¨‹ çš„ æŒ‚ èµ· å’Œ æ¢ å¤(park/unpark)ã€å†…å­˜å±(loadFence/storeFence)å†…å­˜ç®¡ç†ï¼ˆå†…å­˜åˆ†é…ã€é‡Šæ”¾å†…å­˜ã€è·å–å†…å­˜åœ°å€ç­‰.ï¼‰â€‹ 123public final int getAndIncrement() &#123; return unsafe.getAndAddInt(this, valueOffset, 1);&#125; 2.4 getAndAddInt()é€šè¿‡ do/while å¾ªç¯ï¼ŒåŸºäº CAS ä¹è§‚é”æ¥åšåŸå­é€’å¢ã€‚å®é™…ä¸Šå‰é¢çš„ valueOffset çš„ä½œç”¨å°±æ˜¯ä»ä¸»å†…å­˜ä¸­è·å¾—å½“å‰value çš„å€¼å’Œé¢„æœŸå€¼åšä¸€ä¸ªæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œå¯¹ value åšé€’å¢å¹¶ç»“æŸå¾ªç¯ã€‚ 123public final int getAndIncrement() &#123; return unsafe.getAndAddInt(this, valueOffset, 1);&#125; 2.5 compareAndSet()å®ƒ æ ä¾› äº† compareAndSet ï¼Œ å… è®¸ å®¢ æˆ· ç«¯ åŸº äºAtomicInteger æ¥å®ç°ä¹è§‚é”çš„æ“ä½œã€‚ 123public final boolean compareAndSet(int expect, int update) &#123; return unsafe.compareAndSwapInt(this, valueOffset, expect, update);&#125; 3.AtomicStampReferenceâ€‹ \u0000è§£å†³casçš„ABAé—®é¢˜é”æä¾›çš„ä¸€ä¸ªç±»ï¼Œè§£å†³æ–¹æ³•æ˜¯å¯¹æ•°æ®åŠ ç‰ˆæœ¬å·ã€‚â€‹ 3.1 å±æ€§&amp;æ„é€ å™¨123456//ç”¨volatileæ¥ä¿®é¥°Pairå¯¹è±¡ä¿è¯å…¶å†…å­˜å¯è§æ€§private volatile Pair&lt;V&gt; pair;//é€šè¿‡ä¼ å…¥çš„åˆå§‹å€¼å’Œç‰ˆæœ¬å·æ„å»ºpairå¯¹è±¡public AtomicStampedReference(V initialRef, int initialStamp) &#123; pair = Pair.of(initialRef, initialStamp);&#125; 3.2 å†…éƒ¨ç±»123456789101112private static class Pair&lt;T&gt; &#123; final T reference; //å¼•ç”¨æ•°æ® final int stamp; //ç‰ˆæœ¬å· private Pair(T reference, int stamp) &#123; this.reference = reference; this.stamp = stamp; &#125; //é€šè¿‡æ³›å‹æ–¹æ³•æ„é€ å¯¹è±¡ static &lt;T&gt; Pair&lt;T&gt; of(T reference, int stamp) &#123; return new Pair&lt;T&gt;(reference, stamp); &#125;&#125; 3.3 compareAndSet()æ¯”è¾ƒå¹¶äº¤æ¢ 123456789101112131415161718192021//å‚æ•°ï¼šæœŸæœ›å€¼ï¼Œæ–°å€¼ï¼ŒæœŸæœ›ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp) &#123; Pair&lt;V&gt; current = pair; return //æœŸæœ›å€¼å’Œå½“å‰å€¼ç›¸ç­‰ expectedReference == current.reference &amp;&amp; //æœŸæœ›ç‰ˆæœ¬å’Œæ–°ç‰ˆæœ¬ç›¸ç­‰ expectedStamp == current.stamp &amp;&amp; ( ( //è¡¨ç¤ºç‰ˆæœ¬å·å¯¹åº”ä¸Šçš„åŒæ—¶ï¼Œå€¼ä¹Ÿå¯¹åº”ä¸Šï¼Œå°±æ²¡æœ‰å¿…è¦åˆ›å»ºæ–°çš„pairå¯¹è±¡äº† newReference == current.reference &amp;&amp; newStamp == current.stamp ) || //åˆ›å»ºæ–°çš„pairå¯¹è±¡ casPair(current, Pair.of(newReference, newStamp)) );&#125; 3.4 casPair()å®é™…ä¸Šè°ƒç”¨çš„è¿˜æ˜¯unsafeç±»é‡Œé¢çš„compareAndSwapObjectï¼ˆï¼‰ã€‚ 12345private boolean casPair(Pair&lt;V&gt; cmp, Pair&lt;V&gt; val) &#123; return UNSAFE.compareAndSwapObject(this, pairOffset, cmp, val);&#125;","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"CASåŸç†","slug":"JUC/CASåŸç†","date":"2022-01-11T11:05:54.708Z","updated":"2022-01-11T11:24:20.232Z","comments":true,"path":"2022/01/11/JUC/CASåŸç†/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/CAS%E5%8E%9F%E7%90%86/","excerpt":"","text":"1.ä¿è¯i++åœ¨å¤šçº¿ç¨‹ä¸‹çš„å®‰å…¨å¹¶å‘å¯¹ä¸€ä¸ªæ•°è¿›è¡Œ++æ“ä½œä¼šå¯¼è‡´ç»“æœä¸å‡†ç¡®ï¼Œå› ä¸º++æ“ä½œæœ¬èº«å¹¶ä¸æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹ä¼šå‡ºç°é—®é¢˜ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344/** * @author äºŒå * @since 2021/8/26 8:53 ä¸Šåˆ */public class Demo &#123; private static volatile int count = 0; private static int threadSize = 100; private static CountDownLatch countDownLatch = new CountDownLatch(threadSize); private static void request() &#123; try &#123; TimeUnit.MICROSECONDS.sleep(5); /** * å‡ºç°é—®é¢˜çš„åŸå› ï¼šcount++åˆ†ä¸ºä¸‰æ­¥æ“ä½œï¼Œ * count-&gt;æ ˆ A * B=A+1 * count=B */ count++; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; public static void main(String[] args) throws InterruptedException &#123; for (int i = 0; i &lt; 100; i++) &#123; new Thread(() -&gt; &#123; for (int j = 0; j &lt; 10; j++) &#123; request(); &#125; countDownLatch.countDown(); &#125;).start(); &#125; countDownLatch.await(); System.out.println(&quot;count:&quot; + count); &#125;&#125; é€šè¿‡åŠ é”çš„æ–¹å¼å¯ä»¥ä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ï¼Œä½†æ˜¯å¦‚æœç›´æ¥åœ¨request()åŠ é”ï¼Œæ•ˆç‡ä¼šå¾ˆä½ï¼Œå› ä¸ºè¿™æ ·é”çš„ç²’åº¦æ¯”è¾ƒå¤§ã€‚â€‹ åˆ†æä¸€ä¸‹count++æ“ä½œï¼šâ€‹ countçš„å€¼èµ‹å€¼ç»™æ“ä½œæ•°æ ˆå†…çš„a å°†æ“ä½œæ•°æ ˆå†…çš„a+1å¹¶èµ‹å€¼ç»™b å°†æ“ä½œæ•°æ ˆå†…bçš„å€¼èµ‹å€¼ç»™count å¹¶å‘æ¡ä»¶ä¸‹å‡ºç°é”™è¯¯çš„åŸå› å°±æ˜¯å› ä¸ºå‡å¦‚açº¿ç¨‹åœ¨æ“ä½œä¸€åŠçš„è¿‡ç¨‹ä¸­ï¼ˆ1-3ä¹‹é—´ï¼‰ï¼Œçº¿ç¨‹bæ¥è·å–countçš„å€¼è¿›è¡Œ++æ“ä½œï¼Œå°±ä¼šè·å–åˆ°ä¸å‡†ç¡®çš„countå€¼ã€‚å¯ä»¥æ§åˆ¶åœ¨ç¬¬ä¸‰æ­¥åŠ é”ï¼Œåœ¨çº¿ç¨‹å°†è‡ªå·±æ“ä½œæ•°æ ˆå†…çš„ç»“æœèµ‹å€¼ç»™countä¹‹å‰ï¼Œå…ˆæ¯”è¾ƒå½“å‰çš„æœ€æ–°countå’Œå½“å‰çº¿ç¨‹æ“ä½œæ•°æ ˆå†…æ‹·è´çš„countå‰¯æœ¬å€¼æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™å½“å‰çº¿ç¨‹å¯ä»¥å°†è‡ªå·±æ“ä½œæ•°æ ˆçš„ç»“æœèµ‹å€¼ç»™countï¼Œå¦åˆ™é‡æ–°è·å–countå€¼è¿›è¡Œæ“ä½œï¼Œç›´åˆ°æˆåŠŸã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758/** * @author äºŒå * @since 2021/8/26 8:53 ä¸Šåˆ */public class Demo &#123; private static volatile int count = 0; private static int threadSize = 100; private static CountDownLatch countDownLatch = new CountDownLatch(threadSize); private static void request() &#123; try &#123; TimeUnit.MICROSECONDS.sleep(5); /** * å‡ºç°é—®é¢˜çš„åŸå› ï¼šcount++åˆ†ä¸ºä¸‰æ­¥æ“ä½œï¼Œ * count-&gt;æ ˆ A * B=A+1 * count=B */// count++; int e; while (!compareAndSwap(e = getCount(), e + 1)) &#123; &#125; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; private static int getCount() &#123; return count; &#125; private static synchronized boolean compareAndSwap(int e, int n) &#123; if (getCount() == e) &#123; count = n; return true; &#125; return false; &#125; public static void main(String[] args) throws InterruptedException &#123; for (int i = 0; i &lt; 100; i++) &#123; new Thread(() -&gt; &#123; for (int j = 0; j &lt; 10; j++) &#123; request(); &#125; countDownLatch.countDown(); &#125;).start(); &#125; countDownLatch.await(); System.out.println(&quot;count:&quot; + count); &#125;&#125; 2.Javaå¯¹casçš„æ”¯æŒ2.1 casæ¦‚å¿µCAS å…¨ç§°â€œCompareAndSwapâ€ï¼Œä¸­æ–‡ç¿»è¯‘è¿‡æ¥ä¸ºâ€œæ¯”è¾ƒå¹¶æ›¿æ¢â€â€‹ CASæ“ä½œåŒ…å«ä¸‰ä¸ªæ“ä½œæ•°â€”â€”â€”â€”å†…å­˜ä½ç½®ï¼ˆVï¼‰ã€æœŸæœ›å€¼ï¼ˆAï¼‰å’Œæ–°å€¼ï¼ˆBï¼‰ã€‚ å¦‚æœå†…å­˜ä½ç½®çš„å€¼ä¸æœŸæœ›å€¼åŒ¹é…ï¼Œé‚£ä¹ˆå¤„ç†å™¨ä¼šè‡ªåŠ¨å°†è¯¥ä½ç½®å€¼æ›´æ–°ä¸ºæ–°å€¼ã€‚ å¦åˆ™ï¼Œå¤„ç†å™¨ä¸ä½œä»»ä½•æ“ä½œã€‚ æ— è®ºå“ªç§æƒ…å†µï¼Œå®ƒéƒ½ä¼šåœ¨CASæŒ‡ä»¤ä¹‹å‰è¿”å›è¯¥ä½ç½®çš„å€¼ã€‚ï¼ˆCASåœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ä»…è¿”å›CASæ˜¯å¦æˆåŠŸï¼Œè€Œä¸æå–å½“å‰å€¼ï¼‰ CASæœ‰æ•ˆçš„è¯´æ˜äº†â€œæˆ‘è®¤ä¸ºä½ç½®Våº”è¯¥åŒ…å«å€¼Aï¼›å¦‚æœåŒ…å«è¯¥å€¼ï¼Œåˆ™å°†Bæ”¾åˆ°è¿™ä¸ªä½ç½®ï¼›å¦åˆ™ï¼Œä¸è¦æ›´æ”¹ã€‚ â€‹ 2.2 jdkä¸­å¯¹casæä¾›çš„æ”¯æŒjavaä¸­æä¾›äº†å¯¹CASæ“ä½œçš„æ”¯æŒï¼Œå…·ä½“åœ¨sun.misc.unsafeç±»ä¸­ï¼Œå£°æ˜å¦‚ä¸‹ï¼šâ€‹ 123public final native boolean compareAndSwapObject(Object var1, long var2, Object var4, Object var5);public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);public final native boolean compareAndSwapLong(Object var1, long var2, long var4, long var6); å‚æ•°var1 è¡¨ç¤ºè¦æ“ä½œçš„å¯¹è±¡ å‚æ•°var2 è¡¨ç¤ºè¦æ“ä½œå¯¹è±¡ä¸­å±æ€§åœ°å€çš„åç§»é‡ å‚æ•°var4 è¡¨ç¤ºéœ€è¦ä¿®æ”¹æ•°æ®çš„æœŸæœ›çš„å€¼ å‚æ•°var5 è¡¨ç¤ºéœ€è¦ä¿®æ”¹ä¸ºçš„æ–°å€¼ 2.3 caså®ç°åŸç†CASé€šè¿‡è°ƒç”¨JNIçš„ä»£ç å®ç°ï¼ŒJNIï¼šjava Native Interfaceï¼Œå…è®¸javaè°ƒç”¨å…¶å®ƒè¯­è¨€ã€‚è€ŒcompareAndSwapxxxç³»åˆ—çš„æ–¹æ³•å°±æ˜¯å€ŸåŠ©â€œCè¯­è¨€â€æ¥è°ƒç”¨cpuåº•å±‚æŒ‡ä»¤å®ç°çš„ã€‚ä»¥å¸¸ç”¨çš„Intel x86å¹³å°æ¥è¯´ï¼Œæœ€ç»ˆæ˜ å°„åˆ°çš„cpuçš„æŒ‡ä»¤ä¸ºâ€œcmpxchgâ€ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸå­æŒ‡ä»¤ï¼Œcpuæ‰§è¡Œæ­¤å‘½ä»¤æ—¶ï¼Œå®ç°æ¯”è¾ƒå¹¶æ›¿æ¢çš„æ“ä½œï¼â€‹ 2.4 cmpxchgæ€ä¹ˆä¿è¯å¤šæ ¸å¿ƒä¸‹çš„çº¿ç¨‹å®‰å…¨ï¼Ÿç³»ç»Ÿåº•å±‚è¿›è¡ŒCASæ“ä½œçš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦ä¸ºå¤šæ ¸å¿ƒç³»ç»Ÿï¼Œå¦‚æœæ˜¯å°±ç»™â€œæ€»çº¿â€åŠ é”ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹æ€»çº¿åŠ é”æˆåŠŸï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šæ‰§è¡ŒCASæ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´CASçš„åŸå­æ€§æ˜¯å¹³å°çº§åˆ«çš„ï¼â€‹ 2.5 caså­˜åœ¨çš„é—®é¢˜1)ABAé—®é¢˜â€‹ çº¿ç¨‹1å‡†å¤‡ç”¨CASå°†å˜é‡çš„å€¼ç”±Aæ›¿æ¢ä¸ºBï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œçº¿ç¨‹2å°†å˜é‡çš„å€¼ç”±Aæ›¿æ¢ä¸ºCï¼Œåˆç”±Cæ›¿æ¢ä¸ºAï¼Œç„¶åçº¿ç¨‹1æ‰§è¡ŒCASæ—¶å‘ç°å˜é‡çš„å€¼ä»ç„¶ä¸ºAï¼Œæ‰€ä»¥CASæˆåŠŸã€‚ä½†å®é™…ä¸Šè¿™æ—¶çš„ç°åœºå·²ç»å’Œæœ€åˆä¸åŒäº†ï¼Œå°½ç®¡CASæˆåŠŸï¼Œä½†å¯èƒ½å­˜åœ¨æ½œè—çš„é—®é¢˜ã€‚ä¸¾ä¾‹ï¼šä¸€ä¸ªå°å·ï¼ŒæŠŠåˆ«äººå®¶çš„é’±å·äº†ä¹‹ååˆè¿˜äº†å›æ¥ï¼Œè¿˜æ˜¯åŸæ¥çš„é’±å—ï¼Œä½ è€å©†å‡ºè½¨ä¹‹ååˆå›æ¥ï¼Œè¿˜æ˜¯åŸæ¥çš„è€å©†å—ï¼ŸABAé—®é¢˜ä¹Ÿä¸€æ ·ï¼Œå¦‚æœä¸å¥½å¥½è§£å†³å°±ä¼šå¸¦æ¥å¤§é‡çš„é—®é¢˜ã€‚æœ€å¸¸è§çš„å°±æ˜¯èµ„é‡‘é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯åˆ«äººå¦‚æœæŒªç”¨äº†ä½ çš„é’±ï¼Œåœ¨ä½ å‘ç°ä¹‹å‰åˆè¿˜äº†å›æ¥ã€‚ä½†æ˜¯åˆ«äººå´å·²ç»è§¦çŠ¯äº†æ³•å¾‹ã€‚â€‹ 2)å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§â€‹ 3)åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ2.6 ABAé—®é¢˜æ¼”ç¤º123456789101112131415161718192021222324252627282930313233343536373839404142434445/** * @author äºŒå * @since 2021/8/26 2:15 ä¸‹åˆ */public class Aba &#123; static CountDownLatch countDownLatch = new CountDownLatch(2); static AtomicInteger i = new AtomicInteger(1); public static void main(String[] args) &#123; new Thread(() -&gt; &#123; int e = Aba.i.get(); int n = e + 1; try &#123; TimeUnit.SECONDS.sleep(2); &#125; catch (InterruptedException ex) &#123; ex.printStackTrace(); &#125; boolean flag = i.compareAndSet(e, n); System.out.println(&quot;flag = &quot; + flag); countDownLatch.countDown(); &#125;).start(); try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; new Thread(() -&gt; &#123; i.incrementAndGet(); i.decrementAndGet(); countDownLatch.countDown(); &#125;).start(); try &#123; countDownLatch.await(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;&#125; 2.7 jdkå¦‚ä½•è§£å†³ABAé—®é¢˜è§£å†³ABAé—®é¢˜å…¶å®å¾ˆç®€å•ï¼Œåªéœ€è¦åŠ ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ“ä½œï¼Œç‰ˆæœ¬å·éƒ½ä¼šåŠ 1ï¼Œæ¯æ¬¡æ¯”è¾ƒäº¤æ¢çš„æ—¶å€™ï¼ŒæŠŠç‰ˆæœ¬å·ä¹Ÿæ¯”è¾ƒä¸€ä¸‹ï¼Œè¿™æ ·å°±èƒ½ç¡®ä¿ï¼Œè¿™ä¸ªæ•°æ®æ˜¯æ­£ç¡®çš„ã€‚â€‹ AtomicStampReferenceä¸»è¦åŒ…å«ä¸€ä¸ªå¯¹è±¡å¼•ç”¨åŠä¸€ä¸ªå¯ä»¥è‡ªåŠ¨æ›´æ–°çš„æ•´æ•°â€œstampâ€çš„pairå¯¹è±¡æ¥è§£å†³ABAé—®é¢˜ã€‚â€‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445/** * @author äºŒå * @since 2021/8/26 2:29 ä¸‹åˆ */public class AtomicStampReferenceTest &#123; static CountDownLatch countDownLatch = new CountDownLatch(2); static AtomicStampedReference&lt;Integer&gt; i = new AtomicStampedReference(1, 1); public static void main(String[] args) &#123; new Thread(() -&gt; &#123; int e = Aba.i.get(); int n = e + 1; int ev = i.getStamp(); try &#123; TimeUnit.SECONDS.sleep(2); &#125; catch (InterruptedException ex) &#123; ex.printStackTrace(); &#125; boolean flag = i.compareAndSet(e, n, ev, ev + 1); System.out.println(&quot;flag = &quot; + flag); countDownLatch.countDown(); &#125;).start(); try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; new Thread(() -&gt; &#123; i.set(i.getReference() + 1, i.getStamp() + 1); i.set(i.getReference() - 1, i.getStamp() + 1); countDownLatch.countDown(); &#125;).start(); try &#123; countDownLatch.await(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;&#125; â€‹","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"Volatile","slug":"JUC/Volatile","date":"2022-01-11T11:05:46.558Z","updated":"2022-01-11T11:30:33.567Z","comments":true,"path":"2022/01/11/JUC/Volatile/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/Volatile/","excerpt":"","text":"ä¸€ï¼Œå†…å­˜æ¨¡å‹çš„ç›¸å…³æ¦‚å¿µè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½æ˜¯åœ¨CPUä¸­æ‰§è¡Œçš„ï¼Œè€Œæ‰§è¡ŒæŒ‡ä»¤è¿‡ç¨‹ä¸­ï¼ŒåŠ¿å¿…æ¶‰åŠåˆ°æ•°æ®çš„è¯»å–å’Œå†™å…¥ã€‚ç”±äºç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ•°æ®æ˜¯å­˜æ”¾åœ¨ä¸»å­˜ï¼ˆç‰©ç†å†…å­˜ï¼‰å½“ä¸­çš„ï¼Œè¿™æ—¶å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºCPUæ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ï¼Œè€Œä»å†…å­˜è¯»å–æ•°æ®å’Œå‘å†…å­˜å†™å…¥æ•°æ®çš„è¿‡ç¨‹è·ŸCPUæ‰§è¡ŒæŒ‡ä»¤çš„é€Ÿåº¦æ¯”èµ·æ¥è¦æ…¢çš„å¤šï¼Œå› æ­¤å¦‚æœä»»ä½•æ—¶å€™å¯¹æ•°æ®çš„æ“ä½œéƒ½è¦é€šè¿‡å’Œå†…å­˜çš„äº¤äº’æ¥è¿›è¡Œï¼Œä¼šå¤§å¤§é™ä½æŒ‡ä»¤æ‰§è¡Œçš„é€Ÿåº¦ã€‚å› æ­¤åœ¨CPUé‡Œé¢å°±æœ‰äº†é«˜é€Ÿç¼“å­˜ã€‚â€‹ ä¹Ÿå°±æ˜¯ï¼Œå½“ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šå°†è¿ç®—éœ€è¦çš„æ•°æ®ä»ä¸»å­˜å¤åˆ¶ä¸€ä»½åˆ°CPUçš„é«˜é€Ÿç¼“å­˜å½“ä¸­ï¼Œé‚£ä¹ˆCPUè¿›è¡Œè®¡ç®—æ—¶å°±å¯ä»¥ç›´æ¥ä»å®ƒçš„é«˜é€Ÿç¼“å­˜è¯»å–æ•°æ®å’Œå‘å…¶ä¸­å†™å…¥æ•°æ®ï¼Œå½“è¿ç®—ç»“æŸä¹‹åï¼Œå†å°†é«˜é€Ÿç¼“å­˜ä¸­çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚ä¸‹é¢çš„è¿™æ®µä»£ç ï¼šâ€‹ 1i=i+1 å½“çº¿ç¨‹æ‰§è¡Œè¿™ä¸ªè¯­å¥æ—¶ï¼Œä¼šå…ˆä»ä¸»å­˜å½“ä¸­è¯»å–içš„å€¼ï¼Œç„¶åå¤åˆ¶ä¸€ä»½åˆ°é«˜é€Ÿç¼“å­˜å½“ä¸­ï¼Œç„¶åCPUæ‰§è¡ŒæŒ‡ä»¤å¯¹iè¿›è¡ŒåŠ 1æ“ä½œï¼Œç„¶åå°†æ•°æ®å†™å…¥é«˜é€Ÿç¼“å­˜ï¼Œæœ€åå°†é«˜é€Ÿç¼“å­˜ä¸­iæœ€æ–°çš„å€¼åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚â€‹ è¿™ä¸ªä»£ç åœ¨å•çº¿ç¨‹ä¸­è¿è¡Œæ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸­è¿è¡Œå°±ä¼šæœ‰é—®é¢˜äº†ã€‚åœ¨å¤šæ ¸CPUä¸­ï¼Œæ¯æ¡çº¿ç¨‹å¯èƒ½è¿è¡Œäºä¸åŒçš„CPUä¸­ï¼Œå› æ­¤æ¯ä¸ªçº¿ç¨‹è¿è¡Œæ—¶æœ‰è‡ªå·±çš„é«˜é€Ÿç¼“å­˜ï¼ˆå¯¹å•æ ¸CPUæ¥è¯´ï¼Œå…¶å®ä¹Ÿä¼šå‡ºç°è¿™ç§é—®é¢˜ï¼Œåªä¸è¿‡æ˜¯ä»¥çº¿ç¨‹è°ƒåº¦çš„å½¢å¼æ¥åˆ†åˆ«æ‰§è¡Œçš„ï¼‰ã€‚æœ¬æ–‡æˆ‘ä»¬ä»¥å¤šæ ¸CPUä¸ºä¾‹ã€‚â€‹ æ¯”å¦‚åŒæ—¶æœ‰2ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™æ®µä»£ç ï¼Œå‡å¦‚åˆå§‹æ—¶içš„å€¼ä¸º0ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä¹‹åiçš„å€¼å˜ä¸º2ã€‚ä½†æ˜¯äº‹å®ä¼šæ˜¯è¿™æ ·å—ï¼Ÿâ€‹ å¯èƒ½å­˜åœ¨ä¸‹é¢ä¸€ç§æƒ…å†µï¼šåˆå§‹æ—¶ï¼Œä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è¯»å–içš„å€¼å­˜å…¥å„è‡ªæ‰€åœ¨çš„CPUçš„é«˜é€Ÿç¼“å­˜å½“ä¸­ï¼Œç„¶åçº¿ç¨‹1è¿›è¡ŒåŠ 1æ“ä½œï¼Œç„¶åæŠŠiçš„æœ€æ–°å€¼1å†™å…¥åˆ°å†…å­˜ã€‚æ­¤æ—¶çº¿ç¨‹2çš„é«˜é€Ÿç¼“å­˜å½“ä¸­içš„å€¼è¿˜æ˜¯0ï¼Œè¿›è¡ŒåŠ 1æ“ä½œä¹‹åï¼Œiçš„å€¼ä¸º1ï¼Œç„¶åçº¿ç¨‹2æŠŠiçš„å€¼å†™å…¥å†…å­˜ã€‚â€‹ æœ€ç»ˆç»“æœiçš„å€¼æ˜¯1ï¼Œè€Œä¸æ˜¯2ã€‚è¿™å°±æ˜¯è‘—åçš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚é€šå¸¸ç§°è¿™ç§è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®çš„å˜é‡ä¸ºå…±äº«å˜é‡ã€‚â€‹ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªå˜é‡åœ¨å¤šä¸ªCPUä¸­éƒ½å­˜åœ¨ç¼“å­˜ï¼ˆä¸€èˆ¬åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹æ—¶æ‰ä¼šå‡ºç°ï¼‰ï¼Œé‚£ä¹ˆå°±å¯èƒ½å­˜åœ¨ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ã€‚â€‹ ä¸ºäº†è§£å†³ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜ï¼Œé€šå¸¸æ¥è¯´æœ‰ä»¥ä¸‹2ç§è§£å†³æ–¹æ³•ï¼šâ€‹ é€šè¿‡æ€»çº¿åŠ Locké”çš„æ–¹å¼ é€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®® â€‹ è¿™ä¸¤ç§æ–¹å¼éƒ½æ˜¯åœ¨ç¡¬ä»¶å±‚é¢ä¸Šæä¾›çš„æ–¹å¼ã€‚â€‹ åœ¨æ—©æœŸçš„CPUå½“ä¸­ï¼Œæ˜¯é€šè¿‡åœ¨æ€»çº¿ä¸ŠåŠ LOCKé”çš„å½¢å¼æ¥è§£å†³ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ï¼ˆç›¸å½“äºè®©CPUä¸²è¡Œï¼Œæ•ˆç‡ä½ï¼‰ã€‚å› ä¸ºCPUå’Œå…¶ä»–éƒ¨ä»¶è¿›è¡Œé€šä¿¡éƒ½æ˜¯é€šè¿‡æ€»çº¿æ¥è¿›è¡Œçš„ï¼Œå¦‚æœå¯¹æ€»çº¿åŠ LOCKé”çš„è¯ï¼Œä¹Ÿå°±æ˜¯è¯´é˜»å¡äº†å…¶ä»–CPUå¯¹å…¶ä»–éƒ¨ä»¶è®¿é—®ï¼ˆå¦‚å†…å­˜ï¼‰ï¼Œä»è€Œä½¿å¾—åªèƒ½æœ‰ä¸€ä¸ªCPUèƒ½ä½¿ç”¨è¿™ä¸ªå˜é‡çš„å†…å­˜ã€‚æ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­ å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œ i = i +1ï¼Œå¦‚æœåœ¨æ‰§è¡Œè¿™æ®µä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨æ€»çº¿ä¸Šå‘å‡ºäº†LCOKé”çš„ä¿¡å·ï¼Œé‚£ä¹ˆåªæœ‰ç­‰å¾…è¿™æ®µä»£ç å®Œå…¨æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå…¶ä»–CPUæ‰èƒ½ä»å˜é‡iæ‰€åœ¨çš„å†…å­˜è¯»å–å˜é‡ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„æ“ä½œã€‚è¿™æ ·å°±è§£å†³äº†ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ã€‚â€‹ ä½†æ˜¯ä¸Šé¢çš„æ–¹å¼ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºåœ¨é”ä½æ€»çº¿æœŸé—´ï¼Œå…¶ä»–CPUæ— æ³•è®¿é—®å†…å­˜ï¼Œå¯¼è‡´æ•ˆç‡ä½ä¸‹ã€‚â€‹ æ‰€ä»¥å°±å‡ºç°äº†ç¼“å­˜ä¸€è‡´æ€§åè®®ã€‚æœ€å‡ºåçš„å°±æ˜¯Intel çš„MESIåè®®ï¼ŒMESIåè®®ä¿è¯äº†æ¯ä¸ªç¼“å­˜ä¸­ä½¿ç”¨çš„å…±äº«å˜é‡çš„å‰¯æœ¬æ˜¯ä¸€è‡´çš„ï¼ˆæ”¹åŠ¨åˆ™é€šçŸ¥çš„æ–¹å¼ï¼‰ã€‚å®ƒæ ¸å¿ƒçš„æ€æƒ³æ˜¯ï¼šå½“CPUå†™æ•°æ®æ—¶ï¼Œå¦‚æœå‘ç°æ“ä½œçš„å˜é‡æ˜¯å…±äº«å˜é‡ï¼Œå³åœ¨å…¶ä»–CPUä¸­ä¹Ÿå­˜åœ¨è¯¥å˜é‡çš„å‰¯æœ¬ï¼Œä¼šå‘å‡ºä¿¡å·é€šçŸ¥å…¶ä»–CPUå°†è¯¥å˜é‡çš„ç¼“å­˜è¡Œç½®ä¸ºæ— æ•ˆçŠ¶æ€ï¼Œå› æ­¤å½“å…¶ä»–CPUéœ€è¦è¯»å–è¿™ä¸ªå˜é‡æ—¶ï¼Œå‘ç°è‡ªå·±ç¼“å­˜ä¸­ç¼“å­˜è¯¥å˜é‡çš„ç¼“å­˜è¡Œæ˜¯æ— æ•ˆçš„ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šä»å†…å­˜é‡æ–°è¯»å–ã€‚ å—…æ¢æ˜¯å®ç°ç¼“å­˜ä¸€è‡´æ€§çš„å¸¸è§æœºåˆ¶ã€‚â€‹ æ³¨æ„ï¼Œç¼“å­˜çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œä¸æ˜¯å¤šå¤„ç†å™¨å¯¼è‡´ï¼Œè€Œæ˜¯å¤šç¼“å­˜å¯¼è‡´çš„ã€‚ â€‹ å—…æ¢æœºåˆ¶å·¥ä½œåŸç†ï¼šæ¯ä¸ªå¤„ç†å™¨é€šè¿‡ç›‘å¬åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±çš„ç¼“å­˜å€¼æ˜¯ä¸æ˜¯è¿‡æœŸäº†ï¼Œå¦‚æœå¤„ç†å™¨å‘ç°è‡ªå·±ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€ä¿®æ”¹ï¼Œå°±ä¼šå°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®æ— æ•ˆçŠ¶æ€ï¼Œå½“å¤„ç†å™¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šé‡æ–°ä»ä¸»å†…å­˜ä¸­æŠŠæ•°æ®è¯»åˆ°å¤„ç†å™¨ç¼“å­˜ä¸­ã€‚â€‹ æ³¨æ„ï¼šåŸºäº CPU ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ŒJVM å®ç°äº† volatile çš„å¯è§æ€§ï¼Œä½†ç”±äºæ€»çº¿å—…æ¢æœºåˆ¶ï¼Œä¼šä¸æ–­çš„ç›‘å¬æ€»çº¿ï¼Œå¦‚æœå¤§é‡ä½¿ç”¨ volatile ä¼šå¼•èµ·æ€»çº¿é£æš´ã€‚æ‰€ä»¥ï¼Œvolatile çš„ä½¿ç”¨è¦é€‚åˆå…·ä½“åœºæ™¯ã€‚ â€‹ äºŒï¼Œå¹¶å‘ç¼–ç¨‹ä¸­çš„ä¸‰ä¸ªæ¦‚å¿µåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œé€šå¸¸ä¼šå…³å¿ƒä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼šåŸå­æ€§é—®é¢˜ï¼Œå¯è§æ€§é—®é¢˜ï¼Œæœ‰åºæ€§é—®é¢˜ã€‚â€‹ 1.åŸå­æ€§åŸå­æ€§ï¼šå³ä¸€ä¸ªæ“ä½œæˆ–è€…å¤šä¸ªæ“ä½œ è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¹¶ä¸”æ‰§è¡Œçš„è¿‡ç¨‹ä¸ä¼šè¢«ä»»ä½•å› ç´ æ‰“æ–­ï¼Œè¦ä¹ˆå°±éƒ½ä¸æ‰§è¡Œã€‚â€‹ ä¸€ä¸ªå¾ˆç»å…¸çš„ä¾‹å­å°±æ˜¯é“¶è¡Œè´¦æˆ·è½¬è´¦é—®é¢˜ï¼šâ€‹ æ¯”å¦‚ä»è´¦æˆ·Aå‘è´¦æˆ·Bè½¬1000å…ƒï¼Œé‚£ä¹ˆå¿…ç„¶åŒ…æ‹¬2ä¸ªæ“ä½œï¼šä»è´¦æˆ·Aå‡å»1000å…ƒï¼Œå¾€è´¦æˆ·BåŠ ä¸Š1000å…ƒã€‚â€‹ å¦‚æœè¿™2ä¸ªæ“ä½œä¸å…·å¤‡åŸå­æ€§ï¼Œä¼šé€ æˆä»€ä¹ˆæ ·çš„åæœã€‚å‡å¦‚ä»è´¦æˆ·Aå‡å»1000å…ƒä¹‹åï¼Œæ“ä½œçªç„¶ä¸­æ­¢ã€‚ç„¶ååˆä»Bå–å‡ºäº†500å…ƒï¼Œå–å‡º500å…ƒä¹‹åï¼Œå†æ‰§è¡Œ å¾€è´¦æˆ·BåŠ ä¸Š1000å…ƒ çš„æ“ä½œã€‚è¿™æ ·å°±ä¼šå¯¼è‡´è´¦æˆ·Aè™½ç„¶å‡å»äº†1000å…ƒï¼Œä½†æ˜¯è´¦æˆ·Bæ²¡æœ‰æ”¶åˆ°è¿™ä¸ªè½¬è¿‡æ¥çš„1000å…ƒã€‚â€‹ æ‰€ä»¥è¿™2ä¸ªæ“ä½œå¿…é¡»è¦å…·å¤‡åŸå­æ€§æ‰èƒ½ä¿è¯ä¸å‡ºç°ä¸€äº›æ„å¤–çš„é—®é¢˜ã€‚â€‹ åŒæ ·åœ°åæ˜ åˆ°å¹¶å‘ç¼–ç¨‹ä¸­ä¼šå‡ºç°ä»€ä¹ˆç»“æœå‘¢ï¼Ÿâ€‹ å‡å¦‚ä¸ºä¸€ä¸ª32ä½çš„å˜é‡èµ‹å€¼è¿‡ç¨‹ä¸å…·å¤‡åŸå­æ€§çš„è¯ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆåæœï¼Ÿâ€‹ 1i=9ï¼› â€‹ å‡è‹¥ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°è¿™ä¸ªè¯­å¥æ—¶ï¼Œæš‚ä¸”å‡è®¾ä¸ºä¸€ä¸ª32ä½çš„å˜é‡èµ‹å€¼åŒ…æ‹¬ä¸¤ä¸ªè¿‡ç¨‹ï¼šä¸ºä½16ä½èµ‹å€¼ï¼Œä¸ºé«˜16ä½èµ‹å€¼ã€‚â€‹ é‚£ä¹ˆå°±å¯èƒ½å‘ç”Ÿä¸€ç§æƒ…å†µï¼šå½“å°†ä½16ä½æ•°å€¼å†™å…¥ä¹‹åï¼Œçªç„¶è¢«ä¸­æ–­ï¼Œè€Œæ­¤æ—¶åˆæœ‰ä¸€ä¸ªçº¿ç¨‹å»è¯»å–içš„å€¼ï¼Œé‚£ä¹ˆè¯»å–åˆ°çš„å°±æ˜¯é”™è¯¯çš„æ•°æ®ã€‚â€‹ 2.å¯è§æ€§å¯è§æ€§æ˜¯æŒ‡å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼ã€‚â€‹ 123456//çº¿ç¨‹1æ‰§è¡Œçš„ä»£ç int i = 0;i = 10; //çº¿ç¨‹2æ‰§è¡Œçš„ä»£ç j = i; â€‹ å‡è‹¥æ‰§è¡Œçº¿ç¨‹1çš„æ˜¯CPU1ï¼Œæ‰§è¡Œçº¿ç¨‹2çš„æ˜¯CPU2ã€‚ç”±ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œå½“çº¿ç¨‹1æ‰§è¡Œ i =10è¿™å¥æ—¶ï¼Œä¼šå…ˆæŠŠiçš„åˆå§‹å€¼åŠ è½½åˆ°CPU1çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œç„¶åèµ‹å€¼ä¸º10ï¼Œé‚£ä¹ˆåœ¨CPU1çš„é«˜é€Ÿç¼“å­˜å½“ä¸­içš„å€¼å˜ä¸º10äº†ï¼Œå´æ²¡æœ‰ç«‹å³å†™å…¥åˆ°ä¸»å­˜å½“ä¸­ã€‚â€‹ æ­¤æ—¶çº¿ç¨‹2æ‰§è¡Œ j = iï¼Œå®ƒä¼šå…ˆå»ä¸»å­˜è¯»å–içš„å€¼å¹¶åŠ è½½åˆ°CPU2çš„ç¼“å­˜å½“ä¸­ï¼Œæ³¨æ„æ­¤æ—¶å†…å­˜å½“ä¸­içš„å€¼è¿˜æ˜¯0ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—jçš„å€¼ä¸º0ï¼Œè€Œä¸æ˜¯10.â€‹ è¿™å°±æ˜¯å¯è§æ€§é—®é¢˜ï¼Œçº¿ç¨‹1å¯¹å˜é‡iä¿®æ”¹äº†ä¹‹åï¼Œçº¿ç¨‹2æ²¡æœ‰ç«‹å³çœ‹åˆ°çº¿ç¨‹1ä¿®æ”¹çš„å€¼ã€‚â€‹ 3.æœ‰åºæ€§æœ‰åºæ€§ï¼šå³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚â€‹ 1234int i = 0; boolean flag = false;i = 1; //è¯­å¥1 flag = true; //è¯­å¥2 â€‹ ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªintå‹å˜é‡ï¼Œå®šä¹‰äº†ä¸€ä¸ªbooleanç±»å‹å˜é‡ï¼Œç„¶ååˆ†åˆ«å¯¹ä¸¤ä¸ªå˜é‡è¿›è¡Œèµ‹å€¼æ“ä½œã€‚ä»ä»£ç é¡ºåºä¸Šçœ‹ï¼Œè¯­å¥1æ˜¯åœ¨è¯­å¥2å‰é¢çš„ï¼Œé‚£ä¹ˆJVMåœ¨çœŸæ­£æ‰§è¡Œè¿™æ®µä»£ç çš„æ—¶å€™ä¼šä¿è¯è¯­å¥1ä¸€å®šä¼šåœ¨è¯­å¥2å‰é¢æ‰§è¡Œå—ï¼Ÿä¸ä¸€å®šï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œå¯èƒ½ä¼šå‘ç”ŸæŒ‡ä»¤é‡æ’åºï¼ˆInstruction Reorderï¼‰ã€‚â€‹ ä¸‹é¢è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åºï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¤„ç†å™¨ä¸ºäº†æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œå¯èƒ½ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå®ƒä¸ä¿è¯ç¨‹åºä¸­å„ä¸ªè¯­å¥çš„æ‰§è¡Œå…ˆåé¡ºåºåŒä»£ç ä¸­çš„é¡ºåºä¸€è‡´ï¼Œä½†æ˜¯å®ƒä¼šä¿è¯ç¨‹åºæœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºæ‰§è¡Œçš„ç»“æœæ˜¯ä¸€è‡´çš„ã€‚â€‹ æ¯”å¦‚ä¸Šé¢çš„ä»£ç ä¸­ï¼Œè¯­å¥1å’Œè¯­å¥2è°å…ˆæ‰§è¡Œå¯¹æœ€ç»ˆçš„ç¨‹åºç»“æœå¹¶æ²¡æœ‰å½±å“ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¯­å¥2å…ˆæ‰§è¡Œè€Œè¯­å¥1åæ‰§è¡Œã€‚â€‹ ä½†æ˜¯è¦æ³¨æ„ï¼Œè™½ç„¶å¤„ç†å™¨ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œä½†æ˜¯å®ƒä¼šä¿è¯ç¨‹åºæœ€ç»ˆç»“æœä¼šå’Œä»£ç é¡ºåºæ‰§è¡Œç»“æœç›¸åŒï¼Œé‚£ä¹ˆå®ƒé ä»€ä¹ˆä¿è¯çš„å‘¢ï¼Ÿâ€‹ 1234int a = 10; //è¯­å¥1int r = 2; //è¯­å¥2a = a + 3; //è¯­å¥3r = a*a; //è¯­å¥4 è¿™æ®µä»£ç æœ‰4ä¸ªè¯­å¥ï¼Œé‚£ä¹ˆå¯èƒ½çš„ä¸€ä¸ªæ‰§è¡Œé¡ºåºæ˜¯ï¼šâ€‹ é‚£ä¹ˆå¯ä¸å¯èƒ½æ˜¯è¿™ä¸ªæ‰§è¡Œé¡ºåºå‘¢ï¼š è¯­å¥2 è¯­å¥1 è¯­å¥4 è¯­å¥3â€‹ ä¸å¯èƒ½ï¼Œå› ä¸ºå¤„ç†å™¨åœ¨è¿›è¡Œé‡æ’åºæ—¶æ˜¯ä¼šè€ƒè™‘æŒ‡ä»¤ä¹‹é—´çš„æ•°æ®ä¾èµ–æ€§ï¼Œå¦‚æœä¸€ä¸ªæŒ‡ä»¤Instruction 2å¿…é¡»ç”¨åˆ°Instruction 1çš„ç»“æœï¼Œé‚£ä¹ˆå¤„ç†å™¨ä¼šä¿è¯Instruction 1ä¼šåœ¨Instruction 2ä¹‹å‰æ‰§è¡Œã€‚â€‹ è™½ç„¶é‡æ’åºä¸ä¼šå½±å“å•ä¸ªçº¿ç¨‹å†…ç¨‹åºæ‰§è¡Œçš„ç»“æœï¼Œä½†æ˜¯å¤šçº¿ç¨‹å‘¢ï¼Ÿâ€‹ 123456789//çº¿ç¨‹1:context = loadContext(); //è¯­å¥1inited = true; //è¯­å¥2 //çº¿ç¨‹2:while(!inited )&#123; sleep()&#125;doSomethingwithconfig(context); ä¸Šé¢ä»£ç ä¸­ï¼Œç”±äºè¯­å¥1å’Œè¯­å¥2æ²¡æœ‰æ•°æ®ä¾èµ–æ€§ï¼Œå› æ­¤å¯èƒ½ä¼šè¢«é‡æ’åºã€‚å‡å¦‚å‘ç”Ÿäº†é‡æ’åºï¼Œåœ¨çº¿ç¨‹1æ‰§è¡Œè¿‡ç¨‹ä¸­å…ˆæ‰§è¡Œè¯­å¥2ï¼Œè€Œæ­¤æ˜¯çº¿ç¨‹2ä¼šä»¥ä¸ºåˆå§‹åŒ–å·¥ä½œå·²ç»å®Œæˆï¼Œé‚£ä¹ˆå°±ä¼šè·³å‡ºwhileå¾ªç¯ï¼Œå»æ‰§è¡ŒdoSomethingwithconfig(context)æ–¹æ³•ï¼Œè€Œæ­¤æ—¶contextå¹¶æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºå‡ºé”™ã€‚â€‹ ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼ŒæŒ‡ä»¤é‡æ’åºä¸ä¼šå½±å“å•ä¸ªçº¿ç¨‹çš„æ‰§è¡Œï¼Œä½†æ˜¯ä¼šå½±å“åˆ°çº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚â€‹ ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦æƒ³å¹¶å‘ç¨‹åºæ­£ç¡®åœ°æ‰§è¡Œï¼Œå¿…é¡»è¦ä¿è¯åŸå­æ€§ã€å¯è§æ€§ä»¥åŠæœ‰åºæ€§ã€‚åªè¦æœ‰ä¸€ä¸ªæ²¡æœ‰è¢«ä¿è¯ï¼Œå°±æœ‰å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºè¿è¡Œä¸æ­£ç¡®ã€‚â€‹ ä¸‰ï¼ŒJavaå†…å­˜æ¨¡å‹åœ¨å‰é¢è°ˆåˆ°äº†ä¸€äº›å…³äºå†…å­˜æ¨¡å‹ä»¥åŠå¹¶å‘ç¼–ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°çš„ä¸€äº›é—®é¢˜ã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹Javaå†…å­˜æ¨¡å‹ï¼Œç ”ç©¶ä¸€ä¸‹Javaå†…å­˜æ¨¡å‹æä¾›äº†å“ªäº›ä¿è¯ä»¥åŠåœ¨javaä¸­æä¾›äº†å“ªäº›æ–¹æ³•å’Œæœºåˆ¶æ¥è®©æˆ‘ä»¬åœ¨è¿›è¡Œå¤šçº¿ç¨‹ç¼–ç¨‹æ—¶èƒ½å¤Ÿä¿è¯ç¨‹åºæ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚â€‹ åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­è¯•å›¾å®šä¹‰ä¸€ç§Javaå†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰æ¥å±è”½å„ä¸ªç¡¬ä»¶å¹³å°å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°è®©Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœã€‚é‚£ä¹ˆJavaå†…å­˜æ¨¡å‹è§„å®šäº†å“ªäº›ä¸œè¥¿å‘¢ï¼Œå®ƒå®šä¹‰äº†ç¨‹åºä¸­å˜é‡çš„è®¿é—®è§„åˆ™ï¼Œå¾€å¤§ä¸€ç‚¹è¯´æ˜¯å®šä¹‰äº†ç¨‹åºæ‰§è¡Œçš„æ¬¡åºã€‚æ³¨æ„ï¼Œä¸ºäº†è·å¾—è¾ƒå¥½çš„æ‰§è¡Œæ€§èƒ½ï¼ŒJavaå†…å­˜æ¨¡å‹å¹¶æ²¡æœ‰é™åˆ¶æ‰§è¡Œå¼•æ“ä½¿ç”¨å¤„ç†å™¨çš„å¯„å­˜å™¨æˆ–è€…é«˜é€Ÿç¼“å­˜æ¥æå‡æŒ‡ä»¤æ‰§è¡Œé€Ÿåº¦ï¼Œä¹Ÿæ²¡æœ‰é™åˆ¶ç¼–è¯‘å™¨å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨javaå†…å­˜æ¨¡å‹ä¸­ï¼Œä¹Ÿä¼šå­˜åœ¨ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜å’ŒæŒ‡ä»¤é‡æ’åºçš„é—®é¢˜ã€‚â€‹ JMM å®šä¹‰äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„æŠ½è±¡å…³ç³»ï¼šçº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼Œæœ¬åœ°å†…å­˜ä¸­å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯»/å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚â€‹ JMM çš„è§„å®šï¼š æ‰€æœ‰çš„å…±äº«å˜é‡éƒ½å­˜å‚¨äºä¸»å†…å­˜ã€‚è¿™é‡Œæ‰€è¯´çš„å˜é‡æŒ‡çš„æ˜¯å®ä¾‹å˜é‡å’Œç±»å˜é‡ï¼Œä¸åŒ…å«å±€éƒ¨å˜é‡ï¼Œå› ä¸ºå±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå› æ­¤ä¸å­˜åœ¨ç«äº‰é—®é¢˜ã€‚ æ¯ä¸€ä¸ªçº¿ç¨‹è¿˜å­˜åœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹çš„å·¥ä½œå†…å­˜ï¼Œä¿ç•™äº†è¢«çº¿ç¨‹ä½¿ç”¨çš„å˜é‡çš„å·¥ä½œå‰¯æœ¬ã€‚ çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰çš„æ“ä½œï¼ˆè¯»ï¼Œå–ï¼‰éƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­å®Œæˆï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡ã€‚ ä¸åŒçº¿ç¨‹ä¹‹é—´ä¹Ÿä¸èƒ½ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œçº¿ç¨‹é—´å˜é‡çš„å€¼çš„ä¼ é€’éœ€è¦é€šè¿‡ä¸»å†…å­˜ä¸­è½¬æ¥å®Œæˆã€‚ â€‹ 1i = 10; â€‹ æ‰§è¡Œçº¿ç¨‹å¿…é¡»å…ˆåœ¨è‡ªå·±çš„å·¥ä½œçº¿ç¨‹ä¸­å¯¹å˜é‡iæ‰€åœ¨çš„ç¼“å­˜è¡Œè¿›è¡Œèµ‹å€¼æ“ä½œï¼Œç„¶åå†å†™å…¥ä¸»å­˜å½“ä¸­ã€‚è€Œä¸æ˜¯ç›´æ¥å°†æ•°å€¼10å†™å…¥ä¸»å­˜å½“ä¸­ã€‚â€‹ é‚£ä¹ˆJavaè¯­è¨€ æœ¬èº«å¯¹ åŸå­æ€§ã€å¯è§æ€§ä»¥åŠæœ‰åºæ€§æä¾›äº†å“ªäº›ä¿è¯å‘¢ï¼Ÿâ€‹ 1.åŸå­æ€§åœ¨Javaä¸­ï¼Œå¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡çš„è¯»å–å’Œèµ‹å€¼æ“ä½œæ˜¯åŸå­æ€§æ“ä½œï¼Œå³è¿™äº›æ“ä½œæ˜¯ä¸å¯è¢«ä¸­æ–­çš„ï¼Œè¦ä¹ˆæ‰§è¡Œï¼Œè¦ä¹ˆä¸æ‰§è¡Œã€‚â€‹ 1234x = 10; //è¯­å¥1y = x; //è¯­å¥2x++; //è¯­å¥3x = x + 1; //è¯­å¥4 â€‹ åªæœ‰è¯­å¥1æ˜¯åŸå­æ€§æ“ä½œï¼Œå…¶ä»–ä¸‰ä¸ªè¯­å¥éƒ½ä¸æ˜¯åŸå­æ€§æ“ä½œã€‚â€‹ è¯­å¥1æ˜¯ç›´æ¥å°†æ•°å€¼10èµ‹å€¼ç»™xï¼Œä¹Ÿå°±æ˜¯è¯´çº¿ç¨‹æ‰§è¡Œè¿™ä¸ªè¯­å¥çš„ä¼šç›´æ¥å°†æ•°å€¼10å†™å…¥åˆ°å·¥ä½œå†…å­˜ä¸­ã€‚â€‹ è¯­å¥2å®é™…ä¸ŠåŒ…å«2ä¸ªæ“ä½œï¼Œå®ƒå…ˆè¦å»è¯»å–xçš„å€¼ï¼Œå†å°†xçš„å€¼å†™å…¥å·¥ä½œå†…å­˜ï¼Œè™½ç„¶è¯»å–xçš„å€¼ä»¥åŠ å°†xçš„å€¼å†™å…¥å·¥ä½œå†…å­˜ è¿™2ä¸ªæ“ä½œéƒ½æ˜¯åŸå­æ€§æ“ä½œï¼Œä½†æ˜¯åˆèµ·æ¥å°±ä¸æ˜¯åŸå­æ€§æ“ä½œäº†ã€‚â€‹ åŒæ ·çš„ï¼Œx++å’Œ x = x+1åŒ…æ‹¬3ä¸ªæ“ä½œï¼šè¯»å–xçš„å€¼ï¼Œè¿›è¡ŒåŠ 1æ“ä½œï¼Œå†™å…¥æ–°çš„å€¼ã€‚â€‹ æ‰€ä»¥ä¸Šé¢4ä¸ªè¯­å¥åªæœ‰è¯­å¥1çš„æ“ä½œå…·å¤‡åŸå­æ€§ã€‚â€‹ ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰ç®€å•çš„è¯»å–ã€èµ‹å€¼ï¼ˆè€Œä¸”å¿…é¡»æ˜¯å°†æ•°å­—èµ‹å€¼ç»™æŸä¸ªå˜é‡ï¼Œå˜é‡ä¹‹é—´çš„ç›¸äº’èµ‹å€¼ä¸æ˜¯åŸå­æ“ä½œï¼‰æ‰æ˜¯åŸå­æ“ä½œã€‚â€‹ ä¸è¿‡è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šåœ¨32ä½å¹³å°ä¸‹ï¼Œå¯¹64ä½æ•°æ®çš„è¯»å–å’Œèµ‹å€¼æ˜¯éœ€è¦é€šè¿‡ä¸¤ä¸ªæ“ä½œæ¥å®Œæˆçš„ï¼Œä¸èƒ½ä¿è¯å…¶åŸå­æ€§ã€‚ä½†æ˜¯å¥½åƒåœ¨æœ€æ–°çš„JDKä¸­ï¼ŒJVMå·²ç»ä¿è¯å¯¹64ä½æ•°æ®çš„è¯»å–å’Œèµ‹å€¼ä¹Ÿæ˜¯åŸå­æ€§æ“ä½œäº†ã€‚â€‹ ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼ŒJavaå†…å­˜æ¨¡å‹åªä¿è¯äº†åŸºæœ¬è¯»å–å’Œèµ‹å€¼æ˜¯åŸå­æ€§æ“ä½œï¼Œå¦‚æœè¦å®ç°æ›´å¤§èŒƒå›´æ“ä½œçš„åŸå­æ€§ï¼Œå¯ä»¥é€šè¿‡synchronizedå’ŒLockæ¥å®ç°ã€‚ç”±äºsynchronizedå’ŒLockèƒ½å¤Ÿä¿è¯ä»»ä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥ä»£ç å—ï¼Œé‚£ä¹ˆè‡ªç„¶å°±ä¸å­˜åœ¨åŸå­æ€§é—®é¢˜äº†ï¼Œä»è€Œä¿è¯äº†åŸå­æ€§ã€‚â€‹ 2.å¯è§æ€§å¯¹äºå¯è§æ€§ï¼ŒJavaæä¾›äº†volatileå…³é”®å­—æ¥ä¿è¯å¯è§æ€§ã€‚â€‹ å½“ä¸€ä¸ªå…±äº«å˜é‡è¢«volatileä¿®é¥°æ—¶ï¼Œå®ƒä¼šä¿è¯ä¿®æ”¹çš„å€¼ä¼šç«‹å³è¢«æ›´æ–°åˆ°ä¸»å­˜ï¼Œå½“æœ‰å…¶ä»–çº¿ç¨‹éœ€è¦è¯»å–æ—¶ï¼Œå®ƒä¼šå»å†…å­˜ä¸­è¯»å–æ–°å€¼ã€‚â€‹ è€Œæ™®é€šçš„å…±äº«å˜é‡ä¸èƒ½ä¿è¯å¯è§æ€§ï¼Œå› ä¸ºæ™®é€šå…±äº«å˜é‡è¢«ä¿®æ”¹ä¹‹åï¼Œä»€ä¹ˆæ—¶å€™è¢«å†™å…¥ä¸»å­˜æ˜¯ä¸ç¡®å®šçš„ï¼Œå½“å…¶ä»–çº¿ç¨‹å»è¯»å–æ—¶ï¼Œæ­¤æ—¶å†…å­˜ä¸­å¯èƒ½è¿˜æ˜¯åŸæ¥çš„æ—§å€¼ï¼Œå› æ­¤æ— æ³•ä¿è¯å¯è§æ€§ã€‚â€‹ å¦å¤–ï¼Œé€šè¿‡synchronizedå’ŒLockä¹Ÿèƒ½å¤Ÿä¿è¯å¯è§æ€§ï¼Œsynchronizedå’ŒLockèƒ½ä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”ç„¶åæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œå¹¶ä¸”åœ¨é‡Šæ”¾é”ä¹‹å‰ä¼šå°†å¯¹å˜é‡çš„ä¿®æ”¹åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚å› æ­¤å¯ä»¥ä¿è¯å¯è§æ€§ã€‚â€‹ 3.æœ‰åºæ€§åœ¨Javaå†…å­˜æ¨¡å‹ä¸­ï¼Œå…è®¸ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œä½†æ˜¯é‡æ’åºè¿‡ç¨‹ä¸ä¼šå½±å“åˆ°å•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œï¼Œå´ä¼šå½±å“åˆ°å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚ åœ¨Javaé‡Œé¢ï¼Œå¯ä»¥é€šè¿‡volatileå…³é”®å­—æ¥ä¿è¯ä¸€å®šçš„â€œæœ‰åºæ€§â€ï¼ˆå…·ä½“åŸç†åœ¨ä¸‹ä¸€èŠ‚è®²è¿°ï¼‰ã€‚å¦å¤–å¯ä»¥é€šè¿‡synchronizedå’ŒLockæ¥ä¿è¯æœ‰åºæ€§ï¼Œå¾ˆæ˜¾ç„¶ï¼Œsynchronizedå’ŒLockä¿è¯æ¯ä¸ªæ—¶åˆ»æ˜¯æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œç›¸å½“äºæ˜¯è®©çº¿ç¨‹é¡ºåºæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œè‡ªç„¶å°±ä¿è¯äº†æœ‰åºæ€§ã€‚ å¦å¤–ï¼ŒJavaå†…å­˜æ¨¡å‹å…·å¤‡ä¸€äº›å…ˆå¤©çš„â€œæœ‰åºæ€§â€ï¼Œå³ä¸éœ€è¦é€šè¿‡ä»»ä½•æ‰‹æ®µå°±èƒ½å¤Ÿå¾—åˆ°ä¿è¯çš„æœ‰åºæ€§ï¼Œè¿™ä¸ªé€šå¸¸ä¹Ÿç§°ä¸º happens-before åŸåˆ™ã€‚å¦‚æœä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œæ¬¡åºæ— æ³•ä»happens-beforeåŸåˆ™æ¨å¯¼å‡ºæ¥ï¼Œé‚£ä¹ˆå®ƒä»¬å°±ä¸èƒ½ä¿è¯å®ƒä»¬çš„æœ‰åºæ€§ï¼Œè™šæ‹Ÿæœºå¯ä»¥éšæ„åœ°å¯¹å®ƒä»¬è¿›è¡Œé‡æ’åºã€‚ ä¸‹é¢å°±æ¥å…·ä½“ä»‹ç»ä¸‹happens-beforeåŸåˆ™ï¼ˆå…ˆè¡Œå‘ç”ŸåŸåˆ™ï¼‰ï¼š ç¨‹åºæ¬¡åºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§ä»£ç é¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºä¹¦å†™åœ¨åé¢çš„æ“ä½œ é”å®šè§„åˆ™ï¼šä¸€ä¸ªunLockæ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹åŒä¸€ä¸ªé”é¢lockæ“ä½œ volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªå˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œ ä¼ é€’è§„åˆ™ï¼šå¦‚æœæ“ä½œAå…ˆè¡Œå‘ç”Ÿäºæ“ä½œBï¼Œè€Œæ“ä½œBåˆå…ˆè¡Œå‘ç”Ÿäºæ“ä½œCï¼Œåˆ™å¯ä»¥å¾—å‡ºæ“ä½œAå…ˆè¡Œå‘ç”Ÿäºæ“ä½œC çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šThreadå¯¹è±¡çš„start()æ–¹æ³•å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸ªä¸€ä¸ªåŠ¨ä½œ çº¿ç¨‹ä¸­æ–­è§„åˆ™ï¼šå¯¹çº¿ç¨‹interrupt()æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿ çº¿ç¨‹ç»ˆç»“è§„åˆ™ï¼šçº¿ç¨‹ä¸­æ‰€æœ‰çš„æ“ä½œéƒ½å…ˆè¡Œå‘ç”Ÿäºçº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Thread.join()æ–¹æ³•ç»“æŸã€Thread.isAlive()çš„è¿”å›å€¼æ‰‹æ®µæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œ å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆå…ˆè¡Œå‘ç”Ÿäºä»–çš„finalize()æ–¹æ³•çš„å¼€å§‹ è¿™8æ¡åŸåˆ™æ‘˜è‡ªã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ã€‚ å¯¹äºç¨‹åºæ¬¡åºè§„åˆ™æ¥è¯´ï¼Œæˆ‘çš„ç†è§£å°±æ˜¯ä¸€æ®µç¨‹åºä»£ç çš„æ‰§è¡Œåœ¨å•ä¸ªçº¿ç¨‹ä¸­çœ‹èµ·æ¥æ˜¯æœ‰åºçš„ã€‚æ³¨æ„ï¼Œè™½ç„¶è¿™æ¡è§„åˆ™ä¸­æåˆ°â€œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºä¹¦å†™åœ¨åé¢çš„æ“ä½œâ€ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯ç¨‹åºçœ‹èµ·æ¥æ‰§è¡Œçš„é¡ºåºæ˜¯æŒ‰ç…§ä»£ç é¡ºåºæ‰§è¡Œçš„ï¼Œå› ä¸ºè™šæ‹Ÿæœºå¯èƒ½ä¼šå¯¹ç¨‹åºä»£ç è¿›è¡ŒæŒ‡ä»¤é‡æ’åºã€‚è™½ç„¶è¿›è¡Œé‡æ’åºï¼Œä½†æ˜¯æœ€ç»ˆæ‰§è¡Œçš„ç»“æœæ˜¯ä¸ç¨‹åºé¡ºåºæ‰§è¡Œçš„ç»“æœä¸€è‡´çš„ï¼Œå®ƒåªä¼šå¯¹ä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§çš„æŒ‡ä»¤è¿›è¡Œé‡æ’åºã€‚å› æ­¤ï¼Œåœ¨å•ä¸ªçº¿ç¨‹ä¸­ï¼Œç¨‹åºæ‰§è¡Œçœ‹èµ·æ¥æ˜¯æœ‰åºæ‰§è¡Œçš„ï¼Œè¿™ä¸€ç‚¹è¦æ³¨æ„ç†è§£ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªè§„åˆ™æ˜¯ç”¨æ¥ä¿è¯ç¨‹åºåœ¨å•çº¿ç¨‹ä¸­æ‰§è¡Œç»“æœçš„æ­£ç¡®æ€§ï¼Œä½†æ— æ³•ä¿è¯ç¨‹åºåœ¨å¤šçº¿ç¨‹ä¸­æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚â€‹ ç¬¬äºŒæ¡è§„åˆ™ä¹Ÿæ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä¹Ÿå°±æ˜¯è¯´æ— è®ºåœ¨å•çº¿ç¨‹ä¸­è¿˜æ˜¯å¤šçº¿ç¨‹ä¸­ï¼ŒåŒä¸€ä¸ªé”å¦‚æœå‡ºäºè¢«é”å®šçš„çŠ¶æ€ï¼Œé‚£ä¹ˆå¿…é¡»å…ˆå¯¹é”è¿›è¡Œäº†é‡Šæ”¾æ“ä½œï¼Œåé¢æ‰èƒ½ç»§ç»­è¿›è¡Œlockæ“ä½œã€‚â€‹ ç¬¬ä¸‰æ¡è§„åˆ™æ˜¯ä¸€æ¡æ¯”è¾ƒé‡è¦çš„è§„åˆ™ï¼Œä¹Ÿæ˜¯åæ–‡å°†è¦é‡ç‚¹è®²è¿°çš„å†…å®¹ã€‚ç›´è§‚åœ°è§£é‡Šå°±æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹å…ˆå»å†™ä¸€ä¸ªå˜é‡ï¼Œç„¶åä¸€ä¸ªçº¿ç¨‹å»è¿›è¡Œè¯»å–ï¼Œé‚£ä¹ˆå†™å…¥æ“ä½œè‚¯å®šä¼šå…ˆè¡Œå‘ç”Ÿäºè¯»æ“ä½œã€‚â€‹ ç¬¬å››æ¡è§„åˆ™å®é™…ä¸Šå°±æ˜¯ä½“ç°happens-beforeåŸåˆ™å…·å¤‡ä¼ é€’æ€§ã€‚â€‹ å4æ¡è§„åˆ™éƒ½æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚â€‹ å››ï¼Œæ·±å…¥ç†è§£volatileå…³é”®å­—1.volatileå…³é”®çš„ä¸¤å±‚è¯­ä¹‰ä¸€æ—¦ä¸€ä¸ªå…±äº«å˜é‡ï¼ˆç±»çš„æˆå‘˜å˜é‡ã€ç±»çš„é™æ€æˆå‘˜å˜é‡ï¼‰è¢«volatileä¿®é¥°ä¹‹åï¼Œé‚£ä¹ˆå°±å…·å¤‡äº†ä¸¤å±‚è¯­ä¹‰ï¼š ä¿è¯äº†ä¸åŒçº¿ç¨‹å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œæ“ä½œæ—¶çš„å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œè¿™æ–°å€¼å¯¹å…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯ç«‹å³å¯è§çš„ã€‚ ç¦æ­¢è¿›è¡ŒæŒ‡ä»¤é‡æ’åºã€‚ çœ‹ä¸€æ®µä»£ç ï¼Œå‡å¦‚çº¿ç¨‹1å…ˆæ‰§è¡Œï¼Œçº¿ç¨‹2åæ‰§è¡Œï¼šâ€‹ 12345678//çº¿ç¨‹1boolean stop = false;while(!stop)&#123; doSomething();&#125; //çº¿ç¨‹2stop = true; â€‹ è¿™æ®µä»£ç æ˜¯å¾ˆå…¸å‹çš„ä¸€æ®µä»£ç ï¼Œå¾ˆå¤šäººåœ¨ä¸­æ–­çº¿ç¨‹æ—¶å¯èƒ½éƒ½ä¼šé‡‡ç”¨è¿™ç§æ ‡è®°åŠæ³•ã€‚ä½†æ˜¯äº‹å®ä¸Šï¼Œè¿™æ®µä»£ç ä¼šå®Œå…¨è¿è¡Œæ­£ç¡®ä¹ˆï¼Ÿå³ä¸€å®šä¼šå°†çº¿ç¨‹ä¸­æ–­ä¹ˆï¼Ÿä¸ä¸€å®šï¼Œä¹Ÿè®¸åœ¨å¤§å¤šæ•°æ—¶å€™ï¼Œè¿™ä¸ªä»£ç èƒ½å¤ŸæŠŠçº¿ç¨‹ä¸­æ–­ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¯èƒ½ä¼šå¯¼è‡´æ— æ³•ä¸­æ–­çº¿ç¨‹ï¼ˆè™½ç„¶è¿™ä¸ªå¯èƒ½æ€§å¾ˆå°ï¼Œä½†æ˜¯åªè¦ä¸€æ—¦å‘ç”Ÿè¿™ç§æƒ…å†µå°±ä¼šé€ æˆæ­»å¾ªç¯äº†ï¼‰ã€‚ ä¸‹é¢è§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç ä¸ºä½•æœ‰å¯èƒ½å¯¼è‡´æ— æ³•ä¸­æ–­çº¿ç¨‹ã€‚åœ¨å‰é¢å·²ç»è§£é‡Šè¿‡ï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œé‚£ä¹ˆçº¿ç¨‹1åœ¨è¿è¡Œçš„æ—¶å€™ï¼Œä¼šå°†stopå˜é‡çš„å€¼æ‹·è´ä¸€ä»½æ”¾åœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜å½“ä¸­ã€‚ é‚£ä¹ˆå½“çº¿ç¨‹2æ›´æ”¹äº†stopå˜é‡çš„å€¼ä¹‹åï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠå†™å…¥ä¸»å­˜å½“ä¸­ï¼Œçº¿ç¨‹2è½¬å»åšå…¶ä»–äº‹æƒ…äº†ï¼Œé‚£ä¹ˆçº¿ç¨‹1ç”±äºä¸çŸ¥é“çº¿ç¨‹2å¯¹stopå˜é‡çš„æ›´æ”¹ï¼Œå› æ­¤è¿˜ä¼šä¸€ç›´å¾ªç¯ä¸‹å»ã€‚ ä½†æ˜¯ç”¨volatileä¿®é¥°ä¹‹åå°±å˜å¾—ä¸ä¸€æ ·äº†ï¼š ä½¿ç”¨volatileå…³é”®å­—ä¼šå¼ºåˆ¶å°†ä¿®æ”¹çš„å€¼ç«‹å³å†™å…¥ä¸»å­˜ï¼› ä½¿ç”¨volatileå…³é”®å­—çš„è¯ï¼Œå½“çº¿ç¨‹2è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¼šå¯¼è‡´çº¿ç¨‹1çš„å·¥ä½œå†…å­˜ä¸­ç¼“å­˜å˜é‡stopçš„ç¼“å­˜è¡Œæ— æ•ˆï¼ˆåæ˜ åˆ°ç¡¬ä»¶å±‚çš„è¯ï¼Œå°±æ˜¯CPUçš„L1æˆ–è€…L2ç¼“å­˜ä¸­å¯¹åº”çš„ç¼“å­˜è¡Œæ— æ•ˆï¼‰ï¼› ç”±äºçº¿ç¨‹1çš„å·¥ä½œå†…å­˜ä¸­ç¼“å­˜å˜é‡stopçš„ç¼“å­˜è¡Œæ— æ•ˆï¼Œæ‰€ä»¥çº¿ç¨‹1å†æ¬¡è¯»å–å˜é‡stopçš„å€¼æ—¶ä¼šå»ä¸»å­˜è¯»å–ã€‚ é‚£ä¹ˆåœ¨çº¿ç¨‹2ä¿®æ”¹stopå€¼æ—¶ï¼ˆå½“ç„¶è¿™é‡ŒåŒ…æ‹¬2ä¸ªæ“ä½œï¼Œä¿®æ”¹çº¿ç¨‹2å·¥ä½œå†…å­˜ä¸­çš„å€¼ï¼Œç„¶åå°†ä¿®æ”¹åçš„å€¼å†™å…¥å†…å­˜ï¼‰ï¼Œä¼šä½¿å¾—çº¿ç¨‹1çš„å·¥ä½œå†…å­˜ä¸­ç¼“å­˜å˜é‡stopçš„ç¼“å­˜è¡Œæ— æ•ˆï¼Œç„¶åçº¿ç¨‹1è¯»å–æ—¶ï¼Œå‘ç°è‡ªå·±çš„ç¼“å­˜è¡Œæ— æ•ˆï¼Œå®ƒä¼šç­‰å¾…ç¼“å­˜è¡Œå¯¹åº”çš„ä¸»å­˜åœ°å€è¢«æ›´æ–°ä¹‹åï¼Œç„¶åå»å¯¹åº”çš„ä¸»å­˜è¯»å–æœ€æ–°çš„å€¼ã€‚ é‚£ä¹ˆçº¿ç¨‹1è¯»å–åˆ°çš„å°±æ˜¯æœ€æ–°çš„æ­£ç¡®çš„å€¼ã€‚â€‹ 2.volatileä¸ä¿è¯åŸå­æ€§ä»ä¸Šé¢çŸ¥é“volatileå…³é”®å­—ä¿è¯äº†æ“ä½œçš„å¯è§æ€§ï¼Œä½†æ˜¯volatileèƒ½ä¿è¯å¯¹å˜é‡çš„æ“ä½œæ˜¯åŸå­æ€§å—ï¼Ÿâ€‹ 12345678910111213141516171819202122232425public class Test &#123; public volatile int inc = 0; public void increase() &#123; inc++; &#125; public static void main(String[] args) &#123; final Test test = new Test(); for (int i = 0; i &lt; 10; i++) &#123; new Thread() &#123; public void run() &#123; for (int j = 0; j &lt; 1000; j++) test.increase(); &#125; ; &#125;.start(); &#125; while (Thread.activeCount() &gt; 1) //ä¿è¯å‰é¢çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œ Thread.yield(); System.out.println(test.inc); &#125;&#125; è¿™æ®µç¨‹åºçš„è¾“å‡ºç»“æœæ˜¯å¤šå°‘ï¼Ÿäº‹å®ä¸Šè¿è¡Œå®ƒä¼šå‘ç°æ¯æ¬¡è¿è¡Œç»“æœéƒ½ä¸ä¸€è‡´ï¼Œéƒ½æ˜¯ä¸€ä¸ªå°äº10000çš„æ•°å­—ã€‚ å¯èƒ½æœ‰ç–‘é—®ï¼Œä¸å¯¹å•Šï¼Œä¸Šé¢æ˜¯å¯¹å˜é‡incè¿›è¡Œè‡ªå¢æ“ä½œï¼Œç”±äºvolatileä¿è¯äº†å¯è§æ€§ï¼Œé‚£ä¹ˆåœ¨æ¯ä¸ªçº¿ç¨‹ä¸­å¯¹incè‡ªå¢å®Œä¹‹åï¼Œåœ¨å…¶ä»–çº¿ç¨‹ä¸­éƒ½èƒ½çœ‹åˆ°ä¿®æ”¹åçš„å€¼å•Šï¼Œæ‰€ä»¥æœ‰10ä¸ªçº¿ç¨‹åˆ†åˆ«è¿›è¡Œäº†1000æ¬¡æ“ä½œï¼Œé‚£ä¹ˆæœ€ç»ˆincçš„å€¼åº”è¯¥æ˜¯1000*10=10000ã€‚ è¿™é‡Œé¢å°±æœ‰ä¸€ä¸ªè¯¯åŒºäº†ï¼Œvolatileå…³é”®å­—èƒ½ä¿è¯å¯è§æ€§æ²¡æœ‰é”™ï¼Œä½†æ˜¯ä¸Šé¢çš„ç¨‹åºé”™åœ¨æ²¡èƒ½ä¿è¯åŸå­æ€§ã€‚å¯è§æ€§åªèƒ½ä¿è¯æ¯æ¬¡è¯»å–çš„æ˜¯æœ€æ–°çš„å€¼ï¼Œä½†æ˜¯volatileæ²¡åŠæ³•ä¿è¯å¯¹å˜é‡çš„æ“ä½œçš„åŸå­æ€§ã€‚ åœ¨å‰é¢å·²ç»æåˆ°è¿‡ï¼Œè‡ªå¢æ“ä½œæ˜¯ä¸å…·å¤‡åŸå­æ€§çš„ï¼Œå®ƒåŒ…æ‹¬è¯»å–å˜é‡çš„åŸå§‹å€¼ã€è¿›è¡ŒåŠ 1æ“ä½œã€å†™å…¥å·¥ä½œå†…å­˜ã€‚é‚£ä¹ˆå°±æ˜¯è¯´è‡ªå¢æ“ä½œçš„ä¸‰ä¸ªå­æ“ä½œå¯èƒ½ä¼šåˆ†å‰²å¼€æ‰§è¡Œï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´ä¸‹é¢è¿™ç§æƒ…å†µå‡ºç°ï¼š å‡å¦‚æŸä¸ªæ—¶åˆ»å˜é‡incçš„å€¼ä¸º10ï¼Œ çº¿ç¨‹1å¯¹å˜é‡è¿›è¡Œè‡ªå¢æ“ä½œï¼Œçº¿ç¨‹1å…ˆè¯»å–äº†å˜é‡incçš„åŸå§‹å€¼ï¼Œç„¶åçº¿ç¨‹1è¢«é˜»å¡äº†ï¼› ç„¶åçº¿ç¨‹2å¯¹å˜é‡è¿›è¡Œè‡ªå¢æ“ä½œï¼Œçº¿ç¨‹2ä¹Ÿå»è¯»å–å˜é‡incçš„åŸå§‹å€¼ï¼Œç”±äºçº¿ç¨‹1åªæ˜¯å¯¹å˜é‡incè¿›è¡Œè¯»å–æ“ä½œï¼Œè€Œæ²¡æœ‰å¯¹å˜é‡è¿›è¡Œä¿®æ”¹æ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šå¯¼è‡´çº¿ç¨‹2çš„å·¥ä½œå†…å­˜ä¸­ç¼“å­˜å˜é‡incçš„ç¼“å­˜è¡Œæ— æ•ˆï¼Œæ‰€ä»¥çº¿ç¨‹2ä¼šç›´æ¥å»ä¸»å­˜è¯»å–incçš„å€¼ï¼Œå‘ç°incçš„å€¼æ—¶10ï¼Œç„¶åè¿›è¡ŒåŠ 1æ“ä½œï¼Œå¹¶æŠŠ11å†™å…¥å·¥ä½œå†…å­˜ï¼Œæœ€åå†™å…¥ä¸»å­˜ã€‚ ç„¶åçº¿ç¨‹1æ¥ç€è¿›è¡ŒåŠ 1æ“ä½œï¼Œç”±äºå·²ç»è¯»å–äº†incçš„å€¼ï¼Œæ³¨æ„æ­¤æ—¶åœ¨çº¿ç¨‹1çš„å·¥ä½œå†…å­˜ä¸­incçš„å€¼ä»ç„¶ä¸º10ï¼Œæ‰€ä»¥çº¿ç¨‹1å¯¹incè¿›è¡ŒåŠ 1æ“ä½œåincçš„å€¼ä¸º11ï¼Œç„¶åå°†11å†™å…¥å·¥ä½œå†…å­˜ï¼Œæœ€åå†™å…¥ä¸»å­˜ã€‚ é‚£ä¹ˆä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è¿›è¡Œäº†ä¸€æ¬¡è‡ªå¢æ“ä½œåï¼Œincåªå¢åŠ äº†1ã€‚ è™½ç„¶ä¸€ä¸ªå˜é‡åœ¨ä¿®æ”¹volatileå˜é‡æ—¶ï¼Œä¼šè®©ç¼“å­˜è¡Œæ— æ•ˆï¼Œç„¶åå…¶ä»–çº¿ç¨‹å»è¯»å°±ä¼šè¯»åˆ°æ–°çš„å€¼ã€‚è¿™ä¸ªå°±æ˜¯ä¸Šé¢çš„happens-beforeè§„åˆ™ä¸­çš„volatileå˜é‡è§„åˆ™ï¼Œä½†æ˜¯è¦æ³¨æ„ï¼Œçº¿ç¨‹1å¯¹å˜é‡è¿›è¡Œè¯»å–æ“ä½œä¹‹åï¼Œè¢«é˜»å¡äº†çš„è¯ï¼Œå¹¶æ²¡æœ‰å¯¹incå€¼è¿›è¡Œä¿®æ”¹ã€‚ç„¶åè™½ç„¶volatileèƒ½ä¿è¯çº¿ç¨‹2å¯¹å˜é‡incçš„å€¼è¯»å–æ˜¯ä»å†…å­˜ä¸­è¯»å–çš„ï¼Œä½†æ˜¯çº¿ç¨‹1æ²¡æœ‰è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥çº¿ç¨‹2æ ¹æœ¬å°±ä¸ä¼šçœ‹åˆ°ä¿®æ”¹çš„å€¼ã€‚ æ ¹æºå°±åœ¨è¿™é‡Œï¼Œè‡ªå¢æ“ä½œä¸æ˜¯åŸå­æ€§æ“ä½œï¼Œè€Œä¸”volatileä¹Ÿæ— æ³•ä¿è¯å¯¹å˜é‡çš„ä»»ä½•æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ã€‚ æŠŠä¸Šé¢çš„ä»£ç æ”¹æ”¹å°±å¯ä»¥ã€‚â€‹ é‡‡ç”¨synchronizedï¼šâ€‹ 1234567891011121314151617181920212223public class Test &#123; public int inc = 0; public synchronized void increase() &#123; inc++; &#125; public static void main(String[] args) &#123; final Test test = new Test(); for(int i=0;i&lt;10;i++)&#123; new Thread()&#123; public void run() &#123; for(int j=0;j&lt;1000;j++) test.increase(); &#125;; &#125;.start(); &#125; while(Thread.activeCount()&gt;1) //ä¿è¯å‰é¢çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œ Thread.yield(); System.out.println(test.inc); &#125;&#125; é‡‡ç”¨Lockï¼šâ€‹ 1234567891011121314151617181920212223242526272829public class Test &#123; public int inc = 0; Lock lock = new ReentrantLock(); public void increase() &#123; lock.lock(); try &#123; inc++; &#125; finally&#123; lock.unlock(); &#125; &#125; public static void main(String[] args) &#123; final Test test = new Test(); for(int i=0;i&lt;10;i++)&#123; new Thread()&#123; public void run() &#123; for(int j=0;j&lt;1000;j++) test.increase(); &#125;; &#125;.start(); &#125; while(Thread.activeCount()&gt;1) //ä¿è¯å‰é¢çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œ Thread.yield(); System.out.println(test.inc); &#125;&#125; é‡‡ç”¨AtomicIntegerï¼šâ€‹ 1234567891011121314151617181920212223public class Test &#123; public AtomicInteger inc = new AtomicInteger(); public void increase() &#123; inc.getAndIncrement(); &#125; public static void main(String[] args) &#123; final Test test = new Test(); for(int i=0;i&lt;10;i++)&#123; new Thread()&#123; public void run() &#123; for(int j=0;j&lt;1000;j++) test.increase(); &#125;; &#125;.start(); &#125; while(Thread.activeCount()&gt;1) //ä¿è¯å‰é¢çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œ Thread.yield(); System.out.println(test.inc); &#125;&#125; â€‹ åœ¨java 1.5çš„java.util.concurrent.atomicåŒ…ä¸‹æä¾›äº†ä¸€äº›åŸå­æ“ä½œç±»ï¼Œå³å¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„ è‡ªå¢ï¼ˆåŠ 1æ“ä½œï¼‰ï¼Œè‡ªå‡ï¼ˆå‡1æ“ä½œï¼‰ã€ä»¥åŠåŠ æ³•æ“ä½œï¼ˆåŠ ä¸€ä¸ªæ•°ï¼‰ï¼Œå‡æ³•æ“ä½œï¼ˆå‡ä¸€ä¸ªæ•°ï¼‰è¿›è¡Œäº†å°è£…ï¼Œä¿è¯è¿™äº›æ“ä½œæ˜¯åŸå­æ€§æ“ä½œã€‚atomicæ˜¯åˆ©ç”¨CASæ¥å®ç°åŸå­æ€§æ“ä½œçš„ï¼ˆCompare And Swapï¼‰ï¼ŒCASå®é™…ä¸Šæ˜¯åˆ©ç”¨å¤„ç†å™¨æä¾›çš„CMPXCHGæŒ‡ä»¤å®ç°çš„ï¼Œè€Œå¤„ç†å™¨æ‰§è¡ŒCMPXCHGæŒ‡ä»¤æ˜¯ä¸€ä¸ªåŸå­æ€§æ“ä½œã€‚â€‹ 3.volatileä¿è¯æœ‰åºæ€§åœ¨å‰é¢æåˆ°volatileå…³é”®å­—èƒ½ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Œæ‰€ä»¥volatileèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¿è¯æœ‰åºæ€§ã€‚ volatileå…³é”®å­—ç¦æ­¢æŒ‡ä»¤é‡æ’åºæœ‰ä¸¤å±‚æ„æ€ï¼š å½“ç¨‹åºæ‰§è¡Œåˆ°volatileå˜é‡çš„è¯»æ“ä½œæˆ–è€…å†™æ“ä½œæ—¶ï¼Œåœ¨å…¶å‰é¢çš„æ“ä½œçš„æ›´æ”¹è‚¯å®šå…¨éƒ¨å·²ç»è¿›è¡Œï¼Œä¸”ç»“æœå·²ç»å¯¹åé¢çš„æ“ä½œå¯è§ï¼›åœ¨å…¶åé¢çš„æ“ä½œè‚¯å®šè¿˜æ²¡æœ‰è¿›è¡Œï¼› åœ¨è¿›è¡ŒæŒ‡ä»¤ä¼˜åŒ–æ—¶ï¼Œä¸èƒ½å°†åœ¨å¯¹volatileå˜é‡è®¿é—®çš„è¯­å¥æ”¾åœ¨å…¶åé¢æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½æŠŠvolatileå˜é‡åé¢çš„è¯­å¥æ”¾åˆ°å…¶å‰é¢æ‰§è¡Œã€‚ 12345678//xã€yä¸ºévolatileå˜é‡//flagä¸ºvolatileå˜é‡ x = 2; //è¯­å¥1y = 0; //è¯­å¥2flag = true; //è¯­å¥3x = 4; //è¯­å¥4y = -1; //è¯­å¥5 ç”±äºflagå˜é‡ä¸ºvolatileå˜é‡ï¼Œé‚£ä¹ˆåœ¨è¿›è¡ŒæŒ‡ä»¤é‡æ’åºçš„è¿‡ç¨‹çš„æ—¶å€™ï¼Œä¸ä¼šå°†è¯­å¥3æ”¾åˆ°è¯­å¥1ã€è¯­å¥2å‰é¢ï¼Œä¹Ÿä¸ä¼šè®²è¯­å¥3æ”¾åˆ°è¯­å¥4ã€è¯­å¥5åé¢ã€‚ä½†æ˜¯è¦æ³¨æ„è¯­å¥1å’Œè¯­å¥2çš„é¡ºåºã€è¯­å¥4å’Œè¯­å¥5çš„é¡ºåºæ˜¯ä¸ä½œä»»ä½•ä¿è¯çš„ã€‚â€‹ å¹¶ä¸”volatileå…³é”®å­—èƒ½ä¿è¯ï¼Œæ‰§è¡Œåˆ°è¯­å¥3æ—¶ï¼Œè¯­å¥1å’Œè¯­å¥2å¿…å®šæ˜¯æ‰§è¡Œå®Œæ¯•äº†çš„ï¼Œä¸”è¯­å¥1å’Œè¯­å¥2çš„æ‰§è¡Œç»“æœå¯¹è¯­å¥3ã€è¯­å¥4ã€è¯­å¥5æ˜¯å¯è§çš„ã€‚â€‹ å›åˆ°å‰é¢ä¸¾çš„ä¸€ä¸ªä¾‹å­ï¼šâ€‹ 123456789//çº¿ç¨‹1:context = loadContext(); //è¯­å¥1inited = true; //è¯­å¥2 //çº¿ç¨‹2:while(!inited )&#123; sleep()&#125;doSomethingwithconfig(context); â€‹ å‰é¢ä¸¾è¿™ä¸ªä¾‹å­çš„æ—¶å€™ï¼Œæåˆ°æœ‰å¯èƒ½è¯­å¥2ä¼šåœ¨è¯­å¥1ä¹‹å‰æ‰§è¡Œï¼Œé‚£ä¹ˆä¹…å¯èƒ½å¯¼è‡´contextè¿˜æ²¡è¢«åˆå§‹åŒ–ï¼Œè€Œçº¿ç¨‹2ä¸­å°±ä½¿ç”¨æœªåˆå§‹åŒ–çš„contextå»è¿›è¡Œæ“ä½œï¼Œå¯¼è‡´ç¨‹åºå‡ºé”™ã€‚â€‹ è¿™é‡Œå¦‚æœç”¨volatileå…³é”®å­—å¯¹initedå˜é‡è¿›è¡Œä¿®é¥°ï¼Œå°±ä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜äº†ï¼Œå› ä¸ºå½“æ‰§è¡Œåˆ°è¯­å¥2æ—¶ï¼Œå¿…å®šèƒ½ä¿è¯contextå·²ç»åˆå§‹åŒ–å®Œæ¯•ã€‚â€‹ 4.volatileçš„åŸç†å’Œå®ç°æœºåˆ¶volatileåˆ°åº•å¦‚ä½•ä¿è¯å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„ï¼Ÿâ€‹ ä¸‹é¢è¿™æ®µè¯æ‘˜è‡ªã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ï¼šâ€‹ è§‚å¯ŸåŠ å…¥volatileå…³é”®å­—å’Œæ²¡æœ‰åŠ å…¥volatileå…³é”®å­—æ—¶æ‰€ç”Ÿæˆçš„æ±‡ç¼–ä»£ç å‘ç°ï¼ŒåŠ å…¥volatileå…³é”®å­—æ—¶ï¼Œä¼šå¤šå‡ºä¸€ä¸ªlockå‰ç¼€æŒ‡ä»¤â€‹ lockå‰ç¼€æŒ‡ä»¤å®é™…ä¸Šç›¸å½“äºä¸€ä¸ªå†…å­˜å±éšœï¼ˆä¹Ÿæˆå†…å­˜æ …æ ï¼‰ï¼Œå†…å­˜å±éšœä¼šæä¾›3ä¸ªåŠŸèƒ½ï¼šâ€‹ å®ƒç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ä¸ä¼šæŠŠå…¶åé¢çš„æŒ‡ä»¤æ’åˆ°å†…å­˜å±éšœä¹‹å‰çš„ä½ç½®ï¼Œä¹Ÿä¸ä¼šæŠŠå‰é¢çš„æŒ‡ä»¤æ’åˆ°å†…å­˜å±éšœçš„åé¢ï¼›å³åœ¨æ‰§è¡Œåˆ°å†…å­˜å±éšœè¿™å¥æŒ‡ä»¤æ—¶ï¼Œåœ¨å®ƒå‰é¢çš„æ“ä½œå·²ç»å…¨éƒ¨å®Œæˆï¼› å®ƒä¼šå¼ºåˆ¶å°†å¯¹ç¼“å­˜çš„ä¿®æ”¹æ“ä½œç«‹å³å†™å…¥ä¸»å­˜ï¼› å¦‚æœæ˜¯å†™æ“ä½œï¼Œå®ƒä¼šå¯¼è‡´å…¶ä»–CPUä¸­å¯¹åº”çš„ç¼“å­˜è¡Œæ— æ•ˆã€‚ â€‹ 5.ç¦æ­¢æŒ‡ä»¤é‡æ’åºä»€ä¹ˆæ˜¯é‡æ’åºï¼Ÿâ€‹ ä¸ºäº†æé«˜æ€§èƒ½ï¼Œåœ¨éµå®ˆ as-if-serial è¯­ä¹‰ï¼ˆå³ä¸ç®¡æ€ä¹ˆé‡æ’åºï¼Œå•çº¿ç¨‹ä¸‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜ã€‚ç¼–è¯‘å™¨ï¼Œruntime å’Œå¤„ç†å™¨éƒ½å¿…é¡»éµå®ˆã€‚ï¼‰çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºã€‚â€‹ ä¸€èˆ¬é‡æ’åºå¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§ç±»å‹ï¼šâ€‹ ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’åºã€‚ç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œå¯ä»¥é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚ æŒ‡ä»¤çº§å¹¶è¡Œé‡æ’åºã€‚ç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚ å†…å­˜ç³»ç»Ÿé‡æ’åºã€‚ç”±äºå¤„ç†å™¨ä½¿ç”¨ç¼“å­˜å’Œè¯» / å†™ç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯åœ¨ä¹±åºæ‰§è¡Œã€‚ æ•°æ®ä¾èµ–æ€§ï¼šå¦‚æœä¸¤ä¸ªæ“ä½œè®¿é—®åŒä¸€ä¸ªå˜é‡ï¼Œä¸”è¿™ä¸¤ä¸ªæ“ä½œä¸­æœ‰ä¸€ä¸ªä¸ºå†™æ“ä½œï¼Œæ­¤æ—¶è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å°±å­˜åœ¨æ•°æ®ä¾èµ–æ€§ã€‚è¿™é‡Œæ‰€è¯´çš„æ•°æ®ä¾èµ–æ€§ä»…é’ˆå¯¹å•ä¸ªå¤„ç†å™¨ä¸­æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—å’Œå•ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„æ“ä½œï¼Œä¸åŒå¤„ç†å™¨ä¹‹é—´å’Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ä¾èµ–æ€§ä¸è¢«ç¼–è¯‘å™¨å’Œå¤„ç†å™¨è€ƒè™‘ã€‚ ä» Java æºä»£ç åˆ°æœ€ç»ˆæ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ï¼Œä¼šåˆ†åˆ«ç»å†ä¸‹é¢ä¸‰ç§é‡æ’åºï¼š ä¸ºäº†æ›´å¥½åœ°ç†è§£é‡æ’åºï¼Œè¯·çœ‹ä¸‹é¢çš„éƒ¨åˆ†ç¤ºä¾‹ä»£ç ï¼š 123456789int a = 0;// çº¿ç¨‹ Aa = 1; // 1flag = true; // 2// çº¿ç¨‹ Bif (flag) &#123; // 3 int i = a; // 4&#125; â€‹ å•çœ‹ä¸Šé¢çš„ç¨‹åºå¥½åƒæ²¡æœ‰é—®é¢˜ï¼Œæœ€å i çš„å€¼æ˜¯ 1ã€‚ä½†æ˜¯ä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šåœ¨ä¸æ”¹å˜æ•°æ®ä¾èµ–çš„æƒ…å†µä¸‹å¯¹æŒ‡ä»¤åšé‡æ’åºã€‚å‡è®¾çº¿ç¨‹ A åœ¨æ‰§è¡Œæ—¶è¢«é‡æ’åºæˆå…ˆæ‰§è¡Œä»£ç  2ï¼Œå†æ‰§è¡Œä»£ç  1ï¼›è€Œçº¿ç¨‹ B åœ¨çº¿ç¨‹ A æ‰§è¡Œå®Œä»£ç  2 åï¼Œè¯»å–äº† flag å˜é‡ã€‚ç”±äºæ¡ä»¶åˆ¤æ–­ä¸ºçœŸï¼Œçº¿ç¨‹ B å°†è¯»å–å˜é‡ aã€‚æ­¤æ—¶ï¼Œå˜é‡ a è¿˜æ ¹æœ¬æ²¡æœ‰è¢«çº¿ç¨‹ A å†™å…¥ï¼Œé‚£ä¹ˆ i æœ€åçš„å€¼æ˜¯ 0ï¼Œå¯¼è‡´æ‰§è¡Œç»“æœä¸æ­£ç¡®ã€‚é‚£ä¹ˆå¦‚ä½•ç¨‹åºæ‰§è¡Œç»“æœæ­£ç¡®å‘¢ï¼Ÿè¿™é‡Œä»ç„¶å¯ä»¥ä½¿ç”¨ volatile å…³é”®å­—ã€‚â€‹ è¿™ä¸ªä¾‹å­ä¸­ï¼Œ ä½¿ç”¨ volatile ä¸ä»…ä¿è¯äº†å˜é‡çš„å†…å­˜å¯è§æ€§ï¼Œè¿˜ç¦æ­¢äº†æŒ‡ä»¤çš„é‡æ’åºï¼Œå³ä¿è¯äº† volatile ä¿®é¥°çš„å˜é‡ç¼–è¯‘åçš„é¡ºåºä¸ç¨‹åºçš„æ‰§è¡Œé¡ºåºä¸€æ ·ã€‚é‚£ä¹ˆä½¿ç”¨ volatile ä¿®é¥° flag å˜é‡åï¼Œåœ¨çº¿ç¨‹ A ä¸­ï¼Œä¿è¯äº†ä»£ç  1 çš„æ‰§è¡Œé¡ºåºä¸€å®šåœ¨ä»£ç  2 ä¹‹å‰ã€‚â€‹ é‚£ä¹ˆï¼Œ volatile æ˜¯å¦‚ä½•ç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„å‘¢ï¼Ÿè¿™é‡Œå°†å¼•å‡ºä¸€ä¸ªæ¦‚å¿µï¼šå†…å­˜å±éšœæŒ‡ä»¤â€‹ å†…å­˜å±éšœæŒ‡ä»¤â€‹ ä¸ºäº†å®ç° volatile å†…å­˜è¯­ä¹‰ï¼ˆå³å†…å­˜å¯è§æ€§ï¼‰ï¼ŒJMM ä¼šé™åˆ¶ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºã€‚ä¸ºæ­¤ï¼ŒJMM é’ˆå¯¹ç¼–è¯‘å™¨åˆ¶å®šäº† volatile é‡æ’åºè§„åˆ™è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼šâ€‹ â€‹ ä½¿ç”¨ volatile ä¿®é¥°å˜é‡æ—¶ï¼Œæ ¹æ® volatile é‡æ’åºè§„åˆ™è¡¨ï¼ŒJava ç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­æ’å…¥å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚â€‹ å†…å­˜å±éšœæ˜¯ä¸€ç»„å¤„ç†å™¨æŒ‡ä»¤ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç¦æ­¢æŒ‡ä»¤é‡æ’åºå’Œè§£å†³å†…å­˜å¯è§æ€§çš„é—®é¢˜ã€‚â€‹ JMM æŠŠå†…å­˜å±éšœæŒ‡ä»¤åˆ†ä¸ºä¸‹åˆ—å››ç±»ï¼šâ€‹ â€‹ StoreLoad å±éšœæ˜¯ä¸€ä¸ªå…¨èƒ½å‹çš„å±éšœï¼Œå®ƒåŒæ—¶å…·æœ‰å…¶ä»–ä¸‰ä¸ªå±éšœçš„æ•ˆæœã€‚æ‰€ä»¥æ‰§è¡Œè¯¥å±éšœå¼€é”€ä¼šå¾ˆå¤§ï¼Œå› ä¸ºå®ƒä½¿å¤„ç†å™¨è¦æŠŠç¼“å­˜ä¸­çš„æ•°æ®å…¨éƒ¨åˆ·æ–°åˆ°å†…å­˜ä¸­ã€‚ volatile è¯» / å†™æ—¶æ˜¯å¦‚ä½•æ’å…¥å†…å­˜å±éšœçš„ï¼Œè§ä¸‹å›¾ï¼šâ€‹ ä»ä¸Šå›¾ï¼Œå¯ä»¥çŸ¥é“ volatile è¯» / å†™æ’å…¥å†…å­˜å±éšœè§„åˆ™ï¼š åœ¨æ¯ä¸ª volatile è¯»æ“ä½œçš„åé¢æ’å…¥ LoadLoad å±éšœå’Œ LoadStore å±éšœã€‚ åœ¨æ¯ä¸ª volatile å†™æ“ä½œçš„å‰ååˆ†åˆ«æ’å…¥ä¸€ä¸ª StoreStore å±éšœå’Œä¸€ä¸ª StoreLoad å±éšœã€‚ â€‹ ä¹Ÿå°±æ˜¯è¯´ï¼Œç¼–è¯‘å™¨ä¸ä¼šå¯¹ volatile è¯»ä¸ volatile è¯»åé¢çš„ä»»æ„å†…å­˜æ“ä½œé‡æ’åºï¼›ç¼–è¯‘å™¨ä¸ä¼šå¯¹ volatile å†™ä¸ volatile å†™å‰é¢çš„ä»»æ„å†…å­˜æ“ä½œé‡æ’åºã€‚â€‹ äº”ï¼Œä½¿ç”¨volatileçš„åœºæ™¯synchronizedå…³é”®å­—æ˜¯é˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä¸€æ®µä»£ç ï¼Œé‚£ä¹ˆå°±ä¼šå¾ˆå½±å“ç¨‹åºæ‰§è¡Œæ•ˆç‡ï¼Œè€Œvolatileå…³é”®å­—åœ¨æŸäº›æƒ…å†µä¸‹æ€§èƒ½è¦ä¼˜äºsynchronizedï¼Œä½†æ˜¯è¦æ³¨æ„volatileå…³é”®å­—æ˜¯æ— æ³•æ›¿ä»£synchronizedå…³é”®å­—çš„ï¼Œå› ä¸ºvolatileå…³é”®å­—æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚é€šå¸¸æ¥è¯´ï¼Œä½¿ç”¨volatileå¿…é¡»å…·å¤‡ä»¥ä¸‹2ä¸ªæ¡ä»¶ï¼šâ€‹ å¯¹å˜é‡çš„å†™æ“ä½œä¸ä¾èµ–äºå½“å‰å€¼ è¯¥å˜é‡æ²¡æœ‰åŒ…å«åœ¨å…·æœ‰å…¶ä»–å˜é‡çš„ä¸å˜å¼ä¸­ â€‹ å®é™…ä¸Šï¼Œè¿™äº›æ¡ä»¶è¡¨æ˜ï¼Œå¯ä»¥è¢«å†™å…¥ volatile å˜é‡çš„è¿™äº›æœ‰æ•ˆå€¼ç‹¬ç«‹äºä»»ä½•ç¨‹åºçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å˜é‡çš„å½“å‰çŠ¶æ€ã€‚â€‹ äº‹å®ä¸Šï¼Œæˆ‘çš„ç†è§£å°±æ˜¯ä¸Šé¢çš„2ä¸ªæ¡ä»¶éœ€è¦ä¿è¯æ“ä½œæ˜¯åŸå­æ€§æ“ä½œï¼Œæ‰èƒ½ä¿è¯ä½¿ç”¨volatileå…³é”®å­—çš„ç¨‹åºåœ¨å¹¶å‘æ—¶èƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œã€‚â€‹ 1.çŠ¶æ€æ ‡è®°ä½â€‹ 123456789volatile boolean flag = false; while(!flag)&#123; doSomething();&#125; public void setFlag() &#123; flag = true;&#125; 12345678910volatile boolean inited = false;//çº¿ç¨‹1:context = loadContext(); inited = true; //çº¿ç¨‹2:while(!inited )&#123;sleep()&#125;doSomethingwithconfig(context); 2.double check1234567891011121314151617class Singleton&#123; private volatile static Singleton instance = null; private Singleton() &#123; &#125; public static Singleton getInstance() &#123; if(instance==null) &#123; synchronized (Singleton.class) &#123; if(instance==null) instance = new Singleton(); &#125; &#125; return instance; &#125;&#125;","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"Synchronized","slug":"JUC/Synchronized","date":"2022-01-11T11:05:39.534Z","updated":"2022-01-11T11:32:10.744Z","comments":true,"path":"2022/01/11/JUC/Synchronized/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/Synchronized/","excerpt":"","text":"ä¸€ï¼Œçº¿ç¨‹å®‰å…¨é—®é¢˜çº¿ç¨‹çš„åˆç†ä½¿ç”¨èƒ½å¤Ÿæå‡ç¨‹åºçš„å¤„ç†æ€§èƒ½ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªæ–¹é¢ï¼Œç¬¬ä¸€ä¸ªæ˜¯èƒ½å¤Ÿåˆ©ç”¨å¤šæ ¸CPUä»¥åŠè¶…çº¿ç¨‹æŠ€æœ¯æ¥å®ç°çº¿ç¨‹çš„å¹¶è¡Œæ‰§è¡Œï¼›ç¬¬äºŒä¸ªæ˜¯çº¿ç¨‹çš„å¼‚æ­¥åŒ–æ‰§è¡Œç›¸æ¯”äºåŒæ­¥æ¥è¯´ï¼Œå¼‚æ­¥æ‰§è¡Œèƒ½å¤Ÿå¾ˆå¥½çš„ä¼˜åŒ–ç¨‹åºçš„å¤„ç†æ€§èƒ½æå‡å¹¶å‘ååé‡ã€‚ 1.çº¿ç¨‹å®‰å…¨ä¸€ä¸ªå˜é‡iï¼Œå‡å¦‚ä¸€ä¸ªçº¿ç¨‹å»è®¿é—®è¿™ä¸ªå˜é‡è¿›è¡Œä¿®æ”¹ï¼Œè¿™ä¸ªæ—¶å€™å¯¹äºæ•°æ®çš„ä¿®æ”¹å’Œè®¿é—®æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚ä½†æ˜¯å¦‚æœæ›´å¤šçš„çº¿ç¨‹å¯¹äºç€åŒä¸€ä¸ªå˜é‡è¿›è¡Œä¿®æ”¹ï¼Œå°±ä¼šå­˜åœ¨ä¸€ä¸ªæ•°æ®å®‰å…¨æ€§é—®é¢˜ã€‚ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå–å†³äºä»–æ˜¯å¦ä¼šè¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä»¥åŠç¨‹åºä¸­æ˜¯å¦‚ä½•å»ä½¿ç”¨è¿™ä¸ªå¯¹è±¡çš„ã€‚æ‰€ä»¥ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå…±äº«å¯¹è±¡ï¼Œåœ¨ä¸éœ€è¦é¢å¤–çš„åŒæ­¥ä»¥åŠè°ƒç”¨ç«¯ä»£ç ä¸ç”¨åšå…¶ä»–åè°ƒçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå…±äº«å¯¹è±¡çš„çŠ¶æ€ä¾ç„¶æ˜¯æ­£ç¡®çš„ï¼ˆæ­£ç¡®æ€§æ„å‘³ç€è¿™ä¸ªå¯¹è±¡çš„ç»“æœä¸æˆ‘ä»¬é¢„æœŸè§„å®šçš„ç»“æœä¿æŒä¸€è‡´ï¼‰ï¼Œé‚£è¯´æ˜è¿™ä¸ªå¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ 2.å¦‚ä½•ä¿è¯çº¿ç¨‹å¹¶è¡Œçš„æ•°æ®å®‰å…¨èƒ½å¤Ÿæœ‰ä¸€ç§æ–¹æ³•ä½¿å¾—çº¿ç¨‹çš„å¹¶è¡Œå˜æˆä¸²è¡Œã€‚åŠ é”ä»€ä¹ˆæ˜¯é”ï¼Ÿä»–æ˜¯å¤„ç†å¹¶å‘çš„ä¸€ç§åŒæ­¥æ‰‹æ®µï¼Œå¦‚æœè¾¾åˆ°å‰é¢çš„ç›®çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªé”ä¸€å®šéœ€è¦å®ç°äº’æ–¥çš„ç‰¹æ€§ã€‚Javaæä¾›åŠ é”çš„æ–¹æ³•å°±æ˜¯synchronizedå…³é”®å­—ã€‚ äºŒï¼Œsynchronizedå®ç°åŸç†å¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹ä¸­synchronizedä¸€ç›´æ˜¯å…ƒè€çº§çš„ï¼Œå¾ˆå¤šäººéƒ½ä¼šç§°å‘¼ä¸ºé‡é‡çº§é”ã€‚ä½†æ˜¯éšç€jdk6å¯¹synchronizedè¿›è¡Œå„ç§ä¼˜åŒ–ä¹‹åï¼Œæœ‰äº›æƒ…å†µä¸‹ä»–å°±å¹¶ä¸æ˜¯é‚£ä¹ˆé‡é‡çº§äº†ã€‚java6ä¸­ä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—è€Œå¼•å…¥çš„åå‘é”å’Œè½»é‡çº§é”ã€‚â€‹ synchronizedå®ç°åŒæ­¥çš„åŸºç¡€ï¼šJavaä¸­æ¯ä¸€ä¸ªå¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”ã€‚å…·ä½“è¡¨ç°ä¸ºä¸‰ç§æƒ…å†µï¼š æ™®é€šåŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡ é™æ€åŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰ç±»çš„Classå¯¹è±¡ åŒæ­¥æ–¹æ³•å—ï¼Œé”æ˜¯syncæ‹¬å·é‡Œé¢é…ç½®çš„å¯¹è±¡ â€‹ å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è®¿é—®åŒæ­¥ä»£ç å—æ—¶ï¼Œä»–é¦–å…ˆå¿…é¡»å¾—åˆ°é”ï¼Œé€€å‡ºæˆ–è€…æŠ›å‡ºå¼‚å¸¸æ—¶å¿…é¡»é‡Šæ”¾é”ã€‚é‚£ä¹ˆé”åˆ°åº•å­˜å‚¨åœ¨å“ªé‡Œå‘¢ï¼Ÿé”é‡Œé¢ä¼šå­˜å‚¨ä»€ä¹ˆä¿¡æ¯ï¼Ÿâ€‹ ä»JVMè§„èŒƒä¸­å¯ä»¥çœ‹åˆ°synchronizedåœ¨jvmé‡Œé¢çš„å®ç°åŸç†ï¼ŒjvmåŸºäºè¿›å…¥å’Œé€€å‡ºmonitorå¯¹è±¡æ¥å®ç°æ–¹æ³•åŒæ­¥å’Œä»£ç å—çš„åŒæ­¥ï¼Œä½†æ˜¯ä¸¤è€…çš„å®ç°ç»†èŠ‚ä¸ä¸€æ ·ã€‚ä»£ç å—åŒæ­¥ä½¿ç”¨monitorenterå’ŒmonitorexitæŒ‡ä»¤å®ç°çš„ï¼Œè€Œæ–¹æ³•çš„åŒæ­¥æ˜¯ä½¿ç”¨å¦å¤–ä¸€ç§æ–¹å¼å®ç°çš„ï¼Œç»†èŠ‚åœ¨JVMè§„èŒƒé‡Œå¹¶æ²¡æœ‰è¯¦ç»†è¯´æ˜ã€‚ä½†æ˜¯æ–¹æ³•çš„åŒæ­¥åŒæ ·å¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªæŒ‡ä»¤æ¥å®ç°ã€‚â€‹ monitorenteræŒ‡ä»¤æ˜¯åœ¨ç¼–è¯‘åæ’å…¥åˆ°åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œè€Œmonitorexitæ˜¯æ’å…¥åˆ°æ–¹æ³•ç»“æŸå¤„å’Œå¼‚å¸¸å¤„ï¼ŒJVMè¦ä¿è¯æ¯ä¸ªmonitorenterå¿…é¡»æœ‰å¯¹åº”çš„monitorexitä¸ä¹‹é…å¯¹ã€‚ä»»ä½•å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªmonitorä¸ä¹‹å…³è”ï¼Œå½“ä¸”ä¸€ä¸ªmonitorè¢«æŒæœ‰åï¼Œå®ƒå°†å¤„äºé”å®šçŠ¶æ€ã€‚çº¿ç¨‹æ‰§è¡Œåˆ°monitorenteræŒ‡ä»¤æ—¶ï¼Œå°†ä¼šå°è¯•è·å–å¯¹è±¡æ‰€å¯¹åº”çš„monitorçš„æ‰€æœ‰æƒï¼Œå³å°è¯•è·å¾—å¯¹è±¡çš„é”ã€‚â€‹ 12345678910111213141516/** * @author äºŒå * @since 2021/8/26 4:33 ä¸‹åˆ */public class SyncTest &#123; &#123; synchronized (Object.class)&#123; try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125; æ‰§è¡Œjavap -v SyncTest å‘½ä»¤â€‹ ä¸‰ï¼Œé”çš„å­˜å‚¨â€‹ åˆ†æï¼šè¦å®ç°å¤šçº¿ç¨‹çš„äº’æ–¥çŠ¶æ€ï¼Œé‚£è¿™æŠŠé”éœ€è¦å“ªäº›å› ç´ ï¼Ÿ é”éœ€è¦æœ‰ä¸€ä¸ªä¸œè¥¿æ¥è¡¨ç¤ºï¼Œæ¯”å¦‚è·å¾—é”æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Œæ— é”çŠ¶æ€æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Ÿ è¿™ä¸ªçŠ¶æ€éœ€è¦å¯¹å¤šä¸ªçº¿ç¨‹å…±äº« â€‹ è§‚å¯Ÿsynchronizedçš„æ•´ä¸ªè¯­æ³•å‘ç°ï¼Œsynchronized(lock)æ˜¯åŸºäºlockè¿™ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ¥æ§åˆ¶é”ç²’åº¦çš„ï¼Œé‚£æ˜¯ä¸æ˜¯é”çš„å­˜å‚¨å’Œè¿™ä¸ªlockå¯¹è±¡æœ‰å…³ç³»å‘¢ï¼Ÿä»¥å¯¹è±¡åœ¨jvmå†…å­˜ä¸­æ˜¯å¦‚ä½•å­˜å‚¨çš„ä½œä¸ºåˆ‡å…¥ç‚¹ï¼Œåˆ†æå¯¹è±¡é‡Œé¢æœ‰ä»€ä¹ˆç‰¹æ€§èƒ½å¤Ÿå®ç°é”ã€‚ 1.å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€åœ¨ Hotspot è™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­çš„å­˜å‚¨å¸ƒå±€ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸ:å¯¹è±¡å¤´(Header)ã€å®ä¾‹æ•°æ®(Instance Data)ã€å¯¹é½å¡«å……(Padding)ã€‚ 2.JVMæºç å®ç°å½“æˆ‘ä»¬åœ¨javaä»£ç é‡Œé¢ä½¿ç”¨newåˆ›å»ºä¸€ä¸ªå¯¹è±¡å®ä¾‹çš„æ—¶å€™ï¼Œjvmå±‚é¢å®é™…ä¸Šä¼šåˆ›å»ºä¸€ä¸ªinstanceOopDescå¯¹è±¡ã€‚â€‹ Hotspotè™šæ‹Ÿæœºé‡‡ç”¨OOP-Klassç”¨æ¥æè¿°å¯¹è±¡å®ä¾‹Javaå¯¹è±¡å®ä¾‹ï¼ŒOOPæŒ‡çš„æ˜¯æ™®é€šå¯¹è±¡æŒ‡é’ˆï¼ŒKlassç”¨æ¥æè¿°å¯¹è±¡å®ä¾‹çš„å…·ä½“ç±»å‹ã€‚Hotspoté‡‡ç”¨instanceOopDescå’ŒarrayOopDescå¯¹è±¡ç”¨æ¥æè¿°æ•°ç»„ç±»å‹ã€‚â€‹ instanceOopDescçš„å®šä¹‰åœ¨Hotspotæºç ä¸­çš„instanceOop.hppæ–‡ä»¶ä¸­ï¼Œå¦å¤–ï¼ŒarrayOopDescçš„å®šä¹‰å¯¹åº”arrayOop.hppã€‚ 1234567891011121314151617181920212223#ifndef SHARE_OOPS_INSTANCEOOP_HPP#define SHARE_OOPS_INSTANCEOOP_HPP#include &quot;oops/oop.hpp&quot;// An instanceOop is an instance of a Java Class// Evaluating &quot;new HashTable()&quot; will create an instanceOop.class instanceOopDesc : public oopDesc &#123; public: // aligned header size. static int header_size() &#123; return sizeof(instanceOopDesc)/HeapWordSize; &#125; // If compressed, the offset of the fields of the instance may not be aligned. static int base_offset_in_bytes() &#123; return (UseCompressedClassPointers) ? klass_gap_offset_in_bytes() : sizeof(instanceOopDesc); &#125;&#125;;#endif // SHARE_OOPS_INSTANCEOOP_HPP ä» instanceOopDesc ä»£ç ä¸­å¯ä»¥çœ‹åˆ° instanceOopDescç»§æ‰¿è‡ª oopDescï¼ŒoopDesc çš„å®šä¹‰åœ¨Hotspot æºç ä¸­çš„oop.hpp æ–‡ä»¶ä¸­ã€‚åœ¨æ™®é€šå®ä¾‹å¯¹è±¡ä¸­ï¼ŒoopDesc çš„å®šä¹‰åŒ…å«ä¸¤ä¸ªæˆå‘˜ï¼Œåˆ†åˆ«æ˜¯ mark å’Œ metadata ã€‚_markè¡¨ç¤ºå¯¹è±¡æ ‡è®°ã€å±äº markOop ç±»å‹ï¼Œä¹Ÿå°±æ˜¯æ¥ä¸‹æ¥è¦åˆ†æçš„ Mark Worldï¼Œå®ƒè®°å½•äº†å¯¹è±¡å’Œé”æœ‰å…³çš„ä¿¡æ¯ã€‚â€‹ _metadata è¡¨ç¤ºç±»å…ƒä¿¡æ¯ï¼Œç±»å…ƒä¿¡æ¯å­˜å‚¨çš„æ˜¯å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®(Klass)çš„é¦–åœ°å€ï¼Œå…¶ä¸­ Klass è¡¨ç¤ºæ™®é€šæŒ‡é’ˆã€_compressed_klass è¡¨ç¤ºå‹ç¼©ç±»æŒ‡é’ˆã€‚ 3.MarkWordåœ¨Hotspotä¸­ï¼ŒmarkOop çš„å®šä¹‰åœ¨markOop.hpp æ–‡ä»¶ä¸­ã€‚â€‹ Mark word è®°å½•äº†å¯¹è±¡å’Œé”æœ‰å…³çš„ä¿¡æ¯ï¼Œå½“æŸä¸ªå¯¹è±¡è¢«synchronized å…³é”®å­—å½“æˆåŒæ­¥é”æ—¶ï¼Œé‚£ä¹ˆå›´ç»•è¿™ä¸ªé”çš„ä¸€ç³»åˆ—æ“ä½œéƒ½å’Œ Mark word æœ‰å…³ç³»ã€‚Mark Word åœ¨ 32 ä½è™šæ‹Ÿæœºçš„é•¿åº¦æ˜¯ 32bitã€åœ¨ 64 ä½è™šæ‹Ÿæœºçš„é•¿åº¦æ˜¯ 64bitã€‚Mark Wordé‡Œé¢å­˜å‚¨çš„æ•°æ®ä¼šéšç€é”æ ‡å¿—ä½çš„å˜åŒ–è€Œå˜åŒ–ï¼ŒMark Word å¯èƒ½å˜åŒ–ä¸ºå­˜å‚¨ä»¥ä¸‹ 5 ç§æƒ…å†µã€‚â€‹ 4.ä¸ºä»€ä¹ˆä»»ä½•å¯¹è±¡éƒ½å¯ä»¥å®ç°é” é¦–å…ˆï¼Œjavaä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½æ´¾ç”Ÿè‡ªObjectç±»ï¼Œè€Œæ¯ä¸ªJava Object åœ¨JVM å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªnative çš„C++å¯¹è±¡oop/oopDesc è¿›è¡Œå¯¹åº”ã€‚ çº¿ç¨‹åœ¨è·å–é”çš„æ—¶å€™ï¼Œå®é™…ä¸Šå°±æ˜¯è·å¾—äº†ä¸€ä¸ªç›‘è§†å™¨å¯¹è±¡ï¼ˆmonitorï¼‰ï¼Œå¯ä»¥è®¤ä¸ºä»–æ˜¯ä¸€ä¸ªåŒæ­¥å¯¹è±¡ï¼Œæ‰€æœ‰çš„javaå¯¹è±¡å¤©ç”Ÿæºå¸¦monitorã€‚åœ¨hotspotæºç çš„markWord.hppæ–‡ä»¶ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™æ®µä»£ç ï¼š â€‹ 12345ObjectMonitor* monitor() const &#123; assert(has_monitor(), &quot;check&quot;); // Use xor instead of &amp;~ to provide one extra tag-bit check. return (ObjectMonitor*) (value() ^ monitor_value);&#125; å¤šçº¿ç¨‹è®¿é—®åŒæ­¥ä»£ç å—æ—¶ç›¸å½“äºå»äº‰æŠ¢å¯¹è±¡ç›‘è§†å™¨ä¿®æ”¹å¯¹è±¡ä¸­çš„é”æ ‡è¯†ï¼Œä¸Šé¢çš„ä»£ç ä¸­ObjectMonitorè¿™ä¸ªå¯¹è±¡å’Œçº¿ç¨‹äº‰æŠ¢é”çš„é€»è¾‘æœ‰å¯†åˆ‡çš„å…³ç³»ã€‚â€‹ 5.ä¸åŒé”çŠ¶æ€ä¸‹MarkWordä¸­å­˜å‚¨çš„å†…å®¹ å››ï¼Œé”å‡çº§ä½¿ç”¨é”èƒ½å¤Ÿå®ç°æ•°æ®çš„å®‰å…¨æ€§ï¼Œä½†æ˜¯ä¼šå¸¦æ¥æ€§èƒ½çš„ä¸‹é™ã€‚ä¸ä½¿ç”¨é”èƒ½å¤ŸåŸºäºçº¿ç¨‹å¹¶è¡Œæå‡ç¨‹åºæ€§èƒ½ï¼Œä½†æ˜¯å´ä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ã€‚è¿™ä¸¤è€…ä¹‹é—´ä¼¼ä¹æ˜¯æ²¡æœ‰åŠæ³•è¾¾åˆ°æ—¢èƒ½æ»¡è¶³æ€§èƒ½ä¹Ÿèƒ½æ»¡è¶³å®‰å…¨æ€§çš„è¦æ±‚ã€‚â€‹ hotspot è™šæ‹Ÿæœºçš„ä½œè€…ç»è¿‡è°ƒæŸ¥å‘ç°ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒåŠ é”çš„ä»£ç ä¸ä»…ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å¾—ã€‚æ‰€ä»¥åŸºäºè¿™æ ·ä¸€ä¸ªæ¦‚ç‡ï¼Œæ˜¯çš„ synchronized åœ¨JDK1.6 ä¹‹ååšäº†ä¸€äº›ä¼˜åŒ–ï¼Œä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”å¸¦æ¥çš„æ€§èƒ½å¼€é”€ï¼Œå¼•å…¥äº†åå‘é”ã€è½»é‡çº§é”çš„æ¦‚å¿µã€‚å› æ­¤åœ¨ synchronized ä¸­ï¼Œé”å­˜åœ¨å››ç§çŠ¶æ€åˆ†åˆ«æ˜¯ï¼šæ— é”ã€åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ï¼› é”çš„çŠ¶æ€æ ¹æ®ç«äº‰æ¿€çƒˆçš„ç¨‹åº¦ä»ä½åˆ°é«˜ä¸æ–­å‡çº§ã€‚â€‹ 1ï¼Œåå‘é”çš„åŸºæœ¬åŸç†â€‹ æ€ä¹ˆç†è§£åå‘é”ï¼Ÿ å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŠ äº†åŒæ­¥é”çš„ä»£ç å—æ—¶ï¼Œä¼šåœ¨å¯¹è±¡å¤´ä¸­å­˜å‚¨å½“å‰çº¿ç¨‹çš„ IDï¼Œåç»­è¿™ä¸ªçº¿ç¨‹è¿›å…¥å’Œé€€å‡ºè¿™æ®µåŠ äº†åŒæ­¥é”çš„ä»£ç å—æ—¶ï¼Œä¸éœ€è¦å†æ¬¡åŠ é”å’Œé‡Šæ”¾é”ã€‚è€Œæ˜¯ç›´æ¥æ¯”è¾ƒå¯¹è±¡å¤´é‡Œé¢æ˜¯å¦å­˜å‚¨äº†æŒ‡å‘å½“å‰çº¿ç¨‹çš„åå‘é”ã€‚å¦‚æœç›¸ç­‰è¡¨ç¤ºåå‘é”æ˜¯åå‘äºå½“å‰çº¿ç¨‹çš„ï¼Œå°±ä¸éœ€è¦å†å°è¯•è·å¾—é”äº†ã€‚â€‹ å¯¹è±¡ä¸€æ—¦ç”Ÿæˆäº†hashç ï¼Œä»–å°±æ— æ³•è¿›å…¥åå‘é”çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ä¸€ä¸ªå¯¹è±¡å·²ç»è®¡ç®—è¿‡hashç ï¼Œå¥¹å°±æ— æ³•è¿›å…¥åå‘é”çŠ¶æ€ã€‚å½“ä¸€ä¸ªå¯¹è±¡å½“å‰æ­£å¤„äºåå‘é”çŠ¶æ€ï¼Œå¹¶ä¸”éœ€è¦è®¡ç®—å…¶hashç ï¼Œä»–çš„åå‘é”ä¼šè¢«æ’¤é”€ï¼Œå¹¶ä¸”é”ä¼šè†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚ åå‘é”å…¶å®ä¸»è¦è§£å†³çš„æ˜¯æ— ç«äº‰æƒ…å†µä¸‹ï¼Œé”çš„æ€§èƒ½é—®é¢˜ã€‚ 1ï¼‰åå‘é”çš„è·å–å’Œæ’¤é”€é€»è¾‘â€‹ é¦–å…ˆè·å–é” å¯¹è±¡çš„ Markwordï¼Œåˆ¤æ–­æ˜¯å¦å¤„äºå¯åå‘çŠ¶æ€ã€‚ï¼ˆbiased_lock=1ã€ä¸” ThreadId ä¸ºç©ºï¼‰ â€‹ å¦‚æœæ˜¯å¯åå‘çŠ¶æ€ï¼Œåˆ™é€šè¿‡ CAS æ“ä½œï¼ŒæŠŠå½“å‰çº¿ç¨‹çš„ IDå†™å…¥åˆ° MarkWordï¼Œé”æ ‡å¿—ä½æ”¹æˆ01ï¼Œåå‘æ ‡å¿—ä½æ”¹æˆ1. â€‹ å¦‚æœ cas æˆåŠŸï¼Œé‚£ä¹ˆ markword å°±ä¼šå˜æˆè¿™æ ·ã€‚è¡¨ç¤ºå·²ç»è·å¾—äº†é”å¯¹è±¡çš„åå‘é”ï¼Œæ¥ç€æ‰§è¡ŒåŒæ­¥ä»£ç å— å¦‚æœ cas å¤±è´¥ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å·²ç»è·å¾—äº†åå‘é”ï¼Œè¿™ç§æƒ…å†µè¯´æ˜å½“å‰é”å­˜åœ¨ç«äº‰ï¼Œéœ€è¦æ’¤é”€å·²è·å¾—åå‘é”çš„çº¿ç¨‹ï¼Œå¹¶ä¸”æŠŠå®ƒæŒæœ‰çš„é”å‡çº§ä¸ºè½»é‡çº§é”ï¼ˆè¿™ä¸ªæ“ä½œéœ€è¦ç­‰åˆ°å…¨å±€å®‰å…¨ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰çº¿ç¨‹åœ¨æ‰§è¡Œå­—èŠ‚ç ï¼‰æ‰èƒ½æ‰§è¡Œ â€‹ å¦‚æœæ˜¯å·²åå‘çŠ¶æ€ï¼Œéœ€è¦æ£€æŸ¥ markword ä¸­å­˜å‚¨çš„ThreadID æ˜¯å¦ç­‰äºå½“å‰çº¿ç¨‹çš„ ThreadID â€‹ å¦‚æœç›¸ç­‰ï¼Œä¸éœ€è¦å†æ¬¡è·å¾—é”ï¼Œå¯ç›´æ¥æ‰§è¡ŒåŒæ­¥ä»£ç å— â€‹ å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜å½“å‰é”åå‘äºå…¶ä»–çº¿ç¨‹ï¼Œéœ€è¦æ’¤é”€åå‘é”å¹¶å‡çº§åˆ°è½»é‡çº§é”2) åå‘é”çš„æ’¤é”€â€‹ åå‘é”çš„æ’¤é”€å¹¶ä¸æ˜¯æŠŠå¯¹è±¡æ¢å¤åˆ°æ— é”å¯åå‘çŠ¶æ€ï¼ˆå› ä¸ºåå‘é”å¹¶ä¸å­˜åœ¨é”é‡Šæ”¾çš„æ¦‚å¿µï¼‰ï¼Œè€Œæ˜¯åœ¨è·å–åå‘é”çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç° cas å¤±è´¥ä¹Ÿå°±æ˜¯å­˜åœ¨çº¿ç¨‹ç«äº‰æ—¶ï¼Œç›´æ¥æŠŠè¢«åå‘çš„é”å¯¹è±¡å‡çº§åˆ°è¢«åŠ äº†è½»é‡çº§é”çš„çŠ¶æ€ã€‚â€‹ å¯¹åŸæŒæœ‰åå‘é”çš„çº¿ç¨‹è¿›è¡Œæ’¤é”€æ—¶ï¼ŒåŸè·å¾—åå‘é”çš„çº¿ç¨‹æœ‰ä¸¤ç§æƒ…å†µï¼šâ€‹ åŸè·å¾—åå‘é”çš„çº¿ç¨‹å¦‚æœå·²ç»é€€å‡ºäº†ä¸´ç•ŒåŒºï¼Œä¹Ÿå°±æ˜¯åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä¼šæŠŠå¯¹è±¡å¤´è®¾ç½®æˆæ— é”çŠ¶æ€å¹¶ä¸”äº‰æŠ¢é”çš„çº¿ç¨‹å¯ä»¥åŸºäº CAS é‡æ–°åå‘å½“å‰çº¿ç¨‹ â€‹ å¦‚æœåŸè·å¾—åå‘é”çš„çº¿ç¨‹çš„åŒæ­¥ä»£ç å—è¿˜æ²¡æ‰§è¡Œå®Œï¼Œå¤„äºä¸´ç•ŒåŒºä¹‹å†…ï¼Œè¿™ä¸ªæ—¶å€™ä¼šæŠŠåŸè·å¾—åå‘é”çš„çº¿ç¨‹å‡çº§ä¸ºè½»é‡çº§é”åç»§ç»­æ‰§è¡ŒåŒæ­¥ä»£ç å— â€‹ åœ¨æˆ‘ä»¬çš„åº”ç”¨å¼€å‘ä¸­ï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸€å®šä¼šå­˜åœ¨ 2 ä¸ªä»¥ä¸Šçš„çº¿ç¨‹ç«äº‰ï¼Œé‚£ä¹ˆå¦‚æœå¼€å¯åå‘é”ï¼Œåè€Œä¼šæå‡è·å–é”çš„èµ„æºæ¶ˆè€—ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡ jvm å‚æ•°UseBiasedLocking æ¥è®¾ç½®å¼€å¯æˆ–å…³é—­åå‘é”ã€‚â€‹ 3ï¼‰æµç¨‹å›¾åˆ†æ 2ï¼Œè½»é‡çº§é”çš„åŸºæœ¬åŸç†1ï¼‰è½»é‡çº§é”çš„åŠ é”å’Œè§£é”é€»è¾‘â€‹ é”å‡çº§ä¸ºè½»é‡çº§é”ä¹‹åï¼Œå¯¹è±¡çš„ Markword ä¹Ÿä¼šè¿›è¡Œç›¸åº”çš„å˜åŒ–ã€‚å‡çº§ä¸ºè½»é‡çº§é”çš„è¿‡ç¨‹ï¼šâ€‹ çº¿ç¨‹åœ¨è‡ªå·±çš„æ ˆæ¡¢ä¸­åˆ›å»ºé”è®°å½• LockRecordã€‚ â€‹ å°†é”å¯¹è±¡çš„å¯¹è±¡å¤´ä¸­çš„MarkWordå¤åˆ¶åˆ°çº¿ç¨‹çš„åˆšåˆšåˆ›å»ºçš„é”è®°å½•ä¸­ã€‚ â€‹ å°†é”è®°å½•ä¸­çš„ Owner æŒ‡é’ˆæŒ‡å‘é”å¯¹è±¡ã€‚ â€‹ å°†é”å¯¹è±¡çš„å¯¹è±¡å¤´çš„MarkWordæ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆã€‚2ï¼‰è‡ªæ—‹é”â€‹ è½»é‡çº§é”åœ¨åŠ é”è¿‡ç¨‹ä¸­ï¼Œç”¨åˆ°äº†è‡ªæ—‹é”ã€‚â€‹ æ‰€è°“è‡ªæ—‹ï¼Œå°±æ˜¯æŒ‡å½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ¥ç«äº‰é”æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šåœ¨åŸåœ°å¾ªç¯ç­‰å¾…ï¼Œè€Œä¸æ˜¯æŠŠè¯¥çº¿ç¨‹ç»™é˜»å¡ï¼Œç›´åˆ°é‚£ä¸ªè·å¾—é”çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œè¿™ä¸ªçº¿ç¨‹å°±å¯ä»¥é©¬ä¸Šè·å¾—é”çš„ã€‚æ³¨æ„ï¼Œé”åœ¨åŸåœ°å¾ªç¯çš„æ—¶å€™ï¼Œæ˜¯ä¼šæ¶ˆè€— cpu çš„ï¼Œå°±ç›¸å½“äºåœ¨æ‰§è¡Œä¸€ä¸ªå•¥ä¹Ÿæ²¡æœ‰çš„ for å¾ªç¯ã€‚â€‹ æ‰€ä»¥ï¼Œè½»é‡çº§é”é€‚ç”¨äºé‚£äº›åŒæ­¥ä»£ç å—æ‰§è¡Œçš„å¾ˆå¿«çš„åœºæ™¯ï¼Œè¿™æ ·ï¼Œçº¿ç¨‹åŸåœ°ç­‰å¾…å¾ˆçŸ­çš„æ—¶é—´å°±èƒ½å¤Ÿè·å¾—é”äº†ã€‚â€‹ è‡ªæ—‹é”çš„ä½¿ç”¨ï¼Œå…¶å®ä¹Ÿæ˜¯æœ‰ä¸€å®šçš„æ¦‚ç‡èƒŒæ™¯ï¼Œåœ¨å¤§éƒ¨åˆ†åŒæ­¥ä»£ç å—æ‰§è¡Œçš„æ—¶é—´éƒ½æ˜¯å¾ˆçŸ­çš„ã€‚æ‰€ä»¥é€šè¿‡çœ‹ä¼¼æ— å¼‚è®®çš„å¾ªç¯åè€Œèƒ½æå‡é”çš„æ€§èƒ½ã€‚â€‹ ä½†æ˜¯è‡ªæ—‹å¿…é¡»è¦æœ‰ä¸€å®šçš„æ¡ä»¶æ§åˆ¶ï¼Œå¦åˆ™å¦‚æœä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç å—çš„æ—¶é—´å¾ˆé•¿ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹ä¸æ–­çš„å¾ªç¯åè€Œä¼šæ¶ˆè€— CPU èµ„æºã€‚é»˜è®¤æƒ…å†µä¸‹è‡ªæ—‹çš„æ¬¡æ•°æ˜¯ 10 æ¬¡ï¼Œå¯ä»¥é€šè¿‡ preBlockSpin æ¥ä¿®æ”¹ã€‚â€‹ åœ¨ JDK1.6 ä¹‹åï¼Œå¼•å…¥äº†è‡ªé€‚åº”è‡ªæ—‹é”ï¼Œè‡ªé€‚åº”æ„å‘³ç€è‡ªæ—‹çš„æ¬¡æ•°ä¸æ˜¯å›ºå®šä¸å˜çš„ï¼Œè€Œæ˜¯æ ¹æ®å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šè‡ªæ—‹çš„æ—¶é—´ä»¥åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šã€‚â€‹ å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œè‡ªæ—‹ç­‰å¾…åˆšåˆšæˆåŠŸè·å¾—è¿‡é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°±ä¼šè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹ä¹Ÿæ˜¯å¾ˆæœ‰å¯èƒ½å†æ¬¡æˆåŠŸï¼Œè¿›è€Œå®ƒå°†å…è®¸è‡ªæ—‹ç­‰å¾…æŒç»­ç›¸å¯¹æ›´é•¿çš„æ—¶é—´ã€‚å¦‚æœå¯¹äºæŸä¸ªé”ï¼Œè‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å¾—è¿‡ï¼Œé‚£åœ¨ä»¥åå°è¯•è·å–è¿™ä¸ªé”æ—¶å°†å¯èƒ½çœç•¥æ‰è‡ªæ—‹è¿‡ç¨‹ï¼Œç›´æ¥é˜»å¡çº¿ç¨‹ï¼Œé¿å…æµªè´¹å¤„ç†å™¨èµ„æºã€‚ ä¸ºä»€ä¹ˆè¦å°†å†…ç½®é”å¯¹è±¡çš„MarkWordå¤åˆ¶åˆ°é”è®°å½•é‡Œé¢ï¼Ÿå› ä¸ºå†…ç½®é”å¯¹è±¡çš„MarkWordçš„ç»“æ„ä¼šæœ‰æ‰€å˜åŒ–ï¼ŒMarkWordå°†ä¼šå‡ºç°ä¸€ä¸ªæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆï¼Œè€Œä¸å†å­˜ç€æ— é”çŠ¶æ€ä¸‹é”å¯¹è±¡å“ˆå¸Œç ç­‰ä¿¡æ¯ï¼Œæ‰€ä»¥å¿…é¡»å°†è¿™äº›ä¿¡æ¯æš‚å­˜èµ·æ¥ï¼Œä¾›åé¢åœ¨é”é‡Šæ”¾çš„æ—¶å€™ä½¿ç”¨ã€‚ JDK1.6ä½¿ç”¨çš„è½»é‡çº§é”æ˜¯æ™®é€šè‡ªæ—‹é”ï¼Œä¸”éœ€è¦æ‰‹åŠ¨æŒ‡å®šjvmå‚æ•°å¼€å¯ã€‚JDK1.7ä¹‹åï¼Œè½»é‡çº§é”ä½¿ç”¨è‡ªé€‚åº”è‡ªæ—‹é”ï¼Œjvmå¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨å¼€å¯ï¼Œä¸”è‡ªæ—‹æ—¶é—´ç”±jvmè‡ªåŠ¨æ§åˆ¶ã€‚â€‹ è½»é‡çº§é”ä¹Ÿè¢«ç§°ä¸ºéé˜»å¡åŒæ­¥é”ï¼Œä¹è§‚é”ï¼Œå› ä¸ºè¿™ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰æŠŠçº¿ç¨‹é˜»å¡æŒ‚èµ·ï¼Œè€Œæ˜¯è®©çº¿ç¨‹ç©ºå¾ªç¯ç­‰å¾…ã€‚ 3ï¼‰è½»é‡çº§é”çš„è§£é”â€‹ è½»é‡çº§é”çš„é”é‡Šæ”¾é€»è¾‘å…¶å®å°±æ˜¯è·å¾—é”çš„é€†å‘é€»è¾‘ï¼Œé€šè¿‡CAS æ“ä½œæŠŠçº¿ç¨‹æ ˆå¸§ä¸­çš„ LockRecord æ›¿æ¢å›åˆ°é”å¯¹è±¡çš„MarkWord ä¸­ï¼Œå¦‚æœæˆåŠŸè¡¨ç¤ºæ²¡æœ‰ç«äº‰ã€‚å¦‚æœå¤±è´¥ï¼Œè¡¨ç¤ºå½“å‰é”å­˜åœ¨ç«äº‰ï¼Œé‚£ä¹ˆè½»é‡çº§é”å°±ä¼šè†¨èƒ€æˆä¸ºé‡é‡çº§é”ã€‚â€‹ 4ï¼‰æµç¨‹å›¾åˆ†æ 3ï¼Œé‡é‡çº§é”çš„åŸºæœ¬åŸç†â€‹ å½“è½»é‡çº§é”è†¨èƒ€åˆ°é‡é‡çº§é”ä¹‹åï¼Œæ„å‘³ç€çº¿ç¨‹åªèƒ½è¢«æŒ‚èµ·é˜»å¡æ¥ç­‰å¾…è¢«å”¤é†’äº†ã€‚â€‹ 1ï¼‰é‡é‡çº§é”çš„ monitor123456789public class SyncTest &#123; public static void main(String[] args) &#123; synchronized (SyncTest.class)&#123; &#125; test(); &#125; public static synchronized void test()&#123; &#125;&#125; åŠ  äº† åŒ æ­¥ ä»£ ç  å— ä»¥ å ï¼Œ åœ¨ å­— èŠ‚ ç  ä¸­ ä¼š çœ‹ åˆ° ä¸€ ä¸ªmonitorenter å’Œ monitorexitã€‚â€‹ æ¯ä¸€ä¸ª JAVA å¯¹è±¡éƒ½ä¼šä¸ä¸€ä¸ªç›‘è§†å™¨ monitor å…³è”ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£æˆä¸ºä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦æ‰§è¡Œä¸€æ®µè¢«synchronized ä¿®é¥°çš„åŒæ­¥æ–¹æ³•æˆ–è€…ä»£ç å—æ—¶ï¼Œè¯¥çº¿ç¨‹å¾—å…ˆè·å–åˆ° synchronized ä¿®é¥°çš„å¯¹è±¡å¯¹åº”çš„ monitorã€‚monitorenter è¡¨ç¤ºå»è·å¾—ä¸€ä¸ªå¯¹è±¡ç›‘è§†å™¨ã€‚monitorexit è¡¨ç¤ºé‡Šæ”¾ monitor ç›‘è§†å™¨çš„æ‰€æœ‰æƒï¼Œä½¿å¾—å…¶ä»–è¢«é˜»å¡çš„çº¿ç¨‹å¯ä»¥å°è¯•å»è·å¾—è¿™ä¸ªç›‘è§†å™¨ã€‚â€‹ monitor ä¾èµ–æ“ä½œç³»ç»Ÿçš„ MutexLock(äº’æ–¥é”)æ¥å®ç°çš„, çº¿ç¨‹è¢«é˜»å¡åä¾¿è¿›å…¥å†…æ ¸ï¼ˆLinuxï¼‰è°ƒåº¦çŠ¶æ€ï¼Œè¿™ä¸ªä¼šå¯¼è‡´ç³»ç»Ÿåœ¨ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œä¸¥é‡å½±å“é”çš„æ€§èƒ½ã€‚â€‹ 2ï¼‰é‡é‡çº§é”çš„åŠ é”çš„åŸºæœ¬æµç¨‹â€‹ ä»»æ„çº¿ç¨‹å¯¹ Objectï¼ˆObject ç”± synchronized ä¿æŠ¤ï¼‰çš„è®¿é—®ï¼Œé¦–å…ˆè¦è·å¾— Object çš„ç›‘è§†å™¨ã€‚å¦‚æœè·å–å¤±è´¥ï¼Œçº¿ç¨‹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œçº¿ç¨‹çŠ¶æ€å˜ä¸º BLOCKEDã€‚å½“è®¿é—® Object çš„å‰é©±ï¼ˆè·å¾—äº†é”çš„çº¿ç¨‹ï¼‰é‡Šæ”¾äº†é”ï¼Œåˆ™è¯¥é‡Šæ”¾æ“ä½œå”¤é†’é˜»å¡åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ï¼Œä½¿å…¶é‡æ–°å°è¯•å¯¹ç›‘è§†å™¨çš„è·å–ã€‚â€‹ 3ï¼‰é‡é‡çº§é”æ ¸å¿ƒåŸç†jvmä¸­æ¯ä¸€ä¸ªå¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ªç›‘è§†å™¨ï¼Œç›‘è§†å™¨å’Œå¯¹è±¡ä¸€èµ·åˆ›å»ºï¼Œé”€æ¯ã€‚ç›‘è§†å™¨ç›¸å½“äºä¸€ä¸ªç”¨æ¥ç›‘è§†è¿™äº›çº¿ç¨‹è¿›å…¥çš„ç‰¹æ®Šæˆ¿é—´ï¼Œå…¶ä¹‰åŠ¡æ˜¯ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è¢«ä¿æŠ¤çš„ä¸´ç•ŒåŒºä»£ç å—ã€‚â€‹ æœ¬è´¨ä¸Šï¼Œç›‘è§†å™¨æ˜¯ä¸€ç§åŒæ­¥å·¥å…·ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯ï¼šâ€‹ åŒæ­¥ï¼šç›‘è§†å™¨æ‰€ä¿æŠ¤çš„ä¸´ç•ŒåŒºä»£ç æ˜¯äº’æ–¥çš„æ‰§è¡Œçš„ã€‚ä¸€ä¸ªç›‘è§†å™¨æ˜¯ä¸€ä¸ªè¿è¡Œè®¸å¯ï¼Œä»»ä¸€çº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºä»£ç éƒ½éœ€è¦è·å¾—è¿™ä¸ªè®¸å¯ï¼Œç¦»å¼€æ—¶æŠŠè®¸å¯å½’è¿˜ã€‚ åä½œï¼šç›‘è§†å™¨æä¾›Signalæœºåˆ¶ï¼Œå…è®¸æ­£æŒæœ‰è®¸å¯çš„çº¿ç¨‹æš‚æ—¶æ”¾å¼ƒè®¸å¯è¿›å…¥é˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹å‘é€Signalå»å”¤é†’ï¼›å…¶ä»–æ‹¥æœ‰è®¸å¯çš„çº¿ç¨‹å¯ä»¥å‘é€Signalï¼Œå”¤é†’æ­£åœ¨é˜»å¡ç­‰å¾…çš„çº¿ç¨‹ï¼Œè®©ä»–å¯ä»¥é‡æ–°è·å¾—è®¸å¯å¹¶å¯åŠ¨æ‰§è¡Œã€‚ â€‹ åœ¨HotSpotè™šæ‹Ÿæœºä¸­ï¼Œç›‘è§†å™¨æ˜¯ç”±C++ç±»ObjectMonitorå®ç°çš„ï¼ŒObjectMonitorç±»å®šä¹‰åœ¨ObjectMonitor.hppæ–‡ä»¶ä¸­ã€‚â€‹ ObjectMonitorçš„Ownerï¼ŒWaitSetï¼ŒCxqï¼ŒEntryListè¿™å‡ ä¸ªå±æ€§æ¯”è¾ƒå…³é”®ã€‚â€‹ ObjectMonitorçš„WaitSetï¼ŒCxqï¼ŒEntryListè¿™å‡ ä¸ªé˜Ÿåˆ—å­˜æ”¾æŠ¢å¤ºé‡é‡çº§é”çš„çº¿ç¨‹ï¼Œè€ŒObjectMonitorçš„Owneræ‰€æŒ‡å‘çš„çº¿ç¨‹å³ä¸ºè·å¾—é”çš„çº¿ç¨‹ã€‚â€‹ Cxq:ç«äº‰é˜Ÿåˆ—ï¼Œæ‰€æœ‰è¯·æ±‚é”çš„çº¿ç¨‹é¦–å…ˆè¢«æ”¾åˆ°è¿™ä¸ªç«äº‰é˜Ÿåˆ—ã€‚ EntryList:Cxqä¸­é‚£äº›æœ‰èµ„æ ¼æˆä¸ºå€™é€‰èµ„æºçš„çº¿ç¨‹è¢«ç§»åŠ¨åˆ°EntryListä¸­ã€‚ WaitSetï¼šæŸä¸ªæ‹¥æœ‰ObjectMonitorçš„çº¿ç¨‹åœ¨è°ƒç”¨Object.wait()æ–¹æ³•ä¹‹åå°†è¢«é˜»å¡ï¼Œç„¶åè¯¥çº¿ç¨‹å°†ä¼šè¢«æ”¾åˆ°WaitSeté“¾è¡¨ä¸­ã€‚ â€‹ CxqCxqå¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é˜Ÿåˆ—ï¼Œåªæ˜¯ä¸€ä¸ªè™šæ‹Ÿé˜Ÿåˆ—ï¼ŒåŸå› åœ¨äºCxqæ˜¯ç”±NodeåŠå…¶nextæŒ‡é’ˆé€»è¾‘æ„æˆçš„ï¼Œå¹¶ä¸å­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—çš„æ•°æ®ç»“æ„ã€‚æ¯æ¬¡æ–°åŠ å…¥Nodeä¼šåœ¨Cxqçš„é˜Ÿå¤´è¿›è¡Œï¼Œé€šè¿‡casæ”¹å˜ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆä¸ºæ–°å¢èŠ‚ç‚¹ï¼ŒåŒæ—¶è®¾ç½®æ–°å¢èŠ‚ç‚¹çš„nextæŒ‡å‘åç»­çš„èŠ‚ç‚¹ï¼›ä»Cxqå–å¾—å…ƒç´ æ—¶ï¼Œä¼šä»é˜Ÿå°¾è·å–ã€‚æ˜¾ç„¶ï¼ŒCxqç»“æ„æ˜¯ä¸€ä¸ªæ— é”çš„ç»“æ„ã€‚â€‹ å› ä¸ºåªæœ‰Ownerçº¿ç¨‹æ‰èƒ½ä»é˜Ÿå°¾å–å…ƒç´ ï¼Œå³çº¿ç¨‹å‡ºåˆ—æ“ä½œæ— äº‰ç”¨ï¼Œå½“ç„¶å°±é¿å…äº†casçš„abaé—®é¢˜ã€‚â€‹ åœ¨çº¿ç¨‹è¿›å…¥Cxqå‰ï¼ŒæŠ¢é”çº¿ç¨‹ä¼šå…ˆå°è¯•é€šè¿‡casè‡ªæ—‹é”è·å–é”ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œå°±è¿›å…¥Cxqé˜Ÿåˆ—ï¼Œè¿™æ˜æ˜¾å¯¹äºå·²ç»è¿›å…¥Cxqé˜Ÿåˆ—çš„çº¿ç¨‹æ˜¯ä¸å…¬å¹³çš„ã€‚æ‰€ä»¥ï¼ŒsynchronizedåŒæ­¥å—æ‰€ä½¿ç”¨çš„é‡é‡çº§é”æ˜¯ä¸å…¬å¹³é”ã€‚â€‹ EntryListâ€‹ EntryListä¸Cxqåœ¨é€»è¾‘ä¸Šéƒ½å±äºç­‰å¾…é˜Ÿåˆ—ã€‚Cxqä¼šè¢«çº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œä¸ºäº†é™ä½å¯¹Cxqé˜Ÿå°¾çš„äº‰ç”¨ï¼Œè€Œå»ºç«‹EntryListã€‚åœ¨Ownerçº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œjvmä¼šä»Cxqä¸­è¿ç§»çº¿ç¨‹åˆ°EntryListï¼Œå¹¶ä¼šæŒ‡å®šEntryListä¸­çš„æŸä¸ªçº¿ç¨‹ä¸ºOnDeck Threadã€‚EntryListä¸­çš„çº¿ç¨‹ä½œä¸ºå€™é€‰ç«äº‰çº¿ç¨‹è€Œå­˜åœ¨ã€‚â€‹ OnDeck Thread &amp; Owner Threadjvmä¸ç›´æ¥æŠŠé”ä¼ é€’ç»™Owner Threadï¼Œè€Œæ˜¯æŠŠé”ç«äº‰çš„æƒåˆ©äº¤ç»™OnDeck Threadï¼ŒOnDeckéœ€è¦é‡æ–°ç«äº‰é”ã€‚è¿™æ ·è™½ç„¶ç‰ºç‰²äº†ä¸€äº›å…¬å¹³æ€§ï¼Œä½†æ˜¯èƒ½æå¤§çš„æå‡ç³»ç»Ÿçš„ååé‡ï¼Œåœ¨jvmä¸­ï¼Œä¹ŸæŠŠè¿™ç§é€‰æ‹©è¡Œä¸ºç§°ä¸ºç«äº‰åˆ‡æ¢ã€‚â€‹ OnDeck Thread è·å–åˆ°é”èµ„æºåä¼šå˜æˆOwner Threadã€‚æ— æ³•è·å¾—é”çš„OnDeck Threadåˆ™ä¼šä¾ç„¶ç•™åœ¨EntryListä¸­ï¼Œè€ƒè™‘åˆ°å…¬å¹³æ€§ï¼ŒOnDeck Threadåœ¨EntryListä¸­çš„ä½ç½®ä¸å‘ç”Ÿå˜åŒ–ã€‚â€‹ åœ¨OnDeck Threadæˆä¸ºOwnerçš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªä¸å…¬å¹³çš„äº‹æƒ…ï¼Œå°±æ˜¯åæ¥çš„æ–°æŠ¢é”çº¿ç¨‹å¯èƒ½ç›´æ¥é€šè¿‡casè‡ªæ—‹æˆä¸ºOwnerè€ŒæŠ¢åˆ°é”ã€‚â€‹ WaitSetå¦‚æœOwnerçº¿ç¨‹è¢«Object.wait()é˜»å¡ï¼Œå°±è½¬ç§»åˆ°WaitSeté˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°æŸä¸ªæ—¶åˆ»é€šè¿‡Object.notify()å”¤é†’ï¼Œè¯¥çº¿ç¨‹å°±ä¼šé‡æ–°è¿›å…¥EntryListä¸­ã€‚â€‹ 4ï¼‰é‡é‡çº§é”çš„å¼€é”€å¤„äºContentionListï¼ŒEntryListï¼ŒWaitSetä¸­çš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œçº¿ç¨‹çš„é˜»å¡æˆ–è€…å”¤é†’éƒ½éœ€è¦æ“ä½œç³»ç»Ÿæ¥å¸®å¿™ï¼ŒLinuxå†…æ ¸ä¸‹é‡‡ç”¨pthread_mutex_lockç³»ç»Ÿè°ƒç”¨å®ç°ï¼Œè¿›ç¨‹éœ€è¦ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ã€‚â€‹ Linuxç³»ç»Ÿä½“ç³»æ¶æ„åˆ†ä¸ºç”¨æˆ·æ€å’Œå†…æ ¸æ€ã€‚â€‹ Linuxç³»ç»Ÿçš„å†…æ ¸æ˜¯ä¸€ç»„ç‰¹æ®Šçš„è½¯ä»¶ç¨‹åºï¼Œè´Ÿè´£æ§åˆ¶è®¡ç®—æœºçš„ç¡¬ä»¶èµ„æºï¼Œä¾‹å¦‚åè°ƒcpuèµ„æºï¼Œåˆ†é…å†…å­˜èµ„æºï¼Œå¹¶ä¸”æä¾›ç¨³å®šçš„ç¯å¢ƒä¾›åº”ç”¨ç¨‹åºè¿è¡Œã€‚åº”ç”¨ç¨‹åºæ´»åŠ¨çš„ç©ºé—´ä¸ºç”¨æˆ·ç©ºé—´ï¼Œåº”ç”¨ç¨‹åºçš„æ‰§è¡Œå¿…é¡»ä¾æ‰˜äºå†…æ ¸æä¾›çš„èµ„æºï¼ŒåŒ…æ‹¬cpuèµ„æºï¼Œå­˜å‚¨èµ„æºï¼Œioèµ„æºç­‰ã€‚â€‹ ç”¨æˆ·æ€ä¸å†…æ ¸æ€æœ‰å„è‡ªä¸“ç”¨çš„å†…å­˜ç©ºé—´ï¼Œä¸“ç”¨çš„å¯„å­˜å™¨ç­‰ï¼Œè¿›ç¨‹ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€éœ€è¦ä¼ é€’è®¸å¤šå˜é‡ï¼Œå‚æ•°ç»™å†…æ ¸ï¼Œå†…æ ¸ä¹Ÿéœ€è¦ä¿æŠ¤å¥½ç”¨æˆ·æ€åœ¨åˆ‡æ¢æ—¶çš„ä¸€äº›å¯„å­˜å™¨å€¼ï¼Œå˜é‡ç­‰ï¼Œä»¥ä¾¿å†…æ ¸æ€è°ƒç”¨ç»“æŸååˆ‡æ¢å›ç”¨æˆ·æ€ç»§ç»­å·¥ä½œã€‚â€‹ ç”¨æˆ·æ€çš„è¿›ç¨‹èƒ½å¤Ÿè®¿é—®çš„èµ„æºå—åˆ°äº†æå¤§çš„æ§åˆ¶ï¼Œè€Œè¿è¡Œåœ¨å†…æ ¸æ€çš„è¿›ç¨‹å¯ä»¥â€œä¸ºæ‰€æ¬²ä¸ºâ€ã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œä¹Ÿå¯ä»¥è¿è¡Œåœ¨å†…æ ¸æ€ï¼Œé‚£ä¹ˆè‚¯å®šå­˜åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢çš„è¿‡ç¨‹ã€‚è¿›ç¨‹ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€åˆ‡æ¢ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸‰ç§æ–¹å¼:â€‹ (1)ç¡¬ä»¶ä¸­æ–­ã€‚ç¡¬ä»¶ä¸­æ–­ä¹Ÿç§°ä¸ºå¤–è®¾ä¸­æ–­ï¼Œå½“å¤–è®¾å®Œæˆç”¨æˆ·çš„è¯·æ±‚æ—¶ä¼šå‘CPUå‘é€ä¸­æ–­ä¿¡å·ã€‚â€‹ (2)ç³»ç»Ÿè°ƒç”¨ã€‚å…¶å®ç³»ç»Ÿè°ƒç”¨æœ¬èº«å°±æ˜¯ä¸­æ–­ï¼Œåªä¸è¿‡æ˜¯è½¯ä»¶ä¸­æ–­ï¼Œè·Ÿç¡¬ä»¶ä¸­æ–­ä¸åŒã€‚â€‹ (3)å¼‚å¸¸ã€‚å¦‚æœå½“å‰è¿›ç¨‹è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œè¿™ä¸ªæ—¶å€™å‘ç”Ÿäº†å¼‚å¸¸äº‹ä»¶(ä¾‹å¦‚ç¼ºé¡µå¼‚å¸¸)ï¼Œå°±ä¼šè§¦å‘åˆ‡æ¢ã€‚â€‹ ç”¨æˆ·æ€æ˜¯åº”ç”¨ç¨‹åºè¿è¡Œçš„ç©ºé—´ï¼Œä¸ºäº†èƒ½è®¿é—®åˆ°å†…æ ¸ç®¡ç†çš„èµ„æº(ä¾‹å¦‚CPUã€å†…å­˜ã€I/0)ï¼Œå¯ä»¥é€šè¿‡å†…æ ¸æ€æ‰€æä¾›çš„è®¿é—®æ¥å£å®ç°ï¼Œè¿™äº›æ¥å£å°±å«ç³»ç»Ÿè°ƒç”¨ã€‚pthredmutexlockç³»ç»Ÿè°ƒç”¨æ˜¯å†…æ ¸æ€ä¸ºç”¨æˆ·æ€è¿›ç¨‹æä¾›çš„Linuxå†…æ ¸æ€ä¸‹äº’æ–¥é”çš„è®¿é—®æœºåˆ¶ï¼Œæ‰€ä»¥ä½¿ç”¨pthread_mutex_lockç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè¿›ç¨‹éœ€è¦ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œè€Œè¿™ç§åˆ‡æ¢æ˜¯éœ€è¦æ¶ˆè€—å¾ˆå¤šæ—¶é—´çš„ï¼Œæœ‰å¯èƒ½æ¯”ç”¨æˆ·æ‰§è¡Œä»£ç çš„æ—¶é—´è¿˜è¦é•¿ã€‚â€‹ ç”±äºjvmè½»é‡çº§é”ä½¿ç”¨casè¿›è¡Œè‡ªæ—‹æŠ¢é”ï¼Œè¿™äº›casæ“ä½œéƒ½å¤„äºç”¨æˆ·æ€ä¸‹ï¼Œè¿›ç¨‹ä¸å­˜åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„è¿è¡Œåˆ‡æ¢ï¼Œå› æ­¤jvmè½»é‡çº§é”å¼€é”€æ¯”è¾ƒå°ã€‚è€Œjvmé‡é‡çº§é”ä½¿ç”¨äº†Linuxå†…æ ¸æ€ä¸‹çš„äº’æ–¥é”ï¼Œè¿™æ˜¯é‡é‡çº§é”å¼€é”€å¾ˆå¤§çš„åŸå› ã€‚ 4ï¼Œå›é¡¾çº¿ç¨‹çš„ç«äº‰â€‹ å‡å¦‚æœ‰è¿™æ ·ä¸€ä¸ªåŒæ­¥ä»£ç å—ï¼Œå­˜åœ¨ Thread#1ã€Thread#2 ç­‰å¤šä¸ªçº¿ç¨‹ï¼šâ€‹ 123synchronized (lock) &#123;// do something&#125; æƒ…å†µä¸€ï¼šåªæœ‰ Thread#1 ä¼šè¿›å…¥ä¸´ç•ŒåŒºï¼›â€‹ æƒ…å†µäºŒï¼šThread#1 å’Œ Thread#2 äº¤æ›¿è¿›å…¥ä¸´ç•ŒåŒº,ç«äº‰ä¸æ¿€çƒˆï¼›â€‹ æƒ…å†µä¸‰ï¼šThread#1/Thread#2/Thread3â€¦ åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œç«äº‰æ¿€çƒˆã€‚â€‹ 1ï¼‰åå‘é”â€‹ æ­¤æ—¶å½“ Thread#1 è¿›å…¥ä¸´ç•ŒåŒºæ—¶ï¼ŒJVM ä¼šå°† lockObject çš„å¯¹è±¡å¤´ Mark Word çš„é”æ ‡å¿—ä½è®¾ä¸ºâ€œ01â€ï¼ŒåŒæ—¶ä¼šç”¨ CAS æ“ä½œæŠŠ Thread#1 çš„çº¿ç¨‹ ID è®°å½•åˆ° Mark Word ä¸­ï¼Œæ­¤æ—¶è¿›å…¥åå‘æ¨¡å¼ã€‚æ‰€è°“â€œåå‘â€ï¼ŒæŒ‡çš„æ˜¯è¿™ä¸ªé”ä¼šåå‘äº Thread#1ï¼Œè‹¥æ¥ä¸‹æ¥æ²¡æœ‰å…¶ä»–çº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œåˆ™ Thread#1 å†å‡ºå…¥ä¸´ç•ŒåŒºæ— éœ€å†æ‰§è¡Œä»»ä½•åŒæ­¥æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè‹¥åªæœ‰Thread#1 ä¼šè¿›å…¥ä¸´ç•ŒåŒºï¼Œå®é™…ä¸Šåªæœ‰ Thread#1 åˆæ¬¡è¿›å…¥ä¸´ç•ŒåŒºæ—¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œï¼Œä»¥åå†å‡ºå…¥ä¸´ç•ŒåŒºéƒ½ä¸ä¼šæœ‰åŒæ­¥æ“ä½œå¸¦æ¥çš„å¼€é”€ã€‚â€‹ 2ï¼‰è½»é‡çº§é”åå‘é”çš„åœºæ™¯å¤ªè¿‡äºç†æƒ³åŒ–ï¼Œæ›´å¤šçš„æ—¶å€™æ˜¯ Thread#2 ä¹Ÿä¼šå°è¯•è¿›å…¥ä¸´ç•ŒåŒºï¼Œ å¦‚æœ Thread#2 ä¹Ÿè¿›å…¥ä¸´ç•ŒåŒºä½†æ˜¯Thread#1 è¿˜æ²¡æœ‰æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—æ—¶ï¼Œä¼šæš‚åœ Thread#1å¹¶ä¸”å‡çº§åˆ°è½»é‡çº§é”ã€‚Thread#2 é€šè¿‡è‡ªæ—‹å†æ¬¡å°è¯•ä»¥è½»é‡çº§é”çš„æ–¹å¼æ¥è·å–é”ã€‚â€‹ 3ï¼‰é‡é‡çº§é”â€‹ å¦‚æœ Thread#1 å’Œ Thread#2 æ­£å¸¸äº¤æ›¿æ‰§è¡Œï¼Œé‚£ä¹ˆè½»é‡çº§é”åŸºæœ¬èƒ½å¤Ÿæ»¡è¶³é”çš„éœ€æ±‚ã€‚ä½†æ˜¯å¦‚æœ Thread#1 å’Œ Thread#2åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œé‚£ä¹ˆè½»é‡çº§é”å°±ä¼šè†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œæ„å‘³ç€ Thread#1 çº¿ç¨‹è·å¾—äº†é‡é‡çº§é”çš„æƒ…å†µä¸‹ï¼ŒThread#2å°±ä¼šè¢«é˜»å¡ã€‚â€‹ äº”ï¼Œç»“åˆwaitï¼Œnotifyè¢«é˜»å¡çš„çº¿ç¨‹ä»€ä¹ˆæ—¶å€™è¢«å”¤é†’ï¼Œå–å†³äºè·å¾—é”çš„çº¿ç¨‹ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—å¹¶ä¸”é‡Šæ”¾é”ã€‚é‚£æ€ä¹ˆåšåˆ°æ˜¾ç¤ºæ§åˆ¶å‘¢ï¼Ÿæˆ‘ä»¬å°±éœ€è¦å€Ÿ åŠ© ä¸€ ä¸ª ä¿¡ å·æœº åˆ¶ ï¼š åœ¨ Object å¯¹ è±¡ ä¸­ ï¼Œæ ä¾› äº†wait/notify/notifyallï¼Œå¯ä»¥ç”¨äºæ§åˆ¶çº¿ç¨‹çš„çŠ¶æ€ 1ï¼Œwait/notify/notifyallçš„åŸºæœ¬æ¦‚å¿µâ€‹ waitï¼šè¡¨ç¤ºæŒæœ‰å¯¹è±¡é”çš„çº¿ç¨‹ A å‡†å¤‡é‡Šæ”¾å¯¹è±¡é”æƒé™ï¼Œé‡Šæ”¾ cpu èµ„æºå¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚â€‹ notifyï¼šè¡¨ç¤ºæŒæœ‰å¯¹è±¡é”çš„çº¿ç¨‹ A å‡†å¤‡é‡Šæ”¾å¯¹è±¡é”æƒé™ï¼Œé€šçŸ¥ jvm å”¤é†’æŸä¸ªç«äº‰è¯¥å¯¹è±¡é”çš„çº¿ç¨‹ Xã€‚çº¿ç¨‹ Asynchronized ä»£ç æ‰§è¡Œç»“æŸå¹¶ä¸”é‡Šæ”¾äº†é”ä¹‹åï¼Œçº¿ç¨‹ X ç›´æ¥è·å¾—å¯¹è±¡é”æƒé™ï¼Œå…¶ä»–ç«äº‰çº¿ç¨‹ç»§ç»­ç­‰å¾…(å³ä½¿çº¿ç¨‹ X åŒæ­¥å®Œæ¯•ï¼Œé‡Šæ”¾å¯¹è±¡é”ï¼Œå…¶ä»–ç«äº‰çº¿ç¨‹ä»ç„¶ç­‰å¾…ï¼Œç›´è‡³æœ‰æ–°çš„ notify ,notifyAll è¢«è°ƒç”¨)ã€‚â€‹ notifyAllï¼šnotifyall å’Œ notify çš„åŒºåˆ«åœ¨äºï¼ŒnotifyAll ä¼šå”¤é†’æ‰€æœ‰ç«äº‰åŒä¸€ä¸ªå¯¹è±¡é”çš„æ‰€æœ‰çº¿ç¨‹ï¼Œå½“å·²ç»è·å¾—é”çš„çº¿ç¨‹A é‡Šæ”¾é”ä¹‹åï¼Œæ‰€æœ‰è¢«å”¤é†’çš„çº¿ç¨‹éƒ½æœ‰å¯èƒ½è·å¾—å¯¹è±¡é”æƒé™ã€‚â€‹ ä¸‰ä¸ªæ–¹æ³•éƒ½å¿…é¡»åœ¨ synchronized åŒæ­¥å…³é”®å­— æ‰€ é™ å®š çš„ ä½œ ç”¨ åŸŸ ä¸­ è°ƒ ç”¨ ï¼Œ å¦ åˆ™ ä¼š æŠ¥ é”™java.lang.IllegalMonitorStateException ï¼Œæ„æ€æ˜¯å› ä¸ºæ²¡æœ‰åŒæ­¥ï¼Œæ‰€ä»¥çº¿ç¨‹å¯¹å¯¹è±¡é”çš„çŠ¶æ€æ˜¯ä¸ç¡®å®šçš„ï¼Œä¸èƒ½è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚ é€šè¿‡åŒæ­¥æœºåˆ¶æ¥ç¡®ä¿çº¿ç¨‹ä» wait æ–¹æ³•è¿”å›æ—¶èƒ½å¤Ÿæ„ŸçŸ¥åˆ° notify çº¿ç¨‹å¯¹å˜é‡åšå‡ºçš„ä¿®æ”¹ 2ï¼Œwaity /notify çš„åŸºæœ¬ä½¿ç”¨12345678910111213141516171819202122232425262728293031323334353637public class SyncTest &#123; public static void main(String[] args) &#123; Share share = new Share(); new Thread(() -&gt; &#123; for (int i = 0; i &lt; 10; i++) try &#123; share.add(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;, &quot;AAA&quot;).start(); new Thread(() -&gt; &#123; for (int i = 0; i &lt; 10; i++) try &#123; share.sub(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;, &quot;BBB&quot;).start(); &#125;&#125;class Share &#123; private int num = 0; public synchronized void add()throws Exception&#123; //åˆ¤æ–­ if (num!=0) this.wait(); System.out.println(Thread.currentThread().getName()+&quot;æ‰§è¡Œäº†ï¼š&quot;+ ++num); this.notify(); &#125; public synchronized void sub()throws Exception&#123; if (num==0) this.wait(); System.out.println(Thread.currentThread().getName()+&quot;æ‰§è¡Œäº†ï¼š&quot;+ --num); this.notify(); &#125;&#125; 3ï¼Œwaity /notify çš„åŸºæœ¬åŸç† çº¿ç¨‹Aæ‰§è¡ŒMonitorEnteræŒ‡ä»¤æˆåŠŸï¼Œè·å–åˆ°é”ã€‚ çº¿ç¨‹Aæ‰§è¡ŒObject.wait()ï¼Œçº¿ç¨‹Aå°†è‡ªå·±åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—å¹¶é‡Šæ”¾é”ã€‚ çº¿ç¨‹Bæ‰§è¡ŒMonitorEnteræŒ‡ä»¤æˆåŠŸï¼Œè·å–åˆ°é”ã€‚ çº¿ç¨‹Bæ‰§è¡ŒObject.notify(),çº¿ç¨‹Aä»ç­‰å¾…é˜Ÿåˆ—ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œç­‰åˆ°æ”¶åˆ°MonitorExitåï¼Œå‡ºé˜Ÿåˆ—ã€‚ â€‹ å…­ï¼Œsynchronizedçš„å¯é‡å…¥å®ç°åŸç†æ¯ä¸ªé”å¯¹è±¡æ‹¥æœ‰ä¸€ä¸ªé”è®¡æ•°å™¨å’Œä¸€ä¸ªæŒ‡å‘æŒæœ‰è¯¥é”çš„çº¿ç¨‹çš„æŒ‡é’ˆã€‚â€‹ å½“æ‰§è¡Œmonitorenteræ—¶ï¼Œå¦‚æœç›®æ ‡é”å¯¹è±¡çš„è®¡æ•°å™¨ä¸º0ï¼Œé‚£ä¹ˆè¯´æ˜ä»–æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹é”æŒæœ‰ï¼ŒJavaè™šæ‹Ÿæœºä¼šå°†æ”¹é”å¯¹è±¡çš„æŒæœ‰çº¿ç¨‹è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…¶è®¡æ•°å™¨+1.â€‹ åœ¨ç›®æ ‡é”å¯¹è±¡çš„è®¡æ•°å™¨ä¸ä¸º0çš„æƒ…å†µä¸‹ï¼Œå¦‚æœé”å¯¹è±¡çš„æŒæœ‰çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ï¼Œé‚£ä¹ˆJavaè™šæ‹Ÿæœºå¯ä»¥å°†å…¶è®¡æ•°å™¨+1ï¼Œå¦åˆ™éœ€è¦ç­‰å¾…ï¼Œç›´è‡³æŒæœ‰çº¿ç¨‹é‡Šæ”¾é”ã€‚â€‹ å½“æ‰§è¡Œmonitorexitæ—¶ï¼ŒJavaè™šæ‹Ÿæœºåˆ™éœ€è¦å°†é”å¯¹è±¡çš„è®¡æ•°å™¨-1.è®¡æ•°å™¨ä¸º0ä»£è¡¨é‡Šæ”¾é”ã€‚â€‹ 12345678910111213141516171819202122232425public class Demo3 &#123; private static Lock lock=new ReentrantLock(); public static void main(String[] args) &#123; m1(); &#125; public static void m1()&#123; new Thread(()-&gt;&#123; try &#123; lock.lock(); System.out.println(&quot;ç¬¬ä¸€æ¬¡åŠ é”&quot;); try &#123; lock.lock(); System.out.println(&quot;ç¬¬2æ¬¡åŠ é”&quot;); &#125;finally &#123; lock.unlock(); &#125; &#125;finally &#123; lock.unlock(); &#125; &#125;,&quot;m1&quot;).start(); &#125;&#125;","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"Unsafe APIè¯¦è§£","slug":"JUC/Unsafe APIè¯¦è§£","date":"2022-01-11T11:05:27.570Z","updated":"2022-01-11T11:30:55.633Z","comments":true,"path":"2022/01/11/JUC/Unsafe APIè¯¦è§£/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/Unsafe%20API%E8%AF%A6%E8%A7%A3/","excerpt":"","text":"ä¸€ï¼ŒUnsafeä½¿ç”¨å»ºè®® unsafeæœ‰å¯èƒ½åœ¨æœªæ¥å‡ å¹´çš„jdkç‰ˆæœ¬ä¸­ç§»é™¤æˆ–è€…ä¸å…è®¸javaåº”ç”¨ä»£ç ä½¿ç”¨ï¼Œè¿™ä¸€ç‚¹å¯èƒ½ä¼šå¯¼è‡´ä½¿ç”¨äº†unsafeçš„åº”ç”¨æ— æ³•è¿è¡Œåœ¨é«˜ç‰ˆæœ¬çš„jdkä¸­ã€‚ unsafeä¸å°‘æ–¹æ³•ä¸­å¿…é¡»æä¾›åŸå§‹åœ°å€ï¼ˆå†…å­˜åœ°å€ï¼‰å’Œè¢«æ›¿æ¢å¯¹è±¡çš„åœ°å€ï¼Œåç§»é‡è¦è‡ªå·±è®¡ç®—ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜å°±æ˜¯jvmçº§åˆ«çš„å´©æºƒå¼‚å¸¸ã€‚ unsafeæä¾›çš„ç›´æ¥å†…å­˜è®¿é—®çš„æ–¹æ³•ä¸­ä½¿ç”¨çš„å†…å­˜ä¸å—jvmç®¡ç†ï¼ˆæ— æ³•è¢«gcï¼‰ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†ï¼Œä¸€æ—¦å‡ºç°ç–å¿½å¯èƒ½æˆä¸ºå†…å­˜æ³„æ¼çš„æºå¤´ã€‚ â€‹ äºŒï¼Œunsafeè¯¦è§£unsafeç±»ä¸­ä¸€å…±æœ‰82ä¸ªpublic native ä¿®é¥°çš„æ–¹æ³•ï¼Œè¿˜æœ‰å‡ åä¸ªåŸºäºè¿™ä¸ª82ä¸ªæ–¹æ³•çš„å…¶ä»–æ–¹æ³•ã€‚â€‹ 1.åˆå§‹åŒ–123456789101112131415161718private static native void registerNatives();static &#123; registerNatives(); sun.reflect.Reflection.registerMethodsToFilter(Unsafe.class, &quot;getUnsafe&quot;);&#125;private Unsafe() &#123;&#125;private static final Unsafe theUnsafe = new Unsafe();@CallerSensitivepublic static Unsafe getUnsafe() &#123; Class&lt;?&gt; caller = Reflection.getCallerClass(); if (!VM.isSystemDomainLoader(caller.getClassLoader())) throw new SecurityException(&quot;Unsafe&quot;); return theUnsafe;&#125; æ–°å»ºä¸€ä¸ªunsafeå®ä¾‹å‘½åä¸ºtheunsafeï¼Œé€šè¿‡é™æ€æ–¹æ³•getUnsafeè·å–ï¼Œè·å–çš„æ—¶å€™éœ€è¦åšæƒé™åˆ¤æ–­ï¼Œç”±æ­¤å¯è§ï¼Œunsafeç±»çš„è®¾è®¡ä½¿ç”¨äº†å•ä¾‹è®¾è®¡æ¨¡å¼ï¼Œæ„é€ å™¨ç§æœ‰åŒ–äº†ã€‚unsafeç±»åšäº†é™åˆ¶ï¼Œå¦‚æœæ˜¯æ™®é€šçš„è°ƒç”¨çš„è¯ï¼Œä»–ä¼šæŠ›å‡ºä¸€ä¸ªæƒé™å¼‚å¸¸ï¼Œåªæœ‰ç”±å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ‰èƒ½ä½¿ç”¨è¿™ä¸ªç±»çš„æ–¹æ³•ã€‚æœ€ç®€å•çš„æ–¹å¼æ˜¯é€šè¿‡åå°„è·å–unsafeå®ä¾‹ã€‚â€‹ 123Field f = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);f.setAccessible(true);Unsafe unsafe = (Unsafe) f.get(null); 2.ç±»ï¼Œå¯¹è±¡å’Œå˜é‡ç›¸å…³æ–¹æ³•2.1 getObjectâ€‹ é€šè¿‡ç»™å®šçš„javaå˜é‡è·å–å¼•ç”¨å€¼ã€‚è¿™é‡Œå®é™…ä¸Šæ˜¯è·å–ä¸€ä¸ªjavaå¯¹è±¡oä¸­ï¼Œè·å–åç§»åœ°å€==offsetçš„å±æ€§çš„å€¼ã€‚â€‹ æ­¤æ–¹æ³•å¯ä»¥çªç ´ä¿®é¥°ç¬¦çš„é™åˆ¶ã€‚ç±»ä¼¼çš„æ–¹æ³•è¿˜æœ‰getIntï¼ŒgetDoubleç­‰ã€‚â€‹ 2.2 putObjectå°†å¼•ç”¨å€¼å­˜å‚¨åˆ°ç»™å®šçš„javaå˜é‡ä¸­ï¼Œè¿™é‡Œå®é™…ä¸Šæ˜¯è®¾ç½®ä¸€ä¸ªjavaå¯¹è±¡oä¸­åç§»åœ°å€ä¸ºoffsetçš„å±æ€§çš„å€¼ä¸ºxã€‚â€‹ æ­¤æ–¹æ³•å¯ä»¥çªç ´ä¿®é¥°ç¬¦çš„é™åˆ¶ã€‚ç±»ä¼¼çš„æ–¹æ³•è¿˜æœ‰putIntï¼ŒputDoubleç­‰ã€‚â€‹ 2.3 getObjectVolatileâ€‹ æ­¤æ–¹æ³•å’Œä¸Šé¢çš„getObjectåŠŸèƒ½ç±»ä¼¼ï¼Œä¸è¿‡é™„åŠ äº†volatileï¼Œå¼ºåˆ¶ä»ä¸»å­˜ä¸­è·å–å±æ€§å€¼ã€‚â€‹ è¿™ä¸ªæ–¹æ³•è¦æ±‚è¢«ä½¿ç”¨çš„å±æ€§è¢«volatileä¿®é¥°ï¼Œå¦åˆ™å’ŒgetObjectæ²¡æœ‰åŒºåˆ«ã€‚â€‹ 2.4 putObjectVolatileâ€‹ æ­¤æ–¹æ³•å’Œä¸Šé¢çš„putObjectåŠŸèƒ½ç±»ä¼¼ï¼Œä¸è¿‡é™„åŠ äº†volatileï¼Œä¹Ÿå°±æ˜¯è®¾ç½®å€¼å¾—æ—¶å€™å¼ºåˆ¶åˆ·æ–°çš„ä¸»å­˜ï¼Œä»è€Œä¿è¯è¿™äº›å˜æ›´å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚â€‹ 2.5 putOrderedObjectè®¾ç½®oå¯¹è±¡ä¸­offsetåç§»åœ°å€å¯¹åº”çš„Objectå‹fieldçš„å€¼ä¸ºæŒ‡å®šå€¼xã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰åºæˆ–è€…æœ‰å»¶è¿Ÿçš„putObjectVolatileæ–¹æ³•ï¼Œå¹¶ä¸”ä¸ä¿è¯å€¼å¾—æ”¹å˜ç«‹é©¬è¢«å…¶ä»–çº¿ç¨‹çœ‹åˆ°ã€‚â€‹ åªæœ‰åœ¨fieldè¢«volatileä¿®é¥°çš„æ—¶å€™æœŸæœ›è¢«ä¿®æ”¹çš„æ—¶å€™æ‰ä¼šç”Ÿæ•ˆâ€‹ 2.6 staticFieldOffsetè¿”å›ç»™å®šçš„é™æ€å±æ€§åœ¨ä»–çš„ç±»çš„å­˜å‚¨åˆ†é…ä¸­çš„ä½ç½®ï¼ˆåç§»åœ°å€ï¼‰ã€‚è¿™ä¸ªæ–¹æ³•ä»…ä»…é’ˆå¯¹é™æ€å±æ€§ï¼Œéé™æ€å±æ€§è°ƒç”¨ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚â€‹ 2.7 objectFieldOffsetâ€‹ è¿”å›ç»™å®šçš„éé™æ€å±æ€§åœ¨ä»–çš„ç±»çš„å­˜å‚¨åˆ†é…ä¸­çš„ä½ç½®ï¼ˆåç§»åœ°å€ï¼‰ã€‚è¿™ä¸ªæ–¹æ³•ä»…ä»…é’ˆå¯¹éé™æ€å±æ€§ï¼Œé™æ€å±æ€§è°ƒç”¨ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚â€‹ 2.8 staticFieldBaseâ€‹ è¿”å›ç»™å®šçš„é™æ€å±æ€§çš„ä½ç½®ï¼Œé…åˆstaticFieldOffsetä½¿ç”¨ã€‚å®é™…ä¸Šè¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼å°±æ˜¯é™æ€å±æ€§æ‰€åœ¨çš„Classå¯¹è±¡çš„ä¸€ä¸ªå†…å­˜å¿«ç…§ã€‚â€‹ 2.9 shouldBeInitializedâ€‹ æ£€æµ‹ç»™å®šçš„ç±»æ˜¯å¦éœ€è¦åˆå§‹åŒ–ã€‚é€šå¸¸éœ€è¦ä½¿ç”¨åœ¨è·å–ä¸€ä¸ªç±»çš„é™æ€å±æ€§çš„æ—¶å€™ï¼ˆä¸€ä¸ªç±»å¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œä»–çš„é™æ€å±æ€§ä¹Ÿä¸ä¼šåˆå§‹åŒ–ï¼‰ã€‚â€‹ 2.10 arrayIndexScaleè¿”å›æ•°ç»„ç±»å‹çš„æ¯”ä¾‹å› å­ï¼ˆå…¶å®å°±æ˜¯æ•°æ®ä¸­å…ƒç´ åç§»é‡åœ°å€çš„å¢é‡ï¼Œå› ä¸ºæ•°ç»„ä¸­çš„å…ƒç´ åœ°å€æ˜¯è¿ç»­çš„ï¼‰ã€‚â€‹ 2.11 arrayBaseOffsetâ€‹ è¿”å›æ•°ç»„ç±»å‹çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€ï¼ˆåŸºç¡€åç§»åœ°å€ï¼‰ã€‚å¦‚æœarrayIndexScaleæ–¹æ³•è¿”å›çš„æ¯”ä¾‹å› å­ä¸ä¸º0ï¼Œå¯ä»¥é€šè¿‡ç»“åˆåŸºç¡€åç§»åœ°å€å’Œæ¯”ä¾‹å› å­è®¿é—®æ•°ç»„çš„æ‰€æœ‰å…ƒç´ ã€‚â€‹ 3.å†…å­˜ç®¡ç†3.1 allocateMemoryåˆ†é…ä¸€å—æ–°çš„æœ¬åœ°å†…å­˜ï¼Œé€šè¿‡bytesæŒ‡å®šå†…å­˜å—çš„å¤§å°(å•ä½æ˜¯byte)ï¼Œè¿”å›æ–°å¼€è¾Ÿçš„å†…å­˜çš„åœ°å€ã€‚å¦‚æœå†…å­˜å—çš„å†…å®¹ä¸è¢«åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå®ƒä»¬ä¸€èˆ¬ä¼šå˜æˆå†…å­˜åƒåœ¾ã€‚â€‹ ç”Ÿæˆçš„æœ¬æœºæŒ‡é’ˆæ°¸è¿œä¸ä¼šä¸ºé›¶ï¼Œå¹¶å°†å¯¹æ‰€æœ‰å€¼ç±»å‹è¿›è¡Œå¯¹é½ã€‚å¯ä»¥é€šè¿‡freelemoryæ–¹æ³•é‡Šæ”¾å†…å­˜å— æˆ–è€…é€šè¿‡reallocatelemoryæ–¹æ³•è°ƒæ•´å†…å­˜å—å¤§å°ã€‚â€‹ byteså€¼ä¸ºè´Ÿæ•°æˆ–è€…è¿‡å¤§ä¼šæŠ›å‡ºIIlegalArgumentExceptionå¼‚å¸¸ï¼Œå¦‚æœç³»ç»Ÿæ‹’ç»åˆ†é…å†…å­˜ä¼šæŠ›å‡ºOut( OfMemoryErrorå¼‚å¸¸ã€‚â€‹ 3.2 reallocateMemoryé€šè¿‡æŒ‡å®šçš„å†…å­˜åœ°å€addressé‡æ–°è°ƒæ•´æœ¬åœ°å†…å­˜å—çš„å¤§å°ï¼Œè°ƒæ•´åçš„å†…å­˜å—å¤§å°é€šè¿‡bytesæŒ‡å®š(å•ç«‹ä¸ºbyte)ã€‚å¯ä»¥é€šè¿‡freelemoryæ–¹æ³•é‡Šæ”¾å†…å­˜å—ï¼Œæˆ–è€…é€šè¿‡reallocateMemoryæ–¹æ³•è°ƒæ•´å†…å­˜å—å¤§å°ã€‚byteså€¼ä¸ºè´Ÿæ•°æˆ–è€…è¿‡å¤§ä¼šæŠ›å‡ºIllegalArgumentEx ceptionå¼‚å¸¸ï¼Œå¦‚æœç³»ç»Ÿæ‹’ç»åˆ†é…å†…å­˜ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚â€‹ 3.3 freeMemoryé‡Šæ”¾é€šè¿‡allocatelemoryæ–¹æ³•ç”³è¯·çš„å†…å­˜â€‹ 3.4 setMemoryå°†ç»™å®šå†…å­˜å—ä¸­çš„æ‰€æœ‰å­—èŠ‚è®¾ç½®ä¸ºå›ºå®šå€¼(é€šå¸¸æ˜¯0)ã€‚å†…å­˜å—çš„åœ°å€ç”±å¯¹è±¡å¼•ç”¨oå’Œåç§»åœ°å€å…±åŒå†³å®šï¼Œå¦‚æœå¯¹è±¡å¼•ç”¨oä¸ºnullï¼Œoffsetå°±æ˜¯ç»å¯¹åœ°å€ã€‚â€‹ ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯å†…å­˜å—çš„å¤§å°ï¼Œå¦‚æœä½¿ç”¨allocatelenoryè¿›è¡Œå†…å­˜å¼€è¾Ÿçš„è¯ï¼Œè¿™é‡Œçš„å€¼åº”è¯¥å’Œall ocatelemoryçš„å‚æ•°ä¸€è‡´ã€‚valueå°±æ˜¯è®¾ç½®çš„å›ºå®šå€¼ï¼Œä¸€èˆ¬ä¸º0ã€‚â€‹ 4.å¤šçº¿ç¨‹åŒæ­¥4.1 monitorEnteré”å®šå¯¹è±¡ï¼Œå¿…é¡»é€šè¿‡nonitorExitæ–¹æ³•æ‰èƒ½è§£é”ã€‚æ­¤æ–¹æ³•ç»è¿‡å®éªŒæ˜¯å¯ä»¥é‡å…¥çš„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼Œç„¶åé€šè¿‡å¤šæ¬¡è°ƒç”¨monitorExitè¿›è¡Œè§£é”ã€‚â€‹ â€‹ 4.2 monitorExitâ€‹ è§£é”å¯¹è±¡ï¼Œå‰ææ˜¯å¯¹è±¡å¿…é¡»å·²ç»è°ƒç”¨monitorEnterè¿›è¡ŒåŠ é”ï¼Œå¦åˆ™æŠ›å‡ºIIlegalMonitorStateExceptionå¼‚å¸¸ã€‚â€‹ 4.3 tryMonitorEnterå°è¯•é”å®šå¯¹è±¡ï¼Œå¦‚æœåŠ é”æˆåŠŸè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚å¿…é¡»é€šè¿‡monitorExitæ–¹æ³•æ‰èƒ½è§£é”ã€‚â€‹ 4.4 compareAndSwapObjecté’ˆå¯¹Objectå¯¹è±¡è¿›è¡ŒCASæ“ä½œã€‚å³æ˜¯å¯¹åº”Javaå˜é‡å¼•ç”¨oï¼ŒåŸå­æ€§åœ°æ›´æ–°oä¸­åç§»åœ°å€ä¸ºoffsetçš„å±æ€§çš„å€¼ä¸ºxï¼Œå½“ä¸”ä»…å½“åç§»åœ°å€ä¸ºoffsetçš„å±æ€§çš„å½“å‰å€¼ä¸ºexpectedæ‰ä¼šæ›´æ–°æˆåŠŸè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚â€‹ o:ç›®æ ‡Javaå˜é‡å¼•ç”¨ã€‚â€‹ offset:ç›®æ ‡Javaå˜é‡ä¸­çš„ç›®æ ‡å±æ€§çš„åç§»åœ°å€ã€‚â€‹ expected:ç›®æ ‡Javaå˜é‡ä¸­çš„ç›®æ ‡å±æ€§çš„æœŸæœ›çš„å½“å‰å€¼ã€‚ x:ç›®æ ‡Javaå˜é‡ä¸­çš„ç›®æ ‡å±æ€§çš„ç›®æ ‡æ›´æ–°å€¼ã€‚â€‹ ç±»ä¼¼çš„æ–¹æ³•æœ‰compareAndSwapIntå’ŒcompareAndSwapLongï¼Œåœ¨Jdk8ä¸­åŸºäºCASæ‰©å±•å‡ºæ¥çš„æ–¹æ³•æœ‰getAn daddIntã€getAndAddLongã€getAndSetIntã€getAndSetLongã€getAndSet0bjectï¼Œå®ƒä»¬çš„ä½œç”¨éƒ½æ˜¯:é€šè¿‡CASè®¾ç½®æ–°çš„å€¼ï¼Œè¿”å›æ—§çš„å€¼ã€‚â€‹ 5.çº¿ç¨‹çš„æŒ‚èµ·å’Œæ¢å¤5.1 unparkæ¢å¤çº¿ç¨‹ï¼Œå¿…é¡»åˆ¶å®šè¦æ¢å¤çš„çº¿ç¨‹threadã€‚â€‹ 5.2 parkâ€‹ é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä¸€ä¸ªunparkæ–¹æ³•å‡ºç°(è¢«è°ƒç”¨)ã€‚â€‹ å‚æ•°:isAbsolute true è¡¨ç¤ºç»å¯¹æ—¶é—´ï¼Œé˜»å¡æ—¶é—´æŒ‰ç…§çº³ç§’è®¡ç®—ã€‚falseè¡¨ç¤ºç›¸å¯¹æ—¶é—´ï¼Œé˜»å¡æ—¶é—´æŒ‰ç…§æ¯«ç§’è®¡ç®—ã€‚â€‹ ç®€å•ç†è§£isAbsolute trueæ—¶ç²¾åº¦æ›´é«˜ã€‚â€‹ å‚æ•°:timeè¡¨ç¤ºé˜»å¡æ—¶é—´ã€‚å€¼ä¸º0æ—¶è¡¨ç¤ºæ— é™æœŸé˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªçº¿ç¨‹é€šè¿‡unsafeunpark(å½“å‰é˜»å¡çº¿ç¨‹)æ‰ä¼šå”¤é†’ã€‚","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"å¹¶å‘ç¼–ç¨‹åŸºç¡€çŸ¥è¯†","slug":"JUC/å¹¶å‘ç¼–ç¨‹åŸºç¡€çŸ¥è¯†","date":"2022-01-11T11:05:18.345Z","updated":"2022-01-11T11:21:07.732Z","comments":true,"path":"2022/01/11/JUC/å¹¶å‘ç¼–ç¨‹åŸºç¡€çŸ¥è¯†/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","excerpt":"","text":"ä¸€ï¼Œçº¿ç¨‹çš„åˆ›å»ºåœ¨javaä¸­ï¼Œæœ‰å¤šç§æ–¹å¼æ¥å®ç°å¤šçº¿ç¨‹ã€‚ç»§æ‰¿Threadç±»ï¼Œå®ç°Runnableæ¥å£ï¼Œä½¿ç”¨ExecutorServiceï¼ŒCallableï¼ŒFutureå®ç°å¸¦è¿”å›ç»“æœçš„å¤šçº¿ç¨‹ã€‚ 1.ç»§æ‰¿Threadç±»åˆ›å»ºçº¿ç¨‹Threadç±»çš„æœ¬è´¨æ˜¯å®ç°äº†Runnableæ¥å£çš„ä¸€ä¸ªå®ä¾‹ï¼Œä»£è¡¨ä¸€ä¸ªçº¿ç¨‹çš„å®ä¾‹ã€‚å¯åŠ¨çº¿ç¨‹çš„å”¯ä¸€æ–¹æ³•å°±æ˜¯é€šè¿‡Threadç±»çš„start()æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œä»–ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œrun()ã€‚ 1234567891011121314151617181920212223242526272829303132333435public class Thread implements Runnable&#123; private Runnable target; @Override public void run() &#123; if (target != null) &#123; target.run(); &#125; &#125; public synchronized void start() &#123; if (threadStatus != 0) throw new IllegalThreadStateException(); group.add(this); boolean started = false; try &#123; start0(); started = true; &#125; finally &#123; try &#123; if (!started) &#123; group.threadStartFailed(this); &#125; &#125; catch (Throwable ignore) &#123; /* do nothing. If start0 threw a Throwable then it will be passed up the call stack */ &#125; &#125; &#125; private native void start0();&#125; 2.å®ç°Runnableæ¥å£åˆ›å»ºå¤šçº¿ç¨‹12345@FunctionalInterfacepublic interface Runnable &#123; public abstract void run();&#125; ä¸ºä»€ä¹ˆå®ç°Runnableæ¥å£èƒ½å¤Ÿå®ç°å¤šçº¿ç¨‹ï¼Ÿ 123456789101112131415161718/** * @author yhd * @description ä½¿ç”¨Runnableæ¥å£åˆ›å»ºå¤šçº¿ç¨‹ * @email yinhuidong2@xiaomi.com * @since 2021/6/27 */public class RunnableTest implements Runnable&#123; public static void main(String[] args) &#123; RunnableTest runnableTest = new RunnableTest(); new Thread(runnableTest).start(); &#125; @Override public void run() &#123; System.out.println(Thread.currentThread().getName()); &#125;&#125; åœ¨Threadç±»é‡Œé¢ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³• 12345678public Thread(Runnable target) &#123; init(null, target, &quot;Thread-&quot; + nextThreadNum(), 0);&#125;private void init(ThreadGroup g, Runnable target, String name, long stackSize, AccessControlContext acc) &#123; this.target = target; &#125; 3.å®ç°callableæ¥å£æ¥åˆ›å»ºçº¿ç¨‹æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦è®©ä¸€ä¸ªæ‰§è¡Œçš„çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»¥åï¼Œæä¾›ä¸€ä¸ªè¿”å›å€¼ç»™åˆ°å½“å‰çš„ä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹éœ€è¦ä¾èµ–è¿™ä¸ªå€¼è¿›è¡Œåç»­çš„é€»è¾‘å¤„ç†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå°±éœ€è¦ç”¨åˆ°å¸¦è¿”å›å€¼çš„çº¿ç¨‹äº†ã€‚Javaä¸­æä¾›äº†è¿™æ ·çš„å®ç°æ–¹å¼ï¼š 12345678910111213141516171819202122232425262728293031/** * @author yhd * @description ä½¿ç”¨Callableæ¥å£åˆ›å»ºå¤šçº¿ç¨‹ * @email yinhuidong2@xiaomi.com * @since 2021/6/27 */public class CallableTest implements Callable &#123; @Override public Object call() throws Exception &#123; System.out.println(&quot;æ­£åœ¨è®¡ç®—ç»“æœ&quot;); return &quot;123&quot;; &#125; public static void main(String[] args) &#123; try &#123; FutureTask task = new FutureTask&lt;&gt;(new CallableTest()); while (task.isDone())&#123; System.out.println(task.get()); &#125; &#125; catch (Exception e) &#123; &#125; finally &#123; &#125; &#125;&#125; äºŒï¼Œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ1.ç”Ÿå‘½å‘¨æœŸçº¿ç¨‹ä¸€å…±æœ‰å…­ç§çŠ¶æ€ï¼ˆNEWã€RUNNABLEã€BLOCKEDã€WAITINGã€TIME_WAITINGã€TERMINATEDï¼‰Newï¼šåˆå§‹åŒ–çŠ¶æ€ï¼Œçº¿ç¨‹è¢«åˆ›å»ºï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è°ƒç”¨start()ã€‚Runnabledï¼šè¿è¡ŒçŠ¶æ€ï¼ŒJavaçº¿ç¨‹æŠŠæ“ä½œç³»ç»Ÿä¸­çš„è¿è¡ŒçŠ¶æ€å’Œå°±ç»ªçŠ¶æ€ç»Ÿç§°ä¸ºè¿è¡Œä¸­çŠ¶æ€ã€‚Blockedï¼šé˜»å¡çŠ¶æ€ï¼Œè¡¨ç¤ºçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹å› ä¸ºæŸç§åŸå› æ”¾å¼ƒäº†CPUçš„ä½¿ç”¨æƒã€‚é˜»å¡ä¹Ÿåˆ†ä¸ºå‡ ç§æƒ…å†µï¼š ç­‰å¾…é˜»å¡ï¼šè¿è¡Œçš„çº¿ç¨‹æ‰§è¡Œwait(),jvmä¼šæŠŠå½“å‰çº¿ç¨‹æ”¾å…¥åˆ°ç­‰å¾…é˜Ÿåˆ— åŒæ­¥é˜»å¡ï¼šè¿è¡Œçš„çº¿ç¨‹åœ¨è·å–å¯¹è±¡çš„åŒæ­¥é”æ—¶ï¼Œè‹¥è¯¥åŒæ­¥é”è¢«å…¶ä»–çº¿ç¨‹å ç”¨äº†ï¼Œé‚£ä¹ˆJVMä¼šæŠŠå½“å‰çº¿ç¨‹æ”¾å…¥åˆ°é”æ± ä¸­ï¼Œä¹Ÿå°±æ˜¯åŒæ­¥é˜Ÿåˆ— å…¶ä»–é˜»å¡ï¼šè¿è¡Œä¸­çš„çº¿ç¨‹æ‰§è¡Œthread.sleep()æˆ–è€…thread.join(),æˆ–è€…å‘å‡ºäº†IOè¯·æ±‚æ—¶ï¼ŒJVMä¼šæŠŠå½“å‰çº¿ç¨‹è®¾ç½®ä¸ºé˜»å¡çŠ¶æ€ï¼Œå½“sleepç»“æŸï¼Œjoinçº¿ç¨‹ç»ˆæ­¢ï¼Œioå¤„ç†å®Œæ¯•åˆ™çº¿ç¨‹æ¢å¤ timeâ€”â€”waitingï¼šè¶…æ—¶ä»¥åè‡ªåŠ¨è¿”å›ã€‚terminatedï¼šç»ˆæ­¢çŠ¶æ€ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚ 2.ä»£ç æ¼”ç¤ºçº¿ç¨‹çŠ¶æ€12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758/** * @author yhd * @description ä»£ç æ¼”ç¤ºçº¿ç¨‹çŠ¶æ€ * @email yinhuidong2@xiaomi.com * @since 2021/6/27 */public class ThreadStatus &#123; public static void main(String[] args) &#123; //time_waiting new Thread(()-&gt;&#123; while (true)&#123; try &#123; TimeUnit.SECONDS.sleep(100); &#125; catch (Exception e) &#123; &#125; finally &#123; &#125; &#125; &#125;,&quot;time_waiting&quot;).start(); //waiting çº¿ç¨‹æ‹¿åˆ°å½“å‰çš„ç±»é”ä»¥åï¼Œæ‰§è¡Œwait() new Thread(()-&gt;&#123; while (true)&#123; synchronized (ThreadStatus.class)&#123; try &#123; ThreadStatus.class.wait(); &#125; catch (Exception e) &#123; &#125; finally &#123; &#125; &#125; &#125; &#125;).start(); //block ä¸¤ä¸ªçº¿ç¨‹ç«äº‰é” new Thread(new BlockedDemo(),&quot;block-01&quot;).start(); new Thread(new BlockedDemo(),&quot;block-02&quot;).start(); &#125; static class BlockedDemo extends Thread &#123; @Override public void run() &#123; synchronized (BlockedDemo.class) &#123; while (true) &#123; try &#123; TimeUnit.SECONDS.sleep(100); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125; &#125; &#125;&#125; 3.é€šè¿‡å·¥å…·æŸ¥çœ‹çº¿ç¨‹çš„çŠ¶æ€jstackæ˜¯javaè™šæ‹Ÿæœºè‡ªå¸¦çš„ä¸€ç§å †æ ˆè·Ÿè¸ªå·¥å…·ã€‚ jstackç”¨äºæ‰“å°ç»™å®šçš„javaè¿›ç¨‹IDæˆ–è€…core file æˆ–è€…è¿œç¨‹è°ƒè¯•æœåŠ¡çš„Java å †æ ˆä¿¡æ¯ã€‚é€šè¿‡ä¸Šé¢çš„ä»£ç æ¼”ç¤ºï¼Œå¯ä»¥çŸ¥é“çº¿ç¨‹åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­å¹¶ä¸æ˜¯å›ºå®šå¤„äºæŸç§çŠ¶æ€ï¼Œè€Œæ˜¯éšç€ä»£ç çš„æ‰§è¡Œåœ¨ä¸åŒçš„çŠ¶æ€ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚ ä¸‰ï¼Œçº¿ç¨‹ç›¸å…³æ–¹æ³•1.å¯åŠ¨è°ƒç”¨start()å»å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå½“run()ä¸­çš„ä»£ç æ‰§è¡Œå®Œæ¯•ä»¥åï¼Œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿå°†ç»ˆæ­¢ã€‚è°ƒç”¨start()çš„è¯­ä¹‰æ˜¯å½“å‰çº¿ç¨‹å‘Šè¯‰jvmï¼Œå¯åŠ¨è°ƒç”¨start()æ–¹æ³•çš„çº¿ç¨‹ã€‚ 1ï¼‰å¯åŠ¨åŸç†å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä¸ºä»€ä¹ˆæ˜¯è°ƒç”¨start()ï¼Œè€Œä¸æ˜¯run()?è°ƒç”¨start()å®é™…ä¸Šæ˜¯è°ƒç”¨ä¸€ä¸ªnativeæ–¹æ³•start0()æ¥å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œé¦–å…ˆstart0()è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨Thread.classçš„é™æ€ä»£ç å—ä¸­æ³¨å†Œçš„ã€‚registerNativesçš„æœ¬åœ°æ–¹æ³•çš„å®šä¹‰åœ¨æ–‡ä»¶Thread.c,Thread.cå®šä¹‰äº†å„ä¸ªæ“ä½œç³»ç»Ÿå¹³å°è¦ç”¨çš„å…³äºçº¿ç¨‹çš„å…¬å…±æ•°æ®å’Œæ“ä½œã€‚ 1234567891011121314151617181920212223242526272829303132333435363738#include &quot;jni.h&quot;#include &quot;jvm.h&quot;#include &quot;java_lang_Thread.h&quot;#define THD &quot;Ljava/lang/Thread;&quot;#define OBJ &quot;Ljava/lang/Object;&quot;#define STE &quot;Ljava/lang/StackTraceElement;&quot;#define ARRAY_LENGTH(a) (sizeof(a)/sizeof(a[0]))static JNINativeMethod methods[] = &#123; &#123;&quot;start0&quot;, &quot;()V&quot;, (void *)&amp;JVM_StartThread&#125;, &#123;&quot;stop0&quot;, &quot;(&quot; OBJ &quot;)V&quot;, (void *)&amp;JVM_StopThread&#125;, &#123;&quot;isAlive&quot;, &quot;()Z&quot;, (void *)&amp;JVM_IsThreadAlive&#125;, &#123;&quot;suspend0&quot;, &quot;()V&quot;, (void *)&amp;JVM_SuspendThread&#125;, &#123;&quot;resume0&quot;, &quot;()V&quot;, (void *)&amp;JVM_ResumeThread&#125;, &#123;&quot;setPriority0&quot;, &quot;(I)V&quot;, (void *)&amp;JVM_SetThreadPriority&#125;, &#123;&quot;yield&quot;, &quot;()V&quot;, (void *)&amp;JVM_Yield&#125;, &#123;&quot;sleep&quot;, &quot;(J)V&quot;, (void *)&amp;JVM_Sleep&#125;, &#123;&quot;currentThread&quot;, &quot;()&quot; THD, (void *)&amp;JVM_CurrentThread&#125;, &#123;&quot;countStackFrames&quot;, &quot;()I&quot;, (void *)&amp;JVM_CountStackFrames&#125;, &#123;&quot;interrupt0&quot;, &quot;()V&quot;, (void *)&amp;JVM_Interrupt&#125;, &#123;&quot;isInterrupted&quot;, &quot;(Z)Z&quot;, (void *)&amp;JVM_IsInterrupted&#125;, &#123;&quot;holdsLock&quot;, &quot;(&quot; OBJ &quot;)Z&quot;, (void *)&amp;JVM_HoldsLock&#125;, &#123;&quot;getThreads&quot;, &quot;()[&quot; THD, (void *)&amp;JVM_GetAllThreads&#125;, &#123;&quot;dumpThreads&quot;, &quot;([&quot; THD &quot;)[[&quot; STE, (void *)&amp;JVM_DumpThreads&#125;,&#125;;#undef THD#undef OBJ#undef STEJNIEXPORT void JNICALLJava_java_lang_Thread_registerNatives(JNIEnv *env, jclass cls)&#123; (*env)-&gt;RegisterNatives(env, cls, methods, ARRAY_LENGTH(methods));&#125; ä»è¿™æ®µä»£ç å¯ä»¥çœ‹å‡ºï¼Œstart0(),å®é™…ä¸Šä¼šæ‰§è¡ŒJVM_StartThread(),è¿™ä¸ªæ–¹æ³•æ˜¯å¹²å˜›çš„ï¼Ÿä»åå­—ä¸Šæ¥çœ‹ï¼Œä¼¼ä¹æ˜¯JVMå±‚é¢å»å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœçœŸçš„æ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆåœ¨JVMå±‚é¢ï¼Œä¸€å®šä¼šè°ƒç”¨Javaä¸­çš„run()ã€‚æ¥åˆ°jvm.cppæ–‡ä»¶ï¼ˆè¿™ä¸ªæ–‡ä»¶éœ€è¦ä¸‹è½½hotspotæºç æ‰èƒ½æ‰¾åˆ°ï¼‰ã€‚ 12JVM_ENTRY(void, JVM_StartThread(JNIEnv* env, jobject jthread)) native_thread = new JavaThread(&amp;thread_entry, sz); JVM_ENTRY æ˜¯ç”¨æ¥å®šä¹‰ JVM_StartThread å‡½æ•°çš„ï¼Œåœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢åˆ›å»ºäº†ä¸€ä¸ªçœŸæ­£å’Œå¹³å°æœ‰å…³çš„æœ¬åœ°çº¿ç¨‹. ç»§ç»­çœ‹çœ‹ newJavaThread åšäº†ä»€ä¹ˆäº‹æƒ…,ç»§ç»­å¯»æ‰¾ JavaThread çš„å®šä¹‰ã€‚ 1234567891011JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) : JavaThread() &#123; _jni_attach_state = _not_attaching_via_jni; set_entry_point(entry_point); // Create the native thread itself. // %note runtime_23 os::ThreadType thr_type = os::java_thread; thr_type = entry_point == &amp;CompilerThread::thread_entry ? os::compiler_thread : os::java_thread; os::create_thread(this, thr_type, stack_sz); &#125; è¿™ä¸ªæ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯å‡½æ•°åç§°ï¼Œçº¿ç¨‹åˆ›å»ºæˆåŠŸä¹‹åä¼šæ ¹æ®è¿™ä¸ªå‡½æ•°åç§°è°ƒç”¨å¯¹åº”çš„å‡½æ•°ï¼›ç¬¬äºŒä¸ªæ˜¯å½“å‰è¿›ç¨‹å†…å·²ç»æœ‰çš„çº¿ç¨‹æ•°é‡ã€‚æœ€åé‡ç‚¹å…³æ³¨ä¸€ä¸‹os::create_thread,å®é™…å°±æ˜¯è°ƒç”¨å¹³å°åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•æ¥åˆ›å»ºçº¿ç¨‹ã€‚æ¥ä¸‹æ¥å°±æ˜¯çº¿ç¨‹çš„å¯åŠ¨ï¼Œä¼šè°ƒç”¨ Thread.cpp æ–‡ä»¶ä¸­çš„Thread::start(Thread* thread)æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789void Thread::start(Thread* thread) &#123; if (thread-&gt;is_Java_thread()) &#123; java_lang_Thread::set_thread_status(thread-&gt;as_Java_thread()-&gt;threadObj(), JavaThreadStatus::RUNNABLE); &#125; os::start_thread(thread);&#125; start ()ä¸­æœ‰ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼š os::start_thread(thread);ï¼Œè°ƒç”¨å¹³å°å¯åŠ¨çº¿ç¨‹çš„æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ Thread.cpp æ–‡ä»¶ä¸­çš„ JavaThread::run()æ–¹æ³•ã€‚ 2.ç»ˆæ­¢çº¿ç¨‹çš„ç»ˆæ­¢å¹¶ä¸æ˜¯ç®€å•çš„è°ƒç”¨stopå‘½ä»¤ï¼Œè™½ç„¶apiä»ç„¶å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯å’Œå…¶ä»–çš„æ§åˆ¶çº¿ç¨‹çš„æ–¹æ³•ï¼ˆ`` suspendã€resume ``ï¼‰ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸å»ºè®®ä½¿ç”¨çš„ã€‚å°±æ‹¿stopæ¥è¯´ï¼Œstop()åœ¨ç»“æŸä¸€ä¸ªçº¿ç¨‹æ—¶å¹¶ä¸ä¼šä¿è¯çº¿ç¨‹çš„èµ„æºæ­£å¸¸é‡Šæ”¾ï¼Œå› æ­¤å¯èƒ½å¯¼è‡´ç¨‹åºå‡ºç°ä¸€äº›ä¸ç¡®å®šçš„çŠ¶æ€ã€‚è¦ä¼˜é›…çš„å»ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹ä¸­æä¾›äº†ä¸€ä¸ª**interrupt()**ã€‚ 1ï¼‰interruptï¼ˆï¼‰å…¶ä»–çº¿ç¨‹é€šè¿‡è°ƒç”¨å½“å‰çº¿ç¨‹çš„interrupt(),è¡¨ç¤ºåƒå½“å‰çº¿ç¨‹æ‰“ä¸ªæ‹›å‘¼ï¼Œå‘Šè¯‰ä»–å¯ä»¥ä¸­æ–­çº¿ç¨‹çš„æ‰§è¡Œäº†ï¼Œè‡³äºä»€ä¹ˆæ—¶å€™ä¸­æ–­ï¼Œå–å†³äºå½“å‰çº¿ç¨‹è‡ªå·±ã€‚çº¿ç¨‹é€šè¿‡æ£€æŸ¥è‡ªèº« æ˜¯å¦è¢«ä¸­æ–­æ¥è¿›è¡Œå“åº”ï¼Œå¯ä»¥é€šè¿‡isInterrupted()æ¥åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­ã€‚ä»£ç æ¼”ç¤ºçº¿ç¨‹çš„ä¼˜é›…ç»ˆæ­¢ 12345678910111213141516171819202122232425262728/** * @author yhd * @description ä»£ç æ¼”ç¤ºçº¿ç¨‹çš„ä¼˜é›…ç»ˆæ­¢ * @email yinhuidong2@xiaomi.com * @since 2021/6/27 */public class Stop &#123; private static int i; public static void main(String[] args) &#123; Thread t = new Thread(()-&gt;&#123; while (!Thread.currentThread().isInterrupted())&#123; i++; &#125; System.out.println(&quot;num:&quot;+i); &#125;,&quot;interrupt&quot;); t.start(); try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; t.interrupt(); &#125;&#125; è¿™ç§é€šè¿‡æ ‡è¯†ä½æˆ–è€…ä¸­æ–­æ“ä½œçš„æ–¹å¼èƒ½å¤Ÿä½¿çº¿ç¨‹åœ¨ç»ˆæ­¢æ—¶æœ‰æœºä¼šå»æ¸…ç†èµ„æºï¼Œè€Œä¸æ˜¯æ­¦æ–­åœ°å°†çº¿ç¨‹åœæ­¢ï¼Œå› æ­¤è¿™ç§ç»ˆæ­¢çº¿ç¨‹çš„åšæ³•æ˜¾å¾—æ›´åŠ å®‰å…¨å’Œä¼˜é›…ã€‚ 2ï¼‰Thread.interrupted()ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼Œé€šè¿‡ interruptï¼Œè®¾ç½®äº†ä¸€ä¸ªæ ‡è¯†å‘Šè¯‰çº¿ç¨‹å¯ ä»¥ ç»ˆ æ­¢ äº† ï¼Œ çº¿ ç¨‹ ä¸­ è¿˜ æ ä¾› äº† é™ æ€ æ–¹ æ³•Thread.interrupted()å¯¹è®¾ç½®ä¸­æ–­æ ‡è¯†çš„çº¿ç¨‹å¤ä½ã€‚æ¯”å¦‚åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼Œå¤–é¢çš„çº¿ç¨‹è°ƒç”¨ thread.interrupt æ¥è®¾ç½®ä¸­æ–­æ ‡è¯†ï¼Œè€Œåœ¨çº¿ç¨‹é‡Œé¢ï¼Œåˆé€šè¿‡Thread.interruptedæŠŠçº¿ç¨‹çš„æ ‡è¯†åˆè¿›è¡Œäº†å¤ä½ã€‚ 1234567891011121314151617181920public class InterruptDemo &#123; public static void main(String[] args) throws InterruptedException &#123; Thread thread = new Thread(() -&gt; &#123; while (true) &#123; if (Thread.currentThread().isInterrupted()) &#123; System.out.println(&quot;before:&quot; + Thread.currentThread().isInterrupted()) ; Thread.interrupted(); // å¯¹çº¿ç¨‹è¿›è¡Œå¤ä½ï¼Œç”± true å˜æˆ false System.out.println(&quot;after:&quot; + Thread .currentThread().isInterrupted()); &#125; &#125; &#125;, &quot;interruptDemo&quot;); thread.start(); TimeUnit.SECONDS.sleep(1); thread.interrupt(); &#125;&#125; 3)å…¶ä»–çº¿ç¨‹çš„å¤ä½é™¤äº†é€šè¿‡ Thread.interrupted æ–¹æ³•å¯¹çº¿ç¨‹ä¸­æ–­æ ‡è¯†è¿›è¡Œå¤ä½ ä»¥ å¤– ï¼Œ è¿˜ æœ‰ ä¸€ ç§ è¢« åŠ¨ å¤ ä½ çš„ åœº æ™¯ ï¼Œ å°± æ˜¯ å¯¹ æŠ› å‡ºInterruptedException å¼‚ å¸¸ çš„ æ–¹ æ³• ï¼Œ åœ¨InterruptedException æŠ›å‡ºä¹‹å‰ï¼ŒJVM ä¼šå…ˆæŠŠçº¿ç¨‹çš„ä¸­æ–­æ ‡è¯†ä½æ¸…é™¤ï¼Œç„¶åæ‰ä¼šæŠ›å‡ºInterruptedExceptionï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè°ƒç”¨ isInterrupted()ï¼Œå°†ä¼šè¿”å› falseã€‚ 12345678910111213141516171819202122public class InterruptDemo &#123; private static int i; public static void main(String[] args) throws InterruptedException &#123; Thread thread = new Thread(() -&gt; &#123; while (!Thread.currentThread().isInterrupted()) &#123; try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; System.out.println(&quot;Num:&quot; + i); &#125;, &quot;interruptDemo&quot;); thread.start(); TimeUnit.SECONDS.sleep(1); thread.interrupt(); System.out.println(thread.isInterrupted()); &#125;&#125; 4)ä¸ºä»€ä¹ˆè¦å¤ä½Thread.interrupted()æ˜¯å±äºå½“å‰çº¿ç¨‹çš„ï¼Œæ˜¯å½“å‰çº¿ç¨‹å¯¹å¤–ç•Œä¸­æ–­ä¿¡å·çš„ä¸€ä¸ªå“åº”ï¼Œè¡¨ç¤ºè‡ªå·±å·²ç»å¾—åˆ°äº†ä¸­æ–­ä¿¡å·ï¼Œä½†ä¸ä¼šç«‹åˆ»ä¸­æ–­è‡ªå·±ï¼Œå…·ä½“ä»€ä¹ˆæ—¶å€™ä¸­æ–­ç”±è‡ªå·±å†³å®šï¼Œè®©å¤–ç•ŒçŸ¥é“åœ¨è‡ªèº«ä¸­æ–­å‰ï¼Œä»–çš„ä¸­æ–­çŠ¶æ€ä»ç„¶æ˜¯ falseï¼Œè¿™å°±æ˜¯å¤ä½çš„åŸå› ã€‚ 5)çº¿ç¨‹çš„ç»ˆæ­¢åŸç†1234567891011121314public void interrupt() &#123; if (this != Thread.currentThread()) checkAccess(); synchronized (blockerLock) &#123; Interruptible b = blocker; if (b != null) &#123; interrupt0(); // Just to set the interrupt flag b.interrupt(this); return; &#125; &#125; interrupt0();&#125; è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œè°ƒç”¨äº† interrupt0()ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨å‰é¢åˆ†æstart()çš„æ—¶å€™è§è¿‡ï¼Œæ˜¯ä¸€ä¸ª native æ–¹æ³•ï¼ŒåŒæ ·ï¼Œæ‰¾åˆ° jvm.cpp æ–‡ä»¶ï¼Œæ‰¾åˆ°JVM_Interrupt çš„å®šä¹‰ï¼Œè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œç›´æ¥è°ƒç”¨äº† Thread::interrupt(thr)ï¼Œè¿™ä¸ªæ–¹æ³•çš„å®šä¹‰åœ¨ Thread.cpp æ–‡ä»¶ä¸­ï¼ŒThread::interrupt() è°ƒç”¨äº† os::interrupt()ï¼Œè¿™ä¸ªæ˜¯è°ƒç”¨å¹³å°çš„ interrupt()ï¼Œè¿™ä¸ªæ–¹æ³•çš„å®ç°æ˜¯åœ¨ os_*.cppæ–‡ä»¶ä¸­ï¼Œå…¶ä¸­æ˜Ÿå·ä»£è¡¨çš„æ˜¯ä¸åŒå¹³å°ï¼Œå› ä¸º jvm æ˜¯è·¨å¹³å°çš„ï¼Œæ‰€ä»¥å¯¹äºä¸åŒçš„æ“ä½œå¹³å°ï¼Œçº¿ç¨‹çš„è°ƒåº¦æ–¹å¼éƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚ä»¥ os_linux.cpp æ–‡ä»¶ä¸ºä¾‹ï¼šset_interrupted(true)å®é™…ä¸Šå°±æ˜¯è°ƒç”¨ osThread.hpp ä¸­çš„set_interrupted()ï¼Œåœ¨ osThread ä¸­å®šä¹‰äº†ä¸€ä¸ªæˆå‘˜å±æ€§ volatile jint _interruptedã€‚ é€šè¿‡ä¸Šé¢çš„ä»£ç åˆ†æå¯ä»¥çŸ¥é“ï¼Œthread.interrupt()å®é™…å°±æ˜¯è®¾ç½®ä¸€ä¸ª interrupted çŠ¶æ€æ ‡è¯†ä¸º trueã€å¹¶ä¸”é€šè¿‡ParkEvent çš„ unpark()æ¥å”¤é†’çº¿ç¨‹ã€‚ å¯¹äº synchronized é˜»å¡çš„çº¿ç¨‹ï¼Œè¢«å”¤é†’ä»¥åä¼šç»§ç»­å°è¯•è·å–é”ï¼Œå¦‚æœå¤±è´¥ä»ç„¶å¯èƒ½è¢« park åœ¨è°ƒç”¨ ParkEvent çš„ park æ–¹æ³•ä¹‹å‰ï¼Œä¼šå…ˆåˆ¤æ–­çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œå¦‚æœä¸º trueï¼Œä¼šæ¸…é™¤å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è¯† Object.wait ã€ Thread.sleep ã€ Thread.join ä¼š æŠ› å‡ºInterruptedException ä¸ºä»€ä¹ˆ Object.waitã€Thread.sleep å’Œ Thread.join éƒ½ ä¼š æŠ› å‡ºInterruptedException?â€‹ è¿™å‡ ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼Œéƒ½æ˜¯å±äºé˜»å¡çš„æ–¹æ³•ï¼Œè€Œé˜»å¡æ–¹æ³•çš„é‡Šæ”¾ä¼šå–å†³äºä¸€äº›å¤–éƒ¨çš„äº‹ä»¶ï¼Œä½†æ˜¯é˜»å¡æ–¹æ³•å¯èƒ½å› ä¸ºç­‰ä¸åˆ°å¤–éƒ¨çš„è§¦å‘äº‹ä»¶è€Œå¯¼è‡´æ— æ³•ç»ˆæ­¢ï¼Œæ‰€ä»¥å®ƒå…è®¸ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚è‡ªå·±æ¥åœæ­¢å®ƒæ­£åœ¨åšçš„äº‹æƒ…ã€‚å½“ä¸€ä¸ªæ–¹æ³•æŠ›å‡º InterruptedException æ—¶ï¼Œå®ƒæ˜¯åœ¨å‘Šè¯‰è°ƒç”¨è€…å¦‚æœæ‰§è¡Œè¯¥æ–¹æ³•çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œå®ƒä¼šå°è¯•åœæ­¢æ­£åœ¨åšçš„äº‹æƒ…å¹¶ä¸”é€šè¿‡æŠ›å‡º InterruptedException è¡¨ç¤ºæå‰è¿”å›ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªå¼‚å¸¸çš„æ„æ€æ˜¯è¡¨ç¤ºä¸€ä¸ªé˜»å¡è¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­äº†ã€‚ç„¶åï¼Œç”±äºçº¿ç¨‹è°ƒç”¨äº† interrupt()ä¸­æ–­æ–¹æ³•ï¼Œé‚£ä¹ˆObject.waitã€Thread.sleep ç­‰è¢«é˜»å¡çš„çº¿ç¨‹è¢«å”¤é†’ä»¥åä¼šé€šè¿‡ is_interrupted æ–¹æ³•åˆ¤æ–­ä¸­æ–­æ ‡è¯†çš„çŠ¶æ€å˜åŒ–ï¼Œå¦‚æœå‘ç°ä¸­æ–­æ ‡è¯†ä¸º trueï¼Œåˆ™å…ˆæ¸…é™¤ä¸­æ–­æ ‡è¯†ï¼Œç„¶åæŠ›å‡ºInterruptedExceptionã€‚ InterruptedException å¼‚å¸¸çš„æŠ›å‡ºå¹¶ä¸æ„å‘³ç€çº¿ç¨‹å¿…é¡»ç»ˆæ­¢ï¼Œè€Œæ˜¯æé†’å½“å‰çº¿ç¨‹æœ‰ä¸­æ–­çš„æ“ä½œå‘ç”Ÿï¼Œè‡³äºæ¥ä¸‹æ¥æ€ä¹ˆå¤„ç†å–å†³äºçº¿ç¨‹æœ¬èº«ï¼Œ ç›´æ¥æ•è·å¼‚å¸¸ä¸åšä»»ä½•å¤„ç† å°†å¼‚å¸¸å¾€å¤–æŠ›å‡º åœæ­¢å½“å‰çº¿ç¨‹ï¼Œå¹¶æ‰“å°å¼‚å¸¸ä¿¡æ¯â€‹ æ€»ç»“ï¼šå¦‚æœå½“å‰çº¿ç¨‹æ­£å¤„äºwaitï¼Œsleepï¼ŒjoinçŠ¶æ€ï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«æ‰“æ–­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸­æ–­æ ‡è¯†ä¸ºtrueï¼Œæ¸…é™¤å½“å‰çº¿ç¨‹çš„ä¸­ç«¯æ ‡è¯†ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹ä¼šæ”¶åˆ°ä¸­æ–­å¼‚å¸¸ã€‚â€‹ 6)ä»£ç æ—¶é—´â‘ æ‰“æ–­sleepï¼Œwaitï¼Œjoinçš„çº¿ç¨‹è¿™å‡ ä¸ªæ–¹æ³•éƒ½ä¼šè®©çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€æ‰“æ–­sleepçš„çº¿ç¨‹ï¼Œä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ 123456789101112131415161718192021222324252627282930313233/** * @author yhd * @description interruptæ‰“æ–­sleepçš„çº¿ç¨‹ * @email yinhuidong2@xiaomi.com * @since 2021/6/27 */public class Sleep &#123; public static void test() throws Exception&#123; Thread t = new Thread(()-&gt;&#123; try &#123; Thread.sleep(10000); &#125; catch (Exception e) &#123; System.out.println(&quot;æŠ›å‡ºå¼‚å¸¸&quot;); &#125; finally &#123; &#125; &#125;); t.start(); Thread.sleep(1000); t.interrupt(); System.out.println(&quot;æ‰“æ–­çŠ¶æ€ï¼š&quot;+t.isInterrupted()); &#125; public static void main(String[] args) &#123; try &#123; test(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;&#125; â‘¡æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹ï¼Œä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€ 1234567891011121314151617181920212223242526272829/** * @author yhd * @description æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹ * @email yinhuidong2@xiaomi.com * @since 2021/6/27 */public class InterruptTest &#123; private static void test1() throws InterruptedException &#123; Thread t2 = new Thread(()-&gt;&#123; while(true) &#123; Thread current = Thread.currentThread(); boolean interrupted = current.isInterrupted(); if(interrupted) &#123; System.out.println(&quot; æ‰“æ–­çŠ¶æ€: &#123;&#125;&quot;+ Thread.currentThread().isInterrupted()); break; &#125; &#125; &#125;, &quot;t2&quot;); t2.start(); sleep(1); t2.interrupt(); &#125; public static void main(String[] args) throws Exception &#123; test1(); &#125;&#125; â‘¢æ‰“æ–­parkçº¿ç¨‹1234567891011121314151617181920212223242526/** * @author yhd * @description æ‰“æ–­parkçº¿ç¨‹ * @email yinhuidong2@xiaomi.com * @since 2021/6/27 */public class ParkTest &#123; private static void test1() throws InterruptedException &#123; Thread t1 = new Thread(() -&gt; &#123; System.out.println(&quot;park...&quot;); LockSupport.park(); System.out.println(&quot;unpark...&quot;); System.out.println(&quot;æ‰“æ–­çŠ¶æ€ï¼š&#123;&#125;&quot;+ Thread.currentThread().isInterrupted()); &#125;, &quot;t1&quot;); t1.start(); sleep(1); t1.interrupt(); &#125; public static void main(String[] args) throws Exception &#123; test1(); &#125;&#125; å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯trueï¼Œåˆ™parkä¼šå¤±æ•ˆã€‚ 12345678910111213141516171819202122232425/** * @author yhd * @description parkçš„ç¬¬äºŒä¸ªæ¡ˆä¾‹æ¼”ç¤º * @email yinhuidong2@xiaomi.com * @since 2021/6/27 */public class ParkTest2 &#123; private static void test4() throws InterruptedException &#123; Thread t1 = new Thread(() -&gt; &#123; for (int i = 0; i &lt; 5; i++) &#123; System.out.println(&quot;park...&quot;); LockSupport.park(); System.out.println(&quot;æ‰“æ–­çŠ¶æ€ï¼š&#123;&#125;&quot;+Thread.currentThread().isInterrupted()); &#125; &#125;); t1.start(); sleep(1); t1.interrupt(); &#125; public static void main(String[] args) throws Exception &#123; test4(); &#125;&#125; å¯ä»¥ä½¿ç”¨ Thread.interrupted() æ¸…é™¤æ‰“æ–­çŠ¶æ€ã€‚ 3.sleep() &amp; yield()1)sleep() è°ƒç”¨sleepä¼šè®©å½“å‰çº¿ç¨‹ä»runningçŠ¶æ€è¿›å…¥timedwaitingçŠ¶æ€ï¼ˆé˜»å¡ï¼‰ å…¶ä»–çº¿ç¨‹å¯ä»¥ä½¿ç”¨interruptæ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶sleep()ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹å³å¾—åˆ°æ‰§è¡Œ å»ºè®®ä½¿ç”¨TimeUnit.second.sleep()æ›¿ä»£sleepè·å¾—æ›´å¥½çš„å¯è¯»æ€§ 2)yield() è°ƒç”¨yieldä¼šè®©å½“å‰çº¿ç¨‹ä»runningè¿›å…¥runnableå°±ç»ªçŠ¶æ€ï¼Œç„¶åè°ƒåº¦æ‰§è¡Œå…¶ä»–çº¿ç¨‹ å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨ 4.join()1)ä¸ºä»€ä¹ˆéœ€è¦joinä¸‹é¢çš„ä»£ç ï¼Œæ‰“å°ræ˜¯ä»€ä¹ˆï¼Ÿ 1234567891011121314151617181920212223242526/** * @author yhd */public class JoinDemo &#123; static int r = 0; public static void main(String[] args) throws InterruptedException &#123; test1(); &#125; private static void test1() throws InterruptedException &#123; System.out.println(&quot;å¼€å§‹&quot;); Thread t1 = new Thread(() -&gt; &#123; System.out.println(&quot;å¼€å§‹&quot;); try &#123; sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(&quot;ç»“æŸ&quot;); r = 10; &#125;); t1.start(); System.out.println(&quot;ç»“æœä¸º:&#123;&#125;&quot;+r); System.out.println(&quot;ç»“æŸ&quot;); &#125;&#125; åˆ†æï¼šå› ä¸ºä¸»çº¿ç¨‹å’Œçº¿ç¨‹t1æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œt1éœ€è¦1sä¹‹åæ‰èƒ½ç®—å‡ºr=10è€Œä¸»çº¿ç¨‹ä¸€å¼€å§‹å°±è¦æ‰“å°rçš„ç»“æœï¼Œæ‰€ä»¥åªèƒ½æ‰“å°r=0 è§£å†³æ–¹æ³•ï¼š sleepä¸ºä»€ä¹ˆä¸è¡Œï¼Ÿå› ä¸ºä¸»çº¿ç¨‹æ— æ³•å‡†ç¡®æ•æ‰åˆ°t1çº¿ç¨‹ä»€ä¹ˆæ—¶å€™ç»“æŸ ç”¨joinï¼ŒåŠ åœ¨t1.start()ä¹‹å2ï¼‰æœ‰æ—¶æ•ˆçš„join()ç­‰å¤Ÿæ—¶é—´1234567891011121314151617181920212223public class JoinDemo &#123; static int r1 = 0; static int r2 = 0; public static void main(String[] args) throws InterruptedException &#123; test3(); &#125; public static void test3() throws InterruptedException &#123; Thread t1 = new Thread(() -&gt; &#123; try &#123; sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; r1 = 10; &#125;); long start = System.currentTimeMillis(); t1.start();// çº¿ç¨‹æ‰§è¡Œç»“æŸä¼šå¯¼è‡´ join ç»“æŸ t1.join(1500); long end = System.currentTimeMillis(); System.out.println(&quot;r1: &#123;&#125; r2: &#123;&#125; cost: &#123;&#125;&quot;+ r1 +&quot; &quot;+ r2+&quot; &quot;+ (end - start)); &#125;&#125; t1çº¿ç¨‹çš„ç»“æŸä¼šå¯¼è‡´è°ƒç”¨äº†t1.join(1500)çš„ä¸»çº¿ç¨‹ç»“æŸã€‚ æ²¡ç­‰å¤Ÿæ—¶é—´ 1234567891011121314151617181920212223public class JoinDemo &#123; static int r1 = 0; static int r2 = 0; public static void main(String[] args) throws InterruptedException &#123; test3(); &#125; public static void test3() throws InterruptedException &#123; Thread t1 = new Thread(() -&gt; &#123; try &#123; sleep(2); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; r1 = 10; &#125;); long start = System.currentTimeMillis(); t1.start(); t1.join(1500); long end = System.currentTimeMillis(); System.out.println(&quot;r1: &#123;&#125; r2: &#123;&#125; cost: &#123;&#125;&quot;+ r1 +&quot; &quot;+ r2+&quot; &quot;+ (end - start)); &#125;&#125; joinæ—¶é—´åˆ°äº†çº¿ç¨‹ä¼šå°è¯•é‡æ–°è·å–CPUæ‰§è¡Œæƒã€‚ 3ï¼‰åŸç†è°ƒç”¨è€…è½®è®­æ£€æŸ¥aliveçŠ¶æ€ 1t1.join(); ç­‰ä»·äº 123456synchronized (t1) &#123;// è°ƒç”¨è€…çº¿ç¨‹è¿›å…¥ t1 çš„ waitSet ç­‰å¾…, ç›´åˆ° t1 è¿è¡Œç»“æŸ while (t1.isAlive()) &#123; t1.wait(0); &#125;&#125; å½“å‰çº¿ç¨‹è°ƒç”¨å…¶ä»–çº¿ç¨‹çš„wait(),ä¼šè®©å½“å‰çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹çš„wait()æ‰§è¡Œç»“æŸã€‚join()èƒ½å¤Ÿè®©çº¿ç¨‹é¡ºåºæ‰§è¡Œçš„åŸå› å°±æ˜¯åº•å±‚å®é™…ä¸Šæ˜¯wait(),ä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹è°ƒç”¨t1çº¿ç¨‹çš„join(),ä¼šè®©ä¸»çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°t1çº¿ç¨‹çš„join()æ‰§è¡Œç»“æŸã€‚ 5.javaä¸­æ“ä½œçº¿ç¨‹çš„æ–¹æ³•â€‹ æ–¹æ³•å static åŠŸèƒ½è¯´æ˜ æ³¨æ„ start() å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œåœ¨æ–°çš„çº¿ç¨‹è¿è¡Œ run æ–¹æ³•ä¸­çš„ä»£ç  start æ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥å°±ç»ªï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç«‹åˆ»è¿è¡Œï¼ˆCPU çš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„startæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç°IllegalThreadStateExceptionã€‚ run() æ–°çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨çš„æ–¹æ³• å¦‚æœåœ¨æ„é€  Thread å¯¹è±¡æ—¶ä¼ é€’äº† Runnable å‚æ•°ï¼Œåˆ™çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨ Runnable ä¸­çš„ run æ–¹æ³•ï¼Œå¦åˆ™é»˜è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»º Thread çš„å­ç±»å¯¹è±¡ï¼Œæ¥è¦†ç›–é»˜è®¤è¡Œä¸º join() ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸ join(long n) ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸ,æœ€å¤šç­‰å¾… næ¯«ç§’ getId() è·å–çº¿ç¨‹é•¿æ•´å‹çš„ id å”¯ä¸€ getName() è·å–çº¿ç¨‹å setName(String) ä¿®æ”¹çº¿ç¨‹å getPriority() è·å–çº¿ç¨‹ä¼˜å…ˆçº§ setPriority(int) ä¿®æ”¹çº¿ç¨‹ä¼˜å…ˆçº§ javaä¸­è§„å®šçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯1~10 çš„æ•´æ•°ï¼Œè¾ƒå¤§çš„ä¼˜å…ˆçº§èƒ½æé«˜è¯¥çº¿ç¨‹è¢« CPU è°ƒåº¦çš„æœºç‡ getState() è·å–çº¿ç¨‹çŠ¶æ€ Java ä¸­çº¿ç¨‹çŠ¶æ€æ˜¯ç”¨ 6 ä¸ª enum è¡¨ç¤ºï¼Œåˆ†åˆ«ä¸ºï¼šNEW, RUNNABLE, BLOCKED, WAITING,TIMED_WAITING, TERMINATED isInterrupted() åˆ¤æ–­æ˜¯å¦è¢«æ‰“æ–­ ä¸ä¼šæ¸…é™¤ æ‰“æ–­æ ‡è®° isAlive() çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼ˆè¿˜æ²¡æœ‰è¿è¡Œå®Œæ¯•ï¼‰ interrupt() æ‰“æ–­çº¿ç¨‹ å¦‚æœè¢«æ‰“æ–­çº¿ç¨‹æ­£åœ¨ sleepï¼Œwaitï¼Œjoin ä¼šå¯¼è‡´è¢«æ‰“æ–­çš„çº¿ç¨‹æŠ›å‡º InterruptedExceptionï¼Œå¹¶æ¸…é™¤ æ‰“æ–­æ ‡è®° ï¼›å¦‚æœæ‰“æ–­çš„æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œåˆ™ä¼šè®¾ç½® æ‰“æ–­æ ‡è®° ï¼›park çš„çº¿ç¨‹è¢«æ‰“æ–­ï¼Œä¹Ÿä¼šè®¾ç½® æ‰“æ–­æ ‡è®° interrupted() static åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ ä¼šæ¸…é™¤ æ‰“æ–­æ ‡è®° currentThread() static è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ sleep(long n) static è®©å½“å‰æ‰§è¡Œçš„çº¿ç¨‹ä¼‘çœ næ¯«ç§’ï¼Œä¼‘çœ æ—¶è®©å‡º cpuçš„æ—¶é—´ç‰‡ç»™å…¶å®ƒçº¿ç¨‹ yield() static æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹CPUçš„ä½¿ç”¨ ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•å’Œè°ƒè¯• 6.LockSupportâ€‹ ç”¨äºåˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ã€‚â€‹ æœ¬è´¨å°±æ˜¯çº¿ç¨‹é˜»å¡å’Œå”¤é†’wait notifyçš„åŠ å¼ºç‰ˆâ€‹ park() unpark() 1ï¼‰çº¿ç¨‹é˜»å¡å”¤é†’çš„ä¸‰ç§æ–¹æ³•â‘ ä½¿ç”¨Objectä¸­çš„wait()è®©çº¿ç¨‹ç­‰å¾…ï¼Œä½¿ç”¨Objectçš„notify()å”¤é†’çº¿ç¨‹ã€‚1234567891011121314151617181920212223242526272829303132/** * @author yhd * @description é˜»å¡&amp;å”¤é†’ * @email yinhuidong2@xiaomi.com * @since 2021/6/28 */public class WaitNotify &#123; private static Object lock = new Object(); public static void main(String[] args) &#123; new Thread(()-&gt;&#123; synchronized (lock)&#123; try &#123; lock.wait(); System.out.println(Thread.currentThread().getName()+&quot;ç»§ç»­æ‰§è¡Œ!&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;,&quot;t1&quot;).start(); new Thread(()-&gt;&#123; synchronized (lock)&#123; lock.notify(); System.out.println(Thread.currentThread().getName()+&quot;å”¤é†’&quot;); &#125; &#125;,&quot;t2&quot;).start(); &#125;&#125; å­˜åœ¨çš„é—®é¢˜ï¼šå¿…é¡»åœ¨synchronizedä»£ç å—é‡Œï¼Œé¡ºåºä¸èƒ½åã€‚â€‹ â‘¡ä½¿ç”¨Conditionçš„awaitå’Œsignalæ–¹æ³•123456789101112131415161718192021222324252627282930313233343536373839/** * @author yhd * @description é˜»å¡&amp;å”¤é†’ * @email yinhuidong2@xiaomi.com * @since 2021/6/28 */public class AwaitSignal &#123; private static Lock lock = new ReentrantLock(); private static Condition condition =lock.newCondition(); public static void main(String[] args) &#123; new Thread(()-&gt;&#123; lock.lock(); try &#123; condition.await(); &#125; catch (Exception e) &#123; &#125; finally &#123; lock.unlock(); &#125; &#125;,&quot;t1&quot;).start(); new Thread(()-&gt;&#123; lock.lock(); try &#123; condition.signal(); &#125; catch (Exception e) &#123; &#125; finally &#123; lock.unlock(); &#125; &#125;,&quot;t2&quot;).start(); &#125;&#125; å­˜åœ¨çš„é—®é¢˜ï¼šå¿…é¡»åœ¨lockä»£ç å—é‡Œé¢ä½¿ç”¨ï¼Œä½¿ç”¨é¡ºåºä¸èƒ½åã€‚â€‹ â‘¢LockSupportç±»park()å¯ä»¥é˜»å¡å½“å‰çº¿ç¨‹ä»¥åŠunpark(Thread)å”¤é†’æŒ‡å®šè¢«é˜»å¡çš„çº¿ç¨‹ã€‚LockSupportç±»ä½¿ç”¨äº†ä¸€ç§åä¸ºPermitï¼ˆè®¸å¯ï¼‰çš„æ¦‚å¿µæ¥åšåˆ°é˜»å¡å’Œå”¤é†’çº¿ç¨‹çš„åŠŸèƒ½ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè®¸å¯ï¼Œpermitåªæœ‰1å’Œ0ä¸¤ä¸ªå€¼ï¼Œé»˜è®¤æ˜¯0.â€‹ permité»˜è®¤æ˜¯0ï¼Œæ‰€ä»¥ä¸€å¼€å§‹è°ƒç”¨park()æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šé˜»å¡ï¼Œç›´åˆ°åˆ«çš„çº¿ç¨‹å°†å½“å‰çº¿ç¨‹çš„permitè®¾ç½®ä¸º1æ—¶ï¼Œparkæ–¹æ³•ä¼šè¢«å”¤é†’ï¼Œç„¶åå°†permitå†æ¬¡è®¾ç½®ä¸º0å¹¶è¿”å›ã€‚â€‹ 1234567891011121314151617/** * @author yhd * @description é˜»å¡&amp;å”¤é†’ * @email yinhuidong2@xiaomi.com * @since 2021/6/28 */public class ParkUnpark &#123; public static void main(String[] args) &#123; LockSupport.unpark(Thread.currentThread()); LockSupport.park(); LockSupport.park(); &#125;&#125; 2ï¼‰æ€»ç»“LockSupportæ˜¯ä¸€ä¸ªçº¿ç¨‹é˜»å¡å·¥å…·ç±»ï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•ï¼Œå¯ä»¥è®©çº¿ç¨‹åœ¨ä»»æ„ä½ç½®é˜»å¡ï¼Œé˜»å¡ä¹‹åä¹Ÿæœ‰å¯¹åº”çš„å”¤é†’æ–¹æ³•ã€‚å½’æ ¹ç»“åº•ï¼ŒLockSupportè°ƒç”¨çš„Unsafeä¸­çš„nativeä»£ç ã€‚ LockSupportæä¾›park()å’Œunpark()æ–¹æ³•å®ç°é˜»å¡çº¿ç¨‹å’Œè§£é™¤çº¿ç¨‹é˜»å¡çš„è¿‡ç¨‹â€‹ LockSupportå’Œæ¯ä¸ªä½¿ç”¨å®ƒçš„çº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè®¸å¯(permit)å…³è”ã€‚permitç›¸å½“äº1ï¼Œ0çš„å¼€å…³ï¼Œé»˜è®¤æ˜¯0ï¼Œè°ƒç”¨ä¸€æ¬¡unparkå°±åŠ 1å˜æˆ1ï¼Œè°ƒç”¨ä¸€æ¬¡parkä¼šæ¶ˆè´¹permitï¼Œä¹Ÿå°±æ˜¯å°†1å˜æˆoï¼ŒåŒæ—¶parkç«‹å³è¿”å›ã€‚â€‹ å¦‚å†æ¬¡è°ƒç”¨parkä¼šå˜æˆé˜»å¡(å› ä¸ºpermitä¸ºé›¶äº†ä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œä¸€ç›´åˆ°permitå˜ä¸º1)ï¼Œè¿™æ—¶è°ƒç”¨unparkä¼šæŠŠpermitç½®ä¸º1ã€‚â€‹ æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„permit, permitæœ€å¤šåªæœ‰ä¸€ä¸ªï¼Œé‡å¤è°ƒç”¨unparkä¹Ÿä¸ä¼šç§¯ç´¯å‡­è¯ã€‚â€‹ ä¸ºä»€ä¹ˆå¯ä»¥å…ˆå”¤é†’çº¿ç¨‹åé˜»å¡çº¿ç¨‹? å› ä¸ºunparkè·å¾—äº†ä¸€ä¸ªå‡­è¯ï¼Œä¹‹åå†è°ƒç”¨parkæ–¹æ³•ï¼Œå°±å¯ä»¥åæ­£è¨€é¡ºçš„å‡­è¯æ¶ˆè´¹ï¼Œæ•…ä¸ä¼šé˜»å¡ã€‚ ä¸ºä»€ä¹ˆå”¤é†’ä¸¤æ¬¡åé˜»å¡ä¸¤æ¬¡ï¼Œä½†æœ€ç»ˆç»“æœè¿˜ä¼šé˜»å¡çº¿ç¨‹? å› ä¸ºå‡­è¯çš„æ•°é‡æœ€å¤šä¸º1ï¼Œè¿ç»­è°ƒç”¨ä¸¤æ¬¡unparkå’Œè°ƒç”¨ä¸€æ¬¡unparkæ•ˆæœä¸€æ ·ï¼Œåªä¼šå¢åŠ ä¸€ä¸ªå‡­è¯;è€Œè°ƒç”¨ä¸¤æ¬¡parkå´éœ€è¦æ¶ˆè´¹ä¸¤ä¸ªå‡­è¯ï¼Œè¯ä¸å¤Ÿï¼Œä¸èƒ½æ”¾è¡Œã€‚ å››ï¼Œå¤šçº¿ç¨‹ç›¸å…³æ¦‚å¿µ1.å¹¶å‘ï¼Ÿå¹¶è¡Œå•æ ¸ cpu ä¸‹ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯ ä¸²è¡Œæ‰§è¡Œ çš„ã€‚æ“ä½œç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç»„ä»¶å«åšä»»åŠ¡è°ƒåº¦å™¨ï¼Œå°† cpu çš„æ—¶é—´ç‰‡ï¼ˆwindowsä¸‹æ—¶é—´ç‰‡æœ€å°çº¦ä¸º 15 æ¯«ç§’ï¼‰åˆ†ç»™ä¸åŒçš„ç¨‹åºä½¿ç”¨ï¼Œåªæ˜¯ç”±äº cpu åœ¨çº¿ç¨‹é—´ï¼ˆæ—¶é—´ç‰‡å¾ˆçŸ­ï¼‰çš„åˆ‡æ¢éå¸¸å¿«ï¼Œäººç±»æ„Ÿè§‰æ˜¯ åŒæ—¶è¿è¡Œçš„ ã€‚æ€»ç»“ä¸ºä¸€å¥è¯å°±æ˜¯ï¼š å¾®è§‚ä¸²è¡Œï¼Œå®è§‚å¹¶è¡Œ ï¼Œä¸€èˆ¬ä¼šå°†è¿™ç§ çº¿ç¨‹è½®æµä½¿ç”¨ CPU çš„åšæ³•ç§°ä¸ºå¹¶å‘ï¼Œ concurrent cpu æ—¶é—´ç‰‡1 æ—¶é—´ç‰‡2 æ—¶é—´ç‰‡3 æ—¶é—´ç‰‡4 core çº¿ç¨‹1 çº¿ç¨‹2 çº¿ç¨‹3 çº¿ç¨‹4 å¤šæ ¸ cpuä¸‹ï¼Œæ¯ä¸ª æ ¸ï¼ˆcoreï¼‰ éƒ½å¯ä»¥è°ƒåº¦è¿è¡Œçº¿ç¨‹ï¼Œè¿™æ—¶å€™çº¿ç¨‹å¯ä»¥æ˜¯å¹¶è¡Œçš„ã€‚â€‹ cpu æ—¶é—´ç‰‡1 æ—¶é—´ç‰‡2 æ—¶é—´ç‰‡3 æ—¶é—´ç‰‡4 core1 çº¿ç¨‹1 çº¿ç¨‹1 çº¿ç¨‹3 çº¿ç¨‹3 core2 çº¿ç¨‹2 çº¿ç¨‹2 çº¿ç¨‹4 çº¿ç¨‹4 å¹¶å‘æ˜¯åŒä¸€æ—¶é—´åº”å¯¹å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›ã€‚å¹¶è¡Œæ˜¯åŒä¸€æ—¶é—´åŠ¨æ‰‹åšå¤šä»¶äº‹æƒ…çš„èƒ½åŠ›ã€‚ å•æ ¸CPUä¸‹ï¼Œå¤šçº¿ç¨‹ä¸èƒ½å®é™…æé«˜è¿è¡Œæ•ˆç‡ï¼Œåªæ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒçš„ä»»åŠ¡ä¹‹é—´åˆ‡æ¢ï¼Œä¸åŒçš„çº¿ç¨‹è½®æµä½¿ç”¨CPUï¼Œä¸è‡³äºä¸€ä¸ªçº¿ç¨‹æ€»å ç”¨CPUï¼Œåˆ«çš„çº¿ç¨‹æ²¡æ³•å¹²æ´»ã€‚ å¤šæ ¸CPUå¯ä»¥å¹¶è¡Œè·‘å¤šä¸ªçº¿ç¨‹ï¼Œä½†èƒ½å¦æé«˜è¿è¡Œæ•ˆç‡è¿˜æ˜¯è¦çœ‹å…·ä½“æƒ…å†µçš„ã€‚ IOæ“ä½œä¸å ç”¨CPUï¼Œåªæ˜¯ä¸€èˆ¬æ‹·è´æ–‡ä»¶ä½¿ç”¨çš„æ˜¯é˜»å¡IOï¼Œè¿™æ—¶ç›¸å½“äºçº¿ç¨‹è™½ç„¶ä¸ç”¨CPUï¼Œä½†æ˜¯éœ€è¦ä¸€ç›´ç­‰å¾…IOç»“æŸï¼Œæ²¡èƒ½å……åˆ†åˆ©ç”¨çº¿ç¨‹ã€‚æ‰€ä»¥åé¢æ‰æœ‰éé˜»å¡IOå’Œå¼‚æ­¥IOçš„ä¼˜åŒ–ã€‚ 2.çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢å› ä¸ºä»¥ä¸‹ä¸€äº›åŸå› å¯¼è‡´ cpu ä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç [1]ã€‚ çº¿ç¨‹çš„cpuæ—¶é—´ç‰‡ç”¨å®Œ åƒåœ¾å›æ”¶ æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€yieldã€waitã€joinã€parkã€synchronizedã€lock ç­‰æ–¹æ³•ã€‚ å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€[2]ï¼ŒJava ä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡ jvm æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ 3.ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹é»˜è®¤æƒ…å†µä¸‹ï¼ŒJava è¿›ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸï¼Œæ‰ä¼šç»“æŸã€‚æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œåªè¦å…¶å®ƒéå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚ åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹ã€‚ Tomcat ä¸­çš„ Acceptor å’Œ Poller çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥ Tomcat æ¥æ”¶åˆ° shutdown å‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚ã€‚ 4.ä¸´ç•ŒåŒºçš„æ¦‚å¿µä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œé—®é¢˜å‡ºåœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºã€‚ å¤šä¸ªçº¿ç¨‹è¯»å…±äº«èµ„æºå…¶å®ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œåœ¨å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚ ä¸€æ®µä»£ç å—å†…å¦‚æœå­˜åœ¨å¯¹å…±äº«èµ„æºçš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œç§°è¿™æ®µä»£ç å—ä¸ºä¸´ç•ŒåŒºã€‚ 5.æ­»é”1ï¼‰æ­»é”æœ‰è¿™æ ·çš„æƒ…å†µï¼šä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é” t1 çº¿ç¨‹ è·å¾— Aå¯¹è±¡ é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– Bå¯¹è±¡ çš„é” t2 çº¿ç¨‹ è·å¾— Bå¯¹è±¡ é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– Aå¯¹è±¡ çš„é” ä¾‹ï¼š 2ï¼‰å®šä½æ­»é”æ£€æµ‹æ­»é”å¯ä»¥ä½¿ç”¨ jconsoleå·¥å…·ï¼Œæˆ–è€…ä½¿ç”¨ jps å®šä½è¿›ç¨‹ idï¼Œå†ç”¨ jstack å®šä½æ­»é”ã€‚ é¿å…æ­»é”è¦æ³¨æ„åŠ é”é¡ºåºã€‚ å¦å¤–å¦‚æœç”±äºæŸä¸ªçº¿ç¨‹è¿›å…¥äº†æ­»å¾ªç¯ï¼Œå¯¼è‡´å…¶å®ƒçº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œå¯¹äºè¿™ç§æƒ…å†µ linux ä¸‹å¯ä»¥é€šè¿‡ top å…ˆå®šä½åˆ°CPU å ç”¨é«˜çš„ Java è¿›ç¨‹ï¼Œå†åˆ©ç”¨ top -Hp è¿›ç¨‹idæ¥å®šä½æ˜¯å“ªä¸ªçº¿ç¨‹ï¼Œæœ€åå†ç”¨ jstack æ’æŸ¥ã€‚ 6.æ´»é”æ´»é”å‡ºç°åœ¨ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸã€‚ 7.finalåŸç†1ï¼‰è®¾ç½® final å˜é‡çš„åŸç†å­—èŠ‚ç  å‘ç° final å˜é‡çš„èµ‹å€¼ä¹Ÿä¼šé€šè¿‡ putfield æŒ‡ä»¤æ¥å®Œæˆï¼ŒåŒæ ·åœ¨è¿™æ¡æŒ‡ä»¤ä¹‹åä¹Ÿä¼šåŠ å…¥å†™å±éšœï¼Œä¿è¯åœ¨å…¶å®ƒçº¿ç¨‹è¯»åˆ°å®ƒçš„å€¼æ—¶ä¸ä¼šå‡ºç°ä¸º 0 çš„æƒ…å†µã€‚ Context Switch é¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½. â†©ï¸ çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰. â†©ï¸ 8.å¯é‡å…¥é”å¯é‡å…¥é”åˆåé€’å½’é” æ˜¯æŒ‡åœ¨åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œå†è¿›å»è¯¥çº¿ç¨‹çš„å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ï¼ˆå‰æï¼šåŒä¸€ä¸ªé”å¯¹è±¡ï¼‰ï¼Œä¸ä¼šå› ä¸ºä¹‹å‰å·²ç»è·å–è¿‡è¿˜æ²¡é‡Šæ”¾è€Œé˜»å¡ã€‚â€‹ javaä¸­çš„ReentrantLockå’ŒSynchronizedéƒ½æ˜¯å¯é‡å…¥é”ï¼Œå¯é‡å…¥é”çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä¸€å®šç¨‹åº¦é¿å…æ­»é”ã€‚â€‹ 12345678910111213141516171819202122public class Demo2 &#123; private static Object lock = new Object(); public static void main(String[] args) &#123; test(); &#125; public static void test() &#123; new Thread(() -&gt; &#123; synchronized (lock) &#123; System.out.println(Thread.currentThread().getName() + &quot;å¤–&quot;); synchronized (lock) &#123; System.out.println(Thread.currentThread().getName() + &quot;ä¸­&quot;); synchronized (lock) &#123; System.out.println(Thread.currentThread().getName() + &quot;å†…&quot;); &#125; &#125; &#125; &#125;).start(); &#125;&#125; äº”ï¼Œçº¿ç¨‹é€šä¿¡1.ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°é¢˜ç›®ï¼š i=0,a:i++,b:iâ€“,äº¤æ›¿æ‰“å°10æ¬¡â€‹ 1.1 ä½¿ç”¨synchronized12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/** * @author äºŒå * @since 2021/8/31 9:01 ä¸‹åˆ */public class DemoA &#123; static CountDownLatch count=new CountDownLatch(2); public static void main(String[] args)throws Exception &#123; Lock lock = new Lock(); new Thread(()-&gt;&#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; lock.add(); &#125;catch (Exception e)&#123; &#125; &#125; count.countDown(); &#125;,&quot;A&quot;).start(); new Thread(()-&gt;&#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; lock.del(); &#125;catch (Exception e)&#123; &#125; &#125; count.countDown(); &#125;,&quot;B&quot;).start(); count.await(); &#125; private static class Lock&#123; static int num = 0; public synchronized void add()throws Exception&#123; if (num!=0)&#123; this.wait(); &#125; System.out.println(Thread.currentThread().getName()+&quot;num = &quot; + ++num); this.notify(); &#125; public synchronized void del()throws Exception&#123; if (num!=1)&#123; this.wait(); &#125; System.out.println(Thread.currentThread().getName()+&quot;num = &quot; + --num); this.notify(); &#125; &#125;&#125; 1.2 ä¸¤ä¸ªçº¿ç¨‹å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œç°åœ¨å¢åŠ åˆ°å››ä¸ª123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475/** * @author äºŒå * @since 2021/8/31 9:24 ä¸‹åˆ */public class DemoB &#123; static CountDownLatch count=new CountDownLatch(4); public static void main(String[] args)throws Exception &#123; Lock lock = new Lock(); new Thread(()-&gt;&#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; lock.add(); &#125;catch (Exception e)&#123; &#125; &#125; count.countDown(); &#125;,&quot;A&quot;).start(); new Thread(()-&gt;&#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; lock.del(); &#125;catch (Exception e)&#123; &#125; &#125; count.countDown(); &#125;,&quot;B&quot;).start(); new Thread(()-&gt;&#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; lock.add(); &#125;catch (Exception e)&#123; &#125; &#125; count.countDown(); &#125;,&quot;C&quot;).start(); new Thread(()-&gt;&#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; lock.del(); &#125;catch (Exception e)&#123; &#125; &#125; count.countDown(); &#125;,&quot;D&quot;).start(); count.await(); &#125; private static class Lock&#123; static int num = 0; public synchronized void add()throws Exception&#123; if (num!=0)&#123; this.wait(); &#125; System.out.println(Thread.currentThread().getName()+&quot;num = &quot; + ++num); this.notify(); &#125; public synchronized void del()throws Exception&#123; if (num!=1)&#123; this.wait(); &#125; System.out.println(Thread.currentThread().getName()+&quot;num = &quot; + --num); this.notify(); &#125; &#125;&#125; 1.3 çº¿ç¨‹é—´è°ƒç”¨åŒ–å®šåˆ¶é€šä¿¡æŸ¥çœ‹jdkAPI waitï¼ˆï¼‰ï¼›â€‹ æ³¨æ„ï¼šåˆ¤æ–­ä¸€å®šè¦whileå¾ªç¯åˆ¤æ–­ï¼Œä¸èƒ½ç”¨ifï¼Œé˜²æ­¢å¤šçº¿ç¨‹è™šå‡å”¤é†’ã€‚â€‹ 1.4 ä½¿ç”¨lock12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970/** * @author äºŒå * @since 2021/8/31 9:30 ä¸‹åˆ */public class DemoC &#123; private static CountDownLatch count = new CountDownLatch(2); public static void main(String[] args)throws Exception &#123; Data data = new Data(); new Thread(()-&gt;&#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; data.add(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; count.countDown(); &#125;,&quot;A&quot;).start(); new Thread(()-&gt;&#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; data.del(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; count.countDown(); &#125;,&quot;B&quot;).start(); count.await(); &#125; private static class Data &#123; static volatile int num =0; static ReentrantLock lock = new ReentrantLock(); static Condition c =lock.newCondition(); public void add()throws Exception&#123; lock.lock(); try &#123; while (num!=0)&#123; c.await(); &#125; System.out.println(Thread.currentThread().getName()+&quot; num = &quot; + ++num); c.signal(); &#125;finally &#123; lock.unlock(); &#125; &#125; public void del()throws Exception&#123; lock.lock(); try &#123; while (num!=1)&#123; c.await(); &#125; System.out.println(Thread.currentThread().getName()+&quot; num = &quot; + --num); c.signal(); &#125;finally &#123; lock.unlock(); &#125; &#125; &#125;&#125; 2.å¤šä¸ªçº¿ç¨‹æŒ‰é¡ºåºæ‰“å°é¢˜ç›®ï¼šâ€‹ å¤šçº¿ç¨‹ä¹‹é—´æŒ‰ç…§é¡ºåºè°ƒç”¨ï¼Œå®ç°A-B-Câ€‹ ä¸‰ä¸ªçº¿ç¨‹å¯åŠ¨ï¼Œè¦æ±‚å¦‚ä¸‹ï¼šâ€‹ AAæ‰“å°5æ¬¡ï¼ŒBBæ‰“å°10æ¬¡ï¼ŒCCæ‰“å°15æ¬¡â€‹ æ¥ç€å¾ªç¯10è½® åˆ†æï¼šâ€‹ æœ‰é¡ºåºé€šçŸ¥ï¼Œéœ€è¦æœ‰æ ‡è¯†ä½ æœ‰ä¸€ä¸ªé”ï¼Œlockï¼Œ3æŠŠé’¥åŒ™condition åˆ¤æ–­æ ‡è¯†ä½ è¾“å‡ºçº¿ç¨‹å+ç¬¬å‡ æ¬¡+ç¬¬å‡ è½® ä¿®æ”¹æ ‡è¯†ä½ï¼Œé€šçŸ¥ä¸‹ä¸€ä¸ª â€‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100/** * @author äºŒå * @since 2021/8/31 9:48 ä¸‹åˆ */public class DemoD &#123; static CountDownLatch c = new CountDownLatch(3); public static void main(String[] args) throws Exception &#123; Data data = new Data(); for (int i = 0; i &lt; 10; i++) &#123; new Thread(() -&gt; &#123; data.p1(); c.countDown(); &#125;, &quot;A&quot;).start(); new Thread(() -&gt; &#123; data.p2(); c.countDown(); &#125;, &quot;B&quot;).start(); new Thread(() -&gt; &#123; data.p3(); c.countDown(); &#125;, &quot;C&quot;).start(); &#125; c.await(); &#125; private static class Data &#123; static int flag = 0; ReentrantLock lock = new ReentrantLock(); Condition c1 = lock.newCondition(); Condition c2 = lock.newCondition(); Condition c3 = lock.newCondition(); public void printf() &#123; System.out.println(Thread.currentThread().getName() + &quot; flag&quot; + flag); &#125; public void p1() &#123; lock.lock(); try &#123; while (flag != 0) &#123; try &#123; c1.await(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; for (int i = 0; i &lt; 5; i++) &#123; printf(); &#125; flag++; c2.signal(); &#125; finally &#123; lock.unlock(); &#125; &#125; public void p2() &#123; lock.lock(); try &#123; while (flag != 1) &#123; try &#123; c2.await(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; for (int i = 0; i &lt; 10; i++) &#123; printf(); &#125; flag++; c3.signal(); &#125; finally &#123; lock.unlock(); &#125; &#125; public void p3() &#123; lock.lock(); try &#123; while (flag != 2) &#123; try &#123; c3.await(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; for (int i = 0; i &lt; 15; i++) &#123; printf(); &#125; flag = 0; c1.signal(); &#125; finally &#123; lock.unlock(); &#125; &#125; &#125;&#125; å…­ï¼Œçº¿ç¨‹ä¸é›†åˆ1.å¦‚ä½•è¯æ˜é›†åˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„123456789101112131415161718 public static void main(String[] args) &#123; List&lt;String&gt; list = new ArrayList&lt;&gt;(); for (int i = 0; i &lt; 30; i++) &#123; new Thread(() -&gt; &#123; list.add(UUID.randomUUID().toString().substring(8)); System.out.println(list); &#125;, String.valueOf(i)).start(); &#125; &#125;//java.util.ConcurrentModificationException 2.å¦‚ä½•è®©é›†åˆå˜çš„å®‰å…¨2.1 è°ƒç”¨å·¥å…·ç±»12List&lt;String&gt; list= Arrays.asList(&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;);List&lt;String&gt; list2= Collections.synchronizedList(list); 2.2 ä½¿ç”¨JUC copyOnWriteArrayList ConcurrentLinkedQueue ConcurrentHashMap â€‹ 1234567891011121314151617public static void main(String[] args) &#123; CopyOnWriteArrayList&lt;String&gt; list = new CopyOnWriteArrayList&lt;&gt;(); for (int i = 0; i &lt; 30; i++) &#123; new Thread(()-&gt;&#123; list.add(UUID.randomUUID().toString().substring(8)); System.out.println(list); &#125;,String.valueOf(i)).start(); &#125;&#125; æºç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576/** * @author äºŒå * @since 2021/8/31 10:44 ä¸‹åˆ */public class DemoF &#123; public static void main(String[] args) &#123; Printers printers = new Printers(); new Thread(() -&gt; &#123; for (int i = 1; i &lt;= 26; i++) printers.printNum(); &#125;, &quot;æ•°å­—æ‰“å°çº¿ç¨‹&quot;).start(); new Thread(() -&gt; &#123; for (int i = 1; i &lt;= 26; i++) printers.printLetter(i + 64); &#125;, &quot;å­—æ¯æ‰“å°çº¿ç¨‹&quot;).start(); &#125; private static class Printers &#123; private int num = 1; private int a = 0; private ReentrantLock lock = new ReentrantLock(); private Condition cd1 = lock.newCondition(); private Condition cd2 = lock.newCondition(); public void printNum() &#123; try &#123; lock.lock(); while (num != 1) cd1.await(); for (int i = 0; i &lt; 2; i++) &#123; System.out.println(Thread.currentThread().getName() + &quot;æ‰“å°äº†ï¼š&quot; + ++a); &#125; num++; cd2.signal(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125; public void printLetter(int aa) &#123; try &#123; lock.lock(); while (num != 2) cd2.await(); System.out.println(Thread.currentThread().getName() + &quot;æ‰“å°äº†ï¼š&quot; + (char) aa); num--; cd1.signal(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125; &#125;&#125;","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"é«˜å¹¶å‘æ ¸å¿ƒæ¨¡å¼ä¹‹å¼‚æ­¥å›è°ƒ","slug":"JUC/åŒæ­¥é˜Ÿåˆ—","date":"2022-01-11T11:05:09.782Z","updated":"2022-01-11T11:22:06.594Z","comments":true,"path":"2022/01/11/JUC/åŒæ­¥é˜Ÿåˆ—/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/%E5%90%8C%E6%AD%A5%E9%98%9F%E5%88%97/","excerpt":"","text":"äºŒï¼Œæºç 1.å†…éƒ¨ç±»å’Œæˆå‘˜å˜é‡12345678910111213141516171819202122232425262728293031323334353637abstract static class Transferer&lt;E&gt; &#123; /** * * @param e å¯ä»¥ä¸ºnullï¼Œnullçš„æ—¶å€™è¡¨ç¤ºè¿™ä¸ªæ˜¯ä¸€ä¸ªrequestç±»å‹çš„è¯·æ±‚ï¼Œ * å¦‚æœä¸æ˜¯nullï¼Œè¯´æ˜å½“å‰è¯·æ±‚æ˜¯ä¸€ä¸ªdataç±»å‹çš„è¯·æ±‚ * @param timed true è¡¨ç¤ºæŒ‡å®šäº†è¶…æ—¶æ—¶é—´ï¼Œ false è¡¨ç¤ºä¸æ”¯æŒè¶…æ—¶ï¼Œç›´åˆ°åŒ¹é…åˆ°ä¸ºæ­¢ * @param nanos è¶…æ—¶é™åˆ¶ å•ä½ï¼šçº³ç§’ * @return E å¦‚æœå½“å‰è¯·æ±‚æ˜¯ä¸€ä¸ªrequestç±»å‹çš„è¯·æ±‚ * è¿”å›å€¼ï¼=null è¡¨ç¤ºåŒ¹é…æˆåŠŸ * è¿”å›å€¼==null è¡¨ç¤ºè¶…æ—¶æˆ–è€…è¢«ä¸­æ–­ * å¦‚æœå½“å‰è¯·æ±‚æ˜¯dataç±»å‹çš„è¯·æ±‚ï¼Œ * è¿”å›å€¼ï¼=null è¡¨ç¤ºåŒ¹é…æˆåŠŸï¼Œè¿”å›å½“å‰çº¿ç¨‹putçš„æ•°æ® * è¿”å›å€¼ ==null è¡¨ç¤ºdataç±»å‹çš„è¯·æ±‚è¶…æ—¶ æˆ–è€…è¢«ä¸­æ–­ */ abstract E transfer(E e, boolean timed, long nanos);&#125;/** * è¡¨ç¤ºè·å–å½“å‰ç³»ç»Ÿæ‰€æ‹¥æœ‰çš„çš„cpuæ ¸å¿ƒæ•° */static final int NCPUS = Runtime.getRuntime().availableProcessors();/** * è¡¨ç¤ºæŒ‡å®šäº†è¶…æ—¶æ—¶é—´çš„è¯ï¼Œæœ€å¤§çš„è‡ªæ—‹æ¬¡æ•° * ä¸ºä»€ä¹ˆéœ€è¦è‡ªæ—‹æ“ä½œï¼Ÿå› ä¸ºçº¿ç¨‹æŒ‚èµ·å”¤é†’ç«™åœ¨cpuè§’åº¦ï¼Œæ˜¯æ¯”è¾ƒè€—è´¹èµ„æºçš„ï¼Œ * æ¶‰åŠåˆ°ç”¨æˆ·æ€å’Œå†…æ ¸å¤ªçš„åˆ‡æ¢æµªè´¹æ€§èƒ½ï¼Œè‡ªæ—‹æœŸé—´çº¿ç¨‹ä¼šä¸€ç›´æ£€æŸ¥è‡ªå·±çš„ * çŠ¶æ€æ˜¯å¦è¢«åŒ¹é…åˆ°ï¼Œå¦‚æœè‡ªæ—‹æœŸé—´è¢«åŒ¹é…åˆ°ï¼Œç›´æ¥è¿”å›ï¼Œå¦‚æœ * æœªè¢«åŒ¹é…åˆ°ï¼Œè¾¾åˆ°æŸä¸€æŒ‡æ ‡åï¼Œè¿˜æ˜¯ä¼šæŒ‚èµ·ã€‚ */static final int maxTimedSpins = (NCPUS &lt; 2) ? 0 : 32;/** * è¡¨ç¤ºæ²¡æœ‰æŒ‡å®šè¶…æ—¶é™åˆ¶çš„æ—¶å€™ï¼Œçº¿ç¨‹ç­‰å¾…åŒ¹é…æ—¶ï¼Œè‡ªæ—‹çš„æ¬¡æ•°ã€‚ */static final int maxUntimedSpins = maxTimedSpins * 16;/** * å¦‚æœè¯·æ±‚æ˜¯æŒ‡å®šè¶…æ—¶é™åˆ¶çš„è¯ï¼Œå¦‚æœè¶…æ—¶å‚æ•°å°äº1000çº³ç§’çš„æ—¶å€™ï¼Œç¦æ­¢æŒ‚èµ· */static final long spinForTimeoutThreshold = 1000L; 2.éå…¬å¹³æ¨¡å¼TODO","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"SimpleDateFormatåœ¨å¤šçº¿ç¨‹ä¸‹å­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜","slug":"JUC/SimpleDateFormatç±»çš„çº¿ç¨‹å®‰å…¨é—®é¢˜","date":"2022-01-11T11:05:01.751Z","updated":"2022-01-11T11:32:38.766Z","comments":true,"path":"2022/01/11/JUC/SimpleDateFormatç±»çš„çº¿ç¨‹å®‰å…¨é—®é¢˜/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/SimpleDateFormat%E7%B1%BB%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/","excerpt":"","text":"SimpleDateFormatåœ¨å¤šçº¿ç¨‹ä¸‹å­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜ã€‚â€‹ 1.é‡ç°SimpleDateFormatç±»çš„çº¿ç¨‹å®‰å…¨é—®é¢˜12345678910111213141516171819202122232425262728293031323334353637383940414243/** * * é‡ç°SimpleDateFormatç±»çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ * * @author äºŒå * @since 2021/9/12 10:05 ä¸‹åˆ */public class SdfTest &#123; /**æ‰§è¡Œæ€»æ¬¡æ•°*/ private static final int EXECUTE_COUNT=1000; /**å¹¶å‘çº¿ç¨‹æ•°*/ private static final int THREAD_COUNT=100; private static SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;); @Test public void test()throws Exception&#123; final Semaphore semaphore =new Semaphore(THREAD_COUNT); final CountDownLatch cdl = new CountDownLatch(EXECUTE_COUNT); ExecutorService executor = Executors.newCachedThreadPool(); for (int i = 0; i &lt; EXECUTE_COUNT; i++) &#123; executor.execute(()-&gt;&#123; try &#123; semaphore.acquire(); sdf.parse(&quot;2021-09-15&quot;); &#125;catch (Exception e)&#123; System.out.println(Thread.currentThread().getName()+&quot;æ ¼å¼åŒ–æ—¶é—´å¤±è´¥ï¼&quot;); &#125;finally &#123; semaphore.release(); cdl.countDown(); &#125; &#125;); &#125; cdl.await(); executor.shutdown(); &#125;&#125; è¯´æ˜ï¼šåœ¨é«˜å¹¶å‘ä¸‹ä½¿ç”¨SimpleDateFormatç±»æ ¼å¼åŒ–æ—¥æœŸçš„æ—¶å€™æŠ›å‡ºäº†å¼‚å¸¸ï¼ŒSimpleDateFormatç±»ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ä¸ºä»€ä¹ˆSimpleDateFormatä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ 2.SimpleDateFormatä¸ºä»€ä¹ˆä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ12345678910public Date parse(String source) throws ParseException &#123; ParsePosition pos = new ParsePosition(0); //è°ƒç”¨äº†parseæ–¹æ³•ï¼Œæœ€ç»ˆçš„å®ç°ç±»åœ¨SimpleDateFormatç±»ä¸­ Date result = parse(source, pos); if (pos.index == 0) throw new ParseException(&quot;Unparseable date: \\&quot;&quot; + source + &quot;\\&quot;&quot; , pos.errorIndex); return result;&#125; ç‚¹è¿›å»parse()ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ–¹æ³•ã€‚â€‹ 1public abstract Date parse(String source, ParsePosition pos); æœ€ç»ˆçš„å®ç°ç±»è¿˜æ˜¯åœ¨SimpleDateFormatç±»ä¸­ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105public Date parse(String text, ParsePosition pos)&#123; checkNegativeNumberExpression(); int start = pos.index; int oldStart = start; int textLength = text.length(); boolean[] ambiguousYear = &#123;false&#125;; CalendarBuilder calb = new CalendarBuilder(); for (int i = 0; i &lt; compiledPattern.length; ) &#123; int tag = compiledPattern[i] &gt;&gt;&gt; 8; int count = compiledPattern[i++] &amp; 0xff; if (count == 255) &#123; count = compiledPattern[i++] &lt;&lt; 16; count |= compiledPattern[i++]; &#125; switch (tag) &#123; case TAG_QUOTE_ASCII_CHAR: if (start &gt;= textLength || text.charAt(start) != (char)count) &#123; //ç ´åäº†çº¿ç¨‹çš„å®‰å…¨æ€§ pos.index = oldStart; //ç ´åäº†çº¿ç¨‹çš„å®‰å…¨æ€§ pos.errorIndex = start; return null; &#125; start++; break; case TAG_QUOTE_CHARS: while (count-- &gt; 0) &#123; if (start &gt;= textLength || text.charAt(start) != compiledPattern[i++]) &#123; pos.index = oldStart;//ç ´åäº†çº¿ç¨‹çš„å®‰å…¨æ€§ pos.errorIndex = start;//ç ´åäº†çº¿ç¨‹çš„å®‰å…¨æ€§ return null; &#125; start++; &#125; break; default: boolean obeyCount = false; boolean useFollowingMinusSignAsDelimiter = false; if (i &lt; compiledPattern.length) &#123; int nextTag = compiledPattern[i] &gt;&gt;&gt; 8; if (!(nextTag == TAG_QUOTE_ASCII_CHAR || nextTag == TAG_QUOTE_CHARS)) &#123; obeyCount = true; &#125; if (hasFollowingMinusSign &amp;&amp; (nextTag == TAG_QUOTE_ASCII_CHAR || nextTag == TAG_QUOTE_CHARS)) &#123; int c; if (nextTag == TAG_QUOTE_ASCII_CHAR) &#123; c = compiledPattern[i] &amp; 0xff; &#125; else &#123; c = compiledPattern[i+1]; &#125; if (c == minusSign) &#123; useFollowingMinusSignAsDelimiter = true; &#125; &#125; &#125; start = subParse(text, start, tag, count, obeyCount, ambiguousYear, pos, useFollowingMinusSignAsDelimiter, calb); if (start &lt; 0) &#123; //ç ´åäº†çº¿ç¨‹çš„å®‰å…¨æ€§ pos.index = oldStart; return null; &#125; &#125; &#125; //ç ´åäº†çº¿ç¨‹çš„å®‰å…¨æ€§ pos.index = start; Date parsedDate; try &#123; parsedDate = calb.establish(calendar).getTime(); if (ambiguousYear[0]) &#123; if (parsedDate.before(defaultCenturyStart)) &#123; parsedDate = calb.addYear(100).establish(calendar).getTime(); &#125; &#125; &#125; catch (IllegalArgumentException e) &#123; //ç ´åäº†çº¿ç¨‹çš„å®‰å…¨æ€§ pos.errorIndex = start; //ç ´åäº†çº¿ç¨‹çš„å®‰å…¨æ€§ pos.index = oldStart; return null; &#125; return parsedDate;&#125; é€šè¿‡å¯¹SimpleDateFormatç±»ä¸­çš„parse()è¿›è¡Œåˆ†æå¯ä»¥å¾—çŸ¥ï¼šparse()ä¸­å­˜åœ¨å‡ å¤„ä¸ºParsePositionç±»ä¸­çš„ç´¢å¼•èµ‹å€¼çš„æ“ä½œã€‚â€‹ ä¸€æ—¦å°†SimpleDateFormatç±»å®šä¹‰æˆå…¨å±€é™æ€å˜é‡ï¼Œé‚£ä¹ˆSimpleDateFormatç±»åœ¨å¤šçº¿ç¨‹ä¹‹é—´æ˜¯å…±äº«çš„ï¼Œè¿™å°±ä¼šå¯¼è‡´ParsePositionç±»åœ¨å¤šçº¿ç¨‹ä¹‹é—´å…±äº«ã€‚â€‹ åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ParsePositionç±»ä¸­çš„ç´¢å¼•è¿›è¡Œä¿®æ”¹ï¼Œä¸€å®šä¼šå½±å“åˆ°å…¶ä»–çº¿ç¨‹å¯¹ParsePositionç±»ä¸­ç´¢å¼•çš„è¯»ã€‚è¿™å°±é€ æˆäº†çº¿ç¨‹çš„å®‰å…¨é—®é¢˜ã€‚â€‹ é‚£ä¹ˆåœ¨ç¡®å®šäº†SimpleDateFormatçº¿ç¨‹ä¸å®‰å…¨çš„åŸå› ä»¥åï¼Œå¦‚ä½•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚â€‹ 3.SimpleDateFormatç±»çº¿ç¨‹å®‰å…¨çš„è§£å†³3.1 å±€éƒ¨å˜é‡æ³•12345678910111213141516171819202122232425262728293031323334public class SdfTest &#123; /**æ‰§è¡Œæ€»æ¬¡æ•°*/ private static final int EXECUTE_COUNT=1000; /**å¹¶å‘çº¿ç¨‹æ•°*/ private static final int THREAD_COUNT=100; @Test public void test()throws Exception&#123; SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;); final Semaphore semaphore =new Semaphore(THREAD_COUNT); final CountDownLatch cdl = new CountDownLatch(EXECUTE_COUNT); ExecutorService executor = Executors.newCachedThreadPool(); for (int i = 0; i &lt; EXECUTE_COUNT; i++) &#123; executor.execute(()-&gt;&#123; try &#123; semaphore.acquire(); sdf.parse(&quot;2021-09-15&quot;); &#125;catch (Exception e)&#123; System.out.println(Thread.currentThread().getName()+&quot;æ ¼å¼åŒ–æ—¶é—´å¤±è´¥ï¼&quot;); &#125;finally &#123; semaphore.release(); cdl.countDown(); &#125; &#125;); &#125; cdl.await(); executor.shutdown(); &#125;&#125; è¿™ç§æ–¹å¼åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¼šåˆ›å»ºå¤§é‡çš„SimpleDateFormatå¯¹è±¡ï¼Œå½±å“ç¨‹åºçš„æ€§èƒ½ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æ–¹å¼åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸å¤ªæ¨èã€‚â€‹ 3.2 synchronized1234567891011121314151617181920212223242526272829303132333435public class SdfTest &#123; /**æ‰§è¡Œæ€»æ¬¡æ•°*/ private static final int EXECUTE_COUNT=1000; /**å¹¶å‘çº¿ç¨‹æ•°*/ private static final int THREAD_COUNT=100; private static SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);; @Test public void test()throws Exception&#123; final Semaphore semaphore =new Semaphore(THREAD_COUNT); final CountDownLatch cdl = new CountDownLatch(EXECUTE_COUNT); ExecutorService executor = Executors.newCachedThreadPool(); for (int i = 0; i &lt; EXECUTE_COUNT; i++) &#123; executor.execute(()-&gt;&#123; try &#123; semaphore.acquire(); synchronized (sdf)&#123; sdf.parse(&quot;2021-09-15&quot;); &#125; &#125;catch (Exception e)&#123; System.out.println(Thread.currentThread().getName()+&quot;æ ¼å¼åŒ–æ—¶é—´å¤±è´¥ï¼&quot;); &#125;finally &#123; semaphore.release(); cdl.countDown(); &#125; &#125;); &#125; cdl.await(); executor.shutdown(); &#125;&#125; è¿™ç§æ–¹å¼è§£å†³äº†ä»–çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯ç¨‹åºåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸ºSimpleDateFormatç±»å¯¹è±¡åŠ äº†synchronizedé”ï¼Œå¯¼è‡´åœ¨åŒä¸€æ—¶åˆ»åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ ¼å¼åŒ–æ—¶é—´çš„æ–¹æ³•ã€‚æ­¤æ—¶ä¼šå½±å“ç¨‹åºçš„æ€§èƒ½ï¼Œåœ¨è¦æ±‚é«˜å¹¶å‘çš„ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæ­¤ç§æ–¹å¼ä¹Ÿæ˜¯ä¸å¤ªæ¨èä½¿ç”¨çš„ã€‚â€‹ 3.3 Locké”æ–¹å¼1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class SdfTest &#123; /** * æ‰§è¡Œæ€»æ¬¡æ•° */ private static final int EXECUTE_COUNT = 1000; /** * å¹¶å‘çº¿ç¨‹æ•° */ private static final int THREAD_COUNT = 100; private static SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;); private static Lock lock = new ReentrantLock(); @Test public void test() throws Exception &#123; final Semaphore semaphore = new Semaphore(THREAD_COUNT); final CountDownLatch cdl = new CountDownLatch(EXECUTE_COUNT); ExecutorService executor = Executors.newCachedThreadPool(); for (int i = 0; i &lt; EXECUTE_COUNT; i++) &#123; executor.execute(() -&gt; &#123; try &#123; semaphore.acquire(); lock.lock(); try &#123; sdf.parse(&quot;2021-09-15&quot;); &#125; finally &#123; lock.unlock(); &#125; &#125; catch (Exception e) &#123; System.out.println(Thread.currentThread().getName() + &quot;æ ¼å¼åŒ–æ—¶é—´å¤±è´¥ï¼&quot;); &#125; finally &#123; semaphore.release(); cdl.countDown(); &#125; &#125;); &#125; cdl.await(); executor.shutdown(); &#125;&#125; é€šè¿‡ä»£ç å¾—çŸ¥ï¼šé¦–å…ˆå®šä¹‰äº†Lockç±»å‹çš„å…¨å±€é™æ€å˜é‡ä½œä¸ºåŠ é”å’Œé‡Šæ”¾é”çš„å¥æŸ„ã€‚ç„¶åå†SimpleDateFormat.parse()ä»£ç æ‰§è¡Œä¹‹å‰åŠ é”ã€‚â€‹ è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼šä¸ºäº†é˜²æ­¢ç¨‹åºæŠ›å‡ºå¼‚å¸¸è€Œå¯¼è‡´é”ä¸èƒ½è¢«é‡Šæ”¾ï¼Œä¸€å®šè¦å°†é‡Šæ”¾é”çš„æ“ä½œæ”¾åˆ°finallyä»£ç å—ã€‚â€‹ æ­¤ç§æ–¹å¼åœ¨å¹¶å‘ä¸‹åŒæ ·å½±å“æ€§èƒ½ï¼Œä¸å¤ªæ¨èåœ¨é«˜å¹¶å‘ç”Ÿäº§ä¸­ä½¿ç”¨ã€‚â€‹ 3.4ThreadLocalæ–¹å¼123456789101112131415161718192021222324252627282930313233343536373839public class SdfTest &#123; /** * æ‰§è¡Œæ€»æ¬¡æ•° */ private static final int EXECUTE_COUNT = 1000; /** * å¹¶å‘çº¿ç¨‹æ•° */ private static final int THREAD_COUNT = 100; private static ThreadLocal&lt;DateFormat&gt; threadLocal = ThreadLocal.withInitial(() -&gt; new SimpleDateFormat(&quot;yyyy-MM-dd&quot;)); @Test public void test() throws Exception &#123; final Semaphore semaphore = new Semaphore(THREAD_COUNT); final CountDownLatch cdl = new CountDownLatch(EXECUTE_COUNT); ExecutorService executor = Executors.newCachedThreadPool(); for (int i = 0; i &lt; EXECUTE_COUNT; i++) &#123; executor.execute(() -&gt; &#123; try &#123; semaphore.acquire(); threadLocal.get().parse(&quot;2021-09-15&quot;); &#125; catch (Exception e) &#123; System.out.println(Thread.currentThread().getName() + &quot;æ ¼å¼åŒ–æ—¶é—´å¤±è´¥ï¼&quot;); &#125; finally &#123; threadLocal.remove(); semaphore.release(); cdl.countDown(); &#125; &#125;); &#125; cdl.await(); executor.shutdown(); &#125;&#125; ä½¿ç”¨ThreadLocalå°†æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨çš„SimpleDateFormatå‰¯æœ¬ä¿å­˜åœ¨ThreadLocalä¸­ï¼Œå„ä¸ªçº¿ç¨‹åœ¨ä½¿ç”¨æ—¶äº’ä¸å¹²æ‰°ï¼Œä»è€Œè§£å†³äº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚â€‹ æ­¤ç§æ–¹å¼è¿è¡Œæ•ˆç‡æ¯”è¾ƒé«˜ï¼Œæ¨èåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä½¿ç”¨ã€‚â€‹ 3.5 DateTimeFormatterjdk8çº¿ç¨‹å®‰å…¨çš„æ—¶é—´æ—¥æœŸAPIã€‚â€‹ â€‹","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"ScheduledThreadPoolExecutorä¸Timerçš„åŒºåˆ«","slug":"JUC/ScheduledThreadPoolExecutorä¸Timerçš„åŒºåˆ«","date":"2022-01-11T11:04:52.884Z","updated":"2022-01-11T11:33:09.480Z","comments":true,"path":"2022/01/11/JUC/ScheduledThreadPoolExecutorä¸Timerçš„åŒºåˆ«/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/ScheduledThreadPoolExecutor%E4%B8%8ETimer%E7%9A%84%E5%8C%BA%E5%88%AB/","excerpt":"","text":"JDK1.5å¼€å§‹æä¾›ScheduledThreadPoolExecutorç±»ï¼ŒScheduledThreadPoolExecutorç±»ç»§æ‰¿ThreadPoolExecutorç±»é‡ç”¨çº¿ç¨‹æ± å®ç°äº†ä»»åŠ¡çš„å‘¨æœŸæ€§è°ƒåº¦åŠŸèƒ½ã€‚åœ¨IDK1.5ä¹‹å‰ï¼Œå®ç°ä»»åŠ¡çš„å‘¨æœŸæ€§è°ƒåº¦ä¸»è¦ä½¿ç”¨çš„æ˜¯Timerç±»å’ŒTimerTaskç±»ã€‚â€‹ 1.1çº¿ç¨‹è§’åº¦â€‹ Timeræ˜¯å•çº¿ç¨‹æ¨¡å¼ï¼Œå¦‚æœæŸä¸ªTimerTaskä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ¯”è¾ƒä¹…ï¼Œä¼šå½±å“åˆ°å…¶ä»–ä»»åŠ¡çš„è°ƒåº¦æ‰§è¡Œã€‚ ScheduledThreadPoolExecutoræ˜¯å¤šçº¿ç¨‹æ¨¡å¼ï¼Œå¹¶ä¸”é‡ç”¨çº¿ç¨‹æ± ï¼ŒæŸä¸ªScheduledFutureTaskä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´æ¯”è¾ƒä¹…ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–ä»»åŠ¡çš„è°ƒåº¦æ‰§è¡Œã€‚ â€‹ 1.2ç³»ç»Ÿæ—¶é—´æ•æ„Ÿåº¦ Timerè°ƒåº¦æ˜¯åŸºäºæ“ä½œç³»ç»Ÿçš„ç»å¯¹æ—¶é—´çš„ï¼Œå¯¹æ“ä½œç³»ç»Ÿçš„æ—¶é—´æ•æ„Ÿï¼Œä¸€æ—¦æ“ä½œç³»ç»Ÿçš„æ—¶é—´æ”¹å˜ï¼Œåˆ™Timerçš„è°ƒåº¦ä¸å†ç²¾ç¡®ã€‚ ScheduledThreadPoolExecutorè°ƒåº¦æ˜¯åŸºäºç›¸å¯¹æ—¶é—´çš„ï¼Œä¸å—æ“ä½œç³»ç»Ÿæ—¶é—´æ”¹å˜çš„å½±å“ã€‚ â€‹ 1.3æ˜¯å¦æ•è·å¼‚å¸¸â€‹ Timerä¸ä¼šæ•è·TimerTaskæŠ›å‡ºçš„å¼‚å¸¸ï¼ŒåŠ ä¸ŠTimeråˆæ˜¯å•çº¿ç¨‹çš„ã€‚ä¸€æ—¦æŸä¸ªè°ƒåº¦ä»»åŠ¡å‡ºç°å¼‚å¸¸åˆ™æ•´ä¸ªçº¿ç¨‹å°±ä¼šç»ˆæ­¢ï¼Œå…¶ä»–éœ€è¦è°ƒåº¦çš„ä»»åŠ¡ä¹Ÿä¸å†æ‰§è¡Œã€‚ ScheduledThreadPoolExecutoråŸºäºçº¿ç¨‹æ± æ¥å®ç°è°ƒåº¦åŠŸèƒ½ï¼ŒæŸä¸ªä»»åŠ¡æŠ›å‡ºå¼‚å¸¸åï¼Œå…¶ä»–ä»»åŠ¡ä»èƒ½æ­£å¸¸æ‰§è¡Œã€‚ â€‹ 1.4ä»»åŠ¡æ˜¯å¦å…·å¤‡ä¼˜å…ˆçº§â€‹ Timerä¸­æ‰§è¡Œçš„TimerTaskä»»åŠ¡æ•´ä½“ä¸Šæ²¡æœ‰ä¼˜å…ˆçº§çš„æ¦‚å¿µï¼Œåªæ˜¯æŒ‰ç…§ç³»ç»Ÿçš„ç»å¯¹æ—¶é—´æ¥æ‰§è¡Œä»»åŠ¡ã€‚ ScheduledThreadPoolExecutorä¸­æ‰§è¡Œçš„ScheduledFutureTaskç±»å®ç°äº†iavalang.Comparableæ¥å£å’Œjava.utilconcurrentDelayedæ¥å£ï¼Œè¿™ä¹Ÿå°±è¯´æ˜äº†ScheduledFutureTaskç±»ä¸­å®ç°äº†ä¸¤ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯javalangComparableæ¥å£çš„compareToæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯java.util.concurrentDelayedæ¥å£çš„getDelayæ–¹æ³•ã€‚åœ¨ScheduledFutureTaskç±»ä¸­compareToæ–¹æ³•æ–¹æ³•å®ç°äº†ä»»åŠ¡çš„æ¯”è¾ƒï¼Œè·ç¦»ä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´é—´éš”çŸ­çš„ä»»åŠ¡ä¼šæ’åœ¨å‰é¢ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè·ç¦»ä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´é—´éš”çŸ­çš„ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¯”è¾ƒé«˜ã€‚è€ŒgetDelayæ–¹æ³•åˆ™èƒ½å¤Ÿè¿”å›è·ç¦»ä¸‹æ¬¡ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´é—´éš”ã€‚ â€‹ 1.5æ˜¯å¦æ”¯æŒå¯¹ä»»åŠ¡æ’åº Timerä¸æ”¯æŒå¯¹ä»»åŠ¡çš„æ’åºã€‚ ScheduledThreadPoolExecutorç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªé™æ€å†…éƒ¨ç±»DelayedWorkQueue,DelayedWorkQueueç±»æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæœ‰åºé˜Ÿåˆ—ï¼Œä¸ºéœ€è¦è°ƒåº¦çš„æ¯ä¸ªä»»åŠ¡æŒ‰ç…§è·ç¦»ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´é—´éš”çš„å¤§å°æ¥æ’åº â€‹ 1.6èƒ½å¦è·å–è¿”å›çš„ç»“æœâ€‹ Timerä¸­æ‰§è¡Œçš„TimerTaskç±»åªæ˜¯å®ç°äº†iavaangRunnableæ¥å£ï¼Œæ— æ³•ä»TimerTaskä¸­è·å–è¿”å›çš„ç»“æœã€‚ ScheduledThreadPoolExecutorä¸­æ‰§è¡Œçš„ScheduledFutureTaskç±»ç»§æ‰¿äº†FutureTaskç±»ï¼Œèƒ½å¤Ÿé€šè¿‡éFutureæ¥è·å–è¿”å›çš„ç»“æœã€‚ â€‹ é€šè¿‡ä»¥ä¸Šå¯¹ScheduledThreadPoolExecutorç±»å’ŒTimerç±»çš„å¯¹æ¯”ï¼Œç›¸ä¿¡åœ¨JDK1.5ä¹‹åï¼Œå°±æ²¡æœ‰ä½¿ç”¨Timeræ¥å®ç°å®šæ—¶ä»»åŠ¡è°ƒåº¦çš„å¿…è¦äº†ã€‚â€‹ â€‹ â€‹ â€‹","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"çº¿ç¨‹é—´ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯","slug":"JUC/çº¿ç¨‹é—´ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯","date":"2022-01-11T11:04:43.563Z","updated":"2022-01-11T11:24:01.784Z","comments":true,"path":"2022/01/11/JUC/çº¿ç¨‹é—´ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/%E7%BA%BF%E7%A8%8B%E9%97%B4%E4%BC%A0%E9%80%92%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BF%A1%E6%81%AF/","excerpt":"","text":"1.å¤åˆ¶çˆ¶çº¿ç¨‹å˜é‡åˆ°å­çº¿ç¨‹åªæœ‰çˆ¶çº¿ç¨‹é‡Œé¢åˆ›å»ºä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™æ‰ä¼šå»è°ƒç”¨initæ‰ä¼šæœ‰inheritableThreadLocalsçš„æ‹·è´åŠ¨ä½œã€‚â€‹ 1234567891011121314151617181920212223242526272829303132333435public class InheriableThreadLocalTest &#123; private static ThreadLocal&lt;Integer&gt; context = new InheritableThreadLocal&lt;&gt;(); private static ExecutorService pool = Executors.newFixedThreadPool(2); static class MainThread extends Thread &#123; private int index; public MainThread(int index) &#123; this.index = index; &#125; @Override public void run() &#123; context.set(index); //ç”¨çº¿ç¨‹æ± çš„çº¿ç¨‹å°±ä¼šå‡ºç°ä¼ é€’ä¿¡æ¯é”™ä¹± //pool.execute(() -&gt; System.out.println(Thread.currentThread().getName()+&quot;:&quot; + context.get())); new Thread(()-&gt;System.out.println(Thread.currentThread().getName()+&quot;:&quot; + context.get())).start(); &#125; &#125; /** * å½“ä½¿ç”¨çº¿ç¨‹æ± æ¥è¿è¡Œæˆ‘ä»¬çš„å­çº¿ç¨‹çš„ä»»åŠ¡çš„æ—¶å€™ï¼Œ * é‡‡ç”¨InheriableThreadLocalæ˜¯æ— æ³•è§£å†³å˜é‡ä¼ é€’çš„é—®é¢˜çš„ */ public static void main(String[] args) &#123; for (int i = 0; i &lt; 10; i++) &#123; new MainThread(i).start(); &#125; pool.shutdown(); &#125;&#125; â€‹ æ³¨æ„ï¼šè¦æ±‚å¿…é¡»æ˜¯newçš„çº¿ç¨‹ï¼Œä¸èƒ½ä½¿ç”¨çº¿ç¨‹æ± çš„çº¿ç¨‹ï¼Œçº¿ç¨‹å¤ç”¨ä¼šå¯¼è‡´ä¿¡æ¯ä¼ é€’å‡ºé”™ã€‚ 2.è§£å†³æ— æ³•ä½¿ç”¨çº¿ç¨‹æ± çš„é—®é¢˜12345678910111213141516171819202122232425262728293031/** * @author äºŒå * @since 2021/9/14 11:15 ä¸Šåˆ */public class TransmittableTest &#123; private static TransmittableThreadLocal&lt;String&gt; context = new TransmittableThreadLocal&lt;&gt;(); private static ExecutorService pool = TtlExecutors.getTtlExecutorService(Executors.newFixedThreadPool(5)); static class MainThread extends Thread &#123; private int index; public MainThread(int index) &#123; this.index = index; &#125; @Override public void run() &#123; context.set(String.valueOf(index)); pool.execute(() -&gt; System.out.println(Thread.currentThread().getName()+&quot;:&quot; + context.get())); // new Thread(()-&gt;System.out.println(Thread.currentThread().getName()+&quot;:&quot; + context.get())).start(); &#125; &#125; public static void main(String[] args) &#123; for (int i = 0; i &lt; 10; i++) &#123; new MainThread(i).start(); &#125; pool.shutdown(); &#125;&#125; 3.æºç TransmittableThreadLocalç»§æ‰¿äº†InheritableThreadLocalï¼Œå…ˆç‚¹ä¸€ä¸‹InheritableThreadLocalç…ç…ã€‚â€‹ 1234567891011121314151617181920public class InheritableThreadLocal&lt;T&gt; extends ThreadLocal&lt;T&gt; &#123; /** * æ–°å»ºçº¿ç¨‹æ—¶ï¼Œå¦‚æœå½“å‰inheritableThreadLocalséç©ºï¼Œåˆ™ä¼šè·å–å½“å‰inheritableThreadLocalsä¼ é€’ç»™æ–°çº¿ç¨‹ */ protected T childValue(T parentValue) &#123; return parentValue; &#125; /** * InheritableThreadLocalå˜é‡çš„set/get/removeæ“ä½œéƒ½æ˜¯åœ¨inheritableThreadLocalsä¸Š */ ThreadLocalMap getMap(Thread t) &#123; return t.inheritableThreadLocals; &#125; /** * åˆ›å»ºinheritableThreadLocals */ void createMap(Thread t, T firstValue) &#123; t.inheritableThreadLocals = new ThreadLocalMap(this, firstValue); &#125;&#125; å¯¹TLè¿›è¡Œäº†ä¸€å±‚åŒ…è£…å’Œå¢å¼ºã€‚â€‹ Threadç±»ä¸­æœ‰ä¸¤ä¸ªThreadLocalç›¸å…³çš„ThreadLocalMapå±æ€§ï¼Œå¦‚ä¸‹ï¼š 12ThreadLocal.ThreadLocalMap threadLocalsï¼šThreadLocalå˜é‡ä½¿ç”¨ThreadLocal.ThreadLocalMap inheritableThreadLocalsï¼šInheritableThreadLocalå˜é‡ä½¿ç”¨ æ–°å»ºçº¿ç¨‹æ—¶ï¼Œå°†å½“å‰çº¿ç¨‹çš„inheritableThreadLocalsä¼ é€’ç»™æ–°çº¿ç¨‹ï¼Œè¿™é‡Œçš„ä¼ é€’æ˜¯å¯¹InheritableThreadLocalå˜é‡çš„æ•°æ®åšæµ…æ‹·è´ï¼ˆå¼•ç”¨å¤åˆ¶ï¼‰ï¼Œè¿™æ ·æ–°çº¿ç¨‹å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªInheritableThreadLocalå˜é‡æŸ¥çœ‹ä¸Šä¸€ä¸ªçº¿ç¨‹çš„æ•°æ®ã€‚â€‹ ä¸‹é¢ä»¥TtlRunnable.get()ä¸ºèµ·ç‚¹åˆ†æTTLçš„è®¾è®¡å®ç°ï¼ŒTtlRunnable.getæºç å¦‚ä¸‹ï¼ˆTtlRunnable.getæµç¨‹å¯¹åº”çš„åˆå§‹åŒ–æ—¶captureæ“ä½œï¼Œä¿å­˜å¿«ç…§ã€‚TtlCallableå’ŒTtlRunnableæµç¨‹ç±»ä¼¼ï¼‰ï¼šâ€‹ 12345678910111213141516171819202122232425public static TtlRunnable get(@Nullable Runnable runnable) &#123; return get(runnable, false, false);&#125;public static TtlRunnable get(@Nullable Runnable runnable, boolean releaseTtlValueReferenceAfterRun, boolean idempotent) &#123; if (runnable instanceof TtlEnhanced) &#123; // å¹‚ç­‰æ—¶ç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰§è¡Œä¼šäº§ç”Ÿé—®é¢˜ï¼Œç›´æ¥æŠ›å¼‚å¸¸ if (idempotent) return (TtlRunnable) runnable; else throw new IllegalStateException(&quot;Already TtlRunnable!&quot;); &#125; return new TtlRunnable(runnable, releaseTtlValueReferenceAfterRun);&#125;private TtlRunnable(@Nonnull Runnable runnable, boolean releaseTtlValueReferenceAfterRun) &#123; this.capturedRef = new AtomicReference&lt;Object&gt;(capture()); this.runnable = runnable; this.releaseTtlValueReferenceAfterRun = releaseTtlValueReferenceAfterRun;&#125;public static Object capture() &#123; Map&lt;TransmittableThreadLocal&lt;?&gt;, Object&gt; captured = new HashMap&lt;TransmittableThreadLocal&lt;?&gt;, Object&gt;(); // ä»holderè·å–æ‰€æœ‰threadLocalï¼Œå­˜åˆ°capturedï¼Œè¿™é‡Œç›¸å½“äºå¯¹å½“å‰çº¿ç¨‹holderåšä¸€ä¸ªå¿«ç…§ä¿å­˜ // åˆ°TtlRunnableå®ä¾‹å±æ€§ä¸­ï¼Œåœ¨æ‰§è¡ŒTtlRunnableæ—¶è¿›è¡Œå›æ”¾ for (TransmittableThreadLocal&lt;?&gt; threadLocal : holder.get().keySet()) &#123; captured.put(threadLocal, threadLocal.copyValue()); &#125; return captured;&#125; åœ¨æ–°å»ºTtlRunnableè¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜ä¸‹TransmittableThreadLocal.holderåˆ°capturedï¼Œè®°å½•åˆ°TtlRunnableå®ä¾‹ä¸­çš„capturedRefå­—æ®µï¼ŒTransmittableThreadLocal.holderç±»å‹æ˜¯ï¼š 123456789101112131415// Note about holder:// 1. The value of holder is type Map&lt;TransmittableThreadLocal&lt;?&gt;, ?&gt; (WeakHashMap implementation),// but it is used as *set*. å› ä¸ºæ²¡æœ‰WeakSetçš„åŸå› // 2. WeakHashMap support null value.private static InheritableThreadLocal&lt;Map&lt;TransmittableThreadLocal&lt;?&gt;, ?&gt;&gt; holder = new InheritableThreadLocal&lt;Map&lt;TransmittableThreadLocal&lt;?&gt;, ?&gt;&gt;() &#123; @Override protected Map&lt;TransmittableThreadLocal&lt;?&gt;, ?&gt; initialValue() &#123; return new WeakHashMap&lt;TransmittableThreadLocal&lt;?&gt;, Object&gt;(); &#125; @Override protected Map&lt;TransmittableThreadLocal&lt;?&gt;, ?&gt; childValue(Map&lt;TransmittableThreadLocal&lt;?&gt;, ?&gt; parentValue) &#123; return new WeakHashMap&lt;TransmittableThreadLocal&lt;?&gt;, Object&gt;(parentValue); &#125; &#125;; ä»ä¸Šé¢ä»£ç æˆ‘ä»¬çŸ¥é“åˆå§‹åŒ–TtlRunnableæ—¶å·²ç»å°†TransmittableThreadLocalä¿å­˜ä¸‹æ¥äº†ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™åº”ç”¨åˆ°å½“å‰çº¿ç¨‹ThreadLocalä¸­å‘¢ï¼Œè¿™æ˜¯å°±éœ€è¦çœ‹ä¸‹TtlRunnable.runæ–¹æ³•ï¼š 123456789101112131415public void run() &#123; Object captured = capturedRef.get(); // capturedä¸åº”è¯¥ä¸ºç©ºï¼ŒreleaseTtlValueReferenceAfterRunä¸ºtrueæ—¶è®¾ç½®capturedRefä¸ºnullï¼Œé˜²æ­¢å½“å‰Runnableé‡å¤æ‰§è¡Œ if (captured == null || releaseTtlValueReferenceAfterRun &amp;&amp; !capturedRef.compareAndSet(captured, null)) &#123; throw new IllegalStateException(&quot;TTL value reference is released after run!&quot;); &#125; // capturedè¿›è¡Œå›æ”¾ï¼Œåº”ç”¨åˆ°å½“å‰çº¿ç¨‹ä¸­ Object backup = replay(captured); try &#123; runnable.run(); &#125; finally &#123; restore(backup); &#125;&#125; æ³¨æ„ï¼ŒTTLä¸­çš„replayæ“ä½œæ˜¯ä»¥capturedä¸ºå½“å‰inheritableThreadLocalsçš„ï¼ˆå¤„ç†é€»è¾‘æ˜¯åœ¨TtlRunable runæ—¶ï¼Œä¼šä»¥TtlRunnable.getæ—¶é—´ç‚¹è·å–çš„capturedï¼ˆç±»ä¼¼TTLå¿«ç…§ï¼‰ä¸ºå‡†ï¼Œholderä¸­ä¸åœ¨capturedçš„å…ˆç§»é™¤ï¼Œåœ¨çš„ä¼šè¢«æ›¿æ¢ï¼‰ã€‚å›æ”¾capturedå’Œæ‰§è¡Œå®Œrunnable.runä¹‹åï¼Œå†restoreæ¢å¤åˆ°åŸæ¥inheritableThreadLocalsçš„çŠ¶æ€ã€‚ 4.è‡ªå·±å†™ä¸€ä¸ªè½»é‡çº§çš„123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168/** * @author äºŒå * @since 2021/9/14 3:13 ä¸‹åˆ */public class EsThreadLocal&lt;T&gt; extends InheritableThreadLocal&lt;T&gt; &#123; private static InheritableThreadLocal&lt;WeakHashMap&lt;EsThreadLocal&lt;Object&gt;, ?&gt;&gt; holder = new InheritableThreadLocal&lt;WeakHashMap&lt;EsThreadLocal&lt;Object&gt;, ?&gt;&gt;() &#123; @Override protected WeakHashMap&lt;EsThreadLocal&lt;Object&gt;, ?&gt; childValue(WeakHashMap&lt;EsThreadLocal&lt;Object&gt;, ?&gt; parentValue) &#123; return new WeakHashMap&lt;&gt;(parentValue); &#125; @Override protected WeakHashMap&lt;EsThreadLocal&lt;Object&gt;, ?&gt; initialValue() &#123; return new WeakHashMap&lt;&gt;(); &#125; &#125;; @Override public int hashCode() &#123; return super.hashCode(); &#125; @Override public boolean equals(Object obj) &#123; return super.equals(obj); &#125; @Override public T get() &#123; T value = super.get(); if (null != value) addToHolder(); return value; &#125; @Override public void set(T value) &#123; if (null == value) &#123; removeFromHolder(); super.remove(); &#125; else &#123; super.set(value); addToHolder(); &#125; &#125; private void removeFromHolder() &#123; holder.get().remove(this); &#125; private void addToHolder() &#123; if (!holder.get().containsKey(this)) holder.get().put((EsThreadLocal&lt;Object&gt;) this, null); &#125; static class SnapShot &#123; final WeakHashMap&lt;EsThreadLocal&lt;Object&gt;, Object&gt; ctlValue; private SnapShot(WeakHashMap&lt;EsThreadLocal&lt;Object&gt;, Object&gt; ctlValue) &#123; this.ctlValue = ctlValue; &#125; &#125; static class Transmitter &#123; public static SnapShot capture() &#123; return new SnapShot(captureCtlValues()); &#125; private static WeakHashMap&lt;EsThreadLocal&lt;Object&gt;, Object&gt; captureCtlValues() &#123; return holder.get().keySet().stream().collect(Collectors.toMap(ctlItem -&gt; ctlItem, EsThreadLocal::get, (a, b) -&gt; b, WeakHashMap::new)); &#125; public static SnapShot replay(SnapShot snapShot) &#123; WeakHashMap&lt;EsThreadLocal&lt;Object&gt;, Object&gt; capture = snapShot.ctlValue; WeakHashMap&lt;EsThreadLocal&lt;Object&gt;, Object&gt; backValue = new WeakHashMap&lt;&gt;(); /* * ä»holderä¸­è·å–å½“å‰çº¿ç¨‹æŒæœ‰çš„threadLocalçš„Map,è¿›è¡Œè¿­ä»£ä¿å­˜ */ Iterator&lt;EsThreadLocal&lt;Object&gt;&gt; iterator = holder.get().keySet().iterator(); while (iterator.hasNext()) &#123; EsThreadLocal&lt;Object&gt; threadLocal = iterator.next(); backValue.put(threadLocal, threadLocal.get()); if (!capture.containsKey(threadLocal)) &#123; iterator.remove(); threadLocal.remove(); &#125; &#125; /* è®¾ç½®ä¸Šcapture */ setThreadLocal(capture); return new SnapShot(backValue); &#125; public static void setThreadLocal(WeakHashMap&lt;EsThreadLocal&lt;Object&gt;, Object&gt; ctlValues) &#123; ctlValues.forEach(EsThreadLocal::set); &#125; public static void restore(EsThreadLocal.SnapShot backUp) &#123; Iterator&lt;EsThreadLocal&lt;Object&gt;&gt; iterator = holder.get().keySet().iterator(); while (iterator.hasNext()) &#123; EsThreadLocal&lt;Object&gt; threadLocal = iterator.next(); if (!backUp.ctlValue.containsKey(threadLocal)) &#123; iterator.remove(); threadLocal.remove(); &#125; &#125; setThreadLocal(backUp.ctlValue); &#125; &#125; static class EsRunnable implements Runnable &#123; private AtomicReference&lt;SnapShot&gt; captureRef; private Runnable runnable; public EsRunnable(Runnable runnable) &#123; this.runnable = runnable; captureRef = new AtomicReference&lt;&gt;(Transmitter.capture()); &#125; @Override public void run() &#123; SnapShot capture = captureRef.get(); SnapShot backUp = Transmitter.replay(capture); try &#123; runnable.run(); &#125; finally &#123; Transmitter.restore(backUp); &#125; &#125; public static EsRunnable getRunnable(Runnable runnable) &#123; return new EsRunnable(runnable); &#125; &#125;&#125;class Test &#123; private static ThreadLocal&lt;String&gt; context = new EsThreadLocal&lt;&gt;(); private static ExecutorService pool = Executors.newFixedThreadPool(5); public static void main(String[] args)throws Exception &#123; for (int i = 1; i &lt;=10; i++) &#123; context.set(String.valueOf(i)); pool.execute(new EsThreadLocal.EsRunnable(()-&gt;System.out.println(Thread.currentThread().getName()+&quot; : &quot; + context.get() ))); TimeUnit.SECONDS.sleep(1); &#125; pool.shutdown(); &#125;&#125; è¿è¡Œç»“æœï¼š","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"é«˜å¹¶å‘è®¾è®¡æ¨¡å¼","slug":"JUC/é«˜å¹¶å‘è®¾è®¡æ¨¡å¼","date":"2022-01-11T11:04:33.684Z","updated":"2022-01-11T11:23:00.096Z","comments":true,"path":"2022/01/11/JUC/é«˜å¹¶å‘è®¾è®¡æ¨¡å¼/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/%E9%AB%98%E5%B9%B6%E5%8F%91%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/","excerpt":"","text":"å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¸¸è§çš„è®¾è®¡æ¨¡å¼å¯èƒ½å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œæ¯”å¦‚å•ä¾‹æ¨¡å¼å°±æ˜¯ä¸€ä¸ªå…¸å‹ã€‚å¦å¤–ï¼Œä¸ºäº†å……åˆ†å‘æŒ¥å¤šæ ¸çš„ä¼˜åŠ¿ï¼Œé«˜å¹¶å‘ç¨‹åºé€šå¸¸ä¼šå°†å¤§çš„ä»»åŠ¡åˆ†å‰²æˆä¸€äº›è§„æ¨¡æ¯”è¾ƒå°çš„ä»»åŠ¡ï¼Œåˆ†è€Œæ²»ä¹‹ï¼Œè¿™å°±å‡ºç°äº†é«˜å¹¶å‘ä¸‹ç‰¹æœ‰çš„ä¸€äº›è®¾è®¡æ¨¡å¼ï¼Œæ¯”å¦‚ForkJoinæ¨¡å¼ç­‰ç­‰ã€‚ ä¸€ï¼Œçº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼1.åŒé‡æ£€æŸ¥é”12345678910111213141516171819202122232425262728public class SingletonTestA &#123; private static volatile SingletonTestA instance; private SingletonTestA() &#123; &#125; public static SingletonTestA getInstance() &#123; /**åˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œå¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œç›´æ¥è¿”å›ã€‚å¦‚æœå°šæœªåˆå§‹åŒ–ï¼ŒåŠ é”*/ if (instance == null) synchronized (SingletonTestA.class) &#123; /**å†æ¬¡åˆ¤æ–­æ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œé€šè¿‡ç¬¬ä¸€å±‚åˆ¤æ–­çš„çº¿ç¨‹å¯èƒ½æœ‰å¾ˆå¤šï¼Œä½†æ˜¯èƒ½å¤Ÿè·å¾—é”çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ªã€‚*/ if (instance == null) /* åˆ†é…ä¸€å—å†…å­˜M åœ¨å†…å­˜Mä¸Šåˆå§‹åŒ–Singletonå¯¹è±¡ Mçš„åœ°å€èµ‹å€¼ç»™instanceå˜é‡ æŒ‡ä»¤é‡æ’åå¯èƒ½ä¼šå‡ºç°é—®é¢˜ */ instance = new SingletonTestA(); &#125; return instance; &#125;&#125; 2.é™æ€å†…éƒ¨ç±»1234567891011121314151617public class SingletonTestA &#123; private static class LazyHolder&#123; private static final SingletonTestA instance = new SingletonTestA(); &#125; private SingletonTestA() &#123; &#125; /** * åªæœ‰åœ¨æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œæ‰ä¼šå»åŠ è½½å†…éƒ¨ç±»å¹¶ä¸”åˆå§‹åŒ–å•ä¾‹ã€‚ * @return */ public static SingletonTestA getInstance() &#123; return LazyHolder.instance; &#125;&#125; äºŒï¼ŒMaster-Worderæ¨¡å¼Master-Workeræ¨¡å¼æ˜¯ä¸€ç§å¸¸è§çš„é«˜å¹¶å‘æ¨¡å¼ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ä»»åŠ¡çš„è°ƒåº¦å’Œæ‰§è¡Œåˆ†ç¦»ï¼Œè°ƒåº¦ä»»åŠ¡çš„è§’åŒ…äº”ä¸ºMasterï¼Œæ‰§è¡Œä»»åŠ¡çš„è§’è‰²ä¸º Workerï¼ŒMasterè´Ÿè´£æ¥æ”¶ã€åˆ†é…ä»»åŠ¡åŠ¡å’Œåˆå¹¶(Merge)ä»»åŠ¡ç»“æœï¼Œ Workerè´Ÿè´£æ‰§è¡Œä»»åŠ¡ã€‚Master-Work eræ¨¡å¼æ˜¯ä¸€ç§å½’å¹¶ç±»å‹çš„æ¨¡å¼ã€‚ ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œåœ¨TCPæœåŠ¡ç«¯çš„è¯·é’æ±‚å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¤§é‡çš„å®¢æˆ·ç«¯è¿æ¥ç›¸å½“äºå¤§é‡çš„ä»»åŠ¡ï¼ŒMasteréœ€è¦å°†è¿™äº›ä»»åŠ¡å­˜å‚¨åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç„¶ååˆ†å‘ç»™å„ä¸ªWorkerï¼Œæ¯ä¸ªWorkeræ˜¯ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œè´Ÿè´£å®Œæˆè¿æ¥çš„ä¼ è¾“å¤„ç†ã€‚ å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼Œéœ€è¦æ‰§è¡ŒNä¸ªä»»åŠ¡ï¼Œå°†è¿™äº›ä»»åŠ¡çš„ç»“æœè¿›è¡Œç´¯åŠ æ±‚å’Œï¼Œå¦‚æœä»»åŠ¡å¤ªå¤šï¼Œå°±å¯ä»¥é‡‡ç”¨Master-Workeræ¨¡å¼æ¥å®ç°ã€‚MasteræŒæœ‰workerCountä¸ªWorkerï¼Œå¹¶ä¸”è´Ÿè´£æ¥æ”¶ä»»åŠ¡ï¼Œç„¶ååˆ†å‘ç»™Workerï¼Œæœ€ååœ¨å›è°ƒå‡½æ•°ä¸­å¯¹Workerçš„ç»“æœè¿›è¡Œå½’å¹¶æ±‚å’Œã€‚ 1.ä»£ç å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183/** * @author äºŒå * @since 2021/9/14 9:52 ä¸‹åˆ */public class MasterWorkerTest &#123; static class SimpleTask extends Task&lt;Integer&gt; &#123; @Override protected Integer doExecute() &#123; System.out.println(&quot;task &quot; + getId() + &quot; is done !&quot;); return getId(); &#125; &#125; public static void main(String[] args) &#123; //åˆ›å»ºmasterï¼ŒåŒ…å«4ä¸ªworkerï¼Œå¹¶å¯åŠ¨masterçš„æ‰§è¡Œçº¿ç¨‹ Master&lt;SimpleTask, Integer&gt; master = new Master&lt;&gt;(4); //å®šæœŸå‘masteræäº¤ä»»åŠ¡ ScheduledExecutorService executorService = Executors.newScheduledThreadPool(10); executorService.scheduleAtFixedRate(() -&gt; master.submit(new SimpleTask()), 2L, 2L, TimeUnit.SECONDS); //å®šæœŸä»masteræå–ç»“æœ executorService.scheduleAtFixedRate(() -&gt; master.printResult(), 5, 2, TimeUnit.SECONDS); &#125;&#125;/** * å¼‚æ­¥ä»»åŠ¡ç±»åœ¨æ‰§è¡Œå­ç±»ä»»åŠ¡çš„doExecute()ä¹‹åï¼Œ * å›è°ƒä¸€ä¸‹Masterä¼ é€’è¿‡æ¥çš„å›è°ƒå‡½æ•°ï¼Œ * å°†æ‰§è¡Œå®Œæˆåçš„ä»»åŠ¡è¿›è¡Œå›å¡«ã€‚ * * @param &lt;R&gt; */@Dataclass Task&lt;R&gt; &#123; static AtomicInteger index = new AtomicInteger(1); //ä»»åŠ¡çš„å›è°ƒå‡½æ•° public Consumer&lt;Task&lt;R&gt;&gt; resultAction; //ä»»åŠ¡çš„id private int id; //worker id private int workerId; //è®¡ç®—ç»“æœ R result = null; public Task() &#123; this.id = index.getAndIncrement(); &#125; public void execute() &#123; this.result = this.doExecute(); resultAction.accept(this); &#125; //é’©å­æ–¹æ³•ï¼Œäº¤ç»™å­ç±»å®ç° protected R doExecute() &#123; return null; &#125;&#125;/** * Master è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯æäº¤é¢ä»»åŠ¡ï¼Œç„¶åé€šè¿‡é˜»å¡é˜Ÿåˆ—å¯¹ä»»åŠ¡è¿›è¡Œç¼“å­˜ã€‚ * Masteræ‰€æ‹¥æœ‰çš„çº¿ç¨‹ä½œä¸ºé˜»å¡é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—è·å–ä»»åŠ¡å¹¶è½®æµåˆ†ç»™Workerã€‚ * * @param &lt;T&gt; * @param &lt;R&gt; */class Master&lt;T extends Task, R&gt; &#123; //workeré›†åˆ private Map&lt;String, Worker&lt;T, R&gt;&gt; workers = new HashMap&lt;&gt;(); //ä»»åŠ¡é›†åˆ protected LinkedBlockingQueue&lt;T&gt; taskQueue = new LinkedBlockingQueue&lt;&gt;(); //ä»»åŠ¡å¤„ç†ç»“æœé›†åˆ protected Map&lt;String, R&gt; resultMap = new ConcurrentHashMap&lt;&gt;(); //Masterçš„ä»»åŠ¡è°ƒåº¦çº¿ç¨‹ private Thread thread = null; //ä¿æŒæœ€ç»ˆçš„å’Œ private AtomicLong sum = new AtomicLong(0); public Master(int workerCount) &#123; //æ¯ä¸€ä¸ªworkerå¯¹è±¡éƒ½éœ€è¦æŒæœ‰é˜Ÿåˆ—çš„å¼•ç”¨ï¼Œç”¨äºé¢†å–ä»»åŠ¡å’Œæäº¤ç»“æœ for (int i = 0; i &lt; workerCount; i++) &#123; Worker&lt;T, R&gt; worker = new Worker&lt;&gt;(); workers.put(&quot;å­èŠ‚ç‚¹ï¼š&quot; + i, worker); &#125; thread = new Thread(() -&gt; this.execute()); thread.start(); &#125; //æäº¤ä»»åŠ¡ public void submit(T task) &#123; taskQueue.add(task); &#125; //è·å–workerç»“æœå¤„ç†çš„å›è°ƒå‡½æ•° private void resultCallback(Object o) &#123; Task&lt;R&gt; task = (Task&lt;R&gt;) o; String taskName = &quot;Worker:&quot; + task.getWorkerId() + &quot;-&quot; + &quot;Task:&quot; + task.getId(); R result = task.getResult(); resultMap.put(taskName, result); sum.getAndAdd((Integer) result); &#125; //å¯åŠ¨æ‰€æœ‰çš„å­ä»»åŠ¡ public void execute() &#123; for (; ; ) &#123; for (Map.Entry&lt;String, Worker&lt;T, R&gt;&gt; entry : workers.entrySet()) &#123; T task = null; try &#123; //è·å–ä»»åŠ¡ task = this.taskQueue.take(); //è·å–èŠ‚ç‚¹ Worker worker = entry.getValue(); //åˆ†é…ä»»åŠ¡ worker.submit(task, this::resultCallback); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; &#125; &#125; //è·å–æœ€ç»ˆç»“æœ public void printResult() &#123; System.out.println(&quot;sum is : &quot; + sum.get()); for (Map.Entry&lt;String, R&gt; entry : resultMap.entrySet()) System.out.println(entry.getKey() + &quot; : &quot; + entry.getValue()); &#125;&#125;/** * Workeræ¥æ”¶Masteråˆ†é…çš„ä»»åŠ¡ï¼ŒåŒæ ·ä¹Ÿé€šè¿‡é˜»å¡é˜Ÿåˆ—å¯¹å±€éƒ¨ä»»åŠ¡è¿›è¡Œç¼“å­˜ã€‚ * Workeræ‰€æ‹¥æœ‰çš„çš„çº¿ç¨‹ä½œä¸ºæ‹’ä¸ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ï¼Œ * ä¸æ–­ä»é˜»å¡é˜Ÿåˆ—è·å–ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæˆåå›è°ƒMasterä¼ é€’è¿‡æ¥çš„å›è°ƒå‡½æ•°ã€‚ * * @param &lt;T&gt; * @param &lt;R&gt; */class Worker&lt;T extends Task, R&gt; &#123; //æ¥å—ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ— private LinkedBlockingQueue&lt;T&gt; taskQueue = new LinkedBlockingQueue&lt;&gt;(); //Workerçš„ç¼–å· private static AtomicInteger index = new AtomicInteger(1); private int workerId; //æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ private Thread thread = null; public Worker() &#123; this.workerId = index.getAndIncrement(); thread = new Thread(() -&gt; this.run()); thread.start(); &#125; //è½®è®­æ‰§è¡Œä»»åŠ¡ public void run() &#123; //è½®è®­å¯åŠ¨ä»»åŠ¡ for (; ; ) &#123; try &#123; //ä»é˜»å¡é˜Ÿåˆ—æå–ä»»åŠ¡ T task = this.taskQueue.take(); task.setWorkerId(workerId); task.execute(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; &#125; //æ¥æ”¶ä»»åŠ¡åˆ°å¼‚æ­¥é˜Ÿåˆ— public void submit(T task, Consumer&lt;R&gt; action) &#123; //è®¾ç½®ä»»åŠ¡çš„å›è°ƒæ–¹æ³• task.resultAction = action; try &#123; this.taskQueue.put(task); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;&#125; 2.Nettyä¸­Master-Workeræ¨¡å¼çš„å®ç°Master-Workeræ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯åˆ†è€Œæ²»ä¹‹ï¼ŒMasterè§’è‰²è´Ÿè´£æ¥æ”¶å’Œåˆ†é…ä»»åŠ¡ï¼ŒWorkerè§’è‰²è´Ÿè´£æ‰§è¡Œä»»åŠ¡å’Œç»“æœå›å¡«ã€‚ å®é™…ä¸Šï¼Œé«˜æ€§èƒ½ä¼ è¾“æ¨¡å¼Reactoræ¨¡å¼å°±æ˜¯Master-Workeræ¨¡å¼åœ¨ä¼ è¾“é¢†åŸŸçš„ä¸€ç§åº”ç”¨ã€‚åŸºäºJavaçš„NIOæŠ€æœ¯ï¼ŒNettvè®¾è®¡äº†ä¸€å¥—ä¼˜ç§€çš„ã€é«˜æ€§èƒ½Reactor(ååº”å™¨)æ¨¡å¼çš„å…·ä½“å®ç°ã€‚åœ¨Nettyä¸­ï¼ŒEventLoopååº”å™¨å†…éƒ¨æœ‰ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£JavaNIOé€‰æ‹©å™¨çš„äº‹ä»¶è½®è¯¢ï¼Œç„¶åè¿›è¡Œå¯¹åº”çš„äº‹ä»¶åˆ†å‘ã€‚äº‹ä»¶åˆ†å‘çš„ç›®æ ‡å°±æ˜¯Nettyçš„Handlerå¤„ç†ç¨‹åº(å«ç”¨æˆ·å®šä¹‰çš„ä¸šåŠ¡å¤„ç†ç¨‹åº)ã€‚ NettyæœåŠ¡å™¨ç¨‹åºä¸­éœ€è¦è®¾ç½®ä¸¤ä¸ªEventLoopGroupè½®è¯¢ç»„ï¼Œä¸€ä¸ªç»„è´Ÿè´£æ–°è¿æ¥çš„ç›‘å¬å’Œæ¥æ”¶ï¼Œå¦ä¸€ä¸ªç»„è´Ÿè´£IOä¼ è¾“äº‹ä»¶çš„è½®è¯¢ä¸åˆ†å‘ï¼Œä¸¤ä¸ªè½®è¯¢ç»„çš„èŒè´£å…·ä½“å¦‚ä¸‹: (1)è´Ÿè´£æ–°è¿æ¥çš„ç›‘å¬å’Œæ¥æ”¶çš„EventLoopGroupè½®è¯¢ç»„ä¸­çš„ååº”å™¨å®ŒæˆæŸ¥è¯¢é€šé“çš„æ–°è¿æ¥IOäº‹ä»¶æŸ¥è¯¢ï¼Œè¿™äº›ååº”å™¨æœ‰ç‚¹åƒè´Ÿè´£æ‹›å·¥çš„åŒ…å·¥å¤´ï¼Œå› æ­¤è¯¥è½®è¯¢ç»„å¯ä»¥å½¢è±¡åœ°ç§°ä¸ºâ€œåŒ…å·¥å¤´â€(Boss)è½®è¯¢ç»„ã€‚ (2)å¦ä¸€ä¸ªè½®è¯¢ç»„ä¸­çš„ååº”å™¨å®ŒæˆæŸ¥è¯¢æ‰€æœ‰å­é€šé“çš„IOäº‹ä»¶ï¼Œå¹¶ä¸”æ‰§è¡Œå¯¹åº”çš„Handlerå¤„ç†ç¨‹åºå®ŒæˆI0å¤„ç†ï¼Œä¾‹å¦‚æ•°æ®çš„è¾“å…¥å’Œè¾“å‡º(æœ‰ç‚¹åƒæ¬ç –)ï¼Œè¿™ä¸ªè½®è¯¢ç»„å¯ä»¥å½¢è±¡åœ°ç§°ä¸ºâ€œå·¥äººâ€(Worker)è½®è¯¢ç»„ã€‚ Nettyæ˜¯åŸºäºReactoræ¨¡å¼çš„å…·ä½“å®ç°ï¼Œä½“ç°äº†Master-Workeræ¨¡å¼çš„æ€æƒ³ã€‚Nettyçš„EventLoop(Reactorè§’è‰²)å¯ä»¥å¯¹åº”åˆ°Master-Workeræ¨¡å¼çš„Workerè§’è‰²ï¼Œè€ŒNettyçš„EventLoopGroupè½®è¯¢ç»„åˆ™å¯ä»¥å¯¹åº”åˆ°Master-Workeræ¨¡å¼çš„Masterè§’è‰²ã€‚ 3.Nginxä¸­Master-Workeræ¨¡å¼çš„å®ç°å¤§åé¼é¼çš„NginxæœåŠ¡å™¨æ˜¯Master-Workeræ¨¡å¼(æ›´å‡†ç¡®åœ°è¯´æ˜¯Reactoræ¨¡å¼)åœ¨é«˜æ€§èƒ½æœåŠ¡å™¨é¢†åŸŸçš„ä¸€ç§åº”ç”¨ã€‚Nginxæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ HTTPå’Œåå‘ä»£ç†WebæœåŠ¡å™¨ï¼Œæ˜¯ç”±ä¼Šæˆˆå°”Â·èµ›ç´¢è€¶å¤«ä¸ºä¿„ç½—æ–¯è®¿é—®é‡ç¬¬äºŒçš„Ramblerruç«™ç‚¹å¼€å‘çš„WebæœåŠ¡å™¨ã€‚Nginxæºä»£ç ä»¥ç±»BSDè®¸å¯è¯çš„å½¢å¼å‘å¸ƒï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå…¬å¼€ç‰ˆæœ¬010å‘å¸ƒäº2004å¹´10æœˆ4æ—¥ï¼Œ2011å¹´6æœˆ1æ—¥å‘å¸ƒäº†1.0.4ç‰ˆæœ¬ã€‚Nginxå› å…¶é«˜ç¨³å®šæ€§ã€ä¸°å¯Œçš„åŠŸèƒ½é›†ã€å†…å­˜æ¶ˆè€—å°‘ã€å¹¶å‘èƒ½åŠ›å¼ºè€Œé—»åå…¨çƒï¼Œç›®å‰å¾—åˆ°éå¸¸å¹¿æ³›çš„ä½¿ç”¨ï¼Œæ¯”å¦‚ç™¾åº¦ã€äº¬ä¸œã€æ–°æµªã€ç½‘æ˜“ã€è…¾è®¯ã€æ·˜å®ç­‰éƒ½æ˜¯å®ƒçš„ç”¨æˆ·ã€‚ Nginxåœ¨å¯åŠ¨åä¼šä»¥daemonæ–¹å¼åœ¨åå°è¿è¡Œï¼Œå®ƒçš„åå°è¿›ç¨‹æœ‰ä¸¤ç±»:ä¸€ç±»ç§°ä¸ºMasterè¿›ç¨‹(ç›¸å½“äºç®¡ç†è¿›ç¨‹)ï¼Œå¦ä¸€ç±»ç§°ä¸ºWorkerè¿›ç¨‹(å·¥ä½œè¿›ç¨‹)ã€‚Nginxçš„è¿›ç¨‹ç»“æ„å›¾å¦‚å›¾ã€‚ Nginxçš„Masterè¿›ç¨‹ä¸»è¦è´Ÿè´£è°ƒåº¦Workerè¿›ç¨‹ï¼Œæ¯”å¦‚åŠ è½½é…ç½®ã€å¯åŠ¨å·¥ä½œè¿›ç¨‹ã€æ¥æ”¶æ¥è‡ªå¤–ç•Œçš„ä¿¡å·ã€å‘å„Workerè¿›ç¨‹å‘é€ä¿¡å·ã€ç›‘æ§ Workerè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ç­‰ã€‚Masterè¿›ç¨‹è´Ÿè´£åˆ›å»ºç›‘å¬å¥—æ¥å£ï¼Œäº¤ç”±Workerè¿›ç¨‹è¿›è¡Œè¿æ¥ç›‘å¬ã€‚Workerè¿›ç¨‹ä¸»è¦ç”¨æ¥å¤„ç†ç½‘ç»œäº‹ä»¶ï¼Œå½“ä¸€ä¸ª Workerè¿›ç¨‹åœ¨æ¥æ”¶ä¸€æ¡è¿æ¥é€šé“ä¹‹åï¼Œå°±å¼€å§‹è¯»å–è¯·æ±‚ã€è§£æè¯·æ±‚ã€å¤„ç†è¯·æ±‚ï¼Œå¤„ç†å®Œæˆäº§ç”Ÿçš„æ•°æ®åï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæœ€åæ–­å¼€è¿æ¥é€šé“ã€‚ Nginxçš„æ¶æ„éå¸¸ç›´è§‚åœ°ä½“ç°äº†Master-Workeræ¨¡å¼çš„æ€æƒ³ã€‚Nginxçš„ Masterè¿›ç¨‹å¯ä»¥å¯¹åº”åˆ°Master-Workeræ¨¡å¼çš„Masterè§’è‰²ï¼ŒNginxçš„ Workerè¿›ç¨‹å¯ä»¥å¯¹åº”åˆ°Master-Workeræ¨¡å¼çš„Workerè§’è‰²ã€‚ ä¸‰ï¼ŒForkJoinæ¨¡å¼â€œåˆ†è€Œæ²»ä¹‹â€æ˜¯ä¸€ç§æ€æƒ³ï¼Œæ‰€è°“â€œåˆ†è€Œæ²»ä¹‹â€ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªå¤æ‚çš„ç®—æ³•é—®é¢˜æŒ‰ä¸€å®šçš„â€œåˆ†è§£â€æ–¹æ³•åˆ†ä¸ºè§„æ¨¡è¾ƒå°çš„è‹¥å¹²éƒ¨åˆ†ï¼Œç„¶åé€ä¸ªè§£å†³ï¼Œåˆ†åˆ«æ‰¾å‡ºå„éƒ¨åˆ†çš„è§£ï¼Œæœ€åæŠŠå„éƒ¨åˆ†çš„è§£ç»„æˆæ•´ä¸ªé—®é¢˜çš„è§£ã€‚â€œåˆ†è€Œæ²»ä¹‹â€æ€æƒ³åœ¨è½¯ä»¶ä½“ç³»ç»“æ„è®¾è®¡ã€æ¨¡å—åŒ–è®¾è®¡ã€åŸºç¡€ç®—æ³•ä¸­å¾—åˆ°äº†éå¸¸å¹¿æ³›çš„åº”ç”¨ã€‚è®¸å¤šåŸºç¡€ç®—æ³•éƒ½è¿ç”¨äº†â€œåˆ†è€Œæ²»ä¹‹â€çš„æ€æƒ³ï¼Œæ¯”å¦‚äºŒåˆ†æŸ¥æ‰¾ã€å¿«é€Ÿæ’åºç­‰ã€‚ Master-Workeræ¨¡å¼æ˜¯â€œåˆ†è€Œæ²»ä¹‹â€æ€æƒ³çš„ä¸€ç§åº”ç”¨ï¼ŒForkJoinæ¨¡å¼åˆ™æ˜¯â€œåˆ†è€Œæ²»ä¹‹â€æ€æƒ³çš„å¦ä¸€ç§åº”ç”¨ã€‚ä¸Master-Workeræ¨¡å¼ä¸åŒï¼ŒForkJoinæ¨¡å¼æ²¡æœ‰Masterè§’è‰²ï¼Œå…¶æ‰€æœ‰çš„è§’è‰²éƒ½æ˜¯Worker,ForkJoinæ¨¡å¼ä¸­çš„Workerå°†å¤§çš„ä»»åŠ¡åˆ†å‰²æˆå°çš„ä»»åŠ¡ï¼Œä¸€ç›´åˆ°ä»»åŠ¡çš„è§„æ¨¡è¶³å¤Ÿå°ï¼Œå¯ä»¥ä½¿ç”¨å¾ˆç®€å•ã€ç›´æ¥çš„æ–¹å¼æ¥å®Œæˆã€‚ 1.ForkJoinæ¨¡å¼çš„åŸç†ForkJoinæ¨¡å¼å…ˆæŠŠä¸€ä¸ªå¤§ä»»åŠ¡åˆ†è§£æˆè®¸å¤šä¸ªç‹¬ç«‹çš„å­ä»»åŠ¡ï¼Œç„¶åå¼€å¯å¤šä¸ªçº¿ç¨‹å¹¶è¡Œå»å¤„ç†è¿™äº›å­ä»»åŠ¡ã€‚æœ‰å¯èƒ½å­ä»»åŠ¡è¿˜æ˜¯å¾ˆå¤§è€Œéœ€è¦è¿›ä¸€æ­¥åˆ†è§£ï¼Œæœ€ç»ˆå¾—åˆ°è¶³å¤Ÿå°çš„ä»»åŠ¡ã€‚ForkJoinæ¨¡å¼çš„ä»»åŠ¡åˆ†è§£å’Œæ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š ForkJoinæ¨¡å¼å€ŸåŠ©äº†ç°ä»£è®¡ç®—æœºå¤šæ ¸çš„ä¼˜åŠ¿å¹¶è¡Œå¤„ç†æ•°æ®ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒForkJoinæ¨¡å¼å°†åˆ†è§£å‡ºæ¥çš„å­ä»»åŠ¡æ”¾å…¥åŒç«¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åå‡ ä¸ªå¯åŠ¨çº¿ç¨‹ä»åŒç«¯é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œã€‚å­ä»»åŠ¡æ‰§è¡Œçš„ç»“æœæ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå„ä¸ªçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­è·å–æ•°æ®ï¼Œç„¶åè¿›è¡Œå±€éƒ¨ç»“æœçš„åˆå¹¶ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœã€‚ 2.ForkJoinæ¡†æ¶JUCåŒ…æä¾›äº†ä¸€å¥—ForkJoinæ¡†æ¶çš„å®ç°ï¼Œå…·ä½“ä»¥ForkJoinPoolçº¿ç¨‹æ± çš„å½¢å¼æä¾›ï¼Œå¹¶ä¸”è¯¥çº¿ç¨‹æ± åœ¨Java8çš„Lambdaå¹¶è¡Œæµæ¡†æ¶ä¸­å……å½“ç€åº•å±‚æ¡†æ¶çš„è§’è‰²ã€‚JUCåŒ…çš„ForkJoinæ¡†æ¶åŒ…å«å¦‚ä¸‹ç»„ä»¶: (1)ForkJoinPool:æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œç»§æ‰¿äº† AbstractExecutorServiceç±»ã€‚ (2)ForkJoinWorkerThread:æ‰§è¡Œä»»åŠ¡çš„å·¥ä½œçº¿ç¨‹(ForkJoinPoolçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹)ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ªå†…éƒ¨é˜Ÿåˆ—ï¼Œç”¨äºå­˜æ”¾â€œå†…éƒ¨ä»»åŠ¡â€è¯¥ç±»ç»§æ‰¿äº†Threadç±»ã€‚ (3)ForkJoinTask:ç”¨äºForkJoinPoolçš„ä»»åŠ¡æŠ½è±¡ç±»ï¼Œå®ç°äº†Futureæ¥å£ã€‚ (4)RecursiveTask:å¸¦è¿”å›ç»“æœçš„é€’å½’æ‰§è¡Œä»»åŠ¡ï¼Œæ˜¯ForkJoinTaskçš„å­ç±»ï¼Œåœ¨å­ä»»åŠ¡å¸¦è¿”å›ç»“æœæ—¶ä½¿ç”¨ã€‚ (5)RecursiveAction:ä¸è¿”å›ç»“æœçš„é€’å½’æ‰§è¡Œä»»åŠ¡ï¼Œæ˜¯ ForkJoinTaskçš„å­ç±»ï¼Œåœ¨å­ä»»åŠ¡ä¸å¸¦è¿”å›ç»“æœæ—¶ä½¿ç”¨ã€‚ å› ä¸ºForkJoinTaskæ¯”è¾ƒå¤æ‚ï¼Œå¹¶æ—¥å…¶æŠ½è±¡æ–¹æ³•æ¯”è¾ƒå¤šï¼Œæ•…åœ¨æ—¥å¸¸ä½¿ç”¨æ—¶ä¸€èˆ¬ä¸ä¼šç›´æ¥ç»§æ‰¿ForkJoinTaskæ¥å®ç°è‡ªå®šä¹‰çš„ä»»åŠ¡ç±»ï¼Œè€Œæ˜¯é€šè¿‡ç»§æ‰¿ForkJoinTaskä¸¤ä¸ªå­ç±»RecursiveTaskæˆ–è€…RecursiveActionä¹‹ä¸€è¶‹åŠ¿çº¿è‡ªå®šä¹‰ä»»åŠ¡ç±»ï¼Œè‡ªå®šä¹‰ä»»åŠ¡ç±»éœ€è¦å®ç°è¿™äº›å­ç±»çš„compute(),æ”¹æ–¹æ³•çš„æ‰§è¡Œæµç¨‹ä¸€èˆ¬å¦‚ä¸‹ï¼š 123456if ä»»åŠ¡è¶³å¤Ÿå° ç›´æ¥è¿”å›ç»“æœelse åˆ†å‰²æˆNä¸ªå­ä»»åŠ¡ ä¾æ¬¡è°ƒç”¨æ¯ä¸ªå­ä»»åŠ¡çš„forkæ–¹æ³•æ‰§è¡Œå­ä»»åŠ¡ ä¾æ¬¡è°ƒç”¨æ¯ä¸ªå­ä»»åŠ¡çš„joinæ–¹æ³•ï¼Œç­‰å¾…å­ä»»åŠ¡å®Œæˆï¼Œç„¶ååˆå¹¶æ‰§è¡Œç»“æœ 3.ForkJoinæ¡†æ¶ä½¿ç”¨å‡è®¾éœ€è¦è®¡ç®—0-100çš„ç´¯åŠ æ±‚å’Œï¼Œå¯ä»¥ä½¿ç”¨ForkJoinæ¡†æ¶å®Œæˆã€‚é¦–å…ˆéœ€è¦è®¾è®¡ä¸€ä¸ªå¯ä»¥é€’å½’æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡å­ç±»ã€‚ 3.1 å¯é€’å½’æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ç±»AccumulateTask123456789101112131415161718192021222324252627282930313233343536373839404142434445public class AccumulateTask extends RecursiveTask&lt;Integer&gt; &#123; private static final int threshold = 2; private int start; private int end; public AccumulateTask(int start, int end) &#123; this.start = start; this.end = end; &#125; @Override protected Integer compute() &#123; int sum = 0; //åˆ¤æ–­ä»»åŠ¡çš„è§„æ¨¡ï¼šè‹¥è§„æ¨¡å°å¯ä»¥ç›´æ¥è®¡ç®— boolean canCompute = (end - start) &lt;= threshold; //è‹¥ä»»åŠ¡å·²ç»è¶³å¤Ÿå°ï¼Œåˆ™å¯ä»¥ç›´æ¥è®¡ç®— if (canCompute) &#123; //ç›´æ¥è®¡ç®—å¹¶è¿”å›ç»“æœï¼ŒRecursiveç»“æŸ for (int i = start; i &lt;= end; i++) sum += i; System.out.println(&quot;æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š&quot; + start + &quot;åˆ°&quot; + end + &quot;çš„å’Œï¼Œç»“æœæ˜¯ï¼š &quot; + sum); &#125; else &#123; //ä»»åŠ¡è¿‡å¤§ï¼Œéœ€è¦åˆ‡å‰²ï¼ŒRecursive é€’å½’è®¡ç®— System.out.println(&quot;åˆ‡å‰²ä»»åŠ¡ï¼šå°†&quot; + start + &quot;åˆ°&quot; + end + &quot;çš„å’Œä¸€åˆ†ä¸ºäºŒ&quot;); int mid = (start + end) / 2; //åˆ‡å‰²æˆ2ä¸ªå­ä»»åŠ¡ AccumulateTask lTask = new AccumulateTask(start, mid); AccumulateTask rTask = new AccumulateTask(mid + 1, end); //ä¾æ¬¡è°ƒç”¨æ¯ä¸ªå­ä»»åŠ¡çš„forkæ–¹æ³•æ‰§è¡Œå­ä»»åŠ¡ lTask.fork(); rTask.fork(); //ç­‰å¾…å­ä»»åŠ¡å®Œæˆï¼Œä¾æ¬¡è°ƒç”¨æ¯ä¸ªå­ä»»åŠ¡çš„join()åˆå¹¶æ‰§è¡Œç»“æœ int lResult = lTask.join(); int rResult = rTask.join(); //åˆå¹¶å­ä»»åŠ¡çš„æ‰§è¡Œç»“æœ sum = lResult + rResult; &#125; return sum; &#125;&#125; è‡ªå®šä¹‰çš„å¼‚æ­¥ä»»åŠ¡å­ç±»AccumulateTaskç»§æ‰¿è‡ªRecursiveTaskï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œå¯ä»¥æºå¸¦è¿”å›å€¼ã€‚AccumulateTaské€šè¿‡THRESHOLDå¸¸é‡è®¾ç½®å­ä»»åŠ¡åˆ†è§£çš„é˜ˆå€¼ï¼Œå¹¶åœ¨å®ƒçš„computeOæ–¹æ³•ä¸­è¿›è¡Œé˜ˆå€¼åˆ¤æ–­ï¼Œåˆ¤æ–­çš„é€»è¾‘å¦‚ä¸‹: (1)è‹¥å½“å‰çš„è®¡ç®—è§„æ¨¡(è¿™é‡Œä¸ºæ±‚å’Œçš„æ•°å­—ä¸ªæ•°)å¤§äºTHRESHOLDï¼Œå°±å½“å‰å­ä»»åŠ¡éœ€è¦è¿›ä¸€æ­¥åˆ†è§£ï¼Œè‹¥å½“å‰çš„è®¡ç®—è§„æ¨¡æ²¡æœ‰å¤§äºTHRESHOLDï¼Œåˆ™ç›´æ¥è®¡ç®—(è¿™é‡Œä¸ºæ±‚å’Œ)ã€‚ (2)å¦‚æœå­ä»»åŠ¡å¯ä»¥ç›´æ¥æ‰§è¡Œï¼Œå°±è¿›è¡Œæ±‚å’Œæ“ä½œï¼Œå¹¶è¿”å›ç»“æœã€‚å¦‚æœä»»åŠ¡è¿›è¡Œäº†åˆ†è§£ï¼Œå°±éœ€è¦ç­‰å¾…æ‰€æœ‰çš„å­ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€ç„¶åå¯¹å„ä¸ªåˆ†è§£ç»“æœæ±‚å’Œã€‚å¦‚æœä¸€ä¸ªä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªå­ä»»åŠ¡(å«ä¸¤ä¸ª)ï¼Œå°±ä¾æ¬¡è°ƒç”¨æ¯ä¸ªå­ä»»åŠ¡çš„forkæ–¹æ³•æ‰§è¡Œå­ä»»åŠ¡ï¼Œç„¶åä¾æ¬¡è°ƒç”¨æ¯ä¸ªå­ä»»åŠ¡çš„joinæ–¹æ³•åˆå¹¶æ‰§è¡Œç»“æœã€‚ 3.2 ä½¿ç”¨ForkJoinPoolè°ƒåº¦AccmulateTask()12345678910@Testpublic void testAccumulateTask()throws Exception&#123; ForkJoinPool forkJoinPool = new ForkJoinPool(); //åˆ›å»ºä¸€ä¸ªç´¯åŠ ä»»åŠ¡ï¼Œè®¡ç®—ä»1 åˆ° 10 AccumulateTask countTask = new AccumulateTask(1,100); Future&lt;Integer&gt; future = forkJoinPool.submit(countTask); Integer sum = future.get(1, TimeUnit.SECONDS); System.out.println(&quot;æœ€ç»ˆè®¡ç®—ç»“æœæ˜¯ï¼š&quot;+sum); Assert.assertTrue(sum==5050);&#125; åˆ‡å‰²ä»»åŠ¡ï¼šå°†1åˆ°100çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†51åˆ°100çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†1åˆ°50çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†1åˆ°25çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†1åˆ°13çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†1åˆ°7çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†1åˆ°4çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š1åˆ°2çš„å’Œï¼Œç»“æœæ˜¯ï¼š 3æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š3åˆ°4çš„å’Œï¼Œç»“æœæ˜¯ï¼š 7æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š5åˆ°7çš„å’Œï¼Œç»“æœæ˜¯ï¼š 18åˆ‡å‰²ä»»åŠ¡ï¼šå°†8åˆ°13çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š8åˆ°10çš„å’Œï¼Œç»“æœæ˜¯ï¼š 27æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š11åˆ°13çš„å’Œï¼Œç»“æœæ˜¯ï¼š 36åˆ‡å‰²ä»»åŠ¡ï¼šå°†26åˆ°50çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†26åˆ°38çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†26åˆ°32çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†26åˆ°29çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š26åˆ°27çš„å’Œï¼Œç»“æœæ˜¯ï¼š 53æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š28åˆ°29çš„å’Œï¼Œç»“æœæ˜¯ï¼š 57æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š30åˆ°32çš„å’Œï¼Œç»“æœæ˜¯ï¼š 93åˆ‡å‰²ä»»åŠ¡ï¼šå°†33åˆ°38çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š33åˆ°35çš„å’Œï¼Œç»“æœæ˜¯ï¼š 102æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š36åˆ°38çš„å’Œï¼Œç»“æœæ˜¯ï¼š 111åˆ‡å‰²ä»»åŠ¡ï¼šå°†39åˆ°50çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†39åˆ°44çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š39åˆ°41çš„å’Œï¼Œç»“æœæ˜¯ï¼š 120æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š42åˆ°44çš„å’Œï¼Œç»“æœæ˜¯ï¼š 129åˆ‡å‰²ä»»åŠ¡ï¼šå°†45åˆ°50çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š45åˆ°47çš„å’Œï¼Œç»“æœæ˜¯ï¼š 138æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š48åˆ°50çš„å’Œï¼Œç»“æœæ˜¯ï¼š 147åˆ‡å‰²ä»»åŠ¡ï¼šå°†76åˆ°100çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†76åˆ°88çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†76åˆ°82çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†76åˆ°79çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š76åˆ°77çš„å’Œï¼Œç»“æœæ˜¯ï¼š 153æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š78åˆ°79çš„å’Œï¼Œç»“æœæ˜¯ï¼š 157æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š80åˆ°82çš„å’Œï¼Œç»“æœæ˜¯ï¼š 243åˆ‡å‰²ä»»åŠ¡ï¼šå°†83åˆ°88çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š83åˆ°85çš„å’Œï¼Œç»“æœæ˜¯ï¼š 252æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š86åˆ°88çš„å’Œï¼Œç»“æœæ˜¯ï¼š 261åˆ‡å‰²ä»»åŠ¡ï¼šå°†89åˆ°100çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†89åˆ°94çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š89åˆ°91çš„å’Œï¼Œç»“æœæ˜¯ï¼š 270æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š92åˆ°94çš„å’Œï¼Œç»“æœæ˜¯ï¼š 279åˆ‡å‰²ä»»åŠ¡ï¼šå°†95åˆ°100çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š95åˆ°97çš„å’Œï¼Œç»“æœæ˜¯ï¼š 288æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š98åˆ°100çš„å’Œï¼Œç»“æœæ˜¯ï¼š 297åˆ‡å‰²ä»»åŠ¡ï¼šå°†51åˆ°75çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†51åˆ°63çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†51åˆ°57çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†51åˆ°54çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š51åˆ°52çš„å’Œï¼Œç»“æœæ˜¯ï¼š 103æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š53åˆ°54çš„å’Œï¼Œç»“æœæ˜¯ï¼š 107æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š55åˆ°57çš„å’Œï¼Œç»“æœæ˜¯ï¼š 168åˆ‡å‰²ä»»åŠ¡ï¼šå°†58åˆ°63çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š58åˆ°60çš„å’Œï¼Œç»“æœæ˜¯ï¼š 177æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š61åˆ°63çš„å’Œï¼Œç»“æœæ˜¯ï¼š 186åˆ‡å‰²ä»»åŠ¡ï¼šå°†64åˆ°75çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†64åˆ°69çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š64åˆ°66çš„å’Œï¼Œç»“æœæ˜¯ï¼š 195æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š67åˆ°69çš„å’Œï¼Œç»“æœæ˜¯ï¼š 204åˆ‡å‰²ä»»åŠ¡ï¼šå°†70åˆ°75çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š70åˆ°72çš„å’Œï¼Œç»“æœæ˜¯ï¼š 213æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š73åˆ°75çš„å’Œï¼Œç»“æœæ˜¯ï¼š 222åˆ‡å‰²ä»»åŠ¡ï¼šå°†14åˆ°25çš„å’Œä¸€åˆ†ä¸ºäºŒåˆ‡å‰²ä»»åŠ¡ï¼šå°†14åˆ°19çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š14åˆ°16çš„å’Œï¼Œç»“æœæ˜¯ï¼š 45æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š17åˆ°19çš„å’Œï¼Œç»“æœæ˜¯ï¼š 54åˆ‡å‰²ä»»åŠ¡ï¼šå°†20åˆ°25çš„å’Œä¸€åˆ†ä¸ºäºŒæ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š20åˆ°22çš„å’Œï¼Œç»“æœæ˜¯ï¼š 63æ‰§è¡Œä»»åŠ¡ï¼Œè®¡ç®—ï¼š23åˆ°25çš„å’Œï¼Œç»“æœæ˜¯ï¼š 72æœ€ç»ˆè®¡ç®—ç»“æœæ˜¯ï¼š5050 4.ForkJoinæ¡†æ¶çš„æ ¸å¿ƒAPIForkJoinæ¡†æ¶çš„æ ¸å¿ƒæ˜¯ForkJoinPoolçº¿ç¨‹æ± ã€‚è¯¥çº¿ç¨‹æ± ä½¿ç”¨ä¸€ä¸ªæ— é”çš„æ ˆæ¥ç®¡ç†ç©ºé—²çº¿ç¨‹ï¼Œå¦‚æœä¸€ä¸ªå·¥ä½œçº¿ç¨‹æš‚æ—¶å–ä¸åˆ°å¯ç”¨çš„ä»»åŠ¡ï¼Œåˆ™å¯èƒ½è¢«æŒ‚èµ·ï¼Œè€ŒæŒ‚èµ·çš„çº¿ç¨‹å°†è¢«å‹å…¥ç”±ForkJoinPoolç»´æŠ¤çš„æ ˆä¸­ï¼Œç­‰åˆ°æœ‰æ–°çš„ä»»åŠ¡åˆ°æ¥çš„æ—¶å€™ï¼Œå†ä»æ ˆä¸­å”¤é†’è¿™äº›çº¿ç¨‹ã€‚ 4.1 æ„é€ å™¨123456789101112private ForkJoinPool(int parallelism, //å¹¶è¡Œåº¦ï¼Œé»˜è®¤ä¸ºcpuæ•°ï¼Œæœ€å°ä¸º1 ForkJoinWorkerThreadFactory factory, //çº¿ç¨‹åˆ›å»ºå·¥å‚ UncaughtExceptionHandler handler, //å¼‚å¸¸å¤„ç†ç¨‹åº int mode, String workerNamePrefix) &#123; this.workerNamePrefix = workerNamePrefix; this.factory = factory; this.ueh = handler; this.config = (parallelism &amp; SMASK) | mode; long np = (long)(-parallelism); // offset ctl counts this.ctl = ((np &lt;&lt; AC_SHIFT) &amp; AC_MASK) | ((np &lt;&lt; TC_SHIFT) &amp; TC_MASK);&#125; (1) parallelism:å¯å¹¶è¡Œçº§åˆ« ForkJoinæ¡†æ¶å°†ä¾æ®parallelismè®¾å®šçš„çº§åˆ«å†³å®šæ¡†æ¶å†…å¹¶è¡Œæ‰§è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚å¹¶è¡Œçš„æ¯ä¸€ä¸ªä»»åŠ¡éƒ½ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä½†parallelismå±æ€§å¹¶ä¸æ˜¯ForkJoinæ¡†æ¶ä¸­æœ€å¤§çš„çº¿ç¨‹æ•°é‡ï¼Œè¯¥å±æ€§å’ŒThreadPoolExecutorçº¿ç¨‹æ± ä¸­çš„corePoolSizeã€maximumPoolSizeå±æ€§æœ‰åŒºåˆ«ï¼Œå› ä¸º ForkJoinPoolçš„ç»“æ„å’Œå·¥ä½œæ–¹å¼ä¸ThreadPoolExecutorå®Œå…¨ä¸ä¸€æ ·ã€‚ ForkJoinæ¡†æ¶ä¸­å¯å­˜åœ¨çš„çº¿ç¨‹æ•°é‡å’Œparallelismå‚æ•°å€¼å¹¶ä¸æ˜¯ç»å¯¹å…³è”çš„ã€‚ (2)factory:çº¿ç¨‹åˆ›å»ºå·¥å‚ å½“ForkJoinæ¡†æ¶åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ—¶ï¼ŒåŒæ ·ä¼šç”¨åˆ°çº¿ç¨‹åˆ›å»ºå·¥å‚ã€‚åªä¸è¿‡è¿™ä¸ªçº¿ç¨‹å·¥å‚ä¸å†éœ€è¦å®ç°ThreadFactorvæ¥å£ï¼Œè€Œæ˜¯éœ€è¦å®ç°ForkJoinWorkerThreadFactoryæ¥å£ã€‚åè€…æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œåªéœ€è¦å®ç°ä¸€ä¸ªåå«newThreadOçš„æ–¹æ³•ã€‚åœ¨ForkJoinæ¡†æ¶ä¸­æœ‰ä¸€ä¸ªé»˜è®¤çš„ForkJoinWorkerThreadFactoryæ¥å£å®ç° DefaultForkJoinWorkerThreadFactoryã€‚ (3)handler:å¼‚å¸¸æ•è·å¤„ç†ç¨‹åº å½“æ‰§è¡Œçš„ä»»åŠ¡ä¸­å‡ºç°å¼‚å¸¸ï¼Œå¹¶ä»ä»»åŠ¡ä¸­è¢«æŠ›å‡ºæ—¶ï¼Œå°±ä¼šè¢«handleræ•è·ã€‚ (4)asyncMode:å¼‚æ­¥æ¨¡å¼ asyncModeå‚æ•°è¡¨ç¤ºä»»åŠ¡æ˜¯å¦ä¸ºå¼‚æ­¥æ¨¡å¼ï¼Œå…¶é»˜è®¤å€¼ä¸ºfalseã€‚å¦‚æœ asyncModeä¸ºtrueï¼Œå°±è¡¨ç¤ºå­ä»»åŠ¡çš„æ‰§è¡Œéµå¾ªFIFO(å…ˆè¿›å…ˆå‡º)é¡ºåºï¼Œå¹¶ä¸”å­ä»»åŠ¡ä¸èƒ½è¢«åˆå¹¶;å¦‚æœasyncModeä¸ºfalseï¼Œå°±è¡¨ç¤ºå­ä»»åŠ¡çš„æ‰§è¡Œéµå¾ªFIFO(åè¿›å…ˆ!)é¡ºåºï¼Œå¹¶æ—¥å­ä»»åŠ¡å¯ä»¥è¢«åˆå¹¶ã€‚è™½ç„¶ä»å­—é¢æ„æ€æ¥çœ‹asyncModeæ˜¯æŒ‡å¼‚æ­¥æ¨¡å¼ï¼Œå®ƒå¹¶ä¸æ˜¯æŒ‡ForkJoinæ¡†æ¶çš„è°ƒåº¦æ¨¡å¼é‡‡ç”¨æ˜¯åŒæ­¥æ¨¡å¼è¿˜æ˜¯å¼‚æ­¥æ¨¡å¼å·¥ä½œï¼Œä»…ä»…æŒ‡ä»»åŠ¡çš„è°ƒåº¦æ–¹å¼ã€‚ForkJoinæ¡†æ¶ä¸­ä¸ºæ¯ä¸€ä¸ªç‹¬ç«‹å·¥ä½œçš„çº¿ç¨‹å‡†å¤‡äº†å¯¹åº”çš„å¾…æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ï¼Œè¿™ä¸ªä»»åŠ¡é˜Ÿåˆ—æ˜¯ä½¿ç”¨æ•°ç»„è¿›è¡Œç»„åˆçš„åŒå‘é˜Ÿåˆ—ã€‚asyncModeæ¨¡å¼çš„ä¸»è¦æ„æ€æŒ‡çš„æ˜¯å¾…æ‰§è¡Œä»»åŠ¡å¯ä»¥ä½¿ç”¨FIFO(å…ˆè¿›å…ˆå‡º)çš„å·¥ä½œæ¨¡å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ FIFO(åè¿›å…ˆå‡º)çš„å·¥ä½œæ¨¡å¼ï¼Œå·¥ä½œæ¨¡å¼ä¸ºFIFO(å…ˆè¿›å…ˆå‡º)çš„ä»»åŠ¡é€‚ç”¨äºå·¥ä½œçº¿ç¨‹åªè´Ÿè´£è¿è¡Œå¼‚æ­¥äº‹ä»¶ï¼Œä¸éœ€è¦åˆå¹¶ç»“æœçš„å¼‚æ­¥ä»»åŠ¡ã€‚ ForkJoinPoolæ— å‚æ•°çš„ï¼Œé»˜è®¤çš„æ„é€ å™¨å¦‚ä¸‹ï¼š 12345static final int MAX_CAP = 0x7fff; // max #workers - 1public ForkJoinPool() &#123; this(Math.min(MAX_CAP, Runtime.getRuntime().availableProcessors()), defaultForkJoinWorkerThreadFactory, null, false);&#125; è¯¥æ„é€ å™¨çš„parallelismå€¼ä¸ºCPUæ ¸å¿ƒæ•°ï¼Œfactoryå€¼ä¸ºdefaultForkJoinWorkerThreadFactoryé»˜è®¤çš„çº¿ç¨‹å·¥å‚ï¼Œå¼‚å¸¸æ•è·å¤„ç†ç¨‹åºhandlerå€¼ä¸ºnullï¼›è¡¨ç¤ºä¸è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼›å¼‚æ­¥æ¨¡å¼asyncModeå€¼ä¸ºfalseï¼Œä½¿ç”¨LIFOçš„ï¼Œå¯ä»¥åˆå¹¶å­ä»»åŠ¡çš„æ¨¡å¼ã€‚ 4.2 commoné€šç”¨æ± å¾ˆå¤šåœºæ™¯å¯ä»¥ç›´æ¥ä½¿ç”¨ForkJoinPoolå®šä¹‰çš„commoné€šç”¨æ± ï¼Œè°ƒç”¨ForkJoinPool.commonPool()å¯ä»¥è·å–è¯¥ForkJoinçº¿ç¨‹æ± ï¼Œè¯¥çº¿ç¨‹æ± é€šè¿‡makeCommonPool()æ¥æ„é€ ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738private static ForkJoinPool makeCommonPool() &#123; int parallelism = -1; ForkJoinWorkerThreadFactory factory = null; UncaughtExceptionHandler handler = null; try &#123; //å¹¶è¡Œåº¦ String pp = System.getProperty (&quot;java.util.concurrent.ForkJoinPool.common.parallelism&quot;); //çº¿ç¨‹å·¥å‚ String fp = System.getProperty (&quot;java.util.concurrent.ForkJoinPool.common.threadFactory&quot;); //å¼‚å¸¸å¤„ç†ç±» String hp = System.getProperty (&quot;java.util.concurrent.ForkJoinPool.common.exceptionHandler&quot;); if (pp != null) parallelism = Integer.parseInt(pp); if (fp != null) factory = ((ForkJoinWorkerThreadFactory)ClassLoader. getSystemClassLoader().loadClass(fp).newInstance()); if (hp != null) handler = ((UncaughtExceptionHandler)ClassLoader. getSystemClassLoader().loadClass(hp).newInstance()); &#125; catch (Exception ignore) &#123; &#125; if (factory == null) &#123; if (System.getSecurityManager() == null) factory = new DefaultCommonPoolForkJoinWorkerThreadFactory(); else // use security-managed default factory = new InnocuousForkJoinWorkerThreadFactory(); &#125; //é»˜è®¤å¹¶è¡Œåº¦ä¸ºcores-1 if (parallelism &lt; 0 &amp;&amp; // default 1 less than #cores (parallelism = Runtime.getRuntime().availableProcessors() - 1) &lt;= 0) parallelism = 1; if (parallelism &gt; MAX_CAP) parallelism = MAX_CAP; return new ForkJoinPool(parallelism, factory, handler, LIFO_QUEUE, &quot;ForkJoinPool.commonPool-worker-&quot;);&#125; ä½¿ç”¨commonæ± å­çš„ä¼˜ç‚¹æ˜¯å¯ä»¥é€šè¿‡æŒ‡å®šç³»ç»Ÿå±æ€§çš„æ–¹å¼å®šä¹‰â€å¹¶è¡Œåº¦ï¼Œçº¿ç¨‹å·¥å‚å’Œå¼‚å¸¸å¤„ç†ç±»â€œï¼Œå¹¶ä¸”commonæ± ä½¿ç”¨çš„æ˜¯åŒæ­¥æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥æ”¯æŒä»»åŠ¡åˆå¹¶ã€‚ é€šè¿‡ç³»ç»Ÿå±æ€§çš„æ–¹å¼æŒ‡å®šparallellismçš„å€¼å¾—ç¤ºä¾‹å¦‚ä¸‹ï¼š 1System.setPropert(&quot;java.util.concurrent.ForkJoinPool.common.parallelism&quot;,&quot;8&quot;); é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡JavaæŒ‡ä»¤çš„é€‰é¡¹çš„æ–¹å¼æŒ‡å®šparallellismå€¼ï¼Œå…·ä½“çš„é€‰é¡¹ä¸ºï¼š 1-Djava.util.concurrent.ForkJoinPool.common.parallelism=8 å…¶ä»–çš„å‚æ•°å€¼å¦‚å¼‚å¸¸å¤„ç†ç¨‹åºhandlerï¼Œéƒ½å¯ä»¥é€šè¿‡ä»¥ä¸Šä¸¤ç§æ–¹å¼æŒ‡å®šã€‚ 4.3 å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡çš„æ–¹å¼å¯ä»¥å‘ForkJoinPoolçº¿ç¨‹æ± æäº¤ä¸€ä¸‹ä¸¤ç±»ä»»åŠ¡ï¼š å¤–éƒ¨ä»»åŠ¡ï¼ˆExternal/Submissions Taskï¼‰ å‘ForkJoinPoolæäº¤å¤–éƒ¨ä»»åŠ¡æœ‰ä¸‰ç§æ–¹å¼:æ–¹å¼ä¸€æ˜¯è°ƒç”¨invoke()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æäº¤ä»»åŠ¡åçº¿ç¨‹ä¼šç­‰å¾…ï¼Œç­‰åˆ°ä»»åŠ¡è®¡ç®—å®Œæ¯•è¿”å›ç»“æœ;æ–¹å¼äºŒæ˜¯è°ƒç”¨executeæ–¹æ³•æäº¤ä¸€ä¸ªä»»åŠ¡æ¥å¼‚æ­¥æ‰§è¡Œï¼Œæ— è¿”å›ç»“æœ;æ–¹å¼ä¸‰æ˜¯è°ƒç”¨submitæ–¹æ³•æäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶ä¸”ä¼šè¿”å›ä¸€ä¸ªForkJoinTaskå®ä¾‹ï¼Œä¹‹åé€‚å½“çš„æ—¶å€™å¯é€šè¿‡ForkJoinTaskå®ä¾‹è·å–æ‰§è¡Œç»“æœã€‚ å­ä»»åŠ¡ï¼ˆWorker Taskï¼‰æäº¤ å‘ForkJoinPoolæäº¤å­ä»»åŠ¡çš„æ–¹æ³•ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œç”±ä»»åŠ¡å®ä¾‹çš„ forkæ–¹æ³•å®Œæˆã€‚å½“ä»»åŠ¡è¢«åˆ†å‰²ä¹‹åï¼Œå†…éƒ¨ä¼šè°ƒç”¨ForkJoinPool.WorkQueuepush()æ–¹æ³•ç›´æ¥æŠŠä»»åŠ¡æ”¾åˆ°å†…éƒ¨é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«æ‰§è¡Œã€‚ 5.å·¥ä½œçªƒå–ç®—æ³•ForkJoinPoolçº¿ç¨‹æ± çš„ä»»åŠ¡åˆ†ä¸ºâ€œå¤–éƒ¨ä»»åŠ¡â€å’Œâ€œå†…éƒ¨ä»»åŠ¡â€ï¼Œä¸¤ç§ä»»åŠ¡çš„å­˜æ”¾ä½ç½®ä¸åŒ: (1)å¤–éƒ¨ä»»åŠ¡å­˜æ”¾åœ¨ForkJoinPoolçš„å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ (2)å­ä»»åŠ¡ä¼šä½œä¸ºâ€œå†…éƒ¨ä»»åŠ¡â€æ”¾åˆ°å†…éƒ¨é˜Ÿåˆ—ä¸­ï¼ŒForkJoinPoolæ± ä¸­çš„æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ªå†…éƒ¨é˜Ÿåˆ—ï¼Œç”¨äºå­˜æ”¾è¿™äº›â€œå†…éƒ¨ä»»åŠ¡â€ã€‚ ç”±äºForkJoinPoolçº¿ç¨‹æ± é€šå¸¸æœ‰å¤šä¸ªå·¥ä½œçº¿ç¨‹ï¼Œä¸ä¹‹ç›¸å¯¹åº”çš„å°±ä¼šæœ‰å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œè¿™å°±ä¼šå‡ºç°ä»»åŠ¡åˆ†é…ä¸å‡è¡¡çš„é—®é¢˜:æœ‰çš„é˜Ÿåˆ—ä»»åŠ¡å¤šï¼Œå¿™å¾—ä¸åœï¼Œæœ‰çš„é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡ï¼Œä¸€ç›´ç©ºé—²ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æœºåˆ¶å¸®å¿™å°†ä»»åŠ¡ä»ç¹å¿™çš„çº¿ç¨‹åˆ†æ‘Šç»™ç©ºé—²çš„çº¿ç¨‹å‘¢?ç­”æ¡ˆæ˜¯ä½¿ç”¨å·¥ä½œçªƒå–ç®—æ³•ã€‚ å·¥ä½œçªƒå–ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯:å·¥ä½œçº¿ç¨‹è‡ªå·±çš„æ´»å¹²å®Œäº†ä¹‹åï¼Œä¼šå»çœ‹çœ‹åˆ«äººæœ‰æ²¡æœ‰æ²¡å¹²å®Œçš„æ´»ï¼Œå¦‚æœæœ‰å°±æ‹¿è¿‡æ¥å¸®å¿™å¹²ã€‚å·¥ä½œçªƒå–ç®—æ³•çš„ä¸»è¦é€»è¾‘:æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—(æœ¬åœ°é˜Ÿåˆ—)ï¼Œç”¨äºå­˜æ”¾éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå½“è‡ªå·±çš„é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œå¯ä»¥ä»å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å¾—ä¸€ä¸ªä»»åŠ¡ç»§ç»­æ‰§è¡Œã€‚ åœ¨å®é™…è¿›è¡Œä»»åŠ¡çªƒå–æ“ä½œçš„æ—¶å€™ï¼Œæ“ä½œçº¿ç¨‹ä¼šè¿›è¡Œå…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—çš„æ‰«æå’Œä»»åŠ¡çš„å‡ºé˜Ÿå°è¯•ã€‚ä¸ºä»€ä¹ˆè¯´æ˜¯å°è¯•?å› ä¸ºå®Œå…¨æœ‰å¯èƒ½æ“ä½œå¤±è´¥ï¼Œä¸»è¦åŸå› æ˜¯å¹¶è¡Œæ‰§è¡Œè‚¯å®šæ¶‰åŠçº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼Œå‡å¦‚åœ¨çªƒå–è¿‡ç¨‹ä¸­è¯¥ä»»åŠ¡å·²ç»å¼€å§‹æ‰§è¡Œï¼Œé‚£ä¹ˆä»»åŠ¡çš„çªƒå–æ“ä½œå°±ä¼šå¤±è´¥ã€‚ å¦‚ä½•å°½é‡é¿å…åœ¨ä»»åŠ¡çªƒå–ä¸­å‘ç”Ÿçš„çº¿ç¨‹å®‰å…¨é—®é¢˜å‘¢?ä¸€ç§ç®€å•çš„ä¼˜åŒ–æ–¹æ³•æ˜¯:åœ¨çº¿ç¨‹è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—é‡‡å–LIFO(åè¿›å…ˆå‡º)ç­–ç•¥ï¼Œçªƒå–å…¶ä»–ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡æ—¶é‡‡ç”¨FIFO(å…ˆè¿›å…ˆå‡º)ç­–ç•¥ã€‚ç®€å•æ¥è¯´ï¼Œè·å–è‡ªå·±é˜Ÿåˆ—çš„ä»»åŠ¡æ—¶ä»å¤´å¼€å§‹ï¼Œçªƒå–å…¶ä»–é˜Ÿåˆ—çš„ä»»åŠ¡æ—¶ä»å°¾å¼€å§‹ã€‚ç”±äºçªƒå–çš„åŠ¨ä½œååˆ†å¿«é€Ÿï¼Œä¼šå¤§é‡é™ä½è¿™ç§å†²çªï¼Œä¹Ÿæ˜¯ä¸€ç§ä¼˜åŒ–æ–¹å¼ã€‚ 6.ForkJoinæ¡†æ¶çš„åŸç†æ ¸å¿ƒåŸç†å¤§è‡´å¦‚ä¸‹ï¼š (1)ForkJoinæ¡†æ¶çš„çº¿ç¨‹æ± ForkJoinPoolçš„ä»»åŠ¡åˆ†ä¸ºâ€œå¤–éƒ¨ä»»åŠ¡â€å’Œâ€œå†…éƒ¨ä»»åŠ¡â€ã€‚ (2)â€œå¤–éƒ¨ä»»åŠ¡â€æ”¾åœ¨ForkJoinPoolçš„å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ (3)ForkJoinPoolæ± ä¸­çš„æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨äºå­˜æ”¾â€œå†…éƒ¨ä»»åŠ¡â€ï¼Œçº¿ç¨‹åˆ‡å‰²ä»»åŠ¡å¾—åˆ°çš„å­ä»»åŠ¡ä¼šä½œä¸ºâ€œå†…éƒ¨ä»»åŠ¡â€æ”¾åˆ°å†…éƒ¨é˜Ÿåˆ—ä¸­ã€‚ (4)å½“å·¥ä½œçº¿ç¨‹æƒ³è¦æ‹¿åˆ°å­ä»»åŠ¡çš„è®¡ç®—ç»“æœæ—¶ï¼Œå…ˆåˆ¤æ–­å­ä»»åŠ¡æœ‰æ²¡æœ‰å®Œæˆï¼Œå¦‚æœæ²¡æœ‰å®Œæˆï¼Œå†åˆ¤æ–­å­ä»»åŠ¡æœ‰æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹â€œçªƒå–â€ï¼Œå¦‚æœå­ä»»åŠ¡æ²¡æœ‰è¢«çªƒå–ï¼Œå°±ç”±æœ¬çº¿ç¨‹æ¥å®Œæˆ;ä¸€æ—¦å­ä»»åŠ¡è¢«çªƒå–äº†ï¼Œå°±å»æ‰§è¡Œæœ¬çº¿ç¨‹â€œå†…éƒ¨é˜Ÿåˆ—â€çš„å…¶ä»–ä»»åŠ¡ï¼Œæˆ–è€…æ‰«æå…¶ä»–çš„ä»»åŠ¡é˜Ÿåˆ—å¹¶çªƒå–ä»»åŠ¡ã€‚ (5)å½“å·¥ä½œçº¿ç¨‹å®Œæˆå…¶â€œå†…éƒ¨ä»»åŠ¡â€ï¼Œå¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œå°±ä¼šæ‰«æå…¶ä»–çš„ä»»åŠ¡é˜Ÿåˆ—çªƒå–ä»»åŠ¡ï¼Œå°½å¯èƒ½ä¸ä¼šé˜»å¡ç­‰å¾…ã€‚ æ€»ä¹‹ï¼ŒForkJoinçº¿ç¨‹åœ¨ç­‰å¾…ä¸€ä¸ªä»»åŠ¡å®Œæˆæ—¶ï¼Œè¦ä¹ˆè‡ªå·±æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œè¦ä¹ˆåœ¨å…¶ä»–çº¿ç¨‹çªƒå–äº†è¿™ä¸ªä»»åŠ¡çš„æƒ…å†µä¸‹ï¼Œå»æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œæ˜¯ä¸ä¼šé˜»å¡ç­‰å¾…çš„ï¼Œä»è€Œé¿å…èµ„æºæµªè´¹ï¼Œé™¤éæ‰€æœ‰ä»»åŠ¡é˜Ÿåˆ—éƒ½ä¸ºç©ºã€‚ å·¥ä½œçªƒå–ç®—æ³•çš„ä¼˜ç‚¹ï¼š (1)çº¿ç¨‹æ˜¯ä¸ä¼šå› ä¸ºç­‰å¾…æŸä¸ªå­ä»»åŠ¡çš„æ‰§è¡Œæˆ–è€…æ²¡æœ‰å†…éƒ¨ä»»åŠ¡è¦æ‰§è¡Œè€Œè¢«é˜»å¡ç­‰å¾…ã€æŒ‚èµ·çš„ï¼Œè€Œæ˜¯ä¼šæ‰«ææ‰€æœ‰çš„é˜Ÿåˆ—çªƒå–ä»»åŠ¡ï¼Œç›´åˆ°æ‰€æœ‰é˜Ÿåˆ—éƒ½ä¸ºç©ºæ—¶æ‰ä¼šè¢«æŒ‚èµ·ã€‚ (2)ForkJoinæ¡†æ¶ä¸ºæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ç€ä¸€ä¸ªå†…éƒ¨ä»»åŠ¡é˜Ÿåˆ—ä»¥åŠä¸€ä¸ªå…¨å±€çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œè€Œä¸”ä»»åŠ¡é˜Ÿåˆ—éƒ½æ˜¯åŒå‘é˜Ÿåˆ—ï¼Œå¯ä»é¦–å°¾ä¸¤ç«¯æ¥è·å–ä»»åŠ¡ï¼Œæå¤§åœ°å‡å°‘äº†ç«äº‰çš„å¯èƒ½æ€§ï¼Œæé«˜å¹¶è¡Œçš„æ€§èƒ½ã€‚ ForkJoinPoolé€‚åˆéœ€è¦â€œåˆ†è€Œæ²»ä¹‹â€çš„åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯åˆ†æ²»ä¹‹åé€’å½’è°ƒç”¨çš„å‡½æ•°ï¼Œä¾‹å¦‚å¿«é€Ÿæ’åºã€äºŒåˆ†æœç´¢ã€å¤§æ•´æ•°ä¹˜æ³•ã€çŸ©é˜µä¹˜æ³•ã€æ£‹ç›˜è¦†ç›–ã€å½’å¹¶æ’åºã€çº¿æ€§æ—¶é—´é€‰æ‹©ã€æ±‰è¯ºå¡”é—®é¢˜ç­‰ã€‚ForkJoinPoolé€‚åˆè°ƒåº¦çš„ä»»åŠ¡ä¸ºCPUå¯†é›†å‹ä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡å­˜åœ¨I/0æ“ä½œã€çº¿ç¨‹åŒæ­¥æ“ä½œã€sleepç¡çœ ç­‰è¾ƒé•¿æ—¶é—´é˜»å¡çš„æƒ…å†µï¼Œæœ€å¥½é…åˆä½¿ç”¨ManagedBlockerè¿›è¡Œé˜»å¡ç®¡ç†ã€‚æ€»ä½“æ¥è¯´ï¼ŒForkJoinPoolä¸é€‚åˆè¿›è¡ŒI0å¯†é›†å‹ã€æ··åˆå‹çš„ä»»åŠ¡è°ƒåº¦ã€‚ å››ï¼Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼æ˜¯ä¸€ä¸ªç»å…¸çš„å¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼ï¼Œå®ƒä¸ºå¤šçº¿ç¨‹é—´çš„åä½œæä¾›äº†è‰¯å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œæ˜¯é«˜å¹¶å‘ç¼–ç¨‹è¿‡ç¨‹ä¸­å¸¸ç”¨çš„ä¸€ç§è®¾è®¡æ¨¡å¼ã€‚ åœ¨å®é™…çš„è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°å¦‚ä¸‹åœºæ™¯:æŸäº›æ¨¡å—è´Ÿè´£äº§ç”Ÿæ•°æ®ï¼Œå¦ä¸€äº›æ¨¡å—è´Ÿè´£æ¶ˆè´¹æ•°æ®(æ­¤å¤„çš„æ¨¡å—å¯ä»¥æ˜¯ç±»ã€æ‰¿æ•°ã€çº¿ç¨‹ã€è¿›ç¨‹ç­‰)ã€‚äº§ç”Ÿæ•°æ®çš„æ¨¡å—å¯ä»¥å½¢è±¡åœ°ç§°ä¸ºç”Ÿäº§è€…ï¼Œè€Œæ¶ˆè´¹æ•°æ®çš„æ¨¡å—å¯ä»¥ç§°ä¸ºæ¶ˆè´¹è€…ã€‚ç„¶è€Œï¼Œä»…ä»…æŠ½è±¡å‡ºæ¥ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è¿˜ä¸å¤Ÿï¼Œè¯¥æ¨¡å¼è¿˜éœ€è¦æœ‰ä¸€ä¸ªæ•°æ®ç¼“å†²åŒºä½œä¸ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„ä¸­ä»‹:ç”Ÿäº§è€…æŠŠæ•°æ®æ”¾å…¥ç¼“å†²åŒºï¼Œè€Œæ¶ˆè´¹è€…ä»ç¼“å†²åŒºå–å‡ºæ•°æ®ã€‚ æ•°æ®ç¼“å†²åŒºçš„ä½œç”¨ä¸»è¦åœ¨äºèƒ½ä½¿ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è§£è€¦ã€‚å¦‚æœæ²¡æœ‰æ•°æ®ç¼“å†²åŒºï¼Œè®©ç”Ÿäº§è€…ç›´æ¥è°ƒç”¨æ¶ˆè´¹è€…çš„æŸä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å¯¹äºæ¶ˆè´¹è€…å°±ä¼šäº§ç”Ÿä¾èµ–(ä¹Ÿå°±æ˜¯è€¦åˆ)ã€‚å°†æ¥å¦‚æœæ¶ˆè´¹è€…çš„ä»£ç å‘ç”Ÿå˜åŒ–ï¼Œå¯èƒ½ä¼šå½±å“åˆ°ç”Ÿäº§è€…ã€‚è€Œå¦‚æœä¸¤è€…éƒ½ä¾èµ–äºæŸä¸ªç¼“å†²åŒºï¼Œä¸¤è€…ä¹‹é—´ä¸ç›´æ¥ä¾èµ–ï¼Œè€¦åˆä¹Ÿå°±ç›¸åº”é™ä½äº†ã€‚ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼å¤©ç”Ÿå°±æ˜¯ç”¨æ¥å¤„ç†å¹¶å‘é—®é¢˜çš„ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å¹¶å‘ä¸»ä½“ï¼Œç”Ÿäº§è€…æŠŠåˆ¶é€ å‡ºæ¥çš„æ•°æ®å¾€ç¼“å†²åŒºä¸€æ”¾ï¼Œå°±å¯ä»¥å†å»ç”Ÿäº§ä¸‹ä¸€ä¸ªæ•°æ®äº†ã€‚ç”Ÿäº§è€…åŸºæœ¬ä¸Šä¸ç”¨ä¾èµ–æ¶ˆè´¹è€…çš„å¤„ç†é€Ÿåº¦ã€‚å°¤å…¶æ˜¯åœ¨ç”Ÿæˆè€…çš„é€Ÿåº¦æ—¶å¿«æ—¶æ…¢æ—¶ï¼Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼çš„å¥½å¤„å°±ä½“ç°å‡ºæ¥äº†ã€‚å½“æ•°æ®åˆ¶é€ å¿«çš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…æ¥ä¸åŠå¤„ç†ï¼Œæœªå¤„ç†çš„æ•°æ®å¯ä»¥æš‚æ—¶å­˜åœ¨ç¼“å†²åŒºä¸­ã€‚ç­‰ç”Ÿäº§è€…çš„åˆ¶é€ é€Ÿåº¦æ…¢ä¸‹æ¥ï¼Œæ¶ˆè´¹è€…å†æ…¢æ…¢å¤„ç†æ‰ã€‚ åœ¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ä¸­ï¼Œç¼“å†²åŒºæ˜¯æ€§èƒ½çš„å…³é”®ï¼Œç¼“å†²åŒºå¯ä»¥åŸºäº ArrayListã€LinkedListã€BlockingQueueã€ç¯å½¢é˜Ÿåˆ—ç­‰å„ç§ä¸åŒçš„æ•°æ®å­˜å‚¨ç»„ä»¶å»è®¾è®¡ï¼Œæ‰€ä½¿ç”¨çš„ç»„ä»¶ä¸åŒï¼Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼å®ç°çš„æ€§èƒ½å½“ç„¶ä¹Ÿå°±ä¸åŒã€‚ äº”ï¼ŒFutureæ¨¡å¼Futureæ¨¡å¼æ˜¯é«˜å¹¶å‘è®¾è®¡ä¸å¼€å‘è¿‡ç¨‹ä¸­å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯å¼‚æ­¥è°ƒç”¨ã€‚å¯¹äºFutureæ¨¡å¼æ¥è¯´ï¼Œå®ƒä¸æ˜¯ç«‹å³è¿”å›æˆ‘ä»¬æ‰€éœ€è¦çš„æ•°æ®ï¼Œä½†æ˜¯å®ƒä¼šè¿”å›ä¸€ä¸ªå¥‘çº¦(æˆ–å¼‚æ­¥ä»»åŠ¡)ï¼Œå°†æ¥æˆ‘ä»¬å¯ä»¥å‡­å€Ÿè¿™ä¸ªå¥‘çº¦(æˆ–å¼‚æ­¥ä»»åŠ¡)è·å–éœ€è¦çš„ç»“æœã€‚ åœ¨è¿›è¡Œä¼ ç»Ÿçš„RPC(è¿œç¨‹è°ƒç”¨)æ—¶ï¼ŒåŒæ­¥è°ƒç”¨RPCæ˜¯ä¸€æ®µè€—æ—¶çš„è¿‡ç¨‹ã€‚å½“å®¢æˆ·ç«¯å‘å‡ºRPCè¯·æ±‚åï¼ŒæœåŠ¡ç«¯å®Œæˆè¯·æ±‚å¤„ç†éœ€è¦å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´æ‰ä¼šè¿”å›ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­å®¢æˆ·ç«¯ä¸€ç›´åœ¨ç­‰å¾…ï¼Œç›´åˆ°æ•°æ®è¿”å›åï¼Œå†è¿›è¡Œå…¶ä»–ä»»åŠ¡çš„å¤„ç†ã€‚ç°æœ‰ä¸€ä¸ªClientåŒæ­¥å¯¹ä¸‰ä¸ªServeråˆ†åˆ«è¿›è¡Œä¸€æ¬¡RPCè°ƒç”¨ã€‚ å‡è®¾ä¸€æ¬¡è¿œç¨‹è°ƒç”¨çš„æ—¶é—´ä¸º500æ¯«ç§’ï¼Œåˆ™ä¸€ä¸ªClientåŒæ­¥å¯¹ä¸‰ä¸ªServeråˆ†åˆ«è¿›è¡Œä¸€æ¬¡RPCè°ƒç”¨çš„æ€»æ—¶é—´éœ€è¦è€—è´¹1500æ¯«ç§’ã€‚å¦‚æœè¦èŠ‚çœè¿™ä¸ªæ€»æ—¶é—´ï¼Œå¯ä»¥ä½¿ç”¨Futureæ¨¡å¼å¯¹å…¶è¿›è¡Œæ”¹é€ ï¼Œå°†åŒæ­¥çš„RPCè°ƒç”¨æ”¹ä¸ºå¼‚æ­¥å¹¶å‘çš„RPCè°ƒç”¨ï¼Œä¸€ä¸ªClientå¼‚æ­¥å¹¶å‘å¯¹ä¸‰ä¸ªServeråˆ†åˆ«è¿›è¡Œä¸€æ¬¡ RPCè°ƒç”¨ã€‚ ä¸€ä¸ªClientåŒæ­¥å¯¹ä¸‰ä¸ªServeråˆ†åˆ«è¿›è¡Œä¸€æ¬¡RPCè°ƒç”¨ ä¸€ä¸ªClientå¼‚æ­¥å¹¶å‘å¯¹ä¸‰ä¸ªServeråˆ†åˆ«è¿›è¡Œä¸€æ¬¡RPCè°ƒç”¨ å‡è®¾ä¸€æ¬¡è¿œç¨‹è°ƒç”¨çš„æ—¶é—´ä¸º500æ¯«ç§’ï¼Œåˆ™ä¸€ä¸ªClientå¼‚æ­¥å¹¶å‘å¯¹ä¸‰ä¸ª Serveråˆ†åˆ«è¿›è¡Œä¸€æ¬¡RPCè°ƒç”¨çš„æ€»æ—¶é—´åªè¦è€—è´¹500æ¯«ç§’ã€‚ä½¿ç”¨Futureæ¨¡å¼å¼‚æ­¥å¹¶å‘åœ°è¿›è¡ŒRPCè°ƒç”¨ï¼Œå®¢æˆ·ç«¯åœ¨å¾—åˆ°ä¸€ä¸ªRPCçš„è¿”å›ç»“æœå‰å¹¶ä¸æ€¥äºè·å–è¯¥ç»“æœï¼Œè€Œæ˜¯å……åˆ†åˆ©ç”¨ç­‰å¾…æ—¶é—´å»æ‰§è¡Œå…¶ä»–çš„è€—æ—¶æ“ä½œ(å¦‚å…¶ä»–RPCè°ƒç”¨)ï¼Œè¿™å°±æ˜¯Futureæ¨¡å¼çš„æ ¸å¿ƒæ‰€åœ¨ã€‚ Futureæ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œæœ‰ç‚¹ç±»ä¼¼äºå¼‚æ­¥çš„Ajaxè¯·æ±‚ã€‚å½“è°ƒç”¨æŸä¸ªè€—æ—¶æ–¹æ³•æ—¶ï¼Œå¯ä»¥ä¸æ€¥äºç«‹åˆ»è·å–ç»“æœï¼Œè€Œæ˜¯è®©è¢«è°ƒç”¨è€…ç«‹åˆ»è¿”å›ä¸€ä¸ªå¥‘çº¦(æˆ–å¼‚æ­¥ä»»åŠ¡)ï¼Œå¹¶ä¸”å°†è€—æ—¶çš„æ–¹æ³•æ”¾åˆ°å¦å¤–çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œåç»­å‡­å¥‘çº¦å†å»è·å–å¼‚æ­¥æ‰§è¡Œçš„ç»“æœã€‚ åœ¨å…·ä½“çš„å®ç°ä¸Šï¼ŒFutureæ¨¡å¼å’Œå¼‚æ­¥å›è°ƒæ¨¡å¼æ—¢æœ‰åŒºåˆ«ï¼Œåˆæœ‰è”ç³»ã€‚Javaçš„Futureå®ç°ç±»å¹¶æ²¡æœ‰æ”¯æŒå¼‚æ­¥å›è°ƒï¼Œä»ç„¶éœ€è¦ä¸»åŠ¨è·å–è€—æ—¶ä»»åŠ¡çš„ç»“æœ;è€ŒJava8ä¸­çš„CompletableFutureç»„ä»¶å®ç°äº†å¼‚æ­¥å›è°ƒæ¨¡å¼ã€‚","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"é«˜å¹¶å‘æ ¸å¿ƒæ¨¡å¼ä¹‹å¼‚æ­¥å›è°ƒ","slug":"JUC/é«˜å¹¶å‘æ ¸å¿ƒæ¨¡å¼ä¹‹å¼‚æ­¥å›è°ƒ","date":"2022-01-11T11:04:22.500Z","updated":"2022-01-11T11:21:32.266Z","comments":true,"path":"2022/01/11/JUC/é«˜å¹¶å‘æ ¸å¿ƒæ¨¡å¼ä¹‹å¼‚æ­¥å›è°ƒ/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/JUC/%E9%AB%98%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%BC%82%E6%AD%A5%E5%9B%9E%E8%B0%83/","excerpt":"","text":"ä¸€ï¼ŒGuavaçš„å¼‚æ­¥å›è°ƒæ¨¡å¼Guavaæ˜¯Googleæä¾›çš„Javaæ‰©å±•åŒ…ï¼Œå®ƒæä¾›äº†ä¸€ç§å¼‚æ­¥å›è°ƒçš„è§£å†³æ–¹æ¡ˆã€‚Guavaä¸­ä¸å¼‚æ­¥å›è°ƒç›¸å…³çš„æºç å¤„äºcom.google.commonutilconcurrentåŒ…ä¸­ã€‚åŒ…ä¸­çš„å¾ˆå¤šç±»éƒ½ç”¨äºå¯¹javautilconcurrentçš„èƒ½åŠ›æ‰©å±•å’Œèƒ½åŠ›å¢å¼ºã€‚æ¯”å¦‚ï¼ŒGuavaçš„å¼‚æ­¥ä»»åŠ¡æ¥å£ListenableFutureæ‰©å±•äº†Javaçš„Futureæ¥å£ï¼Œå®ç°äº†å¼‚æ­¥å›è°ƒçš„èƒ½åŠ›ã€‚â€‹ 1.FutureCallbackæ€»ä½“æ¥è¯´ï¼ŒGuavaä¸»è¦å¢å¼ºäº†Javaè€Œä¸æ˜¯å¦èµ·ç‚‰ç¶ã€‚ä¸ºäº†å®ç°å¼‚æ­¥å›è°ƒæ–¹å¼è·å–å¼‚æ­¥çº¿ç¨‹çš„ç»“æœï¼ŒGuavaåšäº†ä»¥ä¸‹å¢å¼º:â€‹ å¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ¥å£ListenableFutureï¼Œç»§æ‰¿äº†Javaçš„Futureæ¥å£ï¼Œä½¿å¾—Javaçš„Futureå¼‚æ­¥ä»»åŠ¡åœ¨Guavaä¸­èƒ½è¢«ç›‘æ§å’Œéé˜»å¡è·å–å¼‚æ­¥ç»“æœã€‚ å¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ¥å£FutureCallbackï¼Œè¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ–°æ¥å£ã€‚è¯¥æ¥å£çš„ç›®çš„æ˜¯åœ¨å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œæ ¹æ®å¼‚æ­¥ç»“æœå®Œæˆä¸åŒçš„å›è°ƒå¤„ç†ï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†å¼‚æ­¥ç»“æœã€‚ â€‹ FutureCallbackæ˜¯ä¸€ä¸ªæ–°å¢çš„æ¥å£ï¼Œç”¨æ¥å¡«å†™å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œåçš„ç›‘å¬é€»è¾‘ã€‚FutureCallbackæ‹¥æœ‰ä¸¤ä¸ªæ—¥è°ƒæ–¹æ³•:â€‹ onSuccess()æ–¹æ³•ï¼Œåœ¨å¼‚æ­¥ä»»åŠ¡æ‰§è¡ŒæˆåŠŸåè¢«å›è°ƒã€‚è°ƒç”¨æ—¶ï¼Œå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œç»“æœä½œä¸ºonSuccessæ–¹æ³•çš„å‚æ•°è¢«ä¼ å…¥ã€‚ onFailure0æ–¹æ³•ï¼Œåœ¨å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶è¢«å›è°ƒã€‚è°ƒç”¨æ—¶ï¼Œå¼‚æ­¥ä»»åŠ¡æ‰€æŠ›å‡ºçš„å¼‚å¸¸ä½œä¸ºonFailureæ–¹æ³•çš„å‚æ•°è¢«ä¼ å…¥ã€‚ â€‹ Guavaçš„FutureCallbackä¸Javaçš„Callableåå­—ç›¸è¿‘ï¼Œå®è´¨ä¸åŒï¼Œå­˜åœ¨æœ¬è´¨çš„åŒºåˆ«:â€‹ (1)Javaçš„Callableæ¥å£ä»£è¡¨çš„æ˜¯å¼‚æ­¥æ‰§è¡Œçš„é€»è¾‘ã€‚â€‹ (2)Guavaçš„FutureCallbackæ¥å£ä»£è¡¨çš„æ˜¯Callableå¼‚æ­¥é€»è¾‘æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ ¹æ®æˆåŠŸæˆ–è€…å¼‚å¸¸ä¸¤ç§æƒ…å½¢æ‰€éœ€è¦æ‰§è¡Œçš„å–„åå·¥ä½œã€‚â€‹ Guavaæ˜¯å¯¹JavaFutureå¼‚æ­¥å›è°ƒçš„å¢å¼ºï¼Œä½¿ç”¨Guavaå¼‚æ­¥å›è°ƒä¹Ÿéœ€è¦ç”¨åˆ°Javaçš„Callableæ¥å£ã€‚ç®€å•åœ°è¯´ï¼Œåªæœ‰åœ¨Javaçš„Callableä»»åŠ¡æ‰§è¡Œç»“æœå‡ºæ¥åï¼Œæ‰å¯èƒ½æ‰§è¡ŒGuavaä¸­çš„FutureCallbackç»“æœå›è°ƒã€‚Guavaå¦‚ä½•å®ç°å¼‚æ­¥ä»»åŠ¡Callableå’Œç»“æœå›è°ƒFutureCallbackä¹‹é—´çš„ç›‘æ§å…³ç³»å‘¢?Guavaå¼•å…¥äº†ä¸€ä¸ªæ–°æ¥å£ListenableFutureï¼Œå®ƒç»§æ‰¿äº†Javaçš„ Futureæ¥å£ï¼Œå¢å¼ºäº†è¢«ç›‘æ§çš„èƒ½åŠ›ã€‚ â€‹ 2.ListenableFutureGuavaçš„ListenableFutureæ¥å£æ˜¯å¯¹Javaçš„Futureæ¥å£çš„æ‰©å±•ï¼Œå¯ä»¥ç†è§£ä¸ºå¼‚æ­¥ä»»åŠ¡å®ä¾‹ï¼šâ€‹ 1234public interface ListenableFuture&lt;V&gt; extends Future&lt;V&gt;&#123; //æ­¤æ–¹æ³•ç”±guavaå†…éƒ¨è°ƒç”¨ void addListener(Runnable r , Executor e) &#125; ListenableFutureä»…ä»…å¢åŠ äº†ä¸€ä¸ªaddListeneræ–¹æ³•ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯å°†FutureCallbackå–„åå›è°ƒé€»è¾‘å°è£…æˆä¸€ä¸ªå†…éƒ¨çš„Runnableå¼‚æ­¥å£è°ƒä»»åŠ¡ï¼Œåœ¨Callableå¼‚æ­¥ä»»åŠ¡å®Œæˆåå›è°ƒFutureCallbackå–„åé€»è¾‘ã€‚â€‹ æ³¨æ„ï¼Œæ­¤addListener(æ–¹æ³•åªåœ¨Guavaå†…éƒ¨è°ƒç”¨ï¼Œåœ¨å®é™…ç¼–ç¨‹ä¸­ï¼ŒaddListener(ï¼‰ä¸ä¼šä½¿ç”¨åˆ°ã€‚â€‹ åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œå¦‚ä½•å°†FutureCallbackå›è°ƒé€»è¾‘ç»‘å®šåˆ°å¼‚æ­¥çš„ ListenableFutureä»»åŠ¡å‘¢?å¯ä»¥ä½¿ç”¨Guavaçš„Futureså·¥å…·ç±»ï¼Œå®ƒæœ‰ä¸€ä¸ª addCallback0é™æ€æ–¹æ³•ï¼Œå¯ä»¥å°†FutureCallbackçš„å›è°ƒå®ä¾‹ç»‘å®šåˆ° ListenableFutureå¼‚æ­¥ä»»åŠ¡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç»‘å®šå®ä¾‹:â€‹ 123456789Futures.addCallback(listenableFuture,new FutureCallback&lt;Boolean&gt;)&#123; public void onSuccess(Boolean r)&#123; // listenableFutureå†…çš„Callable æˆåŠŸæ—¶å›è°ƒæ­¤æ–¹æ³• &#125; public void onFailure(Throwable t)&#123; // listenableFutureå†…çš„Callable å¼‚å¸¸æ—¶å›è°ƒæ­¤æ–¹æ³• &#125;&#125; â€‹ Guavaçš„ListenableFutureæ¥å£æ˜¯å¯¹Javaçš„Futureæ¥å£çš„æ‰©å±•ï¼Œéƒ½è¡¨ç¤ºå¼‚æ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆGuavaçš„å¼‚æ­¥ä»»åŠ¡å®ä¾‹ä»ä½•è€Œæ¥?â€‹ 3.ListenableFutureå¼‚æ­¥ä»»åŠ¡å¦‚æœè¦è·å–Guavaçš„ListenableFutureå¼‚æ­¥ä»»åŠ¡å®ä¾‹ï¼Œä¸»è¦é€šè¿‡å‘çº¿ç¨‹æ± (ThreadPool)æäº¤Callableä»»åŠ¡çš„æ–¹å¼è·å–ã€‚ä¸è¿‡ï¼Œè¿™é‡Œæ‰€è¯´çš„çº¿ç¨‹æ± ä¸æ˜¯Javaçš„çº¿ç¨‹æ± ï¼Œè€Œæ˜¯ç»è¿‡Guavaè‡ªå·±å®šåˆ¶è¿‡çš„Guavaçº¿ç¨‹æ± ã€‚â€‹ Guavaçº¿ç¨‹æ± æ˜¯å¯¹Javaçº¿ç¨‹æ± çš„ä¸€ç§è£…é¥°ã€‚åˆ›å»ºGuavaçº¿ç¨‹æ± çš„æ–¹æ³•å¦‚ä¸‹:â€‹ 12345//javaçº¿ç¨‹æ± ExecutorService jPool = Executors.newFixedThreadPool(10);//Guavaçº¿ç¨‹æ± ListeningExecutorService gPool = MoreExecutors.listeningDecorator(jPool); â€‹ é¦–å…ˆåˆ›å»ºJavaçº¿ç¨‹æ± ï¼Œç„¶åä»¥å…¶ä½œä¸ºGuavaçº¿ç¨‹æ± çš„å‚æ•°å†æ„é€ ä¸€ä¸ªGuavaçº¿ç¨‹æ± ã€‚æœ‰äº†Guavaçš„çº¿ç¨‹æ± ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡submit()æ–¹æ³•æ¥æäº¤ä»»åŠ¡äº†ï¼Œä»»åŠ¡æäº¤ä¹‹åçš„è¿”å›ç»“æœå°±æ˜¯æˆ‘ä»¬æ‰€è¦çš„ListenableFutureå¼‚æ­¥ä»»åŠ¡å®ä¾‹ã€‚â€‹ ç®€å•æ¥è¯´ï¼Œè·å–å¼‚æ­¥ä»»åŠ¡å®ä¾‹çš„æ–¹å¼æ˜¯é€šè¿‡å‘çº¿ç¨‹æ± æäº¤Callableä¸šåŠ¡é€»è¾‘æ¥å®ç°ï¼Œä»£ç å¦‚ä¸‹:â€‹ 123456//submit()ç”¨æ¥æäº¤ä»»åŠ¡ï¼Œè¿”å›å¼‚æ­¥ä»»åŠ¡å®ä¾‹ListenableFuture&lt;Boolean&gt; hFuture = gPool.submit(hJob);//ç»‘å®šå›è°ƒå®ä¾‹Futures.addCallback(listenableFuture, new FutureCallback&lt;Boolean&gt;()&#123; //æœ‰ä¸¤ç§å®ç°å›è°ƒçš„æ–¹æ³•&#125;); â€‹ å–åˆ°äº†ListenableFutureå®ä¾‹åï¼Œé€šè¿‡Futures.addCallback0æ–¹æ³•å°† FutureCallbackå›è°ƒé€»è¾‘çš„å®ä¾‹ç»‘å®šåˆ°ListenableFutureå¼‚æ­¥ä»»åŠ¡å®ä¾‹ï¼Œå®ç°å¼‚æ­¥æ‰§è¡Œå®Œæˆåçš„å›è°ƒã€‚â€‹ æ€»ç»“ä¸€ä¸‹ï¼ŒGuavaå¼‚æ­¥å›è°ƒçš„æµç¨‹å¦‚ä¸‹:â€‹ å®ç°Javaçš„Callableæ¥å£ï¼Œåˆ›å»ºå¼‚æ­¥æ‰§è¡Œé€»è¾‘ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå¦‚æœä¸éœ€è¦è¿”å›å€¼ï¼Œå¼‚æ­¥æ‰§è¡Œé€»è¾‘ä¹Ÿå¯ä»¥å®ç°Runnableæ¥å£ã€‚ åˆ›å»ºGuavaçº¿ç¨‹æ± ã€‚ å°†(1)åˆ›å»ºçš„Callable/Runnableå¼‚æ­¥æ‰§è¡Œé€»è¾‘çš„å®ä¾‹æäº¤åˆ° Guavaçº¿ç¨‹æ± ï¼Œä»è€Œè·å–ListenableFutureå¼‚æ­¥ä»»åŠ¡å®ä¾‹ã€‚ åˆ›å»ºFutureCallbackå›è°ƒå®ä¾‹ï¼Œé€šè¿‡FuturesaddCallbackå°†å›è°ƒå®ä¾‹ç»‘å®šåˆ°ListenableFutureå¼‚æ­¥ä»»åŠ¡ä¸Šã€‚ â€‹ å®Œæˆä»¥ä¸Š4æ­¥ï¼Œå½“Callable/Runnableå¼‚æ­¥æ‰§è¡Œé€»è¾‘å®Œæˆåï¼Œå°±ä¼šå›è°ƒ FutureCallbackå®ä¾‹çš„å›è°ƒæ–¹æ³•onSuccess()/onFailure()ã€‚â€‹ 4.ä½¿ç”¨Guavaå®ç°æ³¡èŒ¶å–çš„å®ä¾‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109public class GuavaFutureDemo &#123; public static final int SLEEP_GAP=3; static class HotWaterJob implements Callable&lt;Boolean&gt;&#123; @Override public Boolean call() throws Exception &#123; try &#123; System.out.println(&quot;æ´—å¥½æ°´å£¶&quot;); System.out.println(&quot;çƒ§å¼€æ°´&quot;); TimeUnit.SECONDS.sleep(SLEEP_GAP); System.out.println(&quot;æ°´å¼€äº†&quot;); &#125;catch (Exception e)&#123; e.printStackTrace(); return false; &#125; return true; &#125; &#125; static class WashJob implements Callable&lt;Boolean&gt;&#123; @Override public Boolean call() throws Exception &#123; try&#123; System.out.println(&quot;æ´—èŒ¶æ¯&quot;); TimeUnit.SECONDS.sleep(SLEEP_GAP); System.out.println(&quot;æ´—å®Œäº†&quot;); &#125;catch (Exception e)&#123; System.out.println(&quot;æ¸…æ´—å·¥ä½œå‘ç”Ÿå¼‚å¸¸ï¼&quot;); return false; &#125; System.out.println(&quot;æ¸…æ´—å·¥ä½œè¿è¡Œç»“æŸï¼&quot;); return true; &#125; &#125; static class DrinkJob&#123; boolean waterOk =false; boolean cupOk =false; public void drinkTea()&#123; if (waterOk&amp;&amp;cupOk)&#123; System.out.println(&quot;æ³¡èŒ¶å–ï¼ŒèŒ¶å–å®Œï¼&quot;); this.waterOk=false; &#125; &#125; &#125; public static void main(String[] args)throws Exception &#123; Thread.currentThread().setName(&quot;æ³¡èŒ¶å–çº¿ç¨‹&quot;); //æ–°å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä½œä¸ºæ³¡èŒ¶ä¸»çº¿ç¨‹ DrinkJob drinkJob = new DrinkJob(); //çƒ§æ°´çš„ä¸šåŠ¡é€»è¾‘ Callable&lt;Boolean&gt; hotJob = new HotWaterJob(); //æ¸…æ™°çš„ä¸šåŠ¡é€»è¾‘ Callable&lt;Boolean&gt; washJob = new HotWaterJob(); //åˆ›å»ºjavaçº¿ç¨‹æ±  ExecutorService jPool = Executors.newFixedThreadPool(10); //åŒ…è£…javaçº¿ç¨‹æ± ï¼Œæ„é€ guavaçº¿ç¨‹æ±  ListeningExecutorService gPool = MoreExecutors.listeningDecorator(jPool); //çƒ§æ°´çš„å›è°ƒ FutureCallback&lt;Boolean&gt; hotWaterHook = new FutureCallback&lt;Boolean&gt;() &#123; @Override public void onSuccess(Boolean r) &#123; if (r)&#123; drinkJob.waterOk=true; drinkJob.drinkTea(); &#125; &#125; @Override public void onFailure(Throwable throwable) &#123; System.out.println(&quot;å–nmï¼&quot;); &#125; &#125;; //å¯åŠ¨çƒ§æ°´çº¿ç¨‹ ListenableFuture&lt;Boolean&gt; hotFuture = gPool.submit(hotJob); //è®¾ç½®çƒ§æ°´ä»»åŠ¡çš„å›è°ƒé’©å­ Futures.addCallback(hotFuture, hotWaterHook); //å¯åŠ¨æ¸…æ´—çº¿ç¨‹ ListenableFuture&lt;Boolean&gt; washFuture = gPool.submit(washJob); //ä½¿ç”¨åŒ¿åå®ä¾‹ï¼Œä½œä¸ºæ¸…æ´—ä¹‹åçš„å›è°ƒé’©å­ Futures.addCallback(washFuture, new FutureCallback&lt;Boolean&gt;() &#123; @Override public void onSuccess(Boolean r) &#123; if (r)&#123; drinkJob.cupOk=true; //æ‰§è¡Œå›è°ƒ drinkJob.drinkTea(); &#125; &#125; @Override public void onFailure(Throwable throwable) &#123; System.out.println(&quot;å–nmï¼&quot;); &#125; &#125;); System.out.println(&quot;å¹²ç‚¹å…¶ä»–äº‹ï¼&quot;); TimeUnit.SECONDS.sleep(1); System.out.println(&quot;æ‰§è¡Œå®Œæˆï¼&quot;); &#125;&#125; â€‹ ä»¥ä¸Šç»“æœï¼Œçƒ§æ°´çº¿ç¨‹ä¸ºpool-1-thread-1ï¼Œæ¸…æ´—çº¿ç¨‹ä¸ºpool-1-thread-2ï¼Œåœ¨äºŒè€…å®Œæˆä¹‹å‰ï¼Œæ³¡èŒ¶å–çº¿ç¨‹å·²ç»æ‰§è¡Œå®Œäº†ã€‚æ³¡èŒ¶å–çš„å·¥ä½œåœ¨å¼‚æ­¥å›è°ƒæ–¹æ³•drinkTea(ä¸­æ‰§è¡Œï¼Œæ‰§è¡Œçš„çº¿ç¨‹å¹¶ä¸æ˜¯â€œæ³¡èŒ¶å–â€çº¿ç¨‹ï¼Œè€Œæ˜¯çƒ§æ°´çº¿ç¨‹å’Œæ¸…æ´—çº¿ç¨‹ã€‚â€‹ 5.Guavaå¼‚æ­¥å›è°ƒå’ŒJavaå¼‚æ­¥å›è°ƒçš„åŒºåˆ«æ€»ç»“ä¸€ä¸‹Guavaå¼‚æ­¥å›è°ƒå’ŒJavaçš„FutureTaskå¼‚æ­¥è°ƒç”¨çš„åŒºåˆ«ï¼Œå…·ä½“å¦‚ä¸‹:â€‹ FutureTaskæ˜¯ä¸»åŠ¨è°ƒç”¨çš„æ¨¡å¼ï¼Œâ€œè°ƒç”¨çº¿ç¨‹â€ä¸»åŠ¨è·å¾—å¼‚æ­¥ç»“æœï¼Œåœ¨è·å–å¼‚æ­¥ç»“æœæ—¶å¤„äºé˜»å¡çŠ¶æ€ï¼Œå¹¶ä¸”ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æ‹¿åˆ°å¼‚æ­¥çº¿ç¨‹çš„ç»“æœã€‚ Guavaæ˜¯å¼‚æ­¥å›è°ƒæ¨¡å¼ï¼Œâ€œè°ƒç”¨çº¿ç¨‹â€ä¸ä¼šä¸»åŠ¨è·å¾—å¼‚æ­¥ç»“æœï¼Œè€Œæ˜¯å‡†å¤‡å¥½å›è°ƒå‡½æ•°ï¼Œå¹¶è®¾ç½®å¥½å›è°ƒé’©å­ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°çš„å¹¶ä¸æ˜¯â€œè°ƒç”¨çº¿ç¨‹â€è‡ªèº«ï¼Œå›è°ƒæ‰¿æ•°çš„æ‰§è¡Œè€…æ˜¯â€œè¢«è°ƒç”¨çº¿ç¨‹â€ï¼Œâ€œè°ƒç”¨çº¿ç¨‹â€åœ¨æ‰§è¡Œå®Œè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘åå°±å·²ç»ç»“æŸäº†ï¼Œå½“å›è°ƒé‡‡æ•°è¢«æ‰§è¡Œæ—¶ï¼Œâ€œè°ƒç”¨çº¿ç¨‹â€å¯èƒ½å·²ç»ç»“æŸå¾ˆä¹…äº†ã€‚ â€‹ äºŒï¼ŒNettyçš„å¼‚æ­¥å›è°ƒæ¨¡å¼Nettyå®˜æ–¹æ–‡æ¡£è¯´æ˜Nettyçš„ç½‘ç»œæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ã€‚Nettyæºç ä¸­å¤§é‡ä½¿ç”¨äº†å¼‚æ­¥å›è°ƒå¤„ç†æ¨¡å¼ã€‚åœ¨Nettyçš„ä¸šåŠ¡å¼€å‘å±‚é¢ï¼Œå¤„äºNettyåº”ç”¨çš„ Handlerå¤„ç†ç¨‹åºä¸­çš„ä¸šåŠ¡å¤„ç†ä»£ç ä¹Ÿéƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚æ‰€ä»¥ï¼Œäº†è§£ Nettyçš„å¼‚æ­¥å›è°ƒï¼Œæ— è®ºæ˜¯Nettyåº”ç”¨å¼€å‘è¿˜æ˜¯æºç çº§å¼€å‘éƒ½æ˜¯ååˆ†é‡è¦çš„ã€‚â€‹ Nettyå’ŒGuavaä¸€æ ·ï¼Œå®ç°äº†è‡ªå·±çš„å¼‚æ­¥å›è°ƒä½“ç³»:Nettyç»§æ‰¿å’Œæ‰©å±•äº†JDKFutureç³»åˆ—å¼‚æ­¥å›è°ƒçš„APIï¼Œå®šä¹‰äº†è‡ªèº«çš„Futureç³»åˆ—æ¥å£å’Œç±»ï¼Œå®ç°äº†å¼‚æ­¥ä»»åŠ¡çš„ç›‘æ§ã€å¼‚æ­¥æ‰§è¡Œç»“æœçš„è·å–ã€‚â€‹ æ€»ä½“æ¥è¯´ï¼ŒNettyå¯¹JavaFutureå¼‚æ­¥ä»»åŠ¡çš„æ‰©å±•å¦‚ä¸‹:â€‹ ç»§æ‰¿Javaçš„Futureæ¥å£å¾—åˆ°äº†ä¸€ä¸ªæ–°çš„å±äºNettyè‡ªå·±çš„Futureå¼‚æ­¥ä»»åŠ¡æ¥å£ï¼Œè¯¥æ¥å£å¯¹åŸæœ‰çš„æ¥å£è¿›è¡Œäº†å¢å¼ºï¼Œä½¿å¾—Nettyå¼‚æ­¥ä»»åŠ¡èƒ½å¤Ÿéé˜»å¡åœ°å¤„ç†å›è°ƒç»“æœã€‚æ³¨æ„ï¼ŒNettyæ²¡æœ‰ä¿®æ”¹Futureçš„åç§°ï¼Œåªæ˜¯è°ƒæ•´äº†æ‰€åœ¨çš„åŒ…åï¼ŒNettyçš„Futureç±»çš„åŒ…åå’ŒJavaçš„Futureæ¥å£çš„åŒ…ä¸åŒã€‚â€‹ å¼•å…¥äº†ä¸€ä¸ªæ–°æ¥å£â€“GenericFutureListenerï¼Œç”¨äºè¡¨ç¤ºå¼‚æ­¥æ‰§è¡Œå®Œæˆçš„ç›‘å¬å™¨ã€‚è¿™ä¸ªæ¥å£å’ŒGuavaçš„FutureCallbackå›è°ƒæ¥å£ä¸åŒã€‚Nettvä½¿ç”¨äº†ç›‘å¬å™¨çš„æ¨¡å¼ï¼Œå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåçš„å›è°ƒé€»è¾‘æŠ½è±¡æˆäº†Listenerç›‘å¬å™¨æ¥å£ã€‚å¯ä»¥å°†Nettyçš„GenericFutureListenerç›‘å¬å™¨æ¥å£åŠ å…¥Nettyå¼‚æ­¥ä»»åŠ¡Futureä¸­ï¼Œå®ç°å¯¹å¼‚æ­¥ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€çš„äº‹ä»¶ç›‘å¬ã€‚â€‹ æ€»ä½“æ¥è¯´ï¼Œåœ¨å¼‚æ­¥éé˜»å¡å›è°ƒçš„è®¾è®¡æ€è·¯ä¸Šï¼ŒNettyå’ŒGuavaæ˜¯ä¸€è‡´çš„ã€‚å¯¹åº”å…³ç³»ä¸º:â€‹ Nettyçš„Futureæ¥å£å¯ä»¥å¯¹åº”åˆ°Guavaçš„ListenableFutureæ¥å£ã€‚ â€‹ Nettyçš„GenericFutureListeneræ¥å£å¯ä»¥å¯¹åº”åˆ°Guavaçš„ FutureCallbackæ¥å£ã€‚ â€‹ 1.GenericFutureListenerå‰é¢æåˆ°ï¼Œå’ŒGuavaçš„FutureCallbackä¸€æ ·ï¼ŒNettyæ–°å¢äº†ä¸€ä¸ªæ¥å£ï¼Œç”¨æ¥å°è£…å¼‚æ­¥éé˜»å¡å›è°ƒçš„é€»è¾‘ï¼Œé‚£å°±æ˜¯GenericFutureListeneræ¥å£ã€‚â€‹ GenericFutureListenerä½äºio.netty.util.concurrentåŒ…ä¸­ï¼Œæºç å¦‚ä¸‹:â€‹ 123456package io.netty.util.concurrent; import java.util.EventListenerpublic interface GenericFutureListener&lt;F extends Future&lt;?&gt;&gt; extends Eventlistener&#123; //ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³• void operationComplete(F var1) throws Exception;&#125; â€‹ GenericFutureListeneræ‹¥æœ‰ä¸€ä¸ªå›è°ƒæ–¹æ³•operationCompleteOï¼Œè¡¨ç¤ºå¼‚æ­¥ä»»åŠ¡æ“ä½œå®Œæˆã€‚åœ¨Futureå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåå°†å›è°ƒæ­¤æ–¹æ³•ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒNettyçš„å¼‚æ­¥å›è°ƒä»£ç ç¼–å†™åœ¨GenericFutureListeneræ¥å£çš„å®ç°ç±»çš„operationCompleteæ–¹æ³•ä¸­ã€‚â€‹ è¯´æ˜ä¸€ä¸‹ï¼ŒGenericFutureListenerçš„çˆ¶æ¥å£EventListeneræ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œæ²¡æœ‰ä»»ä½•æŠ½è±¡æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªä»…ä»…å…·æœ‰æ ‡è¯†ä½œç”¨çš„æ¥å£ã€‚â€‹ 2.Nettyçš„Futureæ¥å£Nettyä¹Ÿå¯¹Javaçš„Futureæ¥å£è¿›è¡Œäº†æ‰©å±•ï¼Œå¹¶ä¸”åç§°æ²¡æœ‰å˜ï¼Œè¿˜æ˜¯å«ä½œFutureæ¥å£ï¼Œå®ç°åœ¨io.nettyutil.concurrentåŒ…ä¸­ã€‚â€‹ å’ŒGuavaçš„ListenableFutureä¸€æ ·ï¼ŒNettyçš„Futureæ¥å£æ‰©å±•äº†ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå¯¹æ‰§è¡Œçš„è¿‡ç¨‹è¿›è¡Œç›‘æ§ï¼Œå¯¹å¼‚æ­¥å›è°ƒå®Œæˆäº‹ä»¶è¿›è¡ŒListenç›‘å¬å¹¶ä¸”å›è°ƒã€‚â€‹ Nettyçš„Futureæ¥å£ä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šä½¿ç”¨å®ƒçš„å­æ¥å£ã€‚Nettyæœ‰ä¸€ç³»åˆ—å­æ¥å£ï¼Œä»£è¡¨ä¸åŒç±»å‹çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå¦‚ChannelFutureæ¥å£ã€‚â€‹ ChannelFutureå­æ¥å£è¡¨ç¤ºChannelé€šé“I/0æ“ä½œçš„å¼‚æ­¥ä»»åŠ¡ï¼Œå¦‚æœåœ¨ Channelçš„å¼‚æ­¥I/0æ“ä½œå®Œæˆåéœ€è¦æ‰§è¡Œå›è°ƒæ“ä½œï¼Œå°±éœ€è¦ä½¿ç”¨åˆ° ChannelFutureæ¥å£ã€‚â€‹ 3.ChannelFutureåœ¨Nettyç½‘ç»œç¼–ç¨‹ä¸­ï¼Œç½‘ç»œè¿æ¥é€šé“çš„è¾“å…¥ã€è¾“å‡ºå¤„ç†éƒ½æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œéƒ½ä¼šè¿”å›ä¸€ä¸ªChannelFutureæ¥å£çš„å®ä¾‹ã€‚é€šè¿‡è¿”å›çš„å¼‚æ­¥ä»»åŠ¡å®ä¾‹å¯ä»¥ä¸ºå…¶å¢åŠ å¼‚æ­¥å›è°ƒçš„ç›‘å¬å™¨ã€‚åœ¨å¼‚æ­¥ä»»åŠ¡çœŸæ­£å®Œæˆåï¼Œå›è°ƒæ‰§è¡Œã€‚â€‹ Nettyçš„ç½‘ç»œè¿æ¥çš„å¼‚æ­¥å›è°ƒå®ä¾‹ä»£ç å¦‚ä¸‹:â€‹ 1234567891011121314//connectæ˜¯å¼‚æ­¥çš„ï¼Œä»…ä»…æ˜¯æäº¤å¼‚æ­¥ä»»åŠ¡ChannelFuture future = bootstrap.connect(new InetSocketAddress(&quot;www.manning.com,80));//connectçš„å¼‚æ­¥ä»»åŠ¡çœŸæ­£æ‰§è¡Œå®Œæˆåï¼Œfutureå›è°ƒç›‘å¬å™¨ä¼šæ‰§è¡Œfuture.addListener(new ChannelFutureListener()&#123; @Override public void operationComplete(ChannelFuture channelFuture) throws Exception &#123; if(channelFuture.isSuccess)) System.out.println(&quot;Connection established&quot;); else &#123; System.err.println(&quot;Connection attempt failed&quot;); channelFuture.cause().printStackTrace); &#125; &#125;&#125; â€‹ GenericFutureListeneræ¥å£åœ¨Nettyä¸­æ˜¯ä¸€ä¸ªåŸºç¡€ç±»å‹æ¥å£ã€‚åœ¨ç½‘ç»œç¼–ç¨‹çš„å¼‚æ­¥å›è°ƒä¸­ï¼Œä¸€èˆ¬ä½¿ç”¨Nettyä¸­æä¾›çš„æŸä¸ªå­æ¥å£ï¼Œå¦‚ChannelFutureListeneræ¥å£ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä½¿ç”¨åˆ°çš„æ˜¯è¿™ä¸ªå­æ¥å£ã€‚â€‹ 4.Nettyçš„å‡ºç«™å’Œå…¥ç«™å¼‚æ­¥å›è°ƒNettyçš„å‡ºç«™å’Œå…¥ç«™æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ã€‚å¼‚æ­¥å›è°ƒçš„æ–¹æ³•å’Œå‰é¢Nettyå»ºç«‹çš„å¼‚æ­¥å›è°ƒæ˜¯ä¸€æ ·çš„ã€‚â€‹ ä¸‹é¢ä»¥ç»å…¸çš„NIOå‡ºç«™æ“ä½œwriteä¸ºä¾‹è¯´æ˜ChannelFutureçš„ä½¿ç”¨ã€‚â€‹ åœ¨writeæ“ä½œè°ƒç”¨åï¼ŒNettyå¹¶æ²¡æœ‰ç«‹å³å®Œæˆå¯¹JavaNIOåº•å±‚è¿æ¥çš„å†™å…¥æ“ä½œï¼Œåº•å±‚çš„å†™å…¥æ“ä½œæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä»£ç å¦‚ä¸‹:â€‹ 123456789//write()è¾“å‡ºæ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ChannelFuture future=ctx.channel0.write(msg);//ä¸ºå¼‚æ­¥ä»»åŠ¡åŠ ä¸Šç›‘å¬å™¨ future.addListener( new ChannelFutureListener()&#123; @Override public void operationComplete(ChannelFuture future)&#123; // writeæ“ä½œå®Œæˆåçš„å›è°ƒä»£ç  &#125; &#125;); â€‹ åœ¨writeæ“ä½œå®Œæˆåç«‹å³è¿”å›ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªChannelFutureæ¥å£çš„å®ä¾‹ã€‚é€šè¿‡è¿™ä¸ªå®ä¾‹å¯ä»¥ç»‘å®šå¼‚æ­¥å›è°ƒç›‘å¬å™¨ï¼Œç¼–å†™å¼‚æ­¥å›è°ƒçš„é€»è¾‘ã€‚â€‹ â€‹","categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]},{"title":"RabbitMQ","slug":"æ¶ˆæ¯é˜Ÿåˆ—/RabbitMQ","date":"2022-01-11T09:08:03.557Z","updated":"2022-01-11T09:11:01.252Z","comments":true,"path":"2022/01/11/æ¶ˆæ¯é˜Ÿåˆ—/RabbitMQ/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/RabbitMQ/","excerpt":"","text":"ä¸€.rabbitMQæ¦‚è¿°1.æœç´¢ä¸å•†å“æœåŠ¡çš„é—®é¢˜å‡è®¾æˆ‘ä»¬å·²ç»å®Œæˆäº†å•†å“è¯¦æƒ…å’Œæœç´¢ç³»ç»Ÿçš„å¼€å‘ã€‚æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼Œæ˜¯å¦å­˜åœ¨é—®é¢˜ï¼Ÿ å•†å“çš„åŸå§‹æ•°æ®ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œå¢åˆ æ”¹æŸ¥éƒ½åœ¨æ•°æ®åº“ä¸­å®Œæˆã€‚æœç´¢æœåŠ¡æ•°æ®æ¥æºæ˜¯ç´¢å¼•åº“ï¼Œå¦‚æœæ•°æ®åº“å•†å“å‘ç”Ÿå˜åŒ–ï¼Œç´¢å¼•åº“æ•°æ®èƒ½å¦åŠæ—¶æ›´æ–°ã€‚å¦‚æœæˆ‘ä»¬åœ¨åå°ä¿®æ”¹äº†å•†å“çš„ä»·æ ¼ï¼Œæœç´¢é¡µé¢ä¾ç„¶æ˜¯æ—§çš„ä»·æ ¼ï¼Œè¿™æ ·æ˜¾ç„¶ä¸å¯¹ã€‚è¯¥å¦‚ä½•è§£å†³ï¼Ÿ æ–¹æ¡ˆ1ï¼šæ¯å½“åå°å¯¹å•†å“åšå¢åˆ æ”¹æ“ä½œï¼ŒåŒæ—¶è¦ä¿®æ”¹ç´¢å¼•åº“æ•°æ® æ–¹æ¡ˆ2ï¼šæœç´¢æœåŠ¡å¯¹å¤–æä¾›æ“ä½œæ¥å£ï¼Œåå°åœ¨å•†å“å¢åˆ æ”¹åï¼Œè°ƒç”¨æ¥å£ ä»¥ä¸Šä¸¤ç§æ–¹å¼éƒ½æœ‰åŒä¸€ä¸ªä¸¥é‡é—®é¢˜ï¼šå°±æ˜¯ä»£ç è€¦åˆï¼Œåå°æœåŠ¡ä¸­éœ€è¦åµŒå…¥æœç´¢å’Œå•†å“é¡µé¢æœåŠ¡ï¼Œè¿èƒŒäº†å¾®æœåŠ¡çš„ç‹¬ç«‹åŸåˆ™ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡å¦å¤–ä¸€ç§æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼šæ¶ˆæ¯é˜Ÿåˆ— 2.æ¶ˆæ¯é˜Ÿåˆ—2.1ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå³MQï¼ŒMessage Queueã€‚ â€œæ¶ˆæ¯â€æ˜¯åœ¨ä¸¤å°è®¡ç®—æœºé—´ä¼ é€çš„æ•°æ®å•ä½ã€‚æ¶ˆæ¯å¯ä»¥éå¸¸ç®€å•ï¼Œä¾‹å¦‚åªåŒ…å«æ–‡æœ¬å­—ç¬¦ä¸²ï¼›ä¹Ÿå¯ä»¥æ›´å¤æ‚ï¼Œå¯èƒ½åŒ…å«åµŒå…¥å¯¹è±¡ã€‚â€‹ æ¶ˆæ¯è¢«å‘é€åˆ°é˜Ÿåˆ—ä¸­ã€‚â€œæ¶ˆæ¯é˜Ÿåˆ—â€æ˜¯åœ¨æ¶ˆæ¯çš„ä¼ è¾“è¿‡ç¨‹ä¸­ä¿å­˜æ¶ˆæ¯çš„å®¹å™¨ã€‚æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç†å™¨åœ¨å°†æ¶ˆæ¯ä»å®ƒçš„æºä¸­ç»§åˆ°å®ƒçš„ç›®æ ‡æ—¶å……å½“ä¸­é—´äººã€‚é˜Ÿåˆ—çš„ä¸»è¦ç›®çš„æ˜¯æä¾›è·¯ç”±å¹¶ä¿è¯æ¶ˆæ¯çš„ä¼ é€’ï¼›å¦‚æœå‘é€æ¶ˆæ¯æ—¶æ¥æ”¶è€…ä¸å¯ç”¨ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¼šä¿ç•™æ¶ˆæ¯ï¼Œç›´åˆ°å¯ä»¥æˆåŠŸåœ°ä¼ é€’å®ƒã€‚ æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å…¸å‹çš„ï¼šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…æ¨¡å‹ã€‚ç”Ÿäº§è€…ä¸æ–­å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä¸æ–­çš„ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚å› ä¸ºæ¶ˆæ¯çš„ç”Ÿäº§å’Œæ¶ˆè´¹éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œè€Œä¸”åªå…³å¿ƒæ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶ï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘çš„ä¾µå…¥ï¼Œè¿™æ ·å°±å®ç°äº†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„è§£è€¦ã€‚ ç»“åˆå‰é¢æ‰€è¯´çš„é—®é¢˜ï¼š Â· å•†å“æœåŠ¡å¯¹å•†å“å¢åˆ æ”¹ä»¥åï¼Œæ— éœ€å»æ“ä½œç´¢å¼•åº“ï¼Œåªæ˜¯å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œä¹Ÿä¸å…³å¿ƒæ¶ˆæ¯è¢«è°æ¥æ”¶ã€‚ Â· æœç´¢æœåŠ¡æ¥æ”¶æ¶ˆæ¯ï¼Œå»å¤„ç†ç´¢å¼•åº“ã€‚ å¦‚æœä»¥åæœ‰å…¶å®ƒç³»ç»Ÿä¹Ÿä¾èµ–å•†å“æœåŠ¡çš„æ•°æ®ï¼ŒåŒæ ·ç›‘å¬æ¶ˆæ¯å³å¯ï¼Œå•†å“æœåŠ¡æ— éœ€ä»»ä½•ä»£ç ä¿®æ”¹ã€‚ 2.2AMQPå’ŒJMSMQæ˜¯æ¶ˆæ¯é€šä¿¡çš„æ¨¡å‹ï¼Œå¹¶ä¸æ˜¯å…·ä½“å®ç°ã€‚ç°åœ¨å®ç°MQçš„æœ‰ä¸¤ç§ä¸»æµæ–¹å¼ï¼šAMQPã€JMSã€‚ ä¸¤è€…é—´çš„åŒºåˆ«å’Œè”ç³»ï¼š Â· JMSæ˜¯å®šä¹‰äº†ç»Ÿä¸€æ¥å£ï¼Œå¯¹æ¶ˆæ¯æ“ä½œè¿›è¡Œç»Ÿä¸€ï¼›AMQPé€šè¿‡è§„å®šåè®®ç»Ÿä¸€æ•°æ®äº¤äº’çš„æ ¼å¼ï¼› Â· JMSé™å®šäº†å¿…é¡»ä½¿ç”¨Javaè¯­è¨€ï¼›AMQPåªæ˜¯åè®®ï¼Œä¸è§„å®šå®ç°æ–¹å¼ï¼Œå› æ­¤æ˜¯è·¨è¯­è¨€çš„ Â· JMSè§„å®šäº†ä¸¤ç§æ¶ˆæ¯æ¨¡å‹ï¼ˆqueue, topicï¼‰ï¼›è€ŒAMQPçš„æ¶ˆæ¯æ¨¡å‹æ›´åŠ ä¸°å¯Œ 2.3å¸¸è§MQäº§å“Â· ActiveMQï¼šåŸºäºJMS Â· RabbitMQï¼šåŸºäºAMQPåè®®ï¼Œerlangè¯­è¨€å¼€å‘ï¼Œç¨³å®šæ€§å¥½ Â· RocketMQï¼šåŸºäºJMSï¼Œé˜¿é‡Œå·´å·´äº§å“ï¼Œç›®å‰äº¤ç”±ApacheåŸºé‡‘ä¼š Â· Kafkaï¼šåˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼Œé«˜ååé‡ï¼Œå¤„ç†æ—¥å¿—ï¼ŒScalaå’ŒJavaç¼–å†™ï¼ŒApache 2.4 RabbitMQå®˜ç½‘ï¼š http://www.rabbitmq.com/ å®˜æ–¹æ•™ç¨‹ï¼šhttp://www.rabbitmq.com/getstarted.html 2.5 MQ ä¸‰å¤§ä¸»è¦åŠŸèƒ½ å¼‚æ­¥ è§£è€¦ å‰Šå³° 2.6 RabbitMQå·¥ä½œæ¨¡å‹ 1.Brokeræˆ‘ä»¬è¦ä½¿ç”¨RabbitMQæ¥æ”¶å‘æ¶ˆæ¯ï¼Œå¿…é¡»è¦å®‰è£…ä¸ªRabbitMQçš„æœåŠ¡ï¼Œå¯ä»¥å®‰è£…åœ¨Windowsä¸Šé¢ä¹Ÿå¯ä»¥å®‰è£…åœ¨Linux ä¸Šé¢ï¼Œé»˜è®¤æ˜¯5672çš„ç«¯å£ã€‚è¿™å°RabbitMQçš„æœåŠ¡å™¨æˆ‘ä»¬æŠŠå®ƒå«åš Brokerï¼Œ MQ æœåŠ¡å™¨å¸®åŠ©æˆ‘ä»¬åšçš„äº‹æƒ…å°±æ˜¯å­˜å‚¨ã€è½¬å‘æ¶ˆæ¯ã€‚ 2.Connectionæ— è®ºæ˜¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œè¿˜æ˜¯æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯ï¼Œéƒ½å¿…é¡»è¦è·Ÿ Broker ä¹‹é—´å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œè¿™ä¸ªè¿æ¥æ˜¯ä¸€ä¸ª TCP çš„é•¿è¿æ¥ã€‚ 3.Channelå¦‚æœæ‰€æœ‰çš„ç”Ÿäº§è€…å‘é€æ¶ˆæ¯å’Œæ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯ï¼Œéƒ½ç›´æ¥åˆ›å»ºå’Œé‡Šæ”¾ TCP é•¿è¿æ¥çš„è¯ï¼Œå¯¹äº Broker æ¥è¯´è‚¯å®šä¼šé€ æˆå¾ˆå¤§çš„æ€§èƒ½æŸè€—ï¼Œå› ä¸º TCP è¿æ¥æ˜¯éå¸¸å®è´µçš„èµ„æºï¼Œåˆ›å»ºå’Œé‡Šæ”¾ä¹Ÿè¦æ¶ˆè€—æ—¶é—´ã€‚æ‰€ä»¥åœ¨ AMQP é‡Œé¢å¼•å…¥äº† Channel çš„æ¦‚å¿µï¼Œå®ƒæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„è¿æ¥ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä¿æŒçš„ TCP é•¿è¿æ¥é‡Œé¢å»åˆ›å»ºå’Œé‡Šæ”¾Channelï¼Œå¤§å¤§äº†å‡å°‘äº†èµ„æºæ¶ˆè€—ã€‚ 4.Queueé˜Ÿåˆ—æ˜¯çœŸæ­£ç”¨æ¥å­˜å‚¨æ¶ˆæ¯çš„ï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„è¿›ç¨‹ï¼Œæœ‰è‡ªå·±çš„æ•°æ®åº“ï¼ˆMnesiaï¼‰ã€‚ æˆ‘ä»¬å¯ä»¥åŸºäºäº‹ä»¶æœºåˆ¶ï¼Œå®ç°æ¶ˆè´¹è€…å¯¹é˜Ÿåˆ—çš„ç›‘å¬ã€‚ ç”±äºé˜Ÿåˆ—æœ‰ FIFO çš„ç‰¹æ€§ï¼Œåªæœ‰ç¡®å®šå‰ä¸€æ¡æ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ¥æ”¶ä¹‹åï¼Œæ‰ä¼šæŠŠè¿™æ¡æ¶ˆæ¯ä»æ•°æ®åº“åˆ é™¤ï¼Œç»§ç»­æŠ•é€’ä¸‹ä¸€æ¡æ¶ˆæ¯ã€‚ 5.Exchangeåœ¨ RabbitMQ é‡Œé¢æ°¸è¿œä¸ä¼šå‡ºç°æ¶ˆæ¯ç›´æ¥å‘é€åˆ°é˜Ÿåˆ—çš„æƒ…å†µã€‚å› ä¸ºåœ¨ AMQP é‡Œé¢å¼•å…¥äº†äº¤æ¢æœºï¼ˆExchangeï¼‰çš„æ¦‚å¿µï¼Œç”¨æ¥å®ç°æ¶ˆæ¯çš„çµæ´»è·¯ç”±ã€‚ äº¤æ¢æœºæ˜¯ä¸€ä¸ªç»‘å®šåˆ—è¡¨ï¼Œç”¨æ¥æŸ¥æ‰¾åŒ¹é…çš„ç»‘å®šå…³ç³»ã€‚ é˜Ÿåˆ—ä½¿ç”¨ç»‘å®šé”®ï¼ˆBinding Keyï¼‰è·Ÿäº¤æ¢æœºå»ºç«‹ç»‘å®šå…³ç³»ã€‚ ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯éœ€è¦æºå¸¦è·¯ç”±é”®ï¼ˆRouting Keyï¼‰ï¼Œäº¤æ¢æœºæ”¶åˆ°æ¶ˆæ¯æ—¶ä¼šæ ¹æ®å®ƒä¿å­˜çš„ç»‘å®šåˆ—è¡¨ï¼Œå†³å®šå°†æ¶ˆæ¯è·¯ç”±åˆ°å“ªäº›ä¸å®ƒç»‘å®šçš„é˜Ÿåˆ—ä¸Šã€‚ æ³¨æ„ï¼šäº¤æ¢æœºä¸é˜Ÿåˆ—ã€é˜Ÿåˆ—ä¸æ¶ˆè´¹è€…éƒ½æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ã€‚ 6.VhostVHOST é™¤äº†å¯ä»¥æé«˜ç¡¬ä»¶èµ„æºçš„åˆ©ç”¨ç‡ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å®ç°èµ„æºçš„éš”ç¦»å’Œæƒé™çš„æ§åˆ¶ã€‚ ä¸åŒçš„ VHOST ä¸­å¯ä»¥æœ‰åŒåçš„ Exchange å’Œ Queueï¼Œå®ƒä»¬æ˜¯å®Œå…¨é€æ˜çš„ã€‚ è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºä¸åŒçš„ä¸šåŠ¡ç³»ç»Ÿåˆ›å»ºä¸åŒçš„ç”¨æˆ·ï¼ˆUserï¼‰ï¼Œç„¶åç»™è¿™äº›ç”¨æˆ·åˆ†é… VHOST çš„æƒé™ã€‚ 2.7 ä½¿ç”¨rabbitMQä¼šå¸¦æ¥çš„ä¸€äº›é—®é¢˜ï¼Ÿç³»ç»Ÿå¯ç”¨æ€§é™ä½ï¼šåŸæ¥æ˜¯ä¸¤ä¸ªèŠ‚ç‚¹çš„é€šä¿¡ï¼Œç°åœ¨è¿˜éœ€è¦ç‹¬ç«‹è¿è¡Œä¸€ä¸ªæœåŠ¡ï¼Œå¦‚æœ MQæœåŠ¡å™¨æˆ–è€…é€šä¿¡ç½‘ç»œå‡ºç°é—®é¢˜ï¼Œå°±ä¼šå¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚ ç³»ç»Ÿå¤æ‚æ€§æé«˜ï¼š ä¸ºä»€ä¹ˆè¯´å¤æ‚ï¼Ÿç¬¬ä¸€ä¸ªå°±æ˜¯ä½ å¿…é¡»è¦ç†è§£ç›¸å…³çš„æ¨¡å‹å’Œæ¦‚å¿µï¼Œæ‰èƒ½æ­£ç¡®åœ°é…ç½®å’Œä½¿ç”¨ MQã€‚ç¬¬äºŒä¸ªï¼Œä½¿ç”¨ MQ å‘é€æ¶ˆæ¯å¿…é¡»è¦è€ƒè™‘æ¶ˆæ¯ä¸¢å¤±å’Œæ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„é—®é¢˜ã€‚ä¸€æ—¦æ¶ˆæ¯æ²¡æœ‰è¢«æ­£ç¡®åœ°æ¶ˆè´¹ï¼Œå°±ä¼šå¸¦æ¥æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚ æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨åšç³»ç»Ÿæ¶æ„çš„æ—¶å€™ä¸€å®šè¦æ ¹æ®å®é™…æƒ…å†µæ¥åˆ†æï¼Œä¸è¦å› ä¸ºæˆ‘ä»¬è¯´äº†è¿™ä¹ˆå¤šçš„ MQ èƒ½è§£å†³çš„é—®é¢˜ï¼Œå°±ç›²ç›®åœ°å¼•å…¥ MQã€‚ 3.ä¸‹è½½å’Œå®‰è£…3.1 ä¸‹è½½RabbitMQæ˜¯Erlangè¯­è¨€ç¼–å†™ï¼Œæ‰€ä»¥Erangç¯å¢ƒå¿…é¡»è¦æœ‰ï¼Œæ³¨ï¼šErlangç¯å¢ƒä¸€å®šè¦ä¸RabbitMQç‰ˆæœ¬åŒ¹é…ï¼šhttps://www.rabbitmq.com/which-erlang.html Erlangä¸‹è½½åœ°å€ï¼šhttps://www.rabbitmq.com/releases/erlang/ï¼ˆæ ¹æ®è‡ªèº«éœ€æ±‚åŠåŒ¹é…å…³ç³»ï¼Œä¸‹è½½å¯¹åº”rpmåŒ…ï¼‰ https://dl.bintray.com/rabbitmq-erlang/rpm/erlang/21/el/7/x86_64/erlang-21.3.8.9-1.el7.x86_64.rpm rabbitmqå®‰è£…ä¾èµ–äºsocatï¼Œæ‰€ä»¥éœ€è¦ä¸‹è½½socatã€‚ socatä¸‹è½½åœ°å€ï¼šhttp://repo.iotti.biz/CentOS/7/x86_64/socat-1.7.3.2-5.el7.lux.x86_64.rpm RabbitMQä¸‹è½½åœ°å€ï¼šhttps://www.rabbitmq.com/download.htmlï¼ˆæ ¹æ®è‡ªèº«éœ€æ±‚åŠåŒ¹é…å…³ç³»ï¼Œä¸‹è½½å¯¹åº”rpmåŒ…ï¼‰`rabbitmq-server-3.8.1-1.el7.noarch.rpm` 3.2å®‰è£…1rpm -ivh erlang-21.3.8.9-1.el7.x86_64.rpm 1rpm -ivh socat-1.7.3.2-1.el6.lux.x86_64.rpm 1rpm -ivh rabbitmq-server-3.8.1-1.el7.noarch.rpm å¯ç”¨ç®¡ç†æ’ä»¶ 1rabbitmq-plugins enable rabbitmq_management å¯åŠ¨RabbitMQ 1234systemctl start rabbitmq-server.servicesystemctl status rabbitmq-server.servicesystemctl restart rabbitmq-server.servicesystemctl stop rabbitmq-server.service æŸ¥çœ‹è¿›ç¨‹ 1ps -ef | grep rabbitmq å¯ç”¨å»¶æ—¶é˜Ÿåˆ—æ’ä»¶ 1rabbitmq-plugins enable rabbitmq_delayed_message_exchange 3.3 æµ‹è¯•o å…³é—­é˜²ç«å¢™ï¼šsystemctl stop firewalld.service o åœ¨webæµè§ˆå™¨ä¸­è¾“å…¥åœ°å€ï¼šhttp://è™šæ‹Ÿæœºip:15672/ o è¾“å…¥é»˜è®¤è´¦å·å¯†ç :guest : guestï¼Œguestç”¨æˆ·é»˜è®¤ä¸å…è®¸è¿œç¨‹è¿æ¥ã€‚ æ·»åŠ ç”¨æˆ· 1rabbitmqctl add_user root root åˆ†é…è§’è‰² 1rabbitmqctl set_user_tags root administrator ä¿®æ”¹å¯†ç  1rabbitmqctl change_password root root æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ· 1rabbitmqctl list_users 3.4å¸è½½12rpm -qa | grep rabbitmqrpm -e rabbitmq-server 4ç®¡ç†ç•Œé¢4.1 æ·»åŠ ç”¨æˆ· è¶…çº§ç®¡ç†å‘˜(administrator) å¯ç™»å½•ç®¡ç†æ§åˆ¶å°ï¼Œå¯æŸ¥çœ‹æ‰€æœ‰çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥å¯¹ç”¨æˆ·ï¼Œç­–ç•¥(policy)è¿›è¡Œæ“ä½œã€‚ ç›‘æ§è€…(monitoring) å¯ç™»å½•ç®¡ç†æ§åˆ¶å°ï¼ŒåŒæ—¶å¯ä»¥æŸ¥çœ‹rabbitmqèŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯(è¿›ç¨‹æ•°ï¼Œå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œç£ç›˜ä½¿ç”¨æƒ…å†µç­‰) ç­–ç•¥åˆ¶å®šè€…(policymaker) å¯ç™»å½•ç®¡ç†æ§åˆ¶å°, åŒæ—¶å¯ä»¥å¯¹policyè¿›è¡Œç®¡ç†ã€‚ä½†æ— æ³•æŸ¥çœ‹èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯(ä¸Šå›¾çº¢æ¡†æ ‡è¯†çš„éƒ¨åˆ†)ã€‚ æ™®é€šç®¡ç†è€…(management) ä»…å¯ç™»å½•ç®¡ç†æ§åˆ¶å°ï¼Œæ— æ³•çœ‹åˆ°èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¹Ÿæ— æ³•å¯¹ç­–ç•¥è¿›è¡Œç®¡ç†ã€‚ å…¶ä»– æ— æ³•ç™»å½•ç®¡ç†æ§åˆ¶å°ï¼Œé€šå¸¸å°±æ˜¯æ™®é€šçš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚ 4.2 åˆ›å»º Virtual Hostsè™šæ‹Ÿä¸»æœºï¼šç±»ä¼¼äºmysqlä¸­çš„databaseã€‚ä»–ä»¬éƒ½æ˜¯ä»¥â€œ/â€å¼€å¤´ äºŒï¼Œäº”ç§æ¶ˆæ¯æ¨¡å‹RabbitMQæä¾›äº†6ç§æ¶ˆæ¯æ¨¡å‹ï¼Œä½†æ˜¯ç¬¬6ç§å…¶å®æ˜¯RPCï¼Œå¹¶ä¸æ˜¯MQï¼Œå› æ­¤ä¸äºˆå­¦ä¹ ã€‚é‚£ä¹ˆä¹Ÿå°±å‰©ä¸‹5ç§ã€‚ä½†æ˜¯å…¶å®3ã€4ã€5è¿™ä¸‰ç§éƒ½å±äºè®¢é˜…æ¨¡å‹ï¼Œåªä¸è¿‡è¿›è¡Œè·¯ç”±çš„æ–¹å¼ä¸åŒã€‚â€‹ å‡†å¤‡ä»£ç ç¯å¢ƒ 12345678910111213141516171819202122232425262728&lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.2.6.RELEASE&lt;/version&gt;&lt;/parent&gt;&lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt;&lt;/properties&gt;&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.commons&lt;/groupId&gt; &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt; &lt;version&gt;3.3.2&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.rabbitmq&lt;/groupId&gt; &lt;artifactId&gt;amqp-client&lt;/artifactId&gt; &lt;version&gt;5.4.3&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; æŠ½å–ä¸€ä¸ªè·å–è¿æ¥çš„å·¥å…·ç±» 1234567891011121314151617181920212223242526272829public class ConnectionUtil &#123; /** * å»ºç«‹ä¸RabbitMQçš„è¿æ¥ * @return * @throws Exception */ public static Connection getConnection() throws Exception &#123; //å®šä¹‰è¿æ¥å·¥å‚ ConnectionFactory factory = new ConnectionFactory(); //è®¾ç½®æœåŠ¡åœ°å€ factory.setHost(&quot;121.199.31.160&quot;); //ç«¯å£ factory.setPort(5672); //è®¾ç½®è´¦å·ä¿¡æ¯ï¼Œç”¨æˆ·åã€å¯†ç ã€vhost factory.setVirtualHost(&quot;/shopping&quot;); factory.setUsername(&quot;root&quot;); factory.setPassword(&quot;root&quot;); // é€šè¿‡å·¥ç¨‹è·å–è¿æ¥ Connection connection = factory.newConnection(); return connection; &#125; public static void main(String[] args) throws Exception &#123; Connection con = ConnectionUtil.getConnection(); System.out.println(con); con.close(); &#125;&#125; 1.åŸºæœ¬æ¶ˆæ¯æ¨¡å‹â€‹ RabbitMQæ˜¯ä¸€ä¸ªæ¶ˆæ¯ä»£ç†ï¼šå®ƒæ¥å—å’Œè½¬å‘æ¶ˆæ¯ã€‚ ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªé‚®å±€ï¼šå½“ä½ æŠŠé‚®ä»¶æ”¾åœ¨é‚®ç®±é‡Œæ—¶ï¼Œä½ å¯ä»¥ç¡®å®šé‚®å·®å…ˆç”Ÿæœ€ç»ˆä¼šæŠŠé‚®ä»¶å‘é€ç»™ä½ çš„æ”¶ä»¶äººã€‚RabbitMQä¸é‚®å±€çš„ä¸»è¦åŒºåˆ«æ˜¯å®ƒä¸å¤„ç†çº¸å¼ ï¼Œè€Œæ˜¯æ¥å—ï¼Œå­˜å‚¨å’Œè½¬å‘æ•°æ®æ¶ˆæ¯çš„äºŒè¿›åˆ¶æ•°æ®å—ã€‚â€‹ 1234567891011121314151617181920212223242526/** * ç”Ÿäº§è€… */public class Send &#123; private final static String QUEUE_NAME = &quot;simple_queue&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // ä»è¿æ¥ä¸­åˆ›å»ºé€šé“ï¼Œä½¿ç”¨é€šé“æ‰èƒ½å®Œæˆæ¶ˆæ¯ç›¸å…³çš„æ“ä½œ Channel channel = connection.createChannel(); // å£°æ˜ï¼ˆåˆ›å»ºï¼‰é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, false, false, false, null); // æ¶ˆæ¯å†…å®¹ String message = &quot;Hello World!&quot;; // å‘æŒ‡å®šçš„é˜Ÿåˆ—ä¸­å‘é€æ¶ˆæ¯ channel.basicPublish(&quot;&quot;, QUEUE_NAME, null, message.getBytes()); System.out.println(&quot; [x] Sent &#x27;&quot; + message + &quot;&#x27;&quot;); //å…³é—­é€šé“å’Œè¿æ¥ channel.close(); connection.close(); &#125;&#125; 12345678910111213141516171819202122232425262728/** * æ¶ˆè´¹è€… */public class Recv &#123; private final static String QUEUE_NAME = &quot;simple_queue&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // åˆ›å»ºé€šé“ Channel channel = connection.createChannel(); // å£°æ˜é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, false, false, false, null); // å®šä¹‰é˜Ÿåˆ—çš„æ¶ˆè´¹è€… DefaultConsumer consumer = new DefaultConsumer(channel) &#123; // è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•ç±»ä¼¼äº‹ä»¶ç›‘å¬ï¼Œå¦‚æœæœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; // body å³æ¶ˆæ¯ä½“ String msg = new String(body); System.out.println(&quot; [x] received : &quot; + msg + &quot;!&quot;); &#125; &#125;; // ç›‘å¬é˜Ÿåˆ—ï¼Œç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦è‡ªåŠ¨è¿›è¡Œæ¶ˆæ¯ç¡®è®¤ã€‚ channel.basicConsume(QUEUE_NAME, true, consumer); &#125;&#125; 1.1 æ¶ˆæ¯ç¡®è®¤æœºåˆ¶-ACKRabbitMQæœ‰ä¸€ä¸ªACKæœºåˆ¶ã€‚å½“æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œä¼šå‘RabbitMQå‘é€å›æ‰§ACKï¼Œå‘ŠçŸ¥æ¶ˆæ¯å·²ç»è¢«æ¥æ”¶ã€‚ä¸è¿‡è¿™ç§å›æ‰§ACKåˆ†ä¸¤ç§æƒ…å†µï¼š è‡ªåŠ¨ACKï¼šæ¶ˆæ¯ä¸€æ—¦è¢«æ¥æ”¶ï¼Œæ¶ˆè´¹è€…è‡ªåŠ¨å‘é€ACK æ‰‹åŠ¨ACKï¼šæ¶ˆæ¯æ¥æ”¶åï¼Œä¸ä¼šå‘é€ACKï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨ é€‰æ‹©å“ªç§è¦çœ‹æ¶ˆæ¯çš„é‡è¦æ€§ï¼š å¦‚æœæ¶ˆæ¯ä¸å¤ªé‡è¦ï¼Œä¸¢å¤±ä¹Ÿæ²¡æœ‰å½±å“ï¼Œé‚£ä¹ˆè‡ªåŠ¨ACKä¼šæ¯”è¾ƒæ–¹ä¾¿ å¦‚æœæ¶ˆæ¯éå¸¸é‡è¦ï¼Œä¸å®¹ä¸¢å¤±ã€‚é‚£ä¹ˆæœ€å¥½åœ¨æ¶ˆè´¹å®Œæˆåæ‰‹åŠ¨ACKï¼Œå¦åˆ™æ¥æ”¶æ¶ˆæ¯åå°±è‡ªåŠ¨ACKï¼ŒRabbitMQå°±ä¼šæŠŠæ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚å¦‚æœæ­¤æ—¶æ¶ˆè´¹è€…å®•æœºï¼Œé‚£ä¹ˆæ¶ˆæ¯å°±ä¸¢å¤±äº† æˆ‘ä»¬ä¹‹å‰çš„æµ‹è¯•éƒ½æ˜¯è‡ªåŠ¨ACKçš„ï¼Œå¦‚æœè¦æ‰‹åŠ¨ACKï¼Œéœ€è¦æ”¹åŠ¨æˆ‘ä»¬çš„ä»£ç ï¼šâ€‹ 12345678910111213141516171819202122232425262728293031/** * æ¶ˆè´¹è€…,æ‰‹åŠ¨è¿›è¡ŒACK */public class Recv2 &#123; private final static String QUEUE_NAME = &quot;simple_queue&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // åˆ›å»ºé€šé“ final Channel channel = connection.createChannel(); // å£°æ˜é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, false, false, false, null); // å®šä¹‰é˜Ÿåˆ—çš„æ¶ˆè´¹è€… DefaultConsumer consumer = new DefaultConsumer(channel) &#123; // è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•ç±»ä¼¼äº‹ä»¶ç›‘å¬ï¼Œå¦‚æœæœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; // body å³æ¶ˆæ¯ä½“ String msg = new String(body); //int i = 1/0 ; System.out.println(&quot; [x] received : &quot; + msg + &quot;!&quot;); // æ‰‹åŠ¨è¿›è¡ŒACK channel.basicAck(envelope.getDeliveryTag(), false); &#125; &#125;; // ç›‘å¬é˜Ÿåˆ—ï¼Œç¬¬äºŒä¸ªå‚æ•°falseï¼Œæ‰‹åŠ¨è¿›è¡ŒACK channel.basicConsume(QUEUE_NAME, false, consumer); &#125;&#125; 2.workæ¶ˆæ¯æ¨¡å‹é¿å…æ‰§è¡Œèµ„æºå¯†é›†å‹ä»»åŠ¡æ—¶ï¼Œå¿…é¡»ç­‰å¾…å®ƒæ‰§è¡Œå®Œæˆã€‚ç›¸åæˆ‘ä»¬ç¨åå®Œæˆä»»åŠ¡ï¼Œæˆ‘ä»¬å°†ä»»åŠ¡å°è£…ä¸ºæ¶ˆæ¯å¹¶å°†å…¶å‘é€åˆ°é˜Ÿåˆ—ã€‚ åœ¨åå°è¿è¡Œçš„å·¥ä½œè¿›ç¨‹å°†è·å–ä»»åŠ¡å¹¶æœ€ç»ˆæ‰§è¡Œä½œä¸šã€‚å½“è¿è¡Œè®¸å¤šæ¶ˆè´¹è€…æ—¶ï¼Œä»»åŠ¡å°†åœ¨ä»–ä»¬ä¹‹é—´å…±äº«ï¼Œä½†æ˜¯ä¸€ä¸ªæ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…è·å–ã€‚â€‹ ä¸€å®šç¨‹åº¦ä¸Šï¼Œé¿å…æ¶ˆæ¯çš„å †ç§¯ã€‚ â€‹ å¹³å‡åˆ†æ‘Šâ€‹ æ¶ˆè´¹è€…2ä¸æ¶ˆè´¹è€…1åŸºæœ¬ç±»ä¼¼ï¼Œå°±æ˜¯æ²¡æœ‰è®¾ç½®æ¶ˆè´¹è€—æ—¶æ—¶é—´ã€‚è¿™é‡Œæ˜¯æ¨¡æ‹Ÿæœ‰äº›æ¶ˆè´¹è€…å¿«ï¼Œæœ‰äº›æ¯”è¾ƒæ…¢ã€‚ æ¥ä¸‹æ¥ï¼Œä¸¤ä¸ªæ¶ˆè´¹è€…ä¸€åŒå¯åŠ¨ï¼Œç„¶åå‘é€50æ¡æ¶ˆæ¯ï¼šå¯ä»¥å‘ç°ï¼Œä¸¤ä¸ªæ¶ˆè´¹è€…å„è‡ªæ¶ˆè´¹äº†25æ¡æ¶ˆæ¯ï¼Œè€Œä¸”å„ä¸ç›¸åŒï¼Œè¿™å°±å®ç°äº†ä»»åŠ¡çš„åˆ†å‘ã€‚ èƒ½è€…å¤šåŠ³ ç°åœ¨çš„çŠ¶æ€å±äºæ˜¯æŠŠä»»åŠ¡å¹³å‡åˆ†é…ï¼Œæ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯æ¶ˆè´¹è¶Šå¿«çš„äººï¼Œæ¶ˆè´¹çš„è¶Šå¤šã€‚æ€ä¹ˆå®ç°å‘¢ï¼Ÿ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨basicQosæ–¹æ³•å’ŒprefetchCount = 1è®¾ç½®ã€‚è¿™å‘Šè¯‰RabbitMQä¸€æ¬¡ä¸è¦å‘å·¥ä½œäººå‘˜å‘é€å¤šäºä¸€æ¡æ¶ˆæ¯ã€‚æˆ–è€…æ¢å¥è¯è¯´ï¼Œä¸è¦å‘å·¥ä½œäººå‘˜å‘é€æ–°æ¶ˆæ¯ï¼Œç›´åˆ°å®ƒå¤„ç†å¹¶ç¡®è®¤äº†å‰ä¸€ä¸ªæ¶ˆæ¯ã€‚ç›¸åï¼Œå®ƒä¼šå°†å…¶åˆ†æ´¾ç»™ä¸æ˜¯ä»ç„¶å¿™ç¢Œçš„ä¸‹ä¸€ä¸ªå·¥ä½œäººå‘˜ã€‚ 12345678910111213141516171819202122232425// ç”Ÿäº§è€…public class Send &#123; private final static String QUEUE_NAME = &quot;test_work_queue&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ Channel channel = connection.createChannel(); // å£°æ˜é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, false, false, false, null); // å¾ªç¯å‘å¸ƒä»»åŠ¡ for (int i = 0; i &lt; 50; i++) &#123; // æ¶ˆæ¯å†…å®¹ String message = &quot;task .. &quot; + i; channel.basicPublish(&quot;&quot;, QUEUE_NAME, null, message.getBytes()); System.out.println(&quot; [x] Sent &#x27;&quot; + message + &quot;&#x27;&quot;); //Thread.sleep(i * 2); &#125; // å…³é—­é€šé“å’Œè¿æ¥ channel.close(); connection.close(); &#125;&#125; 1234567891011121314151617181920212223242526272829303132333435// æ¶ˆè´¹è€…1public class Recv &#123; private final static String QUEUE_NAME = &quot;test_work_queue&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ final Channel channel = connection.createChannel(); // å£°æ˜é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, false, false, false, null); // è®¾ç½®æ¯ä¸ªæ¶ˆè´¹è€…åŒæ—¶åªèƒ½å¤„ç†ä¸€æ¡æ¶ˆæ¯ //channel.basicQos(1); // å®šä¹‰é˜Ÿåˆ—çš„æ¶ˆè´¹è€… DefaultConsumer consumer = new DefaultConsumer(channel) &#123; // è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•ç±»ä¼¼äº‹ä»¶ç›‘å¬ï¼Œå¦‚æœæœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; // body å³æ¶ˆæ¯ä½“ String msg = new String(body); System.out.println(&quot; [æ¶ˆè´¹è€…1] received : &quot; + msg + &quot;!&quot;); try &#123; // æ¨¡æ‹Ÿå®Œæˆä»»åŠ¡çš„è€—æ—¶ï¼š1000ms Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; &#125; // æ‰‹åŠ¨ACK channel.basicAck(envelope.getDeliveryTag(), false); &#125; &#125;; // ç›‘å¬é˜Ÿåˆ—ã€‚ channel.basicConsume(QUEUE_NAME, false, consumer); &#125;&#125; 1234567891011121314151617181920212223242526272829303132333435//æ¶ˆè´¹è€…2public class Recv2 &#123; private final static String QUEUE_NAME = &quot;test_work_queue&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ final Channel channel = connection.createChannel(); // å£°æ˜é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, false, false, false, null); // è®¾ç½®æ¯ä¸ªæ¶ˆè´¹è€…åŒæ—¶åªèƒ½å¤„ç†ä¸€æ¡æ¶ˆæ¯ //channel.basicQos(1); // å®šä¹‰é˜Ÿåˆ—çš„æ¶ˆè´¹è€… DefaultConsumer consumer = new DefaultConsumer(channel) &#123; // è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•ç±»ä¼¼äº‹ä»¶ç›‘å¬ï¼Œå¦‚æœæœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; // body å³æ¶ˆæ¯ä½“ String msg = new String(body); System.out.println(&quot; [æ¶ˆè´¹è€…2] received : &quot; + msg + &quot;!&quot;); try &#123; // æ¨¡æ‹Ÿå®Œæˆä»»åŠ¡çš„è€—æ—¶ï¼š1000ms Thread.sleep(200); &#125; catch (InterruptedException e) &#123; &#125; // æ‰‹åŠ¨ACK channel.basicAck(envelope.getDeliveryTag(), false); &#125; &#125;; // ç›‘å¬é˜Ÿåˆ—ã€‚ channel.basicConsume(QUEUE_NAME, false, consumer); &#125;&#125; 3.è®¢é˜…æ¨¡å‹åˆ†ç±»â€‹ åœ¨ä¹‹å‰çš„æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ã€‚ å·¥ä½œé˜Ÿåˆ—èƒŒåçš„å‡è®¾æ˜¯ï¼šæ¯ä¸ªä»»åŠ¡åªè¢«ä¼ é€’ç»™ä¸€ä¸ªå·¥ä½œäººå‘˜ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åšä¸€äº›å®Œå…¨ä¸åŒçš„äº‹æƒ… - æˆ‘ä»¬å°†ä¼šä¼ é€’ä¸€ä¸ªä¿¡æ¯ç»™å¤šä¸ªæ¶ˆè´¹è€…ã€‚ è¿™ç§æ¨¡å¼è¢«ç§°ä¸ºâ€œå‘å¸ƒ/è®¢é˜…â€ã€‚ 1ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€… æ¯ä¸€ä¸ªæ¶ˆè´¹è€…éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªé˜Ÿåˆ— ç”Ÿäº§è€…æ²¡æœ‰å°†æ¶ˆæ¯ç›´æ¥å‘é€åˆ°é˜Ÿåˆ—ï¼Œè€Œæ˜¯å‘é€åˆ°äº†äº¤æ¢æœº æ¯ä¸ªé˜Ÿåˆ—éƒ½è¦ç»‘å®šåˆ°äº¤æ¢æœº ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œç»è¿‡äº¤æ¢æœºåˆ°è¾¾é˜Ÿåˆ—ï¼Œå®ç°ä¸€ä¸ªæ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…è·å–çš„ç›®çš„ Xï¼ˆExchangesï¼‰ï¼š äº¤æ¢æœºä¸€æ–¹é¢ï¼šæ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ã€‚å¦ä¸€æ–¹é¢ï¼šçŸ¥é“å¦‚ä½•å¤„ç†æ¶ˆæ¯ï¼Œä¾‹å¦‚é€’äº¤ç»™æŸä¸ªç‰¹åˆ«é˜Ÿåˆ—ã€é€’äº¤ç»™æ‰€æœ‰é˜Ÿåˆ—ã€æˆ–æ˜¯å°†æ¶ˆæ¯ä¸¢å¼ƒã€‚åˆ°åº•å¦‚ä½•æ“ä½œï¼Œå–å†³äºExchangeçš„ç±»å‹ã€‚ Exchangeï¼ˆäº¤æ¢æœºï¼‰åªè´Ÿè´£è½¬å‘æ¶ˆæ¯ï¼Œä¸å…·å¤‡å­˜å‚¨æ¶ˆæ¯çš„èƒ½åŠ›ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰ä»»ä½•é˜Ÿåˆ—ä¸Exchangeç»‘å®šï¼Œæˆ–è€…æ²¡æœ‰ç¬¦åˆè·¯ç”±è§„åˆ™çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šä¸¢å¤±ï¼ Exchangeç±»å‹æœ‰ä»¥ä¸‹å‡ ç§ï¼š Fanoutï¼šå¹¿æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šåˆ°äº¤æ¢æœºçš„é˜Ÿåˆ— Directï¼šå®šå‘ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆæŒ‡å®šrouting key çš„é˜Ÿåˆ— Topicï¼šé€šé…ç¬¦ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆrouting patternï¼ˆè·¯ç”±æ¨¡å¼ï¼‰ çš„é˜Ÿåˆ— â€‹ 4.è®¢é˜…æ¨¡å‹-Fanoutä¹Ÿç§°ä¸ºå¹¿æ’­ã€‚åœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å‘é€æµç¨‹æ˜¯è¿™æ ·çš„ï¼š å¯ä»¥æœ‰å¤šä¸ªæ¶ˆè´¹è€… æ¯ä¸ªæ¶ˆè´¹è€…æœ‰è‡ªå·±çš„queueï¼ˆé˜Ÿåˆ—ï¼‰ æ¯ä¸ªé˜Ÿåˆ—éƒ½è¦ç»‘å®šåˆ°Exchangeï¼ˆäº¤æ¢æœºï¼‰ â€‹ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œåªèƒ½å‘é€åˆ°äº¤æ¢æœºï¼Œäº¤æ¢æœºæ¥å†³å®šè¦å‘ç»™å“ªä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…æ— æ³•å†³å®šã€‚ äº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€ç»™ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ— é˜Ÿåˆ—çš„æ¶ˆè´¹è€…éƒ½èƒ½æ‹¿åˆ°æ¶ˆæ¯ã€‚å®ç°ä¸€æ¡æ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ â€‹ 1234567891011121314151617181920212223public class Send &#123; private final static String EXCHANGE_NAME = &quot;fanout_exchange_test&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ Channel channel = connection.createChannel(); // å£°æ˜exchangeï¼ŒæŒ‡å®šç±»å‹ä¸ºfanout channel.exchangeDeclare(EXCHANGE_NAME, &quot;fanout&quot;); // æ¶ˆæ¯å†…å®¹ String message = &quot;Hello everyone&quot;; // å‘å¸ƒæ¶ˆæ¯åˆ°Exchange channel.basicPublish(EXCHANGE_NAME, &quot;&quot;, null, message.getBytes()); System.out.println(&quot; [ç”Ÿäº§è€…] Sent &#x27;&quot; + message + &quot;&#x27;&quot;); channel.close(); connection.close(); &#125;&#125; 1234567891011121314151617181920212223242526272829303132//æ¶ˆè´¹è€…1public class Recv &#123; private final static String QUEUE_NAME = &quot;fanout_exchange_queue_1&quot;; private final static String EXCHANGE_NAME = &quot;fanout_exchange_test&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ Channel channel = connection.createChannel(); // å£°æ˜é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, false, false, false, null); // ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœº channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, &quot;&quot;); // å®šä¹‰é˜Ÿåˆ—çš„æ¶ˆè´¹è€… DefaultConsumer consumer = new DefaultConsumer(channel) &#123; // è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•ç±»ä¼¼äº‹ä»¶ç›‘å¬ï¼Œå¦‚æœæœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; // body å³æ¶ˆæ¯ä½“ String msg = new String(body); System.out.println(&quot; [æ¶ˆè´¹è€…1] received : &quot; + msg + &quot;!&quot;); &#125; &#125;; // ç›‘å¬é˜Ÿåˆ—ï¼Œè‡ªåŠ¨è¿”å›å®Œæˆ channel.basicConsume(QUEUE_NAME, true, consumer); &#125;&#125; 1234567891011121314151617181920212223242526272829303132// æ¶ˆè´¹è€…2public class Recv2 &#123; private final static String QUEUE_NAME = &quot;fanout_exchange_queue_2&quot;; private final static String EXCHANGE_NAME = &quot;fanout_exchange_test&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ Channel channel = connection.createChannel(); // å£°æ˜é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, false, false, false, null); // ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœº channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, &quot;&quot;); // å®šä¹‰é˜Ÿåˆ—çš„æ¶ˆè´¹è€… DefaultConsumer consumer = new DefaultConsumer(channel) &#123; // è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•ç±»ä¼¼äº‹ä»¶ç›‘å¬ï¼Œå¦‚æœæœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; // body å³æ¶ˆæ¯ä½“ String msg = new String(body); System.out.println(&quot; [æ¶ˆè´¹è€…2] received : &quot; + msg + &quot;!&quot;); &#125; &#125;; // ç›‘å¬é˜Ÿåˆ—ï¼Œæ‰‹åŠ¨è¿”å›å®Œæˆ channel.basicConsume(QUEUE_NAME, true, consumer); &#125;&#125; 5.è®¢é˜…æ¨¡å‹-Directâ€‹ åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸åŒçš„æ¶ˆæ¯è¢«ä¸åŒçš„é˜Ÿåˆ—æ¶ˆè´¹ã€‚è¿™æ—¶å°±è¦ç”¨åˆ°Directç±»å‹çš„Exchangeã€‚ åœ¨Directæ¨¡å‹ä¸‹ï¼Œé˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ªRoutingKeyï¼ˆè·¯ç”±keyï¼‰ æ¶ˆæ¯çš„å‘é€æ–¹åœ¨å‘Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„routing keyã€‚ Pï¼šç”Ÿäº§è€…ï¼Œå‘Exchangeå‘é€æ¶ˆæ¯ï¼Œå‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šæŒ‡å®šä¸€ä¸ªrouting keyã€‚ Xï¼šExchangeï¼ˆäº¤æ¢æœºï¼‰ï¼Œæ¥æ”¶ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œç„¶åæŠŠæ¶ˆæ¯é€’äº¤ç»™ ä¸routing keyå®Œå…¨åŒ¹é…çš„é˜Ÿåˆ— C1ï¼šæ¶ˆè´¹è€…ï¼Œå…¶æ‰€åœ¨é˜Ÿåˆ—æŒ‡å®šäº†éœ€è¦routing key ä¸º error çš„æ¶ˆæ¯ C2ï¼šæ¶ˆè´¹è€…ï¼Œå…¶æ‰€åœ¨é˜Ÿåˆ—æŒ‡å®šäº†éœ€è¦routing key ä¸º infoã€errorã€warning çš„æ¶ˆæ¯ æ­¤å¤„æˆ‘ä»¬æ¨¡æ‹Ÿå•†å“çš„å¢åˆ æ”¹ï¼Œå‘é€æ¶ˆæ¯çš„RoutingKeyåˆ†åˆ«æ˜¯ï¼šinsertã€updateã€deleteâ€‹ 1234567891011121314151617181920212223/** * ç”Ÿäº§è€…ï¼Œæ¨¡æ‹Ÿä¸ºå•†å“æœåŠ¡ */public class Send &#123; private final static String EXCHANGE_NAME = &quot;direct_exchange_test&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ Channel channel = connection.createChannel(); // å£°æ˜exchangeï¼ŒæŒ‡å®šç±»å‹ä¸ºdirect channel.exchangeDeclare(EXCHANGE_NAME, &quot;direct&quot;); // æ¶ˆæ¯å†…å®¹ String message = &quot;å•†å“åˆ é™¤äº†ï¼Œ id = 1001&quot;; // å‘é€æ¶ˆæ¯ï¼Œå¹¶ä¸”æŒ‡å®šrouting key ä¸ºï¼šinsert ,ä»£è¡¨æ–°å¢å•†å“ channel.basicPublish(EXCHANGE_NAME, &quot;delete&quot;, null, message.getBytes()); System.out.println(&quot; [å•†å“æœåŠ¡ï¼š] Sent &#x27;&quot; + message + &quot;&#x27;&quot;); channel.close(); connection.close(); &#125;&#125; 12345678910111213141516171819202122232425262728293031323334/** * æ¶ˆè´¹è€…1 */public class Recv &#123; private final static String QUEUE_NAME = &quot;direct_exchange_queue_1&quot;; private final static String EXCHANGE_NAME = &quot;direct_exchange_test&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ Channel channel = connection.createChannel(); // å£°æ˜é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, false, false, false, null); // ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœºï¼ŒåŒæ—¶æŒ‡å®šéœ€è¦è®¢é˜…çš„routing keyã€‚å‡è®¾æ­¤å¤„éœ€è¦updateå’Œdeleteæ¶ˆæ¯ channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, &quot;update&quot;); channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, &quot;delete&quot;); // å®šä¹‰é˜Ÿåˆ—çš„æ¶ˆè´¹è€… DefaultConsumer consumer = new DefaultConsumer(channel) &#123; // è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•ç±»ä¼¼äº‹ä»¶ç›‘å¬ï¼Œå¦‚æœæœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ @Override public void handleDelivery(String consumerTag, Envelope envelope, BasicProperties properties, byte[] body) throws IOException &#123; // body å³æ¶ˆæ¯ä½“ String msg = new String(body); System.out.println(&quot; [æ¶ˆè´¹è€…1] received : &quot; + msg + &quot;!&quot;); &#125; &#125;; // ç›‘å¬é˜Ÿåˆ—ï¼Œè‡ªåŠ¨ACK channel.basicConsume(QUEUE_NAME, true, consumer); &#125;&#125; 1234567891011121314151617181920212223242526272829303132333435/** * æ¶ˆè´¹è€…2 */public class Recv2 &#123; private final static String QUEUE_NAME = &quot;direct_exchange_queue_2&quot;; private final static String EXCHANGE_NAME = &quot;direct_exchange_test&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ Channel channel = connection.createChannel(); // å£°æ˜é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, false, false, false, null); // ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœºï¼ŒåŒæ—¶æŒ‡å®šéœ€è¦è®¢é˜…çš„routing keyã€‚è®¢é˜… insertã€updateã€delete channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, &quot;insert&quot;); channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, &quot;update&quot;); channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, &quot;delete&quot;); // å®šä¹‰é˜Ÿåˆ—çš„æ¶ˆè´¹è€… DefaultConsumer consumer = new DefaultConsumer(channel) &#123; // è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•ç±»ä¼¼äº‹ä»¶ç›‘å¬ï¼Œå¦‚æœæœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ @Override public void handleDelivery(String consumerTag, Envelope envelope, BasicProperties properties, byte[] body) throws IOException &#123; // body å³æ¶ˆæ¯ä½“ String msg = new String(body); System.out.println(&quot; [æ¶ˆè´¹è€…2] received : &quot; + msg + &quot;!&quot;); &#125; &#125;; // ç›‘å¬é˜Ÿåˆ—ï¼Œè‡ªåŠ¨ACK channel.basicConsume(QUEUE_NAME, true, consumer); &#125;&#125; 6.è®¢é˜…æ¨¡å‹-Topic Topicç±»å‹çš„Exchangeä¸Directç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ®RoutingKeyæŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ã€‚åªä¸è¿‡Topicç±»å‹Exchangeå¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®šRouting key çš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ï¼ Routingkey ä¸€èˆ¬éƒ½æ˜¯æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå•è¯ç»„æˆï¼Œå¤šä¸ªå•è¯ä¹‹é—´ä»¥â€.â€åˆ†å‰²ï¼Œä¾‹å¦‚ï¼š item.insert é€šé…ç¬¦è§„åˆ™ï¼š #ï¼šåŒ¹é…0æˆ–å¤šä¸ªè¯ï¼ˆå«é›¶ä¸ªï¼‰â€‹ *ï¼šåŒ¹é…ä¸å¤šä¸å°‘æ°å¥½1ä¸ªè¯ï¼ˆä¸å«é›¶ä¸ªï¼‰ åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†å‘é€æ‰€æœ‰æè¿°åŠ¨ç‰©çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯å°†ä½¿ç”¨ç”±ä¸‰ä¸ªå­—ï¼ˆä¸¤ä¸ªç‚¹ï¼‰ç»„æˆçš„routing keyå‘é€ã€‚è·¯ç”±å…³é”®å­—ä¸­çš„ç¬¬ä¸€ä¸ªå•è¯å°†æè¿°é€Ÿåº¦ï¼Œç¬¬äºŒä¸ªé¢œè‰²å’Œç¬¬ä¸‰ä¸ªç§ç±»ï¼šâ€œ**..**â€ã€‚ æˆ‘ä»¬åˆ›å»ºä¸‰ä¸ªç»‘å®šï¼š Q1ç»‘å®šäº†ç»‘å®šé”®â€œ_ .orange.â€ï¼ŒQ2ç»‘å®šäº†â€œ._.rabbitâ€å’Œâ€œlazy.ï¼ƒâ€ã€‚ Â· Q1åŒ¹é…æ‰€æœ‰çš„æ©™è‰²åŠ¨ç‰©ã€‚ Â· Q2åŒ¹é…å…³äºå…”å­ä»¥åŠæ‡’æƒ°åŠ¨ç‰©çš„æ¶ˆæ¯ã€‚ ç»ƒä¹ ï¼Œç”Ÿäº§è€…å‘é€å¦‚ä¸‹æ¶ˆæ¯ï¼Œä¼šè¿›å…¥é‚£ä¸ªé˜Ÿåˆ—ï¼š quick.orange.rabbit Q1 Q2lazy.orange.elephant Q1 Q2quick.orange.fox Q1lazy.pink.rabbit Q2quick.brown.fox éƒ½ä¸èƒ½quick.orange.male.rabbit éƒ½ä¸èƒ½orange éƒ½ä¸èƒ½ 123456789101112131415161718192021222324/** * ç”Ÿäº§è€…ï¼Œæ¨¡æ‹Ÿä¸ºå•†å“æœåŠ¡ */public class Send &#123; private final static String EXCHANGE_NAME = &quot;topic_exchange_test&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ Channel channel = connection.createChannel(); // å£°æ˜exchangeï¼ŒæŒ‡å®šç±»å‹ä¸ºtopic channel.exchangeDeclare(EXCHANGE_NAME, &quot;topic&quot;,true); // æ¶ˆæ¯å†…å®¹ String message = &quot;æ›´æ–°å•†å“ : id = 1001&quot;; // å‘é€æ¶ˆæ¯ï¼Œå¹¶ä¸”æŒ‡å®šrouting key ä¸ºï¼šinsert ,ä»£è¡¨æ–°å¢å•†å“ channel.basicPublish(EXCHANGE_NAME, &quot;item.update&quot;, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes()); System.out.println(&quot; [å•†å“æœåŠ¡ï¼š] Sent &#x27;&quot; + message + &quot;&#x27;&quot;); channel.close(); connection.close(); &#125;&#125; 12345678910111213141516171819202122232425262728293031323334/** * æ¶ˆè´¹è€…1 */public class Recv &#123; private final static String QUEUE_NAME = &quot;topic_exchange_queue_1&quot;; private final static String EXCHANGE_NAME = &quot;topic_exchange_test&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ Channel channel = connection.createChannel(); // å£°æ˜é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, true, false, false, null); // ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœºï¼ŒåŒæ—¶æŒ‡å®šéœ€è¦è®¢é˜…çš„routing keyã€‚éœ€è¦ updateã€delete channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, &quot;item.update&quot;); channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, &quot;item.delete&quot;); // å®šä¹‰é˜Ÿåˆ—çš„æ¶ˆè´¹è€… DefaultConsumer consumer = new DefaultConsumer(channel) &#123; // è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•ç±»ä¼¼äº‹ä»¶ç›‘å¬ï¼Œå¦‚æœæœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; // body å³æ¶ˆæ¯ä½“ String msg = new String(body); System.out.println(&quot; [æ¶ˆè´¹è€…1] received : &quot; + msg + &quot;!&quot;); &#125; &#125;; // ç›‘å¬é˜Ÿåˆ—ï¼Œè‡ªåŠ¨ACK channel.basicConsume(QUEUE_NAME, true, consumer); &#125;&#125; 123456789101112131415161718192021222324252627282930313233/** * æ¶ˆè´¹è€…2 */public class Recv2 &#123; private final static String QUEUE_NAME = &quot;topic_exchange_queue_2&quot;; private final static String EXCHANGE_NAME = &quot;topic_exchange_test&quot;; public static void main(String[] argv) throws Exception &#123; // è·å–åˆ°è¿æ¥ Connection connection = ConnectionUtil.getConnection(); // è·å–é€šé“ Channel channel = connection.createChannel(); // å£°æ˜é˜Ÿåˆ— channel.queueDeclare(QUEUE_NAME, false, false, false, null); // ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœºï¼ŒåŒæ—¶æŒ‡å®šéœ€è¦è®¢é˜…çš„routing keyã€‚è®¢é˜… insertã€updateã€delete channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, &quot;item.*&quot;); // å®šä¹‰é˜Ÿåˆ—çš„æ¶ˆè´¹è€… DefaultConsumer consumer = new DefaultConsumer(channel) &#123; // è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•ç±»ä¼¼äº‹ä»¶ç›‘å¬ï¼Œå¦‚æœæœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; // body å³æ¶ˆæ¯ä½“ String msg = new String(body); System.out.println(&quot; [æ¶ˆè´¹è€…2] received : &quot; + msg + &quot;!&quot;); &#125; &#125;; // ç›‘å¬é˜Ÿåˆ—ï¼Œè‡ªåŠ¨ACK channel.basicConsume(QUEUE_NAME, true, consumer); &#125;&#125; ä¸‰ï¼Œå¯é æ€§æŠ•é€’ä½¿ç”¨ RabbitMQ å®ç°å¼‚æ­¥é€šä¿¡çš„æ—¶å€™ï¼Œæ¶ˆæ¯ä¸¢äº†æ€ä¹ˆåŠï¼Œæ¶ˆæ¯é‡å¤æ¶ˆè´¹æ€ä¹ˆåŠï¼Ÿ åœ¨ RabbitMQ é‡Œé¢æä¾›äº†å¾ˆå¤šä¿è¯æ¶ˆæ¯å¯é æŠ•é€’çš„æœºåˆ¶ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ RabbitMQ çš„ä¸€ä¸ªç‰¹æ€§ã€‚ é¦–å…ˆè¦æ˜ç¡®ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºæ•ˆç‡ä¸å¯é æ€§æ˜¯æ— æ³•å…¼å¾—çš„ï¼Œå¦‚æœè¦ä¿è¯æ¯ä¸€ä¸ªç¯èŠ‚éƒ½æˆåŠŸï¼ŒåŠ¿å¿…ä¼šå¯¹æ¶ˆæ¯çš„æ”¶å‘æ•ˆç‡é€ æˆå½±å“ã€‚æ‰€ä»¥å¦‚æœæ˜¯ä¸€äº›ä¸šåŠ¡å®æ—¶ä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜çš„åœºåˆï¼Œå¯ä»¥ç‰ºç‰²ä¸€äº›å¯é æ€§æ¥æ¢å–æ•ˆç‡ã€‚æ¯”å¦‚å‘é€é€šçŸ¥æˆ–è€…è®°å½•æ—¥å¿—çš„è¿™ç§åœºæ™¯ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰æ”¶åˆ°é€šçŸ¥ï¼Œä¸ä¼šé€ æˆä¸šåŠ¡å½±å“ï¼Œåªè¦å†æ¬¡å‘é€å°±å¯ä»¥äº†ã€‚ åœ¨æˆ‘ä»¬ä½¿ç”¨ RabbitMQ æ”¶å‘æ¶ˆæ¯çš„æ—¶å€™ï¼Œæœ‰å‡ ä¸ªä¸»è¦ç¯èŠ‚ â‘ ä»£è¡¨æ¶ˆæ¯ä»ç”Ÿäº§è€…å‘é€åˆ° Broker ç”Ÿäº§è€…æŠŠæ¶ˆæ¯å‘åˆ° Broker ä¹‹åï¼Œæ€ä¹ˆçŸ¥é“è‡ªå·±çš„æ¶ˆæ¯æœ‰æ²¡æœ‰è¢« Broker æˆåŠŸæ¥æ”¶ï¼Ÿ â‘¡ä»£è¡¨æ¶ˆæ¯ä» Exchange è·¯ç”±åˆ° Queue Exchange æ˜¯ä¸€ä¸ªç»‘å®šåˆ—è¡¨ï¼Œå¦‚æœæ¶ˆæ¯æ²¡æœ‰åŠæ³•è·¯ç”±åˆ°æ­£ç¡®çš„é˜Ÿåˆ—ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼Ÿåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ â‘¢ä»£è¡¨æ¶ˆæ¯åœ¨ Queue ä¸­å­˜å‚¨ é˜Ÿåˆ—æ˜¯ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„æœåŠ¡ï¼Œæœ‰è‡ªå·±çš„æ•°æ®åº“ï¼ˆMnesiaï¼‰ï¼Œå®ƒæ˜¯çœŸæ­£ç”¨æ¥å­˜å‚¨æ¶ˆæ¯çš„ã€‚å¦‚æœè¿˜æ²¡æœ‰æ¶ˆè´¹è€…æ¥æ¶ˆè´¹ï¼Œé‚£ä¹ˆæ¶ˆæ¯è¦ä¸€ç›´å­˜å‚¨åœ¨é˜Ÿåˆ—é‡Œé¢ã€‚å¦‚æœé˜Ÿåˆ—å‡ºäº†é—®é¢˜ï¼Œæ¶ˆæ¯è‚¯å®šä¼šä¸¢å¤±ã€‚æ€ä¹ˆä¿è¯æ¶ˆæ¯åœ¨é˜Ÿåˆ—ç¨³å®šåœ°å­˜å‚¨å‘¢ï¼Ÿ â‘£ä»£è¡¨æ¶ˆè´¹è€…è®¢é˜… Queue å¹¶æ¶ˆè´¹æ¶ˆæ¯ é˜Ÿåˆ—çš„ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼ŸFIFOã€‚é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯æ˜¯ä¸€æ¡ä¸€æ¡çš„æŠ•é€’çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰ä¸Šä¸€æ¡æ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ¥æ”¶ä»¥åï¼Œæ‰èƒ½æŠŠè¿™ä¸€æ¡æ¶ˆæ¯ä»æ•°æ®åº“åˆ æ‰ï¼Œç»§ç»­æŠ•é€’ä¸‹ä¸€æ¡æ¶ˆæ¯ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒBroker æ€ä¹ˆçŸ¥é“æ¶ˆè´¹è€…å·²ç»æ¥æ”¶äº†æ¶ˆæ¯å‘¢ï¼Ÿ 1.æ¶ˆæ¯å‘é€åˆ°rabbitMQæœåŠ¡å™¨è¿™ä¸ªç¯èŠ‚å¯èƒ½å› ä¸ºç½‘ç»œæˆ–è€… Broker çš„é—®é¢˜å¯¼è‡´æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œç”Ÿäº§è€…ä¸èƒ½ç¡®å®š Broker æœ‰æ²¡æœ‰æ­£ç¡®çš„æ¥æ”¶ã€‚ åœ¨ RabbitMQ é‡Œé¢æä¾›äº†ä¸¤ç§æœºåˆ¶æœåŠ¡ç«¯ç¡®è®¤æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯åœ¨ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ç»™RabbitMQ çš„æœåŠ¡ç«¯çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯ä¼šé€šè¿‡æŸç§æ–¹å¼è¿”å›ä¸€ä¸ªåº”ç­”ï¼Œåªè¦ç”Ÿäº§è€…æ”¶åˆ°äº†è¿™ä¸ªåº”ç­”ï¼Œå°±çŸ¥é“æ¶ˆæ¯å‘é€æˆåŠŸäº†ã€‚ç¬¬ä¸€ç§æ˜¯ Transactionï¼ˆäº‹åŠ¡ï¼‰æ¨¡å¼ï¼Œç¬¬äºŒç§ Confirmï¼ˆç¡®è®¤ï¼‰æ¨¡å¼ã€‚ 1.1 Transactionæ¨¡å¼äº‹åŠ¡æ¨¡å¼æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ æˆ‘ä»¬é€šè¿‡ä¸€ä¸ª channel.txSelect()çš„æ–¹æ³•æŠŠä¿¡é“è®¾ç½®æˆäº‹åŠ¡æ¨¡å¼ï¼Œç„¶åå°±å¯ä»¥å‘å¸ƒæ¶ˆæ¯ç»™ RabbitMQ äº†ï¼Œå¦‚æœ channel.txCommit();çš„æ–¹æ³•è°ƒç”¨æˆåŠŸï¼Œå°±è¯´æ˜äº‹åŠ¡æäº¤æˆåŠŸï¼Œåˆ™æ¶ˆæ¯ä¸€å®šåˆ°è¾¾äº† RabbitMQ ä¸­ã€‚ å¦‚æœåœ¨äº‹åŠ¡æäº¤æ‰§è¡Œä¹‹å‰ç”±äº RabbitMQ å¼‚å¸¸å´©æºƒæˆ–è€…å…¶ä»–åŸå› æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¾¿å¯ä»¥å°†å…¶æ•è·ï¼Œè¿›è€Œé€šè¿‡æ‰§è¡Œ channel.txRollback()æ–¹æ³•æ¥å®ç°äº‹åŠ¡å›æ»šã€‚ åœ¨äº‹åŠ¡æ¨¡å¼é‡Œé¢ï¼Œåªæœ‰æ”¶åˆ°äº†æœåŠ¡ç«¯çš„ Commit-OK çš„æŒ‡ä»¤ï¼Œæ‰èƒ½æäº¤æˆåŠŸã€‚æ‰€ä»¥å¯ä»¥è§£å†³ç”Ÿäº§è€…å’ŒæœåŠ¡ç«¯ç¡®è®¤çš„é—®é¢˜ã€‚ä½†æ˜¯äº‹åŠ¡æ¨¡å¼æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå®ƒæ˜¯é˜»å¡çš„ï¼Œä¸€æ¡æ¶ˆæ¯æ²¡æœ‰å‘é€å®Œæ¯•ï¼Œä¸èƒ½å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œå®ƒä¼šæ¦¨å¹² RabbitMQ æœåŠ¡å™¨çš„æ€§èƒ½ã€‚æ‰€ä»¥ä¸å»ºè®®å¤§å®¶åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚ Spring Boot ä¸­çš„è®¾ç½® 1rabbitTemplate.setChannelTransacted(true); 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455/** * @author yhd * @createtime 2021/1/24 23:29 * rabbitmqäº‹åŠ¡ */@Componentpublic class MqTx &#123; private static final String EXCHANGE = &quot;exchange.tx&quot;; private static final String QUEUE = &quot;queue.tx&quot;; private static final String ROUTING_KEY = &quot;routing.tx&quot;; @Resource private RabbitTemplate rabbitTemplate; public boolean sendMessage() &#123; rabbitTemplate.setChannelTransacted(true); rabbitTemplate.setConfirmCallback((correlationData, flag, cause) -&gt; &#123; if (flag) &#123; System.out.println(&quot;å‘é€æˆåŠŸï¼&quot;); &#125; else &#123; System.out.println(&quot;å‘é€å¤±è´¥&quot; + cause); &#125; &#125;); return true; &#125; @RabbitListener(bindings = @QueueBinding( value = @Queue(value = QUEUE, autoDelete = &quot;false&quot;, durable = &quot;true&quot;), exchange = @Exchange(value = EXCHANGE, autoDelete = &quot;true&quot;, durable = &quot;true&quot;), key = &#123;ROUTING_KEY&#125; ) ) public void receiveMessage(String msg, Message message, Channel channel) &#123; try &#123; channel.txSelect(); System.out.println(&quot;msg = &quot; + msg); channel.basicAck(message.getMessageProperties().getDeliveryTag(), false); channel.txCommit(); &#125; catch (IOException e) &#123; try &#123; channel.txRollback(); &#125; catch (IOException ioException) &#123; ioException.printStackTrace(); &#125; &#125; &#125;&#125; é‚£ä¹ˆæœ‰æ²¡æœ‰å…¶ä»–å¯ä»¥ä¿è¯æ¶ˆæ¯è¢« Broker æ¥æ”¶ï¼Œä½†æ˜¯åˆä¸å¤§é‡æ¶ˆè€—æ€§èƒ½çš„æ–¹å¼å‘¢ï¼Ÿè¿™å°±æ˜¯ç¬¬äºŒç§æ¨¡å¼ï¼Œå«åšç¡®è®¤ï¼ˆConfirmï¼‰æ¨¡å¼ã€‚ 1.2 Confirm ï¼ˆ ç¡®è®¤ ï¼‰æ¨¡å¼ç¡®è®¤æ¨¡å¼æœ‰ä¸‰ç§ï¼Œä¸€ç§æ˜¯æ™®é€šç¡®è®¤æ¨¡å¼ã€‚â€‹ æ™®é€šç¡®è®¤æ¨¡å¼ åœ¨ç”Ÿäº§è€…è¿™è¾¹é€šè¿‡è°ƒç”¨ channel.confirmSelect()æ–¹æ³•å°†ä¿¡é“è®¾ç½®ä¸º Confirm æ¨¡å¼ï¼Œç„¶åå‘é€æ¶ˆæ¯ã€‚ä¸€æ—¦æ¶ˆæ¯è¢«æŠ•é€’åˆ°æ‰€æœ‰åŒ¹é…çš„é˜Ÿåˆ—ä¹‹åï¼ŒRabbitMQ å°±ä¼šå‘é€ä¸€ä¸ªç¡®è®¤ï¼ˆBasic.Ackï¼‰ç»™ç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ channel.waitForConfirms()è¿”å› trueï¼Œè¿™æ ·ç”Ÿäº§è€…å°±çŸ¥é“æ¶ˆæ¯è¢«æœåŠ¡ç«¯æ¥æ”¶äº†ã€‚ æ‰¹é‡ç¡®è®¤ è¿™ç§å‘é€ 1 æ¡ç¡®è®¤ 1 æ¡çš„æ–¹å¼æ¶ˆæ¯è¿˜ä¸æ˜¯å¤ªé«˜ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æœ‰ä¸€ç§æ‰¹é‡ç¡®è®¤çš„æ–¹å¼ã€‚æ‰¹ é‡ ç¡® è®¤ ï¼Œ å°± æ˜¯ åœ¨ å¼€ å¯ Confirm æ¨¡ å¼ å ï¼Œ å…ˆ å‘ é€ ä¸€ æ‰¹ æ¶ˆ æ¯ ã€‚ åª è¦channel.waitForConfirmsOrDie();æ–¹æ³•æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œå°±ä»£è¡¨æ¶ˆæ¯éƒ½è¢«æœåŠ¡ç«¯æ¥æ”¶äº†ã€‚ æ‰¹é‡ç¡®è®¤çš„æ–¹å¼æ¯”å•æ¡ç¡®è®¤çš„æ–¹å¼æ•ˆç‡è¦é«˜ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯æ‰¹é‡çš„æ•°é‡çš„ç¡®å®šã€‚å¯¹äºä¸åŒçš„ä¸šåŠ¡ï¼Œåˆ°åº•å‘é€å¤šå°‘æ¡æ¶ˆæ¯ç¡®è®¤ä¸€æ¬¡ï¼Ÿæ•°é‡å¤ªå°‘ï¼Œæ•ˆç‡æå‡ä¸ä¸Šå»ã€‚æ•°é‡å¤šçš„è¯ï¼Œåˆä¼šå¸¦æ¥å¦ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬å‘ 1000 æ¡æ¶ˆæ¯æ‰ç¡®è®¤ä¸€æ¬¡ï¼Œå¦‚æœå‰é¢ 999 æ¡æ¶ˆæ¯éƒ½è¢«æœåŠ¡ç«¯æ¥æ”¶äº†ï¼Œå¦‚æœç¬¬ 1000 æ¡æ¶ˆæ¯è¢«æ‹’ç»äº†ï¼Œé‚£ä¹ˆå‰é¢æ‰€æœ‰çš„æ¶ˆæ¯éƒ½è¦é‡å‘ã€‚ å¼‚æ­¥ç¡®è®¤ â€‹ æœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥ä¸€è¾¹å‘é€ä¸€è¾¹ç¡®è®¤çš„å‘¢ï¼Ÿè¿™ä¸ªå°±æ˜¯å¼‚æ­¥ç¡®è®¤æ¨¡å¼ã€‚ å¼‚æ­¥ç¡®è®¤æ¨¡å¼éœ€è¦æ·»åŠ ä¸€ä¸ª ConfirmListenerï¼Œå¹¶ä¸”ç”¨ä¸€ä¸ª SortedSet æ¥ç»´æŠ¤æ²¡æœ‰è¢«ç¡®è®¤çš„æ¶ˆæ¯ã€‚ Confirm æ¨¡å¼æ˜¯åœ¨ Channel ä¸Šå¼€å¯çš„ï¼Œå› ä¸º RabbitTemplate å¯¹ Channel è¿›è¡Œäº†å°è£…ï¼Œå«åš ConfimrCallbackã€‚ 123456rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -&gt; &#123; if (!ack) &#123; System.out.println(&quot;å‘é€æ¶ˆæ¯å¤±è´¥ï¼š&quot; + cause); throw new RuntimeException(&quot;å‘é€å¼‚å¸¸ï¼š&quot; + cause); &#125;&#125;); 2. æ¶ˆæ¯ä»äº¤æ¢æœºè·¯ç”±åˆ°é˜Ÿåˆ—åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œæ¶ˆæ¯ä¼šæ— æ³•è·¯ç”±åˆ°æ­£ç¡®çš„é˜Ÿåˆ—ï¼Ÿå¯èƒ½å› ä¸ºè·¯ç”±é”®é”™è¯¯ï¼Œæˆ–è€…é˜Ÿåˆ—ä¸å­˜åœ¨ã€‚ æœ‰ä¸¤ç§æ–¹å¼å¤„ç†æ— æ³•è·¯ç”±çš„æ¶ˆæ¯ï¼Œä¸€ç§å°±æ˜¯è®©æœåŠ¡ç«¯é‡å‘ç»™ç”Ÿäº§è€…ï¼Œä¸€ç§æ˜¯è®©äº¤æ¢æœºè·¯ç”±åˆ°å¦ä¸€ä¸ªå¤‡ä»½çš„äº¤æ¢æœºã€‚ æ¶ˆæ¯å›å‘çš„æ–¹å¼ï¼šä½¿ç”¨ mandatory å‚æ•°å’Œ ReturnListenerï¼ˆåœ¨ Spring AMQP ä¸­æ˜¯ReturnCallbackï¼‰ã€‚ 1234567891011121314rabbitTemplate.setMandatory(true);rabbitTemplate.setReturnCallback((Message message, int replyCode, String replyText, String exchange, String routingKey) -&gt; &#123; // ååºåˆ—åŒ–å¯¹è±¡è¾“å‡º log.info(&quot;æ¶ˆæ¯ä¸»ä½“: &#123;&#125;&quot;, new String(message.getBody())); log.info(&quot;åº”ç­”ç : &#123;&#125;&quot;, replyCode); log.info(&quot;æè¿°ï¼š&#123;&#125;&quot;, replyText); log.info(&quot;æ¶ˆæ¯ä½¿ç”¨çš„äº¤æ¢å™¨ exchange : &#123;&#125;&quot;, exchange); log.info(&quot;æ¶ˆæ¯ä½¿ç”¨çš„è·¯ç”±é”® routing : &#123;&#125;&quot;, routingKey);&#125;); æ¶ˆæ¯è·¯ç”±åˆ°å¤‡ä»½äº¤æ¢æœºçš„æ–¹å¼ï¼šåœ¨åˆ›å»ºäº¤æ¢æœºçš„æ—¶å€™ï¼Œä»å±æ€§ä¸­æŒ‡å®šå¤‡ä»½äº¤æ¢æœºã€‚ 123456789101112131415161718192021222324252627private static final String EXCHANGE_NAME = &quot;amqp.yhd.exchange&quot;;private static final String EXCHANGE_NAME_COPY = &quot;amqp.yhd.exchange.copy&quot;;private static final String QUEUE_NAME = &quot;amqp.yhd.queue&quot;;private static final String ROUTING_KEY = &quot;amqp.admin&quot;;/** * AmqpAdmin * * @param factory * @return */@Beanpublic AmqpAdmin amqpAdmin(ConnectionFactory factory) &#123; RabbitAdmin admin = new RabbitAdmin(factory); //ç»™äº¤æ¢æœºæŒ‡å®šå¤‡ä»½äº¤æ¢æœº Map&lt;String,Object&gt; arguments = new HashMap(); arguments.put(&quot;alternate-exchange&quot;,EXCHANGE_NAME_COPY); //å£°æ˜ä¸€ä¸ªäº¤æ¢æœº äº¤æ¢æœºå æ˜¯å¦æŒä¹…åŒ– æ˜¯å¦è‡ªåŠ¨åˆ é™¤ admin.declareExchange(new DirectExchange(EXCHANGE_NAME, true, false,arguments)); //é˜Ÿåˆ—å æŒä¹…åŒ– æ˜¯å¦æ‰¹å¤„ç† è‡ªåŠ¨åˆ é™¤ admin.declareQueue(new Queue(QUEUE_NAME, true, false, false)); //å£°æ˜ä¸€ä¸ªç»‘å®š é˜Ÿåˆ—å ï¼Œç»‘å®šç±»å‹ï¼Œäº¤æ¢æœºåï¼Œè·¯ç”±é”® å‚æ•° admin.declareBinding(new Binding(QUEUE_NAME, Binding.DestinationType.QUEUE, EXCHANGE_NAME, ROUTING_KEY, null)); return admin;&#125; é˜Ÿåˆ—å¯ä»¥æŒ‡å®šæ­»ä¿¡äº¤æ¢æœºï¼›äº¤æ¢æœºå¯ä»¥æŒ‡å®šå¤‡ä»½äº¤æ¢æœº 3.æ¶ˆæ¯åœ¨é˜Ÿåˆ—å­˜å‚¨å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…çš„è¯ï¼Œé˜Ÿåˆ—ä¸€ç›´å­˜åœ¨åœ¨æ•°æ®åº“ä¸­ã€‚ å¦‚æœ RabbitMQ çš„æœåŠ¡æˆ–è€…ç¡¬ä»¶å‘ç”Ÿæ•…éšœï¼Œæ¯”å¦‚ç³»ç»Ÿå®•æœºã€é‡å¯ã€å…³é—­ç­‰ç­‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸­çš„æ¶ˆæ¯ä¸¢å¤±ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠæ¶ˆæ¯æœ¬èº«å’Œå…ƒæ•°æ®ï¼ˆé˜Ÿåˆ—ã€äº¤æ¢æœºã€ç»‘å®šï¼‰éƒ½ä¿å­˜åˆ°ç£ç›˜ã€‚ è§£å†³æ–¹æ¡ˆé˜Ÿåˆ—æŒä¹…åŒ–+äº¤æ¢æœºæŒä¹…åŒ–+æ¶ˆæ¯æŒä¹…åŒ– 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849@Slf4j@Componentpublic class MQProducerAckTest &#123; @Autowired private RabbitTemplate rabbitTemplate; private static final String EXCHANGE = &quot;exchange.confirm&quot;; private static final String QUEUE = &quot;queue.confirm&quot;; private static final String ROUTING_KEY = &quot;routing.confirm&quot;; @Bean public AmqpAdmin amqpAdmin(ConnectionFactory factory) &#123; RabbitAdmin admin = new RabbitAdmin(factory); //å£°æ˜ä¸€ä¸ªäº¤æ¢æœº äº¤æ¢æœºå æ˜¯å¦æŒä¹…åŒ– æ˜¯å¦è‡ªåŠ¨åˆ é™¤ admin.declareExchange(new DirectExchange(EXCHANGE, true, false, null)); //é˜Ÿåˆ—å æŒä¹…åŒ– æ˜¯å¦æ‰¹å¤„ç† è‡ªåŠ¨åˆ é™¤ admin.declareQueue(new org.springframework.amqp.core.Queue(QUEUE, true, false, false)); //å£°æ˜ä¸€ä¸ªç»‘å®š é˜Ÿåˆ—å ï¼Œç»‘å®šç±»å‹ï¼Œäº¤æ¢æœºåï¼Œè·¯ç”±é”® å‚æ•° admin.declareBinding(new Binding(QUEUE, Binding.DestinationType.QUEUE, EXCHANGE, ROUTING_KEY, null)); return admin; &#125; /** * å‘é€æ¶ˆæ¯ * * @param exchange äº¤æ¢æœº * @param routingKey è·¯ç”±é”® * @param message æ¶ˆæ¯ */ public boolean sendMessage(String exchange, String routingKey, String message) &#123; MessageProperties messageProperties = new MessageProperties(); messageProperties.setDeliveryMode(MessageDeliveryMode.PERSISTENT); Message msg = new Message(message.getBytes(), messageProperties); rabbitTemplate.convertAndSend(exchange, routingKey, msg); return true; &#125; @SneakyThrows @RabbitListener(bindings = @QueueBinding( value = @Queue(value = QUEUE, autoDelete = &quot;false&quot;, durable = &quot;true&quot;), exchange = @Exchange(value = EXCHANGE, autoDelete = &quot;true&quot;, durable = &quot;true&quot;), key = &#123;ROUTING_KEY&#125;)) public void process(Message message, Channel channel) &#123; log.info(&quot;RabbitListener:&#123;&#125;&quot;, new String(message.getBody())); channel.basicAck(message.getMessageProperties().getDeliveryTag(), false); &#125;&#125; é›†ç¾¤ å¦‚æœåªæœ‰ä¸€ä¸ª RabbitMQ çš„èŠ‚ç‚¹ï¼Œå³ä½¿äº¤æ¢æœºã€é˜Ÿåˆ—ã€æ¶ˆæ¯åšäº†æŒä¹…åŒ–ï¼Œå¦‚æœæœåŠ¡å´©æºƒæˆ–è€…ç¡¬ä»¶å‘ç”Ÿæ•…éšœï¼ŒRabbitMQ çš„æœåŠ¡ä¸€æ ·æ˜¯ä¸å¯ç”¨çš„ï¼Œæ‰€ä»¥ä¸ºäº†æé«˜ MQ æœåŠ¡çš„å¯ç”¨æ€§ï¼Œä¿éšœæ¶ˆæ¯çš„ä¼ è¾“ï¼Œæˆ‘ä»¬éœ€è¦æœ‰å¤šä¸ª RabbitMQ çš„èŠ‚ç‚¹ã€‚ 4.æ¶ˆæ¯æŠ•é€’åˆ°æ¶ˆè´¹è€…å¦‚æœæ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯åæ²¡æ¥å¾—åŠå¤„ç†å³å‘ç”Ÿå¼‚å¸¸ï¼Œæˆ–è€…å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œä¼šå¯¼è‡´æ¥æ”¶æ¶ˆæ¯å¤±è´¥ã€‚æœåŠ¡ç«¯åº”è¯¥ä»¥æŸç§æ–¹å¼å¾—çŸ¥æ¶ˆè´¹è€…å¯¹æ¶ˆæ¯çš„æ¥æ”¶æƒ…å†µï¼Œå¹¶å†³å®šæ˜¯å¦é‡æ–°æŠ•é€’è¿™æ¡æ¶ˆæ¯ç»™å…¶ä»–æ¶ˆè´¹è€…ã€‚RabbitMQ æä¾›äº†æ¶ˆè´¹è€…çš„æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆmessage acknowledgementï¼‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥è‡ªåŠ¨æˆ–è€…æ‰‹åŠ¨åœ°å‘é€ ACK ç»™æœåŠ¡ç«¯ã€‚ æ²¡æœ‰æ”¶åˆ° ACK çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ–­å¼€è¿æ¥åï¼ŒRabbitMQ ä¼šæŠŠè¿™æ¡æ¶ˆæ¯å‘é€ç»™å…¶ä»–æ¶ˆè´¹è€…ã€‚å¦‚æœæ²¡æœ‰å…¶ä»–æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…é‡å¯åä¼šé‡æ–°æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯ï¼Œé‡å¤æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚ æ¶ˆè´¹è€…åœ¨è®¢é˜…é˜Ÿåˆ—æ—¶ï¼Œå¯ä»¥æŒ‡å®šautoAckå‚æ•°ï¼Œå½“autoAckç­‰äºfalseæ—¶ï¼ŒRabbitMQä¼šç­‰å¾…æ¶ˆè´¹è€…æ˜¾å¼åœ°å›å¤ç¡®è®¤ä¿¡å·åæ‰ä»é˜Ÿåˆ—ä¸­ç§»å»æ¶ˆæ¯ã€‚ å¦‚ä½•è®¾ç½®æ‰‹åŠ¨ ACKï¼Ÿ SimpleRabbitListenerContainer æˆ–è€… SimpleRabbitListenerContainerFactory 1factory.setAcknowledgeMode(AcknowledgeMode.MANUAL); application.properties 12spring.rabbitmq.listener.direct.acknowledge-mode=manualspring.rabbitmq.listener.simple.acknowledge-mode=manual æ³¨æ„è¿™ä¸‰ä¸ªå€¼çš„åŒºåˆ«ï¼šNONEï¼šè‡ªåŠ¨ ACKï¼ŒMANUALï¼š æ‰‹åŠ¨ ACKï¼ŒAUTOï¼šå¦‚æœæ–¹æ³•æœªæŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™å‘é€ ackã€‚ å½“æŠ›å‡º AmqpRejectAndDontRequeueException å¼‚å¸¸çš„æ—¶å€™ï¼Œåˆ™æ¶ˆæ¯ä¼šè¢«æ‹’ç»ï¼Œä¸”ä¸é‡æ–°å…¥é˜Ÿã€‚å½“æŠ›å‡º ImmediateAcknowledgeAmqpException å¼‚å¸¸ï¼Œåˆ™æ¶ˆè´¹è€…ä¼šå‘é€ ACKã€‚å…¶ä»–çš„å¼‚å¸¸ï¼Œåˆ™æ¶ˆæ¯ä¼šè¢«æ‹’ç»ï¼Œä¸” requeue = true ä¼šé‡æ–°å…¥é˜Ÿã€‚ åœ¨ Spring Boot ä¸­ï¼Œæ¶ˆè´¹è€…åˆæ€ä¹ˆè°ƒç”¨ ACKï¼Œæˆ–è€…è¯´æ€ä¹ˆè·å¾— Channel å‚æ•°å‘¢ï¼Ÿ 123456789@SneakyThrows@RabbitListener(bindings = @QueueBinding( value = @Queue(value = QUEUE, autoDelete = &quot;false&quot;, durable = &quot;true&quot;), exchange = @Exchange(value = EXCHANGE, autoDelete = &quot;true&quot;, durable = &quot;true&quot;), key = &#123;ROUTING_KEY&#125;))public void process(Message message, Channel channel) &#123; log.info(&quot;RabbitListener:&#123;&#125;&quot;, new String(message.getBody())); channel.basicAck(message.getMessageProperties().getDeliveryTag(), false);&#125; å¦‚æœæ¶ˆæ¯æ— æ³•å¤„ç†æˆ–è€…æ¶ˆè´¹å¤±è´¥ï¼Œä¹Ÿæœ‰ä¸¤ç§æ‹’ç»çš„æ–¹å¼ï¼ŒBasic.Reject()æ‹’ç»å•æ¡ï¼ŒBasic.Nack()æ‰¹é‡æ‹’ç»ã€‚å¦‚æœ requeue å‚æ•°è®¾ç½®ä¸º trueï¼Œå¯ä»¥æŠŠè¿™æ¡æ¶ˆæ¯é‡æ–°å­˜å…¥é˜Ÿåˆ—ï¼Œä»¥ä¾¿å‘ç»™ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆå½“ç„¶ï¼Œåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…çš„æ—¶å€™ï¼Œè¿™ç§æ–¹å¼å¯èƒ½ä¼šå‡ºç°æ— é™å¾ªç¯é‡å¤æ¶ˆè´¹çš„æƒ…å†µã€‚å¯ä»¥æŠ•é€’åˆ°æ–°çš„é˜Ÿåˆ—ä¸­ï¼Œæˆ–è€…åªæ‰“å°å¼‚å¸¸æ—¥å¿—ï¼‰ã€‚ æœåŠ¡ç«¯æ”¶åˆ°äº† ACK æˆ–è€… NACKï¼Œå³ä½¿æ¶ˆè´¹è€…æ²¡æœ‰æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œæˆ–è€…æ¶ˆè´¹æ—¶å‡ºç°å¼‚å¸¸ï¼Œç”Ÿäº§è€…ä¹Ÿæ˜¯å®Œå…¨ä¸çŸ¥æƒ…çš„ã€‚ 5.æ¶ˆè´¹è€…å›è°ƒ è°ƒç”¨ç”Ÿäº§è€… API å‘é€å“åº”æ¶ˆæ¯ç»™ç”Ÿäº§è€… 6.è¡¥å¿æœºåˆ¶å¦‚æœç”Ÿäº§è€…çš„ API å°±æ˜¯æ²¡æœ‰è¢«è°ƒç”¨ï¼Œä¹Ÿæ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…çš„å“åº”æ¶ˆæ¯ï¼Œæ€ä¹ˆåŠï¼Ÿ å¯èƒ½æ˜¯æ¶ˆè´¹è€…å¤„ç†æ—¶é—´å¤ªé•¿æˆ–è€…ç½‘ç»œè¶…æ—¶ã€‚ ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¹‹é—´åº”è¯¥çº¦å®šä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œæ¯”å¦‚ 5 åˆ†é’Ÿï¼Œå¯¹äºè¶…å‡ºè¿™ä¸ªæ—¶é—´æ²¡æœ‰å¾—åˆ°å“åº”çš„æ¶ˆæ¯ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªå®šæ—¶é‡å‘çš„æœºåˆ¶ï¼Œä½†è¦å‘é€é—´éš”å’Œæ§åˆ¶æ¬¡æ•°ï¼Œæ¯”å¦‚æ¯éš” 2åˆ†é’Ÿå‘é€ä¸€æ¬¡ï¼Œæœ€å¤šé‡å‘ 3 æ¬¡ï¼Œå¦åˆ™ä¼šé€ æˆæ¶ˆæ¯å †ç§¯ã€‚ é‡å‘å¯ä»¥é€šè¿‡ï¼ˆæœ¬åœ°æ¶ˆæ¯è¡¨ï¼‰æ¶ˆæ¯è½åº“+ï¼ˆå¼‚æ­¥ï¼‰å®šæ—¶ä»»åŠ¡æ¥å®ç°ã€‚ 7.æ¶ˆæ¯å¹‚ç­‰æ€§å¦‚æœæ¶ˆè´¹è€…æ¯ä¸€æ¬¡æ¥æ”¶ç”Ÿäº§è€…çš„æ¶ˆæ¯éƒ½æˆåŠŸäº†ï¼Œåªæ˜¯åœ¨å“åº”æˆ–è€…è°ƒç”¨ API çš„æ—¶å€™å‡ºäº†é—®é¢˜ï¼Œä¼šä¸ä¼šå‡ºç°æ¶ˆæ¯çš„é‡å¤å¤„ç†ï¼Ÿ ä¸ºäº†é¿å…ç›¸åŒæ¶ˆæ¯çš„é‡å¤å¤„ç†ï¼Œå¿…é¡»è¦é‡‡å–ä¸€å®šçš„æªæ–½ã€‚RabbitMQ æœåŠ¡ç«¯æ˜¯æ²¡æœ‰è¿™ç§æ§åˆ¶çš„ï¼ˆåŒä¸€æ‰¹çš„æ¶ˆæ¯æœ‰ä¸ªé€’å¢çš„ DeliveryTagï¼‰ï¼Œå®ƒä¸çŸ¥é“ä½ æ˜¯ä¸æ˜¯å°±è¦æŠŠä¸€æ¡æ¶ˆæ¯å‘é€ä¸¤æ¬¡ï¼Œåªèƒ½åœ¨æ¶ˆè´¹ç«¯æ§åˆ¶ã€‚ å¯¼è‡´æ¶ˆæ¯çš„é‡å¤æ¶ˆè´¹çš„åŸå› ï¼š ç”Ÿäº§è€…çš„é—®é¢˜ï¼Œç¯èŠ‚â‘ é‡å¤å‘é€æ¶ˆæ¯ï¼Œæ¯”å¦‚åœ¨å¼€å¯äº† Confirm æ¨¡å¼ä½†æœªæ”¶åˆ°ç¡®è®¤ï¼Œæ¶ˆè´¹è€…é‡å¤æŠ•é€’ã€‚ ç¯èŠ‚â‘£å‡ºäº†é—®é¢˜ï¼Œç”±äºæ¶ˆè´¹è€…æœªå‘é€ ACK æˆ–è€…å…¶ä»–åŸå› ï¼Œæ¶ˆæ¯é‡å¤æŠ•é€’ã€‚ ç”Ÿäº§è€…ä»£ç æˆ–è€…ç½‘ç»œé—®é¢˜ã€‚ å¯¹äºé‡å¤å‘é€çš„æ¶ˆæ¯ï¼Œå¯ä»¥å¯¹æ¯ä¸€æ¡æ¶ˆæ¯ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ä¸šåŠ¡ IDï¼Œé€šè¿‡æ—¥å¿—æˆ–è€…æ¶ˆæ¯è½åº“æ¥åšé‡å¤æ§åˆ¶ã€‚ 8.æœ€ç»ˆä¸€è‡´æ€§å¦‚æœç¡®å®æ˜¯æ¶ˆè´¹è€…å®•æœºäº†ï¼Œæˆ–è€…ä»£ç å‡ºç°äº† BUG å¯¼è‡´æ— æ³•æ­£å¸¸æ¶ˆè´¹ï¼Œåœ¨æˆ‘ä»¬å°è¯•å¤šæ¬¡é‡å‘ä»¥åï¼Œæ¶ˆæ¯æœ€ç»ˆä¹Ÿæ²¡æœ‰å¾—åˆ°å¤„ç†ï¼Œæ€ä¹ˆåŠï¼Ÿæ‰‹åŠ¨å¤„ç†ã€‚ 9.æ¶ˆæ¯çš„é¡ºåºæ€§æ¶ˆæ¯çš„é¡ºåºæ€§æŒ‡çš„æ˜¯æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯çš„é¡ºåºè·Ÿç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚ æ¯”å¦‚ï¼š1ã€å‘è¡¨å¾®åšï¼›2ã€å‘è¡¨è¯„è®ºï¼›3ã€åˆ é™¤å¾®åšã€‚é¡ºåºä¸èƒ½é¢ å€’ã€‚ åœ¨ RabbitMQ ä¸­ï¼Œä¸€ä¸ªé˜Ÿåˆ—æœ‰å¤šä¸ªæ¶ˆè´¹è€…æ—¶ï¼Œç”±äºä¸åŒçš„æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯çš„é€Ÿåº¦æ˜¯ä¸ä¸€æ ·çš„ï¼Œé¡ºåºæ— æ³•ä¿è¯ã€‚åªæœ‰ä¸€ä¸ªé˜Ÿåˆ—ä»…æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…çš„æƒ…å†µæ‰èƒ½ä¿è¯é¡ºåºæ¶ˆè´¹ï¼ˆä¸åŒçš„ä¸šåŠ¡æ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„ä¸“ç”¨çš„é˜Ÿåˆ—ï¼‰ã€‚â€‹ 10.ä»£ç 123456789101112spring.rabbitmq.host=121.199.31.160spring.rabbitmq.port=5672spring.rabbitmq.username=rootspring.rabbitmq.password=root#äº¤æ¢æœºç¡®è®¤spring.rabbitmq.publisher-confirms=true#é˜Ÿåˆ—ç¡®è®¤spring.rabbitmq.publisher-returns=true#é»˜è®¤æƒ…å†µä¸‹æ¶ˆæ¯æ¶ˆè´¹è€…æ˜¯è‡ªåŠ¨ç¡®è®¤æ¶ˆæ¯çš„ï¼Œå¦‚æœè¦æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯åˆ™éœ€è¦ä¿®æ”¹ç¡®è®¤æ¨¡å¼ä¸ºmanualspring.rabbitmq.listener.simple.cknowledge-mode=manual# æ¶ˆè´¹è€…æ¯æ¬¡ä»é˜Ÿåˆ—è·å–çš„æ¶ˆæ¯æ•°é‡ã€‚æ­¤å±æ€§å½“ä¸è®¾ç½®æ—¶ä¸ºï¼šè½®è¯¢åˆ†å‘ï¼Œè®¾ç½®ä¸º1ä¸ºï¼šå…¬å¹³åˆ†å‘spring.rabbitmq.listener.simple.prefetch=1 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950/** * @author yhd * @createtime 2021/1/23 1:38 * @description æ¶ˆæ¯å‘é€ç¡®è®¤ * å…³äºå®ç°çš„è¿™ä¸¤ä¸ªç±»ï¼š * ConfirmCallbackï¼šåªç¡®è®¤æ¶ˆæ¯æ˜¯å¦æ­£ç¡®åˆ°è¾¾Exchangeä¸­ * 1.å¦‚æœæ¶ˆæ¯æ²¡æœ‰åˆ°exchange,åˆ™confirmå›è°ƒ,ack=false * 2.å¦‚æœæ¶ˆæ¯åˆ°è¾¾exchange,åˆ™confirmå›è°ƒ,ack=true * ReturnCallbackï¼šæ¶ˆæ¯æ²¡æœ‰æ­£ç¡®åˆ°è¾¾é˜Ÿåˆ—æ—¶è§¦å‘å›è°ƒï¼Œå¦‚æœæ­£ç¡®åˆ°è¾¾é˜Ÿåˆ—ä¸æ‰§è¡Œ * 1.exchangeåˆ°queueæˆåŠŸ,åˆ™ä¸å›è°ƒreturn * 2.exchangeåˆ°queueå¤±è´¥,åˆ™å›è°ƒreturn */@Component@Slf4jpublic class MQProducerAckConfig implements RabbitTemplate.ConfirmCallback, RabbitTemplate.ReturnCallback&#123; @Resource private RabbitTemplate rabbitTemplate; /** * ä¿®é¥°ä¸€ä¸ªéé™æ€çš„voidï¼ˆï¼‰æ–¹æ³•,åœ¨æœåŠ¡å™¨åŠ è½½Servletçš„æ—¶å€™è¿è¡Œï¼Œ * å¹¶ä¸”åªä¼šè¢«æœåŠ¡å™¨æ‰§è¡Œä¸€æ¬¡ã€‚ * åœ¨æ„é€ å‡½æ•°ä¹‹åæ‰§è¡Œï¼Œinitï¼ˆï¼‰æ–¹æ³•ä¹‹å‰æ‰§è¡Œã€‚ */ @PostConstruct public void init() &#123; rabbitTemplate.setConfirmCallback(this); //æŒ‡å®š ConfirmCallback rabbitTemplate.setReturnCallback(this); //æŒ‡å®š ReturnCallback &#125; @Override public void confirm(CorrelationData correlationData, boolean ack, String cause) &#123; if (ack) &#123; log.info(&quot;æ¶ˆæ¯å‘é€æˆåŠŸï¼š&quot; + GsonUtil.toJson(correlationData)); &#125; else &#123; log.info(&quot;æ¶ˆæ¯å‘é€å¤±è´¥ï¼š&quot; + cause + &quot; æ•°æ®ï¼š&quot; + GsonUtil.toJson(correlationData)); &#125; &#125; @Override public void returnedMessage(Message message, int replyCode, String replyText, String exchange, String routingKey) &#123; // ååºåˆ—åŒ–å¯¹è±¡è¾“å‡º log.info(&quot;æ¶ˆæ¯ä¸»ä½“: &#123;&#125;&quot;,new String(message.getBody())); log.info(&quot;åº”ç­”ç : &#123;&#125;&quot;,replyCode); log.info(&quot;æè¿°ï¼š&#123;&#125;&quot;,replyText); log.info(&quot;æ¶ˆæ¯ä½¿ç”¨çš„äº¤æ¢å™¨ exchange : &#123;&#125;&quot;,exchange); log.info(&quot;æ¶ˆæ¯ä½¿ç”¨çš„è·¯ç”±é”® routing : &#123;&#125;&quot;,routingKey); &#125;&#125; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859/** * @author yhd * @createtime 2021/1/23 1:59 * æµ‹è¯•æ¶ˆæ¯å‘é€ç¡®è®¤ */@Slf4j@Componentpublic class MQProducerAckTest &#123; @Autowired private RabbitTemplate rabbitTemplate; private static final String EXCHANGE = &quot;exchange.confirm&quot;; private static final String QUEUE = &quot;queue.confirm&quot;; private static final String ROUTING_KEY = &quot;routing.confirm&quot;; /** * å‘é€æ¶ˆæ¯ * * @param exchange äº¤æ¢æœº * @param routingKey è·¯ç”±é”® * @param message æ¶ˆæ¯ */ public boolean sendMessage(String exchange, String routingKey, Object message) &#123; rabbitTemplate.convertAndSend(exchange, routingKey, message); return true; &#125; //æ¥æ”¶æ¶ˆæ¯ @SneakyThrows @RabbitListener(bindings = @QueueBinding( value = @Queue(value = QUEUE, autoDelete = &quot;false&quot;), exchange = @Exchange(value = EXCHANGE, autoDelete = &quot;true&quot;), key = &#123;ROUTING_KEY&#125;)) public void process(Message message, Channel channel) &#123; log.info(&quot;RabbitListener:&#123;&#125;&quot;, new String(message.getBody())); // é‡‡ç”¨æ‰‹åŠ¨åº”ç­”æ¨¡å¼, æ‰‹åŠ¨ç¡®è®¤åº”ç­”æ›´ä¸ºå®‰å…¨ç¨³å®š //å¦‚æœæ‰‹åŠ¨ç¡®å®šäº†ï¼Œå†å‡ºå¼‚å¸¸ï¼Œmqä¸ä¼šé€šçŸ¥ï¼›å¦‚æœæ²¡æœ‰æ‰‹åŠ¨ç¡®è®¤ï¼ŒæŠ›å¼‚å¸¸mqä¼šä¸€ç›´é€šçŸ¥ try &#123; int i = 1 / 0; // false ç¡®è®¤ä¸€ä¸ªæ¶ˆæ¯ï¼Œtrue æ‰¹é‡ç¡®è®¤ channel.basicAck(message.getMessageProperties().getDeliveryTag(), false); &#125; catch (Exception e) &#123; // æ¶ˆæ¯æ˜¯å¦å†æ¬¡è¢«æ‹’ç»ï¼ System.out.println(&quot;come on!&quot;); // getRedelivered() åˆ¤æ–­æ˜¯å¦å·²ç»å¤„ç†è¿‡ä¸€æ¬¡æ¶ˆæ¯ï¼ if (message.getMessageProperties().getRedelivered()) &#123; System.out.println(&quot;æ¶ˆæ¯å·²é‡å¤å¤„ç†,æ‹’ç»å†æ¬¡æ¥æ”¶&quot;); // æ‹’ç»æ¶ˆæ¯ï¼Œrequeue=false è¡¨ç¤ºä¸å†é‡æ–°å…¥é˜Ÿï¼Œå¦‚æœé…ç½®äº†æ­»ä¿¡é˜Ÿåˆ—åˆ™è¿›å…¥æ­»ä¿¡é˜Ÿåˆ— channel.basicReject(message.getMessageProperties().getDeliveryTag(), false); &#125; else &#123; System.out.println(&quot;æ¶ˆæ¯å³å°†å†æ¬¡è¿”å›é˜Ÿåˆ—å¤„ç†&quot;); // å‚æ•°äºŒï¼šæ˜¯å¦æ‰¹é‡ï¼Œ å‚æ•°ä¸‰ï¼šä¸ºæ˜¯å¦é‡æ–°å›åˆ°é˜Ÿåˆ—ï¼Œtrueé‡æ–°å…¥é˜Ÿ channel.basicNack(message.getMessageProperties().getDeliveryTag(), false, true); &#125; &#125; &#125;&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263/** * @author yhd * @createtime 2021/1/24 23:29 * rabbitmqäº‹åŠ¡ */@Componentpublic class MqTx &#123; private static final String EXCHANGE = &quot;exchange.tx&quot;; private static final String QUEUE = &quot;queue.tx&quot;; private static final String ROUTING_KEY = &quot;routing.tx&quot;; @Resource private RabbitTemplate rabbitTemplate; @Resource private TransactionTemplate transactionTemplate; public boolean sendMessage() &#123; rabbitTemplate.setConfirmCallback((correlationData, flag, cause) -&gt; &#123; if (flag) &#123; System.out.println(&quot;å‘é€æˆåŠŸï¼&quot;); &#125; else &#123; System.out.println(&quot;å‘é€å¤±è´¥&quot; + cause); &#125; &#125;); rabbitTemplate.setReturnCallback((RabbitTemplate.ReturnsCallback) returnedMessage -&gt; &#123; &#125;); transactionTemplate.execute(transactionStatus -&gt; &#123; rabbitTemplate.convertAndSend(EXCHANGE, ROUTING_KEY, &quot;rabbitmq-tx&quot;); return rabbitTemplate.receiveAndConvert(); &#125;); return true; &#125; @RabbitListener(bindings = @QueueBinding( value = @Queue(value = QUEUE, autoDelete = &quot;false&quot;, durable = &quot;true&quot;), exchange = @Exchange(value = EXCHANGE, autoDelete = &quot;true&quot;, durable = &quot;true&quot;), key = &#123;ROUTING_KEY&#125; ) ) public void receiveMessage(String msg, Message message, Channel channel) &#123; try &#123; channel.txSelect(); System.out.println(&quot;msg = &quot; + msg); channel.basicAck(message.getMessageProperties().getDeliveryTag(), false); channel.txCommit(); &#125; catch (IOException e) &#123; try &#123; channel.txRollback(); &#125; catch (IOException ioException) &#123; ioException.printStackTrace(); &#125; &#125; &#125;&#125; å››ï¼Œæ¶ˆæ¯æµæ§1.æœåŠ¡ç«¯æµæ§å½“ç”Ÿäº§ MQ æ¶ˆæ¯çš„é€Ÿåº¦è¿œå¤§äºæ¶ˆè´¹æ¶ˆæ¯çš„é€Ÿåº¦æ—¶ï¼Œä¼šäº§ç”Ÿå¤§é‡çš„æ¶ˆæ¯å †ç§¯ï¼Œå ç”¨ç³»ç»Ÿèµ„æºï¼Œå¯¼è‡´æœºå™¨çš„æ€§èƒ½ä¸‹é™ã€‚æˆ‘ä»¬æƒ³è¦æ§åˆ¶æœåŠ¡ç«¯æ¥æ”¶çš„æ¶ˆæ¯çš„æ•°é‡ï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ 1.1è®¾ç½®é˜Ÿåˆ—é•¿åº¦é˜Ÿåˆ—æœ‰ä¸¤ä¸ªæ§åˆ¶é•¿åº¦çš„å±æ€§ 12x-max-lengthï¼šé˜Ÿåˆ—ä¸­æœ€å¤§å­˜å‚¨æœ€å¤§æ¶ˆæ¯æ•°ï¼Œè¶…è¿‡è¿™ä¸ªæ•°é‡ï¼Œé˜Ÿå¤´çš„æ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒã€‚x-max-length-bytesï¼šé˜Ÿåˆ—ä¸­å­˜å‚¨çš„æœ€å¤§æ¶ˆæ¯å®¹é‡ï¼ˆå•ä½ bytesï¼‰ï¼Œè¶…è¿‡è¿™ä¸ªå®¹é‡ï¼Œé˜Ÿå¤´çš„æ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒã€‚ è®¾ç½®é˜Ÿåˆ—é•¿åº¦åªåœ¨æ¶ˆæ¯å †ç§¯çš„æƒ…å†µä¸‹æœ‰æ„ä¹‰ï¼Œè€Œä¸”ä¼šåˆ é™¤å…ˆå…¥é˜Ÿçš„æ¶ˆæ¯ï¼Œä¸èƒ½çœŸæ­£åœ°å®ç°æœåŠ¡ç«¯é™æµã€‚ 1.2.å†…å­˜æ§åˆ¶RabbitMQ ä¼šåœ¨å¯åŠ¨æ—¶æ£€æµ‹æœºå™¨çš„ç‰©ç†å†…å­˜æ•°å€¼ã€‚é»˜è®¤å½“ MQ å ç”¨ 40% ä»¥ä¸Šå†…å­˜æ—¶ï¼ŒMQ ä¼šä¸»åŠ¨æŠ›å‡ºä¸€ä¸ªå†…å­˜è­¦å‘Šå¹¶é˜»å¡æ‰€æœ‰è¿æ¥ã€‚å¯ä»¥é€šè¿‡ä¿®æ”¹rabbitmq.config æ–‡ä»¶æ¥è°ƒæ•´å†…å­˜é˜ˆå€¼ï¼Œé»˜è®¤å€¼æ˜¯ 0.4ã€‚ 1[&#123;rabbit, [&#123;vm_memory_high_watermark, 0.4&#125;]&#125;] ä¹Ÿå¯ä»¥ç”¨å‘½ä»¤åŠ¨æ€è®¾ç½®ï¼Œå¦‚æœè®¾ç½®æˆ 0ï¼Œåˆ™æ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä¸èƒ½å‘å¸ƒã€‚ 1rabbitmqctl set_vm_memory_high_watermark 0.3 1.3ç£ç›˜æ§åˆ¶é€šè¿‡ç£ç›˜æ¥æ§åˆ¶æ¶ˆæ¯çš„å‘å¸ƒã€‚å½“ç£ç›˜ç©ºé—´ä½äºæŒ‡å®šçš„å€¼æ—¶ï¼ˆé»˜è®¤50MBï¼‰ï¼Œè§¦å‘æµæ§æªæ–½ã€‚ ä¾‹å¦‚ï¼šæŒ‡å®šä¸ºç£ç›˜çš„ 30%æˆ–è€… 2GB 12disk_free_limit.relative = 3.0disk_free_limit.absolute = 2GB 2.æ¶ˆè´¹ç«¯é™æµ2.1å®˜ç½‘æè¿°é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸è¿›è¡Œé…ç½®ï¼ŒRabbitMQ ä¼šå°½å¯èƒ½å¿«é€Ÿåœ°æŠŠé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å‘é€åˆ°æ¶ˆè´¹è€…ã€‚å› ä¸ºæ¶ˆè´¹è€…ä¼šåœ¨æœ¬åœ°ç¼“å­˜æ¶ˆæ¯ï¼Œå¦‚æœæ¶ˆæ¯æ•°é‡è¿‡å¤šï¼Œå¯èƒ½ä¼šå¯¼è‡´ OOM æˆ–è€…å½±å“å…¶ä»–è¿›ç¨‹çš„æ­£å¸¸è¿è¡Œã€‚ åœ¨æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯çš„èƒ½åŠ›æœ‰é™ï¼Œä¾‹å¦‚æ¶ˆè´¹è€…æ•°é‡å¤ªå°‘ï¼Œæˆ–è€…å•æ¡æ¶ˆæ¯çš„å¤„ç†æ—¶é—´è¿‡é•¿çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨ä¸€å®šæ•°é‡çš„æ¶ˆæ¯æ¶ˆè´¹å®Œä¹‹å‰ï¼Œä¸å†æ¨é€æ¶ˆæ¯è¿‡æ¥ï¼Œå°±è¦ç”¨åˆ°æ¶ˆè´¹ç«¯çš„æµé‡é™åˆ¶æªæ–½ã€‚ å¯ä»¥åŸºäº Consumer æˆ–è€… channel è®¾ç½® prefetch count çš„å€¼ï¼Œå«ä¹‰ä¸º Consumerç«¯çš„æœ€å¤§çš„ unacked messages æ•°ç›®ã€‚å½“è¶…è¿‡è¿™ä¸ªæ•°å€¼çš„æ¶ˆæ¯æœªè¢«ç¡®è®¤ï¼ŒRabbitMQ ä¼šåœæ­¢æŠ•é€’æ–°çš„æ¶ˆæ¯ç»™è¯¥æ¶ˆè´¹è€…ã€‚ 2.2ä»£ç é…ç½®RabbitMQ12channel.basicQos(2); // å¦‚æœè¶…è¿‡ 2 æ¡æ¶ˆæ¯æ²¡æœ‰å‘é€ ACKï¼Œå½“å‰æ¶ˆè´¹è€…ä¸å†æ¥å—é˜Ÿåˆ—æ¶ˆæ¯channel.basicConsume(QUEUE_NAME, false, consumer); SimpleMessageListenerContainer 1container.setPrefetchCount(2); Spring Boot é…ç½®1spring.rabbitmq.listener.simple.prefetch=2 channel çš„ prefetch count è®¾ç½®ä¸º 5ã€‚å½“æ¶ˆè´¹è€…æœ‰ 5 æ¡æ¶ˆæ¯æ²¡æœ‰ç»™ Broker å‘é€ ACKåï¼ŒRabbitMQ ä¸å†ç»™è¿™ä¸ªæ¶ˆè´¹è€…æŠ•é€’æ¶ˆæ¯ã€‚ 3.æ¶ˆæ¯ç§¯å‹ï¼Œä¸¢å¤±ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœæ¶ˆæ¯åœ¨é˜Ÿåˆ—å’Œäº¤æ¢æœºå‘ç”Ÿç§¯å‹ï¼Œå¹¶å·²ç»å¼€å§‹ä¸¢å¤±ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ ä¸´æ—¶æ‰©å®¹æ¶ˆè´¹è€…ï¼Œå…ˆä¿è¯ç°æœ‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸¢å¤±çš„æ¶ˆæ¯ï¼Œç­‰å¾…æµé‡é«˜å³°æœŸè¿‡åï¼Œåˆ©ç”¨ç¨‹åºæ’æŸ¥å‡ºæ¥ï¼Œé‡æ–°çŒå…¥MQé˜Ÿåˆ—ã€‚ä¹Ÿå¯ä»¥è€ƒè™‘å°†æ¶ˆæ¯ä¸´æ—¶å†™å…¥åˆ°ä¸€ä¸ªæ–°çš„topicé‡Œï¼Œç¼“è§£åŸæœ¬çš„é˜Ÿåˆ—å‹åŠ›ã€‚ å…¶å®è¿˜æœ‰brokerï¼Œæ¶ˆæ¯éƒ½æ˜¯å­˜ç£ç›˜ï¼Œä½†æ˜¯MQé«˜ååé‡ä¸€ä¸ªå¾ˆé‡è¦çš„åŸå› æ˜¯åˆ©ç”¨äº†page Cache ï¼Œæ•°æ®é‡æ²¡ç‰¹åˆ«å¤§çš„æƒ…å†µä¸‹ï¼Œmqå‘æ¶ˆæ¯åˆ°brokerç£ç›˜ï¼Œæ­¤æ—¶brokerçš„page cache ä¸­å…¶å®ä¹Ÿæ˜¯æœ‰è¿™ä»½æ¶ˆæ¯çš„ï¼Œå½“ç”Ÿäº§è€…æ­£å¸¸æ¶ˆè´¹æ—¶ï¼Œå¤§æ¦‚ç‡æ˜¯ç›´æ¥å¯ä»¥ä»page cache ä¸­æ‹‰æ¶ˆæ¯ï¼Œè¿™ä¸ªé€Ÿåº¦æ˜¯å†…å­˜çº§åˆ«ï¼Œpage cacheæ²¡æœ‰æ‹‰åˆ°æ¶ˆæ¯é‡‡å–ç£ç›˜ï¼Œå½“æ¶ˆæ¯å †ç§¯åœ¨brokeræ—¶ï¼Œè¯´æ˜ç”Ÿäº§è€…ç”Ÿäº§é€Ÿåº¦è¿‡å¿«ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹ä¸è¿‡æ¥ï¼Œè¿™æ—¶brokerçš„page cacheè¢«å¤§é‡çš„æ›´æ–°ï¼Œå¯¼è‡´æ¶ˆè´¹è€…æ‹‰æ¶ˆæ¯éƒ½æ˜¯å»ç£ç›˜å»è¯»å–ï¼Œpage cacheå¤±æ•ˆäº†ï¼Œæ‰€ä»¥æ‰©å®¹æ¶ˆè´¹è€…æ•°é‡æœ‰ç”¨ï¼Œä½†æ˜¯è¿˜éœ€è¦æ‰©å®¹brokerçš„æ•°é‡ã€‚ äº”ï¼Œé›†ç¾¤ä¸é«˜å¯ç”¨1.ä¸ºä»€ä¹ˆè¦åšé›†ç¾¤é›†ç¾¤ä¸»è¦ç”¨äºå®ç°é«˜å¯ç”¨ä¸è´Ÿè½½å‡è¡¡ã€‚ é«˜å¯ç”¨ï¼šå¦‚æœé›†ç¾¤ä¸­çš„æŸäº› MQ æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œå®¢æˆ·ç«¯è¿˜å¯ä»¥è¿æ¥åˆ°å…¶ä»– MQ æœåŠ¡å™¨ã€‚ è´Ÿè½½å‡è¡¡ï¼šåœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå•å° MQ æœåŠ¡å™¨èƒ½å¤„ç†çš„æ¶ˆæ¯æœ‰é™ï¼Œå¯ä»¥åˆ†å‘ç»™å¤šå° MQ æœåŠ¡å™¨ã€‚ RabbitMQ æœ‰ä¸¤ç§é›†ç¾¤æ¨¡å¼ï¼šæ™®é€šé›†ç¾¤æ¨¡å¼å’Œé•œåƒé˜Ÿåˆ—æ¨¡å¼ã€‚ 2.RabbitMQ å¦‚ä½•æ”¯æŒé›†ç¾¤åº”ç”¨åšé›†ç¾¤ï¼Œéœ€è¦é¢å¯¹æ•°æ®åŒæ­¥å’Œé€šä¿¡çš„é—®é¢˜ã€‚å› ä¸º Erlang å¤©ç”Ÿå…·å¤‡åˆ†å¸ƒå¼çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ RabbitMQ å¤©ç„¶æ”¯æŒé›†ç¾¤ï¼Œä¸éœ€è¦é€šè¿‡å¼•å…¥ ZK æˆ–è€…æ•°æ®åº“æ¥å®ç°æ•°æ®åŒæ­¥ã€‚ RabbitMQ é€šè¿‡/var/lib/rabbitmq/.erlang.cookie æ¥éªŒè¯èº«ä»½ï¼Œéœ€è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šä¿æŒä¸€è‡´ã€‚ 3.rabbitMQçš„èŠ‚ç‚¹ç±»å‹é›†ç¾¤æœ‰ä¸¤ç§èŠ‚ç‚¹ç±»å‹ï¼Œä¸€ç§æ˜¯ç£ç›˜èŠ‚ç‚¹ï¼ˆDisc Nodeï¼‰ï¼Œä¸€ç§æ˜¯å†…å­˜èŠ‚ç‚¹ï¼ˆRAMNodeï¼‰ã€‚ ç£ç›˜èŠ‚ç‚¹ï¼šå°†å…ƒæ•°æ®ï¼ˆåŒ…æ‹¬é˜Ÿåˆ—åå­—å±æ€§ã€äº¤æ¢æœºçš„ç±»å‹åå­—å±æ€§ã€ç»‘å®šã€vhostï¼‰æ”¾åœ¨ç£ç›˜ä¸­ã€‚ å†…å­˜èŠ‚ç‚¹ï¼šå°†å…ƒæ•°æ®æ”¾åœ¨å†…å­˜ä¸­ã€‚ å†…å­˜èŠ‚ç‚¹ä¼šå°†ç£ç›˜èŠ‚ç‚¹çš„åœ°å€å­˜æ”¾åœ¨ç£ç›˜ï¼ˆä¸ç„¶é‡å¯åå°±æ²¡æœ‰åŠæ³•åŒæ­¥æ•°æ®äº†ï¼‰ã€‚å¦‚æœæ˜¯æŒä¹…åŒ–çš„æ¶ˆæ¯ï¼Œä¼šåŒæ—¶å­˜æ”¾åœ¨å†…å­˜å’Œç£ç›˜ã€‚ é›†ç¾¤ä¸­è‡³å°‘éœ€è¦ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ç”¨æ¥æŒä¹…åŒ–å…ƒæ•°æ®ï¼Œå¦åˆ™å…¨éƒ¨å†…å­˜èŠ‚ç‚¹å´©æºƒæ—¶ï¼Œå°±æ— ä»åŒæ­¥å…ƒæ•°æ®ã€‚æœªæŒ‡å®šç±»å‹çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ä¸ºç£ç›˜èŠ‚ç‚¹ã€‚ æˆ‘ä»¬ä¸€èˆ¬æŠŠåº”ç”¨è¿æ¥åˆ°å†…å­˜èŠ‚ç‚¹ï¼ˆè¯»å†™å¿«ï¼‰ï¼Œç£ç›˜èŠ‚ç‚¹ç”¨æ¥å¤‡ä»½ã€‚ é›†ç¾¤é€šè¿‡ 25672 ç«¯å£ä¸¤ä¸¤é€šä¿¡ï¼Œéœ€è¦å¼€æ”¾é˜²ç«å¢™çš„ç«¯å£ã€‚ RabbitMQ é›†ç¾¤æ— æ³•æ­å»ºåœ¨å¹¿åŸŸç½‘ä¸Š é›†ç¾¤çš„é…ç½®æ­¥éª¤ é…ç½® hosts åŒæ­¥ erlang.cookie åŠ å…¥é›†ç¾¤ï¼ˆjoin clusterï¼‰ 4.æ™®é€šé›†ç¾¤æ™®é€šé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä¸åŒçš„èŠ‚ç‚¹ä¹‹é—´åªä¼šç›¸äº’åŒæ­¥å…ƒæ•°æ®ã€‚ ä¸ºä»€ä¹ˆä¸ç›´æ¥æŠŠé˜Ÿåˆ—çš„å†…å®¹ï¼ˆæ¶ˆæ¯ï¼‰åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå¤åˆ¶ä¸€ä»½ï¼Ÿ ä¸»è¦æ˜¯å‡ºäºå­˜å‚¨å’ŒåŒæ­¥æ•°æ®çš„ç½‘ç»œå¼€é”€çš„è€ƒè™‘ï¼Œå¦‚æœæ‰€æœ‰èŠ‚ç‚¹éƒ½å­˜å‚¨ç›¸åŒçš„æ•°æ®ï¼Œå°±æ— æ³•è¾¾åˆ°çº¿æ€§åœ°å¢åŠ æ€§èƒ½å’Œå­˜å‚¨å®¹é‡çš„ç›®çš„ï¼ˆå †æœºå™¨ï¼‰ã€‚ å‡å¦‚ç”Ÿäº§è€…è¿æ¥çš„æ˜¯èŠ‚ç‚¹ 3ï¼Œè¦å°†æ¶ˆæ¯é€šè¿‡äº¤æ¢æœº A è·¯ç”±åˆ°é˜Ÿåˆ— 1ï¼Œæœ€ç»ˆæ¶ˆæ¯è¿˜æ˜¯ä¼šè½¬å‘åˆ°èŠ‚ç‚¹ 1 ä¸Šå­˜å‚¨ï¼Œå› ä¸ºé˜Ÿåˆ— 1 çš„å†…å®¹åªåœ¨èŠ‚ç‚¹ 1 ä¸Šã€‚ åŒç†ï¼Œå¦‚æœæ¶ˆè´¹è€…è¿æ¥æ˜¯èŠ‚ç‚¹ 2ï¼Œè¦ä»é˜Ÿåˆ— 1 ä¸Šæ‹‰å–æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¼šä»èŠ‚ç‚¹ 1 è½¬å‘åˆ°èŠ‚ç‚¹ 2ã€‚å…¶å®ƒèŠ‚ç‚¹èµ·åˆ°ä¸€ä¸ªè·¯ç”±çš„ä½œç”¨ï¼Œç±»ä¼¼äºæŒ‡é’ˆã€‚ æ™®é€šé›†ç¾¤æ¨¡å¼ä¸èƒ½ä¿è¯é˜Ÿåˆ—çš„é«˜å¯ç”¨æ€§ï¼Œå› ä¸ºé˜Ÿåˆ—å†…å®¹ä¸ä¼šå¤åˆ¶ã€‚å¦‚æœèŠ‚ç‚¹å¤±æ•ˆå°†å¯¼è‡´ç›¸å…³é˜Ÿåˆ—ä¸å¯ç”¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç¬¬äºŒç§é›†ç¾¤æ¨¡å¼ã€‚ 5.é•œåƒé›†ç¾¤ç¬¬äºŒç§é›†ç¾¤æ¨¡å¼å«åšé•œåƒé˜Ÿåˆ—ã€‚ é•œåƒé˜Ÿåˆ—æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å†…å®¹ä¼šåœ¨é•œåƒèŠ‚ç‚¹é—´åŒæ­¥ï¼Œå¯ç”¨æ€§æ›´é«˜ã€‚ä¸è¿‡ä¹Ÿæœ‰ä¸€å®šçš„å‰¯ä½œç”¨ï¼Œç³»ç»Ÿæ€§èƒ½ä¼šé™ä½ï¼ŒèŠ‚ç‚¹è¿‡å¤šçš„æƒ…å†µä¸‹åŒæ­¥çš„ä»£ä»·æ¯”è¾ƒå¤§ã€‚ 6.é«˜å¯ç”¨é›†ç¾¤æ­å»ºæˆåŠŸåï¼Œå¦‚æœæœ‰å¤šä¸ªå†…å­˜èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åº”è¯¥è¿æ¥åˆ°å“ªä¸ªå†…å­˜èŠ‚ç‚¹ï¼Ÿå¦‚æœåœ¨æˆ‘ä»¬çš„ä»£ç ä¸­æ ¹æ®ä¸€å®šçš„ç­–ç•¥æ¥é€‰æ‹©è¦ä½¿ç”¨çš„æœåŠ¡å™¨ï¼Œé‚£æ¯ä¸ªåœ°æ–¹éƒ½è¦ä¿®æ”¹ï¼Œå®¢æˆ·ç«¯çš„ä»£ç å°±ä¼šå‡ºç°å¾ˆå¤šçš„é‡å¤ï¼Œä¿®æ”¹èµ·æ¥ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚ æ‰€ä»¥éœ€è¦ä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„ç»„ä»¶ï¼ˆä¾‹å¦‚ HAProxyï¼ŒLVSï¼ŒNignxï¼‰ï¼Œç”±è´Ÿè½½çš„ç»„ä»¶æ¥åšè·¯ç”±ã€‚è¿™ä¸ªæ—¶å€™ï¼Œåªéœ€è¦è¿æ¥åˆ°è´Ÿè½½ç»„ä»¶çš„ IP åœ°å€å°±å¯ä»¥äº†ã€‚ è´Ÿè½½åˆ†ä¸ºå››å±‚è´Ÿè½½å’Œä¸ƒå±‚è´Ÿè½½ã€‚ å››å±‚è´Ÿè½½ï¼šå·¥ä½œåœ¨ OSI æ¨¡å‹çš„ç¬¬å››å±‚ï¼Œå³ä¼ è¾“å±‚ï¼ˆTCP ä½äºç¬¬å››å±‚ï¼‰ï¼Œå®ƒæ˜¯æ ¹æ® IPç«¯å£è¿›è¡Œè½¬å‘ï¼ˆLVS æ”¯æŒå››å±‚è´Ÿè½½ï¼‰ã€‚RabbitMQ æ˜¯ TCP çš„ 5672 ç«¯å£ã€‚ ï¼ˆä¿®æ”¹æŠ¥æ–‡ä¸­ç›®æ ‡åœ°å€å’ŒåŸåœ°å€ï¼‰ ä¸ƒå±‚è´Ÿè½½ï¼šå·¥ä½œåœ¨ç¬¬ä¸ƒå±‚ï¼Œåº”ç”¨å±‚ï¼ˆHTTP ä½äºç¬¬ä¸ƒå±‚ï¼‰ã€‚å¯ä»¥æ ¹æ®è¯·æ±‚èµ„æºç±»å‹åˆ†é…åˆ°åç«¯æœåŠ¡å™¨ï¼ˆNginx æ”¯æŒä¸ƒå±‚è´Ÿè½½ï¼›HAProxy æ”¯æŒå››å±‚å’Œä¸ƒå±‚è´Ÿè½½ï¼‰ã€‚ ï¼ˆå¤„ç†è¯·æ±‚ï¼Œä»£ç†è‡³æœåŠ¡å™¨ï¼‰ ä½†æ˜¯ï¼Œå¦‚æœè¿™ä¸ªè´Ÿè½½çš„ç»„ä»¶ä¹ŸæŒ‚äº†å‘¢ï¼Ÿ æˆ‘ä»¬åº”è¯¥éœ€è¦è¿™æ ·ä¸€ä¸ªç»„ä»¶ å®ƒæœ¬èº«æœ‰è·¯ç”±ï¼ˆè´Ÿè½½ï¼‰åŠŸèƒ½ï¼Œå¯ä»¥ç›‘æ§é›†ç¾¤ä¸­èŠ‚ç‚¹çš„çŠ¶æ€ï¼ˆæ¯”å¦‚ç›‘æ§HAProxyï¼‰ï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹å‡ºç°å¼‚å¸¸æˆ–è€…å‘ç”Ÿæ•…éšœï¼Œå°±æŠŠå®ƒå‰”é™¤æ‰ã€‚ ä¸ºäº†æé«˜å¯ç”¨æ€§ï¼Œå®ƒä¹Ÿå¯ä»¥éƒ¨ç½²å¤šä¸ªæœåŠ¡ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªè‡ªåŠ¨é€‰ä¸¾å‡ºæ¥çš„ MASTER æœåŠ¡å™¨ï¼ˆå«åšä¸»è·¯ç”±å™¨ï¼‰ï¼Œé€šè¿‡å¹¿æ’­å¿ƒè·³æ¶ˆæ¯å®ç°ã€‚ MASTER æœåŠ¡å™¨å¯¹å¤–æä¾›ä¸€ä¸ªè™šæ‹Ÿ IPï¼Œæä¾›å„ç§ç½‘ç»œåŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯è°æŠ¢å åˆ° VIPï¼Œå°±ç”±è°å¯¹å¤–æä¾›ç½‘ç»œæœåŠ¡ã€‚åº”ç”¨ç«¯åªéœ€è¦è¿æ¥åˆ°è¿™ä¸€ä¸ª IP å°±è¡Œäº†ã€‚ è¿™ä¸ªåè®®å«åš VRRP åè®®ï¼ˆè™šæ‹Ÿè·¯ç”±å†—ä½™åè®® Virtual Router RedundancyProtocolï¼‰ï¼Œè¿™ä¸ªç»„ä»¶å°±æ˜¯ Keepalivedï¼Œå®ƒå…·æœ‰ Load Balance å’Œ High Availabilityçš„åŠŸèƒ½ã€‚â€‹ å…­ï¼ŒMQå»¶è¿Ÿæ¶ˆæ¯çš„å®ç°â€‹ mqå®ç°å»¶è¿Ÿæ¶ˆæ¯æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯åŸºäºæ­»ä¿¡é˜Ÿåˆ—ï¼Œä¸€ç§æ˜¯åŸºäºå»¶è¿Ÿæ’ä»¶ã€‚â€‹ 1.åŸºäºæ­»ä¿¡é˜Ÿåˆ—1.1.ç†è®º æ¶ˆæ¯çš„TTL æ¶ˆæ¯çš„å­˜æ´»æ—¶é—´ã€‚RabbitMQå¯ä»¥å¯¹é˜Ÿåˆ—å’Œæ¶ˆæ¯åˆ†åˆ«è®¾ç½®TTLã€‚å¯¹é˜Ÿåˆ—è®¾ç½®å°±æ˜¯é˜Ÿåˆ—æ²¡æœ‰æ¶ˆè´¹è€…è¿ç€çš„ä¿ç•™æ—¶é—´ï¼Œä¹Ÿå¯ä»¥å¯¹æ¯ä¸€ä¸ªå•ç‹¬çš„æ¶ˆæ¯åšå•ç‹¬çš„è®¾ç½®ã€‚è¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™ä¸ªæ¶ˆæ¯å°±æ­»äº†ï¼Œç§°ä¹‹ä¸ºæ­»ä¿¡ã€‚å¦‚ä½•è®¾ç½®TTL æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—queue.tempï¼Œåœ¨Arguments ä¸­æ·»åŠ x-message-ttl ä¸º5000 ï¼ˆå•ä½æ˜¯æ¯«ç§’ï¼‰ï¼Œé‚£æ‰€åœ¨å‹åœ¨è¿™ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯åœ¨5ç§’åä¼šæ¶ˆå¤±ã€‚æ­»ä¿¡äº¤æ¢æœº Dead Letter Exchangeå…¶å®å°±æ˜¯ä¸€ç§æ™®é€šçš„exchangeï¼Œå’Œåˆ›å»ºå…¶ä»–exchangeæ²¡æœ‰ä¸¤æ ·ã€‚åªæ˜¯åœ¨æŸä¸€ä¸ªè®¾ç½®Dead Letter Exchangeçš„é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯è¿‡æœŸäº†ï¼Œä¼šè‡ªåŠ¨è§¦å‘æ¶ˆæ¯çš„è½¬å‘ï¼Œå‘é€åˆ°Dead Letter Exchangeä¸­å»ã€‚ ä½•æ—¶è¿›å…¥æ­»ä¿¡è·¯ç”± ä¸€ä¸ªæ¶ˆæ¯è¢«Consumeræ‹’æ”¶äº†ï¼Œå¹¶ä¸”rejectæ–¹æ³•çš„å‚æ•°é‡Œrequeueæ˜¯falseã€‚ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šè¢«å†æ¬¡æ”¾åœ¨é˜Ÿåˆ—é‡Œï¼Œè¢«å…¶ä»–æ¶ˆè´¹è€…ä½¿ç”¨ã€‚ ä¸Šé¢çš„æ¶ˆæ¯çš„TTLåˆ°äº†ï¼Œæ¶ˆæ¯è¿‡æœŸäº†ã€‚ é˜Ÿåˆ—çš„é•¿åº¦é™åˆ¶æ»¡äº†ã€‚æ’åœ¨å‰é¢çš„æ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒæˆ–è€…æ‰”åˆ°æ­»ä¿¡è·¯ç”±ä¸Šã€‚ 1.2 ä»£ç 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/** * @author yhd * @createtime 2021/1/23 2:26 * @description æ­»ä¿¡äº¤æ¢æœºé…ç½®ç±» */@SpringBootConfigurationpublic class DeadLetterMqConfig &#123; public static final String EXCHANGE_DEAD = &quot;exchange.dead&quot;; public static final String ROUTING_DEAD_1 = &quot;routing.dead.1&quot;; public static final String ROUTING_DEAD_2 = &quot;routing.dead.2&quot;; public static final String QUEUE_DEAD_1 = &quot;queue.dead.1&quot;; public static final String QUEUE_DEAD_2 = &quot;queue.dead.2&quot;; // å®šä¹‰äº¤æ¢æœº @Bean public DirectExchange exchange()&#123; return new DirectExchange(EXCHANGE_DEAD,true,false,null); &#125; @Bean public Queue queue1()&#123; // è®¾ç½®å¦‚æœé˜Ÿåˆ—ä¸€ å‡ºç°é—®é¢˜ï¼Œåˆ™é€šè¿‡å‚æ•°è½¬åˆ°EXCHANGE_DEADï¼ŒROUTING_DEAD_2 ä¸Šï¼ Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); // å‚æ•°ç»‘å®š æ­¤å¤„çš„key å›ºå®šå€¼ï¼Œä¸èƒ½éšæ„å†™ map.put(&quot;x-dead-letter-exchange&quot;,EXCHANGE_DEAD); map.put(&quot;x-dead-letter-routing-key&quot;,ROUTING_DEAD_2); // è®¾ç½®å»¶è¿Ÿæ—¶é—´ map.put(&quot;x-message-ttl&quot;, 10 * 1000); // é˜Ÿåˆ—åç§°ï¼Œæ˜¯å¦æŒä¹…åŒ–ï¼Œæ˜¯å¦ç‹¬äº«ã€æ’å¤–çš„ã€true:åªå¯ä»¥åœ¨æœ¬æ¬¡è¿æ¥ä¸­è®¿é—®ã€‘ï¼Œæ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œé˜Ÿåˆ—çš„å…¶ä»–å±æ€§å‚æ•° return new Queue(QUEUE_DEAD_1,true,false,false,map); &#125; @Bean public Binding binding()&#123; // å°†é˜Ÿåˆ—ä¸€ é€šè¿‡ROUTING_DEAD_1 key ç»‘å®šåˆ°EXCHANGE_DEAD äº¤æ¢æœºä¸Š return BindingBuilder.bind(queue1()).to(exchange()).with(ROUTING_DEAD_1); &#125; // è¿™ä¸ªé˜Ÿåˆ—äºŒå°±æ˜¯ä¸€ä¸ªæ™®é€šé˜Ÿåˆ— @Bean public Queue queue2()&#123; return new Queue(QUEUE_DEAD_2,true,false,false,null); &#125; // è®¾ç½®é˜Ÿåˆ—äºŒçš„ç»‘å®šè§„åˆ™ @Bean public Binding binding2()&#123; // å°†é˜Ÿåˆ—äºŒé€šè¿‡ROUTING_DEAD_2 key ç»‘å®šåˆ°EXCHANGE_DEADäº¤æ¢æœºä¸Šï¼ return BindingBuilder.bind(queue2()).to(exchange()).with(ROUTING_DEAD_2); &#125;&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455package com.yhd.rabbitmq.dead;import com.rabbitmq.client.Channel;import lombok.SneakyThrows;import lombok.extern.slf4j.Slf4j;import org.springframework.amqp.core.Message;import org.springframework.amqp.rabbit.annotation.RabbitListener;import org.springframework.amqp.rabbit.core.RabbitTemplate;import org.springframework.stereotype.Component;import javax.annotation.Resource;/** * @author yhd * @createtime 2021/1/23 2:28 */@Component@Slf4jpublic class DeadLetterMqTest &#123; @Resource private RabbitTemplate rabbitTemplate; /** * æ¶ˆæ¯å‘é€ */ public boolean sendMsg()&#123; rabbitTemplate.convertAndSend(DeadLetterMqConfig.EXCHANGE_DEAD, DeadLetterMqConfig.ROUTING_DEAD_1, &quot;ok&quot;); return true; &#125; /** * æ¶ˆæ¯æ¥æ”¶ * æ­£å¸¸äº¤æ¢æœº */ @SneakyThrows @RabbitListener(queues = DeadLetterMqConfig.QUEUE_DEAD_2) public void get(String msg, Message message, Channel channel) &#123; channel.basicNack(message.getMessageProperties().getDeliveryTag(),false,false); log.info(&quot;æ­£å¸¸é˜Ÿåˆ—æ¥å—æ¶ˆæ¯ï¼š &#123;&#125;&quot; , msg); &#125; /** * æ¶ˆæ¯æ¥æ”¶ * æ­»ä¿¡äº¤æ¢æœº * @param msg * @param message * @param channel */ @SneakyThrows @RabbitListener(queues = DeadLetterMqConfig.QUEUE_DEAD_1) public void get2(String msg, Message message, Channel channel) &#123; log.info(&quot;æ­»ä¿¡é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯: &#123;&#125;&quot; , msg); channel.basicAck(message.getMessageProperties().getDeliveryTag(),false); &#125;&#125; 2.åŸºäºå»¶è¿Ÿæ’ä»¶2.1.ç†è®ºRabbitmqå®ç°äº†ä¸€ä¸ªæ’ä»¶x-delay-messageæ¥å®ç°å»¶æ—¶é˜Ÿåˆ—ã€‚â€‹ åŸºäºæ’ä»¶çš„å»¶è¿Ÿæ¶ˆæ¯å¯èƒ½æœ‰ä¸€ä¸ªå°bugï¼ˆä¸å½±å“ä¸šåŠ¡ï¼‰ï¼Œå°±æ˜¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶ä¼šå›è°ƒreturnedMessageæ–¹æ³•ï¼ˆæ¶ˆæ¯ç¡®è®¤æ—¶æˆ‘ä»¬é…ç½®çš„å›è°ƒæ–¹æ³•ï¼Œè¡¨ç¤ºäº¤æ¢æœºåˆ°é˜Ÿåˆ—å‘é€å¤±è´¥ï¼‰ï¼Œå…¶å®åŸºäºæ’ä»¶çš„å»¶è¿Ÿæ¶ˆæ¯æ˜¯å‘é€æˆåŠŸäº†çš„ï¼Œå¦‚æœå‘ç”Ÿè¯¥bugï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®äº¤æ¢æœºæˆ–é˜Ÿåˆ—è¿‡æ»¤æ‰è¯¥æ¶ˆæ¯ï¼Œåˆ«è®©ä»–åŠ å…¥é‡è¯•é˜Ÿåˆ—ï¼›å¦‚æœä¸èƒ½æ¥å—åç»­ä¸šåŠ¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­»ä¿¡çš„æ–¹å¼å‘é€å»¶è¿Ÿæ¶ˆæ¯ã€‚ æ’ä»¶å®‰è£…â€‹https://www.rabbitmq.com/community-plugins.html å°†æ’ä»¶æ‹·è´åˆ°pluginsç›®å½•ä¸‹ è¿›å…¥pluginsç›®å½• æ‰§è¡Œ rabbitmq-plugins enable rabbitmq_delayed_message_exchange å‘½ä»¤å¯ç”¨æ’ä»¶ é‡å¯ rabbitmq é˜Ÿåˆ—ä¸è¦åœ¨RabbitListenerä¸Šé¢åšç»‘å®šï¼Œå¦åˆ™ä¸ä¼šæˆåŠŸï¼Œå¿…é¡»åœ¨é…ç½®ç±»ç»‘å®šã€‚ 2.2 ä»£ç 12345678910111213141516171819202122232425262728293031323334/** * @author yhd * @createtime 2021/1/22 14:37 */@SpringBootApplicationpublic class DelayConfig &#123; //å»¶æ—¶äº¤æ¢æœº public static final String EXCHANGE_DIRECT_ORDER_CANCEL = &quot;spring.boot.test.delay.exchange&quot;; //è·¯ç”±é”® public static final String ROUTING_ORDER_CANCEL = &quot;spring.boot.test.delay.routing&quot;; //å»¶è¿Ÿé˜Ÿåˆ— public static final String QUEUE_ORDER_CANCEL = &quot;spring.boot.test.delay.queue&quot;; // å»¶è¿Ÿæ—¶é—´ å•ä½ï¼šç§’ public static final int DELAY_TIME = 60; @Bean //å£°æ˜æ­»ä¿¡é˜Ÿåˆ— public Queue delayQueue() &#123; // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åˆ›å»ºçš„queueçš„åå­—ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ˜¯å¦æ”¯æŒæŒä¹…åŒ– return new Queue(QUEUE_ORDER_CANCEL, true); &#125; @Bean //å£°æ˜ç§ä¿¡äº¤æ¢æœº public CustomExchange delayExchange() &#123; Map&lt;String, Object&gt; args = new HashMap&lt;String, Object&gt;(); args.put(&quot;x-delayed-type&quot;, &quot;direct&quot;); return new CustomExchange(EXCHANGE_DIRECT_ORDER_CANCEL, &quot;x-delayed-message&quot;, true, false, args); &#125; @Bean //æ­»ä¿¡äº¤æ¢æœºç»‘å®šæ­»ä¿¡é˜Ÿåˆ—å¹¶è®¾ç½®è·¯ç”±é”® public Binding bindingDelay() &#123; return BindingBuilder.bind(delayQueue()).to(delayExchange()).with(ROUTING_ORDER_CANCEL).noargs(); &#125;&#125; 123456789101112131415161718192021222324252627282930313233343536373839/** * @author yhd * @createtime 2021/1/22 14:34 * æµ‹è¯•springbootæ•´åˆmqåˆ©ç”¨æ­»ä¿¡é˜Ÿåˆ—å‘é€æ¶ˆæ¯å¹¶æ¥æ”¶ */@Component@Slf4jpublic class SpringBootDelayQueueTest &#123; @Resource private RabbitTemplate rabbitTemplate; @Resource private AmqpTemplate amqpTemplate; /** * å‘é€æ¶ˆæ¯ */ public void sendMessage() &#123; amqpTemplate.convertAndSend( DelayConfig.EXCHANGE_DIRECT_ORDER_CANCEL,DelayConfig.ROUTING_ORDER_CANCEL, &quot;try send message to delay queue !&quot;, msg -&gt; &#123; msg.getMessageProperties().setDelay(DelayConfig.DELAY_TIME * 1000); return msg; &#125;); &#125; /** * æ¥æ”¶æ¶ˆæ¯ */ @RabbitListener(queues = DelayConfig.QUEUE_ORDER_CANCEL) public void receiveMessage(String msg, Message message, Channel channel) throws Exception &#123; log.info(&quot;the delaty queue received message : &#123;&#125;&quot;, msg); //log.info(&quot;the delaty queue received message : &#123;&#125;&quot;, new String(message.getBody())); channel.basicAck(message.getMessageProperties().getDeliveryTag(), false); &#125;&#125; ä¸ƒï¼Œé¢è¯•ç»éªŒæ€»ç»“1.åˆ°åº•åœ¨æ¶ˆè´¹è€…åˆ›å»ºè¿˜æ˜¯åœ¨ç”Ÿäº§è€…åˆ›å»ºï¼Ÿå¦‚æœAé¡¹ç›®å’ŒBé¡¹ç›®æœ‰ç›¸äº’å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼Œåº”è¯¥åˆ›å»ºå‡ ä¸ªvhostï¼Œå‡ ä¸ªExchangeï¼Ÿ äº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼Œå®é™…ä¸Šæ˜¯ä½œä¸ºèµ„æºï¼Œç”±è¿ç»´ç®¡ç†å‘˜åˆ›å»ºçš„ã€‚ 2.ä¿¡æ¯è½åº“+ å®šæ—¶ä»»åŠ¡å°†éœ€è¦å‘é€çš„æ¶ˆæ¯ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œå¯ä»¥å®ç°æ¶ˆæ¯çš„å¯è¿½æº¯å’Œé‡å¤æ§åˆ¶ï¼Œéœ€è¦é…åˆå®šæ—¶ä»»åŠ¡æ¥å®ç°ã€‚ å°†éœ€è¦å‘é€çš„æ¶ˆæ¯ç™»è®°åœ¨æ¶ˆæ¯è¡¨ä¸­ã€‚ å®šæ—¶ä»»åŠ¡ä¸€åˆ†é’Ÿæˆ–åŠåˆ†é’Ÿæ‰«æä¸€æ¬¡ï¼Œå°†æœªå‘é€çš„æ¶ˆæ¯å‘é€åˆ° MQ æœåŠ¡å™¨ï¼Œå¹¶ä¸”ä¿®æ”¹çŠ¶æ€ä¸ºå·²å‘é€ã€‚ å¦‚æœéœ€è¦é‡å‘æ¶ˆæ¯ï¼Œå°†æŒ‡å®šæ¶ˆæ¯çš„çŠ¶æ€ä¿®æ”¹ä¸ºæœªå‘é€å³å¯ã€‚ å‰¯ä½œç”¨ï¼šé™ä½æ•ˆç‡ï¼Œæµªè´¹å­˜å‚¨ç©ºé—´ã€‚ 3.æ—¥å¿—è¿½è¸ªRabbitMQ å¯ä»¥é€šè¿‡ Firehose åŠŸèƒ½æ¥è®°å½•æ¶ˆæ¯æµå…¥æµå‡ºçš„æƒ…å†µï¼Œç”¨äºè°ƒè¯•ï¼Œæ’é”™ã€‚ å®ƒæ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ª TOPIC ç±»å‹çš„äº¤æ¢æœºï¼ˆamq.rabbitmq.traceï¼‰ï¼ŒæŠŠç”Ÿäº§è€…å‘é€ç»™Broker çš„æ¶ˆæ¯æˆ–è€… Broker å‘é€ç»™æ¶ˆè´¹è€…çš„æ¶ˆæ¯å‘åˆ°è¿™ä¸ªé»˜è®¤çš„äº¤æ¢æœºä¸Šé¢æ¥å®ç°çš„ã€‚ å¦å¤– RabbitMQ ä¹Ÿæä¾›äº†ä¸€ä¸ª Firehose çš„ GUI ç‰ˆæœ¬ï¼Œå°±æ˜¯ Tracing æ’ä»¶ã€‚ å¯ç”¨ Tracing æ’ä»¶åç®¡ç†ç•Œé¢å³ä¾§é€‰é¡¹å¡ä¼šå¤šä¸€ä¸ª Tracingï¼Œå¯ä»¥æ·»åŠ ç›¸åº”çš„ç­–ç•¥ã€‚ RabbitMQ è¿˜æä¾›äº†å…¶ä»–çš„æ’ä»¶æ¥å¢å¼ºåŠŸèƒ½ã€‚ 4.å¦‚ä½•å‡å°‘è¿æ¥æ•°åœ¨å‘é€å¤§æ‰¹é‡æ¶ˆæ¯çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºå’Œé‡Šæ”¾è¿æ¥ä¾ç„¶æœ‰ä¸å°çš„å¼€é”€ã€‚æˆ‘ä»¬å¯ä»¥è·Ÿæ¥æ”¶æ–¹çº¦å®šæ‰¹é‡æ¶ˆæ¯çš„æ ¼å¼ï¼Œæ¯”å¦‚æ”¯æŒ JSON æ•°ç»„çš„æ ¼å¼ï¼Œé€šè¿‡åˆå¹¶æ¶ˆæ¯å†…å®¹ï¼Œå¯ä»¥å‡å°‘ç”Ÿäº§è€…/æ¶ˆè´¹è€…ä¸ Broker çš„è¿æ¥ã€‚ æ¯”å¦‚ï¼šæ´»åŠ¨è¿‡åï¼Œè¦å…¨èŒƒå›´ä¸‹çº¿äº§å“ï¼Œé€šè¿‡ Excel å¯¼å…¥æ¨¡æ¿ï¼Œé€šå¸¸æœ‰å‡ ä¸‡åˆ°å‡ åä¸‡æ¡è§£ç»‘æ•°æ®ï¼Œåˆå¹¶å‘é€çš„æ•ˆç‡æ›´é«˜ã€‚ å»ºè®®å•æ¡æ¶ˆæ¯ä¸è¦è¶…è¿‡ 4Mï¼ˆ4096KBï¼‰ï¼Œä¸€æ¬¡å‘é€çš„æ¶ˆæ¯æ•°éœ€è¦åˆç†åœ°æ§åˆ¶ã€‚ 5.æ— æ³•è¢«è·¯ç”±çš„æ¶ˆæ¯ï¼Œå»äº†å“ªé‡Œï¼Ÿç›´æ¥ä¸¢å¼ƒã€‚å¯ç”¨å¤‡ä»½äº¤æ¢æœºï¼ˆalternate-exchangeï¼‰æ¥æ”¶ã€‚ 6.å¤§é‡æ¶ˆæ¯å †ç§¯æ€ä¹ˆåŠï¼Ÿ é‡å¯ï¼ˆä¸æ˜¯å¼€ç©ç¬‘çš„ï¼‰ å¤šåˆ›å»ºå‡ ä¸ªæ¶ˆè´¹è€…åŒæ—¶æ¶ˆè´¹ ç›´æ¥æ¸…ç©ºé˜Ÿåˆ—ï¼Œé‡å‘æ¶ˆæ¯ 7.è®¾è®¡ä¸€ä¸ª MQï¼Œä½ çš„æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿå­˜å‚¨ä¸è½¬å‘ã€‚ å­˜å‚¨ï¼šå†…å­˜ï¼šç”¨ä»€ä¹ˆæ•°æ®ç»“æ„ï¼Ÿ ç£ç›˜ï¼šæ–‡ä»¶ç³»ç»Ÿï¼Ÿæ•°æ®åº“ï¼Ÿ é€šä¿¡ï¼šé€šä¿¡åè®®ï¼ˆTCP HTTP AMQP ï¼‰ï¼Ÿä¸€å¯¹ä¸€ï¼Ÿä¸€å¯¹å¤šï¼Ÿä¸€å¯¹å¤š æ¨æ¨¡å¼ï¼Ÿæ‹‰æ¨¡å¼ï¼Ÿåè€… å…¶ä»–ç‰¹æ€§â€¦â€¦â€‹ å…«ï¼ŒSpring AMQP1.ç®€å•ä½¿ç”¨Spring-amqpæ˜¯å¯¹AMQPåè®®çš„æŠ½è±¡å®ç°ï¼Œè€Œspring-rabbitæ˜¯å¯¹åè®®çš„å…·ä½“å®ç°ï¼Œä¹Ÿæ˜¯ç›®å‰çš„å”¯ä¸€å®ç°ã€‚åº•å±‚ä½¿ç”¨çš„å°±æ˜¯RabbitMQã€‚ 1.1ä¾èµ–1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;&lt;/dependency&gt; 1.2 é…ç½®1234567spring: rabbitmq: host: 121.199.31.160 username: root password: root virtual-host: /shopping port: 5672 1.3 ç›‘å¬è€…åœ¨SpringAmqpä¸­ï¼Œå¯¹æ¶ˆæ¯çš„æ¶ˆè´¹è€…è¿›è¡Œäº†å°è£…å’ŒæŠ½è±¡ï¼Œä¸€ä¸ªæ™®é€šçš„JavaBeanä¸­çš„æ™®é€šæ–¹æ³•ï¼Œåªè¦é€šè¿‡ç®€å•çš„æ³¨è§£ï¼Œå°±å¯ä»¥æˆä¸ºä¸€ä¸ªæ¶ˆè´¹è€…ã€‚â€‹ 1234567891011121314151617@Componentpublic class Listener &#123; @RabbitListener(bindings = @QueueBinding( //valueï¼šé˜Ÿåˆ—å value = @Queue(value = &quot;spring.test.queue&quot;, durable = &quot;true&quot;), exchange = @Exchange( //äº¤æ¢æœºå value = &quot;spring.test.exchange&quot;, ignoreDeclarationExceptions = &quot;true&quot;, type = ExchangeTypes.TOPIC ), key = &#123;&quot;#.#&quot;&#125;)) public void listen(String msg)&#123; System.out.println(&quot;æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š&quot; + msg); &#125;&#125; @Componetï¼šç±»ä¸Šçš„æ³¨è§£ï¼Œæ³¨å†Œåˆ°Springå®¹å™¨ @RabbitListenerï¼šæ–¹æ³•ä¸Šçš„æ³¨è§£ï¼Œå£°æ˜è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…æ–¹æ³•ï¼Œéœ€è¦æŒ‡å®šä¸‹é¢çš„å±æ€§ï¼š bindingsï¼šæŒ‡å®šç»‘å®šå…³ç³»ï¼Œå¯ä»¥æœ‰å¤šä¸ªã€‚å€¼æ˜¯@QueueBindingçš„æ•°ç»„ã€‚@QueueBindingåŒ…å«ä¸‹é¢å±æ€§ï¼š valueï¼šè¿™ä¸ªæ¶ˆè´¹è€…å…³è”çš„é˜Ÿåˆ—ã€‚å€¼æ˜¯@Queueï¼Œä»£è¡¨ä¸€ä¸ªé˜Ÿåˆ— exchangeï¼šé˜Ÿåˆ—æ‰€ç»‘å®šçš„äº¤æ¢æœºï¼Œå€¼æ˜¯@Exchangeç±»å‹ keyï¼šé˜Ÿåˆ—å’Œäº¤æ¢æœºç»‘å®šçš„RoutingKey durable = â€œtrueâ€ ä»£è¡¨æŒä¹…åŒ– ignoreDeclarationExceptions = â€œtrueâ€, å¼‚å¸¸æƒ…å†µæ˜¯å¦å¿½ç•¥ ç±»ä¼¼listenè¿™æ ·çš„æ–¹æ³•åœ¨ä¸€ä¸ªç±»ä¸­å¯ä»¥å†™å¤šä¸ªï¼Œå°±ä»£è¡¨å¤šä¸ªæ¶ˆè´¹è€…ã€‚â€‹ 1.4AmqpTemplateSpringä¸ºAMQPæä¾›äº†ç»Ÿä¸€çš„æ¶ˆæ¯å¤„ç†æ¨¡æ¿ï¼šAmqpTemplateï¼Œéå¸¸æ–¹ä¾¿çš„å‘é€æ¶ˆæ¯ï¼Œå…¶å‘é€æ–¹æ³•çº¢æ¡†åœˆèµ·æ¥çš„æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„3ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ï¼š æŒ‡å®šæ¶ˆæ¯ æŒ‡å®šRoutingKeyå’Œæ¶ˆæ¯ï¼Œä¼šå‘é»˜è®¤çš„äº¤æ¢æœºå‘é€æ¶ˆæ¯ æŒ‡å®šäº¤æ¢æœºã€RoutingKeyå’Œæ¶ˆæ¯ä½“ æµ‹è¯•ä»£ç ï¼šâ€‹ 123456789101112131415@RunWith(SpringRunner.class)@SpringBootTest(classes = Application.class)public class MqDemo &#123; @Autowired private AmqpTemplate amqpTemplate; @Test public void testSend() throws InterruptedException &#123; String msg = &quot;hello, Spring boot amqp&quot;; this.amqpTemplate.convertAndSend(&quot;spring.test.exchange&quot;, &quot;a.b&quot;, msg); // ç­‰å¾…10ç§’åå†ç»“æŸ Thread.sleep(10000); &#125;&#125; 2.æ€è€ƒâ€‹ Java API æ–¹å¼ç¼–ç¨‹ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ Spring å°è£… RabbitMQ çš„æ—¶å€™ï¼Œå®ƒåšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ ç®¡ç†å¯¹è±¡ï¼ˆé˜Ÿåˆ—ã€äº¤æ¢æœºã€ç»‘å®šï¼‰ å°è£…æ–¹æ³•ï¼ˆå‘é€æ¶ˆæ¯ã€æ¥æ”¶æ¶ˆæ¯ï¼‰ Spring AMQP æ˜¯å¯¹ Spring åŸºäº AMQP çš„æ¶ˆæ¯æ”¶å‘è§£å†³æ–¹æ¡ˆï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œä¸ä¾èµ–äºç‰¹å®šçš„ AMQP Broker å®ç°å’Œå®¢æˆ·ç«¯çš„æŠ½è±¡ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ›¿æ¢ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ spring-rabbit æ¥å®ç°ã€‚â€‹ 3.Spring AMQPæ ¸å¿ƒç»„ä»¶3.1 ConnectionFactorySpring AMQP çš„è¿æ¥å·¥å‚æ¥å£ï¼Œç”¨äºåˆ›å»ºè¿æ¥ã€‚CachingConnectionFactory æ˜¯ConnectionFactory çš„ä¸€ä¸ªå®ç°ç±»ã€‚ 3.2 RabbitAdminRabbitAdmin æ˜¯ AmqpAdmin çš„å®ç°ï¼Œå°è£…äº†å¯¹ RabbitMQ çš„åŸºç¡€ç®¡ç†æ“ä½œï¼Œæ¯”å¦‚å¯¹äº¤æ¢æœºã€é˜Ÿåˆ—ã€ç»‘å®šçš„å£°æ˜å’Œåˆ é™¤ç­‰ã€‚ 123456789101112131415161718192021222324252627282930313233343536/** * @author yhd * @createtime 2021/1/28 19:24 * @description Spring AMQP configuration class */@SpringBootConfigurationpublic class AMQPConfig &#123; private static final String EXCHANGE_NAME = &quot;amqp.yhd.exchange&quot;; private static final String QUEUE_NAME = &quot;amqp.yhd.queue&quot;; private static final String ROUTING_KEY = &quot;amqp.admin&quot;; @Bean public ConnectionFactory factory() &#123; CachingConnectionFactory factory = new CachingConnectionFactory(); factory.setAddresses(&quot;121.199.31.160&quot;); factory.setPort(5672); factory.setUsername(&quot;root&quot;); factory.setPassword(&quot;root&quot;); return factory; &#125; @Bean public AmqpAdmin amqpAdmin( ConnectionFactory factory) &#123; RabbitAdmin admin = new RabbitAdmin(factory); //å£°æ˜ä¸€ä¸ªäº¤æ¢æœº äº¤æ¢æœºå æ˜¯å¦æŒä¹…åŒ– æ˜¯å¦è‡ªåŠ¨åˆ é™¤ admin.declareExchange(new DirectExchange(EXCHANGE_NAME, true, false)); //é˜Ÿåˆ—å æŒä¹…åŒ– æ˜¯å¦æ‰¹å¤„ç† è‡ªåŠ¨åˆ é™¤ admin.declareQueue(new Queue(QUEUE_NAME, true, false, false)); //å£°æ˜ä¸€ä¸ªç»‘å®š é˜Ÿåˆ—å ï¼Œç»‘å®šç±»å‹ï¼Œäº¤æ¢æœºåï¼Œè·¯ç”±é”® å‚æ•° admin.declareBinding(new Binding(QUEUE_NAME, Binding.DestinationType.QUEUE, EXCHANGE_NAME, ROUTING_KEY, null)); return admin; &#125;&#125; ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ï¼ˆSpringï¼‰æˆ–è€…é…ç½®ç±»ï¼ˆSpringBootï¼‰é‡Œé¢å®šä¹‰äº†äº¤æ¢æœºã€é˜Ÿåˆ—ã€ç»‘å®šå…³ç³»ï¼Œå¹¶æ²¡æœ‰ç›´æ¥è°ƒç”¨ Channel çš„ declare çš„æ–¹æ³•ï¼ŒSpring åœ¨å¯åŠ¨çš„æ—¶å€™å°±å¯ä»¥å¸®æˆ‘ä»¬åˆ›å»ºè¿™äº›å…ƒæ•°æ®ï¼Ÿè¿™äº›äº‹æƒ…å°±æ˜¯ç”± RabbitAdmin å®Œæˆçš„ã€‚ RabbitAdmin å® ç° äº† InitializingBean æ¥ å£ ï¼Œ é‡Œ é¢ æœ‰ å”¯ ä¸€ çš„ ä¸€ ä¸ª æ–¹ æ³•afterPropertiesSet()ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨ RabbitAdmin çš„å±æ€§å€¼è®¾ç½®å®Œçš„æ—¶å€™è¢«è°ƒç”¨ã€‚ åœ¨ afterPropertiesSet ()æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†ä¸€ä¸ª initialize()æ–¹æ³•ã€‚è¿™é‡Œé¢åˆ›å»ºäº†ä¸‰ä¸ªCollectionï¼Œç”¨æ¥ç››æ”¾äº¤æ¢æœºã€é˜Ÿåˆ—ã€ç»‘å®šå…³ç³»ã€‚ æœ€åä¾æ¬¡å£°æ˜è¿”å›ç±»å‹ä¸º Exchangeã€Queue å’Œ Binding è¿™äº› Beanï¼Œåº•å±‚è¿˜æ˜¯è°ƒç”¨äº† Channel çš„ declare çš„æ–¹æ³•ã€‚ 123declareExchanges(channel, exchanges.toArray(new Exchange[exchanges.size()]));declareQueues(channel, queues.toArray(new Queue[queues.size()]));declareBindings(channel, bindings.toArray(new Binding[bindings.size()])); 3.3 MessageMessage æ˜¯ Spring AMQP å¯¹æ¶ˆæ¯çš„å°è£…ã€‚ä¸¤ä¸ªé‡è¦çš„å±æ€§ï¼šbodyï¼šæ¶ˆæ¯å†…å®¹ã€‚ messagePropertiesï¼šæ¶ˆæ¯å±æ€§ã€‚ 3.4 RabbitTemplate æ¶ˆæ¯æ¨¡æ¿RabbitTemplate æ˜¯ AmqpTemplate çš„ä¸€ä¸ªå®ç°ï¼ˆç›®å‰ä¸ºæ­¢ä¹Ÿæ˜¯å”¯ä¸€çš„å®ç°ï¼‰ï¼Œç”¨æ¥ç®€åŒ–æ¶ˆæ¯çš„æ”¶å‘ï¼Œæ”¯æŒæ¶ˆæ¯çš„ç¡®è®¤ï¼ˆConfirmï¼‰ä¸è¿”å›ï¼ˆReturnï¼‰ã€‚è·Ÿ JDBCTemplateä¸€ æ · ï¼Œ å®ƒ å° è£… äº† åˆ› å»º è¿ æ¥ ã€ åˆ› å»º æ¶ˆ æ¯ ä¿¡ é“ ã€ æ”¶ å‘ æ¶ˆ æ¯ ã€ æ¶ˆ æ¯ æ ¼ å¼ è½¬ æ¢ï¼ˆConvertAndSendâ†’Messageï¼‰ã€å…³é—­ä¿¡é“ã€å…³é—­è¿æ¥ç­‰ç­‰æ“ä½œã€‚ é’ˆå¯¹äºå¤šä¸ªæœåŠ¡å™¨è¿æ¥ï¼Œå¯ä»¥å®šä¹‰å¤šä¸ª Templateã€‚å¯ä»¥æ³¨å…¥åˆ°ä»»ä½•éœ€è¦æ”¶å‘æ¶ˆæ¯çš„åœ°æ–¹ä½¿ç”¨ã€‚ 123456789101112131415161718192021222324252627/** * return callback &amp;&amp; confirm callable * * @param factory * @return */@Beanpublic RabbitTemplate rabbitTemplate(ConnectionFactory factory) &#123; RabbitTemplate template = new RabbitTemplate(factory); template.setMandatory(true); template.setReturnCallback((Message message, int replyCode, String replyText, String exchange, String routingKey) -&gt; &#123; &#125;); template.setConfirmCallback((CorrelationData correlationData, boolean ack, String cause) -&gt; &#123; if (ack) &#123; log.info(&quot;æ¶ˆæ¯ç¡®è®¤æˆåŠŸï¼&quot;); &#125; else &#123; log.info(&quot;æ¶ˆæ¯ç¡®è®¤å¤±è´¥ï¼&quot;); &#125; &#125;); return template;&#125; 3.5 Messager Listener æ¶ˆæ¯ç›‘å¬MessageListenerMessageListener æ˜¯ Spring AMQP å¼‚æ­¥æ¶ˆæ¯æŠ•é€’çš„ç›‘å¬å™¨æ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ªæ–¹æ³•onMessageï¼Œç”¨äºå¤„ç†æ¶ˆæ¯é˜Ÿåˆ—æ¨é€æ¥çš„æ¶ˆæ¯ï¼Œä½œç”¨ç±»ä¼¼äº Java API ä¸­çš„ Consumerã€‚ MessageListenerContainerMessageListenerContainerå¯ä»¥ç†è§£ä¸ºMessageListenerçš„å®¹å™¨ï¼Œä¸€ä¸ªContaineråªæœ‰ä¸€ä¸ª Listenerï¼Œä½†æ˜¯å¯ä»¥ç”Ÿæˆå¤šä¸ªçº¿ç¨‹ä½¿ç”¨ç›¸åŒçš„ MessageListener åŒæ—¶æ¶ˆè´¹æ¶ˆæ¯ã€‚ Container å¯ä»¥ç®¡ç† Listener çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥ç”¨äºå¯¹äºæ¶ˆè´¹è€…è¿›è¡Œé…ç½®ã€‚ ä¾‹å¦‚ï¼šåŠ¨æ€æ·»åŠ ç§»é™¤é˜Ÿåˆ—ã€å¯¹æ¶ˆè´¹è€…è¿›è¡Œè®¾ç½®ï¼Œä¾‹å¦‚ ConsumerTagã€Argumentsã€å¹¶å‘ã€æ¶ˆè´¹è€…æ•°é‡ã€æ¶ˆæ¯ç¡®è®¤æ¨¡å¼ç­‰ç­‰ã€‚ 1234567891011121314151617181920212223/** * æ¶ˆæ¯ç›‘å¬å™¨å®¹å™¨ * @param connectionFactory * @return */@Beanpublic SimpleMessageListenerContainer messageContainer(ConnectionFactory connectionFactory) &#123; SimpleMessageListenerContainer container = new SimpleMessageListenerContainer(connectionFactory); //ç›‘å¬çš„é˜Ÿåˆ— container.setQueues(new Queue(QUEUE_NAME, true, false, false)); // æœ€å°æ¶ˆè´¹è€…æ•° container.setConcurrentConsumers(1); // æœ€å¤§çš„æ¶ˆè´¹è€…æ•°é‡ container.setMaxConcurrentConsumers(5); //æ˜¯å¦é‡å›é˜Ÿåˆ— container.setDefaultRequeueRejected(false); //ç­¾æ”¶æ¨¡å¼ container.setAcknowledgeMode(AcknowledgeMode.AUTO); container.setExposeListenerChannel(true); //æ¶ˆè´¹ç«¯çš„æ ‡ç­¾ç­–ç•¥ container.setConsumerTagStrategy(queue -&gt; queue + &quot;_&quot; + UUID.randomUUID().toString()); return container;&#125; åœ¨ SpringBoot2.0 ä¸­æ–°å¢äº†ä¸€ä¸ª DirectMessageListenerContainerã€‚ MessageListenerContainerFactory Spring å»æ•´åˆ IBM MQã€JMSã€Kafka ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„ã€‚ 1234567891011121314/** * * @param connectionFactory * @return */@Beanpublic SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(ConnectionFactory connectionFactory) &#123; SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory(); factory.setConnectionFactory(connectionFactory); factory.setMessageConverter(new Jackson2JsonMessageConverter()); factory.setAcknowledgeMode(AcknowledgeMode.NONE); factory.setAutoStartup(true); return factory;&#125; å¯ä»¥åœ¨æ¶ˆè´¹è€…ä¸ŠæŒ‡å®šï¼Œå½“æˆ‘ä»¬éœ€è¦ç›‘å¬å¤šä¸ª RabbitMQ çš„æœåŠ¡å™¨çš„æ—¶å€™ï¼ŒæŒ‡å®šä¸åŒçš„ MessageListenerContainerFactoryã€‚â€‹ 1234567891011@Slf4j@Component@PropertySource(&quot;classpath:application.properties&quot;)@RabbitListener(queues = &quot;$&#123;amqp.yhd.queue&#125;&quot;, containerFactory = &quot;rabbitListenerContainerFactory&quot;)public class FirstConsumer &#123; @RabbitHandler public void process(@Payload String message) &#123; log.info(&quot;First Queue received msg : &#123;&#125;&quot;, message); &#125;&#125; 3.6 è½¬æ¢å™¨ MessageConvertorMessageConvertor çš„ ä½œç”¨ï¼Ÿ RabbitMQ çš„æ¶ˆæ¯åœ¨ç½‘ç»œä¼ è¾“ä¸­éœ€è¦è½¬æ¢æˆ byte[]ï¼ˆå­—èŠ‚æ•°ç»„ï¼‰è¿›è¡Œå‘é€ï¼Œæ¶ˆè´¹è€…éœ€è¦å¯¹å­—èŠ‚æ•°ç»„è¿›è¡Œè§£æã€‚ åœ¨ Spring AMQP ä¸­ï¼Œæ¶ˆæ¯ä¼šè¢«å°è£…ä¸º org.springframework.amqp.core.Messageå¯¹è±¡ã€‚æ¶ˆæ¯çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå°±æ˜¯å¤„ç† Message çš„æ¶ˆæ¯ä½“ body å¯¹è±¡ã€‚ å¦‚æœæ¶ˆæ¯å·²ç»æ˜¯ byte[]æ ¼å¼ï¼Œå°±ä¸éœ€è¦è½¬æ¢ã€‚ å¦‚æœæ˜¯ Stringï¼Œä¼šè½¬æ¢æˆ byte[]ã€‚ å¦‚æœæ˜¯ Java å¯¹è±¡ï¼Œä¼šä½¿ç”¨ JDK åºåˆ—åŒ–å°†å¯¹è±¡è½¬æ¢ä¸º byte[]ï¼ˆä½“ç§¯å¤§ï¼Œæ•ˆç‡å·®ï¼‰ã€‚ åœ¨ è°ƒ ç”¨ RabbitTemplate çš„ convertAndSend() æ–¹ æ³• å‘ é€ æ¶ˆ æ¯ æ—¶ ï¼Œ ä¼š ä½¿ ç”¨MessageConvertor è¿›è¡Œæ¶ˆæ¯çš„åºåˆ—åŒ–ï¼Œé»˜è®¤ä½¿ç”¨ SimpleMessageConverterã€‚ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦é€‰æ‹©å…¶ä»–çš„é«˜æ•ˆçš„åºåˆ—åŒ–å·¥å…·ã€‚å¦‚æœæˆ‘ä»¬ä¸æƒ³åœ¨æ¯æ¬¡å‘é€æ¶ˆæ¯æ—¶è‡ªå·±å¤„ç†æ¶ˆæ¯ï¼Œå°±å¯ä»¥ç›´æ¥å®šä¹‰ä¸€ä¸ª MessageConvertorã€‚ 123456@Beanpublic RabbitTemplate rabbitTemplate(final ConnectionFactory connectionFactory) &#123; final RabbitTemplate rabbitTemplate = new RabbitTemplate(connectionFactory); rabbitTemplate.setMessageConverter(new Jackson2JsonMessageConverter()); return rabbitTemplate;&#125; MessageConvertor å¦‚ä½• å·¥ä½œï¼Ÿ è°ƒ ç”¨ äº† RabbitTemplate çš„ convertAndSend() æ–¹ æ³• æ—¶ ä¼š ä½¿ ç”¨ å¯¹ åº” çš„MessageConvertor è¿›è¡Œæ¶ˆæ¯çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ åºåˆ—åŒ–ï¼šObject â€”â€” Json â€”â€” Message(body) â€”â€” byte[] ååºåˆ—åŒ–ï¼šbyte[] â€”â€”Message â€”â€” Json â€”â€” Object æœ‰ å“ªäº› MessageConvertor ï¼Ÿ åœ¨ Spring ä¸­æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„è½¬æ¢å™¨ï¼šSimpleMessageConverterã€‚ Jackson2JsonMessageConverterï¼ˆRbbitMQ è‡ªå¸¦ï¼‰ï¼šå°†å¯¹è±¡è½¬æ¢ä¸º jsonï¼Œç„¶åå†è½¬æ¢æˆå­—èŠ‚æ•°ç»„è¿›è¡Œä¼ é€’ã€‚ å¦‚ä½• è‡ªå®šä¹‰ MessageConverter ï¼Ÿ ä¾‹å¦‚ï¼šæˆ‘ä»¬è¦ä½¿ç”¨ Gson æ ¼å¼åŒ–æ¶ˆæ¯ï¼š åˆ›å»ºä¸€ä¸ªç±»ï¼Œå®ç° MessageConverter æ¥å£ï¼Œé‡å†™ toMessage()å’Œ fromMessage()æ–¹æ³•ã€‚ 12toMessage(): Java å¯¹è±¡è½¬æ¢ä¸º MessagefromMessage(): Message å¯¹è±¡è½¬æ¢ä¸º Java å¯¹è±¡ 4.SpringBooté›†æˆRabbitMQä¸ºä»€ä¹ˆæ²¡æœ‰å®šä¹‰ Spring AMQP çš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿèƒ½å®ç°æ¶ˆæ¯çš„æ”¶å‘ï¼ŸSpring Boot åšäº†ä»€ä¹ˆï¼Ÿ è€å¥—è·¯ æºç ï¼šRabbitAutoConfigurationâ€‹","categories":[{"name":"æ¶ˆæ¯é˜Ÿåˆ—","slug":"æ¶ˆæ¯é˜Ÿåˆ—","permalink":"https://yinhuidong.github.io/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"}],"tags":[{"name":"RabbitMQ","slug":"RabbitMQ","permalink":"https://yinhuidong.github.io/tags/RabbitMQ/"}]},{"title":"Spring Data Jpaä½¿ç”¨ç¯‡","slug":"MyBatis/Spring Data Jpaä½¿ç”¨ç¯‡","date":"2022-01-11T06:37:31.534Z","updated":"2022-01-11T06:41:57.741Z","comments":true,"path":"2022/01/11/MyBatis/Spring Data Jpaä½¿ç”¨ç¯‡/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MyBatis/Spring%20Data%20Jpa%E4%BD%BF%E7%94%A8%E7%AF%87/","excerpt":"","text":"ä¸€ï¼Œormæ€æƒ³å’Œhibernateä»¥åŠjpa1.ormæ€æƒ³ ä¸»è¦ç›®çš„ï¼šæ“ä½œå®ä½“ç±»å°±ç›¸å½“äºæ“ä½œæ•°æ®åº“è¡¨ å»ºç«‹ä¸¤ä¸ªæ˜ å°„å…³ç³» `å®ä½“ç±»`å’Œ `è¡¨` å®ä½“ç±»ä¸­çš„å±æ€§ å’Œ è¡¨ä¸­å­—æ®µçš„æ˜ å°„å…³ç³» ä¸å†é‡ç‚¹å…³æ³¨ï¼š SQLè¯­å¥ å®ç°äº†ORMæ€æƒ³çš„æ¡†æ¶ï¼šmybatisï¼Œhibernate 2. hibernateæ¡†æ¶ä»‹ç»Hibernateæ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„å¯¹è±¡å…³ç³»æ˜ å°„æ¡†æ¶ï¼Œå®ƒå¯¹JDBCè¿›è¡Œäº†éå¸¸è½»é‡çº§çš„å¯¹è±¡å°è£…ï¼Œå®ƒå°†POJOä¸æ•°æ®åº“è¡¨å»ºç«‹æ˜ å°„å…³ç³»ï¼Œæ˜¯ä¸€ä¸ªå…¨è‡ªåŠ¨çš„ormæ¡†æ¶ï¼Œhibernateå¯ä»¥è‡ªåŠ¨ç”ŸæˆSQLè¯­å¥ï¼Œè‡ªåŠ¨æ‰§è¡Œï¼Œä½¿å¾—Javaç¨‹åºå‘˜å¯ä»¥éšå¿ƒæ‰€æ¬²çš„ä½¿ç”¨å¯¹è±¡ç¼–ç¨‹æ€ç»´æ¥æ“çºµæ•°æ®åº“ã€‚ 3.jpaè§„èŒƒ JPAçš„å…¨ç§°æ˜¯Java Persistence APIï¼Œ å³Java æŒä¹…åŒ–APIï¼Œæ˜¯SUNå…¬å¸æ¨å‡ºçš„ä¸€å¥—åŸºäºORMçš„è§„èŒƒï¼Œå†…éƒ¨æ˜¯ç”±ä¸€ç³»åˆ—çš„æ¥å£å’ŒæŠ½è±¡ç±»æ„æˆã€‚ JPAé€šè¿‡JDK 5.0æ³¨è§£æè¿°å¯¹è±¡ï¼å…³ç³»è¡¨çš„æ˜ å°„å…³ç³»ï¼Œå¹¶å°†è¿è¡ŒæœŸçš„å®ä½“å¯¹è±¡æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚ JPAä¸hibernateçš„å…³ç³» JPAå’ŒHibernateçš„å…³ç³»å°±åƒJDBCå’ŒJDBCé©±åŠ¨çš„å…³ç³»ï¼ŒJPAæ˜¯è§„èŒƒï¼ŒHibernateé™¤äº†ä½œä¸ºORMæ¡†æ¶ä¹‹å¤–ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ç§JPAå®ç°ã€‚JPAæ€ä¹ˆå–ä»£Hibernateå‘¢ï¼ŸJDBCè§„èŒƒå¯ä»¥é©±åŠ¨åº•å±‚æ•°æ®åº“å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½¿ç”¨JPAè§„èŒƒè¿›è¡Œæ•°æ®åº“æ“ä½œï¼Œåº•å±‚éœ€è¦hibernateä½œä¸ºå…¶å®ç°ç±»å®Œæˆæ•°æ®æŒä¹…åŒ–å·¥ä½œã€‚ 4.jpaçš„å…¥é—¨æ¡ˆä¾‹1.æ¡ˆä¾‹ï¼šæ˜¯å®¢æˆ·çš„ç›¸å…³æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰ å®¢æˆ·ï¼šå°±æ˜¯ä¸€å®¶å…¬å¸ 2.åˆ›å»ºé¡¹ç›®å¯¼å…¥ä¾èµ–123456789101112131415161718192021222324252627282930313233343536373839404142&lt;properties&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;project.hibernate.version&gt;5.0.7.Final&lt;/project.hibernate.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;!-- junit --&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.12&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;!-- hibernateå¯¹jpaçš„æ”¯æŒåŒ… --&gt; &lt;dependency&gt; &lt;groupId&gt;org.hibernate&lt;/groupId&gt; &lt;artifactId&gt;hibernate-entitymanager&lt;/artifactId&gt; &lt;version&gt;$&#123;project.hibernate.version&#125;&lt;/version&gt; &lt;/dependency&gt; &lt;!-- c3p0 --&gt; &lt;dependency&gt; &lt;groupId&gt;org.hibernate&lt;/groupId&gt; &lt;artifactId&gt;hibernate-c3p0&lt;/artifactId&gt; &lt;version&gt;$&#123;project.hibernate.version&#125;&lt;/version&gt; &lt;/dependency&gt; &lt;!-- logæ—¥å¿— --&gt; &lt;dependency&gt; &lt;groupId&gt;log4j&lt;/groupId&gt; &lt;artifactId&gt;log4j&lt;/artifactId&gt; &lt;version&gt;1.2.17&lt;/version&gt; &lt;/dependency&gt; &lt;!-- Mysql and MariaDB --&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;5.1.6&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; 3.é…ç½®æ–‡ä»¶ä½ç½®ï¼šé…ç½®åˆ°ç±»è·¯å¾„ä¸‹çš„ä¸€ä¸ªå«åš META-INF çš„æ–‡ä»¶å¤¹ä¸‹å‘½åï¼špersistence.xml 12345678910111213141516171819202122232425262728293031323334&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;persistence xmlns=&quot;http://java.sun.com/xml/ns/persistence&quot; version=&quot;2.0&quot;&gt; &lt;!--é…ç½®æŒä¹…åŒ–å•å…ƒ nameï¼šæŒä¹…åŒ–å•å…ƒåç§° transaction-typeï¼šäº‹åŠ¡ç±»å‹ RESOURCE_LOCALï¼šæœ¬åœ°äº‹åŠ¡ç®¡ç† JTAï¼šåˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç† --&gt; &lt;persistence-unit name=&quot;myJpa&quot; transaction-type=&quot;RESOURCE_LOCAL&quot;&gt; &lt;!--é…ç½®JPAè§„èŒƒçš„æœåŠ¡æä¾›å•† --&gt; &lt;provider&gt;org.hibernate.jpa.HibernatePersistenceProvider&lt;/provider&gt; &lt;properties&gt; &lt;!-- æ•°æ®åº“é©±åŠ¨ --&gt; &lt;property name=&quot;javax.persistence.jdbc.driver&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt; &lt;!-- æ•°æ®åº“åœ°å€ --&gt; &lt;property name=&quot;javax.persistence.jdbc.url&quot; value=&quot;jdbc:mysql://localhost:3306/jpa&quot;/&gt; &lt;!-- æ•°æ®åº“ç”¨æˆ·å --&gt; &lt;property name=&quot;javax.persistence.jdbc.user&quot; value=&quot;root&quot;/&gt; &lt;!-- æ•°æ®åº“å¯†ç  --&gt; &lt;property name=&quot;javax.persistence.jdbc.password&quot; value=&quot;root&quot;/&gt; &lt;!--jpaæä¾›è€…çš„å¯é€‰é…ç½®ï¼šæˆ‘ä»¬çš„JPAè§„èŒƒçš„æä¾›è€…ä¸ºhibernateï¼Œæ‰€ä»¥jpaçš„æ ¸å¿ƒé…ç½®ä¸­å…¼å®¹hibernateçš„é… --&gt; &lt;!--æ˜¾ç¤ºsqlè¯­å¥--&gt; &lt;property name=&quot;hibernate.show_sql&quot; value=&quot;true&quot;/&gt; &lt;property name=&quot;hibernate.format_sql&quot; value=&quot;true&quot;/&gt; &lt;!-- å»ºè¡¨æ–¹å¼ create:æ¯æ¬¡æ‰§è¡Œéƒ½åˆ›å»ºè¡¨ update:æ²¡æœ‰è¡¨æ‰åˆ›å»º none:ä¸åˆ›å»ºè¡¨ --&gt; &lt;property name=&quot;hibernate.hbm2ddl.auto&quot; value=&quot;update&quot;/&gt; &lt;/properties&gt; &lt;/persistence-unit&gt;&lt;/persistence&gt; 4.å®ä½“ç±»123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107/** * @author yinhuidong * @createTime 2020-06-01-21:43 *///ä½œç”¨ï¼šæŒ‡å®šå½“å‰ç±»æ˜¯å®ä½“ç±»ã€‚@Entity/** * ä½œç”¨ï¼šæŒ‡å®šå®ä½“ç±»å’Œè¡¨ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚ * å±æ€§ï¼š * nameï¼šæŒ‡å®šæ•°æ®åº“è¡¨çš„åç§° */@Table(name = &quot;t_person&quot;)public class Person &#123; //ä½œç”¨ï¼šæŒ‡å®šå½“å‰å­—æ®µæ˜¯ä¸»é”®ã€‚ /** * @Id * ä½œç”¨ï¼šæŒ‡å®šä¸»é”®çš„ç”Ÿæˆæ–¹å¼ã€‚ã€‚ * å±æ€§ï¼š * strategy ï¼šæŒ‡å®šä¸»é”®ç”Ÿæˆç­–ç•¥ã€‚ */ @GeneratedValue(strategy = GenerationType.IDENTITY) /** * @Column * ä½œç”¨ï¼šæŒ‡å®šå®ä½“ç±»å±æ€§å’Œæ•°æ®åº“è¡¨ä¹‹é—´çš„å¯¹åº”å…³ç³» * å±æ€§ï¼š * nameï¼šæŒ‡å®šæ•°æ®åº“è¡¨çš„åˆ—åç§°ã€‚ * uniqueï¼šæ˜¯å¦å”¯ä¸€ * nullableï¼šæ˜¯å¦å¯ä»¥ä¸ºç©º * inserttableï¼šæ˜¯å¦å¯ä»¥æ’å…¥ * updateableï¼šæ˜¯å¦å¯ä»¥æ›´æ–° * columnDefinition: å®šä¹‰å»ºè¡¨æ—¶åˆ›å»ºæ­¤åˆ—çš„DDL * secondaryTable: ä»è¡¨åã€‚å¦‚æœæ­¤åˆ—ä¸å»ºåœ¨ä¸»è¡¨ä¸Šï¼ˆé»˜è®¤å»ºåœ¨ä¸»è¡¨ï¼‰ï¼Œ * è¯¥å±æ€§å®šä¹‰è¯¥åˆ—æ‰€åœ¨ä»è¡¨çš„åå­—æ­å»ºå¼€å‘ç¯å¢ƒ[é‡ç‚¹] */ @Column(name = &quot;id&quot;) private Integer id; @Column(name = &quot;p_name&quot;) private String name; @Column(name = &quot;p_age&quot;) private Integer age; @Column(name = &quot;p_email&quot;) private String email; @Column(name = &quot;p_birth&quot;) private Date birth; public Person() &#123; &#125; public Person(Integer id, String name, Integer age, String email, Date birth) &#123; this.id = id; this.name = name; this.age = age; this.email = email; this.birth = birth; &#125; public Integer getId() &#123; return id; &#125; public void setId(Integer id) &#123; this.id = id; &#125; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125; public Integer getAge() &#123; return age; &#125; public void setAge(Integer age) &#123; this.age = age; &#125; public String getEmail() &#123; return email; &#125; public void setEmail(String email) &#123; this.email = email; &#125; public Date getBirth() &#123; return birth; &#125; public void setBirth(Date birth) &#123; this.birth = birth; &#125; @Override public String toString() &#123; return &quot;Person&#123;&quot; + &quot;id=&quot; + id + &quot;, name=&#x27;&quot; + name + &#x27;\\&#x27;&#x27; + &quot;, age=&quot; + age + &quot;, email=&#x27;&quot; + email + &#x27;\\&#x27;&#x27; + &quot;, birth=&quot; + birth + &#x27;&#125;&#x27;; &#125;&#125; 5.æµ‹è¯•ç±»jpaæ“ä½œçš„æ“ä½œæ­¥éª¤12345678910111213141516171819202122232425262728293031323334351.åŠ è½½é…ç½®æ–‡ä»¶åˆ›å»ºå®ä½“ç®¡ç†å™¨å·¥å‚ Persisitenceï¼šé™æ€æ–¹æ³•ï¼ˆæ ¹æ®æŒä¹…åŒ–å•å…ƒåç§°åˆ›å»ºå®ä½“ç®¡ç†å™¨å·¥å‚ï¼‰ createEntityMnagerFactoryï¼ˆæŒä¹…åŒ–å•å…ƒåç§°ï¼‰ ä½œç”¨ï¼šåˆ›å»ºå®ä½“ç®¡ç†å™¨å·¥å‚2.æ ¹æ®å®ä½“ç®¡ç†å™¨å·¥å‚ï¼Œåˆ›å»ºå®ä½“ç®¡ç†å™¨ EntityManagerFactory ï¼šè·å–EntityManagerå¯¹è±¡ æ–¹æ³•ï¼šcreateEntityManager * å†…éƒ¨ç»´æŠ¤çš„å¾ˆå¤šçš„å†…å®¹ å†…éƒ¨ç»´æŠ¤äº†æ•°æ®åº“ä¿¡æ¯ï¼Œ ç»´æŠ¤äº†ç¼“å­˜ä¿¡æ¯ ç»´æŠ¤äº†æ‰€æœ‰çš„å®ä½“ç®¡ç†å™¨å¯¹è±¡ å†åˆ›å»ºEntityManagerFactoryçš„è¿‡ç¨‹ä¸­ä¼šæ ¹æ®é…ç½®åˆ›å»ºæ•°æ®åº“è¡¨ * EntityManagerFactoryçš„åˆ›å»ºè¿‡ç¨‹æ¯”è¾ƒæµªè´¹èµ„æº ç‰¹ç‚¹ï¼šçº¿ç¨‹å®‰å…¨çš„å¯¹è±¡ å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªEntityManagerFactoryä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ * å¦‚ä½•è§£å†³EntityManagerFactoryçš„åˆ›å»ºè¿‡ç¨‹æµªè´¹èµ„æºï¼ˆè€—æ—¶ï¼‰çš„é—®é¢˜ï¼Ÿ æ€è·¯ï¼šåˆ›å»ºä¸€ä¸ªå…¬å…±çš„EntityManagerFactoryçš„å¯¹è±¡ * é™æ€ä»£ç å—çš„å½¢å¼åˆ›å»ºEntityManagerFactory3.åˆ›å»ºäº‹åŠ¡å¯¹è±¡ï¼Œå¼€å¯äº‹åŠ¡ EntityManagerå¯¹è±¡ï¼šå®ä½“ç±»ç®¡ç†å™¨ beginTransaction : åˆ›å»ºäº‹åŠ¡å¯¹è±¡ presist ï¼š ä¿å­˜ merge ï¼š æ›´æ–° remove ï¼š åˆ é™¤ find/getRefrence ï¼š æ ¹æ®idæŸ¥è¯¢ Transaction å¯¹è±¡ ï¼š äº‹åŠ¡ beginï¼šå¼€å¯äº‹åŠ¡ commitï¼šæäº¤äº‹åŠ¡ rollbackï¼šå›æ»š4.å¢åˆ æ”¹æŸ¥æ“ä½œ5.æäº¤äº‹åŠ¡6.é‡Šæ”¾èµ„æº æµ‹è¯•12345678910@Testpublic void testSave()&#123; EntityManagerFactory factory = Persistence.createEntityManagerFactory(&quot;myJpa&quot;); EntityManager em = factory.createEntityManager(); EntityTransaction tx = em.getTransaction(); tx.begin(); Person person = new Person(null,&quot;aaa&quot;,22,&quot;aaa@163.com&quot;,new Date()); em.persist(person); tx.commit();&#125; 5.ä¸»é”®ç”Ÿæˆç­–ç•¥@GeneratedValue:é…ç½®ä¸»é”®çš„ç”Ÿæˆç­–ç•¥strategyGenerationType.IDENTITY ï¼šè‡ªå¢ï¼Œmysqlåº•å±‚æ•°æ®åº“å¿…é¡»æ”¯æŒè‡ªåŠ¨å¢é•¿ï¼ˆåº•å±‚æ•°æ®åº“æ”¯æŒçš„è‡ªåŠ¨å¢é•¿æ–¹å¼ï¼Œå¯¹idè‡ªå¢ï¼‰GenerationType.SEQUENCE : åºåˆ—ï¼Œoracleåº•å±‚æ•°æ®åº“å¿…é¡»æ”¯æŒåºåˆ—GenerationType.TABLE : jpaæä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œé€šè¿‡ä¸€å¼ æ•°æ®åº“è¡¨çš„å½¢å¼å¸®åŠ©æˆ‘ä»¬å®Œæˆä¸»é”®è‡ªå¢GenerationType.AUTO ï¼š ç”±ç¨‹åºè‡ªåŠ¨çš„å¸®åŠ©æˆ‘ä»¬é€‰æ‹©ä¸»é”®ç”Ÿæˆç­–ç•¥ 6.JPAçš„APIä»‹ç»1.Persistenceå¯¹è±¡Persistenceå¯¹è±¡ä¸»è¦ä½œç”¨æ˜¯ç”¨äºè·å–EntityManagerFactoryå¯¹è±¡çš„ ã€‚é€šè¿‡è°ƒç”¨è¯¥ç±»çš„createEntityManagerFactoryé™æ€æ–¹æ³•ï¼Œæ ¹æ®é…ç½®æ–‡ä»¶ä¸­æŒä¹…åŒ–å•å…ƒåç§°åˆ›å»ºEntityManagerFactoryã€‚ 1EntityManagerFactory factory = Persistence.createEntityManagerFactory(&quot;myJpa&quot;); 2.EntityManagerFactoryEntityManagerFactory æ¥å£ä¸»è¦ç”¨æ¥åˆ›å»º EntityManager å®ä¾‹ 1EntityManager em = factory.createEntityManager(); ç”±äºEntityManagerFactory æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å¯¹è±¡ï¼ˆå³å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªEntityManagerFactory å¯¹è±¡ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼‰ï¼Œå¹¶ä¸”EntityManagerFactory çš„åˆ›å»ºæå…¶æµªè´¹èµ„æºï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨JPAç¼–ç¨‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹EntityManagerFactory çš„åˆ›å»ºè¿›è¡Œä¼˜åŒ–ï¼Œåªéœ€è¦åšåˆ°ä¸€ä¸ªå·¥ç¨‹åªå­˜åœ¨ä¸€ä¸ªEntityManagerFactory å³å¯ã€‚ 3. EntityManageråœ¨ JPA è§„èŒƒä¸­,EntityManageræ˜¯å®ŒæˆæŒä¹…åŒ–æ“ä½œçš„æ ¸å¿ƒå¯¹è±¡ã€‚å®ä½“ç±»ä½œä¸ºæ™®é€š javaå¯¹è±¡ï¼Œåªæœ‰åœ¨è°ƒç”¨ EntityManagerå°†å…¶æŒä¹…åŒ–åæ‰ä¼šå˜æˆæŒä¹…åŒ–å¯¹è±¡ã€‚EntityManagerå¯¹è±¡åœ¨ä¸€ç»„å®ä½“ç±»ä¸åº•å±‚æ•°æ®æºä¹‹é—´è¿›è¡Œ O/R æ˜ å°„çš„ç®¡ç†ã€‚å®ƒå¯ä»¥ç”¨æ¥ç®¡ç†å’Œæ›´æ–° Entity Bean, æ ¹æ¤ä¸»é”®æŸ¥æ‰¾ Entity Bean, è¿˜å¯ä»¥é€šè¿‡JPQLè¯­å¥æŸ¥è¯¢å®ä½“ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨EntityManagerçš„æ–¹æ³•å®Œæˆè·å–äº‹åŠ¡ï¼Œä»¥åŠæŒä¹…åŒ–æ•°æ®åº“çš„æ“ä½œ 12345getTransaction : è·å–äº‹åŠ¡å¯¹è±¡persist ï¼š ä¿å­˜æ“ä½œmerge ï¼š æ›´æ–°æ“ä½œremove ï¼š åˆ é™¤æ“ä½œfind/getReference ï¼š æ ¹æ®idæŸ¥è¯¢ 4.EntityTransactionåœ¨ JPA è§„èŒƒä¸­, EntityTransactionæ˜¯å®Œæˆäº‹åŠ¡æ“ä½œçš„æ ¸å¿ƒå¯¹è±¡ï¼Œå¯¹äºEntityTransactionåœ¨æˆ‘ä»¬çš„javaä»£ç ä¸­æ‰¿æ¥çš„åŠŸèƒ½æ¯”è¾ƒç®€å• 123beginï¼šå¼€å¯äº‹åŠ¡commitï¼šæäº¤äº‹åŠ¡rollbackï¼šå›æ»šäº‹åŠ¡ 7. æŠ½å–JPAUtilå·¥å…·ç±»1234567891011121314151617/** * @author yinhuidong * @createTime 2020-06-02-0:13 */public class JpaUtils &#123; private static EntityManagerFactory factory; static &#123; factory = Persistence.createEntityManagerFactory(&quot;myJpa&quot;); &#125; public static EntityManager getEm()&#123; return factory.createEntityManager(); &#125;&#125; 8. ä½¿ç”¨JPAå®Œæˆå¢åˆ æ”¹æŸ¥æ“ä½œ1.ä¿å­˜1234567891011121314/** * æ·»åŠ  */@Testpublic void testSave()&#123; EntityManager em = JpaUtils.getEm(); EntityTransaction tx = em.getTransaction(); tx.begin(); Person person = new Person(null,&quot;aaa&quot;,22,&quot;aaa@163.com&quot;,new Date()); em.persist(person); tx.commit(); em.close();&#125; 2.åˆ é™¤12345678910111213/** * åˆ é™¤ï¼šremove */ @Test public void testRemove()&#123; EntityManager em = JpaUtils.getEm(); EntityTransaction tx = em.getTransaction(); tx.begin(); Person person = em.getReference(Person.class, 1); em.remove(person); tx.commit(); em.close(); &#125; 3.æ›´æ–°12345678910111213/** * æ›´æ–°:merge */@Testpublic void testmerge()&#123; EntityManager em = JpaUtils.getEm(); EntityTransaction tx = em.getTransaction(); tx.begin(); Person person = new Person(1,&quot;bbb&quot;,22,&quot;aaa@163.com&quot;,new Date()); em.merge(person); tx.commit(); em.close();&#125; 4.æ ¹æ®IDæŸ¥è¯¢1ï¼‰ç«‹å³åŠ è½½1234567891011/** * æŸ¥è¯¢:find * ç«‹å³åŠ è½½ï¼Œæ‰§è¡Œfind()ç«‹åˆ»å‘å‡ºsql */@Testpublic void testFind()&#123; EntityManager em = JpaUtils.getEm(); Person person = em.find(Person.class, 1); System.out.println(person); em.close();&#125; 2ï¼‰æ‡’åŠ è½½123456789101112/** * æŸ¥è¯¢ï¼šgetReference * æ‡’åŠ è½½æœºåˆ¶ï¼Œä»€ä¹ˆæ—¶å€™è°ƒç”¨æŸ¥è¯¢ç»“æœä»€ä¹ˆæ—¶å€™å‘å‡ºsqlè¯­å¥ * å¾—åˆ°çš„æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡ */@Testpublic void testgetReference()&#123; EntityManager em = JpaUtils.getEm(); Person person = em.getReference(Person.class, 1); System.out.println(person); em.close();&#125; 5.å¤æ‚æŸ¥è¯¢JPQLå…¨ç§°Java Persistence Query Language 123JavaæŒä¹…åŒ–æŸ¥è¯¢è¯­è¨€(JPQL)æ˜¯ä¸€ç§å¯ç§»æ¤çš„æŸ¥è¯¢è¯­è¨€ï¼Œæ—¨åœ¨ä»¥é¢å‘å¯¹è±¡è¡¨è¾¾å¼è¯­è¨€çš„è¡¨è¾¾å¼ï¼Œå°†SQLè¯­æ³•å’Œç®€å•æŸ¥è¯¢è¯­ä¹‰ç»‘å®šåœ¨ä¸€èµ·Â·ä½¿ç”¨è¿™ç§è¯­è¨€ç¼–å†™çš„æŸ¥è¯¢æ˜¯å¯ç§»æ¤çš„ï¼Œå¯ä»¥è¢«ç¼–è¯‘æˆæ‰€æœ‰ä¸»æµæ•°æ®åº“æœåŠ¡å™¨ä¸Šçš„SQLã€‚å…¶ç‰¹å¾ä¸åŸç”ŸSQLè¯­å¥ç±»ä¼¼ï¼Œå¹¶ä¸”å®Œå…¨é¢å‘å¯¹è±¡ï¼Œé€šè¿‡ç±»åå’Œå±æ€§è®¿é—®ï¼Œè€Œä¸æ˜¯è¡¨åå’Œè¡¨çš„å±æ€§ 1)æŸ¥è¯¢å…¨éƒ¨1234567891011/** * æŸ¥è¯¢æ‰€æœ‰ */@Testpublic void test1()&#123; EntityManager em = JpaUtils.getEm(); String jpql =&quot;from Person&quot;; Query query = em.createQuery(jpql); query.getResultList().forEach(System.out::println); em.close();&#125; 2ï¼‰åˆ†é¡µæŸ¥è¯¢12345678910111213/** * åˆ†é¡µæŸ¥è¯¢ */@Testpublic void test1()&#123; EntityManager em = JpaUtils.getEm(); String jpql =&quot;from Person&quot;; Query query = em.createQuery(jpql); query.setFirstResult(0); query.setMaxResults(2); query.getResultList().forEach(System.out::println); em.close();&#125; 3ï¼‰æ¡ä»¶æŸ¥è¯¢1234567891011121314/** * æ¡ä»¶æŸ¥è¯¢ */@Testpublic void test1()&#123; EntityManager em = JpaUtils.getEm(); String jpql =&quot;from Person where name like ?&quot;; Query query = em.createQuery(jpql); query.setParameter(1,&quot;aa%&quot;); //è·å–å”¯ä¸€ç»“æœé›† //System.out.println(query.getSingleResult()); query.getResultList().forEach(System.out::println); em.close();&#125; 4ï¼‰æ’åºæŸ¥è¯¢1234567891011/** * æ’åºæŸ¥è¯¢ */@Testpublic void test1()&#123; EntityManager em = JpaUtils.getEm(); String jpql =&quot;from Person order by id desc&quot;; Query query = em.createQuery(jpql); query.getResultList().forEach(System.out::println); em.close();&#125; 5ï¼‰ç»Ÿè®¡æŸ¥è¯¢1234567891011/** * ç»Ÿè®¡æŸ¥è¯¢ */@Testpublic void test1()&#123; EntityManager em = JpaUtils.getEm(); String jpql =&quot;select count(id) from Person&quot;; Query query = em.createQuery(jpql); System.out.println(query.getSingleResult()); em.close();&#125; äºŒï¼Œspringdatajpaçš„è¿è¡ŒåŸç†ä»¥åŠåŸºæœ¬æ“ä½œ1.springDataJpaæ¦‚è¿°1.1SpringDataJpaæ¦‚è¿°Spring Data JPA æ˜¯ Spring åŸºäº ORM æ¡†æ¶ã€JPA è§„èŒƒçš„åŸºç¡€ä¸Šå°è£…çš„ä¸€å¥—JPAåº”ç”¨æ¡†æ¶ï¼Œå¯ä½¿å¼€å‘è€…ç”¨æç®€çš„ä»£ç å³å¯å®ç°å¯¹æ•°æ®åº“çš„è®¿é—®å’Œæ“ä½œã€‚å®ƒæä¾›äº†åŒ…æ‹¬å¢åˆ æ”¹æŸ¥ç­‰åœ¨å†…çš„å¸¸ç”¨åŠŸèƒ½ï¼Œä¸”æ˜“äºæ‰©å±•ï¼å­¦ä¹ å¹¶ä½¿ç”¨ Spring Data JPA å¯ä»¥æå¤§æé«˜å¼€å‘æ•ˆç‡ï¼ Spring Data JPA è®©æˆ‘ä»¬è§£è„±äº†DAOå±‚çš„æ“ä½œï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰CRUDéƒ½å¯ä»¥ä¾èµ–äºå®ƒæ¥å®ç°,åœ¨å®é™…çš„å·¥ä½œå·¥ç¨‹ä¸­ï¼Œæ¨èä½¿ç”¨Spring Data JPA + ORMï¼ˆå¦‚ï¼šhibernateï¼‰å®Œæˆæ“ä½œï¼Œè¿™æ ·åœ¨åˆ‡æ¢ä¸åŒçš„ORMæ¡†æ¶æ—¶æä¾›äº†æå¤§çš„æ–¹ä¾¿ï¼ŒåŒæ—¶ä¹Ÿä½¿æ•°æ®åº“å±‚æ“ä½œæ›´åŠ ç®€å•ï¼Œæ–¹ä¾¿è§£è€¦ 1.2springdatajpaçš„ç‰¹æ€§SpringData Jpa æå¤§ç®€åŒ–äº†æ•°æ®åº“è®¿é—®å±‚ä»£ç ã€‚ å¦‚ä½•ç®€åŒ–çš„å‘¢ï¼Ÿ ä½¿ç”¨äº†SpringDataJpaï¼Œæˆ‘ä»¬çš„daoå±‚ä¸­åªéœ€è¦å†™æ¥å£ï¼Œå°±è‡ªåŠ¨å…·æœ‰äº†å¢åˆ æ”¹æŸ¥ã€åˆ†é¡µæŸ¥è¯¢ç­‰æ–¹æ³•ã€‚ 1.3Spring Data JPA ä¸ JPAå’Œhibernateä¹‹é—´çš„å…³ç³»JPAæ˜¯ä¸€å¥—è§„èŒƒï¼Œå†…éƒ¨æ˜¯æœ‰æ¥å£å’ŒæŠ½è±¡ç±»ç»„æˆçš„ã€‚hibernateæ˜¯ä¸€å¥—æˆç†Ÿçš„ORMæ¡†æ¶ï¼Œè€Œä¸”Hibernateå®ç°äº†JPAè§„èŒƒï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç§°hibernateä¸ºJPAçš„ä¸€ç§å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬ä½¿ç”¨JPAçš„APIç¼–ç¨‹ï¼Œæ„å‘³ç€ç«™åœ¨æ›´é«˜çš„è§’åº¦ä¸Šçœ‹å¾…é—®é¢˜ï¼ˆé¢å‘æ¥å£ç¼–ç¨‹ï¼‰ Spring Data JPAæ˜¯Springæä¾›çš„ä¸€å¥—å¯¹JPAæ“ä½œæ›´åŠ é«˜çº§çš„å°è£…ï¼Œæ˜¯åœ¨JPAè§„èŒƒä¸‹çš„ä¸“é—¨ç”¨æ¥è¿›è¡Œæ•°æ®æŒä¹…åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚ 2.SpringDataJpaå¿«é€Ÿå…¥é—¨2.1éœ€æ±‚è¯´æ˜Spring Data JPAå®Œæˆå®¢æˆ·çš„åŸºæœ¬CRUDæ“ä½œ 2.2æ­å»ºç¯å¢ƒé¡¹ç›®ä¾èµ–1234567891011121314151617181920212223242526272829303132&lt;!--hibernate--&gt;&lt;dependency&gt; &lt;groupId&gt;org.hibernate&lt;/groupId&gt; &lt;artifactId&gt;hibernate-core&lt;/artifactId&gt; &lt;version&gt;5.4.15.Final&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.hibernate&lt;/groupId&gt; &lt;artifactId&gt;hibernate-entitymanager&lt;/artifactId&gt; &lt;version&gt;5.0.7.Final&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.hibernate&lt;/groupId&gt; &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt; &lt;version&gt;5.3.6.Final&lt;/version&gt;&lt;/dependency&gt;&lt;!--springdatajpa--&gt;&lt;dependency&gt; &lt;groupId&gt;javax.el&lt;/groupId&gt; &lt;artifactId&gt;javax.el-api&lt;/artifactId&gt; &lt;version&gt;2.2.4&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.glassfish.web&lt;/groupId&gt; &lt;artifactId&gt;javax.el&lt;/artifactId&gt; &lt;version&gt;2.2.4&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.data&lt;/groupId&gt; &lt;artifactId&gt;spring-data-jpa&lt;/artifactId&gt; &lt;version&gt;2.3.0.RELEASE&lt;/version&gt;&lt;/dependency&gt; Springæ•´åˆSpringDataJPA1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:jdbc=&quot;http://www.springframework.org/schema/jdbc&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xmlns:jpa=&quot;http://www.springframework.org/schema/data/jpa&quot; xmlns:task=&quot;http://www.springframework.org/schema/task&quot; xsi:schemaLocation=&quot; http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd&quot;&gt;&lt;!--ç»„ä»¶æ‰«æ--&gt; &lt;context:component-scan base-package=&quot;com.example&quot;&gt; &lt;!-- é…ç½®è¦å¿½ç•¥çš„æ³¨è§£ --&gt; &lt;context:exclude-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot;/&gt; &lt;/context:component-scan&gt; &lt;!--Springæ•´åˆMyBatis--&gt; &lt;!--é…ç½®æ•°æ®æº--&gt; &lt;!--å¼•å…¥å¤–éƒ¨å±æ€§æ–‡ä»¶--&gt; &lt;context:property-placeholder location=&quot;classpath:jdbc.properties&quot;/&gt; &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt; &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot;/&gt; &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot;/&gt; &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot;/&gt; &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;jdbc.DriverName&#125;&quot;/&gt; &lt;/bean&gt; &lt;!--é…ç½®äº‹åŠ¡ç®¡ç†å™¨--&gt; &lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;&gt; &lt;property name=&quot;entityManagerFactory&quot; ref=&quot;entityManagerFactory&quot;/&gt; &lt;/bean&gt; &lt;jpa:repositories base-package=&quot;com.example.mapper&quot; transaction-manager-ref=&quot;transactionManager&quot; entity-manager-factory-ref=&quot;entityManagerFactory&quot;&gt;&lt;/jpa:repositories&gt; &lt;!--äº‹åŠ¡ç®¡ç†--&gt; &lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;transactionManager&quot;&gt; &lt;tx:attributes&gt; &lt;tx:method name=&quot;save*&quot; propagation=&quot;REQUIRED&quot;/&gt; &lt;tx:method name=&quot;insert*&quot; propagation=&quot;REQUIRED&quot;/&gt; &lt;tx:method name=&quot;update*&quot; propagation=&quot;REQUIRED&quot;/&gt; &lt;tx:method name=&quot;delete*&quot; propagation=&quot;REQUIRED&quot;/&gt; &lt;tx:method name=&quot;get*&quot; read-only=&quot;true&quot;/&gt; &lt;tx:method name=&quot;find*&quot; read-only=&quot;true&quot;/&gt; &lt;tx:method name=&quot;*&quot; propagation=&quot;REQUIRED&quot;/&gt; &lt;/tx:attributes&gt; &lt;/tx:advice&gt; &lt;aop:config&gt; &lt;!--é…ç½®åˆ‡å…¥ç‚¹è¡¨è¾¾å¼--&gt; &lt;aop:pointcut id=&quot;my&quot; expression=&quot;execution(* com.example.service.impl.*.* (..))&quot;&gt;&lt;/aop:pointcut&gt; &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut-ref=&quot;my&quot;&gt;&lt;/aop:advisor&gt; &lt;/aop:config&gt; &lt;bean id=&quot;entityManagerFactory&quot; class=&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;&gt;&lt;/property&gt; &lt;property name=&quot;packagesToScan&quot; value=&quot;com.example.domain&quot;&gt;&lt;/property&gt; &lt;property name=&quot;persistenceProvider&quot;&gt; &lt;bean class=&quot;org.hibernate.jpa.HibernatePersistenceProvider&quot;/&gt; &lt;/property&gt; &lt;!--jpaçš„ä¾›åº”å•†é€‚é…å™¨--&gt; &lt;property name=&quot;jpaVendorAdapter&quot;&gt; &lt;bean class=&quot;org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter&quot;&gt; &lt;property name=&quot;generateDdl&quot; value=&quot;false&quot;&gt;&lt;/property&gt; &lt;property name=&quot;database&quot; value=&quot;MYSQL&quot;&gt;&lt;/property&gt; &lt;property name=&quot;databasePlatform&quot; value=&quot;org.hibernate.dialect.MySQLDialect&quot;&gt;&lt;/property&gt; &lt;property name=&quot;showSql&quot; value=&quot;true&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;/property&gt; &lt;property name=&quot;jpaDialect&quot;&gt; &lt;bean class=&quot;org.springframework.orm.jpa.vendor.HibernateJpaDialect&quot;&gt;&lt;/bean&gt; &lt;/property&gt; &lt;/bean&gt;&lt;/beans&gt; å…³è”æ˜ å°„å®ä½“ç±»1234567891011121314151617@Entity@Table(name = &quot;t_person&quot;)public class Person &#123; @Id @GeneratedValue(strategy = IDENTITY) @Column(name = &quot;id&quot;) private Long id; @Column(name = &quot;p_name&quot;) private String name; @Column(name = &quot;p_age&quot;) private Integer age; @Column(name = &quot;p_email&quot;) private String email; @Column(name = &quot;p_birth&quot;) private Date birth;&#125; mapperæ¥å£12345678/** * @author yinhuidong * @createTime 2020-06-04-15:46 * JpaRepository&lt;Person, Long&gt; ç”¨æ¥å®ŒæˆåŸºæœ¬CRUD * JpaSpecificationExecutor&lt;Person&gt; ç”¨æ¥å®Œæˆå¤æ‚æŸ¥è¯¢ */public interface PersonMapper extends JpaRepository&lt;Person, Long&gt;, JpaSpecificationExecutor&lt;Person&gt; &#123;&#125; æµ‹è¯•ç±»123456789101112131415161718192021222324252627282930313233343536373839404142@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration(locations = &quot;classpath:applicationContext.xml&quot;)public class TestCRUD &#123; @Autowired private PersonMapper mapper; //ä¿å­˜æ“ä½œ @Test public void testSave()&#123; mapper.save(new Person(&quot;aaa&quot;,20,&quot;aaa@qq.com&quot;,new Date())); &#125; /** * ä¿®æ”¹æ“ä½œï¼š * ä¿®æ”¹ä¸ä¿å­˜å…±ç”¨ä¸€ä¸ªæ–¹æ³•save * å½“ä¼ å…¥çš„å®ä½“ç±»æœ‰ä¸»é”®å°±æ˜¯ä¿®æ”¹ï¼Œæ²¡æœ‰ä¸»é”®å°±æ˜¯ä¿å­˜ */ @Test public void testUpdate()&#123; Person person = new Person(&quot;aaa&quot;,20,&quot;bbb@qq.com&quot;,new Date()); person.setId(8l); mapper.save(person); &#125; //åˆ é™¤ @Test public void testDelete()&#123; Person person = new Person(&quot;aaa&quot;,20,&quot;bbb@qq.com&quot;,new Date()); person.setId(8l); mapper.delete(person); &#125; //æ ¹æ®IDæŸ¥è¯¢ @Test public void testFindById()&#123; System.out.println(mapper.findById(7l).get()); &#125; //æŸ¥è¯¢æ‰€æœ‰ @Test public void testFindAll()&#123; mapper.findAll().forEach(System.out::println); &#125;&#125; 3.SpringDataJPAçš„åº•å±‚ä»£ç åˆ†æ3.1å¸¸ç”¨æ¥å£åˆ†æåœ¨è‡ªå®šä¹‰mapperæ¥å£ä¸­ï¼Œå¹¶æ²¡æœ‰æä¾›ä»»ä½•æ–¹æ³•å°±å¯ä»¥ä½¿ç”¨å…¶ä¸­çš„æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™äº›æ–¹æ³•ç©¶ç«Ÿæ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿï¼Œç”±äºæˆ‘ä»¬çš„æ¥å£ç»§æ‰¿äº†JpaRepositoryå’ŒJpaSpecificationExecutorï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªæ¥å£çš„æ‰€æœ‰æ–¹æ³•ã€‚ åœ¨ä½¿ç”¨Spring Data JPAæ—¶ï¼Œä¸€èˆ¬å®ç°JpaRepositoryå’ŒJpaSpecificationExecutoræ¥å£ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨è¿™äº›æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œä½†æ˜¯è¿™äº›æ–¹æ³•éƒ½åªæ˜¯ä¸€äº›å£°æ˜ï¼Œæ²¡æœ‰å…·ä½“çš„å®ç°æ–¹å¼ï¼Œé‚£ä¹ˆåœ¨ Spring Data JPAä¸­å®ƒåˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ 3.2SpringDataJPAçš„å®ç°è¿‡ç¨‹é€šè¿‡åˆšæ‰çš„å…¥é—¨æ¡ˆä¾‹ï¼Œæ‰“æ–­ç‚¹æ¥åˆ†æSpringDataJPAçš„æ‰§è¡Œè¿‡ç¨‹ã€‚ ä»¥findByIdï¼ˆï¼‰ä¸ºä¾‹ã€‚ æ–­ç‚¹æ‰§è¡Œåˆ°æ–¹æ³•ä¸Šæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æ³¨å…¥çš„æ˜¯personmapperå¯¹è±¡ï¼Œæœ¬è´¨ä¸Šæ˜¯é€šè¿‡jdkçš„åŠ¨æ€ä»£ç†ç”Ÿæˆçš„ä¸€ä¸ªå¯¹è±¡ã€‚ æŸ¥çœ‹å…·ä½“è¿‡ç¨‹ï¼š å½“ç¨‹åºæ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šé€šè¿‡JdkDynamicAopProxyçš„invokeæ–¹æ³•ï¼Œå¯¹Daoå¯¹è±¡ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡ã€‚æ ¹æ®å¯¹Spring Data JPAä»‹ç»è€ŒçŸ¥ï¼Œè¦æƒ³è¿›è¡ŒfindOneæŸ¥è¯¢æ–¹æ³•ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šå‡ºç°JPAè§„èŒƒçš„APIå®Œæˆæ“ä½œï¼Œé‚£ä¹ˆè¿™äº›åº•å±‚ä»£ç å­˜åœ¨äºä½•å¤„å‘¢ï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼Œéƒ½éšè—åœ¨é€šè¿‡JdkDynamicAopProxyç”Ÿæˆçš„åŠ¨æ€ä»£ç†å¯¹è±¡å½“ä¸­ï¼Œè€Œè¿™ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡å°±æ˜¯SimpleJpaRepository,é€šè¿‡ SimpleJpaRepositoryçš„æºç åˆ†æï¼Œå®šä½åˆ°äº†findOneæ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­ï¼Œè¿”å›em.find()çš„è¿”å›ç»“æœï¼Œé‚£ä¹ˆemåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ ç»§ç»­æŸ¥æ‰¾emå¯¹è±¡ï¼Œæˆ‘ä»¬å‘ç°emå°±æ˜¯EntityManagerå¯¹è±¡ï¼Œè€Œä»–æ˜¯JPAåŸç”Ÿçš„å®ç°æ–¹å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°ç»“è®ºSpring Data JPAåªæ˜¯å¯¹æ ‡å‡†JPAæ“ä½œè¿›è¡Œäº†è¿›ä¸€æ­¥å°è£…ï¼Œç®€åŒ–äº†Daoå±‚ä»£ç çš„å¼€å‘ã€‚ ç”±æ­¤å¯å¾—ï¼šSpringDataJpaå®Œæ•´æ‰§è¡Œæµç¨‹ï¼š SpringDataJpaâ€“&gt;JPAâ€“&gt;hibernateâ€“&gt;æ•°æ®åº“ 4.SpringDataJPAçš„æŸ¥è¯¢æ–¹å¼4.1ä½¿ç”¨jpqlçš„æ–¹å¼æŸ¥è¯¢ä½¿ç”¨Spring Data JPAæä¾›çš„æŸ¥è¯¢æ–¹æ³•å·²ç»å¯ä»¥è§£å†³å¤§éƒ¨åˆ†çš„åº”ç”¨åœºæ™¯ï¼Œä½†æ˜¯å¯¹äºæŸäº›ä¸šåŠ¡æ¥è¯´ï¼Œæˆ‘ä»¬è¿˜éœ€è¦çµæ´»çš„æ„é€ æŸ¥è¯¢æ¡ä»¶ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨@Queryæ³¨è§£ï¼Œç»“åˆJPQLçš„è¯­å¥æ–¹å¼å®ŒæˆæŸ¥è¯¢ **@Query **** æ³¨è§£çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œåªéœ€åœ¨æ–¹æ³•ä¸Šé¢æ ‡æ³¨è¯¥æ³¨è§£ï¼ŒåŒæ—¶æä¾›ä¸€ä¸ªJPQLæŸ¥è¯¢è¯­å¥å³å¯ ** 1234567891011/** * æµ‹è¯•ä½¿ç”¨JPQLçš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢ */@Query(&quot;from Person &quot;)List&lt;Person&gt; MyfindAll();@Query(&quot;from Person where id=?1&quot;)Person MyfindById(Long id);@Query(value = &quot;update Person set name=?1 where id=?2&quot;)@Modifying@Transactionalvoid MyUpdate(String name,Long id); 4.2ä½¿ç”¨SQLè¯­å¥æŸ¥è¯¢1234567891011/** * nativeQuery : ä½¿ç”¨æœ¬åœ°sqlçš„æ–¹å¼æŸ¥è¯¢ */@Query(value = &quot;select * from t_person&quot;,nativeQuery = true)List&lt;Person&gt; MyfindAll();@Query(value = &quot;select * from t_person where id=?1&quot;,nativeQuery = true)Person MyfindById(Long id);@Query(value = &quot;update t_person set p_name=?1 where id=?2&quot;,nativeQuery = true)@Modifying@Transactionalvoid MyUpdate(String name,Long id); 4.3æ–¹æ³•å‘½åè§„åˆ™æŸ¥è¯¢æ–¹æ³•å‘½åè§„åˆ™æŸ¥è¯¢å°±æ˜¯æ ¹æ®æ–¹æ³•çš„åå­—ï¼Œå°±èƒ½åˆ›å»ºæŸ¥è¯¢ã€‚åªéœ€è¦æŒ‰ç…§Spring Data JPAæä¾›çš„æ–¹æ³•å‘½åè§„åˆ™å®šä¹‰æ–¹æ³•çš„åç§°ï¼Œå°±å¯ä»¥å®ŒæˆæŸ¥è¯¢å·¥ä½œã€‚Spring Data JPAåœ¨ç¨‹åºæ‰§è¡Œçš„æ—¶å€™ä¼šæ ¹æ®æ–¹æ³•åç§°è¿›è¡Œè§£æï¼Œå¹¶è‡ªåŠ¨ç”ŸæˆæŸ¥è¯¢è¯­å¥è¿›è¡ŒæŸ¥è¯¢ æŒ‰ç…§Spring Data JPA å®šä¹‰çš„è§„åˆ™ï¼ŒæŸ¥è¯¢æ–¹æ³•ä»¥findByå¼€å¤´ï¼Œæ¶‰åŠæ¡ä»¶æŸ¥è¯¢æ—¶ï¼Œæ¡ä»¶çš„å±æ€§ç”¨æ¡ä»¶å…³é”®å­—è¿æ¥ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼šæ¡ä»¶å±æ€§é¦–å­—æ¯éœ€å¤§å†™ã€‚æ¡†æ¶åœ¨è¿›è¡Œæ–¹æ³•åè§£ææ—¶ï¼Œä¼šå…ˆæŠŠæ–¹æ³•åå¤šä½™çš„å‰ç¼€æˆªå–æ‰ï¼Œç„¶åå¯¹å‰©ä¸‹éƒ¨åˆ†è¿›è¡Œè§£æã€‚ Keyword Sample JPQL And findByLastnameAndFirstname â€¦ where x.lastname = ?1 and x.firstname = ?2 Or findByLastnameOrFirstname â€¦ where x.lastname = ?1 or x.firstname = ?2 Is,Equals findByFirstnameIs, findByFirstnameEquals â€¦ where x.firstname = ?1 Between findByStartDateBetween â€¦ where x.startDate between ?1 and ?2 LessThan findByAgeLessThan â€¦ where x.age &lt; ?1 LessThanEqual findByAgeLessThanEqual â€¦ where x.age â‡ ?1 GreaterThan findByAgeGreaterThan â€¦ where x.age &gt; ?1 GreaterThanEqual findByAgeGreaterThanEqual â€¦ where x.age &gt;= ?1 After findByStartDateAfter â€¦ where x.startDate &gt; ?1 Before findByStartDateBefore â€¦ where x.startDate &lt; ?1 IsNull findByAgeIsNull â€¦ where x.age is null IsNotNull,NotNull findByAge(Is)NotNull â€¦ where x.age not null Like findByFirstnameLike â€¦ where x.firstname like ?1 NotLike findByFirstnameNotLike â€¦ where x.firstname not like ?1 StartingWith findByFirstnameStartingWith â€¦ where x.firstname like ?1 (parameter bound with appended %) EndingWith findByFirstnameEndingWith â€¦ where x.firstname like ?1 (parameter bound with prepended %) Containing findByFirstnameContaining â€¦ where x.firstname like ?1 (parameter bound wrapped in %) OrderBy findByAgeOrderByLastnameDesc â€¦ where x.age = ?1 order by x.lastname desc Not findByLastnameNot â€¦ where x.lastname &lt;&gt; ?1 In findByAgeIn(Collection ages) â€¦ where x.age in ?1 NotIn findByAgeNotIn(Collection age) â€¦ where x.age not in ?1 TRUE findByActiveTrue() â€¦ where x.active = true FALSE findByActiveFalse() â€¦ where x.active = false IgnoreCase findByFirstnameIgnoreCase â€¦ where UPPER(x.firstame) = UPPER(?1) ä¸‰ï¼ŒspringdataJpaçš„åŠ¨æ€æŸ¥è¯¢ä¸å¤šè¡¨æŸ¥è¯¢1.åŠ¨æ€æŸ¥è¯¢æœ‰æ—¶æˆ‘ä»¬åœ¨æŸ¥è¯¢æŸä¸ªå®ä½“çš„æ—¶å€™ï¼Œç»™å®šçš„æ¡ä»¶æ˜¯ä¸å›ºå®šçš„ï¼Œè¿™æ—¶å°±éœ€è¦åŠ¨æ€æ„å»ºç›¸åº”çš„æŸ¥è¯¢è¯­å¥ï¼Œåœ¨Spring Data JPAä¸­å¯ä»¥é€šè¿‡JpaSpecificationExecutoræ¥å£æŸ¥è¯¢ã€‚ç›¸æ¯”JPQL,å…¶ä¼˜åŠ¿æ˜¯ç±»å‹å®‰å…¨,æ›´åŠ çš„é¢å‘å¯¹è±¡ã€‚ 12345678910111213141516171819202122import java.util.List;import org.springframework.data.domain.Page;import org.springframework.data.domain.Pageable;import org.springframework.data.domain.Sort;import org.springframework.data.jpa.domain.Specification;/** * JpaSpecificationExecutorä¸­å®šä¹‰çš„æ–¹æ³• **/ public interface JpaSpecificationExecutor&lt;T&gt; &#123; //æ ¹æ®æ¡ä»¶æŸ¥è¯¢ä¸€ä¸ªå¯¹è±¡ T findOne(Specification&lt;T&gt; spec); //æ ¹æ®æ¡ä»¶æŸ¥è¯¢é›†åˆ List&lt;T&gt; findAll(Specification&lt;T&gt; spec); //æ ¹æ®æ¡ä»¶åˆ†é¡µæŸ¥è¯¢ Page&lt;T&gt; findAll(Specification&lt;T&gt; spec, Pageable pageable); //æ’åºæŸ¥è¯¢æŸ¥è¯¢ List&lt;T&gt; findAll(Specification&lt;T&gt; spec, Sort sort); //ç»Ÿè®¡æŸ¥è¯¢ long count(Specification&lt;T&gt; spec);&#125; å¯¹äºJpaSpecificationExecutorï¼Œè¿™ä¸ªæ¥å£åŸºæœ¬æ˜¯å›´ç»•ç€Specificationæ¥å£æ¥å®šä¹‰çš„ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•çš„ç†è§£ä¸ºï¼ŒSpecificationæ„é€ çš„å°±æ˜¯æŸ¥è¯¢æ¡ä»¶ã€‚ Specificationæ¥å£ä¸­åªå®šä¹‰äº†å¦‚ä¸‹ä¸€ä¸ªæ–¹æ³•ï¼š 1234567//æ„é€ æŸ¥è¯¢æ¡ä»¶ /** * root ï¼šRootæ¥å£ï¼Œä»£è¡¨æŸ¥è¯¢çš„æ ¹å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡rootè·å–å®ä½“ä¸­çš„å±æ€§ * query ï¼šä»£è¡¨ä¸€ä¸ªé¡¶å±‚æŸ¥è¯¢å¯¹è±¡ï¼Œç”¨æ¥è‡ªå®šä¹‰æŸ¥è¯¢ * cb ï¼šç”¨æ¥æ„å»ºæŸ¥è¯¢ï¼Œæ­¤å¯¹è±¡é‡Œæœ‰å¾ˆå¤šæ¡ä»¶æ–¹æ³• **/ public Predicate toPredicate(Root&lt;T&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb); 1.1 ä½¿ç”¨Specificationså®Œæˆæ¡ä»¶æŸ¥è¯¢1234567891011121314//åŠ¨æ€æ¡ä»¶æŸ¥è¯¢@Testpublic void test7()&#123; //ä½¿ç”¨åŒ¿åäº†å†…éƒ¨ç±»çš„æ–¹å¼ï¼Œåˆ›å»ºä¸€ä¸ªSpecificationçš„å®ç°ç±»ï¼Œå¹¶å®ç°toPredicateï¼ˆï¼‰ Specification&lt;Person&gt; sp=new Specification&lt;Person&gt;() &#123; @Override public Predicate toPredicate(Root&lt;Person&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder criteriaBuilder) &#123; //criteriaBuilder:æ„å»ºæŸ¥è¯¢ï¼Œæ·»åŠ æŸ¥è¯¢æ–¹å¼ likeï¼šæ¨¡ç³ŠåŒ¹é… return criteriaBuilder.like(root.get(&quot;name&quot;).as(String.class),&quot;å°‘å¦‡ç™½æ´&quot;); &#125; &#125;; mapper.findAll(sp).forEach(System.out::println);&#125; 1.2åŸºäºSpecificationçš„åˆ†é¡µæŸ¥è¯¢1234567891011121314151617181920212223242526272829//åŠ¨æ€åˆ†é¡µæŸ¥è¯¢@Testpublic void test8()&#123; //æ„å»ºæŸ¥è¯¢æ¡ä»¶ Specification&lt;Person&gt; sp=new Specification&lt;Person&gt;() &#123; @Override public Predicate toPredicate(Root&lt;Person&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder criteriaBuilder) &#123; return criteriaBuilder.like(root.get(&quot;name&quot;).as(String.class),&quot;å°‘å¦‡%&quot;); &#125; &#125;; /** * æ„å»ºåˆ†é¡µå‚æ•°ï¼š * Pageableï¼šæ¥å£ * PageRequetå®ç°äº†Pageableæ¥å£ï¼Œè°ƒç”¨ofæ–¹æ³•çš„å½¢å¼æ„é€ ã€‚ * ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé¡µç ï¼ˆä»0å¼€å§‹ï¼‰ * ç¬¬äºŒä¸ªå‚æ•°ï¼šæ¯é¡µæŸ¥è¯¢æ¡æ•° */ Pageable request = PageRequest.of(0,1); /** * åˆ†é¡µæŸ¥è¯¢ï¼šå°è£…ä¸ºSpringDataJpaå†…éƒ¨çš„pageBean * æ­¤é‡è½½findAlllæ–¹æ³•ä¸ºåˆ†é¡µæ–¹æ³•éœ€è¦ä¸¤ä¸ªå‚æ•° * ç¬¬ä¸€ä¸ªå‚æ•°ã€ï¼›æŸ¥è¯¢æ¡ä»¶ * ç¬¬äºŒä¸ªå‚æ•°ï¼šåˆ†é¡µå‚æ•° */ Page&lt;Person&gt; page = mapper.findAll(sp, request); page.forEach(System.out::println);&#125; 1.3æ–¹æ³•å¯¹åº”å…³ç³» æ–¹æ³•åç§° Sqlå¯¹åº”å…³ç³» equle filed = value gtï¼ˆgreaterThan ï¼‰ filed &gt; value ltï¼ˆlessThan ï¼‰ filed &lt; value geï¼ˆgreaterThanOrEqualTo ï¼‰ filed &gt;= value leï¼ˆ lessThanOrEqualToï¼‰ filed &lt;= value notEqule filed != value like filed like value notLike filed not like value 2.å¤šè¡¨è®¾è®¡2.1è¡¨ä¹‹é—´å…³ç³»çš„åˆ’åˆ†æ•°æ®åº“ä¸­å¤šè¡¨ä¹‹é—´å­˜åœ¨ç€ä¸‰ç§å…³ç³»ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ ä»å›¾å¯ä»¥çœ‹å‡ºï¼Œç³»ç»Ÿè®¾è®¡çš„ä¸‰ç§å®ä½“å…³ç³»åˆ†åˆ«ä¸ºï¼šå¤šå¯¹å¤šã€ä¸€å¯¹å¤šå’Œä¸€å¯¹ä¸€å…³ç³»ã€‚æ³¨æ„ï¼šä¸€å¯¹å¤šå…³ç³»å¯ä»¥çœ‹ä¸ºä¸¤ç§ï¼š å³ä¸€å¯¹å¤šï¼Œå¤šå¯¹ä¸€ã€‚æ‰€ä»¥è¯´å››ç§æ›´ç²¾ç¡®ã€‚ 2.2 åœ¨JPAæ¡†æ¶ä¸­è¡¨å…³ç³»çš„åˆ†ææ­¥éª¤åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬æ•°æ®åº“çš„è¡¨éš¾å…ä¼šæœ‰ç›¸äº’çš„å…³è”å…³ç³»ï¼Œåœ¨æ“ä½œè¡¨çš„æ—¶å€™å°±æœ‰å¯èƒ½ä¼šæ¶‰åŠåˆ°å¤šå¼ è¡¨çš„æ“ä½œã€‚è€Œåœ¨è¿™ç§å®ç°äº†ORMæ€æƒ³çš„æ¡†æ¶ä¸­ï¼ˆå¦‚JPAï¼‰ï¼Œå¯ä»¥è®©æˆ‘ä»¬é€šè¿‡æ“ä½œå®ä½“ç±»å°±å®ç°å¯¹æ•°æ®åº“è¡¨çš„æ“ä½œã€‚æ‰€ä»¥å­¦ä¹ é‡ç‚¹æ˜¯ï¼šæŒæ¡é…ç½®å®ä½“ä¹‹é—´çš„å…³è”å…³ç³»ã€‚ ç¬¬ä¸€æ­¥ï¼šé¦–å…ˆç¡®å®šä¸¤å¼ è¡¨ä¹‹é—´çš„å…³ç³»ã€‚ å¦‚æœå…³ç³»ç¡®å®šé”™äº†ï¼Œåé¢åšçš„æ‰€æœ‰æ“ä½œå°±éƒ½ä¸å¯èƒ½æ­£ç¡®ã€‚ ç¬¬äºŒæ­¥ï¼šåœ¨æ•°æ®åº“ä¸­å®ç°ä¸¤å¼ è¡¨çš„å…³ç³» ç¬¬ä¸‰æ­¥ï¼šåœ¨å®ä½“ç±»ä¸­æè¿°å‡ºä¸¤ä¸ªå®ä½“çš„å…³ç³» ç¬¬å››æ­¥ï¼šé…ç½®å‡ºå®ä½“ç±»å’Œæ•°æ®åº“è¡¨çš„å…³ç³»æ˜ å°„ï¼ˆé‡ç‚¹ï¼‰ 3.jpaä¸­çš„ä¸€å¯¹å¤š3.1æƒ…æ™¯æ¨¡æ‹Ÿä¸Šä¸ªæ¡ˆä¾‹æˆ‘åˆ›å»ºçš„æ˜¯ä¸€å¼ Personè¡¨ï¼Œæ­¤æ—¶åœ¨åˆ›å»ºä¸€å¼ Dogè¡¨ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥å¯¹åº”ç€å¤šä¸ªå® ç‰©ç‹—ã€‚ æ­¤æ—¶ä»äººçš„è§’åº¦å°±æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚ 3.2è¡¨å…³ç³»å»ºç«‹åœ¨ä¸€å¯¹å¤šå…³ç³»ä¸­ï¼Œæˆ‘ä»¬ä¹ æƒ¯æŠŠä¸€çš„ä¸€æ–¹ç§°ä¹‹ä¸ºä¸»è¡¨ï¼ŒæŠŠå¤šçš„ä¸€æ–¹ç§°ä¹‹ä¸ºä»è¡¨ã€‚åœ¨æ•°æ®åº“ä¸­å»ºç«‹ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œéœ€è¦ä½¿ç”¨æ•°æ®åº“çš„å¤–é”®çº¦æŸã€‚ ä»€ä¹ˆæ˜¯å¤–é”®ï¼Ÿ æŒ‡çš„æ˜¯ä»è¡¨ä¸­æœ‰ä¸€åˆ—ï¼Œå–å€¼å‚ç…§ä¸»è¡¨çš„ä¸»é”®ï¼Œè¿™ä¸€åˆ—å°±æ˜¯å¤–é”®ã€‚ ä¸€å¯¹å¤šæ•°æ®åº“å…³ç³»çš„å»ºç«‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º 3.3 å®ä½“ç±»å…³ç³»å»ºç«‹ä»¥åŠæ˜ å°„é…ç½®æ•°æ®åº“å»ºè¡¨è¯­å¥ 123456789101112CREATE TABLE t_person(id INT PRIMARY KEY AUTO_INCREMENT,p_age INT ,p_birth DATE,p_email VARCHAR(20),p_name VARCHAR(20));CREATE TABLE t_dog(d_id INT PRIMARY KEY AUTO_INCREMENT,d_name VARCHAR(20),p_id INT REFERENCES t_person(id) ); å®ä½“ç±»å…³ç³»æ˜ å°„ 12345678910111213141516171819@Entity@Table(name = &quot;t_person&quot;)public class Person &#123; @Id @GeneratedValue(strategy = IDENTITY) @Column(name = &quot;id&quot;) private Long id; @Column(name = &quot;p_name&quot;) private String name; @Column(name = &quot;p_age&quot;) private Integer age; @Column(name = &quot;p_email&quot;) private String email; @Column(name = &quot;p_birth&quot;) private Date birth; @OneToMany(mappedBy=&quot;person&quot;) private List&lt;Dog&gt; dogs=new ArrayList&lt;&gt;();&#125; 1234567891011121314@Entity@Table(name = &quot;t_dog&quot;)public class Dog &#123; @Id @GeneratedValue(strategy = GenerationType.IDENTITY) @Column(name = &quot;d_id&quot;) private Long id; @Column(name = &quot;d_name&quot;) private String name; @ManyToOne(targetEntity = Person.class) @JoinColumn(name = &quot;p_id&quot;,referencedColumnName = &quot;id&quot;) private Person person;&#125; 3.4æ˜ å°„çš„æ³¨è§£è¯´æ˜@OneToMany:ä½œç”¨ï¼šå»ºç«‹ä¸€å¯¹å¤šçš„å…³ç³»æ˜ å°„ å±æ€§ï¼š targetEntityClassï¼šæŒ‡å®šå¤šçš„å¤šæ–¹çš„ç±»çš„å­—èŠ‚ç  mappedByï¼šæŒ‡å®šä»è¡¨å®ä½“ç±»ä¸­å¼•ç”¨ä¸»è¡¨å¯¹è±¡çš„åç§°ã€‚ cascadeï¼šæŒ‡å®šè¦ä½¿ç”¨çš„çº§è”æ“ä½œ fetchï¼šæŒ‡å®šæ˜¯å¦é‡‡ç”¨å»¶è¿ŸåŠ è½½ orphanRemovalï¼šæ˜¯å¦ä½¿ç”¨å­¤å„¿åˆ é™¤ **@ManyToOne **** **ä½œç”¨ï¼šå»ºç«‹å¤šå¯¹ä¸€çš„å…³ç³» å±æ€§ï¼š targetEntityClassï¼šæŒ‡å®šä¸€çš„ä¸€æ–¹å®ä½“ç±»å­—èŠ‚ç  cascadeï¼šæŒ‡å®šè¦ä½¿ç”¨çš„çº§è”æ“ä½œ fetchï¼šæŒ‡å®šæ˜¯å¦é‡‡ç”¨å»¶è¿ŸåŠ è½½ optionalï¼šå…³è”æ˜¯å¦å¯é€‰ã€‚å¦‚æœè®¾ç½®ä¸ºfalseï¼Œåˆ™å¿…é¡»å§‹ç»ˆå­˜åœ¨éç©ºå…³ç³»ã€‚ **@JoinColumn **** **ä½œç”¨ï¼šç”¨äºå®šä¹‰ä¸»é”®å­—æ®µå’Œå¤–é”®å­—æ®µçš„å¯¹åº”å…³ç³»ã€‚ å±æ€§ï¼š nameï¼šæŒ‡å®šå¤–é”®å­—æ®µçš„åç§° referencedColumnNameï¼šæŒ‡å®šå¼•ç”¨ä¸»è¡¨çš„ä¸»é”®å­—æ®µåç§° uniqueï¼šæ˜¯å¦å”¯ä¸€ã€‚é»˜è®¤å€¼ä¸å”¯ä¸€ nullableï¼šæ˜¯å¦å…è®¸ä¸ºç©ºã€‚é»˜è®¤å€¼å…è®¸ã€‚ insertableï¼šæ˜¯å¦å…è®¸æ’å…¥ã€‚é»˜è®¤å€¼å…è®¸ã€‚ updatableï¼šæ˜¯å¦å…è®¸æ›´æ–°ã€‚é»˜è®¤å€¼å…è®¸ã€‚ columnDefinitionï¼šåˆ—çš„å®šä¹‰ä¿¡æ¯ã€‚ 3.5ä¸€å¯¹å¤šçš„æ“ä½œ1ï¼‰æ·»åŠ 1234567891011121314151617181920212223242526@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration(locations = &quot;classpath:applicationContext.xml&quot;)public class OneToManyTest &#123; @Autowired private PersonMapper personMapper; @Autowired private DogMapper dogMapper; /** * æµ‹è¯•ä¿å­˜ï¼š * åŒæ—¶ä¿å­˜ä¸€ä¸ªç‹—ä¸»äººå’Œä¸€åªç‹—çš„ä¿¡æ¯ */ @Test @Transactional @Rollback(value = false) public void testSave()&#123; Person person = new Person(&quot;å¼ æ•&quot;,26,&quot;baijie@qq.com&quot;,new Date()); Dog dog = new Dog(); dog.setName(&quot;é‡‘æ¯›&quot;); person.getDogs().add(dog); dog.setPerson(person); personMapper.save(person); dogMapper.save(dog); &#125;&#125; 2ï¼‰åˆ é™¤1234567891011/** * åˆ é™¤æ“ä½œ */@Testpublic void testDelete()&#123; //åˆ é™¤ä¸»è¡¨æ•°æ®ï¼Œå¯ä»¥ç›´æ¥åˆ é™¤ï¼Œå¯¹åº”ä»è¡¨å¤–é”®å­—æ®µè¿˜æ˜¯åˆ é™¤çš„ä¸»è¡¨ID personMapper.deleteById(4l); //æ­¤æ—¶åœ¨åˆ é™¤ä»è¡¨ä¼šæŠ¥é”™ dogMapper.deleteById(4l); //å¦‚æœå…ˆåˆ é™¤ä»è¡¨å†åˆ é™¤ä¸»è¡¨åˆ™æ²¡æœ‰é—®é¢˜&#125; 3ï¼‰çº§è”æ“ä½œçº§è”æ“ä½œï¼šæŒ‡æ“ä½œä¸€ä¸ªå¯¹è±¡åŒæ—¶æ“ä½œå®ƒçš„å…³è”å¯¹è±¡ ä½¿ç”¨æ–¹æ³•ï¼šåªéœ€è¦åœ¨æ“ä½œä¸»ä½“çš„æ³¨è§£ä¸Šé…ç½®cascade 1@OneToMany(mappedBy=&quot;person&quot;,cascade = CascadeType.ALL) cascade:é…ç½®çº§è”æ“ä½œCascadeType.MERGE çº§è”æ›´æ–°CascadeType.PERSIST çº§è”ä¿å­˜ï¼šCascadeType.REFRESH çº§è”åˆ·æ–°ï¼šCascadeType.REMOVE çº§è”åˆ é™¤ï¼šCascadeType.ALL åŒ…å«æ‰€æœ‰ 4.jpaä¸­çš„å¤šå¯¹å¤š4.1.æƒ…æ™¯æ¨¡æ‹Ÿç”¨æˆ·å’Œè§’è‰²ï¼šä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²ï¼Œä¸€ä¸ªè§’è‰²å¯ä»¥å¯¹åº”å¤šä¸ªç”¨æˆ· 4.2è¡¨å…³ç³»å»ºç«‹ 123456789CREATE TABLE t_role(r_id INT PRIMARY KEY AUTO_INCREMENT,NAME VARCHAR(20));CREATE TABLE t_person_role(id INT PRIMARY KEY AUTO_INCREMENT,r_id INT REFERENCES t_role(r_id),p_id INT REFERENCES t_person(id)) 4.3å®ä½“å…³ç³»å»ºç«‹ä»¥åŠæ˜ å°„é…ç½®12345678910111213141516171819202122@Entity@Table(name = &quot;t_person&quot;)public class Person &#123; @Id @GeneratedValue(strategy = IDENTITY) @Column(name = &quot;id&quot;) private Long id; @Column(name = &quot;p_name&quot;) private String name; @Column(name = &quot;p_age&quot;) private Integer age; @Column(name = &quot;p_email&quot;) private String email; @Column(name = &quot;p_birth&quot;) private Date birth; @OneToMany(mappedBy=&quot;person&quot;,cascade = CascadeType.ALL) private List&lt;Dog&gt; dogs=new ArrayList&lt;&gt;(); //å¤šå¯¹å¤šå…³ç³»æ˜ å°„ @ManyToMany(mappedBy =&quot;persons&quot;) private List&lt;Role&gt; roles=new ArrayList&lt;&gt;(); &#125; 12345678910111213141516@Entity@Table(name = &quot;t_role&quot;)public class Role &#123; @Id @GeneratedValue(strategy = GenerationType.IDENTITY) @Column(name = &quot;r_id&quot;) private Integer id; @Column(name = &quot;name&quot;) private String name; @ManyToMany @JoinTable(name=&quot;t_person_role&quot;,//ä¸­é—´è¡¨çš„åç§° joinColumns=&#123;@JoinColumn(name=&quot;r_id&quot;,referencedColumnName=&quot;r_id&quot;)&#125;, inverseJoinColumns=&#123;@JoinColumn(name=&quot;p_id&quot;,referencedColumnName=&quot;id&quot;)&#125; ) private List&lt;Person&gt; persons=new ArrayList&lt;&gt;(); &#125; 4.4æ˜ å°„çš„æ³¨è§£è¯´æ˜**@ManyToMany **** ** ä½œç”¨ï¼šç”¨äºæ˜ å°„å¤šå¯¹å¤šå…³ç³» å±æ€§ï¼š cascadeï¼šé…ç½®çº§è”æ“ä½œã€‚ fetchï¼šé…ç½®æ˜¯å¦é‡‡ç”¨å»¶è¿ŸåŠ è½½ã€‚ targetEntityï¼šé…ç½®ç›®æ ‡çš„å®ä½“ç±»ã€‚æ˜ å°„å¤šå¯¹å¤šçš„æ—¶å€™ä¸ç”¨å†™ã€‚ **@JoinTable **** **ä½œç”¨ï¼šé’ˆå¯¹ä¸­é—´è¡¨çš„é…ç½® å±æ€§ï¼š namï¼šé…ç½®ä¸­é—´è¡¨çš„åç§° joinColumnsï¼šä¸­é—´è¡¨çš„å¤–é”®å­—æ®µå…³è”å½“å‰å®ä½“ç±»æ‰€å¯¹åº”è¡¨çš„ä¸»é”®å­—æ®µ inverseJoinColumnï¼šä¸­é—´è¡¨çš„å¤–é”®å­—æ®µå…³è”å¯¹æ–¹è¡¨çš„ä¸»é”®å­—æ®µ â€‹ **@JoinColumn **** **ä½œç”¨ï¼šç”¨äºå®šä¹‰ä¸»é”®å­—æ®µå’Œå¤–é”®å­—æ®µçš„å¯¹åº”å…³ç³»ã€‚ å±æ€§ï¼š nameï¼šæŒ‡å®šå¤–é”®å­—æ®µçš„åç§° referencedColumnNameï¼šæŒ‡å®šå¼•ç”¨ä¸»è¡¨çš„ä¸»é”®å­—æ®µåç§° uniqueï¼šæ˜¯å¦å”¯ä¸€ã€‚é»˜è®¤å€¼ä¸å”¯ä¸€ nullableï¼šæ˜¯å¦å…è®¸ä¸ºç©ºã€‚é»˜è®¤å€¼å…è®¸ã€‚ insertableï¼šæ˜¯å¦å…è®¸æ’å…¥ã€‚é»˜è®¤å€¼å…è®¸ã€‚ updatableï¼šæ˜¯å¦å…è®¸æ›´æ–°ã€‚é»˜è®¤å€¼å…è®¸ã€‚ columnDefinitionï¼šåˆ—çš„å®šä¹‰ä¿¡æ¯ã€‚ 4.5å¤šå¯¹å¤šçš„æ“ä½œ1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950/** * @author yinhuidong * @createTime 2020-06-04-21:19 */@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration(locations = &quot;classpath:applicationContext.xml&quot;)public class ManyToManyTest &#123; @Autowired private PersonMapper personMapper; @Autowired private RoleMapper roleMapper; /** * ä¿å­˜ */ @Test @Transactional @Rollback(false) public void test1()&#123; Person person = new Person(); person.setName(&quot;å°¹ä¼šä¸œ&quot;); Person person2 = new Person(); person2.setName(&quot;å¼ è´è´&quot;); Role r1 = new Role(); r1.setName(&quot;å­¦ç”Ÿ&quot;); Role r2 = new Role(); r2.setName(&quot;ä¸ˆå¤«&quot;); person.getRoles().add(r1); person.getRoles().add(r2); person2.getRoles().add(r1); person2.getRoles().add(r2); r1.getPersons().add(person); r2.getPersons().add(person); r1.getPersons().add(person2); r2.getPersons().add(person2); personMapper.save(person); personMapper.save(person2); roleMapper.save(r1); roleMapper.save(r2); &#125; @Test @Transactional @Rollback(false) public void test2()&#123; personMapper.deleteById(10l); &#125;&#125; 5.SpringDataJPAçš„å¤šè¡¨æŸ¥è¯¢å¯¹è±¡å¯¼èˆªå›¾æŸ¥è¯¢å¯¹è±¡å›¾å¯¼èˆªæ£€ç´¢æ–¹å¼æ˜¯æ ¹æ®å·²ç»åŠ è½½çš„å¯¹è±¡ï¼Œå¯¼èˆªåˆ°ä»–çš„å…³è”å¯¹è±¡ã€‚å®ƒåˆ©ç”¨ç±»ä¸ç±»ä¹‹é—´çš„å…³ç³»æ¥æ£€ç´¢å¯¹è±¡ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬é€šè¿‡IDæŸ¥è¯¢æ–¹å¼æŸ¥å‡ºä¸€ä¸ªå®¢æˆ·ï¼Œå¯ä»¥è°ƒç”¨Customerç±»ä¸­çš„getLinkMans()æ–¹æ³•æ¥è·å–è¯¥å®¢æˆ·çš„æ‰€æœ‰è”ç³»äººã€‚å¯¹è±¡å¯¼èˆªæŸ¥è¯¢çš„ä½¿ç”¨è¦æ±‚æ˜¯ï¼šä¸¤ä¸ªå¯¹è±¡ä¹‹é—´å¿…é¡»å­˜åœ¨å…³è”å…³ç³»ã€‚ æŸ¥è¯¢ä¸€ä¸ªPersonè·å–å®ƒå¯¹åº”çš„æ‰€æœ‰Role 1234567@Transactional@Testpublic void test3()&#123; Person person = personMapper.findById(11l).get(); System.out.println(&quot;person = &quot; + person); person.getRoles().forEach(System.out::println);&#125; æŸ¥è¯¢ä¸€ä¸ªè§’è‰²ï¼Œè·å–è§’è‰²å¯¹åº”çš„æ‰€æœ‰person 1234567@Transactional@Testpublic void test3()&#123; Role role = roleMapper.findById(5l).get(); System.out.println(&quot;role = &quot; + role); role.getPersons().forEach(System.out::println);&#125; å¯¹è±¡å¯¼èˆªæŸ¥è¯¢çš„é—®é¢˜åˆ†æ é—®é¢˜1ï¼šæˆ‘ä»¬æŸ¥è¯¢å®¢æˆ·æ—¶ï¼Œè¦ä¸è¦æŠŠè”ç³»äººæŸ¥è¯¢å‡ºæ¥ï¼Ÿ åˆ†æï¼šå¦‚æœæˆ‘ä»¬ä¸æŸ¥çš„è¯ï¼Œåœ¨ç”¨çš„æ—¶å€™è¿˜è¦è‡ªå·±å†™ä»£ç ï¼Œè°ƒç”¨æ–¹æ³•å»æŸ¥è¯¢ã€‚å¦‚æœæˆ‘ä»¬æŸ¥å‡ºæ¥çš„ï¼Œä¸ä½¿ç”¨æ—¶åˆä¼šç™½ç™½çš„æµªè´¹äº†æœåŠ¡å™¨å†…å­˜ã€‚ è§£å†³ï¼šé‡‡ç”¨å»¶è¿ŸåŠ è½½çš„æ€æƒ³ã€‚é€šè¿‡é…ç½®çš„æ–¹å¼æ¥è®¾å®šå½“æˆ‘ä»¬åœ¨éœ€è¦ä½¿ç”¨æ—¶ï¼Œå‘èµ·çœŸæ­£çš„æŸ¥è¯¢ã€‚ é…ç½®æ–¹å¼ï¼š 12//LAZY @ManyToMany(mappedBy =&quot;persons&quot;,fetch = FetchType.EAGER) FetchType.EAGER ç«‹å³åŠ è½½ FetchType.LAZY æ‡’åŠ è½½ 12345678910111213141516 r1.getPersons().add(person); r2.getPersons().add(person); r1.getPersons().add(person2); r2.getPersons().add(person2); personMapper.save(person); personMapper.save(person2); roleMapper.save(r1); roleMapper.save(r2);&#125;@Test@Transactional@Rollback(false)public void test2()&#123; personMapper.deleteById(10l);&#125; } 1234567891011121314151617## 5.SpringDataJPAçš„å¤šè¡¨æŸ¥è¯¢### 5.1å¯¹è±¡å¯¼èˆªå›¾æŸ¥è¯¢å¯¹è±¡å›¾å¯¼èˆªæ£€ç´¢æ–¹å¼æ˜¯æ ¹æ®å·²ç»åŠ è½½çš„å¯¹è±¡ï¼Œå¯¼èˆªåˆ°ä»–çš„å…³è”å¯¹è±¡ã€‚å®ƒåˆ©ç”¨ç±»ä¸ç±»ä¹‹é—´çš„å…³ç³»æ¥æ£€ç´¢å¯¹è±¡ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬é€šè¿‡IDæŸ¥è¯¢æ–¹å¼æŸ¥å‡ºä¸€ä¸ªå®¢æˆ·ï¼Œå¯ä»¥è°ƒç”¨Customerç±»ä¸­çš„getLinkMans()æ–¹æ³•æ¥è·å–è¯¥å®¢æˆ·çš„æ‰€æœ‰è”ç³»äººã€‚å¯¹è±¡å¯¼èˆªæŸ¥è¯¢çš„ä½¿ç”¨è¦æ±‚æ˜¯ï¼šä¸¤ä¸ªå¯¹è±¡ä¹‹é—´å¿…é¡»å­˜åœ¨å…³è”å…³ç³»ã€‚**æŸ¥è¯¢ä¸€ä¸ªPersonè·å–å®ƒå¯¹åº”çš„æ‰€æœ‰Role**```java @Transactional @Test public void test3()&#123; Person person = personMapper.findById(11l).get(); System.out.println(&quot;person = &quot; + person); person.getRoles().forEach(System.out::println); &#125; æŸ¥è¯¢ä¸€ä¸ªè§’è‰²ï¼Œè·å–è§’è‰²å¯¹åº”çš„æ‰€æœ‰person 1234567@Transactional@Testpublic void test3()&#123; Role role = roleMapper.findById(5l).get(); System.out.println(&quot;role = &quot; + role); role.getPersons().forEach(System.out::println);&#125; å¯¹è±¡å¯¼èˆªæŸ¥è¯¢çš„é—®é¢˜åˆ†æ é—®é¢˜1ï¼šæˆ‘ä»¬æŸ¥è¯¢å®¢æˆ·æ—¶ï¼Œè¦ä¸è¦æŠŠè”ç³»äººæŸ¥è¯¢å‡ºæ¥ï¼Ÿ åˆ†æï¼šå¦‚æœæˆ‘ä»¬ä¸æŸ¥çš„è¯ï¼Œåœ¨ç”¨çš„æ—¶å€™è¿˜è¦è‡ªå·±å†™ä»£ç ï¼Œè°ƒç”¨æ–¹æ³•å»æŸ¥è¯¢ã€‚å¦‚æœæˆ‘ä»¬æŸ¥å‡ºæ¥çš„ï¼Œä¸ä½¿ç”¨æ—¶åˆä¼šç™½ç™½çš„æµªè´¹äº†æœåŠ¡å™¨å†…å­˜ã€‚ è§£å†³ï¼šé‡‡ç”¨å»¶è¿ŸåŠ è½½çš„æ€æƒ³ã€‚é€šè¿‡é…ç½®çš„æ–¹å¼æ¥è®¾å®šå½“æˆ‘ä»¬åœ¨éœ€è¦ä½¿ç”¨æ—¶ï¼Œå‘èµ·çœŸæ­£çš„æŸ¥è¯¢ã€‚ é…ç½®æ–¹å¼ï¼š 12//LAZY @ManyToMany(mappedBy =&quot;persons&quot;,fetch = FetchType.EAGER) FetchType.EAGER ç«‹å³åŠ è½½ FetchType.LAZY æ‡’åŠ è½½","categories":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://yinhuidong.github.io/categories/MyBatis/"}],"tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://yinhuidong.github.io/tags/MyBatis/"}]},{"title":"MyBatisåº”ç”¨åˆ†æä¸æœ€ä½³å®è·µ","slug":"MyBatis/MyBatisåº”ç”¨åˆ†æä¸æœ€ä½³å®è·µ","date":"2022-01-11T06:37:23.826Z","updated":"2022-01-11T06:40:09.343Z","comments":true,"path":"2022/01/11/MyBatis/MyBatisåº”ç”¨åˆ†æä¸æœ€ä½³å®è·µ/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MyBatis/MyBatis%E5%BA%94%E7%94%A8%E5%88%86%E6%9E%90%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/","excerpt":"","text":"å†™åœ¨å‰é¢ï¼šå…¨æ–‡ä»£ç gitåœ°å€ï¼šhttps://gitee.com/yin_huidong/mybatis-use.git ä¸€ï¼ŒMyBatiså…¥é—¨æŒä¹…å±‚æŠ€æœ¯çš„è§£å†³æ–¹æ¡ˆï¼š JDBC Springçš„JdbcTemplate Apacheçš„DbUtils ä»¥ä¸Šéƒ½ä¸æ˜¯æ¡†æ¶ï¼ŒJDBCæ˜¯è§„èŒƒï¼ŒSpringçš„JdbcTemplateå’ŒApacheçš„DBUtilséƒ½åªæ˜¯å·¥å…·ç±»ã€‚â€‹ MyBatisæ¦‚è¿°ï¼šä¸€ä¸ªç”¨Javaç¼–å†™çš„æŒä¹…å±‚æ¡†æ¶ï¼Œå°è£…äº†JDBCæ“ä½œçš„å¾ˆå¤šç»†èŠ‚ï¼Œæ˜¯å¼€å‘è€…åªéœ€è¦å…³æ³¨SQLè¯­å¥æœ¬èº«ï¼Œä¸éœ€è¦å…³æ³¨æ•´ä¸ªè¯·æ±‚è¿‡ç¨‹ã€‚ ORMï¼šObject Relational Mappging å¯¹è±¡å…³ç³»æ˜ å°„ã€‚ç®€å•çš„è¯´ï¼šå°±æ˜¯æŠŠæ•°æ®åº“è¡¨å’Œå®ä½“ç±»åŠå®ä½“ç±»çš„å±æ€§å¯¹åº”èµ·æ¥ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ“ä½œå®ä½“ç±»å°±å®ç°æ“ä½œæ•°æ®åº“è¡¨ã€‚ t_user TUser id id name name â€‹ 1.mybatisç¯å¢ƒæ­å»º åˆ›å»ºmavenå·¥ç¨‹ï¼Œå¯¼å…¥åæ ‡ åˆ›å»ºå®ä½“ç±»å’Œmapperæ¥å£ åˆ›å»ºmybatisçš„ä¸»é…ç½®æ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶ åˆ›å»ºæ˜ å°„é…ç½®æ–‡ä»¶ â€‹ 2.æ³¨æ„äº‹é¡¹ åœ¨ideaä¸­åˆ›å»ºç›®å½•çš„æ—¶å€™ï¼Œå®ƒå’ŒåŒ…æ˜¯ä¸ä¸€æ ·çš„ã€‚ åŒ…åœ¨åˆ›å»ºæ—¶ï¼šcom.itheima.daoå®ƒæ˜¯ä¸‰çº§ç»“æ„ ç›®å½•åœ¨åˆ›å»ºæ—¶ï¼šcom.itheima.daoæ˜¯ä¸€çº§ç›®å½• mybatisçš„æ˜ å°„é…ç½®æ–‡ä»¶ä½ç½®å¿…é¡»å’Œdaoæ¥å£çš„åŒ…ç»“æ„ç›¸åŒ æ˜ å°„é…ç½®æ–‡ä»¶çš„mapperæ ‡ç­¾namespaceå±æ€§çš„å–å€¼å¿…é¡»æ˜¯daoæ¥å£çš„å…¨é™å®šç±»å æ˜ å°„é…ç½®æ–‡ä»¶çš„æ“ä½œé…ç½®ï¼ˆselectï¼‰ï¼Œidå±æ€§çš„å–å€¼å¿…é¡»æ˜¯daoæ¥å£çš„æ–¹æ³•å â€‹ 3.åŸºäºXMLå½¢å¼çš„é…ç½®ä»£ç ï¼šmybatis-01â€‹ 4.åŸºäºæ³¨è§£å½¢å¼çš„é…ç½®ä»£ç ï¼šmybatis-02â€‹ 5.æ€è€ƒè‡ªå·±å®ç°mybatisæ¡†æ¶ 5.1 éœ€æ±‚åˆ†æ å®ƒéœ€è¦å®ç°å¯¹è¿æ¥èµ„æºçš„è‡ªåŠ¨ç®¡ç†ï¼Œä¹Ÿå°±æ˜¯æŠŠåˆ›å»º Connectionã€Statementã€å…³é—­ Connectionã€Statementã€ResultSet è¿™äº›æ“ä½œå°è£…åˆ°åº•å±‚çš„å¯¹è±¡ä¸­ï¼Œä¸éœ€è¦åœ¨åº”ç”¨å±‚æ‰‹åŠ¨è°ƒç”¨ã€‚ å®ƒéœ€è¦æŠŠ SQL è¯­å¥æŠ½ç¦»å‡ºæ¥å®ç°é›†ä¸­ç®¡ç†ï¼Œå¼€å‘äººå‘˜ä¸ç”¨åœ¨ä¸šåŠ¡ä»£ç é‡Œé¢å†™ SQLè¯­å¥ã€‚ å®ƒéœ€è¦å®ç°å¯¹ç»“æœé›†çš„è½¬æ¢ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æŒ‡å®šäº†æ˜ å°„è§„åˆ™ä¹‹åï¼Œè¿™ä¸ªæ¡†æ¶ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æŠŠ ResultSet æ˜ å°„æˆå®ä½“ç±»å¯¹è±¡ã€‚ éœ€è¦æä¾›ä¸€ä¸ª API æ¥ç»™æˆ‘ä»¬æ“ä½œæ•°æ®åº“ï¼Œè¿™é‡Œé¢å°è£…äº†å¯¹æ•°æ®åº“çš„æ“ä½œçš„å¸¸ç”¨çš„æ–¹æ³•ã€‚ 5.2 æ¦‚è¦è®¾è®¡â‘  æ ¸å¿ƒå¯¹è±¡ å­˜æ”¾å‚æ•°å’Œç»“æœæ˜ å°„å…³ç³»ã€å­˜æ”¾ SQL è¯­å¥ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªé…ç½®ç±» æ‰§è¡Œå¯¹æ•°æ®åº“çš„æ“ä½œï¼Œå¤„ç†å‚æ•°å’Œç»“æœé›†çš„æ˜ å°„ï¼Œåˆ›å»ºå’Œé‡Šæ”¾èµ„æºï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªæ‰§è¡Œå™¨ æœ‰äº†è¿™ä¸ªæ‰§è¡Œå™¨ä»¥åï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨å®ƒï¼Œè€Œæ˜¯å®šä¹‰ä¸€ä¸ªç»™åº”ç”¨å±‚ä½¿ç”¨çš„ APIï¼Œå®ƒå¯ä»¥æ ¹æ® SQL çš„ id æ‰¾åˆ° SQL è¯­å¥ï¼Œäº¤ç»™æ‰§è¡Œå™¨æ‰§è¡Œ ç›´æ¥ä½¿ç”¨ id æŸ¥æ‰¾ SQL è¯­å¥å¤ªéº»çƒ¦äº†ï¼Œæˆ‘ä»¬å¹²è„†æŠŠå­˜æ”¾ SQL çš„å‘½åç©ºé—´å®šä¹‰æˆä¸€ä¸ªæ¥å£ï¼ŒæŠŠ SQL çš„ id å®šä¹‰æˆæ–¹æ³•ï¼Œè¿™æ ·åªè¦è°ƒç”¨æ¥å£æ–¹æ³•å°±å¯ä»¥æ‰¾åˆ°è¦æ‰§è¡Œçš„ SQLã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªä»£ç†ç±»ã€‚ â‘¡ æµç¨‹åˆ†æ å®šä¹‰æ¥å£ Mapper å’Œæ–¹æ³•ï¼Œç”¨æ¥è°ƒç”¨æ•°æ®åº“æ“ä½œã€‚Mapper æ¥å£æ“ä½œæ•°æ®åº“éœ€è¦é€šè¿‡ä»£ç†ç±»ã€‚ å®šä¹‰é…ç½®ç±»å¯¹è±¡ Configurationã€‚ å®šä¹‰åº”ç”¨å±‚çš„ API SqlSessionã€‚å®ƒæœ‰ä¸€ä¸ª getMapper()æ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šä»é…ç½®ç±»Configuration é‡Œé¢ä½¿ç”¨ Proxy.newProxyInatance()æ‹¿åˆ°ä¸€ä¸ªä»£ç†å¯¹è±¡ MapperProxyã€‚ æœ‰äº†ä»£ç†å¯¹è±¡ MapperProxy ä¹‹åï¼Œæˆ‘ä»¬è°ƒç”¨æ¥å£çš„ä»»æ„æ–¹æ³•ï¼Œå°±æ˜¯è°ƒç”¨ä»£ç†å¯¹è±¡çš„ invoke()æ–¹æ³•ã€‚ ä»£ç†å¯¹è±¡ MapperProxy çš„ invoke()æ–¹æ³•è°ƒç”¨äº† SqlSession çš„ selectOne()ã€‚ SqlSession åªæ˜¯ä¸€ä¸ª APIï¼Œè¿˜ä¸æ˜¯çœŸæ­£çš„ SQL æ‰§è¡Œè€…ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ä¼šè°ƒç”¨æ‰§è¡Œå™¨ Executor çš„ query()æ–¹æ³•ã€‚ æ‰§è¡Œå™¨ Executor çš„ query()æ–¹æ³•é‡Œé¢å°±æ˜¯å¯¹ JDBC åº•å±‚çš„ Statement çš„å°è£…ï¼Œæœ€ç»ˆå®ç°å¯¹æ•°æ®åº“çš„æ“ä½œï¼Œå’Œç»“æœçš„è¿”å›ã€‚ 5.3 ä»£ç &amp;æ€è€ƒmybatis-0 åœ¨ Executor ä¸­ï¼Œå¯¹å‚æ•°ã€è¯­å¥å’Œç»“æœé›†çš„å¤„ç†æ˜¯è€¦åˆçš„ï¼Œæ²¡æœ‰å®ç°èŒè´£åˆ†ç¦»ï¼› å‚æ•°ï¼šæ²¡æœ‰å®ç°å¯¹è¯­å¥çš„é¢„ç¼–è¯‘ï¼Œåªæœ‰ç®€å•çš„æ ¼å¼åŒ–ï¼ˆformatï¼‰ï¼Œæ•ˆç‡ä¸é«˜ï¼Œè¿˜å­˜åœ¨ SQL æ³¨å…¥çš„é£é™©ï¼› è¯­å¥æ‰§è¡Œï¼šæ•°æ®åº“è¿æ¥ç¡¬ç¼–ç ï¼› ç»“æœé›†ï¼šè¿˜åªèƒ½å¤„ç† Blog ç±»å‹ï¼Œæ²¡æœ‰å®ç°æ ¹æ®å®ä½“ç±»è‡ªåŠ¨æ˜ å°„ã€‚ç¡®å®æœ‰ç‚¹æ“ï¼Œæ‹¿ä¸å‡ºæ‰‹ã€‚ å±•æœ› æ”¯æŒå‚æ•°é¢„ç¼–è¯‘ æ”¯æŒç»“æœé›†çš„è‡ªåŠ¨å¤„ç†ï¼ˆé€šè¿‡åå°„ï¼‰ å¯¹ Executor çš„èŒè´£è¿›è¡Œç»†åŒ– åœ¨æ–¹æ³•ä¸Šä½¿ç”¨æ³¨è§£é…ç½® SQL æŸ¥è¯¢å¸¦ç¼“å­˜åŠŸèƒ½ æ”¯æŒè‡ªå®šä¹‰æ’ä»¶6.Mybatisä¸jdbcç¼–ç¨‹æ¯”è¾ƒ æ•°æ®åº“é“¾æ¥åˆ›å»ºã€é‡Šæ”¾é¢‘ç¹é€ æˆç³»ç»Ÿèµ„æºæµªè´¹ä»è€Œå½±å“ç³»ç»Ÿæ€§èƒ½ï¼Œå¦‚æœä½¿ç”¨æ•°æ®åº“é“¾æ¥æ± å¯è§£å†³æ­¤é—®é¢˜ã€‚ è§£å†³ï¼šåœ¨ SqlMapConfig.xml ä¸­é…ç½®æ•°æ®é“¾æ¥æ± ï¼Œä½¿ç”¨è¿æ¥æ± ç®¡ç†æ•°æ®åº“é“¾æ¥ã€‚ Sql è¯­å¥å†™åœ¨ä»£ç ä¸­é€ æˆä»£ç ä¸æ˜“ç»´æŠ¤ï¼Œå®é™…åº”ç”¨ sql å˜åŒ–çš„å¯èƒ½è¾ƒå¤§ï¼Œsql å˜åŠ¨éœ€è¦æ”¹å˜ java ä»£ç ã€‚ è§£å†³ï¼šå°† Sql è¯­å¥é…ç½®åœ¨ XXXXmapper.xml æ–‡ä»¶ä¸­ä¸ java ä»£ç åˆ†ç¦»ã€‚ å‘ sql è¯­å¥ä¼ å‚æ•°éº»çƒ¦ï¼Œå› ä¸º sql è¯­å¥çš„ where æ¡ä»¶ä¸ä¸€å®šï¼Œå¯èƒ½å¤šä¹Ÿå¯èƒ½å°‘ï¼Œå ä½ç¬¦éœ€è¦å’Œå‚æ•°å¯¹åº”ã€‚ è§£å†³ï¼šMybatis è‡ªåŠ¨å°† java å¯¹è±¡æ˜ å°„è‡³ sql è¯­å¥ï¼Œé€šè¿‡ statement ä¸­çš„ parameterType å®šä¹‰è¾“å…¥å‚æ•°çš„ç±»å‹ã€‚ å¯¹ç»“æœé›†è§£æéº»çƒ¦ï¼Œsql å˜åŒ–å¯¼è‡´è§£æä»£ç å˜åŒ–ï¼Œä¸”è§£æå‰éœ€è¦éå†ï¼Œå¦‚æœèƒ½å°†æ•°æ®åº“è®°å½•å°è£…æˆ pojo å¯¹è±¡è§£ææ¯”è¾ƒæ–¹ä¾¿ã€‚ è§£å†³ï¼šMybatis è‡ªåŠ¨å°† sql æ‰§è¡Œç»“æœæ˜ å°„è‡³ java å¯¹è±¡ï¼Œé€šè¿‡ statement ä¸­çš„ resultType å®šä¹‰è¾“å‡ºç»“æœçš„ç±»å‹ äºŒï¼ŒåŸºäºMybatiså®ç°åŸºæœ¬çš„å¢åˆ æ”¹æŸ¥1.ä»£ç mybatis-03â€‹ 2.Mapperæ˜ å°„æ–‡ä»¶è¯¦è§£ æ˜ å°„å™¨é‡Œé¢æœ€ä¸»è¦çš„æ˜¯é…ç½®äº† SQL è¯­å¥ï¼Œä¹Ÿè§£å†³äº†æˆ‘ä»¬çš„å‚æ•°æ˜ å°„å’Œç»“æœé›†æ˜ å°„çš„é—®é¢˜ã€‚ä¸€å…±æœ‰ 8 ä¸ªæ ‡ç­¾ï¼š cache â€“ ç»™å®šå‘½åç©ºé—´çš„ç¼“å­˜é…ç½®ï¼ˆæ˜¯å¦å¼€å¯äºŒçº§ç¼“å­˜ï¼‰ã€‚ cache-ref â€“ å…¶ä»–å‘½åç©ºé—´ç¼“å­˜é…ç½®çš„å¼•ç”¨ã€‚ resultMap â€“ æ˜¯æœ€å¤æ‚ä¹Ÿæ˜¯æœ€å¼ºå¤§çš„å…ƒç´ ï¼Œç”¨æ¥æè¿°å¦‚ä½•ä»æ•°æ®åº“ç»“æœé›†ä¸­æ¥åŠ è½½å¯¹è±¡ã€‚ sql â€“ å¯è¢«å…¶ä»–è¯­å¥å¼•ç”¨çš„å¯é‡ç”¨è¯­å¥å—ã€‚ insert â€“ æ˜ å°„æ’å…¥è¯­å¥ update â€“ æ˜ å°„æ›´æ–°è¯­å¥ delete â€“ æ˜ å°„åˆ é™¤è¯­å¥ select â€“ æ˜ å°„æŸ¥è¯¢è¯­å¥ 2.1 select æ ‡ç­¾ resultType å±æ€§ï¼šç”¨äºæŒ‡å®šç»“æœé›†çš„ç±»å‹ã€‚ parameterType å±æ€§ï¼šç”¨äºæŒ‡å®šä¼ å…¥å‚æ•°çš„ç±»å‹ã€‚ sql è¯­å¥ä¸­ä½¿ç”¨#{}å­—ç¬¦ï¼š å®ƒä»£è¡¨å ä½ç¬¦ï¼Œç›¸å½“äºåŸæ¥ jdbc éƒ¨åˆ†æ‰€å­¦çš„?ï¼Œéƒ½æ˜¯ç”¨äºæ‰§è¡Œè¯­å¥æ—¶æ›¿æ¢å®é™…çš„æ•°æ®ã€‚å…·ä½“çš„æ•°æ®æ˜¯ç”±#{}é‡Œé¢çš„å†…å®¹å†³å®šçš„ã€‚#{}ä¸­å†…å®¹çš„å†™æ³•ï¼šç”±äºæ•°æ®ç±»å‹æ˜¯åŸºæœ¬ç±»å‹ï¼Œæ‰€ä»¥æ­¤å¤„å¯ä»¥éšæ„å†™ã€‚â€‹ 2.2 insert æ ‡ç­¾ parameterType å±æ€§ï¼šä»£è¡¨å‚æ•°çš„ç±»å‹ï¼Œå› ä¸ºæˆ‘ä»¬è¦ä¼ å…¥çš„æ˜¯ä¸€ä¸ªç±»çš„å¯¹è±¡ï¼Œæ‰€ä»¥ç±»å‹å°±å†™ç±»çš„å…¨åç§°ã€‚ sql è¯­å¥ä¸­ä½¿ç”¨#{}å­—ç¬¦ï¼š å®ƒä»£è¡¨å ä½ç¬¦ï¼Œç›¸å½“äºåŸæ¥ jdbc éƒ¨åˆ†æ‰€å­¦çš„?ï¼Œéƒ½æ˜¯ç”¨äºæ‰§è¡Œè¯­å¥æ—¶æ›¿æ¢å®é™…çš„æ•°æ®ã€‚å…·ä½“çš„æ•°æ®æ˜¯ç”±#{}é‡Œé¢çš„å†…å®¹å†³å®šçš„ã€‚ #{}ä¸­å†…å®¹çš„å†™æ³•ï¼šç”±äºæˆ‘ä»¬ä¿å­˜æ–¹æ³•çš„å‚æ•°æ˜¯ ä¸€ä¸ª User å¯¹è±¡ï¼Œæ­¤å¤„è¦å†™ User å¯¹è±¡ä¸­çš„å±æ€§åç§°ã€‚å®ƒç”¨çš„æ˜¯ ognl è¡¨è¾¾å¼ã€‚ â€‹ 2.3 OGNL è¡¨è¾¾å¼ognl è¡¨è¾¾å¼ï¼šå®ƒæ˜¯ apache æä¾›çš„ä¸€ç§è¡¨è¾¾å¼è¯­è¨€ï¼Œå…¨ç§°æ˜¯ï¼šObject Graphic Navigation Language å¯¹è±¡å›¾å¯¼èˆªè¯­è¨€ï¼Œå®ƒæ˜¯æŒ‰ç…§ä¸€å®šçš„è¯­æ³•æ ¼å¼æ¥è·å–æ•°æ®çš„ã€‚â€‹ è¯­æ³•æ ¼å¼å°±æ˜¯ä½¿ç”¨ #{å¯¹è±¡.å¯¹è±¡}çš„æ–¹å¼ï¼š#{user.username}å®ƒä¼šå…ˆå»æ‰¾ user å¯¹è±¡ï¼Œç„¶ååœ¨ user å¯¹è±¡ä¸­æ‰¾åˆ° username å±æ€§ï¼Œå¹¶è°ƒç”¨getUsername()æ–¹æ³•æŠŠå€¼å–å‡ºæ¥ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨ parameterType å±æ€§ä¸ŠæŒ‡å®šäº†å®ä½“ç±»åç§°ï¼Œæ‰€ä»¥å¯ä»¥çœç•¥ user.è€Œç›´æ¥å†™ usernameã€‚â€‹ 2.4 æ’å…¥åä¸»é”®è¿”å›çš„ä¸‰ç§æ–¹å¼æ–°å¢ç”¨æˆ·åï¼ŒåŒæ—¶è¿˜è¦è¿”å›å½“å‰æ–°å¢ç”¨æˆ·çš„ id å€¼ï¼Œå› ä¸º id æ˜¯ç”±æ•°æ®åº“çš„è‡ªåŠ¨å¢é•¿æ¥å®ç°çš„ï¼Œæ‰€ä»¥å°±ç›¸â€‹å½“äºæˆ‘ä»¬è¦åœ¨æ–°å¢åå°†è‡ªåŠ¨å¢é•¿ auto_increment çš„å€¼è¿”å›ã€‚ â‘ æ–¹æ³•ä¸€123&lt;insert id=&quot;add&quot; useGeneratedKeys=&quot;true&quot; keyProperty=&quot;id&quot; parameterType=&quot;com.yhd.domain.Account&quot;&gt; insert into account(name,money) values (#&#123;name&#125;,#&#123;money&#125;);&lt;/insert&gt; â‘¡æ–¹æ³•äºŒ123456&lt;insert id=&quot;add&quot; &gt; &lt;selectKey order=&quot;AFTER&quot; keyProperty=&quot;id&quot; resultType=&quot;int&quot;&gt; select last_insert_id(); &lt;/selectKey&gt; insert into account(name,money) values (#&#123;name&#125;,#&#123;money&#125;);&lt;/insert&gt; â‘¢æ–¹æ³•ä¸‰å¯ä»¥æŠŠæŸ¥è¯¢å›æ¥çš„å¤šæ¡æ•°æ®å°è£…ä¸ºMapï¼ŒMapçš„é”®æ˜¯æˆ‘ä»¬æŒ‡å®šçš„å”¯ä¸€é”®çš„å€¼ï¼ŒMapçš„valueæ˜¯æ¯ä¸€è¡Œè®°å½•è½¬æ¢çš„å¯¹è±¡ã€‚ 12@MapKey(&quot;id&quot;)Map&lt;Integer,Account&gt; findAllByMap(); 123&lt;select id=&quot;findAllByMap&quot; resultType=&quot;account&quot;&gt; select * from account;&lt;/select&gt; 2.5 æ ¹æ®åç§°æ¨¡ç³ŠæŸ¥è¯¢â‘ ç¬¬ä¸€ç§æ–¹å¼æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰åŠ å…¥%æ¥ä½œä¸ºæ¨¡ç³ŠæŸ¥è¯¢çš„æ¡ä»¶ï¼Œæ‰€ä»¥åœ¨ä¼ å…¥å­—ç¬¦ä¸²å®å‚æ—¶ï¼Œå°±éœ€è¦ç»™å®šæ¨¡ç³ŠæŸ¥è¯¢çš„æ ‡è¯†%ã€‚é…ç½®æ–‡ä»¶ä¸­çš„#{username}ä¹Ÿåªæ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œæ‰€ä»¥ SQL è¯­å¥æ˜¾ç¤ºä¸ºâ€œï¼Ÿâ€ã€‚â€‹ 123&lt;!-- æ ¹æ®åç§°æ¨¡ç³ŠæŸ¥è¯¢ --&gt; &lt;select id=&quot;findByName&quot; resultType=&quot;com.yhd.domain.User&quot; parameterType=&quot;String&quot;&gt; select * from user where username like % #&#123;username&#125; %&lt;/select&gt; â‘¡ç¬¬äºŒç§æ–¹å¼123456ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹ SQL è¯­å¥çš„é…ç½®ï¼Œé…ç½®å¦‚ä¸‹ï¼š&lt;!-- æ ¹æ®åç§°æ¨¡ç³ŠæŸ¥è¯¢ --&gt; &lt;select id=&quot;findByName&quot; parameterType=&quot;string&quot; resultType=&quot;com.yhd.domain.User&quot;&gt; select * from user where username like &#x27;%$&#123;value&#125;%&#x27;&lt;/select&gt; æˆ‘ä»¬åœ¨ä¸Šé¢å°†åŸæ¥çš„#{}å ä½ç¬¦ï¼Œæ”¹æˆäº†${value}ã€‚æ³¨æ„å¦‚æœç”¨æ¨¡ç³ŠæŸ¥è¯¢çš„è¿™ç§å†™æ³•ï¼Œé‚£ä¹ˆ${value}çš„å†™æ³•å°±æ˜¯å›ºå®šçš„ï¼Œä¸èƒ½å†™æˆå…¶å®ƒåå­—ã€‚â€‹ â‘¢ #{}å’Œ${}çš„åŒºåˆ« #{}è¡¨ç¤ºä¸€ä¸ªå ä½ç¬¦å· é€šè¿‡#{}å¯ä»¥å®ç° preparedStatement å‘å ä½ç¬¦ä¸­è®¾ç½®å€¼ï¼Œè‡ªåŠ¨è¿›è¡Œ java ç±»å‹å’Œ jdbc ç±»å‹è½¬æ¢ï¼Œ #{}å¯ä»¥æœ‰æ•ˆé˜²æ­¢ sql æ³¨å…¥ã€‚ #{}å¯ä»¥æ¥æ”¶ç®€å•ç±»å‹å€¼æˆ– pojo å±æ€§å€¼ã€‚ å¦‚æœ parameterType ä¼ è¾“å•ä¸ªç®€å• ç±»å‹å€¼ï¼Œ#{}æ‹¬å·ä¸­å¯ä»¥æ˜¯ value æˆ–å…¶å®ƒåç§°ã€‚${}è¡¨ç¤ºæ‹¼æ¥ sql ä¸² é€šè¿‡${}å¯ä»¥å°† parameterType ä¼ å…¥çš„å†…å®¹æ‹¼æ¥åœ¨ sql ä¸­ä¸”ä¸è¿›è¡Œ jdbc ç±»å‹è½¬æ¢ï¼Œ ${}å¯ä»¥æ¥æ”¶ç®€ å•ç±»å‹å€¼æˆ– pojo å±æ€§å€¼ï¼Œå¦‚æœ parameterType ä¼ è¾“å•ä¸ªç®€å•ç±»å‹å€¼ï¼Œ${}æ‹¬å·ä¸­åªèƒ½æ˜¯ valueã€‚ â‘£æ¨¡ç³ŠæŸ¥è¯¢${value}çš„æºç 12345678910111213@Override public String handleToken(String content) &#123; Object parameter = context.getBindings().get(&quot;_parameter&quot;); if (parameter == null) &#123; context.getBindings().put(&quot;value&quot;, null); &#125; else if (SimpleTypeRegistry.isSimpleType(parameter.getClass())) &#123; context.getBindings().put(&quot;value&quot;, parameter); &#125; Object value = OgnlCache.getValue(content, context.getBindings()); String srtValue = (value == null ? &quot;&quot; : String.valueOf(value)); checkInjection(srtValue); return srtValue; &#125; è¿™å°±è¯´æ˜äº†æºç ä¸­æŒ‡å®šäº†è¯»å–çš„ key çš„åå­—å°±æ˜¯â€valueâ€ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç»‘å®šå‚æ•°æ—¶å°±åªèƒ½å« value çš„åå­—äº†ã€‚â€‹ 2.6 resultType é…ç½®ç»“æœç±»å‹resultTypeé…ç½®ç»“æœç±»å‹:å½“ä»–ä¸ºå®ä½“ç±»å…¨é™å®šç±»åï¼Œå¿…é¡»è®©å®ä½“ç±»çš„å±æ€§åä¸æ•°æ®åº“è¡¨çš„åˆ—åå¯¹åº”ï¼Œå¦åˆ™ï¼Œæ•°æ®ä¼šå°è£…ä¸è¿›å»ï¼Œå½“ç„¶ï¼Œä¹Ÿå­˜åœ¨è§£å†³åŠæ³•ã€‚è§£å†³åŠæ³•ï¼š èµ·åˆ«åï¼Œåœ¨sqlè¯­å¥ä¸­ç»™æ•°æ®åº“è¡¨çš„åˆ—åèµ·åˆ«åï¼Œåˆ«åä¸å®ä½“ç±»çš„å±æ€§åä¸€è‡´ ä¼˜ç‚¹ï¼šæ‰§è¡Œæ•ˆç‡é«˜ ç¼ºç‚¹ï¼šå¼€å‘æ•ˆç‡ä½ é…ç½®resultMap è‡ªå®šä¹‰ä¸€ä¸ªresultMapï¼Œåœ¨selectæ ‡ç­¾ä¸­è¿›è¡Œå¼•ç”¨ ä¼˜ç‚¹ï¼šå¼€å‘æ•ˆç‡é«˜ ç¼ºç‚¹ï¼šæ‰§è¡Œæ•ˆç‡ä½â€‹ 123456789101112131415&lt;resultMap id=&quot;map&quot; type=&quot;com.atguigu.domain.User&quot;&gt; &lt;!--é…ç½®ä¸»é”®--&gt; &lt;id column=&quot;id&quot; property=&quot;id&quot;&gt;&lt;/id&gt; &lt;!--é…ç½®å…¶ä»–åˆ—--&gt; &lt;result column=&quot;birthday&quot; property=&quot;birthday&quot;&gt;&lt;/result&gt; &lt;result column=&quot;sex&quot; property=&quot;sex&quot;&gt;&lt;/result&gt; &lt;result column=&quot;address&quot; property=&quot;address&quot;&gt;&lt;/result&gt; &lt;result column=&quot;username&quot; property=&quot;username&quot;&gt;&lt;/result&gt; &lt;!-- id æ ‡ç­¾ï¼šç”¨äºæŒ‡å®šä¸»é”®å­—æ®µ result æ ‡ç­¾ï¼šç”¨äºæŒ‡å®šéä¸»é”®å­—æ®µ column å±æ€§ï¼šç”¨äºæŒ‡å®šæ•°æ®åº“åˆ—å property å±æ€§ï¼šç”¨äºæŒ‡å®šå®ä½“ç±»å±æ€§åç§° --&gt;&lt;/resultMap&gt; 1234&lt;!-- é…ç½®æŸ¥è¯¢æ‰€æœ‰æ“ä½œ --&gt; &lt;select id=&quot;findAll&quot; resultMap=&quot;userMap&quot;&gt; select * from user&lt;/select&gt; 3.æ ¸å¿ƒé…ç½®è§£è¯»configurationMyBatis å…¨å±€é…ç½®æ–‡ä»¶é¡ºåºæ˜¯å›ºå®šçš„ï¼Œå¦åˆ™å¯åŠ¨çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚ propertiesé…ç½®å‚æ•°ä¿¡æ¯ï¼Œæ¯”å¦‚æœ€å¸¸è§çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€‚ ä¸ºäº†é¿å…ç›´æ¥æŠŠå‚æ•°å†™æ­»åœ¨ xml é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™äº›å‚æ•°å•ç‹¬æ”¾åœ¨properties æ–‡ä»¶ä¸­ï¼Œç”¨ properties æ ‡ç­¾å¼•å…¥è¿›æ¥ï¼Œç„¶ååœ¨ xml é…ç½®æ–‡ä»¶ä¸­ç”¨${}å¼•ç”¨å°±å¯ä»¥äº†ã€‚ å¯ä»¥ç”¨ resource å¼•ç”¨åº”ç”¨é‡Œé¢çš„ç›¸å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥ç”¨ url æŒ‡å®šæœ¬åœ°æœåŠ¡å™¨æˆ–è€…ç½‘ç»œçš„ç»å¯¹è·¯å¾„ã€‚ settings å±æ€§å å«ä¹‰ ç®€ä»‹ æœ‰æ•ˆå€¼ é»˜è®¤å€¼ cacheEnabled æ˜¯å¦ä½¿ç”¨ç¼“å­˜ æ˜¯æ•´ä¸ªå·¥ç¨‹ä¸­æ‰€æœ‰æ˜ å°„å™¨é…ç½®ç¼“å­˜çš„å¼€å…³ï¼Œå³æ˜¯ä¸€ä¸ªå…¨å±€ç¼“å­˜å¼€å…³ true/false true lazyLoadingEnabled æ˜¯å¦å¼€å¯å»¶è¿ŸåŠ è½½ æ§åˆ¶å…¨å±€æ˜¯å¦ä½¿ç”¨å»¶è¿ŸåŠ è½½ï¼ˆassociationã€collectionï¼‰ã€‚å½“æœ‰ç‰¹æ®Šå…³è”å…³ç³»éœ€è¦å•ç‹¬é…ç½®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ fetchType å±æ€§æ¥è¦†ç›–æ­¤é…ç½® true/false false aggressiveLazyLoading æ˜¯å¦éœ€è¦ä¾µå…¥å¼å»¶è¿ŸåŠ è½½ å¼€å¯æ—¶ï¼Œæ— è®ºè°ƒç”¨ä»€ä¹ˆæ–¹æ³•åŠ è½½æŸä¸ªå¯¹è±¡ï¼Œéƒ½ä¼šåŠ è½½è¯¥å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œå…³é—­ä¹‹ååªä¼šæŒ‰éœ€åŠ è½½ true/false false defaultExecutorType è®¾ç½®é»˜è®¤çš„æ‰§è¡Œå™¨ æœ‰ä¸‰ç§æ‰§è¡Œå™¨ï¼šSIMPLE ä¸ºæ™®é€šæ‰§è¡Œå™¨ï¼›REUSE æ‰§è¡Œå™¨ä¼šé‡ç”¨ä¸å¤„ç†è¯­å¥ï¼›BATCH æ‰§è¡Œå™¨å°†é‡ç”¨è¯­å¥å¹¶æ‰§è¡Œæ‰¹é‡æ›´æ–° SIMPLE/REUSE/BATCH SIMPLE lazyLoadTriggerMethods æŒ‡å®šå“ªä¸ªå¯¹è±¡çš„æ–¹æ³•è§¦å‘ä¸€æ¬¡å»¶è¿ŸåŠ è½½ é…ç½®éœ€è¦è§¦å‘å»¶è¿ŸåŠ è½½çš„æ–¹æ³•çš„åå­—ï¼Œè¯¥æ–¹æ³•å°±ä¼šè§¦å‘ä¸€æ¬¡å»¶è¿ŸåŠ è½½ ä¸€ä¸ªé€—å·åˆ†éš”çš„æ–¹æ³•åç§°åˆ—è¡¨ equalsï¼Œcloneï¼ŒhashCodeï¼ŒtoString localCacheScope MyBatis åˆ©ç”¨æœ¬åœ°ç¼“å­˜æœºåˆ¶ï¼ˆLocalCacheï¼‰é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼ˆcircularreferencesï¼‰å’ŒåŠ é€Ÿé‡å¤åµŒå¥—æŸ¥è¯¢ é»˜è®¤å€¼ä¸º SESSIONï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šç¼“å­˜ä¸€ä¸ªä¼šè¯ä¸­æ‰§è¡Œçš„æ‰€æœ‰æŸ¥è¯¢ã€‚è‹¥è®¾ç½®å€¼ä¸º STATEMENTï¼Œæœ¬åœ°ä¼šè¯ä»…ç”¨åœ¨è¯­å¥æ‰§è¡Œä¸Šï¼Œå¯¹ç›¸åŒ SqlSession çš„ä¸åŒè°ƒç”¨å°†ä¸ä¼šå…±äº«æ•°æ® SESSION/STATEMENT SESSION logImpl æ—¥å¿—å®ç° æŒ‡å®š MyBatis æ‰€ç”¨æ—¥å¿—çš„å…·ä½“å®ç°ï¼ŒæœªæŒ‡å®šæ—¶å°†è‡ªåŠ¨æŸ¥æ‰¾ SLF4Jã€LOG4Jã€LOG4J2ã€JDK_LOGGINGã€COMMONS_LOGGINGã€STDOUT_LOGGINGã€NO_LOGGING æ—  multipleResultSetsEnabled æ˜¯å¦å…è®¸å•ä¸€è¯­å¥è¿”å›å¤šç»“æœé›† å³ Mapper é…ç½®ä¸­ä¸€ä¸ªå•ä¸€çš„ SQL é…ç½®æ˜¯å¦èƒ½è¿”å›å¤šä¸ªç»“æœé›† true/false true useColumnLabel ä½¿ç”¨åˆ—æ ‡ç­¾ä»£æ›¿åˆ— è®¾ç½®æ˜¯å¦ä½¿ç”¨åˆ—æ ‡ç­¾ä»£æ›¿åˆ—å true/false true useGeneratedKeys æ˜¯å¦æ”¯æŒ JDBC è‡ªåŠ¨ç”Ÿæˆä¸»é”® è®¾ç½®ä¹‹åï¼Œå°†ä¼šå¼ºåˆ¶ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆä¸»é”®çš„ç­–ç•¥ true/false false autoMappingBehavior æŒ‡å®š MyBatis è‡ªåŠ¨æ˜ å°„å­—æ®µæˆ–å±æ€§çš„æ–¹å¼ æœ‰ä¸‰ç§æ–¹å¼ï¼ŒNONE æ—¶å°†å–æ¶ˆè‡ªåŠ¨æ˜ å°„ï¼›PARTIAL æ—¶åªä¼šè‡ªåŠ¨æ˜ å°„æ²¡æœ‰å®šä¹‰ç»“æœé›†çš„ç»“æœæ˜ å°„ï¼›FULL æ—¶ä¼šæ˜ å°„ä»»æ„å¤æ‚çš„ç»“æœé›† NONE/PARTIAL/FULL PARTIAL autoMappingUnknownColumnBehavior è®¾ç½®å½“è‡ªåŠ¨æ˜ å°„æ—¶å‘ç°æœªçŸ¥åˆ—çš„åŠ¨ä½œ æœ‰ä¸‰ç§åŠ¨ä½œï¼šNONE æ—¶ä¸åšä»»ä½•æ“ä½œï¼›WARNING æ—¶ä¼šè¾“å‡ºæé†’æ—¥å¿—ï¼›FAILINGæ—¶ä¼šæŠ›å‡º SqlSessionException å¼‚å¸¸è¡¨ç¤ºæ˜ å°„å¤±è´¥ NONE/WARNING/FAILING NONE defaultStatementTimeout è®¾ç½®è¶…æ—¶æ—¶é—´ è¯¥è¶…æ—¶æ—¶é—´å³æ•°æ®åº“é©±åŠ¨è¿æ¥æ•°æ®åº“æ—¶ï¼Œç­‰å¾…æ•°æ®åº“å›åº”çš„æœ€å¤§ç§’æ•° ä»»æ„æ­£æ•´æ•° æ—  defaultFetchSize è®¾ç½®é©±åŠ¨çš„ç»“æœé›†è·å–æ•°é‡ï¼ˆfetchSizeï¼‰çš„æç¤ºå€¼ ä¸ºäº†é˜²æ­¢ä»æ•°æ®åº“æŸ¥è¯¢å‡ºæ¥çš„ç»“æœè¿‡å¤šï¼Œè€Œå¯¼è‡´å†…å­˜æº¢å‡ºï¼Œå¯ä»¥é€šè¿‡è®¾ç½®fetchSize å‚æ•°æ¥æ§åˆ¶ç»“æœé›†çš„æ•°é‡ ä»»æ„æ­£æ•´æ•° æ—  safeRowBoundsEnabled å…è®¸åœ¨åµŒå¥—è¯­å¥ä¸­ä½¿ç”¨åˆ†é¡µï¼ˆRowBoundï¼Œå³è¡Œå†…åµŒå¥—è¯­å¥ï¼‰ å¦‚æœå…è®¸åœ¨ SQL çš„è¡Œå†…åµŒå¥—è¯­å¥ä¸­ä½¿ç”¨åˆ†é¡µï¼Œå°±è®¾ç½®è¯¥å€¼ä¸º false true/false false safeResultHandlerEnabled å…è®¸åœ¨åµŒå¥—è¯­å¥ä¸­ä½¿ç”¨åˆ†é¡µï¼ˆResultHandlerï¼Œå³ç»“æœé›†å¤„ç†ï¼‰ å¦‚æœå…è®¸åœ¨ SQL çš„ç»“æœé›†ä½¿ç”¨åˆ†é¡µï¼Œå°±è®¾ç½®è¯¥å€¼ä¸º false true/false false mapUnderscoreToCamelCase æ˜¯å¦å¼€å¯é©¼å³°å‘½åè§„åˆ™ï¼ˆcamel caseï¼‰æ˜ å°„ è¡¨æ˜æ•°æ®åº“ä¸­çš„å­—æ®µåç§°ä¸å·¥ç¨‹ä¸­Java å®ä½“ç±»çš„æ˜ å°„æ˜¯å¦é‡‡ç”¨é©¼å³°å‘½åè§„åˆ™æ ¡éªŒ true/false false jdbcTypeForNull JDBCç±»å‹çš„é»˜è®¤è®¾ç½® å½“æ²¡æœ‰ä¸ºå‚æ•°æä¾›ç‰¹å®šçš„ JDBC ç±»å‹æ—¶ï¼Œä¸ºç©ºå€¼æŒ‡å®š JDBC ç±»å‹ã€‚æŸäº›é©±åŠ¨éœ€è¦æŒ‡å®šåˆ—çš„ JDBC ç±»å‹ï¼Œå¤šæ•°æƒ…å†µç›´æ¥ç”¨ä¸€èˆ¬ç±»å‹å³å¯ï¼Œæ¯”å¦‚ NULLã€VARCHAR æˆ– OTHER å¸¸ç”¨ NULLã€VARCHARã€OTHER OTHER defaultScriptingLanguage åŠ¨æ€ SQL é»˜è®¤è¯­è¨€ æŒ‡å®šåŠ¨æ€ SQL ç”Ÿæˆçš„é»˜è®¤è¯­è¨€ ä¸€ä¸ªç±»å‹åˆ«åæˆ–è€…ä¸€ä¸ªç±»çš„å…¨è·¯å¾„å org.apache.ibatis.scripting.xmltags.XMLLanguageDriver callSettersOnNulls æ˜¯å¦åœ¨æ§åˆ¶æƒ…å†µä¸‹è°ƒç”¨ Set æ–¹æ³• æŒ‡å®šå½“ç»“æœé›†ä¸­å€¼ä¸º null æ—¶æ˜¯å¦è°ƒç”¨æ˜ å°„å¯¹è±¡çš„ setter ï¼ˆmapå¯¹è±¡æ—¶ä¸ºputï¼‰æ–¹æ³•ï¼Œè¿™å¯¹äºæœ‰ Map.keySet()ä¾èµ–æˆ–null å€¼åˆå§‹åŒ–æ—¶æ˜¯æœ‰ç”¨çš„ã€‚æ³¨æ„åŸºæœ¬ç±»å‹æ˜¯ä¸èƒ½è®¾ç½®æˆ null çš„ true/false false returnInstanceForEmptyRow è¿”å›ç©ºå®ä½“é›†å¯¹è±¡ å½“è¿”å›è¡Œçš„æ‰€æœ‰åˆ—éƒ½æ˜¯ç©ºæ—¶ï¼ŒMyBatisé»˜è®¤è¿”å› nullã€‚å½“å¼€å¯è¿™ä¸ªè®¾ç½®æ—¶ï¼ŒMyBatis ä¼šè¿”å›ä¸€ä¸ªç©ºå®ä¾‹ã€‚è¯·æ³¨æ„ï¼Œå®ƒä¹Ÿé€‚ç”¨äºåµŒå¥—çš„ç»“æœé›†ï¼ˆä»MyBatis3.4.2 ç‰ˆæœ¬å¼€å§‹ï¼‰ true/false false logPrefix æ—¥å¿—å‰ç¼€ æŒ‡å®š MyBatis æ‰€ç”¨æ—¥å¿—çš„å…·ä½“å®ç°ï¼ŒæœªæŒ‡å®šæ—¶å°†è‡ªåŠ¨æŸ¥æ‰¾ ä»»æ„å­—ç¬¦ä¸² æ—  vfsImpl vfs å®ç° æŒ‡å®š vfs çš„å®ç° è‡ªå®šä¹‰ VFS çš„å®ç°çš„ç±»çš„å…¨é™å®šåï¼Œä»¥é€—å·åˆ†éš” æ—  useActualParamName ä½¿ç”¨æ–¹æ³•ç­¾å å…è®¸ä½¿ç”¨æ–¹æ³•ç­¾åä¸­çš„åç§°ä½œä¸ºè¯­å¥å‚æ•°åç§°ã€‚è¦ä½¿ç”¨è¯¥ç‰¹æ€§ï¼Œå·¥ç¨‹å¿…é¡»é‡‡ç”¨ Java8 ç¼–è¯‘ï¼Œå¹¶ä¸”åŠ ä¸Š-parametersé€‰é¡¹ï¼ˆä» MyBatis3.4.1 ç‰ˆæœ¬å¼€å§‹ï¼‰ è‡ªå®šä¹‰ VFS çš„å®ç°çš„ç±»çš„å…¨é™å®šåï¼Œä»¥é€—å·åˆ†éš” æ—  configurationFactory é…ç½®å·¥å‚ æŒ‡å®šæä¾›é…ç½®ç¤ºä¾‹çš„ç±»ã€‚è¿”å›çš„é…ç½®å®ä¾‹ç”¨äºåŠ è½½ååºåˆ—åŒ–çš„æ‡’åŠ è½½å‚æ•°ã€‚è¿™ä¸ªç±»å¿…é¡»æœ‰ä¸€ä¸ªç­¾åçš„é™æ€é…ç½®getconfiguration()æ–¹æ³•ï¼ˆä»MyBatis3.2.3 ç‰ˆæœ¬å¼€å§‹ï¼‰ ä¸€ä¸ªç±»å‹åˆ«åæˆ–è€…ä¸€ä¸ªç±»å‹çš„å…¨è·¯å¾„å æ—  typeAliasesTypeAlias æ˜¯ç±»å‹çš„åˆ«åï¼Œè·Ÿ Linux ç³»ç»Ÿé‡Œé¢çš„ alias ä¸€æ ·ï¼Œä¸»è¦ç”¨æ¥ç®€åŒ–å…¨è·¯å¾„ç±»åçš„æ‹¼å†™ã€‚æ¯”å¦‚æˆ‘ä»¬çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹éƒ½å¯èƒ½ä¼šç”¨åˆ°æˆ‘ä»¬çš„ Beanï¼Œå¦‚æœæ¯ä¸ªåœ°æ–¹éƒ½é…ç½®å…¨è·¯å¾„çš„è¯ï¼Œé‚£ä¹ˆå†…å®¹å°±æ¯”è¾ƒå¤šï¼Œè¿˜å¯èƒ½ä¼šå†™é”™ã€‚ æˆ‘ä»¬å¯ä»¥ä¸ºè‡ªå·±çš„ Bean åˆ›å»ºåˆ«åï¼Œæ—¢å¯ä»¥æŒ‡å®šå•ä¸ªç±»ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ª packageï¼Œè‡ªåŠ¨è½¬æ¢ã€‚é…ç½®äº†åˆ«åä»¥åï¼Œåªéœ€è¦å†™åˆ«åå°±å¯ä»¥äº†ï¼Œæ¯”å¦‚ com.gupaoedu.domain.Blogéƒ½åªè¦å†™ blog å°±å¯ä»¥äº†ã€‚ MyBatis é‡Œé¢æœ‰ç³»ç»Ÿé¢„å…ˆå®šä¹‰å¥½çš„ç±»å‹åˆ«åï¼Œåœ¨ TypeAliasRegistry ä¸­ã€‚ typeHandlersç”±äº Java ç±»å‹å’Œæ•°æ®åº“çš„ JDBC ç±»å‹ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼ˆæ¯”å¦‚ String ä¸ varcharï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠ Java å¯¹è±¡è½¬æ¢ä¸ºæ•°æ®åº“çš„å€¼ï¼Œå’ŒæŠŠæ•°æ®åº“çš„å€¼è½¬æ¢æˆ Java å¯¹è±¡ï¼Œéœ€è¦ç»è¿‡ä¸€å®šçš„è½¬æ¢ï¼Œè¿™ä¸¤ä¸ªæ–¹å‘çš„è½¬æ¢å°±è¦ç”¨åˆ° TypeHandlerã€‚ MyBatis å·²ç»å†…ç½®äº†å¾ˆå¤š TypeHandlerï¼ˆåœ¨ type åŒ…ä¸‹ï¼‰ï¼Œå®ƒä»¬å…¨éƒ¨æ³¨å†Œåœ¨ TypeHandlerRegistry ä¸­ï¼Œä»–ä»¬éƒ½ç»§æ‰¿äº†æŠ½è±¡ç±» BaseTypeHandlerï¼Œæ³›å‹å°±æ˜¯è¦å¤„ç†çš„ Java æ•°æ®ç±»å‹ã€‚ å½“æˆ‘ä»¬åšæ•°æ®ç±»å‹è½¬æ¢çš„æ—¶å€™ï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨å¯¹åº”çš„ TypeHandler çš„æ–¹æ³•ã€‚ å¦‚æœæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€äº›ç±»å‹è½¬æ¢è§„åˆ™ï¼Œæˆ–è€…è¦åœ¨å¤„ç†ç±»å‹çš„æ—¶å€™åšä¸€äº›ç‰¹æ®Šçš„åŠ¨ä½œï¼Œå°±å¯ä»¥ç¼–å†™è‡ªå·±çš„ TypeHandlerï¼Œè·Ÿç³»ç»Ÿè‡ªå®šä¹‰çš„ TypeHandler ä¸€æ ·ï¼Œç»§æ‰¿æŠ½è±¡ç±»BaseTypeHandlerã€‚æœ‰ 4 ä¸ªæŠ½è±¡æ–¹æ³•å¿…é¡»å®ç°ï¼Œæˆ‘ä»¬æŠŠå®ƒåˆ†æˆä¸¤ç±»ï¼šset æ–¹æ³•ä» Java ç±»å‹è½¬æ¢æˆ JDBC ç±»å‹çš„ï¼Œget æ–¹æ³•æ˜¯ä» JDBC ç±»å‹è½¬æ¢æˆ Java ç±»å‹çš„ã€‚ objectFactoryå½“æˆ‘ä»¬æŠŠæ•°æ®åº“è¿”å›çš„ç»“æœé›†è½¬æ¢ä¸ºå®ä½“ç±»çš„æ—¶å€™ï¼Œéœ€è¦åˆ›å»ºå¯¹è±¡çš„å®ä¾‹ï¼Œç”±äºæˆ‘ä»¬ä¸çŸ¥é“éœ€è¦å¤„ç†çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Œæœ‰å“ªäº›å±æ€§ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨ new çš„æ–¹å¼å»åˆ›å»ºã€‚åœ¨MyBatis é‡Œé¢ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå·¥å‚ç±»çš„æ¥å£ï¼Œå«åš ObjectFactoryï¼Œä¸“é—¨ç”¨æ¥åˆ›å»ºå¯¹è±¡çš„å®ä¾‹ï¼Œé‡Œé¢å®šä¹‰äº† 4 ä¸ªæ–¹æ³•ã€‚ æ–¹æ³• ä½œç”¨ void setProperties(Properties properties); è®¾ç½®å‚æ•°æ—¶è°ƒç”¨ T create(Class type); åˆ›å»ºå¯¹è±¡ï¼ˆè°ƒç”¨æ— å‚æ„é€ å‡½æ•°ï¼‰ T create(Class type, List&lt;Class&lt;?&gt;constructorArgTypes, List åˆ›å»ºå¯¹è±¡ï¼ˆè°ƒç”¨å¸¦å‚æ•°æ„é€ å‡½æ•°ï¼‰ n boolean isCollection(Class type) åˆ¤æ–­æ˜¯å¦é›†åˆ ObjectFactory æœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°ç±» DefaultObjectFactoryï¼Œåˆ›å»ºå¯¹è±¡çš„æ–¹æ³•æœ€ç»ˆéƒ½è°ƒç”¨äº† instantiateClass()ï¼Œæ˜¯é€šè¿‡åå°„æ¥å®ç°çš„ã€‚ å¦‚æœæƒ³è¦ä¿®æ”¹å¯¹è±¡å·¥å‚åœ¨åˆå§‹åŒ–å®ä½“ç±»çš„æ—¶å€™çš„è¡Œä¸ºï¼Œå°±å¯ä»¥é€šè¿‡åˆ›å»ºè‡ªå·±çš„å¯¹è±¡å·¥å‚ï¼Œç»§æ‰¿ DefaultObjectFactory æ¥å®ç°ï¼ˆä¸éœ€è¦å†å®ç° ObjectFactory æ¥å£ï¼‰ã€‚ pluginsæ’ä»¶æ˜¯ MyBatis çš„ä¸€ä¸ªå¾ˆå¼ºå¤§çš„æœºåˆ¶ï¼Œè·Ÿå¾ˆå¤šå…¶ä»–çš„æ¡†æ¶ä¸€æ ·ï¼ŒMyBatis é¢„ç•™äº†æ’ä»¶çš„æ¥å£ï¼Œè®© MyBatis æ›´å®¹æ˜“æ‰©å±•ã€‚ environments ã€environmentenvironments æ ‡ç­¾ç”¨æ¥ç®¡ç†æ•°æ®åº“çš„ç¯å¢ƒï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥æœ‰å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒçš„æ•°æ®åº“ã€‚å¯ä»¥åœ¨ä¸åŒçš„ç¯å¢ƒä¸­ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“åœ°å€æˆ–è€…ç±»å‹ã€‚ 1234567891011&lt;environments default=&quot;dev&quot;&gt; &lt;environment id=&quot;dev&quot;&gt; &lt;transactionManager type=&quot;JDBC&quot;/&gt; &lt;dataSource type=&quot;POOLED&quot;&gt; &lt;property name=&quot;driver&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt; &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://127.0.0.1:3306/aaa&quot;/&gt; &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt; &lt;property name=&quot;password&quot; value=&quot;Alibaba741&quot;/&gt; &lt;/dataSource&gt; &lt;/environment&gt;&lt;/environments&gt; ä¸€ä¸ª environment æ ‡ç­¾å°±æ˜¯ä¸€ä¸ªæ•°æ®æºï¼Œä»£è¡¨ä¸€ä¸ªæ•°æ®åº“ã€‚è¿™é‡Œé¢æœ‰ä¸¤ä¸ªå…³é”®çš„æ ‡ç­¾ï¼Œä¸€ä¸ªæ˜¯äº‹åŠ¡ç®¡ç†å™¨ï¼Œä¸€ä¸ªæ˜¯æ•°æ®æºã€‚ transactionManagerå¦‚æœé…ç½®çš„æ˜¯ JDBCï¼Œåˆ™ä¼šä½¿ç”¨ Connection å¯¹è±¡çš„ commit()ã€rollback()ã€close()ç®¡ç†äº‹åŠ¡ã€‚ å¦‚æœé…ç½®æˆ MANAGEDï¼Œä¼šæŠŠäº‹åŠ¡äº¤ç»™å®¹å™¨æ¥ç®¡ç†ï¼Œæ¯”å¦‚ JBOSSï¼ŒWeblogicã€‚å› ä¸ºæˆ‘ä»¬è·‘çš„æ˜¯æœ¬åœ°ç¨‹åºï¼Œå¦‚æœé…ç½®æˆ MANAGE ä¸ä¼šæœ‰ä»»ä½•äº‹åŠ¡ã€‚ å¦‚ æœ æ˜¯ Spring + MyBatis ï¼Œ åˆ™ æ²¡ æœ‰ å¿… è¦ é… ç½® ï¼Œ å›  ä¸º æˆ‘ ä»¬ ä¼š ç›´ æ¥ åœ¨applicationContext.xml é‡Œé¢é…ç½®æ•°æ®æºï¼Œè¦†ç›– MyBatis çš„é…ç½®ã€‚ dataSourcemappersæ ‡ç­¾é…ç½®çš„æ˜¯æˆ‘ä»¬çš„æ˜ å°„å™¨ï¼Œä¹Ÿå°±æ˜¯ Mapper.xml çš„è·¯å¾„ã€‚è¿™é‡Œé…ç½®çš„ç›®çš„æ˜¯è®© MyBatis åœ¨å¯åŠ¨çš„æ—¶å€™å»æ‰«æè¿™äº›æ˜ å°„å™¨ï¼Œåˆ›å»ºæ˜ å°„å…³ç³»ã€‚ ä½¿ç”¨ç›¸å¯¹äºç±»è·¯å¾„çš„èµ„æºå¼•ç”¨ï¼ˆresourceï¼‰ ä½¿ç”¨å®Œå…¨é™å®šèµ„æºå®šä½ç¬¦ï¼ˆç»å¯¹è·¯å¾„ï¼‰ï¼ˆURLï¼‰ ä½¿ç”¨æ˜ å°„å™¨æ¥å£å®ç°ç±»çš„å®Œå…¨é™å®šç±»å å°†åŒ…å†…çš„æ˜ å°„å™¨æ¥å£å®ç°å…¨éƒ¨æ³¨å†Œä¸ºæ˜ å°„å™¨ï¼ˆæœ€å¸¸ç”¨ï¼‰ å®Œæ•´çš„é…ç½®æ–‡ä»¶12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;&lt;configuration&gt; &lt;!-- MyBatisæ ‡ç­¾ --&gt; &lt;!-- propertiesï¼š é€šè¿‡propertieså±æ€§æŒ‡å®šæ•°æ®æºçš„é…ç½® resource=&quot;jdbc.properties&quot; é€šè¿‡resourceå±æ€§å¼•å…¥å¤–éƒ¨å±æ€§æ–‡ä»¶ --&gt; &lt;properties&gt; &lt;property name=&quot;username&quot; value=&quot;root&quot;&gt;&lt;/property&gt; &lt;property name=&quot;password&quot; value=&quot;root&quot;&gt;&lt;/property&gt; &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql:///ssm&quot;&gt;&lt;/property&gt; &lt;property name=&quot;driverName&quot; value=&quot;com.mysql.jdbc.Driver&quot;&gt;&lt;/property&gt; &lt;/properties&gt; &lt;!-- setting mybatisè¿è¡Œæ—¶çš„é‡è¦è®¾ç½®ï¼Œè°¨æ…ä¿®æ”¹ --&gt; &lt;settings&gt; &lt;!--å¼€å¯é©¼å³°å‘½åæ³•--&gt; &lt;setting name=&quot;mapUnderscoreToCamelCase&quot; value=&quot;true&quot;/&gt; &lt;/settings&gt; &lt;!-- typeAliasesï¼šç±»å‹åˆ«å --&gt; &lt;typeAliases&gt; &lt;!--ä¸ºä¸€ä¸ªå®ä½“ç±»èµ·åˆ«åï¼Œä»£æ›¿å­æ˜ å°„æ–‡ä»¶çš„å®ä½“ç±»å…¨é™å®šç±»å--&gt; &lt;!--&lt;typeAlias type=&quot;com.atguigu.pojo.User&quot; alias=&quot;user&quot;/&gt;--&gt; &lt;!--ç›´æ¥ä¸ºä¸€ä¸ªåŒ…ä¸‹çš„æ‰€æœ‰ç±»èµ·åˆ«åï¼Œé»˜è®¤ç±»åé¦–å­—æ¯å°å†™--&gt; &lt;package name=&quot;com.atguigu.pojo&quot;/&gt; &lt;/typeAliases&gt; &lt;!--typeHandlersï¼šè‡ªå·±æ³¨å†Œç±»å‹å¤„ç†å™¨--&gt; &lt;!--&lt;typeHandlers&gt;--&gt; &lt;!--&lt;typeHandler handler=&quot;&quot; javaType=&quot;&quot; jdbcType=&quot;&quot;/&gt;--&gt; &lt;!--&lt;/typeHandlers&gt;--&gt; &lt;!--ObjectFactory:é…ç½®å¯¹è±¡å·¥å‚--&gt; &lt;!--plugins:æ’ä»¶--&gt; &lt;plugins&gt; &lt;!--5.0ç‰ˆæœ¬ä¹‹å‰å†™pagehelperï¼Œ5.0ä»¥åå†™PageInterceptor--&gt; &lt;plugin interceptor=&quot;com.github.pagehelper.PageInterceptor&quot;&gt; &lt;!--åˆ†é¡µåˆç†åŒ–å‚æ•°--&gt; &lt;property name=&quot;reasonable&quot; value=&quot;true&quot;/&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;environments default=&quot;mysql&quot;&gt; &lt;!--é…ç½®ç¯å¢ƒ- æ­¤å¤„ä¸å…‰å¯ä»¥é…ç½®mysql è¿˜å¯ä»¥é…ç½®SQLserverï¼Œdb2ï¼Œoracle ä½¿ç”¨æ—¶åœ¨æ ‡ç­¾ä¸ŠæŒ‡å®šdatabaseId --&gt; &lt;environment id=&quot;mysql&quot;&gt; &lt;!--é…ç½®äº‹åŠ¡--&gt; &lt;transactionManager type=&quot;JDBC&quot;/&gt; &lt;!--é…ç½®è¿æ¥æ± ï¼š type=&quot;POOLED&quot; ä½¿ç”¨è¿æ¥æ±  type=&quot;UNPOOLED&quot; ä¸ä½¿ç”¨è¿æ¥æ±  --&gt; &lt;dataSource type=&quot;POOLED&quot;&gt; &lt;property name=&quot;driver&quot; value=&quot;$&#123;driver&#125;&quot;/&gt; &lt;property name=&quot;url&quot; value=&quot;$&#123;url&#125;&quot;/&gt; &lt;property name=&quot;username&quot; value=&quot;$&#123;username&#125;&quot;/&gt; &lt;property name=&quot;password&quot; value=&quot;$&#123;password&#125;&quot;/&gt; &lt;/dataSource&gt; &lt;/environment&gt; &lt;/environments&gt; &lt;!--æ˜ å°„æ–‡ä»¶å¤„ç†å™¨--&gt; &lt;mappers&gt; &lt;!--ä½¿ç”¨ç›¸å¯¹äºç±»è·¯å¾„ä¸‹çš„èµ„æº--&gt; &lt;!--&lt;mapper resource=&quot;com/atguigu/mapper/AccountMapper.xml&quot;/&gt;--&gt; &lt;!--æ­¤ç§æ–¹æ³•è¦æ±‚æ¥å£ä¸æ˜ å°„æ–‡ä»¶åœ¨åŒä¸€åŒ…ä¸‹ä¸”åŒå--&gt; &lt;mapper class=&quot;com.atguigu.mapper.UserMapper&quot;/&gt; &lt;!--æ‰¹é‡æ³¨å†Œï¼šä¾æ­¤åˆ¶å®šä¸€ä¸ªåŒ… æ­¤ç§æ–¹æ³•è¦æ±‚æ¥å£ä¸æ˜ å°„æ–‡ä»¶åœ¨åŒä¸€åŒ…ä¸‹ä¸”åŒå --&gt; &lt;package name=&quot;com/atguigu/mapper&quot;/&gt; &lt;/mappers&gt;&lt;/configuration&gt; 4.å…³äºä¼ é€’å‚æ•°æ˜¯å¤šä¸ªåŸºæœ¬æ•°æ®ç±»å‹åœ¨ä¼ é€’å‚æ•°æ˜¯å¤šä¸ªæ™®é€šç±»å‹çš„æƒ…å†µä¸‹ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆå¯ä»¥ä¼ é€’å‚æ•°çš„å€¼åˆ°å ä½ç¬¦ã€‚â€‹ 1234567891011121314ç¬¬ä¸€ç§æƒ…å†µï¼š args0 è¡¨ç¤ºç¬¬ä¸€ä¸ªå‚æ•° args1 è¡¨ç¤ºç¬¬äºŒä¸ªå‚æ•° ã€‚ã€‚ã€‚ä»¥æ­¤ç±»æ¨ argsn è¡¨ç¤ºç¬¬n+1ä¸ªå‚æ•° ç¬¬äºŒç§æƒ…å†µï¼š param1 è¡¨ç¤ºç¬¬ä¸€ä¸ªå‚æ•° param2 è¡¨ç¤ºç¬¬äºŒä¸ªå‚æ•° ã€‚ã€‚ã€‚ä»¥æ­¤ç±»æ¨ paramn è¡¨ç¤ºç¬¬nä¸ªå‚æ•° ç¬¬ä¸‰ç§æƒ…å†µï¼š @Param(&quot;name&quot;) String name, @Param(&quot;sex&quot;) Integer sex å¦‚æœä¼ é€’çš„å‚æ•°æ˜¯Mapç±»å‹ï¼Œåˆ™åœ¨#{}ä¸­éœ€è¦å†™ä¸Šmapçš„keyå€¼è¡¨ç¤ºä¼ é€’ç›¸åº”keyçš„å€¼åˆ°sqlçš„å ä½ç¬¦ä¸­ã€‚mybatisåº•å±‚ä¼ é€’å‚æ•°å°±æ˜¯ä½¿ç”¨çš„mapé›†åˆã€‚â€‹ ä¸‰ï¼ŒMybatisè¿æ¥æ± å’Œäº‹åŠ¡æ·±å…¥1.è¿æ¥æ± Mybatis ä¸­ä¹Ÿæœ‰è¿æ¥æ± æŠ€æœ¯ï¼Œä½†æ˜¯å®ƒé‡‡ç”¨çš„æ˜¯è‡ªå·±çš„è¿æ¥æ± æŠ€æœ¯ã€‚åœ¨ Mybatis çš„ ä¸» é…ç½®æ–‡ä»¶ä¸­ï¼Œé€šè¿‡æ¥å®ç° Mybatis ä¸­è¿æ¥æ± çš„é…ç½®ã€‚â€‹ Mybatis å°†å®ƒè‡ªå·±çš„æ•°æ®æºåˆ†ä¸ºä¸‰ç±»ï¼šâ€‹ UNPOOLED ä¸ä½¿ç”¨è¿æ¥æ± çš„æ•°æ®æº POOLED ä½¿ç”¨è¿æ¥æ± çš„æ•°æ®æº JNDI ä½¿ç”¨ JNDI å®ç°çš„æ•°æ®æº â€‹ ç›¸åº”åœ°ï¼ŒMyBatis å†…éƒ¨åˆ†åˆ«å®šä¹‰äº†å®ç°äº† java.sql.DataSource æ¥å£çš„ UnpooledDataSourceï¼ŒPooledDataSource ç±»æ¥è¡¨ç¤º UNPOOLEDã€POOLED ç±»å‹çš„æ•°æ®æºã€‚ä¸€èˆ¬é‡‡ç”¨çš„æ˜¯ POOLED æ•°æ®æºï¼ˆå¾ˆå¤šæ—¶å€™æˆ‘ä»¬æ‰€è¯´çš„æ•°æ®æºå°±æ˜¯ä¸ºäº†æ›´å¥½çš„ç®¡ç†æ•°æ®åº“è¿æ¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„è¿æ¥æ± æŠ€æœ¯ï¼‰è¿æ¥æ± å…¶å®å°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå®¹å™¨å°±å¯ä»¥ç”¨é›†åˆæ¥å……å½“ï¼Œè€Œä¸”ä»–å¿…é¡»å…·æœ‰ï¼Œé˜Ÿåˆ—çš„ç‰¹æ€§ï¼Œå…ˆè¿›å…ˆå‡ºã€‚è¿˜å¾—æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸èƒ½è®©å¤šä¸ªçº¿ç¨‹æ‹¿åˆ°åŒä¸€ä¸ªè¿æ¥ã€‚â€‹ 1.1 MyBatisä¸­æ•°æ®æºçš„é…ç½®1234567&lt;!-- é…ç½®æ•°æ®æºï¼ˆè¿æ¥æ± ï¼‰ä¿¡æ¯ --&gt; &lt;dataSource type=&quot;POOLED&quot;&gt; &lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc.driver&#125;&quot;/&gt; &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot;/&gt; &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot;/&gt; &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot;/&gt;&lt;/dataSource&gt; â€‹ MyBatis åœ¨åˆå§‹åŒ–æ—¶ï¼Œæ ¹æ®çš„ type å±æ€§æ¥åˆ›å»ºç›¸åº”ç±»å‹çš„çš„æ•°æ®æº DataSourceï¼Œå³ï¼štype=â€POOLEDâ€ï¼šMyBatis ä¼šåˆ›å»º PooledDataSource å®ä¾‹type=â€UNPOOLEDâ€ ï¼š MyBatis ä¼šåˆ›å»º UnpooledDataSource å®ä¾‹type=â€JNDIâ€ï¼šMyBatis ä¼šä» JNDI æœåŠ¡ä¸ŠæŸ¥æ‰¾ DataSource å®ä¾‹ï¼Œç„¶åè¿”å›ä½¿ç”¨ 1.2 MyBatisä¸­Datasourceçš„å­˜å–MyBatis æ˜¯ é€š è¿‡ å·¥ å‚ æ¨¡ å¼ æ¥ åˆ› å»º æ•° æ® æº DataSource å¯¹ è±¡ çš„ ï¼Œ MyBatis å®š ä¹‰ äº† æŠ½ è±¡ çš„ å·¥ å‚ æ¥å£:org.apache.ibatis.datasource.DataSourceFactory,é€šè¿‡å…¶ getDataSource()æ–¹æ³•è¿”å›æ•°æ®æºDataSourceã€‚â€‹ MyBatis åˆ›å»ºäº† DataSource å®ä¾‹åï¼Œä¼šå°†å…¶æ”¾åˆ° Configuration å¯¹è±¡å†…çš„ Environment å¯¹è±¡ä¸­ï¼Œ ä¾›ä»¥åä½¿ç”¨ã€‚ï¼ˆå…·ä½“å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªç±»ï¼Œå« XMLConfigBuilderï¼‰ã€‚â€‹ 1.3 Mybatisä¸­è¿æ¥çš„è·å–è¿‡ç¨‹åˆ†æ123456789101112131415161718192021222324252627282930313233343536373839å½“æˆ‘ä»¬éœ€è¦åˆ›å»º SqlSession å¯¹è±¡å¹¶éœ€è¦æ‰§è¡Œ SQL è¯­å¥æ—¶ï¼Œè¿™æ—¶å€™ MyBatis æ‰ä¼šå»è°ƒç”¨ dataSource å¯¹è±¡æ¥åˆ›å»ºjava.sql.Connectionå¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œjava.sql.Connectionå¯¹è±¡çš„åˆ›å»ºä¸€ç›´å»¶è¿Ÿåˆ°æ‰§è¡ŒSQLè¯­å¥çš„æ—¶å€™ã€‚ @Test public void testSql() throws Exception &#123; InputStream in = Resources.getResourceAsStream(&quot;SqlMapConfig.xml&quot;); SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(in); SqlSession sqlSession = factory.openSession(); List&lt;User&gt; list = sqlSession.selectList(&quot;findUserById&quot;,41); System.out.println(list.size()); &#125;åªæœ‰å½“ç¬¬ 4 å¥ sqlSession.selectList(&quot;findUserById&quot;)ï¼Œæ‰ä¼šè§¦å‘ MyBatis åœ¨åº•å±‚æ‰§è¡Œä¸‹é¢è¿™ä¸ªæ–¹æ³•æ¥åˆ›å»º java.sql.Connection å¯¹è±¡ã€‚æŸ¥çœ‹åŠ è½½è¿‡ç¨‹ï¼šé€šè¿‡æ–­ç‚¹è°ƒè¯•ï¼Œåœ¨ PooledDataSource ä¸­æ‰¾åˆ°å¦‚ä¸‹ popConnection()æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤º **386è¡Œå·¦å³ if (!state.idleConnections.isEmpty()) &#123; // Pool has available connection //ä»£è¡¨æ± å­é‡Œæœ‰å¯ç”¨è¿æ¥ conn = state.idleConnections.remove(0); if (log.isDebugEnabled()) &#123; log.debug(&quot;Checked out connection &quot; + conn.getRealHashCode() + &quot; from pool.&quot;); &#125; &#125; else &#123; // Pool does not have available connection if (state.activeConnections.size() &lt; poolMaximumActiveConnections) &#123; // Can create new connection conn = new PooledConnection(dataSource.getConnection(), this); if (log.isDebugEnabled()) &#123; log.debug(&quot;Created connection &quot; + conn.getRealHashCode() + &quot;.&quot;); &#125; &#125; else &#123; // Cannot create new connection PooledConnection oldestActiveConnection = state.activeConnections.get(0); long longestCheckoutTime = oldestActiveConnection.getCheckoutTime(); .... //æ­¤å¤„çœç•¥ä¸€éƒ¨åˆ†ï¼Œæš‚æ—¶çœ‹ä¸æ‡‚ &#125;å¤§æ¦‚æ„æ€å°±æ˜¯ï¼šåº•å±‚æœ‰ä¸¤ä¸ªæ± å­ï¼Œä¸€ä¸ªæ˜¯ç©ºé—²æ± ï¼Œä¸€ä¸ªæ˜¯å­˜æ”¾æ´»è·ƒè¿æ¥çš„æ± å­ï¼Œå½“è·å–è¿æ¥çš„æ—¶å€™ï¼Œé¦–å…ˆå»ç©ºé—²æ± å­çœ‹çœ‹æœ‰æ²¡æœ‰ç©ºé—²çš„è¿æ¥ï¼Œæœ‰çš„è¯ç›´æ¥æ‹¿èµ°ï¼Œæ²¡æœ‰çš„è¯ï¼Œå°±å»æ´»è·ƒæ± å­ï¼Œçœ‹çœ‹åˆ°æ²¡åˆ°æœ€å¤§è¿æ¥æ•°ï¼Œå¦‚æœåˆ°äº†ï¼Œå°±æŠŠæœ€å…ˆæ´»è·ƒçš„è¿æ¥æ‹¿è¿‡æ¥ï¼ŒæŠŠé‡Œé¢ç»‘å®šçš„æ•°æ®éƒ½æ¸…äº†ï¼Œç„¶åæ‹¿æ¥ç”¨ã€‚æ’åºè§„åˆ™å°±æ˜¯ï¼Œæ‹¿èµ°æœ€å…ˆè¿›æ¥çš„ï¼Œç„¶ååé¢çš„ä¾æ¬¡å‘å‰è¡¥ä½ï¼Œæ¯”å¦‚è¯´æ‹¿èµ°0ï¼Œé‚£ä¹ˆ1å°±ä¼šå‘å‰è¡¥ä½ï¼Œå˜æˆ0ï¼Œç„¶ååé¢çš„ä¾æ¬¡å‘å‰è¡¥ä½ã€‚ 2.äº‹åŠ¡æ§åˆ¶2.1 JDBCäº‹åŠ¡å›é¡¾åœ¨ JDBC ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰‹åŠ¨æ–¹å¼å°†äº‹åŠ¡çš„æäº¤æ”¹ä¸ºæ‰‹åŠ¨æ–¹å¼ï¼Œé€šè¿‡ setAutoCommit()æ–¹æ³•å°±å¯ä»¥è°ƒæ•´ã€‚â€‹ æŸ¥æ‰¾jdkæ–‡æ¡£ï¼šé»˜è®¤ä¸ºè‡ªåŠ¨æäº¤ï¼Œå½“åšå•ä¸ªäº‹åŠ¡å¤„ç†ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®trueï¼Œfalseæ¥æ”¹å˜ã€‚â€‹ 2.2 mybatisäº‹åŠ¡åˆ†ææ¡†æ¶çš„æœ¬è´¨ä¹Ÿæ˜¯è°ƒç”¨jdkçš„è¿™ä¸ªæ–¹æ³•ï¼Œåªæ˜¯è¿›è¡Œäº†ä¸€äº›å¤„ç†ã€‚å¯¹äºä¹‹å‰çš„å¢åˆ è¯¥æ–¹æ³•ï¼šé€šè¿‡æŸ¥çœ‹æ§åˆ¶å°çš„æ—¥å¿—ï¼Œå¯ä»¥å‘ç°ï¼Œmybatiså¯¹äºå¢åˆ æ”¹ï¼Œé»˜è®¤æäº¤æ–¹å¼æ˜¯falseï¼Œæˆ‘ä»¬è¦åœ¨æäº¤ä¹‹åå°†ä»–çš„æäº¤æ–¹å¼è®¾ç½®ä¸ºtrueï¼Œæˆ–è€…åœ¨session.getCommit()æ–¹æ³•çš„ï¼ˆï¼‰é‡Œé¢ç›´æ¥ä¼ ä¸€ä¸ªtrueã€‚â€‹ å››ï¼ŒåŠ¨æ€SQLæˆ‘ä»¬æ ¹æ®å®ä½“ç±»çš„ä¸åŒå–å€¼ï¼Œä½¿ç”¨ä¸åŒçš„ SQL è¯­å¥æ¥è¿›è¡ŒæŸ¥è¯¢ã€‚æ¯”å¦‚åœ¨ id å¦‚æœä¸ä¸ºç©ºæ—¶å¯ä»¥æ ¹æ® id æŸ¥è¯¢ï¼Œ å¦‚æœ username ä¸åŒç©ºæ—¶è¿˜è¦åŠ å…¥ç”¨æˆ·åä½œä¸ºæ¡ä»¶ã€‚è¿™ç§æƒ…å†µåœ¨æˆ‘ä»¬çš„å¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢ä¸­ç»å¸¸ä¼šç¢°åˆ°ã€‚â€‹ 1.æŠ½å–é‡å¤ä»£ç ç‰‡æ®µ123456&lt;!-- æŠ½å–é‡å¤çš„è¯­å¥ä»£ç ç‰‡æ®µ --&gt;&lt;sql id=&quot;defaultSql&quot;&gt; select * from user&lt;/sql&gt;&lt;!-- ç„¶åå°±å¯ä»¥åœ¨æ ‡ç­¾ä¸­å¯¹æŠ½å–å‡ºæ¥çš„è¯­å¥è¿›è¡Œå¼•ç”¨ --&gt;&lt;include refid=&quot;defaultSql&quot;/&gt; 2.if1234/** * æ ¹æ®idæŸ¥è¯¢ */User findById(User user); 12345678&lt;!--æ ¹æ®idæŸ¥è¯¢--&gt;&lt;select id=&quot;findById&quot; parameterType=&quot;com.yhd.domain.User&quot; resultType=&quot;com.yhd.domain.User&quot;&gt; &lt;include refid=&quot;defaultSql&quot;/&gt; where 1=1 &lt;if test=&quot;id!=null and id!=&#x27;&#x27;&quot;&gt; and id = #&#123;id&#125;; &lt;/if&gt;&lt;/select&gt; æ³¨æ„ where 1=1 çš„ä½œç”¨~ï¼ 1234567&lt;!--Account selectByIdSelective(Integer id);--&gt;&lt;select id=&quot;selectByIdSelective&quot; parameterType=&quot;int&quot; resultMap=&quot;baseAccountMap&quot;&gt; select id ,name ,money from account where 1=1 &lt;if test=&quot;_parameter!=null and _parameter !=&#x27;&#x27;&quot;&gt; and id = #&#123;_parameter&#125; &lt;/if&gt;&lt;/select&gt; 3. where1234 /** * æ ¹æ®idæŸ¥è¯¢ */User findById(User user); 123456789&lt;!--æ ¹æ®idæŸ¥è¯¢--&gt; &lt;select id=&quot;findById&quot; parameterType=&quot;com.yhd.domain.User&quot; resultType=&quot;com.yhd.domain.User&quot;&gt; &lt;include refid=&quot;defaultSql&quot;/&gt; &lt;where&gt; &lt;if test=&quot;id!=null and id!=&#x27;&#x27;&quot;&gt; and id = #&#123;id&#125; &lt;/if&gt; &lt;/where&gt; &lt;/select&gt; æœ‰äº†whereå°±ä¸ç”¨å†™1=1äº†ã€‚â€‹ 4.foreach1List&lt;Account&gt; selectByIds(Integer []ids); 12345678910111213&lt;!--List&lt;Account&gt; selectByIds(Integer []ids);--&gt;&lt;select id=&quot;selectByIds&quot; parameterType=&quot;int&quot; resultMap=&quot;baseAccountMap&quot;&gt; select id ,name ,money from account &lt;where&gt; &lt;if test=&quot;_parameter!=null and _parameter.size()&gt;0&quot;&gt; id in &lt;foreach collection=&quot;array&quot; item=&quot;id&quot; open=&quot;(&quot; close=&quot;)&quot; separator=&quot;,&quot;&gt; #&#123;id&#125; &lt;/foreach&gt; &lt;/if&gt; &lt;/where&gt;&lt;/select&gt; SQL è¯­å¥ï¼šselect å­—æ®µ from user where id in (?)æ ‡ç­¾ç”¨äºéå†é›†åˆï¼Œå®ƒçš„å±æ€§ï¼šcollection:ä»£è¡¨è¦éå†çš„é›†åˆå…ƒç´ ï¼Œæ³¨æ„ç¼–å†™æ—¶ä¸è¦å†™#{}open:ä»£è¡¨è¯­å¥çš„å¼€å§‹éƒ¨åˆ†close:ä»£è¡¨ç»“æŸéƒ¨åˆ†item:ä»£è¡¨éå†é›†åˆçš„æ¯ä¸ªå…ƒç´ ï¼Œç”Ÿæˆçš„å˜é‡åsperator:ä»£è¡¨åˆ†éš”ç¬¦ äº”ï¼ŒMybatiså¤šè¡¨æŸ¥è¯¢1.ä¸€å¯¹ä¸€æŸ¥è¯¢ä»£ç ï¼šmybatis-04 2.ä¸€å¯¹å¤šæŸ¥è¯¢ä»£ç ï¼šmybatis-05 3.å¤šå¯¹å¤šæŸ¥è¯¢ä»£ç ï¼šmybatis-06â€‹ å…­ï¼Œå»¶è¿ŸåŠ è½½å»¶è¿ŸåŠ è½½ï¼šå°±æ˜¯åœ¨éœ€è¦ç”¨åˆ°æ•°æ®æ—¶æ‰è¿›è¡ŒåŠ è½½ï¼Œä¸éœ€è¦ç”¨åˆ°æ•°æ®æ—¶å°±ä¸åŠ è½½æ•°æ®ã€‚å»¶è¿ŸåŠ è½½ä¹Ÿç§°æ‡’åŠ è½½. å¥½å¤„ï¼šå…ˆä»å•è¡¨æŸ¥è¯¢ï¼Œéœ€è¦æ—¶å†ä»å…³è”è¡¨å»å…³è”æŸ¥è¯¢ï¼Œå¤§å¤§æé«˜æ•°æ®åº“æ€§èƒ½ï¼Œå› ä¸ºæŸ¥è¯¢å•è¡¨è¦æ¯”å…³è”æŸ¥è¯¢å¤šå¼ è¡¨é€Ÿåº¦è¦å¿«ã€‚â€‹ åå¤„ï¼šå› ä¸ºåªæœ‰å½“éœ€è¦ç”¨åˆ°æ•°æ®æ—¶ï¼Œæ‰ä¼šè¿›è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼Œè¿™æ ·åœ¨å¤§æ‰¹é‡æ•°æ®æŸ¥è¯¢æ—¶ï¼Œå› ä¸ºæŸ¥è¯¢å·¥ä½œä¹Ÿè¦æ¶ˆè€—æ—¶é—´ï¼Œæ‰€ä»¥å¯èƒ½é€ æˆç”¨æˆ·ç­‰å¾…æ—¶é—´å˜é•¿ï¼Œé€ æˆç”¨æˆ·ä½“éªŒä¸‹é™ã€‚ â€‹ å¦‚ä½•å¼€å¯æ‡’åŠ è½½ç­–ç•¥ï¼Ÿâ€‹ 12345&lt;!-- å¼€å¯å»¶è¿ŸåŠ è½½çš„æ”¯æŒ --&gt;&lt;settings&gt; &lt;setting name=&quot;lazyLoadingEnabled&quot; value=&quot;true&quot;/&gt; &lt;setting name=&quot;aggressiveLazyLoading&quot; value=&quot;false&quot;/&gt;&lt;/settings&gt; 1.ä¸€å¯¹ä¸€æ‡’åŠ è½½â€‹ mybatis-07â€‹ 2.å¤šå¯¹ä¸€æ‡’åŠ è½½mybatis-08â€‹ ä¸ƒï¼Œç¼“å­˜æœºåˆ¶1.ä¸€çº§ç¼“å­˜â€‹ ä¸€çº§ç¼“å­˜ä¹Ÿå«æœ¬åœ°ç¼“å­˜ï¼ŒMyBatis çš„ä¸€çº§ç¼“å­˜æ˜¯åœ¨ä¼šè¯ï¼ˆSqlSessionï¼‰å±‚é¢è¿›è¡Œç¼“å­˜çš„ã€‚MyBatis çš„ä¸€çº§ç¼“å­˜æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œä¸éœ€è¦ä»»ä½•çš„é…ç½®ã€‚ è¦åœ¨åŒä¸€ä¸ªä¼šè¯é‡Œé¢å…±äº«ä¸€çº§ç¼“å­˜ï¼Œè¿™ä¸ªå¯¹è±¡è‚¯å®šæ˜¯åœ¨ SqlSession é‡Œé¢åˆ›å»ºçš„ï¼Œä½œä¸º SqlSession çš„ä¸€ä¸ªå±æ€§ã€‚ DefaultSqlSession é‡Œé¢åªæœ‰ä¸¤ä¸ªå±æ€§ï¼ŒConfiguration æ˜¯å…¨å±€çš„ï¼Œæ‰€ä»¥ç¼“å­˜åªå¯èƒ½æ”¾åœ¨ Executor é‡Œé¢ç»´æŠ¤â€”â€”SimpleExecutor/ReuseExecutor/BatchExecutor çš„çˆ¶ç±»BaseExecutor çš„æ„é€ å‡½æ•°ä¸­æŒæœ‰äº† PerpetualCacheã€‚ åœ¨åŒä¸€ä¸ªä¼šè¯é‡Œé¢ï¼Œå¤šæ¬¡æ‰§è¡Œç›¸åŒçš„ SQL è¯­å¥ï¼Œä¼šç›´æ¥ä»å†…å­˜å–åˆ°ç¼“å­˜çš„ç»“æœï¼Œä¸ä¼šå†å‘é€ SQL åˆ°æ•°æ®åº“ã€‚ä½†æ˜¯ä¸åŒçš„ä¼šè¯é‡Œé¢ï¼Œå³ä½¿æ‰§è¡Œçš„ SQL ä¸€æ¨¡ä¸€æ ·ï¼ˆé€šè¿‡ä¸€ä¸ªMapper çš„åŒä¸€ä¸ªæ–¹æ³•çš„ç›¸åŒå‚æ•°è°ƒç”¨ï¼‰ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨åˆ°ä¸€çº§ç¼“å­˜ã€‚â€‹ ä¸€çº§ç¼“å­˜åœ¨ BaseExecutor çš„ query()â€”â€”queryFromDatabase()ä¸­å­˜å…¥ã€‚åœ¨queryFromDatabase()ä¹‹å‰ä¼š get()ã€‚ ä¸€çº§ç¼“å­˜æ˜¯åœ¨ BaseExecutor ä¸­çš„ update()æ–¹æ³•ä¸­è°ƒç”¨ clearLocalCache()æ¸…ç©ºçš„ï¼ˆæ— æ¡ä»¶ï¼‰ï¼Œquery ä¸­ä¼šåˆ¤æ–­ã€‚ ä¸€çº§ç¼“å­˜çš„ ä¸è¶³ ä½¿ç”¨ä¸€çº§ç¼“å­˜çš„æ—¶å€™ï¼Œå› ä¸ºç¼“å­˜ä¸èƒ½è·¨ä¼šè¯å…±äº«ï¼Œä¸åŒçš„ä¼šè¯ä¹‹é—´å¯¹äºç›¸åŒçš„æ•°æ®å¯èƒ½æœ‰ä¸ä¸€æ ·çš„ç¼“å­˜ã€‚åœ¨æœ‰å¤šä¸ªä¼šè¯æˆ–è€…åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¼šå­˜åœ¨è„æ•°æ®çš„é—®é¢˜ã€‚å¦‚æœè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±è¦ç”¨åˆ°äºŒçº§ç¼“å­˜ã€‚â€‹ è™½ç„¶åœ¨ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬æŸ¥è¯¢äº†ä¸¤æ¬¡ï¼Œä½†æœ€ååªæ‰§è¡Œäº†ä¸€æ¬¡æ•°æ®åº“æ“ä½œï¼Œè¿™å°±æ˜¯ Mybatis æä¾›ç»™æˆ‘ä»¬çš„ä¸€çº§ç¼“å­˜åœ¨èµ·ä½œç”¨äº†ã€‚å› ä¸ºä¸€çº§ç¼“å­˜çš„å­˜åœ¨ï¼Œå¯¼è‡´ç¬¬äºŒæ¬¡æŸ¥è¯¢ id ä¸º 41 çš„è®°å½•æ—¶ï¼Œå¹¶æ²¡æœ‰å‘å‡º sql è¯­å¥ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®ï¼Œè€Œæ˜¯ä»ä¸€çº§ç¼“å­˜ä¸­æŸ¥è¯¢ã€‚â€‹ å¦‚ä½•æ¸…ç©ºä¸€çº§ç¼“å­˜ï¼Ÿâ€‹ ä¸€çº§ç¼“å­˜æ˜¯ SqlSession èŒƒå›´çš„ç¼“å­˜ï¼Œå½“è°ƒç”¨ SqlSession çš„ä¿®æ”¹ï¼Œæ·»åŠ ï¼Œåˆ é™¤ï¼Œcommit()ï¼Œclose()ç­‰æ–¹æ³•æ—¶ï¼Œå°±ä¼šæ¸…ç©ºä¸€çº§ç¼“å­˜ã€‚â€‹ ç¬¬ä¸€æ¬¡å‘èµ·æŸ¥è¯¢ç”¨æˆ· id ä¸º 1 çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå…ˆå»æ‰¾ç¼“å­˜ä¸­æ˜¯å¦æœ‰ id ä¸º 1 çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ã€‚å¾—åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°ä¸€çº§ç¼“å­˜ä¸­ã€‚â€‹ å¦‚æœ sqlSession å»æ‰§è¡Œ commit æ“ä½œï¼ˆæ‰§è¡Œæ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼‰ï¼Œæ¸…ç©º SqlSession ä¸­çš„ä¸€çº§ç¼“å­˜ï¼Œè¿™æ ·åšçš„ç›®çš„ä¸ºäº†è®©ç¼“å­˜ä¸­å­˜å‚¨çš„æ˜¯æœ€æ–°çš„ä¿¡æ¯ï¼Œé¿å…è„è¯»ã€‚â€‹ ç¬¬äºŒæ¬¡å‘èµ·æŸ¥è¯¢ç”¨æˆ· id ä¸º 1 çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå…ˆå»æ‰¾ç¼“å­˜ä¸­æ˜¯å¦æœ‰ id ä¸º 1 çš„ç”¨æˆ·ä¿¡æ¯ï¼Œç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ã€‚â€‹ 2.äºŒçº§ç¼“å­˜äºŒçº§ç¼“å­˜æ˜¯ç”¨æ¥è§£å†³ä¸€çº§ç¼“å­˜ä¸èƒ½è·¨ä¼šè¯å…±äº«çš„é—®é¢˜çš„ï¼ŒèŒƒå›´æ˜¯ namespace çº§åˆ«çš„ï¼Œå¯ä»¥è¢«å¤šä¸ª SqlSession å…±äº«ï¼ˆåªè¦æ˜¯åŒä¸€ä¸ªæ¥å£é‡Œé¢çš„ç›¸åŒæ–¹æ³•ï¼Œéƒ½å¯ä»¥å…±äº«ï¼‰ï¼Œç”Ÿå‘½å‘¨æœŸå’Œåº”ç”¨åŒæ­¥ã€‚ ä½œä¸ºä¸€ä¸ªä½œç”¨èŒƒå›´æ›´å¹¿çš„ç¼“å­˜ï¼Œå®ƒè‚¯å®šæ˜¯åœ¨ SqlSession çš„å¤–å±‚ï¼Œå¦åˆ™ä¸å¯èƒ½è¢«å¤šä¸ªSqlSession å…±äº«ã€‚è€Œä¸€çº§ç¼“å­˜æ˜¯åœ¨ SqlSession å†…éƒ¨çš„ï¼Œæ‰€ä»¥ï¼Œè‚¯å®šæ˜¯å·¥ä½œåœ¨ä¸€çº§ç¼“å­˜ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯åªæœ‰å–ä¸åˆ°äºŒçº§ç¼“å­˜çš„æƒ…å†µä¸‹æ‰åˆ°ä¸€ä¸ªä¼šè¯ä¸­å»å–ä¸€çº§ç¼“å­˜ã€‚ è¦è·¨ä¼šè¯å…±äº«çš„è¯ï¼ŒSqlSession æœ¬èº«å’Œå®ƒé‡Œé¢çš„ BaseExecutor å·²ç»æ»¡è¶³ä¸äº†éœ€æ±‚äº†ï¼Œé‚£æˆ‘ä»¬åº”è¯¥åœ¨ BaseExecutor ä¹‹å¤–åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚ å®é™…ä¸Š MyBatis ç”¨äº†ä¸€ä¸ªè£…é¥°å™¨çš„ç±»æ¥ç»´æŠ¤ï¼Œå°±æ˜¯ CachingExecutorã€‚å¦‚æœå¯ç”¨äº†äºŒçº§ç¼“å­˜ï¼ŒMyBatis åœ¨åˆ›å»º Executor å¯¹è±¡çš„æ—¶å€™ä¼šå¯¹ Executor è¿›è¡Œè£…é¥°ã€‚CachingExecutor å¯¹äºæŸ¥è¯¢è¯·æ±‚ï¼Œä¼šåˆ¤æ–­äºŒçº§ç¼“å­˜æ˜¯å¦æœ‰ç¼“å­˜ç»“æœï¼Œå¦‚æœæœ‰å°±ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰å§”æ´¾äº¤ç»™çœŸæ­£çš„æŸ¥è¯¢å™¨ Executor å®ç°ç±»ï¼Œæ¯”å¦‚ SimpleExecutor æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼Œå†èµ°åˆ°ä¸€çº§ç¼“å­˜çš„æµç¨‹ã€‚æœ€åä¼šæŠŠç»“æœç¼“å­˜èµ·æ¥ï¼Œå¹¶ä¸”è¿”å›ç»™ç”¨æˆ·ã€‚â€‹ â€‹ äºŒçº§ç¼“å­˜çš„å¼€å¯ä¸å…³é—­â€‹ ä¸»é…ç½®æ–‡ä»¶12345678&lt;!-- å£°æ˜è¿™ä¸ª namespace ä½¿ç”¨äºŒçº§ç¼“å­˜ --&gt;&lt;cache type=&quot;org.apache.ibatis.cache.impl.PerpetualCache&quot; size=&quot;1024&quot; eviction=&quot;LRU&quot; flushInterval=&quot;120000&quot; readOnly=&quot; false&quot;&gt; &lt;!--è‡ªåŠ¨åˆ·æ–°æ—¶é—´ msï¼Œæœªé…ç½®æ—¶åªæœ‰è°ƒç”¨æ—¶åˆ·æ–° --&gt; &lt;!-- å›æ”¶ç­–ç•¥--&gt; &lt;!-- æœ€å¤šç¼“å­˜å¯¹è±¡ä¸ªæ•°ï¼Œé»˜è®¤ 1024--&gt; &lt;!-- é»˜è®¤æ˜¯ falseï¼ˆå®‰å…¨ï¼‰ï¼Œæ”¹ä¸º true å¯è¯»å†™æ—¶ï¼Œå¯¹è±¡å¿…é¡»æ”¯æŒåºåˆ—åŒ–--&gt;&lt;/cache&gt; å› ä¸º cacheEnabled çš„å–å€¼é»˜è®¤å°±ä¸º trueï¼Œæ‰€ä»¥è¿™ä¸€æ­¥å¯ä»¥çœç•¥ä¸é…ç½®ã€‚ä¸º true ä»£è¡¨å¼€å¯äºŒçº§ç¼“å­˜ï¼›ä¸ºfalse ä»£è¡¨ä¸å¼€å¯äºŒçº§ç¼“å­˜ã€‚â€‹ mapperæ˜ å°„æ–‡ä»¶123456789&lt;mapper namespace=&quot;com.itheima.dao.IUserDao&quot;&gt; &lt;!-- å¼€å¯äºŒçº§ç¼“å­˜çš„æ”¯æŒ --&gt; &lt;cache&gt;&lt;/cache&gt; &lt;!-- æ ¹æ® id æŸ¥è¯¢ --&gt; &lt;!-- åœ¨æ­¤å¤„å°†userCacheå±æ€§è®¾ç½®ä¸ºtrue --&gt; &lt;select id=&quot;findById&quot; resultType=&quot;user&quot; parameterType=&quot;int&quot; useCache=&quot;true&quot;&gt; select * from user where id = #&#123;uid&#125; &lt;/select&gt;&lt;/mapper&gt; æ ‡ç­¾è¡¨ç¤ºå½“å‰è¿™ä¸ª mapper æ˜ å°„å°†ä½¿ç”¨äºŒçº§ç¼“å­˜ï¼ŒåŒºåˆ†çš„æ ‡å‡†å°±çœ‹ mapper çš„ namespace å€¼ã€‚ å°† UserDao.xml æ˜ å°„æ–‡ä»¶ä¸­çš„æ ‡ç­¾ä¸­è®¾ç½® useCache=â€trueâ€ä»£è¡¨å½“å‰è¿™ä¸ª statement è¦ä½¿ç”¨ äºŒçº§ç¼“å­˜ï¼Œå¦‚æœä¸ä½¿ç”¨äºŒçº§ç¼“å­˜å¯ä»¥è®¾ç½®ä¸º falseã€‚ æ³¨æ„ï¼šé’ˆå¯¹æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦æœ€æ–°çš„æ•°æ® sqlï¼Œè¦è®¾ç½®æˆ useCache=falseï¼Œç¦ç”¨äºŒçº§ç¼“å­˜ã€‚â€‹ å½“æˆ‘ä»¬åœ¨ä½¿ç”¨äºŒçº§ç¼“å­˜æ—¶ï¼Œæ‰€ç¼“å­˜çš„ç±»ä¸€å®šè¦å®ç° java.io.Serializable æ¥å£ï¼Œè¿™ç§å°±å¯ä»¥ä½¿ç”¨åºåˆ—åŒ–æ–¹å¼æ¥ä¿å­˜å¯¹è±¡ã€‚å¦åˆ™ä¼šæŠ¥java,io.SerializableExceptionã€‚â€‹ Mapper.xml é…ç½®äº†ä¹‹åï¼Œselect()ä¼šè¢«ç¼“å­˜ã€‚update()ã€delete()ã€insert()ä¼šåˆ·æ–°ç¼“å­˜ã€‚ å¦‚æœ cacheEnabled=trueï¼ŒMapper.xml æ²¡æœ‰é…ç½®æ ‡ç­¾ï¼Œè¿˜æœ‰äºŒçº§ç¼“å­˜å—ï¼Ÿè¿˜ä¼šå‡ºç° CachingExecutor åŒ…è£…å¯¹è±¡å—ï¼Ÿ åªè¦ cacheEnabled=true åŸºæœ¬æ‰§è¡Œå™¨å°±ä¼šè¢«è£…é¥°ã€‚æœ‰æ²¡æœ‰é…ç½®ï¼Œå†³å®šäº†åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šä¸ä¼šåˆ›å»ºè¿™ä¸ª mapper çš„ Cache å¯¹è±¡ï¼Œæœ€ç»ˆä¼šå½±å“åˆ° CachingExecutorquery æ–¹æ³•é‡Œé¢çš„åˆ¤æ–­ï¼š 1if (cache != null) å¦‚æœæŸäº›æŸ¥è¯¢æ–¹æ³•å¯¹æ•°æ®çš„å®æ—¶æ€§è¦æ±‚å¾ˆé«˜ï¼Œä¸éœ€è¦äºŒçº§ç¼“å­˜ï¼Œæ€ä¹ˆåŠï¼Ÿ å¯ä»¥åœ¨å•ä¸ª Statement ID ä¸Šæ˜¾å¼å…³é—­äºŒçº§ç¼“å­˜ï¼ˆé»˜è®¤æ˜¯ trueï¼‰ 12&lt;select id=&quot;selectBlog&quot; resultMap=&quot;BaseResultMap&quot; useCache=&quot;false&quot;&gt;&lt;/select&gt; ä¸ºä»€ä¹ˆäº‹åŠ¡ä¸æäº¤ï¼ŒäºŒçº§ç¼“å­˜ä¸ç”Ÿæ•ˆï¼Ÿ å› ä¸ºäºŒçº§ç¼“å­˜ä½¿ç”¨ TransactionalCacheManagerï¼ˆTCMï¼‰æ¥ç®¡ç†ï¼Œæœ€ååˆè°ƒç”¨äº†TransactionalCacheçš„getObject()ã€putObjectå’Œcommit()æ–¹æ³•ï¼ŒTransactionalCacheé‡Œé¢åˆæŒæœ‰äº†çœŸæ­£çš„ Cache å¯¹è±¡ï¼Œæ¯”å¦‚æ˜¯ç»è¿‡å±‚å±‚è£…é¥°çš„ PerpetualCacheã€‚åœ¨ putObject çš„æ—¶å€™ï¼Œåªæ˜¯æ·»åŠ åˆ°äº† entriesToAddOnCommit é‡Œé¢ï¼Œåªæœ‰å®ƒçš„commit()æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™æ‰ä¼šè°ƒç”¨ flushPendingEntries()çœŸæ­£å†™å…¥ç¼“å­˜ã€‚å®ƒå°±æ˜¯åœ¨DefaultSqlSession è°ƒç”¨ commit()çš„æ—¶å€™è¢«è°ƒç”¨çš„ã€‚ ä¸ºä»€ä¹ˆå¢åˆ æ”¹æ“ä½œä¼šæ¸…ç©ºç¼“å­˜ï¼Ÿ åœ¨ CachingExecutor çš„ update()æ–¹æ³•é‡Œé¢ä¼šè°ƒç”¨ flushCacheIfRequired(ms)ï¼ŒisFlushCacheRequired å°±æ˜¯ä»æ ‡ç­¾é‡Œé¢æ¸ é“çš„ flushCache çš„å€¼ã€‚è€Œå¢åˆ æ”¹æ“ä½œçš„flushCache å±æ€§é»˜è®¤ä¸º trueã€‚ ç¬¬ä¸‰æ–¹ç¼“å­˜ åš äºŒçº§ç¼“å­˜ é™¤äº† MyBatis è‡ªå¸¦çš„äºŒçº§ç¼“å­˜ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å®ç° Cache æ¥å£æ¥è‡ªå®šä¹‰äºŒçº§ç¼“å­˜ã€‚ MyBatis å®˜æ–¹æä¾›äº†ä¸€äº›ç¬¬ä¸‰æ–¹ç¼“å­˜é›†æˆæ–¹å¼ï¼Œæ¯”å¦‚ ehcache å’Œ redisã€‚â€‹ å…«ï¼ŒMybatisæ‰©å±•1.æ‰¹é‡æ“ä½œåœ¨ MyBatis é‡Œé¢æ˜¯æ”¯æŒæ‰¹é‡çš„æ“ä½œçš„ï¼ŒåŒ…æ‹¬æ‰¹é‡çš„æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ä¼ å…¥ä¸€ä¸ª Listã€Setã€Map æˆ–è€…æ•°ç»„ï¼Œé…åˆåŠ¨æ€ SQL çš„æ ‡ç­¾ï¼ŒMyBatis ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆè¯­æ³•æ­£ç¡®çš„ SQL è¯­å¥ã€‚ 1.1 æ‰¹é‡æ’å…¥æ‰¹é‡æ’å…¥çš„è¯­æ³•æ˜¯è¿™æ ·çš„ï¼Œåªè¦åœ¨ values åé¢å¢åŠ æ’å…¥çš„å€¼å°±å¯ä»¥äº†ã€‚ 1insert into tbl_emp (emp_id, emp_name, gender,email, d_id) values ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) ,( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) , ( ?,?,?,?,? ) åœ¨ Mapper æ–‡ä»¶é‡Œé¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ foreach æ ‡ç­¾æ‹¼æ¥ values éƒ¨åˆ†çš„è¯­å¥ï¼š 12345678910&lt;!-- æ‰¹é‡æ’å…¥ --&gt;&lt;insert id=&quot;batchInsert&quot; parameterType=&quot;java.util.List&quot; useGeneratedKeys=&quot;true&quot;&gt; &lt;selectKey resultType=&quot;long&quot; keyProperty=&quot;id&quot; order=&quot;AFTER&quot;&gt; SELECT LAST_INSERT_ID() &lt;/selectKey&gt; insert into tbl_emp (emp_id, emp_name, gender,email, d_id) values &lt;foreach collection=&quot;list&quot; item=&quot;emps&quot; index=&quot;index&quot; separator=&quot;,&quot;&gt; (#&#123;emps.empId&#125;,#&#123;emps.empName&#125;,#&#123;emps.gender&#125;,#&#123;emps.email&#125;,#&#123;emps.dId&#125;) &lt;/foreach&gt;&lt;/insert&gt; Java ä»£ç é‡Œé¢ï¼Œç›´æ¥ä¼ å…¥ä¸€ä¸ª List ç±»å‹çš„å‚æ•°ã€‚ æ•ˆç‡è¦æ¯”å¾ªç¯å‘é€ SQL æ‰§è¡Œè¦é«˜å¾—å¤šã€‚æœ€å…³é”®çš„åœ°æ–¹å°±åœ¨äºå‡å°‘äº†è·Ÿæ•°æ®åº“äº¤äº’çš„æ¬¡æ•°ï¼Œå¹¶ä¸”é¿å…äº†å¼€å¯å’Œç»“æŸäº‹åŠ¡çš„æ—¶é—´æ¶ˆè€—ã€‚ 1.2 æ‰¹é‡æ›´æ–°æ‰¹é‡æ›´æ–°çš„è¯­æ³•æ˜¯è¿™æ ·çš„ï¼Œé€šè¿‡ case whenï¼Œæ¥åŒ¹é… id ç›¸å…³çš„å­—æ®µå€¼ã€‚ 1234567891011121314151617update tbl_emp setemp_name = case emp_id when ? then ? when ? then ? when ? then ? end , gender = case emp_id when ? then ? when ? then ? when ? then ? end , email = case emp_id when ? then ? when ? then ? when ? then ? endwhere emp_id in ( ? , ? , ? ) æ‰€ä»¥åœ¨ Mapper æ–‡ä»¶é‡Œé¢æœ€å…³é”®çš„å°±æ˜¯ case when å’Œ where çš„é…ç½®ã€‚éœ€è¦æ³¨æ„ä¸€ä¸‹ open å±æ€§å’Œ separator å±æ€§ã€‚ 12345678910111213141516171819202122&lt;update id=&quot;updateBatch&quot;&gt; update tbl_emp set emp_name = &lt;foreach collection=&quot;list&quot; item=&quot;emps&quot; index=&quot;index&quot; separator=&quot; &quot; opene=&quot;case emp_id&quot; close=&quot;end&quot;&gt; when #&#123;emps.empId&#125; then #&#123;emps.empName&#125; &lt;/ foreach&gt; ,gender = &lt;foreach collection=&quot;list&quot; item=&quot;emps&quot; index=&quot;index&quot; separator=&quot; &quot; opene=&quot;case emp_id&quot; close=&quot;end&quot;&gt; when #&#123;emps.empId&#125; then #&#123;emps.gender&#125; &lt;/foreach&gt; ,email = &lt;foreach collection=&quot;list&quot; item=&quot;emps&quot; index=&quot;index&quot; separator=&quot; &quot; opene=&quot;case emp_id&quot; close=&quot;end&quot;&gt; when #&#123;emps.empId&#125; then #&#123;emps.email&#125; &lt;/foreach&gt; where emp_id in &lt;foreach collection=&quot;list&quot; item=&quot;emps&quot; index=&quot;index&quot; separator=&quot;,&quot; open=&quot;(&quot; close=&quot;)&quot;&gt; #&#123;emps.empId&#125; &lt;/foreach&gt;&lt;/update&gt; 1.3 BatchExecutorå½“ç„¶ MyBatis çš„åŠ¨æ€æ ‡ç­¾çš„æ‰¹é‡æ“ä½œä¹Ÿæ˜¯å­˜åœ¨ä¸€å®šçš„ç¼ºç‚¹çš„ï¼Œæ¯”å¦‚æ•°æ®é‡ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œæ‹¼æ¥å‡ºæ¥çš„ SQL è¯­å¥è¿‡å¤§ã€‚ MySQL çš„æœåŠ¡ç«¯å¯¹äºæ¥æ”¶çš„æ•°æ®åŒ…æœ‰å¤§å°é™åˆ¶ï¼Œmax_allowed_packet é»˜è®¤æ˜¯4Mï¼Œéœ€è¦ä¿®æ”¹é»˜è®¤é…ç½®æ‰å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åœ¨æˆ‘ä»¬çš„å…¨å±€é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é…ç½®é»˜è®¤çš„ Executor çš„ç±»å‹ã€‚å…¶ä¸­æœ‰ä¸€ç§BatchExecutorã€‚ 1&lt;setting name =&quot;defaultExecutorType&quot; value =&quot;BATCH&quot; /&gt; ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºä¼šè¯çš„æ—¶å€™æŒ‡å®šæ‰§è¡Œå™¨ç±»å‹ 1SqlSession session = sqlSessionFactory.openSession(ExecutorType. BATCH ); BatchExecutor åº•å±‚æ˜¯å¯¹ JDBC ps.addBatch()çš„å°è£…ï¼ŒåŸç†æ˜¯æ”’ä¸€æ‰¹ SQL ä»¥åå†å‘ã€‚ 2.ç¿»é¡µåœ¨æˆ‘ä»¬æŸ¥è¯¢æ•°æ®åº“çš„æ“ä½œä¸­ï¼Œæœ‰ä¸¤ç§ç¿»é¡µæ–¹å¼ï¼Œä¸€ç§æ˜¯é€»è¾‘ç¿»é¡µï¼ˆå‡åˆ†é¡µï¼‰ï¼Œä¸€ç§æ˜¯ç‰©ç†ç¿»é¡µï¼ˆçœŸåˆ†é¡µï¼‰ã€‚é€»è¾‘ç¿»é¡µçš„åŸç†æ˜¯æŠŠæ‰€æœ‰æ•°æ®æŸ¥å‡ºæ¥ï¼Œåœ¨å†…å­˜ä¸­åˆ é€‰æ•°æ®ã€‚ ç‰©ç†ç¿»é¡µæ˜¯çœŸæ­£çš„ç¿»é¡µï¼Œæ¯”å¦‚ MySQL ä½¿ç”¨ limit è¯­å¥ï¼ŒOracle ä½¿ç”¨ rownum è¯­å¥ï¼ŒSQLServer ä½¿ç”¨ top è¯­å¥ã€‚ 2.1é€»è¾‘ç¿»é¡µMyBatis é‡Œé¢æœ‰ä¸€ä¸ªé€»è¾‘åˆ†é¡µå¯¹è±¡ RowBoundsï¼Œé‡Œé¢ä¸»è¦æœ‰ä¸¤ä¸ªå±æ€§ï¼Œoffset å’Œlimitï¼ˆä»ç¬¬å‡ æ¡å¼€å§‹ï¼ŒæŸ¥è¯¢å¤šå°‘æ¡ï¼‰ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨Mapperæ¥å£çš„æ–¹æ³•ä¸ŠåŠ ä¸Šè¿™ä¸ªå‚æ•°ï¼Œä¸éœ€è¦ä¿®æ”¹xmlé‡Œé¢çš„SQLè¯­å¥ã€‚ 1public List&lt;Blog&gt; selectBlogList(RowBounds rowBounds); å®ƒçš„åº•å±‚å…¶å®æ˜¯å¯¹ ResultSet çš„å¤„ç†ã€‚å®ƒä¼šèˆå¼ƒæ‰å‰é¢ offset æ¡æ•°æ®ï¼Œç„¶åå†å–å‰©ä¸‹çš„æ•°æ®çš„ limit æ¡ã€‚ å¦‚æœæ•°æ®é‡å¤§çš„è¯ï¼Œè¿™ç§ç¿»é¡µæ–¹å¼æ•ˆç‡ä¼šå¾ˆä½ï¼ˆè·ŸæŸ¥è¯¢åˆ°å†…å­˜ä¸­å†ä½¿ç”¨subList(start,end)æ²¡ä»€ä¹ˆåŒºåˆ«ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ç”¨åˆ°ç‰©ç†ç¿»é¡µã€‚ 2.2ç‰©ç†ç¿»é¡µç‰©ç†ç¿»é¡µæ˜¯çœŸæ­£çš„ç¿»é¡µï¼Œå®ƒæ˜¯é€šè¿‡æ•°æ®åº“æ”¯æŒçš„è¯­å¥æ¥ç¿»é¡µã€‚ ç¬¬ä¸€ç§ç®€å•çš„åŠæ³•å°±æ˜¯ä¼ å…¥å‚æ•°ï¼ˆæˆ–è€…åŒ…è£…ä¸€ä¸ª page å¯¹è±¡ï¼‰ï¼Œåœ¨ SQL è¯­å¥ä¸­ç¿»é¡µã€‚ 123&lt;select id=&quot;selectBlogPage&quot; parameterType=&quot;map&quot; resultMap=&quot;BaseResultMap&quot;&gt; select * from blog limit #&#123;curIndex&#125; , #&#123;pageSize&#125;&lt;/ select&gt; ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬è¦åœ¨ Java ä»£ç é‡Œé¢å»è®¡ç®—èµ·æ­¢åºå·ï¼›ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼šæ¯ä¸ªéœ€è¦ç¿»é¡µçš„ Statement éƒ½è¦ç¼–å†™ limit è¯­å¥ï¼Œä¼šé€ æˆ Mapper æ˜ å°„å™¨é‡Œé¢å¾ˆå¤šä»£ç å†—ä½™ã€‚ éœ€è¦ä¸€ç§é€šç”¨çš„æ–¹å¼ï¼Œä¸éœ€è¦å»ä¿®æ”¹é…ç½®çš„ä»»ä½•ä¸€æ¡ SQL è¯­å¥ï¼Œåªè¦åœ¨æˆ‘ä»¬éœ€è¦ç¿»é¡µçš„åœ°æ–¹å°è£…ä¸€ä¸‹ç¿»é¡µå¯¹è±¡å°±å¯ä»¥äº†ã€‚ ä½¿ç”¨ç¿»é¡µçš„æ’ä»¶ï¼Œè¿™ä¸ªæ˜¯åŸºäº MyBatis çš„æ‹¦æˆªå™¨å®ç°çš„ï¼Œæ¯”å¦‚ PageHelperã€‚ 123456// pageSize æ¯ä¸€é¡µå‡ æ¡PageHelper. startPage (pn, 10);List&lt;Employee&gt; emps = employeeService.getAll();// navigatePages å¯¼èˆªé¡µç æ•°PageInfo page = w new PageInfo(emps, 10);return Msg. success ().add( &quot;pageInfo&quot;, page); 3.é€šç”¨Mapperé—®é¢˜ï¼šå½“æˆ‘ä»¬çš„è¡¨å­—æ®µå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹å®ä½“ç±»å’Œ Mapper æ–‡ä»¶å®šä¹‰çš„å­—æ®µå’Œæ–¹æ³•ã€‚å¦‚æœæ˜¯å¢é‡ç»´æŠ¤ï¼Œé‚£ä¹ˆä¸€ä¸ªä¸ªæ–‡ä»¶å»ä¿®æ”¹ã€‚å¦‚æœæ˜¯å…¨é‡æ›¿æ¢ï¼Œæˆ‘ä»¬è¿˜è¦å»å¯¹æ¯”ç”¨ MBG ç”Ÿæˆçš„æ–‡ä»¶ã€‚å­—æ®µå˜åŠ¨ä¸€æ¬¡å°±è¦ä¿®æ”¹ä¸€æ¬¡ï¼Œç»´æŠ¤èµ·æ¥éå¸¸éº»çƒ¦ã€‚ è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§æ€è·¯ã€‚ ç¬¬ ä¸€ ä¸ª ï¼Œ å›  ä¸º MyBatis çš„ Mapper æ˜¯ æ”¯ æŒ ç»§ æ‰¿ çš„ ã€‚ æ‰€ ä»¥ æˆ‘ ä»¬ å¯ ä»¥ æŠŠ æˆ‘ ä»¬ çš„Mapper.xml å’Œ Mapper æ¥å£éƒ½åˆ†æˆä¸¤ä¸ªæ–‡ä»¶ã€‚ä¸€ä¸ªæ˜¯ MBG ç”Ÿæˆçš„ï¼Œè¿™éƒ¨åˆ†æ˜¯å›ºå®šä¸å˜çš„ã€‚ç„¶ååˆ›å»º DAO ç±»ç»§æ‰¿ç”Ÿæˆçš„æ¥å£ï¼Œå˜åŒ–çš„éƒ¨åˆ†å°±åœ¨ DAO é‡Œé¢ç»´æŠ¤ã€‚ GitHubåœ°å€ 4.MyBatis-PlusMyBatis-Plus æ˜¯åŸç”Ÿ MyBatis çš„ä¸€ä¸ªå¢å¼ºå·¥å…·ï¼Œå¯ä»¥åœ¨ä½¿ç”¨åŸç”Ÿ MyBatis çš„æ‰€æœ‰åŠŸèƒ½çš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨ plus ç‰¹æœ‰çš„åŠŸèƒ½ã€‚â€‹ ä¹ï¼ŒMybatisæ³¨è§£å¼€å‘1.å¸¸ç”¨æ³¨è§£ @Insert:å®ç°æ–°å¢@Update:å®ç°æ›´æ–°@Delete:å®ç°åˆ é™¤@Select:å®ç°æŸ¥è¯¢@Result:å®ç°ç»“æœé›†å°è£…@Results:å¯ä»¥ä¸@Result ä¸€èµ·ä½¿ç”¨ï¼Œå°è£…å¤šä¸ªç»“æœé›†@ResultMap:å®ç°å¼•ç”¨@Results å®šä¹‰çš„å°è£…@One:å®ç°ä¸€å¯¹ä¸€ç»“æœé›†å°è£…@Many:å®ç°ä¸€å¯¹å¤šç»“æœé›†å°è£…@SelectProvider: å®ç°åŠ¨æ€ SQL æ˜ å°„@CacheNamespace:å®ç°æ³¨è§£äºŒçº§ç¼“å­˜çš„ä½¿ç”¨ â€‹ 2.ä½¿ç”¨Mybatisæ³¨è§£å®ç°CRUD2.1 å¤æ‚æ˜ å°„å®ç°å¤æ‚å…³ç³»æ˜ å°„ä¹‹å‰æˆ‘ä»¬å¯ä»¥åœ¨æ˜ å°„æ–‡ä»¶ä¸­é€šè¿‡é…ç½®æ¥å®ç°ï¼Œåœ¨ä½¿ç”¨æ³¨è§£å¼€å‘æ—¶æˆ‘ä»¬éœ€è¦å€ŸåŠ©@Results æ³¨è§£ï¼Œ@Result æ³¨è§£ï¼Œ@One æ³¨è§£ï¼Œ@Many æ³¨è§£ã€‚â€‹ @Results æ³¨è§£ä»£æ›¿çš„æ˜¯æ ‡ç­¾è¯¥æ³¨è§£ä¸­å¯ä»¥ä½¿ç”¨å•ä¸ª@Result æ³¨è§£ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨@Result é›†åˆ@Resultsï¼ˆ{@Resultï¼ˆï¼‰ï¼Œ@Resultï¼ˆï¼‰}ï¼‰æˆ–@Resultsï¼ˆ@Resultï¼ˆï¼‰ï¼‰@Resutl æ³¨è§£ä»£æ›¿äº† æ ‡ç­¾å’Œæ ‡ç­¾@Result ä¸­ å±æ€§ä»‹ç»ï¼šid æ˜¯å¦æ˜¯ä¸»é”®å­—æ®µcolumn æ•°æ®åº“çš„åˆ—åproperty éœ€è¦è£…é…çš„å±æ€§åone éœ€è¦ä½¿ç”¨çš„@One æ³¨è§£ï¼ˆ@Resultï¼ˆone=@Oneï¼‰ï¼ˆï¼‰ï¼‰ï¼‰many éœ€è¦ä½¿ç”¨çš„@Many æ³¨è§£ï¼ˆ@Resultï¼ˆmany=@manyï¼‰ï¼ˆï¼‰ï¼‰ï¼‰@One æ³¨è§£ï¼ˆä¸€å¯¹ä¸€ï¼‰ä»£æ›¿äº†æ ‡ç­¾ï¼Œæ˜¯å¤šè¡¨æŸ¥è¯¢çš„å…³é”®ï¼Œåœ¨æ³¨è§£ä¸­ç”¨æ¥æŒ‡å®šå­æŸ¥è¯¢è¿”å›å•ä¸€å¯¹è±¡ã€‚@One æ³¨è§£å±æ€§ä»‹ç»ï¼šselect æŒ‡å®šç”¨æ¥å¤šè¡¨æŸ¥è¯¢çš„ sqlmapperfetchType ä¼šè¦†ç›–å…¨å±€çš„é…ç½®å‚æ•° lazyLoadingEnabledã€‚ã€‚ä½¿ç”¨æ ¼å¼ï¼š@Result(column=â€ â€œ,property=â€â€,one=@One(select=â€â€))@Many æ³¨è§£ï¼ˆå¤šå¯¹ä¸€ï¼‰ä»£æ›¿äº†æ ‡ç­¾,æ˜¯æ˜¯å¤šè¡¨æŸ¥è¯¢çš„å…³é”®ï¼Œåœ¨æ³¨è§£ä¸­ç”¨æ¥æŒ‡å®šå­æŸ¥è¯¢è¿”å›å¯¹è±¡é›†åˆã€‚æ³¨æ„ï¼šèšé›†å…ƒç´ ç”¨æ¥å¤„ç†â€œä¸€å¯¹å¤šâ€çš„å…³ç³»ã€‚éœ€è¦æŒ‡å®šæ˜ å°„çš„ Java å®ä½“ç±»çš„å±æ€§ï¼Œå±æ€§çš„ javaTypeï¼ˆä¸€èˆ¬ä¸º ArrayListï¼‰ä½†æ˜¯æ³¨è§£ä¸­å¯ä»¥ä¸å®šä¹‰ï¼›ä½¿ç”¨æ ¼å¼ï¼š@Result(property=â€â€,column=â€â€,many=@Many(select=â€â€)) 2.2 äºŒçº§ç¼“å­˜ ä¸»é…ç½®æ–‡ä»¶ â€‹ 12345&lt;!-- é…ç½®äºŒçº§ç¼“å­˜ --&gt; &lt;settings&gt; &lt;!-- å¼€å¯äºŒçº§ç¼“å­˜çš„æ”¯æŒ --&gt; &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;&lt;/settings&gt; æ˜ å°„æ–‡ä»¶1234@CacheNamespace(blocking=true)//mybatis åŸºäºæ³¨è§£æ–¹å¼å®ç°é…ç½®äºŒçº§ç¼“å­˜public interface UserMapper &#123; &#125;","categories":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://yinhuidong.github.io/categories/MyBatis/"}],"tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://yinhuidong.github.io/tags/MyBatis/"}]},{"title":"MyBatisæºç åˆ†æ","slug":"MyBatis/MyBatisæºç åˆ†æ","date":"2022-01-11T06:37:14.818Z","updated":"2022-01-11T06:41:11.784Z","comments":true,"path":"2022/01/11/MyBatis/MyBatisæºç åˆ†æ/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MyBatis/MyBatis%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","excerpt":"","text":"MyBatis SQL Mapper Framework for Java The MyBatis SQL mapper framework makes it easier to use a relational database with object-oriented applications.MyBatis couples objects with stored procedures or SQL statements using an XML descriptor or annotations.Simplicity is the biggest advantage of the MyBatis data mapper over object relational mapping tools. ä¸€ï¼ŒMybatisåŸç”Ÿä½¿ç”¨æ–¹å¼1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859public class EsTest &#123; /** * å­—èŠ‚æµ */ private InputStream in; /** * æ•°æ®åº“è¿æ¥å·¥å‚ */ private SqlSessionFactory sqlSessionFactory; /** * æ•°æ®åº“è¿æ¥ */ private SqlSession sqlSession; &#123; try &#123; //å°†é…ç½®æ–‡ä»¶ä»¥äºŒè¿›åˆ¶å­—èŠ‚æµçš„æ–¹å¼åŠ è½½åˆ°å†…å­˜ in = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;); //é€šè¿‡æ„å»ºè€…æ¨¡å¼åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿æ¥å·¥å‚ sqlSessionFactory = new SqlSessionFactoryBuilder().build(in); //é€šè¿‡å·¥å‚æ¥ç®¡ç†å’Œè·å–æ•°æ®åº“è¿æ¥ sqlSession = sqlSessionFactory.openSession(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; public void query() &#123; //è·å–ä¸€ä¸ªæŒ‡å®šç±»å‹çš„mapperä»£ç†å¯¹è±¡ UserMapper userMapper = sqlSession.getMapper(UserMapper.class); //ä»£ç†å¯¹è±¡æ‰§è¡Œç›®æ ‡æ–¹æ³• List&lt;Object&gt; users = userMapper.queryUser(1L); users.forEach(System.out::println); &#125; private static interface UserMapper &#123; List&lt;Object&gt; queryUser(Long id); &#125; /** * åˆ©ç”¨å¯¹è±¡çš„finalize æ–¹æ³•è¿›è¡Œèµ„æºå›æ”¶ * @throws Throwable */ @Override protected void finalize() throws Throwable &#123; sqlSession.commit(true); assert sqlSession != null; sqlSession.close(); assert in != null; try &#123; in.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125;&#125; åˆ†æä¸‹æµç¨‹ï¼š é€šè¿‡Resourceså¯¹è±¡åŠ è½½Mybatisä¸»é…ç½®æ–‡ä»¶åˆ°å†…å­˜å½¢æˆä¸€ä¸ªäºŒè¿›åˆ¶çš„å­—èŠ‚æµã€‚ å°†ä¸Šä¸€æ­¥ç”Ÿæˆçš„äºŒè¿›åˆ¶å­—èŠ‚æµå½“åšå‚æ•°ä¼ é€’åˆ°SqlSessionFactoryBuilder çš„build()ï¼Œç”¨æ¥æ„å»ºæ•°æ®åº“è¿æ¥å·¥å‚ SqlSessionFactoryã€‚ é€šè¿‡ç”Ÿæˆçš„æ•°æ®åº“è¿æ¥å·¥å‚è·å–æ•°æ®åº“è¿æ¥ã€‚ é€šè¿‡æ•°æ®åº“è¿æ¥è·å–æŒ‡å®šç±»å‹çš„Mapperçš„ä»£ç†å¯¹è±¡ã€‚ é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼Œè·å¾—ç»“æœã€‚ å…³é—­æ•°æ®åº“è¿æ¥ï¼Œå…³é—­å­—èŠ‚æµã€‚ äºŒï¼ŒMybatisæºç æ‰§è¡Œæµç¨‹åˆ†æ é¦–å…ˆï¼Œé€šè¿‡Resourceså¯¹è±¡é‡Œé¢çš„æ–¹æ³•å»åŠ è½½é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œä¼šé»˜è®¤ä¼ å…¥ä¸€ä¸ªç±»åŠ è½½å™¨æ•°ç»„ï¼Œå¾ªç¯å°è¯•ä½¿ç”¨å„ç§ç±»åŠ è½½å™¨åŠ è½½é…ç½®æ–‡ä»¶ï¼Œç›´åˆ°è·å–åˆ°äºŒè¿›åˆ¶å­—èŠ‚æµï¼Œå¦‚æœæœ€ç»ˆä»ç„¶æ²¡æœ‰è·å–åˆ°ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ å¦‚æœæˆåŠŸåŠ è½½é…ç½®æ–‡ä»¶ç”Ÿæˆäº†äºŒè¿›åˆ¶å­—èŠ‚æµï¼Œé‚£ä¹ˆä¼šå°†äºŒè¿›åˆ¶å­—èŠ‚æµä¼ å…¥åˆ°SqlSessionFactoryBuilderçš„buildæ–¹æ³•ï¼Œä¸ºç”Ÿæˆä¸€ä¸ªæ•°æ®åº“è¿æ¥å·¥å‚å¯¹è±¡ SqlSessionFactory å¯¹è±¡èµ‹èƒ½ã€‚ é¦–å…ˆåœ¨buildæ–¹æ³•é‡Œé¢ä¼šå»æ„å»ºä¸€ä¸ªxmlè§£æå™¨å¯¹è±¡ XMLConfigBuilderï¼Œç”¨æ¥è§£æä¸»é…ç½®æ–‡ä»¶ã€‚ é€šè¿‡è§£æå™¨çš„parse()è¿”å›äº†ä¸€ä¸ªConfigurationå¯¹è±¡ï¼Œç”¨æ¥æ„å»ºæ•°æ®åº“è¿æ¥å·¥å‚ã€‚ åˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½è¿‡ä¸»é…ç½®æ–‡ä»¶ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ ä»configurationæ ‡ç­¾å¼€å§‹è§£æé…ç½®æ–‡ä»¶ã€‚ mybatisçš„ä¸»é…ç½®æ–‡ä»¶é‡Œé¢çš„æ ‡ç­¾æ˜¯æœ‰é¡ºåºçš„ï¼Œä»–ä¼šæŒ‰ç…§é¡ºåºæ¥è§£æé…ç½®æ–‡ä»¶ä¸­çš„æ ‡ç­¾ï¼Œé‡ç‚¹åœ¨äºè§£æmappersæ ‡ç­¾ã€‚ ä»–ä¼šå¾ªç¯è·å–åˆ°æ‰€æœ‰çš„mapper.xmlæ–‡ä»¶ï¼Œåˆ©ç”¨mapperè§£æå™¨è§£æmapper.xmlæ–‡ä»¶ï¼Œè§£æå°è£…çš„åˆ°Configurationå¯¹è±¡ä¸­ã€‚ å…·ä½“çš„è§£æè¿‡ç¨‹ï¼šé¦–å…ˆå»å®šä½æ ¹æ ‡ç­¾mapperï¼Œç„¶åç»‘å®šmapperçš„å‘½åç©ºé—´ï¼ŒæŠŠæ‰€æœ‰çš„å‘½åç©ºé—´æ”¾åˆ°configurationå¯¹è±¡çš„ä¸€ä¸ªseté›†åˆé‡Œé¢ï¼ŒæŠŠå½“å‰mapperçš„ç±»å‹é€šè¿‡MapperRegistryå¯¹è±¡æ·»åŠ åˆ°ä¸€ä¸ªmapé‡Œé¢ã€‚ å…·ä½“æ”¾åˆ°Mapperæ³¨å†Œä¸­å¿ƒçš„å…¶å®æ˜¯Mapperå¯¹è±¡çš„ç±»å‹å’ŒMapperæ¥å£çš„ä»£ç†å·¥å‚ã€‚ æœ€ç»ˆè§£æå®Œmappersæ ‡ç­¾ä»¥åï¼Œè¿”å›äº†ä¸€ä¸ªConfigurationå¯¹è±¡ã€‚ æœ€ç»ˆé€šè¿‡buildæ–¹æ³•è¿”å›äº†ä¸€ä¸ªé»˜è®¤çš„æ•°æ®åº“è¿æ¥å·¥å‚å¯¹è±¡ï¼ŒDefaultSqlSessionFactoryï¼Œè¿™ä¸ªå·¥å‚é‡Œé¢æŒæœ‰ä¸€ä¸ªConfigurationå¯¹è±¡ã€‚ è·å–åˆ°æ•°æ®åº“è¿æ¥å·¥å‚ä»¥åå°±æ˜¯å»é€šè¿‡openSession()å»è·å–æ•°æ®åº“è¿æ¥ã€‚ SqlSessionçš„è·å–ä¸»è¦æ˜¯é€šè¿‡SqlSessionFactoryçš„é»˜è®¤å®ç°ç±»DefaultSqlSessionFactoryçš„openSessionFromDataSourceå°è£…ä¸€ä¸ªDefaultSqlSession(å®ç°SqlSessionæ¥å£ï¼‰è¿”å›ã€‚ é¦–å…ˆé€šè¿‡Configurationå¯¹è±¡è·å–ç¯å¢ƒä¿¡æ¯ã€‚ å†é€šè¿‡ç¯å¢ƒä¿¡æ¯è·å–äº‹åŠ¡å·¥å‚ï¼Œäº‹åŠ¡å·¥å‚ä¸»è¦æ˜¯çœ‹é…ç½®æ–‡ä»¶æœ‰æ²¡æœ‰é…ç½®ï¼Œæ²¡æœ‰é…ç½®çš„è¯å°±åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚ é€šè¿‡äº‹åŠ¡å·¥å‚æ¥è·å–äº‹åŠ¡å¯¹è±¡ã€‚ é€šè¿‡ä¸€ä¸ªConfigurationå¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªExecutorå¯¹è±¡ï¼Œä½¿ç”¨å®ƒæ¥æ‰§è¡ŒSQLã€‚ åˆ¤æ–­executorTypeçš„ç±»å‹ï¼Œåˆ†ä¸ºæ‰¹å¤„ç†ï¼Œå¯å¤ç”¨å’Œæ™®é€šä¸‰ç§ç±»å‹çš„Executorå¯¹è±¡ã€‚ SimpleExecutorï¼šæ¯æ‰§è¡Œä¸€æ¬¡ update æˆ– selectï¼Œå°±å¼€å¯ä¸€ä¸ª Statement å¯¹è±¡ï¼Œç”¨å®Œç«‹åˆ»å…³é—­ Statement å¯¹è±¡ ReuseExecutorï¼šç”¨å®Œåï¼Œä¸å…³é—­ Statement å¯¹è±¡ï¼Œè€Œæ˜¯æ”¾ç½®äº Map å†…ï¼Œä¾›ä¸‹ä¸€æ¬¡ä½¿ç”¨ BatchExecutorï¼šé‡Œé¢ç¼“å­˜äº†å¤šä¸ªstatementç”¨æ¥åšæ‰¹å¤„ç† ä¸Šé¢é€‰æ‹©å®Œå…·ä½“çš„Executorå¯¹è±¡åï¼Œåˆ¤æ–­æ˜¯å¦å¼€å¯äº†äºŒçº§ç¼“å­˜ï¼Œå¦‚æœå¼€å¯äº†äºŒçº§ç¼“å­˜çš„è¯ï¼Œä½¿ç”¨è£…é¥°å™¨æ¨¡å¼å¯¹Executorè¿›è¡Œä¸€ä¸ªåŒ…è£…ï¼Œç”Ÿæˆä¸€ä¸ªCachingExecutorå¯¹è±¡ï¼Œé‡Œé¢æŒæœ‰ä¸€ä¸ªExecutorå¯¹è±¡ã€‚ åœ¨æ­¤å¤„ä¼šæ‰§è¡Œæ’ä»¶çš„æ‹¦æˆªå™¨é“¾ï¼Œè¿™ä¸ªæ‹¦æˆªå™¨é“¾æ˜¯mybatisçš„ä¸€ä¸ªå¾ˆæ ¸å¿ƒçš„æ‰©å±•ç‚¹æœºåˆ¶ï¼Œæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªexecutorå¯¹è±¡ã€‚ å›å¤´çœ‹ä¸€ä¸‹Configurationå¯¹è±¡ï¼Œè¿™ä¸ªConfigurationå¯¹è±¡å¾ˆæœ‰æ„æ€ï¼Œé‡Œé¢é—´æ¥çš„æŒæœ‰å‡ ä¸ªå¯¹è±¡ ï¼Œä¸ºä»€ä¹ˆæ˜¯é—´æ¥ï¼Ÿå› ä¸ºç±»é‡Œé¢æ²¡æœ‰è¿™å‡ ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œä½†æ˜¯å´å¯ä»¥é€šè¿‡å½“å‰ç±»åˆ›å»ºè¿™å‡ ä¸ªå¯¹è±¡ã€‚ Executor å¯¹è±¡ StatementHandler å¯¹è±¡ PameterHandler å¯¹è±¡ ResultSetHandler å¯¹è±¡ mybatisçš„æ’ä»¶æ‹¦æˆªå™¨ä¼šå¯¹è¿™å››ä¸ªæ¥å£è¿›è¡Œæ‹¦æˆªï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šå¯¹è¿™å››ç§å¯¹è±¡ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œmybatis çš„æ‹¦æˆªå™¨ç”¨åˆ°äº†è´£ä»»é“¾+ä»£ç†+åå°„æœºåˆ¶ã€‚ï¼ˆé€šè¿‡æºç å¯ä»¥çŸ¥é“ï¼šæ‰€æœ‰å¯èƒ½è¢«æ‹¦æˆªçš„å¤„ç†ç±»éƒ½ä¼šç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ï¼Œå¦‚æœæœ‰Nä¸ªæ‹¦æˆªå™¨ï¼Œå°±ä¼šæœ‰Nä¸ªä»£ç†ï¼Œå±‚å±‚ç”ŸæˆåŠ¨æ€ä»£ç†æ˜¯æ¯”è¾ƒæ¶ˆè€—æ€§èƒ½çš„ã€‚è€Œä¸”è™½ç„¶èƒ½æŒ‡å®šæ’ä»¶æ‹¦æˆªçš„ä½ç½®ï¼Œä½†è¿™ä¸ªæ˜¯åœ¨æ‰§è¡Œæ–¹æ³•çš„æ—¶å€™åˆ©ç”¨åå°„åŠ¨æ€åˆ¤æ–­çš„ï¼Œåˆå§‹åŒ–çš„æ—¶å€™å°±æ˜¯ç®€å•çš„æŠŠæ‹¦æˆªå™¨æ’å…¥åˆ°äº†æ‰€æœ‰å¯ä»¥æ‹¦æˆªçš„åœ°æ–¹ã€‚æ‰€ä»¥å°½é‡ä¸è¦ç¼–å†™ä¸å¿…è¦çš„æ‹¦æˆªå™¨ã€‚ï¼‰å…¶å®mybatisçš„æ’ä»¶å®ç°åŸç†å’Œspringçš„aopçš„å®ç°åŸç†æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯ä¸€ä¸ªå¤šé‡çš„ä»£ç†ï¼Œå¤šé‡çš„ä»£ç†æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯é€šè¿‡è´£ä»»é“¾ è¿”å›ä¸€ä¸ªé»˜è®¤çš„ SQLSession ï¼Œè¿™ä¸ªDefaultSQLSessioné‡Œé¢æŒæœ‰ Configurationå¯¹è±¡ executorå¯¹è±¡ ï¼Œexecutorå¯¹è±¡é‡Œé¢æŒæœ‰ä¸€ä¸ªäº‹åŠ¡å¯¹è±¡ã€‚ é€šè¿‡SqlSessionå¯¹è±¡çš„getMapperæ–¹æ³•è·å–ä¸€ä¸ªæŒ‡å®šç±»å‹çš„mapperä»£ç†å¯¹è±¡ã€‚ æ•°æ®åº“è¿æ¥å¯¹è±¡é‡Œé¢çš„getMapperå®é™…ä¸Šè°ƒç”¨äº†configurationå¯¹è±¡çš„getMapperæ–¹æ³•ã€‚ é€šè¿‡mapperRegistryå»è·å–ä¸€ä¸ªmapperçš„ä»£ç†å¯¹è±¡ã€‚ å‰é¢è§£æé…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œå°†mapperå¯¹è±¡ç±»å‹å’Œmapperçš„ä»£ç†å·¥å‚å°è£…åˆ°äº†ä¸€ä¸ªmapï¼Œè¿™é‡Œå®é™…ä¸Šä»è¿™ä¸ªmapé‡Œé¢æ‹¿å‡ºæ¥äº†ä¸€ä¸ªmapperçš„ä»£ç†å·¥å‚ã€‚ ä½¿ç”¨ä»£ç†å·¥å‚å»åˆ›å»ºå¯¹è±¡ï¼Œé€šè¿‡ä¼ é€’æ•°æ®åº“è¿æ¥å»åˆ›å»ºä¸€ä¸ªmapperProxyå¯¹è±¡ï¼Œè¿™ä¸ªmapperProxyå®ç°äº†InvocationHandleræ¥å£ã€‚ é€šè¿‡mapperProxyè¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå®é™…ä¸Šå°±æ˜¯ä½¿ç”¨JDKçš„åŠ¨æ€ä»£ç†åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚ å½“ä»£ç†å¯¹è±¡æ‰§è¡Œç›®æ ‡æ–¹æ³•çš„æ—¶å€™ï¼šå®é™…ä¸Šå°±æ˜¯æ‰§è¡ŒmapperProxyçš„invokeæ–¹æ³•ã€‚ è¿™é‡Œå¯¹ç›®æ ‡æ–¹æ³•è¿›è¡Œä¸€ä¸ªåŒ…è£…ï¼Œç”Ÿæˆä¸€ä¸ªinvokerï¼Œé€šè¿‡invokeræ‰§è¡Œinvoke()ã€‚ å®é™…ä¸Šè¿™é‡Œè°ƒç”¨äº†MapperMethodçš„executeæ–¹æ³•ã€‚ åœ¨executeæ–¹æ³•é‡Œé¢å®é™…ä¸Šå°±æ˜¯åˆ¤æ–­æ‰§è¡Œçš„å¢åˆ æ”¹æŸ¥çš„ç±»å‹ï¼Œç„¶åè°ƒç”¨SqlSessionçš„crudæ–¹æ³•ã€‚(åŠ¨æ€ä»£ç†å®é™…ä¸Šå°±æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªstatementçš„å­—ç¬¦ä¸²ï¼Œç„¶åè°ƒç”¨SqlSessionçš„crudæ–¹æ³•ã€‚) ä»¥sqlSession.selectOne()è¿›è¡Œåˆ†æ ä»configurationå¯¹è±¡æ„å»ºä¸€ä¸ªMappedStatementå¯¹è±¡ï¼Œç„¶åæ‰§è¡Œexecutorçš„queryæ–¹æ³•è¿›è¡ŒæŸ¥è¯¢ï¼Œexecutoråˆ†ä¸ºä¸‰ç§ï¼š ä¸€ä¸ªæ˜¯æ‰¹å¤„ç†çš„ ä¸€ä¸ªæ˜¯èµ°äºŒçº§ç¼“å­˜çš„ ä¸€ä¸ªæ˜¯BaseExecutorï¼Œç›´æ¥æ‰§è¡Œçš„ æ¥ä¸‹æ¥çœ‹executorçš„queryæ–¹æ³•ï¼š ç»„è£…æ„å»ºå¾…æ‰§è¡Œçš„SQLã€‚ åˆ›å»ºä¸€çº§ç¼“å­˜çš„ç¼“å­˜keyï¼Œä¸€çº§ç¼“å­˜é»˜è®¤æ˜¯å¼€å¯çš„ã€‚ æ–¹æ³•é‡è½½query() åˆ¤æ–­å¦‚æœå‘½ä¸­ä¸€çº§ç¼“å­˜çš„è¯ï¼Œç›´æ¥è¿”å›ã€‚ å¦åˆ™çš„è¯ï¼ŒqueryFromDatabase ç›´æ¥å»æŸ¥è¯¢æ•°æ®åº“ å§”æ´¾ç»™å­ç±»å–èµ°çœŸæ­£çš„æŸ¥è¯¢é€»è¾‘ï¼Œç„¶åå°†æŸ¥è¯¢ç»“æœæˆ¿æ”¾åˆ°ä¸€çº§ç¼“å­˜ã€‚ åœ¨å­ç±»é‡Œé¢é€šè¿‡åŸç”Ÿjdbcçš„prepareStatementæ‰§è¡ŒæŸ¥è¯¢sqlï¼ŒæŸ¥è¯¢ä¹‹åé€šè¿‡ResultHandlerå¯¹è±¡å»å¤„ç†ç»“æœï¼Œæœ€ç»ˆè¿”å›ã€‚ äºŒåä¸­æ–‡æ³¨é‡Šç‰ˆæºç åœ°å€ï¼šhttps://gitee.com/yin_huidong/mybatis-3.git ä¸‰ï¼Œmybatisæ•´ä½“æ¶æ„åˆ†æmybatisçš„æ•´ä½“æ¶æ„åˆ†ä¸ºä¸‰å±‚ï¼Œåˆ†åˆ«æ˜¯åŸºç¡€æ”¯æŒå±‚ï¼Œæ ¸å¿ƒå¤„ç†å±‚ï¼Œæ¥å£å±‚ã€‚ æ¥å£å±‚æ ¸å¿ƒå¯¹è±¡æ˜¯ SqlSessionï¼Œå®ƒæ˜¯ä¸Šå±‚åº”ç”¨å’Œ MyBatisæ‰“äº¤é“çš„æ¡¥æ¢ï¼ŒSqlSession ä¸Šå®šä¹‰äº†éå¸¸å¤šçš„å¯¹æ•°æ®åº“çš„æ“ä½œæ–¹æ³•ã€‚æ¥å£å±‚åœ¨æ¥æ”¶åˆ°è°ƒç”¨è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨æ ¸å¿ƒå¤„ç†å±‚çš„ç›¸åº”æ¨¡å—æ¥å®Œæˆå…·ä½“çš„æ•°æ®åº“æ“ä½œã€‚ æ ¸å¿ƒå¤„ç†å±‚æ—¢ç„¶å«æ ¸å¿ƒå¤„ç†å±‚ï¼Œä¹Ÿå°±æ˜¯è·Ÿæ•°æ®åº“æ“ä½œç›¸å…³çš„åŠ¨ä½œéƒ½æ˜¯åœ¨è¿™ä¸€å±‚å®Œæˆçš„ã€‚ æ ¸å¿ƒå¤„ç†å±‚ä¸»è¦åšäº†è¿™å‡ ä»¶äº‹ï¼š æŠŠæ¥å£ä¸­ä¼ å…¥çš„å‚æ•°è§£æå¹¶ä¸”æ˜ å°„æˆ JDBC ç±»å‹ï¼› è§£æ xml æ–‡ä»¶ä¸­çš„ SQL è¯­å¥ï¼ŒåŒ…æ‹¬æ’å…¥å‚æ•°ï¼Œå’ŒåŠ¨æ€ SQL çš„ç”Ÿæˆï¼› æ‰§è¡Œ SQL è¯­å¥ï¼› å¤„ç†ç»“æœé›†ï¼Œå¹¶æ˜ å°„æˆ Java å¯¹è±¡ã€‚ æ’ä»¶ä¹Ÿå±äºæ ¸å¿ƒå±‚ï¼Œè¿™æ˜¯ç”±å®ƒçš„å·¥ä½œæ–¹å¼å’Œæ‹¦æˆªçš„å¯¹è±¡å†³å®šçš„ã€‚ åŸºç¡€æ”¯æŒå±‚åŸºç¡€æ”¯æŒå±‚ä¸»è¦æ˜¯ä¸€äº›æŠ½å–å‡ºæ¥çš„é€šç”¨çš„åŠŸèƒ½ï¼ˆå®ç°å¤ç”¨ï¼‰ï¼Œç”¨æ¥æ”¯æŒæ ¸å¿ƒå¤„ç†å±‚çš„åŠŸèƒ½ã€‚æ¯”å¦‚æ•°æ®æºã€ç¼“å­˜ã€æ—¥å¿—ã€xml è§£æã€åå°„ã€IOã€äº‹åŠ¡ç­‰ç­‰è¿™äº›åŠŸèƒ½ã€‚ 2.å†çœ‹mybatisçš„SQLæ‰§è¡Œæµç¨‹ SQLè¯­å¥çš„æ‰§è¡Œè®¾æ¶‰åŠåˆ°å¾ˆå¤šä¸ªç»„ä»¶ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„å°±æ˜¯Executorï¼ŒStatementHandlerï¼ŒParameterHandlerï¼ŒResultSetHandlerã€‚Executorä¸»è¦è´Ÿè´£ç»´æŠ¤ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œå¹¶æä¾›äº‹åŠ¡ç®¡ç†çš„ç›¸å…³æ“ä½œã€‚ä»–ä¼šå°†æ•°æ®åº“ç›¸å…³çš„æ“ä½œäº¤ç»™StatementHandlerå®Œæˆã€‚StatementHandleré¦–å…ˆé€šè¿‡ParameterHandlerå®ŒæˆSQLè¯­å¥çš„å®å‚ç»‘å®šï¼Œç„¶åé€šè¿‡jdkå†…ç½®çš„Statementå¯¹è±¡æ‰§è¡ŒSQLè¯­å¥å¹¶å¾—åˆ°ç»“æœé›†ï¼Œæœ€åé€šè¿‡ResultSetHandlerå®Œæˆç»“æœé›†çš„æ˜ å°„ï¼Œå¾—åˆ°ç»“æœå¯¹è±¡å¹¶è¿”å›ã€‚ 3. æ ¸å¿ƒå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ3.1 SqlSessionFactoryBuilerå®ƒ æ˜¯ ç”¨ æ¥ æ„ å»º SqlSessionFactory çš„ ï¼Œ è€ŒSqlSessionFactory åªéœ€è¦ä¸€ä¸ªï¼Œæ‰€ä»¥åªè¦æ„å»ºäº†è¿™ä¸€ä¸ª SqlSessionFactoryï¼Œå®ƒçš„ä½¿å‘½å°±å®Œæˆäº†ï¼Œä¹Ÿå°±æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰äº†ã€‚æ‰€ä»¥å®ƒçš„ç”Ÿå‘½å‘¨æœŸåªå­˜åœ¨äºæ–¹æ³•çš„å±€éƒ¨ã€‚ 3.2 SqlSessionFactorySqlSessionFactory æ˜¯ç”¨æ¥åˆ›å»º SqlSession çš„ï¼Œæ¯æ¬¡åº”ç”¨ç¨‹åºè®¿é—®æ•°æ®åº“ï¼Œéƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªä¼šè¯ã€‚å› ä¸ºæˆ‘ä»¬ä¸€ç›´æœ‰åˆ›å»ºä¼šè¯çš„éœ€è¦ï¼Œæ‰€ä»¥ SqlSessionFactory åº”è¯¥å­˜åœ¨äºåº”ç”¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼ˆä½œç”¨åŸŸæ˜¯åº”ç”¨ä½œç”¨åŸŸï¼‰ã€‚åˆ›å»º SqlSession åªéœ€è¦ä¸€ä¸ªå®ä¾‹æ¥åšè¿™ä»¶äº‹å°±è¡Œäº†ï¼Œå¦åˆ™ä¼šäº§ç”Ÿå¾ˆå¤šçš„æ··ä¹±ï¼Œå’Œæµªè´¹èµ„æºã€‚æ‰€ä»¥æˆ‘ä»¬è¦é‡‡ç”¨å•ä¾‹æ¨¡å¼ã€‚ 3.3 SqlSessionSqlSession æ˜¯ä¸€ä¸ªä¼šè¯ï¼Œå› ä¸ºå®ƒä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸èƒ½åœ¨çº¿ç¨‹é—´å…±äº«ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨è¯·æ±‚å¼€å§‹çš„æ—¶å€™åˆ›å»ºä¸€ä¸ª SqlSession å¯¹è±¡ï¼Œåœ¨è¯·æ±‚ç»“æŸæˆ–è€…è¯´æ–¹æ³•æ‰§è¡Œå®Œæ¯•çš„æ—¶å€™è¦åŠæ—¶å…³é—­å®ƒï¼ˆä¸€æ¬¡è¯·æ±‚æˆ–è€…æ“ä½œä¸­ï¼‰ã€‚ 3.4 MapperMapperï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼‰æ˜¯ä» SqlSession ä¸­è·å–çš„ã€‚å®ƒçš„ä½œç”¨æ˜¯å‘é€ SQL æ¥æ“ä½œæ•°æ®åº“çš„æ•°æ®ã€‚å®ƒåº”è¯¥åœ¨ä¸€ä¸ª SqlSession äº‹åŠ¡æ–¹æ³•ä¹‹å†…ã€‚ å¯¹è±¡ ç”Ÿå‘½å‘¨æœŸ SqlSessionFactoryBuiler æ–¹æ³•å±€éƒ¨ï¼ˆmethodï¼‰ SqlSessionFactoryï¼ˆå•ä¾‹ï¼‰ åº”ç”¨çº§åˆ«ï¼ˆapplicationï¼‰ SqlSession è¯·æ±‚å’Œæ“ä½œï¼ˆrequest/methodï¼‰ Mapper æ–¹æ³•ï¼ˆmethodï¼‰ å››ï¼Œæ‰©å±•ï¼šPageHelperåŸç†ä¸Šé¢åˆ†ææºç çš„æ—¶å€™å…¶å®å·²ç»åˆ†æè¿‡ï¼Œmybatisçš„æ‹¦æˆªå™¨å®é™…ä¸Šå°±æ˜¯ä»£ç†æ¨¡å¼åŠ æ‹¦æˆªå™¨æ¥å®ç°çš„ï¼ˆåŒAOPï¼‰ï¼Œè€Œpagehelperå®é™…ä¸Šæ˜¯åŸºäºæ’ä»¶æœºåˆ¶å®ç°çš„ã€‚ å…ˆçœ‹ PageHelper jar åŒ…ä¸­ PageInterceptor çš„æºç ã€‚æ‹¦æˆªçš„æ˜¯ Executor çš„ä¸¤ä¸ªquery()æ–¹æ³•ã€‚åœ¨è¿™é‡Œå¯¹ SQL è¿›è¡Œäº†æ”¹å†™ã€‚ è·Ÿè¸ªåˆ°æœ€åï¼Œæ˜¯åœ¨ MySqlDialect.getPageSql()å¯¹ SQL è¿›è¡Œäº†æ”¹å†™ï¼Œç¿»é¡µå‚æ•°æ˜¯ä»ä¸€ä¸ª Page å¯¹è±¡ä¸­æ‹¿åˆ°çš„ï¼Œé‚£ä¹ˆ Page å¯¹è±¡æ˜¯æ€ä¹ˆä¼ åˆ°è¿™é‡Œçš„å‘¢ï¼Ÿ ä¸Šä¸€æ­¥ï¼ŒAbstractHelperDialect.getPageSql()ä¸­ï¼šPage å¯¹è±¡æ˜¯ä»ä¸€ä¸ª ThreadLocal&lt;&gt;å˜é‡ä¸­æ‹¿åˆ°çš„ï¼Œé‚£å®ƒæ˜¯ä»€ä¹ˆæ—¶å€™èµ‹å€¼çš„ï¼Ÿ PageHelper.startPage()æ–¹æ³•ï¼ŒæŠŠåˆ†é¡µå‚æ•°æ”¾åˆ°äº† ThreadLocal&lt;&gt;å˜é‡ä¸­ã€‚ æ‰©å±•ï¼šæ’ä»¶æœºåˆ¶çš„åº”ç”¨åœºæ™¯ï¼š ä½œç”¨ å®ç°æ–¹å¼ æ°´å¹³åˆ†è¡¨ å¯¹ query update æ–¹æ³•è¿›è¡Œæ‹¦æˆªåœ¨æ¥å£ä¸Šæ·»åŠ æ³¨è§£ï¼Œé€šè¿‡åå°„è·å–æ¥å£æ³¨è§£ï¼Œæ ¹æ®æ³¨è§£ä¸Šé…ç½®çš„å‚æ•°è¿›è¡Œåˆ†è¡¨ï¼Œä¿®æ”¹åŸ SQLï¼Œä¾‹å¦‚ id å–æ¨¡ï¼ŒæŒ‰æœˆåˆ†è¡¨ æ•°æ®åŠ è§£å¯† updateâ€”â€”åŠ å¯†ï¼›queryâ€”â€”è§£å¯†è·å¾—å…¥å‚å’Œè¿”å›å€¼ èœå•æƒé™æ§åˆ¶ å¯¹ query æ–¹æ³•è¿›è¡Œæ‹¦æˆªåœ¨æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£ï¼Œæ ¹æ®æƒé™é…ç½®ï¼Œä»¥åŠç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼Œåœ¨ SQL ä¸ŠåŠ ä¸Šæƒé™è¿‡æ»¤æ¡ä»¶ äº”ï¼Œæ•´åˆSpringå¤§éƒ¨åˆ†æ—¶å€™æˆ‘ä»¬ä¸ä¼šåœ¨é¡¹ç›®ä¸­å•ç‹¬ä½¿ç”¨ MyBatis çš„å·¥ç¨‹ï¼Œè€Œæ˜¯é›†æˆåˆ° Spring é‡Œé¢ä½¿ç”¨ï¼Œä½†æ˜¯å´æ²¡æœ‰çœ‹åˆ°è¿™ä¸‰ä¸ªå¯¹è±¡åœ¨ä»£ç é‡Œé¢çš„å‡ºç°ã€‚æˆ‘ä»¬ç›´æ¥æ³¨å…¥äº†ä¸€ä¸ª Mapper æ¥å£ï¼Œè°ƒç”¨å®ƒçš„æ–¹æ³•ã€‚ SqlSessionFactory æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Ÿ SqlSession å»å“ªé‡Œäº†ï¼Ÿä¸ºä»€ä¹ˆä¸ç”¨å®ƒæ¥ getMapperï¼Ÿ ä¸ºä»€ä¹ˆ@Autowired æ³¨å…¥ä¸€ä¸ªæ¥å£ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™å´å˜æˆäº†ä»£ç†å¯¹è±¡ï¼Ÿåœ¨ IOCçš„å®¹å™¨é‡Œé¢æˆ‘ä»¬æ³¨å…¥çš„æ˜¯ä»€ä¹ˆï¼Ÿ æ³¨å…¥çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ 1.å…³é”®é…ç½®12345&lt;dependency&gt; &lt;groupId&gt;org.mybatis&lt;/groupId&gt; &lt;artifactId&gt;mybatis-spring&lt;/artifactId&gt; &lt;version&gt;2.0.6&lt;/version&gt;&lt;/dependency&gt; ç„¶ååœ¨ Spring çš„ applicationContext.xml é‡Œé¢é…ç½® SqlSessionFactoryBeanï¼Œå®ƒæ˜¯ç”¨æ¥å¸®åŠ©æˆ‘ä»¬åˆ›å»ºä¼šè¯çš„ï¼Œå…¶ä¸­è¿˜è¦æŒ‡å®šå…¨å±€é…ç½®æ–‡ä»¶å’Œ mapper æ˜ å°„å™¨æ–‡ä»¶çš„è·¯å¾„ã€‚ 12345&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt; &lt;property name=&quot;configLocation&quot; value=&quot;classpath:mybatis-config.xml&quot;&gt;&lt;/ property&gt; &lt;property name=&quot;mapperLocations&quot; value=&quot;classpath:mapper/*.xml&quot;&gt;&lt;/ property&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;&lt;/ bean&gt; ç„¶ååœ¨ applicationContext.xml é…ç½®éœ€è¦æ‰«æ Mapper æ¥å£çš„è·¯å¾„ã€‚ 123&lt;bean id=&quot;mapperScanner&quot; class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt; &lt;property name=&quot;basePackage&quot; value=&quot;com.yhd.crud.dao&quot;/&gt;&lt;/ bean&gt; 1&lt;mybatis-springn:scan base-package =&quot;com.yhd.crud.dao&quot;/&gt; 1@MapperScan( &quot;com.yhd.crud.dao&quot;) Spring å¯¹ MyBatis çš„å¯¹è±¡è¿›è¡Œäº†ç®¡ç†ï¼Œä½†æ˜¯å¹¶ä¸ä¼šæ›¿æ¢ MyBatis çš„æ ¸å¿ƒå¯¹è±¡ã€‚ä¹Ÿå°±æ„å‘³ç€ï¼šMyBatis jar åŒ…ä¸­çš„ SqlSessionFactoryã€SqlSessionã€MapperProxy è¿™äº›éƒ½ä¼šç”¨åˆ°ã€‚è€Œ mybatis-spring.jar é‡Œé¢çš„ç±»åªæ˜¯åšäº†ä¸€äº›åŒ…è£…æˆ–è€…æ¡¥æ¢çš„å·¥ä½œã€‚ 2.åˆ›å»ºä¼šè¯å·¥å‚æˆ‘ä»¬åœ¨ Spring çš„é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†ä¸€ä¸ª SqlSessionFactoryBeanï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»ã€‚ å®ƒå®ç°äº† InitializingBean æ¥å£ï¼Œæ‰€ä»¥è¦å®ç° afterPropertiesSet()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨ bean çš„å±æ€§å€¼è®¾ç½®å®Œçš„æ—¶å€™è¢«è°ƒç”¨ å¦å¤–å®ƒå®ç°äº† FactoryBean æ¥å£ï¼Œæ‰€ä»¥å®ƒåˆå§‹åŒ–çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨ getObject()æ–¹æ³•ï¼Œå®ƒé‡Œé¢è°ƒç”¨çš„ä¹Ÿæ˜¯ afterPropertiesSet()æ–¹æ³•ã€‚ åœ¨ afterPropertiesSet()æ–¹æ³•é‡Œé¢ï¼šè§£æé…ç½®æ–‡ä»¶ï¼ŒæŒ‡å®šäº‹åŠ¡å·¥å‚ã€‚ 3.åˆ›å»ºSqlSession3.1å¯ä»¥ç›´æ¥ä½¿ç”¨ DefaultSqlSession å—ï¼Ÿç°åœ¨å·²ç»æœ‰ä¸€ä¸ª DefaultSqlSessionFactoryï¼ŒæŒ‰ç…§ç¼–ç¨‹å¼çš„å¼€å‘è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±ä¼šåˆ›å»ºä¸€ä¸ª SqlSession çš„å®ç°ç±»ï¼Œä½†æ˜¯åœ¨ Spring é‡Œé¢ï¼Œæˆ‘ä»¬ä¸æ˜¯ç›´æ¥ä½¿ç”¨DefaultSqlSession çš„ï¼Œè€Œæ˜¯å¯¹å®ƒè¿›è¡Œäº†ä¸€ä¸ªå°è£…ï¼Œè¿™ä¸ª SqlSession çš„å®ç°ç±»å°±æ˜¯SqlSessionTemplateã€‚è¿™ä¸ªè·Ÿ Spring å°è£…å…¶ä»–çš„ç»„ä»¶æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚ JdbcTemplateï¼ŒRedisTemplate ç­‰ç­‰ï¼Œä¹Ÿæ˜¯ Spring è·Ÿ MyBatis æ•´åˆçš„æœ€å…³é”®çš„ä¸€ä¸ªç±»ã€‚ ä¸ºä»€ä¹ˆä¸ç”¨ DefaultSqlSessionï¼Ÿå®ƒæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ³¨æ„çœ‹ç±»ä¸Šçš„æ³¨è§£ï¼šè€Œ SqlSessionTemplate æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ 1Note that this class is not Thread-Safe. 3.2æ€ä¹ˆæ‹¿åˆ°ä¸€ä¸ª SqlSessionTemplate ï¼ŸMyBatisæä¾›äº†ä¸€ä¸ª SqlSessionDaoSupportï¼Œé‡Œé¢æŒæœ‰ä¸€ä¸ªSqlSessionTemplate å¯¹è±¡ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ª getSqlSession()æ–¹æ³•ï¼Œè®©æˆ‘ä»¬è·å¾—ä¸€ä¸ªSqlSessionTemplateã€‚ 123456public abstract class SqlSessionDaoSupport extends DaoSupport &#123; private SqlSessionTemplate sqlSessionTemplate; public SqlSession getSqlSession() &#123; return this.sqlSessionTemplate; &#125;&#125; å…ˆåˆ›å»ºä¸€ä¸ª BaseDao ç»§æ‰¿ SqlSessionDaoSupportã€‚åœ¨BaseDao é‡Œé¢å°è£…å¯¹æ•°æ®åº“çš„æ“ä½œï¼ŒåŒ…æ‹¬ selectOne()ã€selectList()ã€insert()ã€delete()è¿™äº›æ–¹æ³•ï¼Œå­ç±»å°±å¯ä»¥ç›´æ¥è°ƒç”¨ã€‚ ç„¶åè®©æˆ‘ä»¬çš„å®ç°ç±»ç»§æ‰¿ BaseDao å¹¶ä¸”å®ç°æˆ‘ä»¬çš„ DAO å±‚æ¥å£ï¼Œè¿™é‡Œå°±æ˜¯æˆ‘ä»¬çš„Mapper æ¥å£ã€‚å®ç°ç±»éœ€è¦åŠ ä¸Š@Repository çš„æ³¨è§£ã€‚ åœ¨å®ç°ç±»çš„æ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨çˆ¶ç±»ï¼ˆBaseDaoï¼‰å°è£…çš„ selectOne()æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒæœ€ç»ˆä¼šè°ƒç”¨ sqlSessionTemplate çš„ selectOne()æ–¹æ³•ã€‚ 3.3æœ‰æ²¡æœ‰æ›´å¥½çš„æ‹¿åˆ° SqlSessionTemplateæˆ‘ä»¬çš„æ¯ä¸€ä¸ª DAO å±‚çš„æ¥å£ï¼ˆMapper æ¥å£ä¹Ÿå±äºï¼‰ï¼Œå¦‚æœè¦æ‹¿åˆ°ä¸€ä¸ª SqlSessionTemplateï¼Œå»æ“ä½œæ•°æ®åº“ï¼Œéƒ½è¦åˆ›å»ºå®ç°ä¸€ä¸ªå®ç°ç±»ï¼ŒåŠ ä¸Š@Repository çš„æ³¨è§£ï¼Œç»§æ‰¿ BaseDaoï¼Œè¿™ä¸ªå·¥ä½œé‡ä¹Ÿä¸å°ã€‚ å¦å¤–ä¸€ä¸ªï¼Œæˆ‘ä»¬å»ç›´æ¥è°ƒç”¨ selectOne()æ–¹æ³•ï¼Œè¿˜æ˜¯å‡ºç°äº† Statement ID çš„ç¡¬ç¼–ç ï¼ŒMapperProxy åœ¨è¿™é‡Œæ ¹æœ¬æ²¡ç”¨ä¸Šã€‚ 4.æ¥å£çš„æ‰«ææ³¨å†Œåœ¨ applicationContext.xml é‡Œ é¢ é… ç½® äº† ä¸€ ä¸ªMapperScannerConfigurerã€‚ MapperScannerConfigurer å®ç°äº† BeanDefinitionRegistryPostProcessor æ¥å£ï¼ŒBeanDefinitionRegistryPostProcessor æ˜¯ BeanFactoryPostProcessor çš„å­ç±»ï¼Œå¯ä»¥é€šè¿‡ç¼–ç çš„æ–¹å¼ä¿®æ”¹ã€æ–°å¢æˆ–è€…åˆ é™¤æŸäº› Bean çš„å®šä¹‰ã€‚ æˆ‘ä»¬åªéœ€è¦é‡å†™ postProcessBeanDefinitionRegistry()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œé¢æ“ä½œ Beanå°±å¯ä»¥äº†ã€‚ åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼š scanner.scan() æ–¹ æ³• æ˜¯ ClassPathBeanDefinitionScanner ä¸­ çš„ ï¼Œ è€Œ å®ƒ çš„ å­ ç±»ClassPathMapperScanner è¦† ç›– äº† doScan() æ–¹ æ³• ï¼Œ åœ¨ doScan() ä¸­ è°ƒ ç”¨ äº†processBeanDefinitionsï¼Œå®ƒå…ˆè°ƒç”¨çˆ¶ç±»çš„ doScan()æ‰«ææ‰€æœ‰çš„æ¥å£ã€‚ processBeanDefinitions æ–¹æ³•é‡Œé¢ï¼Œåœ¨æ³¨å†Œ beanDefinitions çš„æ—¶å€™ï¼ŒBeanClassè¢«æ”¹ä¸º MapperFactoryBeanï¼ˆæ³¨æ„ç°è‰²çš„æ³¨é‡Šï¼‰ã€‚ ä¸ºä»€ä¹ˆè¦æŠŠ BeanClass ä¿®æ”¹æˆ MapperFactoryBeanï¼Œè¿™ä¸ªç±»æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ MapperFactoryBean ç»§ æ‰¿ äº† SqlSessionDaoSupport ï¼Œ å¯ ä»¥ æ‹¿ åˆ°SqlSessionTemplateã€‚ 5.æ¥å£æ³¨å…¥ä½¿ç”¨æˆ‘ä»¬ä½¿ç”¨ Mapper çš„æ—¶å€™ï¼Œåªéœ€è¦åœ¨åŠ äº† Service æ³¨è§£çš„ç±»é‡Œé¢ä½¿ç”¨@Autowiredæ³¨å…¥ Mapper æ¥å£å°±å¥½äº†ã€‚ 123456789 @Service public class EmployeeService &#123; @Autowired EmployeeMapper employeeMapper; public List&lt;Employee&gt; getAll() &#123; return employeeMapper.selectByMap( null); &#125;&#125; Spring åœ¨å¯åŠ¨çš„æ—¶å€™éœ€è¦å»å®ä¾‹åŒ– EmployeeServiceã€‚ EmployeeService ä¾èµ–äº† EmployeeMapper æ¥å£ï¼ˆæ˜¯ EmployeeService çš„ä¸€ä¸ªå±æ€§ï¼‰ã€‚ Spring ä¼šæ ¹æ® Mapper çš„åå­—ä» BeanFactory ä¸­è·å–å®ƒçš„ BeanDefinationï¼Œå†ä»BeanDefination ä¸­ è· å– BeanClass ï¼ŒEmployeeMapper å¯¹ åº” çš„ BeanClass æ˜¯MapperFactoryBeanï¼ˆä¸Šä¸€æ­¥å·²ç»åˆ†æè¿‡ï¼‰ã€‚ æ¥ä¸‹æ¥å°±æ˜¯åˆ›å»º MapperFactoryBeanï¼Œå› ä¸ºå®ç°äº† FactoryBean æ¥å£ï¼ŒåŒæ ·æ˜¯è°ƒç”¨ getObject()æ–¹æ³•ã€‚ 1234// MapperFactoryBean.java public T getObject() throws Exception &#123; return getSqlSession().getMapper( this. mapperInterface);&#125; å› ä¸º MapperFactoryBean ç»§ æ‰¿ äº† SqlSessionDaoSupport ï¼Œ æ‰€ ä»¥ è¿™ ä¸ªgetSqlSession()å°±æ˜¯è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œè¿”å› SqlSessionTemplateã€‚ 1234// SqlSessionDaoSupport.javapublic SqlSession getSqlSession() &#123; return this. sqlSessionTemplate;&#125; æˆ‘ä»¬æ³¨å…¥åˆ° Service å±‚çš„æ¥å£ï¼Œå®é™…ä¸Šè¿˜æ˜¯ä¸€ä¸ª MapperProxy ä»£ç†å¯¹è±¡ã€‚æ‰€ä»¥æœ€åè°ƒç”¨ Mapper æ¥å£çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯æ‰§è¡Œ MapperProxy çš„ invoke()æ–¹æ³•ã€‚ DaoSupport ï¼Œ æ‰€ ä»¥ è¿™ ä¸ªgetSqlSession()å°±æ˜¯è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œè¿”å› SqlSessionTemplateã€‚ 1234// SqlSessionDaoSupport.javapublic SqlSession getSqlSession() &#123; return this. sqlSessionTemplate;&#125; æˆ‘ä»¬æ³¨å…¥åˆ° Service å±‚çš„æ¥å£ï¼Œå®é™…ä¸Šè¿˜æ˜¯ä¸€ä¸ª MapperProxy ä»£ç†å¯¹è±¡ã€‚æ‰€ä»¥æœ€åè°ƒç”¨ Mapper æ¥å£çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯æ‰§è¡Œ MapperProxy çš„ invoke()æ–¹æ³•ã€‚ 6.æ€»ç»“â€‹ Mybatisæ•´åˆSpringæ¡†æ¶é¦–å…ˆåˆ©ç”¨çš„æ˜¯Springæ¡†æ¶çš„SPIæœºåˆ¶ï¼Œåœ¨é¡¹ç›®çš„META-INFç›®å½•ä¸‹æœ‰ä¸€ä¸ªæ–‡ä»¶ã€spring.handlersã€‘ï¼Œé‡Œé¢ç»™Springå®¹å™¨ä¸­å¯¼å…¥äº†ä¸€ä¸ªç±»ã€NamespaceHandlerã€‘ã€‚ã€NamespaceHandlerã€‘ ç»§æ‰¿å…³ç³»ä¸Šï¼šå®ç°äº†springçš„æ‰©å±•ç‚¹æ¥å£ ã€initã€‘ç»™å®¹å™¨ä¸­æ³¨å†Œäº†ä¸€ä¸ªã€BeanDefinitionParserã€‘beanå®šä¹‰ä¿¡æ¯çš„è§£æå™¨ ã€MapperScannerBeanDefinitionParserã€‘ã€MapperScannerBeanDefinitionParserã€‘ ä»–ä¼šåœ¨springå®¹å™¨åˆ›å»ºè¿‡ç¨‹ä¸­å»è§£æã€mapperScannerã€‘æ ‡ç­¾ è§£æå‡ºæ¥çš„å±æ€§ä¼šç»™ã€MapperScannerConfigurerã€‘èµ‹èƒ½å¦ä¸€ä¸ªéœ€è¦é…ç½®çš„beanå°±æ˜¯ã€SqlSessionFactoryBeanã€‘ ç»§æ‰¿å…³ç³» FactoryBean InitializingBean åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰§è¡Œã€afterPropertiesSet()ã€‘ ApplicationListener afterPropertiesSet() buildSqlSessionFactory() åˆ›å»ºMybatisçš„ä¸»é…ç½®æ–‡ä»¶è§£æå™¨ï¼Œè§£æä¸»é…ç½®æ–‡ä»¶ åˆ›å»ºmapperæ˜ å°„æ–‡ä»¶çš„è§£æå™¨ï¼Œè§£æmapperæ˜ å°„æ–‡ä»¶ æ„å»ºå‡ºä¸€ä¸ªConfigurationå¯¹è±¡ä¼ å…¥åˆ°ã€SqlSessionFactoryBuilderã€‘çš„ã€build()ã€‘ æœ€ç»ˆè¿”å›äº†ä¸€ä¸ªã€SqlSessionFactoryã€‘å¯¹è±¡å®ä¾‹ã€MapperScannerConfigurerã€‘ ç»§æ‰¿å…³ç³» ã€BeanDefinitionRegistryPostProcessorã€‘ ã€postProcessBeanDefinitionRegistry()ã€‘ åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œæ‰«æäº†é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„basePackage ä¸‹çš„æ‰€æœ‰ Mapper ç±»ï¼Œæœ€ç»ˆç”Ÿæˆ Spring çš„ Bean å¯¹è±¡ï¼Œæ³¨å†Œåˆ°å®¹å™¨ä¸­ è¿™é‡Œé¢è°ƒç”¨äº†åŒ…æ‰«æçš„æ–¹æ³•ã€scanner.scan()ã€‘ç»è¿‡ä¸€ç³»åˆ—è°ƒç”¨ï¼Œè°ƒç”¨åˆ°äº† ã€ClassPathMapperScannerã€‘çš„ã€doScanã€‘ è°ƒç”¨çˆ¶ç±»çš„doScan()æ–¹æ³•ï¼Œéå†basePackagesä¸­æŒ‡å®šçš„æ‰€æœ‰åŒ…ï¼Œæ‰«ææ¯ä¸ªåŒ…ä¸‹çš„Javaæ–‡ä»¶å¹¶è¿›è¡Œè§£æã€‚ ä½¿ç”¨ä¹‹å‰æ³¨å†Œçš„è¿‡æ»¤å™¨è¿›è¡Œè¿‡æ»¤ï¼Œå¾—åˆ°ç¬¦åˆæ¡ä»¶çš„BeanDefinitionHolderå¯¹è±¡ ã€processBeanDefinitions()ã€‘å¤„ç†æ‰«æå¾—åˆ°çš„BeanDefinitionHolderé›†åˆ å¾ªç¯ å°†BeanDefinitionä¸­è®°å½•çš„Beanç±»å‹ä¿®æ”¹ä¸ºã€MapperFactoryBeanã€‘ å°†æ‰«æåˆ°çš„æ¥å£ç±»å‹ä½œä¸ºæ„é€ æ–¹æ³•çš„å‚æ•° æ„é€ MapperFactoryBeançš„å±æ€§ï¼Œå°†sqlSessionFactoryã€sqlSessionTemplate ç­‰ä¿¡æ¯å¡«å……åˆ°BeanDefinitionä¸­ï¼Œä¿®æ”¹è‡ªåŠ¨æ³¨å…¥æ–¹å¼ é‡æ–°æ³¨å†Œåˆ°å®¹å™¨ ClassPathMapperScanner åœ¨å¤„ç† Mapper æ¥å£çš„æ—¶å€™ç”¨åˆ°äº† MapperFactoryBean ç±»ï¼ŒåŠ¨æ€ä»£ç†çš„å®ç°ï¼Œå¯ä»¥ç›´æ¥å°† Mapper æ¥å£æ³¨å…¥åˆ° Service å±‚çš„ Bean ä¸­ï¼Œè¿™æ ·å°±ä¸éœ€è¦ç¼–å†™ä»»ä½• DAO å®ç°çš„ä»£ç ã€‚ã€MapperFactoryBeanã€‘ ç»§æ‰¿å…³ç³» InitializingBean DaoSupport SqlSessionDaoSupport FactoryBean MapperFactoryBean MapperFactoryBean ç±»çš„åŠ¨æ€ä»£ç†åŠŸèƒ½æ˜¯é€šè¿‡å®ç°äº† Spring æä¾›çš„ FactoryBean æ¥å£å®ç°çš„ï¼Œè¯¥æ¥å£æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»º Bean å¯¹è±¡çš„å·¥å‚æ¥å£ï¼Œé€šè¿‡ getObject() æ–¹æ³•è·å–çœŸå®çš„å¯¹è±¡ã€‚ ã€getObject()ã€‘ ã€getSqlSession().getMapper(this.mapperInterface)ã€‘ ã€getSqlSession()ã€‘æ˜¯å¥¹çˆ¶ç±»ã€SqlSessionDaoSupportã€‘çš„æ–¹æ³• ã€getMapper()ã€‘ é€šè¿‡sqlSessionè·å–åˆ°mapperä»£ç†å¯¹è±¡è¿™é‡Œé¢æ¶‰åŠåˆ°äº†ä¸€ä¸ªç±» ã€SqlSessionDaoSupportã€‘ æ„é€ å™¨ é€šè¿‡ Spring å®¹å™¨è‡ªåŠ¨æ³¨å…¥ sqlSessionFactory å±æ€§ ã€createSqlSessionTemplate()ã€‘ åˆ›å»ºäº†ä¸€ä¸ªã€SqlSessionTemplateã€‘å¯¹è±¡å¹¶ä¸”é‡Œé¢æŒæœ‰ã€SqlSessionFactoryã€‘ã€SqlSessionTemplateã€‘ SqlSessionTemplate å®ç°äº† SqlSession æ¥å£ï¼Œåœ¨ MyBatis ä¸ Spring é›†æˆå¼€å‘æ—¶ï¼Œç”¨æ¥ä»£æ›¿ MyBatis ä¸­çš„ DefaultSqlSession çš„åŠŸèƒ½ã€‚ SqlSessionTemplate æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥åœ¨ DAO ä¹‹é—´å…±äº«ä½¿ç”¨ï¼Œæ¯”å¦‚ä¸Šé¢ç”Ÿæˆçš„ Mapper å¯¹è±¡ä¼šæŒæœ‰ä¸€ä¸ª SqlSessionTemplate å¯¹è±¡ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šå…±ç”¨è¯¥å¯¹è±¡ã€‚ åœ¨ MyBatis ä¸­ SqlSession çš„ Scope æ˜¯ä¼šè¯çº§åˆ«ï¼Œè¯·æ±‚ç»“æŸåéœ€è¦å…³é—­æœ¬æ¬¡ä¼šè¯ï¼Œæ€ä¹ˆé›†æˆäº† Spring åï¼Œå¯ä»¥å…±ç”¨äº†ï¼Ÿ é¦–å…ˆï¼Œåœ¨é›†æˆ Spring åï¼ŒMapper å¯¹è±¡æ˜¯å•ä¾‹ï¼Œç”± Spring å®¹å™¨ç®¡ç†ï¼Œä¾› Service å±‚ä½¿ç”¨ï¼ŒSqlSessionTemplate åœ¨è®¾è®¡çš„æ—¶å€™ï¼ŒåŠŸèƒ½åˆ†æˆäº†å¦‚ä¸‹ä¸¤éƒ¨åˆ†ï¼š 1. è·å– MapperProxy ä»£ç†å¯¹è±¡ï¼› 2. æ‰§è¡Œ SQL æ“ä½œï¼Œè¯¥éƒ¨åˆ†åŠŸèƒ½é€šè¿‡ä»£ç†å¯¹è±¡ SqlSessionInterceptor å®ç°ï¼› ã€æ„é€ å™¨ã€‘ sqlSessioné€šè¿‡åŠ¨æ€ä»£ç†æ¥åˆ›å»ºçš„ï¼Œã€SqlSessionInterceptorã€‘å®ç°äº† ã€InvocationHandlerã€‘å½“è°ƒç”¨mapperé‡Œé¢çš„æ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œã€SqlSessionInterceptorã€‘çš„ã€invoke()ã€‘ é€šè¿‡SqlSessionUtils.getSqlSession()è·å–SqlSessionå¯¹è±¡ï¼ŒåŒä¸€ä¸ªäº‹åŠ¡å…±äº«SqlSession é€šè¿‡ã€invokeã€‘è°ƒç”¨SqlSessionå¯¹è±¡çš„ç›¸åº”æ–¹æ³• æ£€æµ‹äº‹åŠ¡æ˜¯å¦ç”±Springè¿›è¡Œç®¡ç†ï¼Œå¹¶æ®æ­¤å†³å®šæ˜¯å¦æäº¤äº‹åŠ¡ã€‚â€‹ Mybatis-Spring ä¸­æ–‡æ³¨é‡Šæºç åœ°å€ï¼šhttps://gitee.com/yin_huidong/mybatis-spring.git\u0000","categories":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://yinhuidong.github.io/categories/MyBatis/"}],"tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://yinhuidong.github.io/tags/MyBatis/"}]},{"title":"Spring[åä¸€]æ³¨è§£ç‰ˆAopæµç¨‹åˆ†æ","slug":"Spring/Spring[åä¸€]æ³¨è§£ç‰ˆAopæµç¨‹åˆ†æ","date":"2022-01-11T06:13:44.508Z","updated":"2022-01-11T06:18:16.601Z","comments":true,"path":"2022/01/11/Spring/Spring[åä¸€]æ³¨è§£ç‰ˆAopæµç¨‹åˆ†æ/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E5%8D%81%E4%B8%80]%E6%B3%A8%E8%A7%A3%E7%89%88Aop%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/","excerpt":"","text":"ä¸Šä¸€ç¯‡ä»‹ç»äº†å®ç°AOPçš„ä¸¤ç§æ–¹å¼ï¼Œæœ¬ç¯‡æˆ‘ä»¬é€šè¿‡åˆ†ææºç æµç¨‹ï¼Œæ¥çœ‹ä¸€ä¸‹æ³¨è§£ç‰ˆAOPçš„å®ç°ã€‚å…·ä½“çš„æºç ç»†èŠ‚ï¼Œä¼šåœ¨åé¢çš„ç¯‡ç« ä¸€è¡Œè¡Œç¿»è¯‘ã€‚ 1.å¼€å¯AOPçš„åŠŸèƒ½è¯»æºç éœ€è¦æ‰¾åˆ°å…¥å£æˆ–è€…æŠ“æ‰‹ï¼ŒAOPçš„æºç æˆ‘ä»¬å¦‚ä½•å…¥æ‰‹å‘¢ï¼Ÿæƒ³è¦ä½¿ç”¨AOPçš„åŠŸèƒ½å°±éœ€è¦åœ¨Springçš„é…ç½®ç±»ä¸ŠåŠ ä¸Š**@EnableAspectJAutoProxy**æ³¨è§£ã€‚â€‹ å…ˆåˆ†æä¸€ä¸‹è¿™ä¸ªæ³¨è§£ï¼š\u0000 12345678910111213141516171819@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Import(AspectJAutoProxyRegistrar.class)public @interface EnableAspectJAutoProxy &#123; /** * æ˜¯å¦è¦åˆ›å»ºåŸºäºå­ç±» (CGLIB) çš„ä»£ç†ï¼Œè€Œä¸æ˜¯åŸºäºæ ‡å‡† Java æ¥å£çš„ä»£ç†ã€‚ é»˜è®¤å€¼ä¸ºfalse ã€‚ * @return */ boolean proxyTargetClass() default false; /** * ä»£ç†åº”ç”± AOP æ¡†æ¶å…¬å¼€ä¸ºThreadLocalä»¥é€šè¿‡AopContextç±»è¿›è¡Œæ£€ç´¢ã€‚ * é»˜è®¤å…³é—­ï¼Œå³ä¸ä¿è¯AopContextè®¿é—®å°†èµ·ä½œç”¨ã€‚ */ boolean exposeProxy() default false;&#125; å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ³¨è§£çš„åº•å±‚æœ‰ä¸€ä¸ª**@Import(AspectJAutoProxyRegistrar.class)**ï¼Œä»–å¾€å®¹å™¨ä¸­å¯¼å…¥äº†ä¸€ä¸ªç»„ä»¶**AspectJAutoProxyRegistrar**ã€‚â€‹ çœ‹ä¸€ä¸‹è¿™ä¸ªç»„ä»¶ï¼šâ€‹ 12345678910111213141516171819202122class AspectJAutoProxyRegistrar implements ImportBeanDefinitionRegistrar &#123; @Override public void registerBeanDefinitions( AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123; /*å¯¼å…¥ç»„ä»¶åˆ°å®¹å™¨ä¸­ AnnotationAwareAspectJAutoProxyCreator*/ AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry); AnnotationAttributes enableAspectJAutoProxy = AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class); if (enableAspectJAutoProxy != null) &#123; if (enableAspectJAutoProxy.getBoolean(&quot;proxyTargetClass&quot;)) &#123; AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry); &#125; if (enableAspectJAutoProxy.getBoolean(&quot;exposeProxy&quot;)) &#123; AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry); &#125; &#125; &#125;&#125; 12345678910@Nullablepublic static BeanDefinition registerAspectJAnnotationAutoProxyCreatorIfNecessary( BeanDefinitionRegistry registry, @Nullable Object source) &#123; /* * å‚æ•°ä¸€ï¼šå›ºå®šç±»å‹ * å‚æ•°äºŒï¼šspringå®¹å™¨ * å‚æ•°ä¸‰ï¼šæ ‡ç­¾ * */ return registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source);&#125; \u0000\u0000**AspectJAutoProxyRegistrar** å®ç°äº† **ImportBeanDefinitionRegistrar**æ¥å£ï¼Œå¾€å®¹å™¨ä¸­æ³¨å†Œäº†ä¸€ä¸ªbdä¿¡æ¯ã€‚**AnnotationAwareAspectJAutoProxyCreator**â€‹ 2.åŠ è½½æ—¶æœº\u0000ä¸Šä¸€èŠ‚æˆ‘ä»¬åˆ†æåˆ°ï¼Œåœ¨Springçš„é…ç½®ç±»ä¸Šæ‰“ä¸€ä¸ªæ³¨è§£ï¼Œæœ€åæ€»ä¼šå¾€å®¹å™¨ä¸­å¯¼å…¥ä¸€ä¸ªç±»ï¼š**AnnotationAwareAspectJAutoProxyCreator**ã€‚â€‹ æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªç±»çš„ç»§æ‰¿å…³ç³»ï¼šâ€‹ æŒ‰ç…§é¡ºåºåˆ†æä¸€ä¸‹è¿™ä¸ªç±»çš„åŠ è½½æ—¶æœºå’ŒåŠ è½½çš„æ—¶å€™ï¼Œé‡Œé¢çš„ **initBeanFactory()** &amp; **setBeanFactory()** æ˜¯ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„ã€‚â€‹ â€‹ \u0000 é¦–å…ˆæ‰§è¡Œçš„æ˜¯**AbstractAdvisorAutoProxyCreator**çš„**setBeanFactory()**ã€‚ 123456789@Overridepublic void setBeanFactory(BeanFactory beanFactory) &#123; super.setBeanFactory(beanFactory); if (!(beanFactory instanceof ConfigurableListableBeanFactory)) &#123; throw new IllegalArgumentException( &quot;AdvisorAutoProxyCreator requires a ConfigurableListableBeanFactory: &quot; + beanFactory); &#125; initBeanFactory((ConfigurableListableBeanFactory) beanFactory);&#125; æ¥ä¸‹æ¥æ‰§è¡Œçš„æ˜¯**AbstractAutoProxyCreator**çš„**setBeanFactory()**ã€‚ \u0000 1234@Overridepublic void setBeanFactory(BeanFactory beanFactory) &#123; this.beanFactory = beanFactory;&#125; â€‹ ç„¶åæ‰§è¡Œçš„æ˜¯**AnnotationAwareAspectJAutoProxyCreator**çš„**initBeanFactory()** ã€‚ â€‹ 123456789@Overrideprotected void initBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123; super.initBeanFactory(beanFactory); if (this.aspectJAdvisorFactory == null) &#123; this.aspectJAdvisorFactory = new ReflectiveAspectJAdvisorFactory(beanFactory); &#125; this.aspectJAdvisorsBuilder = new BeanFactoryAspectJAdvisorsBuilderAdapter(beanFactory, this.aspectJAdvisorFactory);&#125; æœ€ç»ˆæ‰§è¡Œçš„æ˜¯**AbstractAdvisorAutoProxyCreator**çš„**initBeanFactory()**ã€‚ â€‹ 123protected void initBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123; this.advisorRetrievalHelper = new BeanFactoryAdvisorRetrievalHelperAdapter(beanFactory);&#125; æ¥ä¸‹æ¥åˆ†æ**AnnotationAwareAspectJAutoProxyCreator**çš„æ‰§è¡Œæ—¶æœºã€‚â€‹ 3.åˆ›å»ºä»£ç†å¯¹è±¡ 4.è·å–æ‹¦æˆªå™¨ 5.é“¾å¼è°ƒç”¨é€šçŸ¥æ–¹æ³• 6.æµç¨‹æ€»ç»“ AOPå…¶å®å°±æ˜¯å¾€å®¹å™¨ä¸­å¯¼å…¥äº†ä¸€ä¸ªç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶æ˜¯ä¸€ä¸ªåç½®å¤„ç†å™¨ï¼Œä»–ä¼šåœ¨å¯¹è±¡åˆ›å»ºä¹‹å‰å°è¯•è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¦‚æœä¸èƒ½æˆåŠŸè¿”å›ï¼Œä¼šåœ¨å¯¹è±¡åˆ›å»ºä¹‹åï¼Œinitæ–¹æ³•æ‰§è¡Œå‰åå»åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯å¦éœ€è¦è¢«ä»£ç†ï¼Œå¦‚æœéœ€è¦è¢«ä»£ç†åˆ™æ ¹æ®å„ç§æ¡ä»¶å»é€‰æ‹©ä»£ç†æ–¹å¼ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡ï¼ŒåŒæ—¶ä¼šå»åˆ¤æ–­å“ªäº›åˆ‡é¢å’Œæ–¹æ³•éœ€è¦å¢å¼ºä»£ç†å¯¹è±¡é‡Œé¢çš„æ–¹æ³•ï¼Œç”Ÿæˆä¸€æ¡æ‹¦æˆªå™¨é“¾ã€‚\u0000\u0000åœ¨ä»£ç†å¯¹è±¡æ‰§è¡Œç›®æ ‡æ–¹æ³•å‰åï¼Œé€šè¿‡æ‹¦æˆªå™¨å¯¹ç›®æ ‡æ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œæ‰§è¡Œå¢å¼ºé€»è¾‘ã€‚","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[æ‰©å±•]æ¨¡æ‹Ÿæ ¸å¿ƒåŸç†","slug":"Spring/Spring[æ‰©å±•]æ¨¡æ‹Ÿæ ¸å¿ƒåŸç†","date":"2022-01-11T06:11:42.407Z","updated":"2022-01-11T06:20:30.143Z","comments":true,"path":"2022/01/11/Spring/Spring[æ‰©å±•]æ¨¡æ‹Ÿæ ¸å¿ƒåŸç†/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E6%89%A9%E5%B1%95]%E6%A8%A1%E6%8B%9F%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/","excerpt":"","text":"ä¸€ï¼Œå®ç°æ€è·¯1ï¼Œé…ç½®é˜¶æ®µ é…ç½®web.xml DispatcherServlet è®¾å®šinit-param contextConfigLocation=classpath:application.xml è®¾å®šurl-pattern /* é…ç½®Annotation @Controller @Service @Autowrited @RequestMapping 2,åˆå§‹åŒ–é˜¶æ®µ è°ƒç”¨initæ–¹æ³• åŠ è½½é…ç½®æ–‡ä»¶ IOCå®¹å™¨åˆå§‹åŒ– MAP æ‰«æç›¸å…³çš„ç±» scan-package=â€â€ åˆ›å»ºå®ä¾‹åŒ–å¹¶ä¿å­˜è‡³å®¹å™¨ é€šè¿‡åå°„æœºåˆ¶å°†ç±»å®ä¾‹åŒ–æ”¾å…¥IOCå®¹å™¨ è¿›è¡ŒDIæ“ä½œ æ‰«æIOCå®¹å™¨çš„å®ä¾‹ï¼Œç»™æ²¡æœ‰èµ‹å€¼çš„å±æ€§è‡ªåŠ¨å¡«å…… åˆå§‹åŒ–HandlerMapping è®²ä¸€ä¸ªURLå’Œä¸€ä¸ªMethodè¿›è¡Œä¸€å¯¹ä¸€çš„æ˜ å°„ 3ï¼Œè¿è¡Œé˜¶æ®µ è°ƒç”¨doGet/doPost webå®¹å™¨è°ƒç”¨dogetã€dopostï¼Œè·å–reqå’Œrespå¯¹è±¡ åŒ¹é…HandlerMapping ä»reqå¯¹è±¡è·å–è¾“å…¥çš„URLï¼Œæ‰¾åˆ°å…¶å¯¹åº”çš„method åå°„è°ƒç”¨method.invoker() åˆ©ç”¨åå°„è°ƒç”¨æ–¹æ³•å¹¶è¿”å›ç»“æœ response.getWrite().write() å°†è¿”å›ç»“æœè¾“å‡ºåˆ°æµè§ˆå™¨ äºŒï¼Œè‡ªå®šä¹‰é…ç½®1ï¼Œé…ç½® application.properties æ–‡ä»¶ä¸ºäº†è§£ææ–¹ä¾¿ï¼Œç”¨ application.properties æ¥ä»£æ›¿ application.xml æ–‡ä»¶ï¼Œå…·ä½“é…ç½®å†…å®¹å¦‚ä¸‹ï¼š 1scanPackage=com.yhd.spring01 2ï¼Œé…ç½®web.xmlæ–‡ä»¶12345678910111213141516171819202122&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;web-app xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://java.sun.com/xml/ns/j2ee&quot; xmlns:javaee=&quot;http://java.sun.com/xml/ns/javaee&quot; xmlns:web=&quot;http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot; xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/j2eehttp://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot; version=&quot;2.4&quot;&gt; &lt;display-name&gt;YHD Web Application&lt;/display-name&gt; &lt;servlet&gt; &lt;servlet-name&gt;yhdmvc&lt;/servlet-name&gt; &lt;servlet-class&gt;com.yhd.spring01.servlet.HdDispatcherServlet&lt;/servlet-class&gt; &lt;init-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;application.properties&lt;/param-value&gt; &lt;/init-param&gt; &lt;load-on-startup&gt;1&lt;/load-on-startup&gt; &lt;/servlet&gt; &lt;servlet-mapping&gt; &lt;servlet-name&gt;yhdmvc&lt;/servlet-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt; &lt;/servlet-mapping&gt;&lt;/web-app&gt; 3ï¼Œè‡ªå®šä¹‰æ³¨è§£123456@Target(&#123;ElementType.FIELD&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface HdAutowired &#123; String value() default &quot;&quot;;&#125; 1234567import java.lang.annotation.*;@Target(&#123;ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface HdController &#123; String value() default &quot;&quot;;&#125; 123456@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface HdRequestMapping &#123; String value() default &quot;&quot;;&#125; 123456@Target(&#123;ElementType.PARAMETER&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface HdRequestParam &#123; String value() default &quot;&quot;;&#125; 123456@Target(&#123;ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface HdService &#123; String value() default &quot;&quot;;&#125; 4ï¼Œç¼–å†™æ¨¡æ‹Ÿä¸šåŠ¡1234567@HdServicepublic class DemoService implements IDemoService &#123; @Override public String get(String name) &#123; return &quot;My name is &quot; + name; &#125;&#125; 12345678910111213141516171819202122232425262728293031@HdController@HdRequestMapping(&quot;/demo&quot;)public class DemoController &#123; @HdAutowired private IDemoService demoService; @HdRequestMapping(&quot;/query&quot;) public void query(HttpServletRequest req, HttpServletResponse resp, @HdRequestParam(&quot;name&quot;) String name)&#123; String result = demoService.get(name); try &#123; resp.getWriter().write(result); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; @HdRequestMapping(&quot;/add&quot;) public void add(HttpServletRequest req, HttpServletResponse resp, @HdRequestParam(&quot;a&quot;) Integer a, @HdRequestParam(&quot;b&quot;) Integer b)&#123; try &#123; resp.getWriter().write(a + &quot;+&quot; + b + &quot;=&quot; + (a + b)); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; @HdRequestMapping(&quot;/remove&quot;) public void remove(HttpServletRequest req,HttpServletResponse resp, @HdRequestParam(&quot;id&quot;) Integer id)&#123; &#125;&#125; ä¸‰ï¼Œå®¹å™¨åˆå§‹åŒ–1.0ç‰ˆæœ¬æµç¨‹åˆ†æ1.é¦–å…ˆåœ¨doGetæ–¹æ³•é‡Œé¢è°ƒç”¨doDispatcheræ–¹æ³•ï¼Œæ ¹æ®è¯·æ±‚è·¯å¾„åˆ¤æ–­è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±è¿”å›404å­˜åœ¨å°±ä»å®¹å™¨ä¸­æ‹¿åˆ°è·¯å¾„å¯¹åº”çš„æ–¹æ³•ï¼Œé€šè¿‡åŠ¨æ€ä»£ç†æ‰§è¡Œå¯¹åº”çš„æ–¹æ³• 2.åœ¨ç±»åŠ è½½é˜¶æ®µï¼Œç”¨æµæ¥åŠ è½½é…ç½®æ–‡ä»¶ï¼Œä»é…ç½®æ–‡ä»¶è¯»å–é…ç½®çš„åŒ…æ‰«æè·¯å¾„æ ¹æ®åŒ…æ‰«æè·¯å¾„è¿›è¡Œè¿­ä»£éå†ï¼Œåˆ©ç”¨åå°„åˆ›å»ºæ‰€æœ‰ç±»ä¸Šæ ‡æœ‰controlleræ³¨è§£çš„ç±»åŠ å…¥åˆ°å®¹å™¨ï¼Œå¹¶ä¸‹é’»åˆ°ç±»ä¸­ï¼Œå°†ç±»ä¸­æ¯ä¸€ä¸ªæ–¹æ³•çš„ç»å¯¹è®¿é—®è·¯å¾„å’Œæ–¹æ³•åŠ å…¥åˆ°å®¹å™¨ï¼Œè¿­ä»£éå†åˆ›å»ºæ‰€æœ‰æ ‡æœ‰serviceæ³¨è§£çš„ç±»ï¼Œå¦‚æœè¯¥ç±»å®ç°äº†æ¥å£ï¼Œå°†è¯¥æ¥å£çš„å…¨é™å®šç±»å‹åå’Œç±»å®ä¾‹å¯¹è±¡ä¹Ÿæ”¾å…¥å®¹å™¨ï¼Œè¾¾åˆ°æ ¹æ®æ¥å£æ³¨å…¥çš„æ•ˆæœã€‚ 3.å±æ€§èµ‹å€¼ï¼Œéå†å®¹å™¨ä¸­æ‰€æœ‰ç±»ï¼Œå¦‚æœç±»ä¸­æ ‡æœ‰@autowriedæ³¨è§£ï¼Œå°†å±æ€§å¯¹åº”çš„å€¼è®¾ç½®è¿›å»ã€‚ é‡è¦æ–¹æ³•1.clazz.isAnnotationPresent(HdController.class)åˆ¤æ–­clazzä¸Šæœ‰æ²¡æœ‰HdControlleræ³¨è§£ 2.field.set(mappings.get(clazz.getName()), mappings.get(beanName));å±æ€§èµ‹å€¼ï¼šargs1ï¼šç»™å“ªä¸ªå±æ€§è®¾å€¼ï¼Œargs2ï¼šè®¾ç½®çš„ä»€ä¹ˆå€¼ 3.method.invoke(mappings.get(method.getDeclaringClass().getName()), new Object[]{req, resp, params.get(â€œnameâ€)[0]});é€šè¿‡åŠ¨æ€ä»£ç†æ‰§è¡Œæ–¹æ³•ï¼Œæ–¹æ³•æ‰€åœ¨ç±»åï¼Œæ–¹æ³•å‚æ•° ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139/** * @author yhd * @createtime 2021/1/31 15:49 * @description æ¨¡æ‹ŸIOCå®¹å™¨çš„åˆ›å»º */public class HdDispatcherServlet extends HttpServlet &#123; //æ˜ å°„å…³ç³» è®¿é—®è·¯å¾„-æ–¹æ³•å å…¨é™å®šç±»å-å®ä¾‹å¯¹è±¡ private Map&lt;String, Object&gt; mappings = new HashMap&lt;&gt;(); @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; this.doPost(req, resp); &#125; @SneakyThrows @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doDispatch(req, resp); &#125; private void doDispatch(HttpServletRequest req, HttpServletResponse resp) throws IOException, InvocationTargetException, IllegalAccessException &#123; //ç»„è£…è·¯å¾„ String url = req.getRequestURI(); String contextPath = req.getContextPath(); url = url.replace(contextPath, &quot;&quot;).replaceAll(&quot;/+&quot;, &quot;/&quot;); //åˆ¤æ–­è·¯å¾„æ˜¯å¦å­˜åœ¨ if (!this.mappings.containsKey(url)) &#123; resp.getWriter().write(&quot;404 NotFound!&quot;); return; &#125; //è·å–è·¯å¾„å¯¹åº”çš„æ–¹æ³•å‚æ•°ï¼Œé€šè¿‡åŠ¨æ€ä»£ç†è¿›è¡Œå¢å¼º Method method = (Method) this.mappings.get(url); Map&lt;String, String[]&gt; params = req.getParameterMap(); method.invoke(mappings.get(method.getDeclaringClass().getName()), new Object[]&#123;req, resp, params.get(&quot;name&quot;)[0]&#125;); &#125; @Override public void init(ServletConfig config) throws ServletException &#123; InputStream is = null; try &#123; //åŠ è½½é…ç½®æ–‡ä»¶ Properties configContext = new Properties(); is = this.getClass().getClassLoader().getResourceAsStream(config.getInitParameter(&quot;contextConfigLocation&quot;)); configContext.load(is); //è·å–æ‰«æè·¯å¾„ String scanPackage = configContext.getProperty(&quot;scanPackage&quot;); doScanner(scanPackage); for (String className : mappings.keySet()) &#123; if (!className.contains(&quot;.&quot;)) &#123; continue; &#125; Class&lt;?&gt; clazz = Class.forName(className); //å½“å‰è¿™ä¸ªç±»ä¸Šæœ‰æ²¡æœ‰controlleræ³¨è§£ if (clazz.isAnnotationPresent(HdController.class)) &#123; mappings.put(className, clazz.newInstance()); String baseUrl = &quot;&quot;; //åˆ¤æ–­æœ‰æ²¡æœ‰ä¸€çº§è®¿é—®è·¯å¾„ if (clazz.isAnnotationPresent(HdRequestMapping.class)) &#123; HdRequestMapping requestMapping = clazz.getAnnotation(HdRequestMapping.class); baseUrl = requestMapping.value(); &#125; Method[] methods = clazz.getMethods(); for (Method method : methods) &#123; if (!method.isAnnotationPresent(HdRequestMapping.class)) &#123; continue; &#125; HdRequestMapping requestMapping = method.getAnnotation(HdRequestMapping.class); //æ‹¼è£…è·¯å¾„ String url = (baseUrl + &quot;/&quot; + requestMapping.value()).replaceAll(&quot;/+&quot;, &quot;/&quot;); //mapæ”¾çš„æ˜¯ï¼šcontrolleré‡Œé¢ä¸€ä¸ªæ–¹æ³•çš„è®¿é—®ç»å¯¹è·¯å¾„ï¼Œè¿™ä¸ªå¯¹åº”çš„æ–¹æ³• mappings.put(url, method); System.out.println(&quot;Mapped &quot; + url + &quot;,&quot; + method); &#125; &#125; else if (clazz.isAnnotationPresent(HdService.class)) &#123; HdService service = clazz.getAnnotation(HdService.class); String beanName = service.value(); if (&quot;&quot;.equals(beanName)) &#123; beanName = clazz.getName(); &#125; Object instance = clazz.newInstance(); //mapé‡Œé¢æ”¾çš„æ˜¯ç±»åå’Œå®ä¾‹å¯¹è±¡ mappings.put(beanName, instance); //å°†è¿™ä¸ªç±»å®ç°çš„æ¥å£å’Œå®ä¾‹å¯¹è±¡æ”¾è¿›å» for (Class&lt;?&gt; i : clazz.getInterfaces()) &#123; mappings.put(i.getName(), instance); &#125; &#125; else &#123; continue; &#125; &#125; //å±æ€§æ³¨å…¥ for (Object object : mappings.values()) &#123; if (object == null) &#123; continue; &#125; Class clazz = object.getClass(); if (clazz.isAnnotationPresent(HdController.class)) &#123; Field[] fields = clazz.getDeclaredFields(); for (Field field : fields) &#123; if (!field.isAnnotationPresent(HdAutowired.class)) &#123; continue; &#125; HdAutowired autowired = field.getAnnotation(HdAutowired.class); String beanName = autowired.value(); if (&quot;&quot;.equals(beanName)) &#123; beanName = field.getType().getName(); &#125; field.setAccessible(true); try &#123; field.set(mappings.get(clazz.getName()), mappings.get(beanName)); &#125; catch (IllegalAccessException e) &#123; e.printStackTrace(); &#125; &#125; &#125; &#125; System.out.print(&quot;Diy MVC Framework is init&quot;); &#125; catch (Exception e) &#123; &#125; &#125; private void doScanner(String scanPackage) &#123; URL url = this.getClass().getClassLoader().getResource(&quot;/&quot; + scanPackage.replaceAll(&quot;\\\\.&quot;, &quot;/&quot;)); File classDir = new File(url.getFile()); Arrays.stream(classDir.listFiles()).forEach(file -&gt; &#123; if (file.isDirectory()) &#123; doScanner(scanPackage + &quot;.&quot; + file.getName()); &#125; else &#123; if (!file.getName().endsWith(&quot;.class&quot;)) &#123; return; &#125; String clazzName = (scanPackage + &quot;.&quot; + file.getName().replace(&quot;.class&quot;, &quot;&quot;)); mappings.put(clazzName, null); &#125; &#125;); &#125;&#125; 2.0ç‰ˆæœ¬åˆ†æ1.0ç‰ˆæœ¬çš„æ‰€æœ‰ä»£ç éƒ½å†™åœ¨äº†ä¸€ä¸ªæ–¹æ³•é‡Œé¢ï¼Œä»£ç è€¦åˆåº¦ ååˆ†é«˜ï¼Œä¸ç¬¦åˆå¼€å‘è§„èŒƒ æ€è·¯é‡‡ç”¨è®¾è®¡æ¨¡å¼ï¼ˆå·¥å‚æ¨¡å¼ã€å•ä¾‹æ¨¡å¼ã€å§”æ´¾æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ï¼‰ï¼Œæ”¹é€ ä¸šåŠ¡é€»è¾‘ã€‚ ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202/** * @author yhd * @createtime 2021/2/1 11:29 */public class HdDispatcherServlet2 extends HttpServlet &#123; private Map&lt;String, Object&gt; ioc = new ConcurrentHashMap&lt;&gt;(); private Map&lt;String, Method&gt; handlerMappings = new ConcurrentHashMap&lt;&gt;(); private List&lt;String&gt; classNames = new CopyOnWriteArrayList&lt;&gt;(); private Properties configContext = new Properties(); private static final String CONFIG_LOCATION = &quot;contextConfigLocation&quot;; @Override public void init(ServletConfig config) throws ServletException &#123; //1.åŠ è½½é…ç½®æ–‡ä»¶ loadConfig(config.getInitParameter(CONFIG_LOCATION)); //2.æ‰«ææ‰€æœ‰çš„ç»„ä»¶ doScanPackages(configContext.getProperty(&quot;scanPackage&quot;)); //3.å°†ç»„ä»¶åŠ å…¥åˆ°å®¹å™¨ refersh(); //4.å±æ€§è®¾å€¼ population(); //5.å»ºç«‹æ–¹æ³•ä¸è·¯å¾„çš„æ˜ å°„ routingAndMapping(); &#125; /** * å»ºç«‹æ–¹æ³•ä¸è·¯å¾„çš„æ˜ å°„ */ private void routingAndMapping() &#123; classNames.forEach(className -&gt; &#123; Object instance = ioc.get(className); if (instance.getClass().isAnnotationPresent(HdController.class)) &#123; String baseUrl = &quot;&quot;; if (instance.getClass().isAnnotationPresent(HdRequestMapping.class)) &#123; baseUrl += instance.getClass().getAnnotation(HdRequestMapping.class).value().trim(); &#125; String finalBaseUrl = baseUrl; Arrays.asList(instance.getClass().getDeclaredMethods()).forEach(method -&gt; &#123; if (method.isAnnotationPresent(HdRequestMapping.class)) &#123; String methodUrl = finalBaseUrl; methodUrl += method.getAnnotation(HdRequestMapping.class).value().trim(); handlerMappings.put(methodUrl, method); &#125; &#125;); &#125; &#125;); &#125; /** * å±æ€§è®¾å€¼ */ private void population() &#123; Set&lt;String&gt; keySet = ioc.keySet(); keySet.forEach(key -&gt; &#123; Field[] fields = ioc.get(key).getClass().getFields(); Arrays.asList(fields).forEach(field -&gt; &#123; if (field.isAnnotationPresent(HdAutowired.class)) &#123; HdAutowired autowired = field.getAnnotation(HdAutowired.class); String name = autowired.value().trim(); if (&quot;&quot;.equals(autowired.value().trim())) &#123; name = field.getType().getName(); &#125; try &#123; field.setAccessible(true); field.set(name, ioc.get(name)); &#125; catch (IllegalAccessException e) &#123; &#125; &#125; &#125;); &#125;); &#125; /** * å®¹å™¨åˆ·æ–° * ç»„ä»¶åŠ å…¥åˆ°å®¹å™¨ä¸­ */ @SneakyThrows private void refersh() &#123; if (classNames == null || classNames.isEmpty()) &#123; throw new RuntimeException(&quot;ç»„ä»¶æ‰«æå‡ºç°å¼‚å¸¸ï¼&quot;); &#125; for (String className : classNames) &#123; Class&lt;?&gt; clazz = Class.forName(className); if (clazz.isAnnotationPresent(HdController.class)) &#123; //TODO ç±»åå¤„ç† ioc.put(clazz.getSimpleName(), clazz.newInstance()); &#125; else if (clazz.isAnnotationPresent(HdService.class)) &#123; Object instance = clazz.newInstance(); ioc.put(clazz.getSimpleName(), instance); Class&lt;?&gt;[] interfaces = clazz.getInterfaces(); for (Class&lt;?&gt; inter : interfaces) &#123; ioc.put(inter.getSimpleName(), clazz); &#125; &#125; else &#123; continue; &#125; &#125; &#125; /** * ç»„ä»¶æ‰«æ * * @param scanPackage */ private void doScanPackages(String scanPackage) &#123; URL url = getClass().getClassLoader().getResource(&quot;/&quot; + scanPackage.replaceAll(&quot;\\\\.&quot;, &quot;/&quot;)); File files = new File(url.getFile()); for (File file : files.listFiles()) &#123; if (file.isDirectory()) &#123; doScanPackages(scanPackage + &quot;.&quot; + file.getName()); &#125; else &#123; if (!file.getName().endsWith(&quot;.class&quot;)) &#123; continue; &#125; String className = scanPackage + &quot;.&quot; + file.getName().replace(&quot;.class&quot;, &quot;&quot;); classNames.add(className); &#125; &#125; &#125; /** * åŠ è½½é…ç½®æ–‡ä»¶ * * @param initParameter */ @SneakyThrows private void loadConfig(String initParameter) &#123; InputStream is = getClass().getClassLoader().getResourceAsStream(initParameter); configContext.load(is); &#125; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doPost(req, resp); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; try &#123; doDispatcher(req, resp); &#125; catch (Exception e) &#123; throw new RuntimeException(&quot; 500 server error!&quot;); &#125; &#125; @SneakyThrows private void doDispatcher(HttpServletRequest req, HttpServletResponse resp) &#123; String realPath = req.getRequestURI().replace(req.getContextPath(), &quot;&quot;); Map&lt;String, String[]&gt; parameterMap = req.getParameterMap(); if (!handlerMappings.containsKey(realPath)) &#123; throw new RuntimeException(&quot;404 Not Found!&quot;); &#125; Method method = handlerMappings.get(realPath); Class&lt;?&gt;[] parameterTypes = method.getParameterTypes(); Object[] paramValues = new Object[parameterTypes.length]; for (int i = 0; i &lt; parameterTypes.length - 1; i++) &#123; Class param = parameterTypes[i]; if (param == HttpServletRequest.class) &#123; paramValues[i] = req; &#125; if (param == HttpServletResponse.class) &#123; paramValues[i] = resp; &#125; if (param == String.class) &#123; HdRequestParam requestParam = parameterTypes[i].getAnnotation(HdRequestParam.class); String value = requestParam.value(); String[] realParam = parameterMap.get(value); paramValues[i] = Arrays.toString(realParam) .replaceAll(&quot;\\\\[|\\\\]&quot;, &quot;&quot;) .replaceAll(&quot;\\\\s&quot;, &quot;,&quot;); &#125; &#125; method.invoke(method.getDeclaringClass().getSimpleName(), paramValues); &#125; private Object convertParamType() &#123; return null; &#125;&#125; 3.0ç‰ˆæœ¬åˆ†æHandlerMappingè¿˜ä¸èƒ½åƒSpringMVCä¸€æ ·æ”¯æŒæ­£åˆ™ï¼Œurlå‚æ•°è¿˜ä¸æ”¯æŒå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œåå°„è°ƒç”¨ä¹‹å‰è¿˜éœ€è¦é‡æ–°è·å–beançš„nameã€‚ æ”¹é€  HandlerMappingï¼Œåœ¨çœŸå®çš„ Spring æºç ä¸­ï¼ŒHandlerMapping å…¶å®æ˜¯ä¸€ä¸ª List è€Œé Mapã€‚List ä¸­çš„å…ƒç´ æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ç±»å‹ã€‚ æ€è·¯ä½¿ç”¨å†…éƒ¨ç±»ç»´æŠ¤requestMappingå’Œurlä¹‹é—´çš„å…³ç³»ã€‚ ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282public class HdDispatcherServlet3 extends HttpServlet &#123; private Map&lt;String, Object&gt; ioc = new ConcurrentHashMap&lt;&gt;(); private Map&lt;String, Method&gt; handlerMappings = new ConcurrentHashMap&lt;&gt;(); private List&lt;String&gt; classNames = new CopyOnWriteArrayList&lt;&gt;(); private Properties configContext = new Properties(); private static final String CONFIG_LOCATION = &quot;contextConfigLocation&quot;; private List&lt;Handler&gt; handlerMapping = new ArrayList&lt;&gt;(); /** * */ @Data private class Handler &#123; //ä¿å­˜æ–¹æ³•å¯¹åº”çš„å®ä¾‹ private Object controller; //ä¿å­˜æ˜ å°„çš„æ–¹æ³• private Method method; //æ­£åˆ™åŒ¹é… private Pattern pattern; //å‚æ•°é¡ºåº private Map&lt;String, Integer&gt; paramIndexMapping = new ConcurrentHashMap&lt;&gt;(); public Handler(Pattern pattern, Object controller, Method method) &#123; this.controller = controller; this.method = method; this.pattern = pattern; paramIndexMapping = new HashMap&lt;String, Integer&gt;(); putParamIndexMapping(method); &#125; private void putParamIndexMapping(Method method) &#123; //æå–æ–¹æ³•ä¸­åŠ äº†æ³¨è§£çš„å‚æ•° Annotation[][] pa = method.getParameterAnnotations(); for (int i = 0; i &lt; pa.length; i++) &#123; for (Annotation a : pa[i]) &#123; if (a instanceof HdRequestParam) &#123; String paramName = ((HdRequestParam) a).value(); if (!&quot;&quot;.equals(paramName.trim())) &#123; paramIndexMapping.put(paramName, i); &#125; &#125; &#125; &#125; //æå–æ–¹æ³•ä¸­çš„reqå’Œresp Class&lt;?&gt;[] parameterTypes = method.getParameterTypes(); for (int i = 0; i &lt; parameterTypes.length; i++) &#123; Class&lt;?&gt; type = parameterTypes[i]; if (type == HttpServletRequest.class || type == HttpServletResponse.class) &#123; paramIndexMapping.put(type.getName(), i); &#125; &#125; &#125; &#125; @Override public void init(ServletConfig config) throws ServletException &#123; //1.åŠ è½½é…ç½®æ–‡ä»¶ loadConfig(config.getInitParameter(CONFIG_LOCATION)); //2.æ‰«ææ‰€æœ‰çš„ç»„ä»¶ doScanPackages(configContext.getProperty(&quot;scanPackage&quot;)); //3.å°†ç»„ä»¶åŠ å…¥åˆ°å®¹å™¨ refersh(); //4.å±æ€§è®¾å€¼ population(); //5.å»ºç«‹æ–¹æ³•ä¸è·¯å¾„çš„æ˜ å°„ routingAndMapping(); &#125; /** * å»ºç«‹æ–¹æ³•ä¸è·¯å¾„çš„æ˜ å°„ */ private void routingAndMapping() &#123; if (ioc.isEmpty()) &#123; return; &#125; for (Map.Entry&lt;String, Object&gt; entry : ioc.entrySet()) &#123; Class&lt;?&gt; clazz = entry.getValue().getClass(); if (!clazz.isAnnotationPresent(HdController.class)) &#123; continue; &#125; String url = &quot;&quot;; if (clazz.isAnnotationPresent(HdRequestMapping.class)) &#123; HdRequestMapping requestMapping = clazz.getAnnotation(HdRequestMapping.class); url = requestMapping.value(); &#125; for (Method method : clazz.getMethods()) &#123; if (!method.isAnnotationPresent(HdRequestMapping.class)) &#123; continue; &#125; HdRequestMapping requestMapping = method.getAnnotation(HdRequestMapping.class); String regex = (&quot;/&quot; + url + requestMapping.value()).replaceAll(&quot;/+&quot;, &quot;/&quot;); Pattern pattern = Pattern.compile(regex); handlerMapping.add(new Handler(pattern, entry.getValue(), method)); &#125; &#125; &#125; /** * å±æ€§è®¾å€¼ */ private void population() &#123; Set&lt;String&gt; keySet = ioc.keySet(); keySet.forEach(key -&gt; &#123; Field[] fields = ioc.get(key).getClass().getFields(); Arrays.asList(fields).forEach(field -&gt; &#123; if (field.isAnnotationPresent(HdAutowired.class)) &#123; HdAutowired autowired = field.getAnnotation(HdAutowired.class); String name = autowired.value().trim(); if (&quot;&quot;.equals(autowired.value().trim())) &#123; name = field.getType().getName(); &#125; try &#123; field.setAccessible(true); field.set(name, ioc.get(name)); &#125; catch (IllegalAccessException e) &#123; &#125; &#125; &#125;); &#125;); &#125; /** * å®¹å™¨åˆ·æ–° * ç»„ä»¶åŠ å…¥åˆ°å®¹å™¨ä¸­ */ @SneakyThrows private void refersh() &#123; if (classNames == null || classNames.isEmpty()) &#123; throw new RuntimeException(&quot;ç»„ä»¶æ‰«æå‡ºç°å¼‚å¸¸ï¼&quot;); &#125; for (String className : classNames) &#123; Class&lt;?&gt; clazz = Class.forName(className); if (clazz.isAnnotationPresent(HdController.class)) &#123; //TODO ç±»åå¤„ç† ioc.put(clazz.getSimpleName(), clazz.newInstance()); &#125; else if (clazz.isAnnotationPresent(HdService.class)) &#123; Object instance = clazz.newInstance(); ioc.put(clazz.getSimpleName(), instance); Class&lt;?&gt;[] interfaces = clazz.getInterfaces(); for (Class&lt;?&gt; inter : interfaces) &#123; ioc.put(inter.getSimpleName(), clazz); &#125; &#125; else &#123; continue; &#125; &#125; &#125; /** * ç»„ä»¶æ‰«æ * * @param scanPackage */ private void doScanPackages(String scanPackage) &#123; URL url = getClass().getClassLoader().getResource(&quot;/&quot; + scanPackage.replaceAll(&quot;\\\\.&quot;, &quot;/&quot;)); File files = new File(url.getFile()); for (File file : files.listFiles()) &#123; if (file.isDirectory()) &#123; doScanPackages(scanPackage + &quot;.&quot; + file.getName()); &#125; else &#123; if (!file.getName().endsWith(&quot;.class&quot;)) &#123; continue; &#125; String className = scanPackage + &quot;.&quot; + file.getName().replace(&quot;.class&quot;, &quot;&quot;); classNames.add(className); &#125; &#125; &#125; /** * åŠ è½½é…ç½®æ–‡ä»¶ * * @param initParameter */ @SneakyThrows private void loadConfig(String initParameter) &#123; InputStream is = getClass().getClassLoader().getResourceAsStream(initParameter); configContext.load(is); &#125; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doPost(req, resp); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; try &#123; doDispatcher(req, resp); &#125; catch (Exception e) &#123; throw new RuntimeException(&quot; 500 server error!&quot;); &#125; &#125; @SneakyThrows private void doDispatcher(HttpServletRequest req, HttpServletResponse resp) &#123; Handler handler = getHandler(req); if (handler == null) &#123; throw new RuntimeException(&quot;404 Not Found!&quot;); &#125; Class&lt;?&gt;[] parameterTypes = handler.getMethod().getParameterTypes(); Object[] paramValues = new Object[parameterTypes.length]; Map&lt;String, String[]&gt; params = req.getParameterMap(); for (Map.Entry&lt;String, String[]&gt; param : params.entrySet()) &#123; String value = Arrays.toString(param.getValue()).replaceAll(&quot;\\\\[|\\\\]&quot;, &quot;&quot;) .replaceAll(&quot;\\\\s&quot;, &quot;,&quot;); if (!handler.getParamIndexMapping().containsKey(param.getKey())) &#123; continue; &#125; Integer index = handler.getParamIndexMapping().get(param.getKey()); paramValues[index] = this.convert(parameterTypes[index], value); &#125; if (handler.paramIndexMapping.containsKey(HttpServletRequest.class.getName())) &#123; int reqIndex = handler.paramIndexMapping.get(HttpServletRequest.class.getName()); paramValues[reqIndex] = req; &#125; if (handler.paramIndexMapping.containsKey(HttpServletResponse.class.getName())) &#123; int respIndex = handler.paramIndexMapping.get(HttpServletResponse.class.getName()); paramValues[respIndex] = resp; &#125; Object returnValue = handler.getMethod().invoke(handler.getController(), paramValues); if (returnValue == null || returnValue instanceof Void) &#123; return; &#125; resp.getWriter().write(returnValue.toString()); &#125; private Object convert(Class&lt;?&gt; parameterType, String value) &#123; if (Integer.class == parameterType) &#123; return Integer.parseInt(value); &#125; return value; &#125; private Handler getHandler(HttpServletRequest req) &#123; if (handlerMapping.isEmpty()) &#123; return null; &#125; String url = req.getRequestURI(); String contextPath = req.getContextPath(); url = url.replace(contextPath, &quot;&quot;) .replaceAll(&quot;/+&quot;, &quot;/&quot;); for (Handler handler : handlerMapping) &#123; try &#123; Matcher matcher = handler.pattern.matcher(url); //å¦‚æœæ²¡æœ‰åŒ¹é…ä¸Šç»§ç»­ä¸‹ä¸€ä¸ªåŒ¹é… if (!matcher.matches()) &#123; continue; &#125; return handler; &#125; catch (Exception e) &#123; throw e; &#125; &#125; return null; &#125;&#125;","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[æ‰©å±•]MVCä½¿ç”¨ç¯‡","slug":"Spring/Spring[æ‰©å±•]MVCä½¿ç”¨ç¯‡","date":"2022-01-11T06:11:34.427Z","updated":"2022-01-11T06:20:52.215Z","comments":true,"path":"2022/01/11/Spring/Spring[æ‰©å±•]MVCä½¿ç”¨ç¯‡/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E6%89%A9%E5%B1%95]MVC%E4%BD%BF%E7%94%A8%E7%AF%87/","excerpt":"","text":"ä¸€ï¼ŒspringmvcåŸºæœ¬æ¦‚å¿µ1.ä¸‰å±‚æ¶æ„å¼€å‘æ¶æ„ä¸€èˆ¬åŸºäºä¸¤ç§å½¢å¼ï¼Œä¸€ç§æ˜¯c/sæ¶æ„ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯æœåŠ¡å™¨ï¼Œå¦ä¸€ç§æ˜¯b/sæ¶æ„ï¼Œä¹Ÿå°±æ˜¯æµè§ˆå™¨æœåŠ¡å™¨ã€‚javaeeçš„å¼€å‘åŸºæœ¬éƒ½æ˜¯b/sæ¶æ„ã€‚åœ¨b/sæ¶æ„ä¸­ï¼Œç³»ç»Ÿè¡¨è½¬çš„ä¸‰å±‚æ¶æ„åŒ…æ‹¬ï¼šè¡¨ç°å±‚ï¼Œä¸šåŠ¡å±‚ï¼ŒæŒä¹…å±‚ã€‚ è¡¨ç°å±‚ï¼šwebå±‚ã€‚è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå‘å®¢æˆ·ç«¯å“åº”ç»“æœã€‚ä¾èµ–äºä¸šåŠ¡å±‚ï¼Œæ¥å—è¯·æ±‚è°ƒç”¨ä¸šåŠ¡å±‚è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œå¹¶å°†å¤„ç†ç»“æœå“åº”å›å®¢æˆ·ç«¯ã€‚ å±•ç¤ºå±‚ï¼šå±•ç¤ºç»“æœã€‚ æ§åˆ¶å±‚ï¼šæ¥å—è¯·æ±‚ è¡¨ç°å±‚çš„è®¾è®¡ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨MVCè®¾è®¡æ¨¡å¼ã€‚ ä¸šåŠ¡å±‚ï¼šserviceå±‚ã€‚è´Ÿè´£ä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚ ä¸šåŠ¡å±‚å¯èƒ½ä¼šä¾èµ–äºæŒä¹…å±‚ï¼Œå¦‚æœéœ€è¦å¯¹æ•°æ®æŒä¹…åŒ–ï¼Œéœ€è¦ä¿è¯äº‹ç‰©çš„ä¸€è‡´æ€§ã€‚ æŒä¹…å±‚ï¼šdaoå±‚ã€‚è´Ÿè´£æ•°æ®æŒä¹…åŒ–ã€‚ æ•°æ®åº“ï¼šå¯¹æ•°æ®è¿›è¡ŒæŒä¹…åŒ–çš„è½½ä½“ã€‚ æ•°æ®è®¿é—®å±‚ï¼šä¸šåŠ¡å±‚å’ŒæŒä¹…å±‚äº¤äº’çš„æ¥å£ æŒä¹…å±‚å°±æ˜¯å’Œæ•°æ®åº“äº¤äº’ï¼Œå¯¹æ•°æ®åº“è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚ 2.MVCæ¨¡å‹MVC å…¨åæ˜¯ Model View Controllerï¼Œæ˜¯æ¨¡å‹(model)ï¼è§†å›¾(view)ï¼æ§åˆ¶å™¨(controller)çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§ç”¨äºè®¾è®¡åˆ›å»º Web åº”ç”¨ç¨‹åºè¡¨ç°å±‚çš„æ¨¡å¼ã€‚MVC ä¸­æ¯ä¸ªéƒ¨åˆ†å„å¸å…¶èŒï¼š Modelï¼ˆæ¨¡å‹ï¼‰ï¼šé€šå¸¸æŒ‡çš„å°±æ˜¯æˆ‘ä»¬çš„æ•°æ®æ¨¡å‹ã€‚ä½œç”¨ä¸€èˆ¬æƒ…å†µä¸‹ç”¨äºå°è£…æ•°æ®ã€‚ Viewï¼ˆè§†å›¾ï¼‰ï¼šé€šå¸¸æŒ‡çš„å°±æ˜¯æˆ‘ä»¬çš„ jsp æˆ–è€… htmlã€‚ä½œç”¨ä¸€èˆ¬å°±æ˜¯å±•ç¤ºæ•°æ®çš„ã€‚é€šå¸¸è§†å›¾æ˜¯ä¾æ®æ¨¡å‹æ•°æ®åˆ›å»ºçš„ã€‚ Controllerï¼ˆæ§åˆ¶å™¨ï¼‰ï¼šæ˜¯åº”ç”¨ç¨‹åºä¸­å¤„ç†ç”¨æˆ·äº¤äº’çš„éƒ¨åˆ†ã€‚ä½œç”¨ä¸€èˆ¬å°±æ˜¯å¤„ç†ç¨‹åºé€»è¾‘çš„ã€‚ 3.springmvcæ˜¯ä»€ä¹ˆSpringMVC æ˜¯ä¸€ç§åŸºäº Java çš„å®ç° MVC è®¾è®¡æ¨¡å‹çš„è¯·æ±‚é©±åŠ¨ç±»å‹çš„è½»é‡çº§ Web æ¡†æ¶ï¼Œå±äº SpringFrameWork çš„åç»­äº§å“ï¼Œå·²ç»èåˆåœ¨ Spring Web Flow é‡Œé¢ã€‚Spring æ¡†æ¶æä¾›äº†æ„å»º Web åº”ç”¨ç¨‹åºçš„å…¨åŠŸèƒ½ MVC æ¨¡å—ã€‚ä½¿ç”¨ Spring å¯æ’å…¥çš„ MVC æ¶æ„ï¼Œä»è€Œåœ¨ä½¿ç”¨ Spring è¿›è¡Œ WEB å¼€å‘æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ Springçš„ Spring MVC æ¡†æ¶æˆ–é›†æˆå…¶ä»– MVC å¼€å‘æ¡†æ¶ï¼Œå¦‚ Struts1(ç°åœ¨ä¸€èˆ¬ä¸ç”¨)ï¼ŒStruts2 ç­‰ã€‚â€‹ SpringMVC å·²ç»æˆä¸ºç›®å‰æœ€ä¸»æµçš„ MVC æ¡†æ¶ä¹‹ä¸€ï¼Œå¹¶ä¸”éšç€ Spring3.0 çš„å‘å¸ƒï¼Œå…¨é¢è¶…è¶Š Struts2ï¼Œæˆä¸ºæœ€ä¼˜ç§€çš„ MVC æ¡†æ¶ã€‚â€‹ å®ƒé€šè¿‡ä¸€å¥—æ³¨è§£ï¼Œè®©ä¸€ä¸ªç®€å•çš„ Java ç±»æˆä¸ºå¤„ç†è¯·æ±‚çš„æ§åˆ¶å™¨ï¼Œè€Œæ— é¡»å®ç°ä»»ä½•æ¥å£ã€‚åŒæ—¶å®ƒè¿˜æ”¯æŒRESTful ç¼–ç¨‹é£æ ¼çš„è¯·æ±‚ã€‚ 4.springmvcå’Œstruts2çš„ä¼˜åŠ£å¯¹æ¯”å…±åŒç‚¹ï¼š å®ƒä»¬éƒ½æ˜¯è¡¨ç°å±‚æ¡†æ¶ï¼Œéƒ½æ˜¯åŸºäº MVC æ¨¡å‹ç¼–å†™çš„ã€‚ å®ƒä»¬çš„åº•å±‚éƒ½ç¦»ä¸å¼€åŸå§‹ ServletAPIã€‚ å®ƒä»¬å¤„ç†è¯·æ±‚çš„æœºåˆ¶éƒ½æ˜¯ä¸€ä¸ªæ ¸å¿ƒæ§åˆ¶å™¨ã€‚ åŒºåˆ«ï¼š Spring MVC çš„å…¥å£æ˜¯ Servlet, è€Œ Struts2 æ˜¯ Filter Spring MVC æ˜¯åŸºäºæ–¹æ³•è®¾è®¡çš„ï¼Œè€Œ Struts2 æ˜¯åŸºäºç±»ï¼ŒStruts2 æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªåŠ¨ä½œç±»ã€‚æ‰€ ä»¥ Spring MVC ä¼šç¨å¾®æ¯” Struts2 å¿«äº›ã€‚ Spring MVC ä½¿ç”¨æ›´åŠ ç®€æ´,åŒæ—¶è¿˜æ”¯æŒ JSR303, å¤„ç† ajax çš„è¯·æ±‚æ›´æ–¹ä¾¿ (JSR303 æ˜¯ä¸€å¥— JavaBean å‚æ•°æ ¡éªŒçš„æ ‡å‡†ï¼Œå®ƒå®šä¹‰äº†å¾ˆå¤šå¸¸ç”¨çš„æ ¡éªŒæ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†è¿™äº›æ³¨è§£åŠ åœ¨æˆ‘ä»¬ JavaBean çš„å±æ€§ä¸Šé¢ï¼Œå°±å¯ä»¥åœ¨éœ€è¦æ ¡éªŒçš„æ—¶å€™è¿›è¡Œæ ¡éªŒäº†ã€‚) Struts2 çš„ OGNL è¡¨è¾¾å¼ä½¿é¡µé¢çš„å¼€å‘æ•ˆç‡ç›¸æ¯” Spring MVC æ›´é«˜äº›ï¼Œä½†æ‰§è¡Œæ•ˆç‡å¹¶æ²¡æœ‰æ¯” JSTL æ å‡ï¼Œå°¤å…¶æ˜¯ struts2 çš„è¡¨å•æ ‡ç­¾ï¼Œè¿œæ²¡æœ‰ html æ‰§è¡Œæ•ˆç‡é«˜ã€‚ äºŒï¼ŒSpringmvcå…¥é—¨1.å…¥é—¨æ¡ˆä¾‹éœ€æ±‚ï¼šç‚¹å‡»é¡µé¢è¶…é“¾æ¥ï¼Œè·³è½¬åˆ°æˆåŠŸé¡µé¢ 1&lt;a href=&quot;success/success&quot;&gt;testSuccess&lt;/a&gt;&lt;br/&gt; 12345678910111213@Controller@RequestMapping(&quot;/success&quot;)public class success &#123; /** * å…¥é—¨æ¡ˆä¾‹ * @return */ @RequestMapping(&quot;/success&quot;) public String testSuccess()&#123; System.out.println(&quot;testSuccess()...&quot;); return &quot;success&quot;; &#125; &#125; web.xmlé…ç½®æ ¸å¿ƒæ§åˆ¶å™¨ï¼šä¸€ä¸ªServlet 12345678910111213141516&lt;!-- é…ç½® DispatcherServlet --&gt; &lt;servlet&gt; &lt;servlet-name&gt;springDispatcherServlet&lt;/servlet-name&gt; &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt; &lt;init-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;classpath:springmvc.xml&lt;/param-value&gt; &lt;/init-param&gt; &lt;load-on-startup&gt;1&lt;/load-on-startup&gt; &lt;/servlet&gt; &lt;!-- æ˜ å°„åœ°å€ --&gt; &lt;servlet-mapping&gt; &lt;servlet-name&gt;springDispatcherServlet&lt;/servlet-name&gt; &lt;url-pattern&gt;/&lt;/url-pattern&gt; &lt;/servlet-mapping&gt; springmvc.xml1234567891011121314151617181920212223&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot; http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt; &lt;!--ç»„ä»¶æ‰«æ--&gt; &lt;context:component-scan base-package=&quot;com.atguigu&quot;&gt;&lt;/context:component-scan&gt; &lt;!--é…ç½®è§†å›¾è§£æå™¨--&gt; &lt;bean id=&quot;internalResourceViewResolver&quot; class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt; &lt;!--å‰ç¼€è§£æå™¨--&gt; &lt;property name=&quot;prefix&quot; value=&quot;/WEB-INF/views/&quot;&gt;&lt;/property&gt; &lt;!--åç¼€è§£æå™¨--&gt; &lt;property name=&quot;suffix&quot; value=&quot;.jsp&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;!--å¼€å¯æ³¨è§£æ”¯æŒ--&gt; &lt;mvc:annotation-driven /&gt; &lt;/beans&gt; 2.å…¥é—¨æ¡ˆä¾‹æµç¨‹åˆ†æ æœåŠ¡å™¨å¯åŠ¨ï¼ŒåŠ è½½åº”ç”¨ã€‚è¯»å–web.xmlä¸­çš„é…ç½®åˆ›å»ºspringå®¹å™¨å¹¶ä¸”åˆå§‹åŒ–å®¹å™¨ä¸­çš„å¯¹è±¡ã€‚ä»æ¡ˆä¾‹ä¸­å¯ä»¥å‘ç°åˆ›å»ºçš„æ˜¯successControllerå’ŒInternalResourceViewResolverï¼Œå®é™…ä¸Šè¿œä¸æ­¢è¿™äº›ã€‚ æµè§ˆå™¨å‘é€è¯·æ±‚ï¼Œç»è¿‡å‰ç«¯æ§åˆ¶å™¨ï¼Œè¢«å…¶æ•è·ï¼Œä»–å¹¶ä¸å¤„ç†è¯·æ±‚ï¼Œåªæ˜¯æ ¹æ®è·¯å¾„çš„URLåŒ¹é…æœ‰æ²¡æœ‰å¯¹åº”çš„ï¼Œå¦‚æœåŒ¹é…åˆ°@RequestMappingä¸­çš„å†…å®¹ï¼Œå°±è½¬å‘ã€‚ è½¬å‘åˆ°æ§åˆ¶å±‚æ‰§è¡Œå¯¹åº”çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ‰ä¸€ä¸ªè¿”å›å€¼ã€‚ æ ¹æ®æ–¹æ³•çš„è¿”å›å€¼ï¼Œå€ŸåŠ©è§†å›¾è§£æå™¨å¯¹è±¡æ‰¾åˆ°å¯¹åº”çš„è§†å›¾ç»“æœã€‚ æ¸²æŸ“ç»“æœè§†å›¾ï¼Œå“åº”æµè§ˆå™¨ 3.è¯·æ±‚å“åº”æµç¨‹ 1234567891011è¯·æ±‚ç›¸åº”æµç¨‹ï¼š è¯·æ±‚å…ˆæ¥åˆ°springDispatcherServletçœ‹Springmvcæ˜¯å¦å­˜åœ¨å¯¹åº”çš„æ˜ å°„ï¼Ÿ å¦‚æœä¸å­˜åœ¨ï¼Œçœ‹springmvcçš„é…ç½®æ–‡ä»¶æ˜¯å¦é…ç½®äº†&lt;mvc:default-servlet-handler/&gt; å¦‚æœä¸å­˜åœ¨ï¼Œé¡µé¢å“åº”404ï¼Œæ§åˆ¶å°æ‰“å°no mapping found å¦‚æœå­˜åœ¨ï¼Œè½¬å‘åˆ°ç›®æ ‡èµ„æºã€‚ å¦‚æœå­˜åœ¨ï¼Œè¯·æ±‚äº¤ç»™handlerMappingï¼ˆå¤„ç†å™¨æ˜ å°„å™¨ï¼‰ï¼Œç”±å®ƒè·å–HandlerExecutionChainå¯¹è±¡ï¼Œ å†äº¤ç»™HandlerAdapterï¼ˆå¤„ç†å™¨é€‚é…å™¨ï¼‰å¯¹è±¡ï¼Œè°ƒç”¨æ‹¦æˆªå™¨çš„PreHandleæ–¹æ³•ï¼Œ ç„¶åè°ƒç”¨ç›®æ ‡Handleræ–¹æ³•å¾—åˆ°ModelAndviewå¯¹è±¡ï¼Œè°ƒç”¨æ‹¦æˆªå™¨çš„PostHnadleæ–¹æ³•ï¼Œ æŸ¥çœ‹æ˜¯å¦å­˜åœ¨å¼‚å¸¸ å¦‚æœå­˜åœ¨ï¼Œç”±å¼‚å¸¸å¤„ç†å™¨å¤„ç†å¼‚å¸¸ï¼Œå¾—åˆ°æ–°çš„ModelAndViewå¯¹è±¡ï¼Œ å¦‚æœä¸å­˜åœ¨å¼‚å¸¸ï¼Œç”±è§†å›¾è§£æå™¨è§£æè§†å›¾ï¼Œå¾—åˆ°å®é™…çš„Viewï¼Œæ¸²æŸ“è§†å›¾ï¼Œè°ƒç”¨æ‹¦æˆªå™¨çš„afterCompletionæ–¹æ³• 4.æ¡ˆä¾‹ä¸­æ¶‰åŠçš„ç»„ä»¶ DispatcherServletï¼šå‰ç«¯æ§åˆ¶å™¨:ç”¨æˆ·è¯·æ±‚åˆ°è¾¾å‰ç«¯æ§åˆ¶å™¨ï¼Œå®ƒå°±ç›¸å½“äº mvc æ¨¡å¼ä¸­çš„ cï¼ŒdispatcherServlet æ˜¯æ•´ä¸ªæµç¨‹æ§åˆ¶çš„ä¸­å¿ƒï¼Œç”±å®ƒè°ƒç”¨å…¶å®ƒç»„ä»¶å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼ŒdispatcherServlet çš„å­˜åœ¨é™ä½äº†ç»„ä»¶ä¹‹é—´çš„è€¦åˆæ€§ HandlerMappingï¼šå¤„ç†å™¨æ˜ å°„å™¨:HandlerMapping è´Ÿè´£æ ¹æ®ç”¨æˆ·è¯·æ±‚æ‰¾åˆ° Handler å³å¤„ç†å™¨ï¼ŒSpringMVC æä¾›äº†ä¸åŒçš„æ˜ å°„å™¨å®ç°ä¸åŒçš„æ˜ å°„æ–¹å¼ï¼Œä¾‹å¦‚ï¼šé…ç½®æ–‡ä»¶æ–¹å¼ï¼Œå®ç°æ¥å£æ–¹å¼ï¼Œæ³¨è§£æ–¹å¼ç­‰ã€‚ Handlerï¼šå¤„ç†å™¨:å¼€å‘ä¸­è¦ç¼–å†™çš„å…·ä½“ä¸šåŠ¡æ§åˆ¶å™¨ã€‚ç”± DispatcherServlet æŠŠç”¨æˆ·è¯·æ±‚è½¬å‘åˆ° Handlerã€‚ç”±Handler å¯¹å…·ä½“çš„ç”¨æˆ·è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚ HandlAdapterï¼šå¤„ç†å™¨é€‚é…å™¨:é€šè¿‡é€‚é…å™¨å¯¹å¤„ç†å™¨è¿›è¡Œæ‰§è¡Œï¼Œé€šè¿‡æ‹“å±•é€‚é…å™¨å¯ä»¥å¤„ç†æ›´å¤šç±»å‹ã€‚ View Resolverï¼šè§†å›¾è§£æå™¨:View Resolver è´Ÿè´£å°†å¤„ç†ç»“æœç”Ÿæˆ View è§†å›¾ï¼ŒView Resolver é¦–å…ˆæ ¹æ®é€»è¾‘è§†å›¾åè§£ææˆç‰©ç†è§†å›¾å.å³å…·ä½“çš„é¡µé¢åœ°å€ï¼Œå†ç”Ÿæˆ View è§†å›¾å¯¹è±¡ï¼Œæœ€åå¯¹ View è¿›è¡Œæ¸²æŸ“å°†å¤„ç†ç»“æœé€šè¿‡é¡µé¢å±•ç¤ºç»™ç”¨æˆ· Viewï¼šè§†å›¾:SpringMVC æ¡†æ¶æä¾›äº†å¾ˆå¤šçš„ View è§†å›¾ç±»å‹çš„æ”¯æŒï¼ŒåŒ…æ‹¬ï¼šjstlViewã€freemarkerViewã€pdfViewç­‰ã€‚æˆ‘ä»¬æœ€å¸¸ç”¨çš„è§†å›¾å°±æ˜¯ jspã€‚ä¸€èˆ¬æƒ…å†µä¸‹éœ€è¦é€šè¿‡é¡µé¢æ ‡ç­¾æˆ–é¡µé¢æ¨¡ç‰ˆæŠ€æœ¯å°†æ¨¡å‹æ•°æ®é€šè¿‡é¡µé¢å±•ç¤ºç»™ç”¨æˆ·ï¼Œéœ€è¦ç”±ç¨‹åºå‘˜æ ¹æ®ä¸šåŠ¡éœ€æ±‚å¼€å‘å…·ä½“çš„é¡µé¢ã€‚ mvc:annotation-drivenè¯´æ˜:åœ¨ SpringMVC çš„å„ä¸ªç»„ä»¶ä¸­ï¼Œå¤„ç†å™¨æ˜ å°„å™¨ã€å¤„ç†å™¨é€‚é…å™¨ã€è§†å›¾è§£æå™¨ç§°ä¸º SpringMVC çš„ä¸‰å¤§ç»„ä»¶ã€‚ä½¿ ç”¨ mvc:annotation-driven è‡ªåŠ¨åŠ è½½ RequestMappingHandlerMapping ï¼ˆå¤„ç†æ˜ å°„å™¨ï¼‰ å’ŒRequestMappingHandlerAdapter ï¼ˆ å¤„ ç† é€‚ é… å™¨ ï¼‰ ï¼Œ å¯ ç”¨ åœ¨ SpringMVC.xml é… ç½® æ–‡ ä»¶ ä¸­ ä½¿ ç”¨mvc:annotation-driven/æ›¿ä»£æ³¨è§£å¤„ç†å™¨å’Œé€‚é…å™¨çš„é…ç½®ã€‚ 5.RequestMappingæ³¨è§£123456789101112131415161718192021222324æºç ï¼š@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)//å¯ä»¥åŠ åˆ°ç±»ä¸Šå’Œæ–¹æ³•ä¸Š@Retention(RetentionPolicy.RUNTIME)@Documented@Mappingpublic @interface RequestMapping &#123; &#125;ä½œç”¨ï¼š ç”¨äºå»ºç«‹è¯·æ±‚ URL å’Œå¤„ç†è¯·æ±‚æ–¹æ³•ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚å‡ºç°ä½ç½®ï¼š 1.ç±»ä¸Š è¯·æ±‚ URL çš„ç¬¬ä¸€çº§è®¿é—®ç›®å½•ï¼Œä¾¿äºæ¨¡å—åŒ–ç®¡ç†ã€‚ 2.æ–¹æ³•ä¸Š è¯·æ±‚ URL çš„ç¬¬äºŒçº§è®¿é—®ç›®å½•ã€‚å±æ€§ï¼š valueï¼šç”¨äºæŒ‡å®šè¯·æ±‚çš„ URLã€‚å®ƒå’Œ path å±æ€§çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ã€‚ methodï¼šç”¨äºæŒ‡å®šè¯·æ±‚çš„æ–¹å¼ã€‚ paramsï¼šç”¨äºæŒ‡å®šé™åˆ¶è¯·æ±‚å‚æ•°çš„æ¡ä»¶ã€‚å®ƒæ”¯æŒç®€å•çš„è¡¨è¾¾å¼ã€‚è¦æ±‚è¯·æ±‚å‚æ•°çš„ key å’Œ value å¿…é¡»å’Œé…ç½®çš„ä¸€æ¨¡ä¸€æ ·ã€‚ä¾‹å¦‚ï¼šparams = &#123;&quot;accountName&quot;&#125;ï¼Œè¡¨ç¤ºè¯·æ±‚å‚æ•°å¿…é¡»æœ‰ accountNameparams = &#123;&quot;moeny!100&quot;&#125;ï¼Œè¡¨ç¤ºè¯·æ±‚å‚æ•°ä¸­ money ä¸èƒ½æ˜¯ 100ã€‚ headersï¼šç”¨äºæŒ‡å®šé™åˆ¶è¯·æ±‚æ¶ˆæ¯å¤´çš„æ¡ä»¶ã€‚æ³¨æ„ï¼šä»¥ä¸Šå››ä¸ªå±æ€§åªè¦å‡ºç° 2 ä¸ªæˆ–ä»¥ä¸Šæ—¶ï¼Œä»–ä»¬çš„å…³ç³»æ˜¯ä¸çš„å…³ç³»ã€‚ ä¸‰ï¼Œè¯·æ±‚å‚æ•°çš„ç»‘å®š1.ç»‘å®šçš„æœºåˆ¶123456789101112131415è¡¨å•ä¸­è¯·æ±‚å‚æ•°éƒ½æ˜¯åŸºäº key=value çš„ã€‚SpringMVC ç»‘å®šè¯·æ±‚å‚æ•°çš„è¿‡ç¨‹æ˜¯é€šè¿‡æŠŠè¡¨å•æäº¤è¯·æ±‚å‚æ•°ï¼Œä½œä¸ºæ§åˆ¶å™¨ä¸­æ–¹æ³•å‚æ•°è¿›è¡Œç»‘å®šçš„ã€‚ä¾‹å¦‚ï¼š&lt;a href=&quot;account/findAccount?accountId=10&quot;&gt;æŸ¥è¯¢è´¦æˆ·&lt;/a&gt;ä¸­è¯·æ±‚å‚æ•°æ˜¯ï¼š accountId=10/*** æŸ¥è¯¢è´¦æˆ·* @return*/@RequestMapping(&quot;/findAccount&quot;)public String findAccount(Integer accountId) &#123; System.out.println(&quot;æŸ¥è¯¢äº†è´¦æˆ·ã€‚ã€‚ã€‚ã€‚&quot;+accountId); return &quot;success&quot;;&#125; 2.æ”¯æŒçš„æ•°æ®ç±»å‹ åŸºæœ¬ç±»å‹å‚æ•°ï¼š åŒ…æ‹¬åŸºæœ¬ç±»å‹å’Œ String ç±»å‹ POJO ç±»å‹å‚æ•°ï¼š åŒ…æ‹¬å®ä½“ç±»ï¼Œä»¥åŠå…³è”çš„å®ä½“ç±» æ•°ç»„å’Œé›†åˆç±»å‹å‚æ•°ï¼š åŒ…æ‹¬ List ç»“æ„å’Œ Map ç»“æ„çš„é›†åˆï¼ˆåŒ…æ‹¬æ•°ç»„ï¼‰ SpringMVC ç»‘å®šè¯·æ±‚å‚æ•°æ˜¯è‡ªåŠ¨å®ç°çš„ï¼Œä½†æ˜¯è¦æƒ³ä½¿ç”¨ï¼Œå¿…é¡»éµå¾ªä½¿ç”¨è¦æ±‚ã€‚ 3.ä½¿ç”¨è¦æ±‚ å¦‚æœæ˜¯åŸºæœ¬ç±»å‹æˆ–è€… String ç±»å‹ï¼š è¦æ±‚æˆ‘ä»¬çš„å‚æ•°åç§°å¿…é¡»å’Œæ§åˆ¶å™¨ä¸­æ–¹æ³•çš„å½¢å‚åç§°ä¿æŒä¸€è‡´ã€‚(ä¸¥æ ¼åŒºåˆ†å¤§å°å†™) å¦‚æœæ˜¯ POJO ç±»å‹ï¼Œæˆ–è€…å®ƒçš„å…³è”å¯¹è±¡ï¼š è¦æ±‚è¡¨å•ä¸­å‚æ•°åç§°å’Œ POJO ç±»çš„å±æ€§åç§°ä¿æŒä¸€è‡´ã€‚å¹¶ä¸”æ§åˆ¶å™¨æ–¹æ³•çš„å‚æ•°ç±»å‹æ˜¯ POJO ç±»å‹ã€‚ å¦‚æœæ˜¯é›†åˆç±»å‹,æœ‰ä¸¤ç§æ–¹å¼ï¼š ç¬¬ä¸€ç§ï¼š è¦æ±‚é›†åˆç±»å‹çš„è¯·æ±‚å‚æ•°å¿…é¡»åœ¨ POJO ä¸­ã€‚åœ¨è¡¨å•ä¸­è¯·æ±‚å‚æ•°åç§°è¦å’Œ POJO ä¸­é›†åˆå±æ€§åç§°ç›¸åŒã€‚ ç»™ List é›†åˆä¸­çš„å…ƒç´ èµ‹å€¼ï¼Œä½¿ç”¨ä¸‹æ ‡ã€‚ ç»™ Map é›†åˆä¸­çš„å…ƒç´ èµ‹å€¼ï¼Œä½¿ç”¨é”®å€¼å¯¹ã€‚ ç¬¬äºŒç§ï¼š æ¥æ”¶çš„è¯·æ±‚å‚æ•°æ˜¯ json æ ¼å¼æ•°æ®ã€‚éœ€è¦å€ŸåŠ©ä¸€ä¸ªæ³¨è§£å®ç° æ³¨æ„: å®ƒè¿˜å¯ä»¥å®ç°ä¸€äº›æ•°æ®ç±»å‹è‡ªåŠ¨è½¬æ¢ã€‚å¦‚é‡ç‰¹æ®Šç±»å‹è½¬æ¢è¦æ±‚ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™è‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨ã€‚ 4.ä»£ç ç¤ºä¾‹1234567891011121314151617181920/** * å‚æ•°ç»‘å®š1: * beanä¸­åŒ…å«bean */ @RequestMapping(&quot;/getBean&quot;) public String getBean(Person person)&#123; System.out.println(&quot;getBean()...&quot;); System.out.println(person); return &quot;success&quot;; &#125; /** * å‚æ•°ç»‘å®š2 * é›†åˆç±»å‹ */ @RequestMapping(&quot;/getCollection&quot;) public String getList(MyCollection collection)&#123; System.out.println(&quot;getList()....&quot;); System.out.println(collection); return &quot;success&quot;; &#125; 12345678910111213&lt;form action=&quot;success/getBean&quot; method=&quot;post&quot;&gt; id: &lt;input type=&quot;text&quot; name=&quot;id&quot;/&gt;&lt;br/&gt; name: &lt;input type=&quot;text&quot; name=&quot;user.name&quot;/&gt;&lt;br/&gt; age:&lt;input type=&quot;text&quot; name=&quot;user.age&quot;/&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot;/&gt;&lt;br/&gt;&lt;/form&gt;&lt;form method=&quot;post&quot; action=&quot;success/getCollection&quot;&gt; name: &lt;input type=&quot;text&quot; name=&quot;list[0].name&quot;/&gt;&lt;br/&gt; age: &lt;input type=&quot;text&quot; name=&quot;list[0].age&quot;/&gt;&lt;br/&gt; name: &lt;input type=&quot;text&quot; name=&quot;map[1].name&quot;/&gt;&lt;br/&gt; age: &lt;input type=&quot;text&quot; name=&quot;map[1].age&quot;/&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot;/&gt;&lt;/form&gt; 5.è¯·æ±‚å‚æ•°ä¹±ç é—®é¢˜ideaæ§åˆ¶å°è¾“å‡ºä¸­æ–‡ä¹±ç ï¼š-Dfile.encoding=UTF-8 1234567891011121314&lt;!-- ç¼–ç è¿‡æ»¤å™¨,å¿…é¡»æ”¾åœ¨web.xmlæœ€ä¸Šé¢ï¼Œé˜²æ­¢ç¼“å­˜ --&gt; &lt;filter&gt; &lt;filter-name&gt;CharacterEncodingFilter&lt;/filter-name&gt; &lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt; &lt;init-param&gt; &lt;param-name&gt;encoding&lt;/param-name&gt; &lt;param-value&gt;UTF-8&lt;/param-value&gt; &lt;/init-param&gt; &lt;/filter&gt; &lt;filter-mapping&gt; &lt;filter-name&gt;CharacterEncodingFilter&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt; &lt;!-- æ­¤å¤„/*ä»£è¡¨è¿‡æ»¤æ‰€æœ‰è¯·æ±‚ --&gt; &lt;/filter-mapping&gt; 6.å…³äºé™æ€èµ„æºå¤„ç†åœ¨ springmvc çš„é…ç½®æ–‡ä»¶ä¸­å¯ä»¥é…ç½®ï¼Œé™æ€èµ„æºä¸è¿‡æ»¤ï¼š 1234&lt;!-- location è¡¨ç¤ºè·¯å¾„ï¼Œmapping è¡¨ç¤ºæ–‡ä»¶ï¼Œ**è¡¨ç¤ºè¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶ä»¥åŠå­ç›®å½•çš„æ–‡ä»¶ --&gt;&lt;mvc:resources location=&quot;/css/&quot; mapping=&quot;/css/**&quot;/&gt;&lt;mvc:resources location=&quot;/images/&quot; mapping=&quot;/images/**&quot;/&gt;&lt;mvc:resources location=&quot;/scripts/&quot; mapping=&quot;/javascript/**&quot;/&gt; 7.å…³äºgetè¯·æ±‚tomacat å¯¹ GET å’Œ POST è¯·æ±‚å¤„ç†æ–¹å¼æ˜¯ä¸åŒçš„ï¼ŒGET è¯·æ±‚çš„ç¼–ç é—®é¢˜ï¼Œè¦æ”¹ tomcat çš„ server.xml é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š 123456789&lt;Connector connectionTimeout=&quot;20000&quot; port=&quot;8080&quot;protocol=&quot;HTTP/1.1&quot; redirectPort=&quot;8443&quot;/&gt;æ”¹ä¸ºï¼š&lt;Connector connectionTimeout=&quot;20000&quot; port=&quot;8080&quot;protocol=&quot;HTTP/1.1&quot; redirectPort=&quot;8443&quot;useBodyEncodingForURI=&quot;true&quot;/&gt;å¦‚æœé‡åˆ° ajax è¯·æ±‚ä»ç„¶ä¹±ç ï¼Œè¯·æŠŠï¼šuseBodyEncodingForURI=&quot;true&quot;æ”¹ä¸º URIEncoding=&quot;UTF-8&quot;å³å¯ 8.è‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨ä»£ç ï¼šjspé¡µé¢ 1234&lt;form action=&quot;success/date&quot; method=&quot;post&quot;&gt; &lt;input type=&quot;text&quot; name=&quot;date&quot;/&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot;/&gt;&lt;/form&gt; è½¬æ¢å™¨ 123456789101112131415public class StringToDate implements Converter&lt;String, Date&gt; &#123; @Override public Date convert(String s) &#123; if (s==null||&quot;&quot;.equals(s))&#123; throw new RuntimeException(&quot;è¾“å…¥ä¸èƒ½ä¸ºç©º&quot;); &#125; try &#123; SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;); return format.parse(s); &#125; catch (Exception e) &#123; throw new ClassCastException(&quot;ç±»å‹è½¬æ¢å¼‚å¸¸&quot;); &#125; &#125;&#125; è‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨ spring é…ç½®ç±»å‹è½¬æ¢å™¨çš„æœºåˆ¶æ˜¯ï¼Œå°†è‡ªå®šä¹‰çš„è½¬æ¢å™¨æ³¨å†Œåˆ°ç±»å‹è½¬æ¢æœåŠ¡ä¸­å»ã€‚ 1234567891011&lt;!--è‡ªå®šä¹‰ç±»å‹è½¬æ¢--&gt;&lt;!-- é…ç½®ç±»å‹è½¬æ¢å™¨å·¥å‚ --&gt; &lt;bean id=&quot;conversionServiceFactoryBean&quot; class=&quot;org.springframework.context.support.ConversionServiceFactoryBean&quot;&gt; &lt;!-- ç»™å·¥å‚æ³¨å…¥ä¸€ä¸ªæ–°çš„ç±»å‹è½¬æ¢å™¨ --&gt; &lt;property name=&quot;converters&quot;&gt; &lt;set&gt;&lt;!-- é…ç½®è‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨ --&gt; &lt;bean class=&quot;com.atguigu.utils.StringToDate&quot;&gt;&lt;/bean&gt; &lt;/set&gt; &lt;/property&gt; &lt;/bean&gt;&lt;mvc:annotation-driven conversion-service=&quot;conversionServiceFactoryBean&quot;/&gt; æ§åˆ¶å™¨ 1234567891011/** * è‡ªå®šä¹‰æ•°æ®ç±»å‹è½¬æ¢ * 1.ç¼–å†™ç±»å‹è½¬æ¢ç±»ï¼Œå®ç° Converter æ¥å£ï¼Œè¯¥æ¥å£æœ‰ä¸¤ä¸ªæ³›å‹ã€‚ * 2.é…ç½®æ–‡ä»¶ä¸­é…ç½®è½¬æ¢å™¨,å¹¶åœ¨æ³¨è§£æ”¯æŒé‡Œé¢æ³¨å†Œã€‚ * 3.æ§åˆ¶å±‚å‚æ•°åˆ—è¡¨ä¼ å…¥è½¬æ¢ç±» */ @RequestMapping(&quot;/date&quot;) public String getDate(Date date)&#123; System.out.println(date.toString()); return &quot;success&quot;; &#125; 9.ä½¿ç”¨servletAPIå¯¹è±¡ä½œä¸ºæ–¹æ³•å‚æ•°springMVC è¿˜æ”¯æŒä½¿ç”¨åŸå§‹ ServletAPI å¯¹è±¡ä½œä¸ºæ§åˆ¶å™¨æ–¹æ³•çš„å‚æ•°ã€‚æ”¯æŒåŸå§‹ ServletAPI å¯¹è±¡æœ‰ï¼š 12345678/** * è·å–åŸç”ŸServletAPI */@RequestMapping(&quot;/getServlet&quot;)public String getServlet(HttpServletRequest request, HttpServletResponse response)&#123; System.out.println(&quot;getServlet()...&quot;); return &quot;success&quot;;&#125; 1&lt;a href=&quot;success/getServlet&quot;&gt;getServlet&lt;/a&gt;&lt;br/&gt; å››ï¼Œå¸¸ç”¨æ³¨è§£1.RequestParamä½œç”¨ï¼š æŠŠè¯·æ±‚ä¸­æŒ‡å®šåç§°çš„å‚æ•°ç»™æ§åˆ¶å™¨ä¸­çš„å½¢å‚èµ‹å€¼ã€‚å±æ€§ï¼š valueï¼šè¯·æ±‚å‚æ•°ä¸­çš„åç§°ã€‚ requiredï¼šè¯·æ±‚å‚æ•°ä¸­æ˜¯å¦å¿…é¡»æä¾›æ­¤å‚æ•°ã€‚é»˜è®¤å€¼ï¼štrueã€‚è¡¨ç¤ºå¿…é¡»æä¾›ï¼Œå¦‚æœä¸æä¾›å°†æŠ¥é”™ã€‚ 1234567891011/** * @RequestParam å½“è¡¨å•nameå’Œå½¢å‚åˆ—è¡¨åå­—ä¸ä¸€è‡´æ—¶ï¼Œä½¿ç”¨æ­¤æ³¨è§£ã€‚ * å±æ€§ï¼š * nameï¼šæŒ‡å®šè¡¨å•çš„name * requiredï¼šæŒ‡å®šæ˜¯å¦ä¸ºå¿…é¡» */ @RequestMapping(&quot;/test1&quot;) public String test1(@RequestParam(name = &quot;name&quot;, required = false) String username, Integer age) &#123; System.out.println(username + &quot; &quot; + age); return &quot;success&quot;; &#125; 12345&lt;form method=&quot;post&quot; action=&quot;anno/test1&quot;&gt; &lt;input type=&quot;text&quot; name=&quot;name&quot;/&gt;&lt;br/&gt; &lt;input type=&quot;text&quot; name=&quot;age&quot;/&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot;/&gt;&lt;/form&gt; 2.RequestBodyä½œç”¨ï¼š ç”¨äºè·å–è¯·æ±‚ä½“å†…å®¹ã€‚ç›´æ¥ä½¿ç”¨å¾—åˆ°æ˜¯ key=value&amp;key=valueâ€¦ç»“æ„çš„æ•°æ®ã€‚ get è¯·æ±‚æ–¹å¼ä¸é€‚ç”¨ã€‚å±æ€§ï¼š requiredï¼šæ˜¯å¦å¿…é¡»æœ‰è¯·æ±‚ä½“ã€‚é»˜è®¤å€¼æ˜¯:trueã€‚å½“å–å€¼ä¸º true æ—¶,get è¯·æ±‚æ–¹å¼ä¼šæŠ¥é”™ã€‚å¦‚æœå–å€¼ ä¸º falseï¼Œget è¯·æ±‚å¾—åˆ°æ˜¯ nullã€‚ 12345678910111213/** * @RequestBody ç”¨äºè·å–è¯·æ±‚ä½“å†…å®¹ * å±æ€§ï¼š * å±æ€§ï¼š * requiredï¼šæŒ‡å®šæ˜¯å¦ä¸ºå¿…é¡» * å½“è¯·æ±‚æ–¹å¼ä¸ºgetæ—¶ï¼ŒæŒ‡å®šä¸ºtrueä¼šæŠ¥é”™ï¼Œ * æŒ‡å®šä¸ºfalseæ—¶ï¼Œæ‹¿åˆ°çš„æ˜¯nullã€‚ */ @RequestMapping(&quot;/test2&quot;) public String test2(@RequestBody(required = false) String name) &#123; System.out.println(name); return &quot;success&quot;; &#125; 1234&lt;form method=&quot;post&quot; action=&quot;anno/test2&quot;&gt; &lt;input type=&quot;text&quot; name=&quot;name&quot;/&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot;/&gt;&lt;/form&gt; 3.PathVariableä½œç”¨ï¼š ç”¨äºç»‘å®š url ä¸­çš„å ä½ç¬¦ã€‚ä¾‹å¦‚ï¼šè¯·æ±‚ url ä¸­ /delete/{id}ï¼Œè¿™ä¸ª{id}å°±æ˜¯ url å ä½ç¬¦ã€‚ url æ”¯æŒå ä½ç¬¦æ˜¯ spring3.0 ä¹‹ååŠ å…¥çš„ã€‚æ˜¯ springmvc æ”¯æŒ rest é£æ ¼ URL çš„ä¸€ä¸ªé‡è¦æ ‡å¿—ã€‚å±æ€§ï¼š valueï¼šç”¨äºæŒ‡å®š url ä¸­å ä½ç¬¦åç§°ã€‚ requiredï¼šæ˜¯å¦å¿…é¡»æä¾›å ä½ç¬¦ã€‚ 1&lt;a href=&quot;anno/test3/å¼ ä¸‰&quot;&gt;test3&lt;/a&gt;&lt;br/&gt; 12345678910/** * @PathVariable restfulé£æ ¼ï¼Œspring3.0æ–°ç‰¹æ€§ * ä»¥/å‚æ•°æ–¹å¼ä¼ é€’å‚æ•° * æ¬¡æ³¨è§£çš„valueå±æ€§æŒ‡å®šä¼ é€’çš„å‚æ•°å */@RequestMapping(&quot;/test3/&#123;name&#125;&quot;)public String test3(@PathVariable(&quot;name&quot;) String name) &#123; System.out.println(name); return &quot;success&quot;;&#125; å…³äºresté£æ ¼url123456789101112131415161718192021222324252627*ä»€ä¹ˆæ˜¯ restï¼šRESTï¼ˆè‹±æ–‡ï¼šRepresentational State Transferï¼Œç®€ç§° RESTï¼‰æè¿°äº†ä¸€ä¸ªæ¶æ„æ ·å¼çš„ç½‘ç»œç³»ç»Ÿï¼Œæ¯”å¦‚ web åº”ç”¨ç¨‹åºã€‚å®ƒé¦–æ¬¡å‡ºç°åœ¨ 2000 å¹´ Roy Fielding çš„åšå£«è®ºæ–‡ä¸­ï¼Œä»–æ˜¯ HTTP è§„èŒƒçš„ä¸»è¦ç¼–å†™è€…ä¹‹ä¸€ã€‚åœ¨ç›®å‰ä¸»æµçš„ä¸‰ç§ Web æœåŠ¡äº¤äº’æ–¹æ¡ˆä¸­ï¼ŒREST ç›¸æ¯”äº SOAPï¼ˆSimple Object Access protocolï¼Œç®€å•å¯¹è±¡è®¿é—®åè®®ï¼‰ä»¥åŠ XML-RPC æ›´åŠ ç®€å•æ˜äº†ï¼Œæ— è®ºæ˜¯å¯¹ URL çš„å¤„ç†è¿˜æ˜¯å¯¹ Payload çš„ç¼–ç ï¼ŒREST éƒ½å€¾å‘äºç”¨æ›´åŠ ç®€å•è½»é‡çš„æ–¹æ³•è®¾è®¡å’Œå®ç°ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ REST å¹¶æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ‡å‡†ï¼Œè€Œæ›´åƒæ˜¯ä¸€ç§è®¾è®¡çš„é£æ ¼ã€‚å®ƒæœ¬èº«å¹¶æ²¡æœ‰ä»€ä¹ˆå®ç”¨æ€§ï¼Œå…¶æ ¸å¿ƒä»·å€¼åœ¨äºå¦‚ä½•è®¾è®¡å‡ºç¬¦åˆ REST é£æ ¼çš„ç½‘ç»œæ¥å£ã€‚*restful çš„ä¼˜ç‚¹å®ƒç»“æ„æ¸…æ™°ã€ç¬¦åˆæ ‡å‡†ã€æ˜“äºç†è§£ã€æ‰©å±•æ–¹ä¾¿ï¼Œæ‰€ä»¥æ­£å¾—åˆ°è¶Šæ¥è¶Šå¤šç½‘ç«™çš„é‡‡ç”¨ã€‚*restful çš„ç‰¹æ€§ï¼š*èµ„æºï¼ˆResourcesï¼‰ï¼šç½‘ç»œä¸Šçš„ä¸€ä¸ªå®ä½“ï¼Œæˆ–è€…è¯´æ˜¯ç½‘ç»œä¸Šçš„ä¸€ä¸ªå…·ä½“ä¿¡æ¯ã€‚å®ƒå¯ä»¥æ˜¯ä¸€æ®µæ–‡æœ¬ã€ä¸€å¼ å›¾ç‰‡ã€ä¸€é¦–æ­Œæ›²ã€ä¸€ç§æœåŠ¡ï¼Œæ€»ä¹‹å°±æ˜¯ä¸€ä¸ªå…·ä½“çš„å­˜åœ¨ã€‚å¯ä»¥ç”¨ä¸€ä¸ª URIï¼ˆç»Ÿä¸€èµ„æºå®šä½ç¬¦ï¼‰æŒ‡å‘å®ƒï¼Œæ¯ç§èµ„æºå¯¹åº”ä¸€ä¸ªç‰¹å®šçš„ URI ã€‚è¦è·å–è¿™ä¸ªèµ„æºï¼Œè®¿é—®å®ƒçš„ URI å°±å¯ä»¥ï¼Œå› æ­¤ URI å³ä¸ºæ¯ä¸€ä¸ªèµ„æºçš„ç‹¬ä¸€æ— äºŒçš„è¯†åˆ«ç¬¦ã€‚ è¡¨ç°å±‚ï¼ˆRepresentationï¼‰ï¼šæŠŠèµ„æºå…·ä½“å‘ˆç°å‡ºæ¥çš„å½¢å¼ï¼Œå«åšå®ƒçš„è¡¨ç°å±‚ ï¼ˆRepresentationï¼‰ã€‚æ¯”å¦‚ï¼Œæ–‡æœ¬å¯ä»¥ç”¨ txt æ ¼å¼è¡¨ç°ï¼Œä¹Ÿå¯ä»¥ç”¨ HTML æ ¼å¼ã€XML æ ¼å¼ã€JSON æ ¼å¼è¡¨ç°ï¼Œç”šè‡³å¯ä»¥é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼ã€‚*çŠ¶æ€è½¬åŒ–ï¼ˆState Transferï¼‰ï¼šæ¯ å‘å‡ºä¸€ä¸ªè¯·æ±‚ï¼Œå°±ä»£è¡¨äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„ä¸€æ¬¡äº¤äº’è¿‡ç¨‹ã€‚*HTTP åè®®ï¼Œæ˜¯ä¸€ä¸ªæ— çŠ¶æ€åè®®ï¼Œå³æ‰€æœ‰çš„çŠ¶æ€éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ã€‚å› æ­¤ï¼Œå¦‚æœå®¢æˆ·ç«¯æƒ³è¦æ“ä½œæœåŠ¡å™¨ï¼Œå¿…é¡»é€šè¿‡æŸç§æ‰‹æ®µï¼Œè®©æœåŠ¡å™¨ç«¯å‘ç”Ÿâ€œçŠ¶æ€è½¬åŒ–â€ï¼ˆState Transferï¼‰ã€‚è€Œè¿™ç§è½¬åŒ–æ˜¯å»ºç«‹åœ¨è¡¨ç°å±‚ä¹‹ä¸Šçš„ï¼Œæ‰€ä»¥å°±æ˜¯ â€œè¡¨ç°å±‚çŠ¶æ€è½¬åŒ–â€ã€‚å…·ä½“è¯´ï¼Œå°±æ˜¯ HTTP åè®®é‡Œé¢ï¼Œå››ä¸ªè¡¨ç¤ºæ“ä½œæ–¹å¼çš„åŠ¨è¯ï¼šGET ã€POST ã€PUTã€DELETEã€‚å®ƒä»¬åˆ†åˆ«å¯¹åº”å››ç§åŸºæœ¬æ“ä½œï¼šGET ç”¨æ¥è·å–èµ„æºï¼ŒPOST ç”¨æ¥æ–°å»ºèµ„æºï¼ŒPUT ç”¨æ¥æ›´æ–°èµ„æºï¼ŒDELETE ç”¨æ¥åˆ é™¤èµ„æºã€‚*restful çš„ç¤ºä¾‹ï¼š /account/1 HTTP GET ï¼š å¾—åˆ° id = 1 çš„ account /account/1 HTTP DELETEï¼š åˆ é™¤ id = 1 çš„ account /account/1 HTTP PUTï¼š æ›´æ–° id = 1 çš„ account /account HTTP POSTï¼š æ–°å¢ account 4.requestHeaderä½œç”¨ï¼š ç”¨äºè·å–è¯·æ±‚æ¶ˆæ¯å¤´ã€‚å±æ€§ï¼š valueï¼šæä¾›æ¶ˆæ¯å¤´åç§° requiredï¼šæ˜¯å¦å¿…é¡»æœ‰æ­¤æ¶ˆæ¯å¤´æ³¨ï¼š åœ¨å®é™…å¼€å‘ä¸­ä¸€èˆ¬ä¸æ€ä¹ˆç”¨ã€‚ 1234567891011/** * @RequestHeader è·å–è¯·æ±‚å¤´ä¿¡æ¯ï¼Œä¸å¸¸ç”¨ * å±æ€§ï¼š * value: * required: */@RequestMapping(&quot;/test4&quot;)public String test4(@RequestHeader(value = &quot;Accept-Language&quot;, required = false) String value) &#123; System.out.println(value); return &quot;success&quot;;&#125; 1&lt;a href=&quot;anno/test4&quot;&gt;test4&lt;/a&gt;&lt;br/&gt; 5.CookieValueä½œç”¨ï¼š ç”¨äºæŠŠæŒ‡å®š cookie åç§°çš„å€¼ä¼ å…¥æ§åˆ¶å™¨æ–¹æ³•å‚æ•°ã€‚å±æ€§ï¼š valueï¼šæŒ‡å®š cookie çš„åç§°ã€‚ requiredï¼šæ˜¯å¦å¿…é¡»æœ‰æ­¤ cookieã€‚ 1234567891011/** * @CookieValue è·å–cookieé‡Œé¢çš„ä¿¡æ¯ * å±æ€§ï¼š * valueï¼š * requiredï¼š */@RequestMapping(&quot;/test5&quot;)public String test5(@CookieValue(value = &quot;JSESSIONID&quot;, required = false) String value) &#123; System.out.println(value); return &quot;success&quot;;&#125; 1&lt;a href=&quot;anno/test5&quot;&gt;test5&lt;/a&gt;&lt;br/&gt; 6.ModelAttributeä½œç”¨ï¼š è¯¥æ³¨è§£æ˜¯ SpringMVC4.3 ç‰ˆæœ¬ä»¥åæ–°åŠ å…¥çš„ã€‚å®ƒå¯ä»¥ç”¨äºä¿®é¥°æ–¹æ³•å’Œå‚æ•°ã€‚ å‡ºç°åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºå½“å‰æ–¹æ³•ä¼šåœ¨æ§åˆ¶å™¨çš„æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œå…ˆæ‰§è¡Œã€‚å®ƒå¯ä»¥ä¿®é¥°æ²¡æœ‰è¿”å›å€¼çš„æ–¹æ³•ï¼Œä¹Ÿå¯ ä»¥ä¿®é¥°æœ‰å…·ä½“è¿”å›å€¼çš„æ–¹æ³•ã€‚ å‡ºç°åœ¨å‚æ•°ä¸Šï¼Œè·å–æŒ‡å®šçš„æ•°æ®ç»™å‚æ•°èµ‹å€¼ã€‚å±æ€§ï¼š valueï¼šç”¨äºè·å–æ•°æ®çš„ keyã€‚key å¯ä»¥æ˜¯ POJO çš„å±æ€§åç§°ï¼Œä¹Ÿå¯ä»¥æ˜¯ map ç»“æ„çš„ keyã€‚åº”ç”¨åœºæ™¯ï¼š å½“è¡¨å•æäº¤æ•°æ®ä¸æ˜¯å®Œæ•´çš„å®ä½“ç±»æ•°æ®æ—¶ï¼Œä¿è¯æ²¡æœ‰æäº¤æ•°æ®çš„å­—æ®µä½¿ç”¨æ•°æ®åº“å¯¹è±¡åŸæ¥çš„æ•°æ®ã€‚ ä¾‹å¦‚ï¼š æˆ‘ä»¬åœ¨ç¼–è¾‘ä¸€ä¸ªç”¨æˆ·æ—¶ï¼Œç”¨æˆ·æœ‰ä¸€ä¸ªåˆ›å»ºä¿¡æ¯å­—æ®µï¼Œè¯¥å­—æ®µçš„å€¼æ˜¯ä¸å…è®¸è¢«ä¿®æ”¹çš„ã€‚åœ¨æäº¤è¡¨å•æ•° æ®æ˜¯è‚¯å®šæ²¡æœ‰æ­¤å­—æ®µçš„å†…å®¹ï¼Œä¸€æ—¦æ›´æ–°ä¼šæŠŠè¯¥å­—æ®µå†…å®¹ç½®ä¸º nullï¼Œæ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨æ­¤æ³¨è§£è§£å†³é—®é¢˜ã€‚ 12345678910111213141516171819202122/** * @ModelAttribute * 1.å¤¹åœ¨æ–¹æ³•ä¸Šï¼š * 1.æ²¡æœ‰è¿”å›å€¼ * å¯ä»¥åº”ç”¨åœ¨ä»è¡¨å•è·å–çš„å€¼ä¸å…¨ï¼Œåœ¨è¿”å›æ–¹æ³•å‰å…ˆç»™å…¶å°†å€¼è¡¥å…¨ * 2.æœ‰è¿”å›å€¼ * å¯ä»¥æ ¹æ®è¡¨å•æäº¤çš„ä¸€ä¸ªå€¼åœ¨åˆ°è¾¾æ§åˆ¶å±‚ä¹‹å‰å…ˆå»ä»æ•°æ®åº“æŸ¥è¯¢ï¼Œ * *ä¸¥é‡æ€€ç–‘è¿™ä¸ªæ–¹æ³•åˆ©ç”¨åŠ¨æ€ä»£ç†å¯¹æ–¹æ³•è¿›è¡Œå¢å¼ºã€‚ * 2.åŠ åœ¨æ–¹æ³•å‚æ•°ä¸Šï¼š * å¯ä»¥ä¸ºæŒ‡å®šçš„å±æ€§èµ‹å€¼ * */ @RequestMapping(&quot;/test6&quot;) public String test6(User user) &#123; System.out.println(user.getName() + &quot;...&quot; + user.getAge()); return &quot;success&quot;; &#125; @ModelAttribute public void test11(User user)&#123; System.out.println(user.getName()+&quot; &quot;+user.getAge()+&quot;......&quot;); user.setAge(20); &#125; 1234&lt;form action=&quot;anno/test6&quot;&gt; &lt;input type=&quot;text&quot; name=&quot;name&quot;/&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot;/&gt;&lt;/form&gt; åœºæ™¯äºŒï¼š123456789101112131415161718 @RequestMapping(&quot;/test6&quot;) public String test6(User user) &#123; System.out.println(user.getName() + &quot;...&quot; + user.getAge()); return &quot;success&quot;; &#125; @ModelAttribute public User test22(String name) &#123; //æ¨¡æ‹Ÿä»æ•°æ®åº“æŸ¥è¯¢æ•°æ® User user=findUserByname(name); return user; &#125; //æ¨¡æ‹ŸæœåŠ¡å±‚daoå±‚æ–¹æ³• private User findUserByname(String name) &#123; User user = new User(); user.setName(name); user.setAge(20); return user; &#125; 1234&lt;form action=&quot;anno/test6&quot;&gt; &lt;input type=&quot;text&quot; name=&quot;name&quot;/&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot;/&gt;&lt;/form&gt; åœºæ™¯ä¸‰123456789101112131415161718//æ¨¡æ‹ŸæœåŠ¡å±‚daoå±‚æ–¹æ³•private User findUserByname(String name) &#123; User user = new User(); user.setName(name); user.setAge(20); return user;&#125;@RequestMapping(&quot;/test7&quot;)public String test7(@ModelAttribute(value=&quot;1&quot;) User user)&#123; System.out.println(user); return &quot;success&quot;;&#125;@ModelAttributepublic void test33(String name, Map&lt;String,User&gt;map)&#123; //æ¨¡æ‹Ÿä»æ•°æ®åº“æŸ¥è¯¢ User user=findUserByname(name); map.put(&quot;1&quot;,user);&#125; 1234&lt;form action=&quot;anno/test7&quot;&gt; &lt;input type=&quot;text&quot; name=&quot;name&quot;/&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;submit&quot;/&gt;&lt;/form&gt; 7.SessionAttributeä½œç”¨ï¼š ç”¨äºå¤šæ¬¡æ‰§è¡Œæ§åˆ¶å™¨æ–¹æ³•é—´çš„å‚æ•°å…±äº«ã€‚å±æ€§ï¼š valueï¼šç”¨äºæŒ‡å®šå­˜å…¥çš„å±æ€§åç§° typeï¼šç”¨äºæŒ‡å®šå­˜å…¥çš„æ•°æ®ç±»å‹ 123&lt;a href=&quot;session/put&quot;&gt;put&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;session/get&quot;&gt;get&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;session/delete&quot;&gt;delete&lt;/a&gt;&lt;br/&gt; 123456789101112131415161718192021222324252627282930313233@Controller@RequestMapping(&quot;/session&quot;)@SessionAttributes(value = &#123;&quot;name&quot;,&quot;age&quot;&#125;)public class Session &#123; /** * å­˜å…¥Session * Model æ˜¯ spring æä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£æœ‰ä¸€ä¸ªå®ç°ç±» ExtendedModelMap * è¯¥ç±»ç»§æ‰¿äº† ModelMapï¼Œè€Œ ModelMap å°±æ˜¯ LinkedHashMap å­ç±» */ @RequestMapping(&quot;/put&quot;) public String put(Model model)&#123; model.addAttribute(&quot;name&quot;,&quot;å°¹ä¼šä¸œ&quot;); model.addAttribute(&quot;age&quot;,23); return &quot;success&quot;; &#125; /** * å–å‡ºSession */ @RequestMapping(&quot;/get&quot;) public String get(ModelMap map)&#123; System.out.println(map.get(&quot;name&quot;)); System.out.println(map.get(&quot;age&quot;)); return &quot;success&quot;; &#125; /** * æ¸…é™¤Session */ @RequestMapping(&quot;/delete&quot;) public String delete(SessionStatus status)&#123; status.setComplete(); return &quot;success&quot;; &#125;&#125; äº”ï¼Œå“åº”æ•°æ®å’Œç»“æœè§†å›¾1.è¿”å›å€¼åˆ†ç±»â‘ voidåœ¨ controller æ–¹æ³•å½¢å‚ä¸Šå¯ä»¥å®šä¹‰ request å’Œ responseï¼Œä½¿ç”¨ request æˆ– response æŒ‡å®šå“åº”ç»“æœï¼š 123456781ã€ä½¿ç”¨ request è½¬å‘é¡µé¢ï¼Œå¦‚ä¸‹ï¼šrequest.getRequestDispatcher(&quot;/WEB-INF/pages/success.jsp&quot;).forward(request, response);2ã€ä¹Ÿå¯ä»¥é€šè¿‡ response é¡µé¢é‡å®šå‘ï¼šresponse.sendRedirect(&quot;testRetrunString&quot;) 3ã€ä¹Ÿå¯ä»¥é€šè¿‡ response æŒ‡å®šå“åº”ç»“æœï¼Œä¾‹å¦‚å“åº” json æ•°æ®ï¼šresponse.setCharacterEncoding(&quot;utf-8&quot;);response.setContentType(&quot;application/json;charset=utf-8&quot;);response.getWriter().write(&quot;json ä¸²&quot;); â‘¡ModelAndViewModelAndView æ˜¯ SpringMVC ä¸ºæˆ‘ä»¬æä¾›çš„ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¹Ÿå¯ä»¥ç”¨ä½œæ§åˆ¶å™¨æ–¹æ³•çš„è¿”å›å€¼ã€‚ è¯¥å¯¹è±¡ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š â‘¢è½¬å‘å’Œé‡å®šå‘forward è½¬å‘controller æ–¹æ³•åœ¨æä¾›äº† String ç±»å‹çš„è¿”å›å€¼ä¹‹åï¼Œé»˜è®¤å°±æ˜¯è¯·æ±‚è½¬å‘ã€‚â€‹ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœç”¨äº† formwardï¼šåˆ™è·¯å¾„å¿…é¡»å†™æˆå®é™…è§†å›¾ urlï¼Œä¸èƒ½å†™é€»è¾‘è§†å›¾ã€‚â€‹ å®ƒç›¸å½“äºâ€œrequest.getRequestDispatcher(â€œurlâ€).forward(request,response)â€ã€‚ä½¿ç”¨è¯·æ±‚è½¬å‘ï¼Œæ—¢å¯ä»¥è½¬å‘åˆ° jspï¼Œä¹Ÿå¯ä»¥è½¬å‘åˆ°å…¶ä»–çš„æ§åˆ¶å™¨æ–¹æ³•ã€‚ Redirect é‡å®šå‘contrller æ–¹æ³•æä¾›äº†ä¸€ä¸ª String ç±»å‹è¿”å›å€¼ä¹‹åï¼Œå®ƒéœ€è¦åœ¨è¿”å›å€¼é‡Œä½¿ç”¨:redirect:å®ƒç›¸å½“äºâ€œresponse.sendRedirect(url)â€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯é‡å®šå‘åˆ° jsp é¡µé¢ï¼Œåˆ™ jsp é¡µé¢ä¸èƒ½å†™åœ¨ WEB-INF ç›®å½•ä¸­ï¼Œå¦åˆ™æ— æ³•æ‰¾åˆ° 1234567891011121314151617181920212223242526272829303132333435363738394041424344@Controller@RequestMapping(&quot;/return&quot;)public class returnController &#123; /** * è¿”å›å€¼ç±»å‹ä¸ºStringï¼Œåœ¨requestä½œç”¨äºå­˜æ”¾å€¼ï¼Œå¹¶æ˜¾ç¤ºåˆ°é¡µé¢ * @param model * @return */ @RequestMapping(&quot;/string&quot;) public String test1(Model model)&#123; model.addAttribute(&quot;name&quot;,&quot;å°¹ä¼šä¸œ&quot;); model.addAttribute(&quot;age&quot;,20); return &quot;success&quot;; &#125; /** * è¿”å›å€¼ç±»å‹ä¸ºvoid */ @RequestMapping(&quot;/void&quot;) public void test2(HttpServletResponse response, HttpServletRequest request)throws Exception&#123;// //request.getRequestDispatcher(&quot;/WEB-INF/views/success.jsp&quot;).forward(request,response); //response.sendRedirect(&quot;/index.jsp&quot;); response.getWriter().write(&quot;aaaa&quot;); &#125; /** * è¿”å›å€¼ç±»å‹ä¸ºModelAndView */ @RequestMapping(&quot;/model&quot;) public ModelAndView test3()&#123; ModelAndView mv = new ModelAndView(); mv.addObject(&quot;name&quot;,&quot;zhangsan&quot;); mv.addObject(&quot;age&quot;,20); mv.setViewName(&quot;success&quot;); return mv; &#125; /** * å…³é”®å­—ï¼šforwardå’Œredirect */ @RequestMapping(&quot;/fr&quot;) public String test4()&#123; System.out.println(&quot;..................&quot;); //return &quot;forward:/WEB-INF/views/success.jsp&quot;; return &quot;redirect:/index.jsp&quot;; &#125;&#125; 12345678910111213&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;return&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h3&gt;returnè¿”å›å€¼ç±»å‹&lt;/h3&gt;&lt;a href=&quot;return/string&quot; &gt;string&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;return/void&quot; &gt;void&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;return/model&quot; &gt;model&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;return/fr&quot; &gt;fr&lt;/a&gt;&lt;br/&gt;&lt;/body&gt;&lt;/html&gt; â‘£@ResponseBody æ³¨è§£å“åº”jsonæ•°æ®ä½œç”¨ï¼šâ€‹ è¯¥æ³¨è§£ç”¨äºå°† Controller çš„æ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œé€šè¿‡ HttpMessageConverter æ¥å£è½¬æ¢ä¸ºæŒ‡å®šæ ¼å¼çš„æ•°æ®å¦‚ï¼šjson,xml ç­‰ï¼Œé€šè¿‡ Response å“åº”ç»™å®¢æˆ·ç«¯ 123456789101112131415161718192021222324@Controller@RequestMapping(&quot;/ajax&quot;)public class Ajax &#123; /** * å‘é€Ajaxå¼‚æ­¥è¯·æ±‚ * 1.é™æ€èµ„æºå¤„ç†ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥&lt;mvc:resource /&gt;æ ‡ç­¾ï¼ŒæŒ‡å®šæ”¾è¡Œçš„èµ„æºã€‚ * 2.å¯¼å…¥jacksonçš„ä¾èµ– * 3. * @RequestBody * æ¥å—è¯·æ±‚ä½“æ¶ˆæ¯ * @ResponseBody * å‘é€å“åº”ä½“æ¶ˆæ¯ * 4.springmvcæ¡†æ¶å·²ç»ä¸ºæˆ‘ä»¬å°è£…å¥½äº†å¤„ç†jsonæ•°æ®çš„æ–¹æ³•ï¼Œåº•å±‚ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚ * @param user * @return */ @RequestMapping(&quot;/ajax&quot;) public @ResponseBody User testAjax(@RequestBody User user) &#123; user.setName(&quot;yinhuidong&quot;); user.setAge(23); return user; &#125;&#125; 123456789101112131415161718192021222324252627&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;Ajax&lt;/title&gt; &lt;script src=&quot;js/jquery-3.3.1.min.js&quot;&gt;&lt;/script&gt; &lt;script type=&quot;text/javascript&quot;&gt; $(function () &#123; $(&quot;#btn&quot;).click(function () &#123; $.ajax(&#123; url: &quot;ajax/ajax&quot;, contentType:&quot;application/json;charset=UTF-8&quot;, data: &#x27;&#123;&quot;name&quot;:&quot;aa&quot;,&quot;age&quot;:20&#125;&#x27;, dataType: &quot;json&quot;, type: &quot;post&quot;, success: function (data) &#123; alert(data.name); alert(data.age); &#125; &#125;); &#125;); &#125;); &lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;input type=&quot;button&quot; id=&quot;btn&quot; value=&quot;åˆ«ç‚¹æˆ‘&quot;/&gt;&lt;/body&gt;&lt;/html&gt; 12//data:JSON.stringify(&#123;&quot;name&quot;:&quot;å¼ ä¸‰&quot;,&quot;msg&quot;:message&#125;),data:&#x27;&#123;&quot;name&quot;:&quot;å¼ ä¸‰&quot;,&quot;msg&quot;:&quot;123&quot;&#125;&#x27;, å…­ï¼Œæ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½1.æ–‡ä»¶ä¸Šä¼ å‰ææ¡ä»¶ form è¡¨å•çš„ enctype å–å€¼å¿…é¡»æ˜¯ï¼šmultipart/form-data (é»˜è®¤å€¼æ˜¯:application/x-www-form-urlencoded) enctype:æ˜¯è¡¨å•è¯·æ±‚æ­£æ–‡çš„ç±»å‹ method å±æ€§å–å€¼å¿…é¡»æ˜¯ Post æä¾›ä¸€ä¸ªæ–‡ä»¶é€‰æ‹©åŸŸ åŸç†åˆ†æ1234567891011121314å½“ form è¡¨å•çš„ enctype å–å€¼ä¸æ˜¯é»˜è®¤å€¼åï¼Œrequest.getParameter()å°†å¤±æ•ˆã€‚ enctype=â€application/x-www-form-urlencodedâ€æ—¶ï¼Œform è¡¨å•çš„æ­£æ–‡å†…å®¹æ˜¯ï¼š key=value&amp;key=value&amp;key=valueå½“ form è¡¨å•çš„ enctype å–å€¼ä¸º Mutilpart/form-data æ—¶ï¼Œè¯·æ±‚æ­£æ–‡å†…å®¹å°±å˜æˆï¼š æ¯ä¸€éƒ¨åˆ†éƒ½æ˜¯ MIME ç±»å‹æè¿°çš„æ­£æ–‡-----------------------------7de1a433602ac åˆ†ç•Œç¬¦Content-Disposition: form-data; name=&quot;userName&quot; åè®®å¤´aaa åè®®çš„æ­£æ–‡-----------------------------7de1a433602acContent-Disposition: form-data; name=&quot;file&quot;; filename=&quot;C:\\Users\\zhy\\Desktop\\fileupload_demofile\\b.txt&quot;Content-Type: text/plain åè®®çš„ç±»å‹ï¼ˆMIME ç±»å‹ï¼‰bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb-----------------------------7de1a433602ac-- â‘ ä¼ ç»Ÿæ¨¡å¼çš„æ–‡ä»¶ä¸Šä¼ 123456&lt;h3&gt;æ–‡ä»¶ä¸Šä¼ &lt;/h3&gt;&lt;form action=&quot;file/fileupload&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt; æ‹©æ–‡ä»¶ï¼š&lt;input type=&quot;file&quot; name=&quot;upload&quot;/&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;ä¸Šä¼ æ–‡ä»¶&quot;/&gt;&lt;/form&gt;&lt;hr/&gt; 12345678910111213141516171819202122232425262728293031323334353637383940@Controller@RequestMapping(&quot;/file&quot;)public class upload &#123; /** * æ–‡ä»¶ä¸Šä¼ 1: * ä¼ ç»Ÿçš„æ–‡ä»¶ä¸Šä¼  * */ @RequestMapping(value = &quot;/fileupload&quot;) public String fileupload(HttpServletRequest request) throws Exception &#123; // å…ˆè·å–åˆ°è¦ä¸Šä¼ çš„æ–‡ä»¶ç›®å½• String path = request.getSession().getServletContext().getRealPath(&quot;/uploads&quot;); // åˆ›å»ºFileå¯¹è±¡ï¼Œä¸€ä¼šå‘è¯¥è·¯å¾„ä¸‹ä¸Šä¼ æ–‡ä»¶ File file = new File(path); // åˆ¤æ–­è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºè¯¥è·¯å¾„ if (!file.exists()) &#123; file.mkdirs(); &#125; // åˆ›å»ºç£ç›˜æ–‡ä»¶é¡¹å·¥å‚ DiskFileItemFactory factory = new DiskFileItemFactory(); ServletFileUpload fileUpload = new ServletFileUpload(factory); // è§£ærequestå¯¹è±¡ List&lt;FileItem&gt; list = fileUpload.parseRequest(request); // éå† for (FileItem fileItem : list) &#123; // åˆ¤æ–­æ–‡ä»¶é¡¹æ˜¯æ™®é€šå­—æ®µï¼Œè¿˜æ˜¯ä¸Šä¼ çš„æ–‡ä»¶ if (fileItem.isFormField()) &#123; &#125; else &#123; // ä¸Šä¼ æ–‡ä»¶é¡¹ &#125; // è·å–åˆ°ä¸Šä¼ æ–‡ä»¶çš„åç§° String filename = fileItem.getName(); // ä¸Šä¼ æ–‡ä»¶ fileItem.write(new File(file, filename)); // åˆ é™¤ä¸´æ—¶æ–‡ä»¶ fileItem.delete(); &#125; return &quot;success&quot;; &#125; &#125; â‘¡springmvcæ–‡ä»¶ä¸Šä¼ 12345&lt;form action=&quot;file/upload&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt; æ‹©æ–‡ä»¶ï¼š&lt;input type=&quot;file&quot; name=&quot;upload&quot;/&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;ä¸Šä¼ æ–‡ä»¶&quot;/&gt;&lt;/form&gt;&lt;hr/&gt; 12345678910111213141516171819202122232425262728/** * springmvcæ–‡ä»¶ä¸Šä¼  * 1.å¯¼å…¥ä¾èµ– * commons-upload * commons-io * 2.é…ç½®æ–‡ä»¶è§£æå™¨ * 3.ç¼–å†™jspé¡µé¢ * 4.ä»£ç å®ç° */ @RequestMapping(&quot;/upload&quot;) public String fileupload2(HttpSession session, MultipartFile upload)throws Exception&#123; //è·å–æ–‡ä»¶ä¸Šä¼ è·¯å¾„ String path = session.getServletContext().getRealPath(&quot;/img&quot;); File file = new File(path); //åˆ¤æ–­ä¸å­˜åœ¨è¯¥ç›®å½•å°±åˆ›å»º if (!file.exists())&#123; file.mkdirs(); &#125; //è·å–æ–‡ä»¶å String filename = upload.getOriginalFilename(); System.out.println(filename); //èµ·åˆ«å String s = UUID.randomUUID().toString().replace(&quot;_&quot;, &quot;&quot;).toUpperCase(); filename=s+filename; //å¼€å§‹ä¸Šä¼  upload.transferTo(new File(file,filename)); return &quot;success&quot;; &#125; 2.æ–‡ä»¶ä¸‹è½½12345678910&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;Title&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h3&gt;æ–‡ä»¶ä¸‹è½½&lt;/h3&gt;&lt;a href=&quot;down/down?name=6.jpg&quot;&gt;ç‚¹å‡»ä¸‹è½½&lt;/a&gt;&lt;/body&gt;&lt;/html&gt; 123456789101112131415161718192021222324252627282930313233@Controller@RequestMapping(&quot;/down&quot;)public class down &#123; /** * æ–‡ä»¶ä¸‹è½½ * 1.è·å–æ–‡ä»¶å * 2.è·å¾—æ–‡ä»¶ä¸‹è½½è·¯å¾„ * 3.æ‹¼æ¥ * 4.ç”¨æµæ¥åŠ è½½æ–‡ä»¶åˆ°å­—èŠ‚æ•°ç»„ * 5.è®¾ç½®å¤´ä¿¡æ¯ä»¥é™„ä»¶å½¢å¼æ‰“å¼€ * 6.è®¾ç½®å“åº”çŠ¶æ€å— * 7.ä¸‹è½½ */ @RequestMapping(&quot;/down&quot;) public ResponseEntity&lt;byte[]&gt; down(HttpSession session,String name)throws Exception&#123; //è·å–æ–‡ä»¶ä¸‹è½½è·¯å¾„ String path = session.getServletContext().getRealPath(&quot;/img&quot;); //åŠ ä¸Šæ–‡ä»¶å String finalpath = path + File.separator + name; FileInputStream is = new FileInputStream(finalpath); //is.available()è·å–æµçš„å­—èŠ‚æ•° byte[] bytes = new byte[is.available()]; is.read(bytes); HttpHeaders headers = new HttpHeaders(); //è®¾ç½®æœ‰é™„ä»¶å½¢å¼æ‰“å¼€ headers.add(&quot;Content-Disposition&quot;, &quot;attachment;filename=&quot;+name); //è®¾ç½®å“åº”å— HttpStatus status=HttpStatus.OK; ResponseEntity&lt;byte[]&gt; entity = new ResponseEntity&lt;&gt;(bytes, headers, status); is.close(); return entity; &#125;&#125; ä¸ƒï¼Œspringmvcä¸­çš„å¼‚å¸¸å¤„ç†1.å¼‚å¸¸å¤„ç†çš„æ€è·¯ç³»ç»Ÿä¸­å¼‚å¸¸åŒ…æ‹¬ä¸¤ç±»ï¼šé¢„æœŸå¼‚å¸¸å’Œè¿è¡Œæ—¶å¼‚å¸¸ RuntimeExceptionï¼Œå‰è€…é€šè¿‡æ•è·å¼‚å¸¸ä»è€Œè·å–å¼‚å¸¸ä¿¡æ¯ï¼Œåè€…ä¸»è¦é€šè¿‡è§„èŒƒä»£ç å¼€å‘ã€æµ‹è¯•é€šè¿‡æ‰‹æ®µå‡å°‘è¿è¡Œæ—¶å¼‚å¸¸çš„å‘ç”Ÿã€‚â€‹ ç³»ç»Ÿçš„ daoã€serviceã€controller å‡ºç°éƒ½é€šè¿‡ throws Exception å‘ä¸ŠæŠ›å‡ºï¼Œæœ€åç”± springmvc å‰ç«¯æ§åˆ¶å™¨äº¤ç”±å¼‚å¸¸å¤„ç†å™¨è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚ 2.ä»£ç è‡ªå®šä¹‰å¼‚å¸¸ç±»1234567891011121314151617181920212223/** * @author yinhuidong * @createTime 2020-03-09-17:18 */public class MyException extends Exception&#123; private String message; public MyException() &#123; &#125; public MyException(String message) &#123; this.message = message; &#125; @Override public String getMessage() &#123; return message; &#125; public void setMessage(String message) &#123; this.message = message; &#125;&#125; 123456789101112131415161718192021/** * è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨ * @author yinhuidong * @createTime 2020-03-09-17:20 */public class HandlerException implements HandlerExceptionResolver &#123; @Override public ModelAndView resolveException(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e) &#123; MyException mye=null; if (e instanceof MyException)&#123; mye= (MyException) e; &#125;else&#123; mye=new MyException(); &#125; mye.setMessage(&quot;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•ï¼&quot;); ModelAndView mv = new ModelAndView(); mv.addObject(&quot;message&quot;,mye.getMessage()); mv.setViewName(&quot;/error&quot;); return mv; &#125;&#125; 12&lt;!--å¼‚å¸¸å¤„ç†ç±»--&gt; &lt;bean id=&quot;handlerException&quot; class=&quot;com.atguigu.exception.HandlerException&quot;&gt;&lt;/bean&gt; 123456789101112131415161718192021/** * @author yinhuidong * @createTime 2020-03-09-17:27 */@Controller@RequestMapping(&quot;/exception&quot;)public class TestException &#123; /** * æµ‹è¯•å¼‚å¸¸ * 1.ç¼–å†™è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼Œç»§æ‰¿Exceptionç±» * 2.ç¼–å†™å¼‚å¸¸å¤„ç†ç±»ï¼Œ * 3.åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®å¼‚å¸¸å¤„ç†ç±» * 4.æ¨¡æ‹Ÿå‘ç”Ÿå¼‚å¸¸ * @return */ @RequestMapping(&quot;/test&quot;) public String test1()throws MyException &#123; int i=1/0; return &quot;success&quot;; &#125;&#125; 1&lt;a href=&quot;exception/test&quot;&gt;æµ‹è¯•å¼‚å¸¸&lt;/a&gt; å…¨å±€å¼‚å¸¸å¤„ç†å™¨ 123456789101112131415161718192021222324252627282930313233343536public class ExceptionHandler implements HandlerExceptionResolver &#123; @Override public ModelAndView resolveException (HttpServletRequest request, HttpServletResponse response, Object o, Exception e) &#123; boolean isAjax = JudgeRequestType.judgeIsAjax(request); if (isAjax)&#123; try &#123; String message=e.getMessage(); Gson gson = new Gson(); String json = gson.toJson(message); response.getWriter().write(json); &#125; catch (IOException e1) &#123; e1.printStackTrace(); &#125; return null; &#125; ModelAndView mv = new ModelAndView(); mv.addObject(&quot;message&quot;,e.getMessage()); mv.setViewName(&quot;error&quot;); return mv; &#125;&#125;class JudgeRequestType &#123; public static boolean judgeIsAjax(HttpServletRequest request)&#123; String accept = request.getHeader(&quot;Accept&quot;); String header = request.getHeader(&quot;X-Requested-With&quot;); return (accept!=null &amp;&amp;accept.length()&gt;0&amp;&amp;accept.contains(&quot;application/json&quot;)) || (header!=null&amp;&amp;header.length()&gt;0&amp;&amp;header.equals(&quot;XMLHttpRequest&quot;)); &#125;&#125; å…«ï¼Œspringmvcä¸­çš„æ‹¦æˆªå™¨æ‹¦æˆªå™¨çš„ä½œç”¨Spring MVC çš„å¤„ç†å™¨æ‹¦æˆªå™¨ç±»ä¼¼äº Servlet å¼€å‘ä¸­çš„è¿‡æ»¤å™¨ Filterï¼Œç”¨äºå¯¹å¤„ç†å™¨è¿›è¡Œé¢„å¤„ç†å’Œåå¤„ç†ã€‚ç”¨æˆ·å¯ä»¥è‡ªå·±å®šä¹‰ä¸€äº›æ‹¦æˆªå™¨æ¥å®ç°ç‰¹å®šçš„åŠŸèƒ½ã€‚â€‹ è°ˆåˆ°æ‹¦æˆªå™¨ï¼Œè¿˜è¦å‘å¤§å®¶æä¸€ä¸ªè¯â€”â€”æ‹¦æˆªå™¨é“¾ï¼ˆInterceptor Chainï¼‰ã€‚æ‹¦æˆªå™¨é“¾å°±æ˜¯å°†æ‹¦æˆªå™¨æŒ‰ä¸€å®šçš„é¡ºåºè”ç»“æˆä¸€æ¡é“¾ã€‚åœ¨è®¿é—®è¢«æ‹¦æˆªçš„æ–¹æ³•æˆ–å­—æ®µæ—¶ï¼Œæ‹¦æˆªå™¨é“¾ä¸­çš„æ‹¦æˆªå™¨å°±ä¼šæŒ‰å…¶ä¹‹å‰å®šä¹‰çš„é¡ºåºè¢«è°ƒç”¨ã€‚â€‹ è¯´åˆ°è¿™é‡Œï¼Œå¯èƒ½å¤§å®¶è„‘æµ·ä¸­æœ‰äº†ä¸€ä¸ªç–‘é—®ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬ä¹‹å‰å­¦çš„è¿‡æ»¤å™¨å—ï¼Ÿæ˜¯çš„å®ƒå’Œè¿‡æ»¤å™¨æ˜¯æœ‰å‡ åˆ†ç›¸ä¼¼ï¼Œä½†æ˜¯ä¹Ÿæœ‰åŒºåˆ«ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥è¯´è¯´ä»–ä»¬çš„åŒºåˆ«ï¼š è¿‡æ»¤å™¨æ˜¯ servlet è§„èŒƒä¸­çš„ä¸€éƒ¨åˆ†ï¼Œä»»ä½• java web å·¥ç¨‹éƒ½å¯ä»¥ä½¿ç”¨ã€‚ æ‹¦æˆªå™¨æ˜¯ SpringMVC æ¡†æ¶è‡ªå·±çš„ï¼Œåªæœ‰ä½¿ç”¨äº† SpringMVC æ¡†æ¶çš„å·¥ç¨‹æ‰èƒ½ç”¨ã€‚ è¿‡æ»¤å™¨åœ¨ url-pattern ä¸­é…ç½®äº†/*ä¹‹åï¼Œå¯ä»¥å¯¹æ‰€æœ‰è¦è®¿é—®çš„èµ„æºæ‹¦æˆªã€‚ æ‹¦æˆªå™¨å®ƒæ˜¯åªä¼šæ‹¦æˆªè®¿é—®çš„æ§åˆ¶å™¨æ–¹æ³•ï¼Œå¦‚æœè®¿é—®çš„æ˜¯ jspï¼Œhtml,css,image æˆ–è€… js æ˜¯ä¸ä¼šè¿›è¡Œæ‹¦ æˆªçš„ã€‚â€‹ å®ƒä¹Ÿæ˜¯ AOP æ€æƒ³çš„å…·ä½“åº”ç”¨ã€‚æˆ‘ä»¬è¦æƒ³è‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼Œ è¦æ±‚å¿…é¡»å®ç°ï¼šHandlerInterceptor æ¥å£ã€‚ è‡ªå®šä¹‰æ‹¦æˆªå™¨æ­¥éª¤1.å†™ä¸€ä¸ªç±»ç»§æ‰¿HandlerInterceptoræ¥å£12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/** * @author yinhuidong * @createTime 2020-03-09-17:33 */public class Intercepter1 implements HandlerInterceptor &#123; /** * 1. preHandleæ–¹æ³•æ˜¯controlleræ–¹æ³•æ‰§è¡Œå‰æ‹¦æˆªçš„æ–¹æ³• * 1. å¯ä»¥ä½¿ç”¨requestæˆ–è€…responseè·³è½¬åˆ°æŒ‡å®šçš„é¡µé¢ * 2. return trueæ”¾è¡Œï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¦‚æœæ²¡æœ‰æ‹¦æˆªå™¨ï¼Œ * æ‰§è¡Œcontrollerä¸­çš„æ–¹æ³•ã€‚ * 3. return falseä¸æ”¾è¡Œï¼Œä¸ä¼šæ‰§è¡Œcontrollerä¸­çš„æ–¹æ³• * @param request * @param response * @param handler * @return * @throws Exception */ public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; System.out.println(&quot;preHandle()....&quot;); //request.getRequestDispatcher(&quot;/WEB-INF/views/error.jsp&quot;).forward(request, response); return true; &#125; /** * 2. postHandleæ˜¯controlleræ–¹æ³•æ‰§è¡Œåæ‰§è¡Œçš„æ–¹æ³•ï¼Œåœ¨JSPè§†å›¾æ‰§è¡Œå‰ã€‚ * 1. å¯ä»¥ä½¿ç”¨requestæˆ–è€…responseè·³è½¬åˆ°æŒ‡å®šçš„é¡µé¢ * 2. å¦‚æœæŒ‡å®šäº†è·³è½¬çš„é¡µé¢ï¼Œé‚£ä¹ˆcontrolleræ–¹æ³•è·³è½¬çš„é¡µé¢å°†ä¸ä¼šæ˜¾ç¤ºã€‚ * @param request * @param response * @param handler * @param modelAndView * @throws Exception */ public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView modelAndView) throws Exception &#123; System.out.println(&quot;postHandle()....&quot;); &#125; /** * 3. postHandleæ–¹æ³•æ˜¯åœ¨JSPæ‰§è¡Œåæ‰§è¡Œ * requestæˆ–è€…responseä¸èƒ½å†è·³è½¬é¡µé¢äº† * @param request * @param response * @param handler * @param ex * @throws Exception */ public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable Exception ex) throws Exception &#123; System.out.println(&quot;afterCompletion()...&quot;); &#125;&#125; 2.åœ¨springmvcçš„é…ç½®æ–‡ä»¶ä¸­é…ç½®æ‹¦æˆªå™¨1234567891011121314151617181920&lt;!--é…ç½®æ‹¦æˆªå™¨--&gt; &lt;mvc:interceptors&gt; &lt;!--é…ç½®ä¸€ä¸ªæ‹¦æˆªå™¨--&gt; &lt;mvc:interceptor&gt; &lt;!--è®¾ç½®æ‹¦æˆªè·¯å¾„--&gt; &lt;mvc:mapping path=&quot;/**&quot;/&gt; &lt;!--è®¾ç½®å“ªäº›ä¸æ‹¦æˆª--&gt; &lt;!--&lt;mvc:exclude-mapping path=&quot;&quot;/&gt;--&gt; &lt;!--é…ç½®bean--&gt; &lt;bean class=&quot;com.atguigu.intercept.Intercepter1&quot;/&gt; &lt;/mvc:interceptor&gt; &lt;mvc:interceptor&gt; &lt;!--è®¾ç½®æ‹¦æˆªè·¯å¾„--&gt; &lt;mvc:mapping path=&quot;/**&quot;/&gt; &lt;!--è®¾ç½®å“ªäº›ä¸æ‹¦æˆª--&gt; &lt;!--&lt;mvc:exclude-mapping path=&quot;&quot;/&gt;--&gt; &lt;!--é…ç½®bean--&gt; &lt;bean class=&quot;com.atguigu.intercept.Intercepter2&quot;/&gt; &lt;/mvc:interceptor&gt; &lt;/mvc:interceptors&gt; 3.ç¼–å†™æµ‹è¯•ç±»å’Œjspé¡µé¢12345678910111213141516171819/** * @author yinhuidong * @createTime 2020-03-09-17:37 */@Controller@RequestMapping(&quot;/intercepter&quot;)public class TestIntercepter &#123; /** * 1.ç¼–å†™æ‹¦æˆªå™¨ * 2.åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®æ‹¦æˆªå™¨ * 3.æµ‹è¯• * 4.å¤šä¸ªæ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº */ @RequestMapping(&quot;/test&quot;) public String test()&#123; System.out.println(&quot;controller().....&quot;); return &quot;success&quot;; &#125;&#125; 1&lt;a href=&quot;intercepter/test&quot;&gt;æµ‹è¯•æ‹¦æˆªå™¨&lt;/a&gt; 4.å®šä¹‰å¤šä¸ªæ‹¦æˆªå™¨12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/** * @author yinhuidong * @createTime 2020-03-09-17:33 */public class Intercepter2 implements HandlerInterceptor &#123; /** * 1. preHandleæ–¹æ³•æ˜¯controlleræ–¹æ³•æ‰§è¡Œå‰æ‹¦æˆªçš„æ–¹æ³• * 1. å¯ä»¥ä½¿ç”¨requestæˆ–è€…responseè·³è½¬åˆ°æŒ‡å®šçš„é¡µé¢ * 2. return trueæ”¾è¡Œï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¦‚æœæ²¡æœ‰æ‹¦æˆªå™¨ï¼Œ * æ‰§è¡Œcontrollerä¸­çš„æ–¹æ³•ã€‚ * 3. return falseä¸æ”¾è¡Œï¼Œä¸ä¼šæ‰§è¡Œcontrollerä¸­çš„æ–¹æ³• * @param request * @param response * @param handler * @return * @throws Exception */ public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; System.out.println(&quot;preHandle2()....&quot;); //request.getRequestDispatcher(&quot;/WEB-INF/views/error.jsp&quot;).forward(request, response); return true; &#125; /** * 2. postHandleæ˜¯controlleræ–¹æ³•æ‰§è¡Œåæ‰§è¡Œçš„æ–¹æ³•ï¼Œåœ¨JSPè§†å›¾æ‰§è¡Œå‰ã€‚ * 1. å¯ä»¥ä½¿ç”¨requestæˆ–è€…responseè·³è½¬åˆ°æŒ‡å®šçš„é¡µé¢ * 2. å¦‚æœæŒ‡å®šäº†è·³è½¬çš„é¡µé¢ï¼Œé‚£ä¹ˆcontrolleræ–¹æ³•è·³è½¬çš„é¡µé¢å°†ä¸ä¼šæ˜¾ç¤ºã€‚ * @param request * @param response * @param handler * @param modelAndView * @throws Exception */ public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView modelAndView) throws Exception &#123; System.out.println(&quot;postHandle()2....&quot;); &#125; /** * 3. postHandleæ–¹æ³•æ˜¯åœ¨JSPæ‰§è¡Œåæ‰§è¡Œ * requestæˆ–è€…responseä¸èƒ½å†è·³è½¬é¡µé¢äº† * @param request * @param response * @param handler * @param ex * @throws Exception */ public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable Exception ex) throws Exception &#123; System.out.println(&quot;afterCompletion()2...&quot;); &#125;&#125; æ‹¦æˆªå™¨çš„ç®€å•åº”ç”¨éœ€æ±‚ï¼š123456781ã€æœ‰ä¸€ä¸ªç™»å½•é¡µé¢ï¼Œéœ€è¦å†™ä¸€ä¸ª controller è®¿é—®é¡µé¢ 2ã€ç™»å½•é¡µé¢æœ‰ä¸€æäº¤è¡¨å•çš„åŠ¨ä½œã€‚éœ€è¦åœ¨ controller ä¸­å¤„ç†ã€‚ 2.1ã€åˆ¤æ–­ç”¨æˆ·åå¯†ç æ˜¯å¦æ­£ç¡® 2.2ã€å¦‚æœæ­£ç¡® å‘ session ä¸­å†™å…¥ç”¨æˆ·ä¿¡æ¯ 2.3ã€è¿”å›ç™»å½•æˆåŠŸã€‚3ã€æ‹¦æˆªç”¨æˆ·è¯·æ±‚ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½• 3.1ã€å¦‚æœç”¨æˆ·å·²ç»ç™»å½•ã€‚æ”¾è¡Œ 3.2ã€å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢ ä»£ç å®ç°ï¼š1.æ§åˆ¶å™¨ä»£ç 1234567891011121314151617181920//ç™»é™†é¡µé¢@RequestMapping(&quot;/login&quot;)public String login(Model model)throws Exception&#123; return &quot;login&quot;; &#125;//ç™»é™†æäº¤//useridï¼šç”¨æˆ·è´¦å·ï¼Œpwdï¼šå¯†ç @RequestMapping(&quot;/loginsubmit&quot;)public String loginsubmit(HttpSession session,String userid,String pwd)throws Exception&#123; //å‘ session è®°å½•ç”¨æˆ·èº«ä»½ä¿¡æ¯ session.setAttribute(&quot;activeUser&quot;, userid); return &quot;redirect:/main.jsp&quot;; &#125;//é€€å‡º@RequestMapping(&quot;/logout&quot;)public String logout(HttpSession session)throws Exception&#123; //session è¿‡æœŸ session.invalidate(); return &quot;redirect:index.jsp&quot;;&#125; 2.æ‹¦æˆªå™¨ä»£ç 123456789101112131415161718public class LoginInterceptor implements HandlerInterceptor&#123;@OverridePublic boolean preHandle(HttpServletRequest request,HttpServletResponse response, Object handler) throws Exception &#123; //å¦‚æœæ˜¯ç™»å½•é¡µé¢åˆ™æ”¾è¡Œ if(request.getRequestURI().indexOf(&quot;login.action&quot;)&gt;=0)&#123; return true; &#125; HttpSession session = request.getSession(); //å¦‚æœç”¨æˆ·å·²ç™»å½•ä¹Ÿæ”¾è¡Œ if(session.getAttribute(&quot;user&quot;)!=null)&#123; return true; &#125; //ç”¨æˆ·æ²¡æœ‰ç™»å½•æŒ‘æˆ˜åˆ°ç™»å½•é¡µé¢ request.getRequestDispatcher(&quot;/WEB-INF/jsp/login.jsp&quot;).forward(request,response); return false; &#125; &#125;","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[æ‰©å±•]åŸºæœ¬ä½¿ç”¨ç¯‡","slug":"Spring/Spring[æ‰©å±•]åŸºæœ¬ä½¿ç”¨ç¯‡","date":"2022-01-11T06:11:20.219Z","updated":"2022-01-11T06:20:10.278Z","comments":true,"path":"2022/01/11/Spring/Spring[æ‰©å±•]åŸºæœ¬ä½¿ç”¨ç¯‡/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E6%89%A9%E5%B1%95]%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E7%AF%87/","excerpt":"","text":"ä¸€ï¼ŒSpringçš„æ¦‚è¿°1.Springæ˜¯ä»€ä¹ˆï¼ŸSpring æ˜¯åˆ†å±‚çš„ Java SE/EE åº”ç”¨ full-stack è½»é‡çº§å¼€æºæ¡†æ¶ï¼Œä»¥ IoCï¼ˆInverse Of Controlï¼šåè½¬æ§åˆ¶ï¼‰å’Œ AOPï¼ˆAspect Oriented Programmingï¼šé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ä¸ºå†…æ ¸ï¼Œæä¾›äº†å±•ç°å±‚ Spring MVC å’ŒæŒä¹…å±‚ Spring JDBC ä»¥åŠä¸šåŠ¡å±‚äº‹åŠ¡ç®¡ç†ç­‰ä¼—å¤šçš„ä¼ä¸šçº§åº”ç”¨æŠ€æœ¯ï¼Œè¿˜èƒ½æ•´åˆå¼€æºä¸–ç•Œä¼—å¤šè‘—åçš„ç¬¬ä¸‰æ–¹æ¡†æ¶å’Œç±»åº“ï¼Œé€æ¸æˆä¸ºä½¿ç”¨æœ€å¤šçš„ Java EE ä¼ä¸šåº”ç”¨å¼€æºæ¡†æ¶ã€‚â€‹ 2.Springçš„ä¼˜åŠ¿ï¼Ÿ æ–¹ä¾¿è§£è€¦ï¼Œç®€åŒ–å¼€å‘ AOPç¼–ç¨‹çš„æ”¯æŒ å£°æ˜å¼äº‹åŠ¡çš„æ”¯æŒ æ–¹ä¾¿ç¨‹åºçš„æµ‹è¯• æ–¹ä¾¿é›†æˆå„ç§ä¼˜ç§€æ¡†æ¶ é™ä½JavaEE API çš„ä½¿ç”¨éš¾åº¦ æºç æ˜¯ç»å…¸çš„å­¦ä¹ èŒƒä¾‹ â€‹ 3.Springçš„ä½“ç³»ç»“æ„å›¾ äºŒï¼ŒIOC1.ç¨‹åºçš„è€¦åˆå’Œè§£è€¦è€¦åˆæ˜¯å½±å“è½¯ä»¶å¤æ‚ç¨‹åº¦å’Œè®¾è®¡è´¨é‡çš„ä¸€ä¸ªé‡è¦å› ç´ ï¼Œåœ¨è®¾è®¡ä¸Šæˆ‘ä»¬åº”é‡‡ç”¨ä»¥ä¸‹åŸåˆ™ï¼šå¦‚æœæ¨¡å—é—´å¿…é¡» å­˜åœ¨è€¦åˆï¼Œå°±å°½é‡ä½¿ç”¨æ•°æ®è€¦åˆï¼Œå°‘ç”¨æ§åˆ¶è€¦åˆï¼Œé™åˆ¶å…¬å…±è€¦åˆçš„èŒƒå›´ï¼Œå°½é‡é¿å…ä½¿ç”¨å†…å®¹è€¦åˆã€‚â€‹ 2.è§£å†³è€¦åˆçš„æ€è·¯Class.forName(&quot;com.mysql.jdbc.Driver&quot;);//æ­¤å¤„åªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ­¤æ—¶çš„å¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬çš„ç±»ä¸­ä¸å†ä¾èµ–å…·ä½“çš„é©±åŠ¨ç±»ï¼Œæ­¤æ—¶å°±ç®—åˆ é™¤ mysql çš„é©±åŠ¨ jar åŒ…ï¼Œä¾ç„¶å¯ä»¥ç¼–è¯‘ï¼ˆè¿è¡Œå°±ä¸è¦æƒ³äº†ï¼Œæ²¡æœ‰é©±åŠ¨ä¸å¯èƒ½è¿è¡ŒæˆåŠŸçš„ï¼‰ã€‚â€‹ åŒæ—¶ï¼Œä¹Ÿäº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œmysql é©±åŠ¨çš„å…¨é™å®šç±»åå­—ç¬¦ä¸²æ˜¯åœ¨ java ç±»ä¸­å†™æ­»çš„ï¼Œä¸€æ—¦è¦æ”¹è¿˜æ˜¯è¦ä¿®æ”¹æºç ã€‚è§£å†³è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆç®€å•ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶é…ç½®ã€‚â€‹ 3.å·¥å‚æ¨¡å¼è§£è€¦åœ¨å®é™…å¼€å‘ä¸­å¯ä»¥æŠŠä¸‰å±‚çš„å¯¹è±¡éƒ½ä½¿ç”¨é…ç½®æ–‡ä»¶é…ç½®èµ·æ¥ï¼Œå½“å¯åŠ¨æœåŠ¡å™¨åº”ç”¨åŠ è½½çš„æ—¶å€™ï¼Œè®©ä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•é€šè¿‡è¯»å–é…ç½®æ–‡ä»¶ï¼ŒæŠŠè¿™äº›å¯¹è±¡åˆ›å»ºå‡ºæ¥å¹¶å­˜èµ·æ¥ã€‚åœ¨æ¥ä¸‹æ¥çš„ä½¿ç”¨çš„æ—¶å€™ï¼Œç›´æ¥æ‹¿è¿‡æ¥ç”¨å°±å¥½äº†ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªè¯»å–é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºå’Œè·å–ä¸‰å±‚å¯¹è±¡çš„ç±»å°±æ˜¯å·¥å‚ã€‚â€‹ 4.ä»£ç æ¡ˆä¾‹4.1 AccountMapper123456789101112131415161718/** * @author äºŒå * @since 2021/9/21 3:23 ä¸‹åˆ */public class AccountMapper &#123; public void update(Account account) &#123; System.out.println(&quot;è°ƒç”¨äº†update()...&quot;); &#125; public void add(Account account) &#123; System.out.println(&quot;è°ƒç”¨äº†add()...&quot;); &#125; public void delete(Integer id) &#123; System.out.println(&quot;è°ƒç”¨äº†delete()...&quot;); &#125;&#125; 4.2 AccountService123456789101112131415161718192021222324252627/** * @author äºŒå * @since 2021/9/21 3:25 ä¸‹åˆ */public class AccountService &#123; private Account account = (Account) BeanFactory.getBean(&quot;account&quot;); private AccountMapper accountDao = (AccountMapper) BeanFactory.getBean(&quot;accountMapper&quot;); int i = 1; public void update(Account account) &#123; accountDao.update(account); &#125; public void add(Account account) &#123; accountDao.add(account); System.out.println(i + 1); &#125; public void delete(Integer id) &#123; System.out.println(accountDao); accountDao.delete(id); System.out.println(account.toString()); System.out.println(i + 1); &#125;&#125; 4.3 BeanFactory1234567891011121314151617181920212223242526272829303132333435363738394041424344/** * @author äºŒå * @since 2021/9/21 3:27 ä¸‹åˆ */public class BeanFactory &#123; private static Properties prop; private static Map&lt;String, Object&gt; beans; private static InputStream in; private final static String configFile = &quot;beans.properties&quot;; static &#123; try &#123; in = BeanFactory.class.getClassLoader().getResourceAsStream(configFile); prop = new Properties(); prop.load(in); beans = new HashMap&lt;&gt;(); Enumeration&lt;Object&gt; keys = prop.keys(); while (keys.hasMoreElements()) &#123; String key = keys.nextElement().toString(); String path = prop.getProperty(key); Object value = Class.forName(path).newInstance(); beans.put(key, value); &#125; &#125; catch (Exception e) &#123; &#125; finally &#123; try &#123; assert in != null; in.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125; public static Object getBean(String name) &#123; assert name != null; return beans.get(name); &#125;&#125; 4.4 beans.properties123accountService=com.es.service.AccountServiceaccountMapper=com.es.mapper.AccountMapperaccount=com.es.domain.Account 4.5 å•å…ƒæµ‹è¯•123456@Testpublic void test()&#123;//AccountService service=new AccountServiceImpl();AccountService service = (AccountService) BeanFactory.getBean(&quot;accountService&quot;);service.delete(1);&#125; 5.æ§åˆ¶åè½¬ å­˜å“ªå»ï¼Ÿ åˆ†æï¼šç”±äºæˆ‘ä»¬æ˜¯å¾ˆå¤šå¯¹è±¡ï¼Œè‚¯å®šè¦æ‰¾ä¸ªé›†åˆæ¥å­˜ã€‚è¿™æ—¶å€™æœ‰ Map å’Œ List ä¾›é€‰æ‹©ã€‚åˆ°åº•é€‰ Map è¿˜æ˜¯ List å°±çœ‹æˆ‘ä»¬æœ‰æ²¡æœ‰æŸ¥æ‰¾éœ€æ±‚ã€‚æœ‰æŸ¥æ‰¾éœ€æ±‚ï¼Œé€‰ Mapã€‚æ‰€ä»¥æˆ‘ä»¬çš„ç­”æ¡ˆå°±æ˜¯åœ¨åº”ç”¨åŠ è½½æ—¶ï¼Œåˆ›å»ºä¸€ä¸ª Mapï¼Œç”¨äºå­˜æ”¾ä¸‰å±‚å¯¹è±¡ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ª map ç§°ä¹‹ä¸ºå®¹å™¨ã€‚ è¿˜æ˜¯æ²¡è§£é‡Šä»€ä¹ˆæ˜¯å·¥å‚ï¼Ÿ å·¥å‚å°±æ˜¯è´Ÿè´£ç»™æˆ‘ä»¬ä»å®¹å™¨ä¸­è·å–æŒ‡å®šå¯¹è±¡çš„ç±»ã€‚è¿™æ—¶å€™æˆ‘ä»¬è·å–å¯¹è±¡çš„æ–¹å¼å‘ç”Ÿäº†æ”¹å˜ã€‚åŸæ¥ï¼šæˆ‘ä»¬åœ¨è·å–å¯¹è±¡æ—¶ï¼Œéƒ½æ˜¯é‡‡ç”¨ new çš„æ–¹å¼ã€‚æ˜¯ä¸»åŠ¨çš„ã€‚ç°åœ¨ï¼šæˆ‘ä»¬è·å–å¯¹è±¡æ—¶ï¼ŒåŒæ—¶è·Ÿå·¥å‚è¦ï¼Œæœ‰å·¥å‚ä¸ºæˆ‘ä»¬æŸ¥æ‰¾æˆ–è€…åˆ›å»ºå¯¹è±¡ã€‚æ˜¯è¢«åŠ¨çš„ã€‚ è¿™ç§è¢«åŠ¨æ¥æ”¶çš„æ–¹å¼è·å–å¯¹è±¡çš„æ€æƒ³å°±æ˜¯æ§åˆ¶åè½¬ï¼Œå®ƒæ˜¯ spring æ¡†æ¶çš„æ ¸å¿ƒä¹‹ä¸€ã€‚ æ˜ç¡® ioc çš„ä½œç”¨ï¼š å‰Šå‡è®¡ç®—æœºç¨‹åºçš„è€¦åˆ(è§£é™¤æˆ‘ä»¬ä»£ç ä¸­çš„ä¾èµ–å…³ç³»)ã€‚ ä¸‰ï¼Œä½¿ç”¨IOCè§£å†³ç¨‹åºçš„è€¦åˆ1.åŸºäºxmlå½¢å¼çš„è£…é…1.1 æ­¥éª¤â€‹ åˆ›å»ºmavenå·¥ç¨‹ï¼Œå¯¼å…¥ç›¸å…³ä¾èµ– åˆ›å»ºspringçš„é…ç½®æ–‡ä»¶ï¼ŒapplicationContext.xmlé…ç½®æ–‡ä»¶ è®©springç®¡ç†èµ„æºï¼Œåœ¨springçš„é…ç½®æ–‡ä»¶ä¸­é…ç½®serviceå’Œmapper â€‹ 1.2 ä»£ç 12345678910/** * æµ‹è¯•åŸºäºxmlå½¢å¼çš„spring iocè·å–å¯¹è±¡ * */@Testpublic void test3()&#123; ApplicationContext ioc=new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); User user= (User) ioc.getBean(&quot;user&quot;);//åœ¨æ­¤å¤„æ‰“æ–­ç‚¹éªŒè¯å¯¹è±¡æ˜¯ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºçš„ã€‚ user.show();&#125; 12&lt;!-- åŸºäºxmlå½¢å¼è£…é…bean --&gt;&lt;bean id=&quot;user&quot; class=&quot;com.es.domain.User&quot;&gt;&lt;/bean&gt; 2.ç»†èŠ‚2.1 BeanFactoryå’ŒApplicationContextçš„åŒºåˆ«BeanFactory æ‰æ˜¯ Spring å®¹å™¨ä¸­çš„é¡¶å±‚æ¥å£ã€‚â€‹ ApplicationContext æ˜¯å®ƒçš„å­æ¥å£ã€‚â€‹ BeanFactory å’Œ ApplicationContext çš„åŒºåˆ«ï¼šåˆ›å»ºå¯¹è±¡çš„æ—¶é—´ç‚¹ä¸ä¸€æ ·ã€‚ ApplicationContextï¼šåªè¦ä¸€è¯»å–é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹å°±ä¼šåˆ›å»ºå¯¹è±¡ã€‚ BeanFactoryï¼šä»€ä¹ˆä½¿ç”¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºå¯¹è±¡ â€‹ 2.2 ApplicationContextæ¥å£çš„å®ç°ç±»ClasspathXmlApplicationContextï¼šä»ç±»çš„æ ¹è·¯å¾„ä¸‹åŠ è½½é…ç½®æ–‡ä»¶ï¼Œæ¨èä½¿ç”¨è¿™ç§æ–¹å¼ã€‚â€‹ FileSystemXmlApplicationContextï¼šä»ç£ç›˜è·¯å¾„ä¸ŠåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥æŒ‡å®šåœ¨ä»»æ„ä½ç½®ã€‚â€‹ AnnotationConfigApplicationContextï¼šå½“ä½¿ç”¨æ³¨è§£é…ç½®å®¹å™¨æˆ–è€…å¯¹è±¡çš„æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨æ­¤ç±»æ¥åˆ›å»º spring å®¹å™¨ï¼Œç”¨æ¥è¯»å–æ³¨è§£ã€‚â€‹ 2.3 beanæ ‡ç­¾ä½œç”¨ï¼šç”¨äºé…ç½®å¯¹è±¡è®© spring æ¥åˆ›å»ºçš„ã€‚é»˜è®¤æƒ…å†µä¸‹å®ƒè°ƒç”¨çš„æ˜¯ç±»ä¸­çš„æ— å‚æ„é€ å‡½æ•°ã€‚å¦‚æœæ²¡æœ‰æ— å‚æ„é€ å‡½æ•°åˆ™ä¸èƒ½åˆ›å»ºæˆåŠŸã€‚ å±æ€§ï¼š idï¼šç»™å¯¹è±¡åœ¨å®¹å™¨ä¸­æä¾›ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ã€‚ç”¨äºè·å–å¯¹è±¡ã€‚ classï¼šæŒ‡å®šç±»çš„å…¨é™å®šç±»åã€‚ç”¨äºåå°„åˆ›å»ºå¯¹è±¡ã€‚é»˜è®¤æƒ…å†µä¸‹è°ƒç”¨æ— å‚æ„é€ å‡½æ•°ã€‚ scopeï¼šæŒ‡å®šå¯¹è±¡çš„ä½œç”¨èŒƒå›´ã€‚ singleton :é»˜è®¤å€¼ï¼Œå•ä¾‹çš„. prototype :å¤šä¾‹çš„. request :WEB é¡¹ç›®ä¸­,Spring åˆ›å»ºä¸€ä¸ª Bean çš„å¯¹è±¡,å°†å¯¹è±¡å­˜å…¥åˆ° request åŸŸä¸­. session :WEB é¡¹ç›®ä¸­,Spring åˆ›å»ºä¸€ä¸ª Bean çš„å¯¹è±¡,å°†å¯¹è±¡å­˜å…¥åˆ° session åŸŸä¸­. global session :WEB é¡¹ç›®ä¸­,åº”ç”¨åœ¨ Portlet ç¯å¢ƒ.å¦‚æœæ²¡æœ‰ Portlet ç¯å¢ƒé‚£ä¹ˆglobalSession ç›¸å½“äº session. init-methodï¼šæŒ‡å®šç±»ä¸­çš„åˆå§‹åŒ–æ–¹æ³•åç§°ã€‚ destroy-methodï¼šæŒ‡å®šç±»ä¸­é”€æ¯æ–¹æ³•åç§°ã€‚ 2.4 beançš„ç”Ÿå‘½å‘¨æœŸå’Œä½œç”¨èŒƒå›´å•ä¾‹å¯¹è±¡ï¼šscope=&quot;singleton&quot; ä¸€ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹ã€‚å®ƒçš„ä½œç”¨èŒƒå›´å°±æ˜¯æ•´ä¸ªå¼•ç”¨ã€‚â€‹ ç”Ÿå‘½å‘¨æœŸï¼š å¯¹è±¡å‡ºç”Ÿï¼šå½“åº”ç”¨åŠ è½½ï¼Œåˆ›å»ºå®¹å™¨æ—¶ï¼Œå¯¹è±¡å°±è¢«åˆ›å»ºäº†ã€‚ å¯¹è±¡æ´»ç€ï¼šåªè¦å®¹å™¨åœ¨ï¼Œå¯¹è±¡ä¸€ç›´æ´»ç€ã€‚ å¯¹è±¡æ­»äº¡ï¼šå½“åº”ç”¨å¸è½½ï¼Œé”€æ¯å®¹å™¨æ—¶ï¼Œå¯¹è±¡å°±è¢«é”€æ¯äº†ã€‚ â€‹ å¤šä¾‹å¯¹è±¡ï¼šscope=&quot;prototype&quot; æ¯æ¬¡è®¿é—®å¯¹è±¡æ—¶ï¼Œéƒ½ä¼šé‡æ–°åˆ›å»ºå¯¹è±¡å®ä¾‹ã€‚â€‹ ç”Ÿå‘½å‘¨æœŸï¼š å¯¹è±¡å‡ºç”Ÿï¼šå½“ä½¿ç”¨å¯¹è±¡æ—¶ï¼Œåˆ›å»ºæ–°çš„å¯¹è±¡å®ä¾‹ã€‚ å¯¹è±¡æ´»ç€ï¼šåªè¦å¯¹è±¡åœ¨ä½¿ç”¨ä¸­ï¼Œå°±ä¸€ç›´æ´»ç€ã€‚ å¯¹è±¡æ­»äº¡ï¼šå½“å¯¹è±¡é•¿æ—¶é—´ä¸ç”¨æ—¶ï¼Œè¢« java çš„åƒåœ¾å›æ”¶å™¨å›æ”¶äº†ã€‚ 2.5 å®ä¾‹åŒ–beançš„ä¸‰ç§æ–¹å¼2.5.1.ä½¿ç”¨æ— å‚æ„é€ å™¨é»˜è®¤æƒ…å†µä¸‹ï¼šå®ƒä¼šæ ¹æ®é»˜è®¤æ— å‚æ„é€ å™¨æ¥åˆ›å»ºç±»å¯¹è±¡ã€‚å¦‚æœbeanä¸­æ²¡æœ‰é»˜è®¤æ— å‚æ„é€ å™¨ï¼Œå°†ä¼šåˆ›å»ºå¤±è´¥ã€‚â€‹ 1&lt;bean id=&quot;accountService&quot; class=&quot;com.itheima.service.impl.AccountServiceImpl&quot;/&gt; 2.5.2.é™æ€å·¥å‚æ­¤ç§æ–¹å¼æ˜¯ä½¿ç”¨StaticFactoryç±»ä¸­çš„é™æ€æ–¹æ³•åˆ›å»ºå¯¹è±¡ï¼Œå¹¶å­˜å…¥Springå®¹å™¨ã€‚â€‹ idå±æ€§ï¼šæŒ‡å®šbeançš„idï¼Œç”¨äºä»å®¹å™¨ä¸­è·å–ã€‚â€‹ classå±æ€§ï¼šæŒ‡å®šé™æ€å·¥å‚çš„å…¨é™å®šç±»åã€‚â€‹ factory-methodå±æ€§ï¼šæŒ‡å®šç”Ÿäº§å¯¹è±¡çš„é™æ€æ–¹æ³•ã€‚â€‹ æ¡ˆä¾‹ï¼šâ€‹ 12345678/*** æ¨¡æ‹Ÿä¸€ä¸ªé™æ€å·¥å‚ï¼Œåˆ›å»ºä¸šåŠ¡å±‚å®ç°ç±»*/public class StaticFactory &#123; public static IAccountService createAccountService()&#123; return new AccountServiceImpl(); &#125; &#125; 1&lt;bean id=&quot;accountService&quot; class=&quot;com.itheima.factory.StaticFactory&quot; factory-method=&quot;createAccountService&quot;&gt;&lt;/bean&gt; 2.5.3 å®ä¾‹å·¥å‚æ­¤ç§æ–¹å¼å…ˆæŠŠå·¥å‚çš„åˆ›å»ºäº¤ç»™springå®¹å™¨æ¥ç®¡ç†ã€‚ç„¶åå†ä½¿ç”¨å·¥å‚çš„beanæ¥è°ƒç”¨é‡Œé¢çš„æ–¹æ³•ã€‚â€‹ factory-beanå±æ€§ï¼šç”¨äºæŒ‡å®šå®ä¾‹å·¥å‚beançš„idã€‚â€‹ factory-methodå±æ€§ï¼šç”¨äºæŒ‡å®šå®ä¾‹å·¥å‚ä¸­åˆ›å»ºå¯¹è±¡çš„æ–¹æ³•ã€‚â€‹ æ¡ˆä¾‹ï¼šâ€‹ 123456789/*** æ¨¡æ‹Ÿä¸€ä¸ªå®ä¾‹å·¥å‚ï¼Œåˆ›å»ºä¸šåŠ¡å±‚å®ç°ç±»* æ­¤å·¥å‚åˆ›å»ºå¯¹è±¡ï¼Œå¿…é¡»ç°æœ‰å·¥å‚å®ä¾‹å¯¹è±¡ï¼Œå†è°ƒç”¨æ–¹æ³•*/public class InstanceFactory &#123; public IAccountService createAccountService()&#123; return new AccountServiceImpl(); &#125; &#125; 12&lt;bean id=&quot;instancFactory&quot; class=&quot;com.itheima.factory.InstanceFactory&quot;&gt;&lt;/bean&gt; &lt;bean id=&quot;accountService&quot;factory-bean=&quot;instancFactory&quot;factory- method=&quot;createAccountService&quot;&gt;&lt;/bean&gt; 3.ä¾èµ–æ³¨å…¥ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰ä»–æ˜¯springæ¡†æ¶çš„æ ¸å¿ƒï¼Œiocçš„å…·ä½“å®ç°ã€‚â€‹ ç¼–å†™ç¨‹åºçš„æ—¶å€™ï¼Œé€šè¿‡æ§åˆ¶åè½¬ï¼ŒæŠŠå¯¹è±¡çš„åˆ›å»ºäº¤ç»™springå®¹å™¨ï¼Œä½†æ˜¯ä»£ç ä¸­ä¸å¯èƒ½å‡ºç°æ²¡æœ‰ä¾èµ–çš„æƒ…å†µã€‚â€‹ iocè§£è€¦åªæ˜¯é™ä½ä»–ä»¬çš„ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯ä¸ä¼šæ¶ˆé™¤ã€‚æ¯”å¦‚æˆ‘ä»¬çš„ä¸šåŠ¡å±‚ä»ç„¶ä¼šè°ƒç”¨æŒä¹…å±‚çš„æ–¹æ³•ã€‚â€‹ é‚£ä¹ˆè¿™ç§ä¸šåŠ¡å±‚å’ŒæŒä¹…å±‚çš„ä¾èµ–å…³ç³»ï¼Œåœ¨ä½¿ç”¨springæ¡†æ¶ä¹‹åï¼Œå°±è®©springæ¥ç»´æŠ¤äº†ã€‚â€‹ ç®€å•åœ°è¯´ï¼Œå°±æ˜¯åç­‰æ¡†æ¶æŠŠæŒä¹…å±‚çš„å¯¹è±¡ä¼ å…¥ä¸šåŠ¡å±‚ï¼Œä¸éœ€è¦å¼€å‘äººå‘˜æ‰‹åŠ¨å»è·å–ã€‚â€‹ 3.1 æ„é€ å‡½æ•°æ³¨å…¥å°±æ˜¯ä½¿ç”¨ç±»ä¸­çš„æ„é€ å‡½æ•°ç»™æˆå‘˜å˜é‡èµ‹å€¼ã€‚ æ³¨æ„ï¼šèµ‹å€¼çš„æ“ä½œä¸æ˜¯æˆ‘ä»¬è‡ªå·±åšçš„ï¼Œè€Œæ˜¯é€šè¿‡é…ç½®çš„æ–¹å¼ï¼Œè®©springæ¡†æ¶æ¥ä¸ºæˆ‘ä»¬æ³¨å…¥ã€‚ â€‹ 3.2 set()æ³¨å…¥åœ¨ç±»ä¸­æä¾›éœ€è¦æ³¨å…¥çš„æˆå‘˜çš„setæ–¹æ³•ã€‚â€‹ 3.3 æ³¨å…¥é›†åˆå±æ€§ç»™ç±»ä¸­çš„é›†åˆæˆå‘˜ä¼ é€’å€¼ï¼Œä»–ç”¨çš„ä¹Ÿæ˜¯setæ–¹æ³•çš„æ³¨å…¥æ–¹å¼ï¼Œåªä¸è¿‡å˜é‡çš„æ•°æ®ç±»å‹éƒ½æ˜¯é›†åˆã€‚â€‹ 3.4 æ¡ˆä¾‹3.4.1 User123456789101112131415161718192021222324252627282930313233public class User &#123; private String name; private Integer age; private Date birth; public void setName(String name) &#123; this.name = name; &#125; public void setAge(Integer age) &#123; this.age = age; &#125; public void setBirth(Date birth) &#123; this.birth = birth; &#125; public User()&#123; System.out.println(&quot;æˆ‘è¢«åˆ›å»ºäº†...&quot;); &#125; public void show()&#123; System.out.println(&quot;userä¸­çš„showæ–¹æ³•èƒŒè°ƒç”¨äº†ã€‚ã€‚ã€‚&quot;); &#125; @Override public String toString() &#123; return &quot;User&#123;&quot; + &quot;name=&#x27;&quot; + name + &#x27;\\&#x27;&#x27; + &quot;, age=&quot; + age + &quot;, birth=&quot; + birth + &#x27;&#125;&#x27;; &#125;&#125; 3.4.2 Person1234567891011121314151617181920public class Person &#123; private String name; private int age; public Person() &#123; &#125; public Person(String name, int age) &#123; this.name = name; this.age = age; &#125; @Override public String toString() &#123; return &quot;Person&#123;&quot; + &quot;name=&#x27;&quot; + name + &#x27;\\&#x27;&#x27; + &quot;, age=&quot; + age + &#x27;&#125;&#x27;; &#125;&#125; 3.4.3 CollectionDemo1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class CollectionDemo &#123; private String [] arr; private List&lt;String&gt; myList; private Set&lt;String&gt; mySet; private Map&lt;String,String&gt; myMap; private Properties myProp; public void setArr(String[] arr) &#123; this.arr = arr; &#125; public void setMyList(List&lt;String&gt; myList) &#123; this.myList = myList; &#125; public void setMySet(Set&lt;String&gt; mySet) &#123; this.mySet = mySet; &#125; public void setMyMap(Map&lt;String, String&gt; myMap) &#123; this.myMap = myMap; &#125; public void setMyProp(Properties myProp) &#123; this.myProp = myProp; &#125; public String[] getArr() &#123; return arr; &#125; public List&lt;String&gt; getMyList() &#123; return myList; &#125; public Set&lt;String&gt; getMySet() &#123; return mySet; &#125; public Map&lt;String, String&gt; getMyMap() &#123; return myMap; &#125; public Properties getMyProp() &#123; return myProp; &#125;&#125; 3.4.4é…ç½®æ–‡ä»¶123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354&lt;!-- åŸºäºxmlå½¢å¼è£…é…bean --&gt;&lt;bean id=&quot;user&quot; class=&quot;com.es.java1.User&quot;&gt;&lt;/bean&gt;&lt;!--ä½¿ç”¨getæ–¹æ³•åˆ›å»ºbean--&gt;&lt;bean id=&quot;user2&quot; class=&quot;com.es.java1.User&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;å¼ &quot;&gt;&lt;/property&gt; &lt;property name=&quot;age&quot;&gt; &lt;value&gt;20&lt;/value&gt; &lt;/property&gt; &lt;property name=&quot;birth&quot; ref=&quot;now&quot;&gt;&lt;/property&gt;&lt;/bean&gt;&lt;bean id=&quot;now&quot; class=&quot;java.util.Date&quot;&gt;&lt;/bean&gt;&lt;!--é›†åˆå’Œæ•°ç»„ç±»å‹çš„ä¾èµ–æ³¨å…¥--&gt;&lt;bean id=&quot;demo&quot; class=&quot;com.es.java1.CollectionDemo&quot;&gt; &lt;property name=&quot;arr&quot;&gt; &lt;array&gt; &lt;value&gt;111&lt;/value&gt; &lt;value&gt;222&lt;/value&gt; &lt;value&gt;333&lt;/value&gt; &lt;/array&gt; &lt;/property&gt; &lt;property name=&quot;myList&quot;&gt; &lt;list&gt; &lt;value&gt;111&lt;/value&gt; &lt;value&gt;222&lt;/value&gt; &lt;value&gt;333&lt;/value&gt; &lt;/list&gt; &lt;/property&gt; &lt;property name=&quot;mySet&quot;&gt; &lt;set&gt; &lt;value&gt;111&lt;/value&gt; &lt;value&gt;222&lt;/value&gt; &lt;value&gt;333&lt;/value&gt; &lt;/set&gt; &lt;/property&gt; &lt;property name=&quot;myMap&quot;&gt; &lt;map&gt; &lt;entry key=&quot;aaa&quot; value=&quot;aaa&quot;&gt;&lt;/entry&gt; &lt;entry key=&quot;bbb&quot; value=&quot;bbb&quot;&gt;&lt;/entry&gt; &lt;entry key=&quot;ccc&quot; value=&quot;ccc&quot;&gt;&lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;property name=&quot;myProp&quot;&gt; &lt;props&gt; &lt;prop key=&quot;aaa&quot;&gt;aaa&lt;/prop&gt; &lt;prop key=&quot;bbb&quot;&gt;bbb&lt;/prop&gt; &lt;prop key=&quot;ccc&quot;&gt;ccc&lt;/prop&gt; &lt;/props&gt; &lt;/property&gt;&lt;/bean&gt;&lt;!--ä½¿ç”¨é»˜è®¤æ„é€ å™¨åˆ›å»ºbean--&gt;&lt;bean id=&quot;person&quot; class=&quot;com.es.java1.Person&quot;&gt; &lt;constructor-arg name=&quot;name&quot; value=&quot;å¼ &quot;&gt;&lt;/constructor-arg&gt; &lt;constructor-arg name=&quot;age&quot; value=&quot;20&quot;&gt;&lt;/constructor-arg&gt;&lt;/bean&gt; 3.4.5 æµ‹è¯•ç±»12345678910111213141516171819202122232425262728293031323334353637383940414243/** * æµ‹è¯•åŸºäºxmlå½¢å¼çš„spring iocè·å–å¯¹è±¡ * */@Testpublic void test3()&#123; ApplicationContext ioc=new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); User user= (User) ioc.getBean(&quot;user&quot;);//åœ¨æ­¤å¤„æ‰“æ–­ç‚¹éªŒè¯å¯¹è±¡æ˜¯ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºçš„ã€‚ user.show();&#125;/** * é‡‡ç”¨é»˜è®¤æ„é€ å™¨çš„å½¢å¼åˆ›å»ºbeanå¯¹è±¡ */@Testpublic void test()&#123; ApplicationContext ioc=new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); Person p= (Person) ioc.getBean(&quot;person&quot;); Person p2= (Person) ioc.getBean(&quot;person&quot;); System.out.println(p.toString());&#125;/** * ä½¿ç”¨getæ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥ */@Testpublic void test4()&#123; ApplicationContext ioc=new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); User user= (User) ioc.getBean(&quot;user2&quot;);//åœ¨æ­¤å¤„æ‰“æ–­ç‚¹éªŒè¯å¯¹è±¡æ˜¯ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºçš„ã€‚ System.out.println(user.toString());&#125;/** * é›†åˆå’Œæ•°ç»„çš„ä¾èµ–æ³¨å…¥ */@Testpublic void test5()&#123; ApplicationContext ioc=new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); CollectionDemo demo= (CollectionDemo) ioc.getBean(&quot;demo&quot;); System.out.println(Arrays.toString(demo.getArr())); System.out.println(demo.getMyList()); System.out.println(demo.getMySet()); System.out.println(demo.getMyMap()); System.out.println(demo.getMyProp());&#125; å››ï¼Œä½¿ç”¨iocå®ç°è´¦æˆ·CRUD1.åŸºäºxmlå½¢å¼1.1 å¼•ç”¨å¤–éƒ¨å±æ€§æ–‡ä»¶12345678910&lt;!-- å¼•ç”¨å¤–éƒ¨å±æ€§æ–‡ä»¶ --&gt; &lt;context:property-placeholder location=&quot;classpath:druid.properties&quot;/&gt; &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt; &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot;&gt;&lt;/property&gt; &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot;&gt;&lt;/property&gt; &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot;&gt;&lt;/property&gt; &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;driverClassName&#125;&quot;&gt;&lt;/property&gt; &lt;property name=&quot;initialSize&quot; value=&quot;$&#123;initialSize&#125;&quot;&gt;&lt;/property&gt; &lt;property name=&quot;maxActive&quot; value=&quot;$&#123;maxActive&#125;&quot;&gt;&lt;/property&gt; &lt;/bean&gt; 1.2 SPELè¡¨è¾¾å¼1.2.1 ç®€ä»‹â€‹ Spring Expression Languageï¼ŒSpringè¡¨è¾¾å¼è¯­è¨€ï¼Œç®€ç§°SpELã€‚æ”¯æŒè¿è¡Œæ—¶æŸ¥è¯¢å¹¶å¯ä»¥æ“ä½œå¯¹è±¡å›¾ã€‚â€‹ å’ŒJSPé¡µé¢ä¸Šçš„ELè¡¨è¾¾å¼ã€Struts2ä¸­ç”¨åˆ°çš„OGNLè¡¨è¾¾å¼ä¸€æ ·ï¼ŒSpELæ ¹æ®JavaBeané£æ ¼çš„getXxx()ã€setXxx()æ–¹æ³•å®šä¹‰çš„å±æ€§è®¿é—®å¯¹è±¡å›¾ï¼Œå®Œå…¨ç¬¦åˆæˆ‘ä»¬ç†Ÿæ‚‰çš„æ“ä½œä¹ æƒ¯ã€‚â€‹ 1.2.2 åŸºæœ¬è¯­æ³•â€‹ SpELä½¿ç”¨#{â€¦}ä½œä¸ºå®šç•Œç¬¦ï¼Œæ‰€æœ‰åœ¨å¤§æ¡†å·ä¸­çš„å­—ç¬¦éƒ½å°†è¢«è®¤ä¸ºæ˜¯SpELè¡¨è¾¾å¼ã€‚â€‹ 1.2.3 ä½¿ç”¨å­—é¢é‡â—æ•´æ•°ï¼š&lt;property name=&quot;count&quot; value=&quot;#&#123;5&#125;&quot;/&gt; â—å°æ•°ï¼š&lt;property name=&quot;frequency&quot; value=&quot;#&#123;89.7&#125;&quot;/&gt; â—ç§‘å­¦è®¡æ•°æ³•ï¼š&lt;property name=&quot;capacity&quot; value=&quot;#&#123;1e4&#125;&quot;/&gt; â—Stringç±»å‹çš„å­—é¢é‡å¯ä»¥ä½¿ç”¨å•å¼•å·æˆ–è€…åŒå¼•å·ä½œä¸ºå­—ç¬¦ä¸²çš„å®šç•Œç¬¦å· &lt;property name=â€nameâ€ value=&quot;#&#123;&#39;Chuck&#39;&#125;&quot;/&gt; &lt;property name=&#39;name&#39; value=&#39;#&#123;&quot;Chuck&quot;&#125;&#39;/&gt; â—Booleanï¼š&lt;property name=&quot;enabled&quot; value=&quot;#&#123;false&#125;&quot;/&gt; 1.2.4 å¼•ç”¨å…¶ä»–bean123456&lt;bean id=&quot;emp04&quot; class=&quot;com.es.parent.bean.Employee&quot;&gt; &lt;property name=&quot;empId&quot; value=&quot;1003&quot;/&gt; &lt;property name=&quot;empName&quot; value=&quot;Kate&quot;/&gt; &lt;property name=&quot;age&quot; value=&quot;21&quot;/&gt; &lt;property name=&quot;detp&quot; value=&quot;#&#123;dept&#125;&quot;/&gt;&lt;/bean&gt; 1.2.5 å¼•ç”¨å…¶ä»–beançš„å±æ€§å€¼ä½œä¸ºè‡ªå·±æŸä¸ªå±æ€§çš„å€¼123456&lt;bean id=&quot;emp05&quot; class=&quot;com.es.parent.bean.Employee&quot;&gt; &lt;property name=&quot;empId&quot; value=&quot;1003&quot;/&gt; &lt;property name=&quot;empName&quot; value=&quot;Kate&quot;/&gt; &lt;property name=&quot;age&quot; value=&quot;21&quot;/&gt; &lt;property name=&quot;deptName&quot; value=&quot;#&#123;dept.deptName&#125;&quot;/&gt;&lt;/bean&gt; 1.2.6è°ƒç”¨éé™æ€æ–¹æ³•1234567&lt;!-- åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨SpELè¡¨è¾¾å¼ä¸­è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„æ–¹æ³• --&gt;&lt;bean id=&quot;salaryGenerator&quot; class=&quot;com.es.spel.bean.SalaryGenerator&quot;/&gt;&lt;bean id=&quot;employee&quot; class=&quot;com.es.spel.bean.Employee&quot;&gt; &lt;!-- é€šè¿‡å¯¹è±¡æ–¹æ³•çš„è¿”å›å€¼ä¸ºå±æ€§èµ‹å€¼ --&gt; &lt;property name=&quot;salayOfYear&quot; value=&quot;#&#123;salaryGenerator.getSalaryOfYear(5000)&#125;&quot;/&gt;&lt;/bean&gt; 1.2.7è°ƒç”¨é™æ€æ–¹æ³•1234&lt;bean id=&quot;employee&quot; class=&quot;com.es.spel.bean.Employee&quot;&gt; &lt;!-- åœ¨SpELè¡¨è¾¾å¼ä¸­è°ƒç”¨ç±»çš„é™æ€æ–¹æ³• --&gt; &lt;property name=&quot;circle&quot; value=&quot;#&#123;T(java.lang.Math).PI*20&#125;&quot;/&gt;&lt;/bean&gt; 1.2.8 è¿ç®—ç¬¦â‘ ç®—æœ¯è¿ç®—ç¬¦ï¼š+ã€-ã€*ã€/ã€%ã€^â‘¡å­—ç¬¦ä¸²è¿æ¥ï¼š+â‘¢æ¯”è¾ƒè¿ç®—ç¬¦ï¼š&lt;ã€&gt;ã€==ã€&lt;=ã€&gt;=ã€ltã€gtã€eqã€leã€geâ‘£é€»è¾‘è¿ç®—ç¬¦ï¼šand, or, not, |â‘¤ä¸‰ç›®è¿ç®—ç¬¦ï¼šåˆ¤æ–­æ¡ä»¶?åˆ¤æ–­ç»“æœä¸ºtrueæ—¶çš„å–å€¼:åˆ¤æ–­ç»“æœä¸ºfalseæ—¶çš„å–å€¼â‘¥æ­£åˆ™è¡¨è¾¾å¼ï¼šmatchesâ€‹ 1.3 Springçš„#å’Œ$çš„åŒºåˆ«$&#123;keyåç§°&#125;ï¼šâ€‹ ç”¨æˆ·è·å–å¤–éƒ¨æ–‡ä»¶ä¸­æŒ‡å®škeyçš„å€¼ï¼› â€‹ å¯ä»¥å‡ºç°åœ¨xmlé…ç½®æ–‡ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥å‡ºç°åœ¨æ³¨è§£@Valueä¸­ï¼› â€‹ ä¸€èˆ¬ç”¨æˆ·è·å–æ•°æ®åº“é…ç½®æ–‡ä»¶çš„å†…å®¹ä¿¡æ¯ç­‰ã€‚ #&#123;è¡¨è¾¾å¼&#125;ï¼šâ€‹ SpELè¡¨è¾¾å¼çš„æ ¼å¼ï¼Œè¯¦æƒ…(https://blog.csdn.net/xingfei_work/article/details/76058178))ï¼› â€‹ å¯ä»¥å‡ºç°åœ¨xmlé…ç½®æ–‡ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥å‡ºç°åœ¨æ³¨è§£@Valueä¸­ â€‹ å¯ä»¥ä»»æ„è¡¨è¾¾å¼ï¼Œæ”¯æŒè¿ç®—ç¬¦ç­‰ã€‚ â€‹ 1.4 æ¡ˆä¾‹1.4.1 é…ç½®æ–‡ä»¶12345678910111213141516171819202122232425262728293031&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:jdbc=&quot;http://www.springframework.org/schema/jdbc&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-4.2.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.2.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.2.xsd&quot;&gt; &lt;!--è®¾ç½®è‡ªåŠ¨æ‰«æçš„åŒ…--&gt; &lt;context:component-scan base-package=&quot;com.es&quot;&gt;&lt;/context:component-scan&gt; &lt;bean id=&quot;accountDao&quot; class=&quot;com.es.dao.impl.AccountDaoImpl&quot;&gt; &lt;property name=&quot;runner&quot; ref=&quot;runner&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;bean id=&quot;accountService&quot; class=&quot;com.es.service.impl.AccountServiceImpl&quot;&gt; &lt;property name=&quot;accountDao&quot; ref=&quot;accountDao&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;bean id=&quot;account&quot; class=&quot;com.es.domain.Account&quot;&gt;&lt;/bean&gt; &lt;bean id=&quot;runner&quot; class=&quot;org.apache.commons.dbutils.QueryRunner&quot; scope=&quot;prototype&quot;&gt; &lt;constructor-arg name=&quot;ds&quot; ref=&quot;dataSource&quot;&gt;&lt;/constructor-arg&gt; &lt;/bean&gt; &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt; &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/eesy&quot;&gt;&lt;/property&gt; &lt;property name=&quot;username&quot; value=&quot;root&quot;&gt;&lt;/property&gt; &lt;property name=&quot;password&quot; value=&quot;yhd666&quot;&gt;&lt;/property&gt; &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;&gt;&lt;/property&gt; &lt;/bean&gt;&lt;/beans&gt; 1.4.2 æŒä¹…å±‚12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970package com.es.dao.impl;import com.es.dao.IAccountDao;import com.es.domain.Account;import org.apache.commons.dbutils.QueryRunner;import org.apache.commons.dbutils.handlers.BeanHandler;import org.apache.commons.dbutils.handlers.BeanListHandler;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Repository;import java.util.List;/** * è´¦æˆ·çš„æŒä¹…å±‚å®ç°ç±» */public class AccountDaoImpl implements IAccountDao &#123; private QueryRunner runner; public void setRunner(QueryRunner runner) &#123; this.runner = runner; &#125; public List&lt;Account&gt; findAllAccount() &#123; try&#123; return runner.query(&quot;select * from account&quot;,new BeanListHandler&lt;Account&gt;(Account.class)); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public Account findAccountById(Integer accountId) &#123; try&#123; return runner.query(&quot;select * from account where id = ? &quot;,new BeanHandler&lt;Account&gt;(Account.class),accountId); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public void saveAccount(Account account) &#123; try&#123; runner.update(&quot;insert into account(name,money)values(?,?)&quot;,account.getName(),account.getMoney()); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public void updateAccount(Account account) &#123; try&#123; runner.update(&quot;update account set name=?,money=? where id=?&quot;,account.getName(),account.getMoney(),account.getId()); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public void deleteAccount(Integer accountId) &#123; try&#123; runner.update(&quot;delete from account where id=?&quot;,accountId); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125;&#125; 1.4.3 ä¸šåŠ¡å±‚12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849package com.es.service.impl;import com.es.dao.IAccountDao;import com.es.domain.Account;import com.es.domain.Account;import com.es.service.IAccountService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import java.util.List;/** * è´¦æˆ·çš„ä¸šåŠ¡å±‚å®ç°ç±» */public class AccountServiceImpl implements IAccountService&#123; private IAccountDao accountDao; public void setAccountDao(IAccountDao accountDao) &#123; this.accountDao = accountDao; &#125; public List&lt;Account&gt; findAllAccount() &#123; return accountDao.findAllAccount(); &#125; public Account findAccountById(Integer accountId) &#123; return accountDao.findAccountById(accountId); &#125; public void saveAccount(Account account) &#123; accountDao.saveAccount(account); &#125; public void updateAccount(Account account) &#123; accountDao.updateAccount(account); &#125; public void deleteAccount(Integer acccountId) &#123; accountDao.deleteAccount(acccountId); &#125;&#125; 1.4.4 æµ‹è¯•ç±»12345678public class Test1 &#123; ApplicationContext ioc=new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); @Test public void test1()&#123; IAccountService service= (IAccountService) ioc.getBean(&quot;accountService&quot;); service.deleteAccount(2); &#125;&#125; 2.xmlå’Œæ³¨è§£æ··æ­2.1 ç”¨äºåˆ›å»ºå¯¹è±¡ä»–ä»¬çš„ä½œç”¨å°±å’Œåœ¨XMLé…ç½®æ–‡ä»¶ä¸­ç¼–å†™ä¸€ä¸ªæ ‡ç­¾å®ç°çš„åŠŸèƒ½æ˜¯ä¸€æ ·çš„ã€‚ â€‹Component: ä½œç”¨ï¼šç”¨äºæŠŠå½“å‰ç±»å¯¹è±¡å­˜å…¥springå®¹å™¨ä¸­ å±æ€§ï¼š valueï¼šç”¨äºæŒ‡å®šbeançš„idã€‚å½“æˆ‘ä»¬ä¸å†™æ—¶ï¼Œå®ƒçš„é»˜è®¤å€¼æ˜¯å½“å‰ç±»åï¼Œä¸”é¦–å­—æ¯æ”¹å°å†™ã€‚ â€‹Controllerï¼šä¸€èˆ¬ç”¨åœ¨è¡¨ç°å±‚ â€‹Serviceï¼šä¸€èˆ¬ç”¨åœ¨ä¸šåŠ¡å±‚ â€‹Repositoryï¼šä¸€èˆ¬ç”¨åœ¨æŒä¹…å±‚ â€‹ ä»¥ä¸Šä¸ªæ³¨è§£ä»–ä»¬çš„ä½œç”¨å’Œå±æ€§ä¸Componentæ˜¯ä¸€æ¨¡ä¸€æ ·ã€‚â€‹ ä»–ä»¬æ˜¯springæ¡†æ¶ä¸ºæˆ‘ä»¬æä¾›æ˜ç¡®çš„å±‚ä½¿ç”¨çš„æ³¨è§£ï¼Œä½¿æˆ‘ä»¬çš„å±‚å¯¹è±¡æ›´åŠ æ¸…æ™°ã€‚â€‹ 2.2 ç”¨äºæ³¨å…¥æ•°æ®ä»–ä»¬çš„ä½œç”¨å°±å’Œåœ¨xmlé…ç½®æ–‡ä»¶ä¸­çš„beanæ ‡ç­¾ä¸­å†™ä¸€ä¸ªæ ‡ç­¾çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ã€‚ Autowired: ä½œç”¨ï¼šè‡ªåŠ¨ç…§ç±»å‹æ³¨å…¥ã€‚åªè¦å®¹å™¨ä¸­å”¯ä¸€çš„ä¸€ä¸ªbeanå¯¹è±¡ç±»å‹å’Œè¦æ³¨å…¥çš„å˜é‡ç±»å‹åŒ¹é…ï¼Œå°±å¯ä»¥æ³¨å…¥æˆåŠŸ å¦‚æœiocå®¹å™¨ä¸­æ²¡ä»»ä½•beançš„ç±»å‹å’Œè¦æ³¨å…¥çš„å˜é‡ç±»å‹åŒ¹é…ï¼Œåˆ™æŠ¥é”™ã€‚ å¦‚æœIocå®¹å™¨ä¸­å¤šä¸ªç±»å‹åŒ¹é…æ—¶ï¼š å‡ºç°ä½ç½®ï¼š å¯ä»¥æ˜¯å˜é‡ä¸Šï¼Œä¹Ÿå¯ä»¥æ˜¯æ–¹æ³•ä¸Š ç»†èŠ‚ï¼š åœ¨ä½¿ç”¨æ³¨è§£æ³¨å…¥æ—¶ï¼Œsetæ–¹æ³•å°±ä¸æ˜¯å¿…é¡»çš„äº†ã€‚ â€‹Qualifier: ä½œç”¨ï¼šåœ¨ç…§ç±»å‹æ³¨å…¥çš„åŸºç¡€ä¹‹ä¸Šå†ç…§åç§°æ³¨å…¥ã€‚å®ƒåœ¨ç»™ç±»æˆå‘˜æ³¨å…¥æ—¶ä¸èƒ½å•ç‹¬ä½¿ç”¨ã€‚ä½†æ˜¯åœ¨ç»™æ–¹æ³•å‚æ•°æ³¨å…¥æ—¶å¯ä»¥ å±æ€§ï¼š valueï¼šç”¨äºæŒ‡å®šæ³¨å…¥beançš„idã€‚ â€‹Resource ä½œç”¨ï¼šç›´æ¥ç…§beançš„idæ³¨å…¥ã€‚å®ƒå¯ä»¥ç‹¬ç«‹ä½¿ç”¨ å±æ€§ï¼š nameï¼šç”¨äºæŒ‡å®šbeançš„idã€‚ä»¥ä¸Šä¸ªæ³¨å…¥éƒ½åªèƒ½æ³¨å…¥å…¶ä»–beanç±»å‹çš„æ•°æ®ï¼Œè€ŒåŸºæœ¬ç±»å‹å’ŒStringç±»å‹æ— æ³•ä½¿ç”¨ä¸Šè¿°æ³¨è§£å®ç°ã€‚å¦å¤–ï¼Œé›†åˆç±»å‹çš„æ³¨å…¥åªèƒ½é€šè¿‡XMLæ¥å®ç°ã€‚â€‹ â€‹Value ä½œç”¨ï¼šç”¨äºæ³¨å…¥åŸºæœ¬ç±»å‹å’ŒStringç±»å‹çš„æ•°æ® å±æ€§ï¼š valueï¼šç”¨äºæŒ‡å®šæ•°æ®çš„å€¼ã€‚å®ƒå¯ä»¥ä½¿ç”¨springä¸­SpEL(ä¹Ÿå°±æ˜¯springçš„elè¡¨è¾¾å¼ï¼ŒSpELçš„å†™æ³•ï¼š${è¡¨è¾¾å¼}â€‹ 2.3.ç”¨äºæ”¹å˜ä½œç”¨èŒƒå›´ä»–ä»¬çš„ä½œç”¨å°±å’Œåœ¨beanæ ‡ç­¾ä¸­ä½¿ç”¨scopeå±æ€§å®ç°çš„åŠŸèƒ½æ˜¯ä¸€æ ·çš„ã€‚ â€‹Scope ä½œç”¨ï¼šç”¨äºæŒ‡å®šbeançš„ä½œç”¨èŒƒå›´ å±æ€§ï¼š valueï¼šæŒ‡å®šèŒƒå›´çš„å–å€¼ã€‚å¸¸ç”¨å–å€¼ï¼šsingleton prototypeâ€‹ 2.4 å’Œç”Ÿå‘½å‘¨æœŸç›¸å…³ä»–ä»¬çš„ä½œç”¨å°±å’Œåœ¨beanæ ‡ç­¾ä¸­ä½¿ç”¨init-methodå’Œdestroy-methodeçš„ä½œç”¨æ˜¯ä¸€æ ·çš„ã€‚â€‹ â€‹PreDestroy ä½œç”¨ï¼šç”¨äºæŒ‡å®šé”€æ¯æ–¹æ³• â€‹PostConstruct ä½œç”¨ï¼šç”¨äºæŒ‡å®šåˆå§‹åŒ–æ–¹æ³•â€‹ 2.5 æ¡ˆä¾‹2.5.1 é…ç½®æ–‡ä»¶123456789101112131415161718192021222324&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:jdbc=&quot;http://www.springframework.org/schema/jdbc&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-4.2.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.2.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.2.xsd&quot;&gt; &lt;!--è®¾ç½®è‡ªåŠ¨æ‰«æçš„åŒ…--&gt; &lt;context:component-scan base-package=&quot;com.es&quot;&gt;&lt;/context:component-scan&gt; &lt;bean id=&quot;runner&quot; class=&quot;org.apache.commons.dbutils.QueryRunner&quot; scope=&quot;prototype&quot;&gt; &lt;constructor-arg name=&quot;ds&quot; ref=&quot;dataSource&quot;&gt;&lt;/constructor-arg&gt; &lt;/bean&gt; &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt; &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/eesy&quot;&gt;&lt;/property&gt; &lt;property name=&quot;username&quot; value=&quot;root&quot;&gt;&lt;/property&gt; &lt;property name=&quot;password&quot; value=&quot;yhd666&quot;&gt;&lt;/property&gt; &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;&gt;&lt;/property&gt; &lt;/bean&gt;&lt;/beans&gt; 2.5.2 æŒä¹…å±‚1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768package com.es.dao.impl;import com.es.dao.IAccountDao;import com.es.domain.Account;import org.apache.commons.dbutils.QueryRunner;import org.apache.commons.dbutils.handlers.BeanHandler;import org.apache.commons.dbutils.handlers.BeanListHandler;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Repository;import java.util.List;/** * è´¦æˆ·çš„æŒä¹…å±‚å®ç°ç±» */@Repository(value = &quot;accountDao&quot;)public class AccountDaoImpl implements IAccountDao &#123; @Autowired private QueryRunner runner; public List&lt;Account&gt; findAllAccount() &#123; try&#123; return runner.query(&quot;select * from account&quot;,new BeanListHandler&lt;Account&gt;(Account.class)); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public Account findAccountById(Integer accountId) &#123; try&#123; return runner.query(&quot;select * from account where id = ? &quot;,new BeanHandler&lt;Account&gt;(Account.class),accountId); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public void saveAccount(Account account) &#123; try&#123; runner.update(&quot;insert into account(name,money)values(?,?)&quot;,account.getName(),account.getMoney()); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public void updateAccount(Account account) &#123; try&#123; runner.update(&quot;update account set name=?,money=? where id=?&quot;,account.getName(),account.getMoney(),account.getId()); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public void deleteAccount(Integer accountId) &#123; try&#123; runner.update(&quot;delete from account where id=?&quot;,accountId); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125;&#125; 2.5.3 ä¸šåŠ¡å±‚1234567891011121314151617181920212223242526272829303132333435363738394041424344package com.es.service.impl;import com.es.dao.IAccountDao;import com.es.domain.Account;import com.es.domain.Account;import com.es.service.IAccountService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import java.util.List;/** * è´¦æˆ·çš„ä¸šåŠ¡å±‚å®ç°ç±» */@Service(&quot;accountService&quot;)public class AccountServiceImpl implements IAccountService&#123; @Autowired private IAccountDao accountDao; public List&lt;Account&gt; findAllAccount() &#123; return accountDao.findAllAccount(); &#125; public Account findAccountById(Integer accountId) &#123; return accountDao.findAccountById(accountId); &#125; public void saveAccount(Account account) &#123; accountDao.saveAccount(account); &#125; public void updateAccount(Account account) &#123; accountDao.updateAccount(account); &#125; public void deleteAccount(Integer acccountId) &#123; accountDao.deleteAccount(acccountId); &#125;&#125; 2.5.4 æµ‹è¯•ç±»1234567891011121314151617import com.es.service.IAccountService;import org.junit.Test;import org.springframework.context.ApplicationContext;import org.springframework.context.support.ClassPathXmlApplicationContext;/** * @author yinhuidong * @createTime 2020-03-01-11:03 */public class Test1 &#123; ApplicationContext ioc=new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); @Test public void test1()&#123; IAccountService service= (IAccountService) ioc.getBean(&quot;accountService&quot;); service.deleteAccount(2); &#125;&#125; 3.çº¯æ³¨è§£é…ç½®3.1 æ³¨è§£ â€‹Configuration ä½œç”¨ï¼šæŒ‡å®šå½“å‰ç±»æ˜¯ä¸€ä¸ªé…ç½®ç±»ç»†èŠ‚ï¼šå½“é…ç½®ç±»ä½œä¸ºAnnotationConfigApplicationContextå¯¹è±¡åˆ›å»ºçš„å‚æ•°æ—¶ï¼Œè¯¥æ³¨è§£å¯ä»¥ä¸å†™ã€‚ â€‹ComponentScan ä½œç”¨ï¼šç”¨äºé€šè¿‡æ³¨è§£æŒ‡å®šspringåœ¨åˆ›å»ºå®¹å™¨æ—¶è¦æ‰«æçš„åŒ…å±æ€§ï¼š valueï¼šå®ƒå’ŒbasePackagesçš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ç”¨äºæŒ‡å®šåˆ›å»ºå®¹å™¨æ—¶è¦æ‰«æçš„åŒ…ã€‚ æˆ‘ä»¬ä½¿ç”¨æ­¤æ³¨è§£å°±ç­‰åŒäºåœ¨xmlä¸­é…ç½®äº†: &lt;context:component-scan base-package=&quot;com.itheima&quot;&gt;&lt;/context:component-scan&gt; â€‹Bean ä½œç”¨ï¼šç”¨äºæŠŠå½“å‰æ–¹æ³•çš„è¿”å›å€¼ä½œä¸ºbeanå¯¹è±¡å­˜å…¥springçš„iocå®¹å™¨ä¸­å±æ€§: name:ç”¨äºæŒ‡å®šbeançš„idã€‚å½“ä¸å†™æ—¶ï¼Œé»˜è®¤å€¼æ˜¯å½“å‰æ–¹æ³•çš„åç§°ç»†èŠ‚ï¼š å½“æˆ‘ä»¬ä½¿ç”¨æ³¨è§£é…ç½®æ–¹æ³•æ—¶ï¼Œå¦‚æœæœ‰æ–¹æ³•å‚æ•°ï¼Œspringæ¡†æ¶ä¼šå»å®¹å™¨ä¸­æŸ¥æ‰¾æ²¡å¯ç”¨çš„beanå¯¹è±¡ã€‚ æŸ¥æ‰¾çš„æ–¹å¼å’ŒAutowiredæ³¨è§£çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ â€‹Import ä½œç”¨ï¼šç”¨äºå¯¼å…¥å…¶ä»–çš„é…ç½®ç±» å±æ€§ï¼š valueï¼šç”¨äºæŒ‡å®šå…¶ä»–é…ç½®ç±»çš„å­—èŠ‚ç ã€‚ å½“æˆ‘ä»¬ä½¿ç”¨Importçš„æ³¨è§£ä¹‹åï¼ŒImportæ³¨è§£çš„ç±»å°±çˆ¶é…ç½®ç±»ï¼Œè€Œå¯¼å…¥çš„éƒ½æ˜¯å­é…ç½®ç±» â€‹PropertySource ä½œç”¨ï¼šç”¨äºæŒ‡å®špropertiesæ–‡ä»¶çš„ä½ç½® å±æ€§ï¼š valueï¼šæŒ‡å®šæ–‡ä»¶çš„åç§°å’Œè·¯å¾„ã€‚ å…³é”®å­—ï¼šclasspathï¼Œè¡¨ç¤ºç±»è·¯å¾„ä¸‹ â€‹ 3.2 springæ•´åˆjunit4123456789101112131415161718192021222324252627/**1ã€åº”ç”¨ç¨‹åºçš„å…¥å£ mainæ–¹æ³•2ã€junitå•å…ƒæµ‹è¯•ä¸­ï¼Œæ²¡æœ‰mainæ–¹æ³•ä¹Ÿèƒ½æ‰§è¡Œ junité›†æˆäº†ä¸€ä¸ªmainæ–¹æ³• è¯¥æ–¹æ³•å°±ä¼šåˆ¤æ–­å½“å‰æµ‹è¯•ç±»ä¸­å“ªäº›æ–¹æ³•æœ‰ @Testæ³¨è§£ junitå°±è®©æœ‰Testæ³¨è§£çš„æ–¹æ³•æ‰§è¡Œ3ã€junitä¸ä¼šç®¡æˆ‘ä»¬æ˜¯å¦é‡‡ç”¨springæ¡†æ¶ åœ¨æ‰§è¡Œæµ‹è¯•æ–¹æ³•æ—¶ï¼Œjunitæ ¹æœ¬ä¸çŸ¥é“æˆ‘ä»¬æ˜¯ä¸æ˜¯ä½¿ç”¨äº†springæ¡†æ¶ æ‰€ä»¥ä¹Ÿå°±ä¸ä¼šä¸ºæˆ‘ä»¬è¯»å–é…ç½®æ–‡ä»¶/é…ç½®ç±»åˆ›å»ºspringæ ¸å¿ƒå®¹å™¨4ã€ç”±ä»¥ä¸Šä¸‰ç‚¹å¯çŸ¥ å½“æµ‹è¯•æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œæ²¡æœ‰Iocå®¹å™¨ï¼Œå°±ç®—å†™äº†Autowiredæ³¨è§£ï¼Œä¹Ÿæ— æ³•å®ç°æ³¨å…¥------------------------------------------------------------------------- * ä½¿ç”¨Junitå•å…ƒæµ‹è¯•ï¼šæµ‹è¯•æˆ‘ä»¬çš„é…ç½® * Springæ•´åˆjunitçš„é…ç½® * 1ã€å¯¼å…¥springæ•´åˆjunitçš„jar(åæ ‡) * 2ã€ä½¿ç”¨Junitæä¾›çš„ä¸€ä¸ªæ³¨è§£æŠŠåŸæœ‰çš„mainæ–¹æ³•æ›¿æ¢äº†ï¼Œæ›¿æ¢æˆspringæä¾›çš„ * @Runwith(SpringJUnit4ClassRunner.class) * 3ã€å‘ŠçŸ¥springçš„è¿è¡Œå™¨ï¼Œspringå’Œiocåˆ›å»ºæ˜¯åŸºäºxmlè¿˜æ˜¯æ³¨è§£çš„ï¼Œå¹¶ä¸”è¯´æ˜ä½ç½® * @ContextConfiguration * locationsï¼šæŒ‡å®šxmlæ–‡ä»¶çš„ä½ç½®ï¼ŒåŠ ä¸Šclasspathå…³é”®å­—ï¼Œè¡¨ç¤ºåœ¨ç±»è·¯å¾„ä¸‹ * classesï¼šæŒ‡å®šæ³¨è§£ç±»æ‰€åœ¨åœ°ä½ç½® * * å½“æˆ‘ä»¬ä½¿ç”¨spring 5.xç‰ˆæœ¬çš„æ—¶å€™ï¼Œè¦æ±‚junitçš„jarå¿…é¡»æ˜¯4.12åŠä»¥ä¸Š */ 3.3 æ¡ˆä¾‹3.3.1 é…ç½®ç±»1234567891011/** * @author yinhuidong * @createTime 2020-03-01-16:43 */@Configuration@ComponentScan(&quot;com.es&quot;)@Import(JdbcConfig.class)@PropertySource(&quot;classpath:c3p0.properties&quot;)public class SpringConfig &#123;&#125; 3.3.2 é…ç½®å­ç±»123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051/** * @author yinhuidong * @createTime 2020-03-01-16:56 */public class JdbcConfig &#123; @Bean(name=&quot;runner&quot;) @Scope(value = &quot;prototype&quot;) public QueryRunner getRunner(@Qualifier(&quot;ds1&quot;) DataSource dataSource) &#123; QueryRunner runner = new QueryRunner(dataSource); return runner; &#125; private static DataSource dataSource = null; @Bean(name=&quot;ds1&quot;) public DataSource getDataSource() &#123; try &#123; Properties prop = new Properties(); InputStream is = JdbcConfig.class.getClassLoader().getResourceAsStream(&quot;jdbc.properties&quot;); prop.load(is); dataSource = DruidDataSourceFactory.createDataSource(prop); return dataSource; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return null; &#125; @Value(&quot;$&#123;jdbc.driver&#125;&quot;) private String driver; @Value(&quot;$&#123;jdbc.url&#125;&quot;) private String url; @Value(&quot;$&#123;jdbc.username&#125;&quot;) private String username; @Value(&quot;$&#123;jdbc.password&#125;&quot;) private String password; @Bean(name=&quot;ds2&quot;) public DataSource getDataSource2()&#123; try &#123; ComboPooledDataSource dataSource=new ComboPooledDataSource(); dataSource.setDriverClass(driver); dataSource.setJdbcUrl(url); dataSource.setUser(username); dataSource.setPassword(password); return dataSource; &#125; catch (PropertyVetoException e) &#123; e.printStackTrace(); &#125; return null; &#125;&#125; 3.3.3 æµ‹è¯•ç±»1234567891011@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration(classes = com.es.java1.SpringConfig.class)public class Test1 &#123; @Autowired private IAccountService service = null; @Test public void test1() &#123; service.deleteAccount(5); &#125;&#125; äº”ï¼ŒAOPé¢å‘åˆ‡é¢ç¼–ç¨‹1.åŠ¨æ€ä»£ç†1.1 åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859public class Test1 &#123; @Test public void test1()&#123; //è¢«ä»£ç†ç±»å¯¹è±¡è¦å£°æ˜ä¸ºæœ€ç»ˆçš„ final Producer producer=new Producer(); /** * åŠ¨æ€ä»£ç†ï¼š * ç‰¹ç‚¹ï¼šå­—èŠ‚ç éšç”¨éšåˆ›å»ºï¼Œéšç”¨éšåŠ è½½ * ä½œç”¨ï¼šä¸ä¿®æ”¹æºç çš„åŸºç¡€ä¸Šå¯¹æ–¹æ³•å¢å¼º * åˆ†ç±»ï¼š * åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç† * åŸºäºå­ç±»çš„åŠ¨æ€ä»£ç† * åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†ï¼š * æ¶‰åŠçš„ç±»ï¼šProxy * æä¾›è€…ï¼šJDKå®˜æ–¹ * å¦‚ä½•åˆ›å»ºä»£ç†å¯¹è±¡ï¼š * ä½¿ç”¨Proxyç±»ä¸­çš„newProxyInstanceæ–¹æ³• * åˆ›å»ºä»£ç†å¯¹è±¡çš„è¦æ±‚ï¼š * è¢«ä»£ç†ç±»æœ€å°‘å®ç°ä¸€ä¸ªæ¥å£ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸èƒ½ä½¿ç”¨ * newProxyInstanceæ–¹æ³•çš„å‚æ•°ï¼š * ClassLoaderï¼šç±»åŠ è½½å™¨ * å®ƒæ˜¯ç”¨äºåŠ è½½ä»£ç†å¯¹è±¡å­—èŠ‚ç çš„ã€‚å’Œè¢«ä»£ç†å¯¹è±¡ä½¿ç”¨ç›¸åŒçš„ç±»åŠ è½½å™¨ã€‚å›ºå®šå†™æ³•ã€‚ * Class[]ï¼šå­—èŠ‚ç æ•°ç»„ * å®ƒæ˜¯ç”¨äºè®©ä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†å¯¹è±¡ç›¸åŒæ–¹æ³•ã€‚å›ºå®šå†™æ³•ã€‚ * InvocationHandlerï¼šç”¨äºæä¾›å¢å¼ºçš„ä»£ç  * å®ƒæ˜¯è®©æˆ‘ä»¬å†™å¦‚ä½•ä»£ç†ã€‚æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯äº›ä¸€ä¸ªè¯¥æ¥å£çš„å®ç°ç±»ï¼Œé€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯åŒ¿åå†…éƒ¨ç±»ï¼Œä½†ä¸æ˜¯å¿…é¡»çš„ã€‚ * æ­¤æ¥å£çš„å®ç°ç±»éƒ½æ˜¯è°ç”¨è°å†™ã€‚ */ //ä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†ç±»å¯¹è±¡è¦å®ç°åŒä¸€ä¸ªæ¥å£ IProducer proxyProducer = (IProducer) Proxy.newProxyInstance(producer.getClass().getClassLoader(), producer.getClass().getInterfaces(), new InvocationHandler() &#123; /** * ä½œç”¨ï¼šæ‰§è¡Œè¢«ä»£ç†å¯¹è±¡çš„ä»»ä½•æ¥å£æ–¹æ³•éƒ½ä¼šç»è¿‡è¯¥æ–¹æ³• * æ–¹æ³•å‚æ•°çš„å«ä¹‰ * @param proxy ä»£ç†å¯¹è±¡çš„å¼•ç”¨ * 1. å¯ä»¥ä½¿ç”¨åå°„è·å–ä»£ç†å¯¹è±¡çš„ä¿¡æ¯ï¼ˆä¹Ÿå°±æ˜¯proxy.getClass().getName()ã€‚ * 2. å¯ä»¥å°†ä»£ç†å¯¹è±¡è¿”å›ä»¥è¿›è¡Œè¿ç»­è°ƒç”¨ï¼Œè¿™å°±æ˜¯proxyå­˜åœ¨çš„ç›®çš„ï¼Œå› ä¸ºthiså¹¶ä¸æ˜¯ä»£ç†å¯¹è±¡ã€‚ * @param method å½“å‰æ‰§è¡Œçš„æ–¹æ³• * @param args å½“å‰æ‰§è¡Œæ–¹æ³•æ‰€éœ€çš„å‚æ•° * @return å’Œè¢«ä»£ç†å¯¹è±¡æ–¹æ³•ç›¸åŒçš„è¿”å›å€¼ * @throws Throwable */ public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; Object value=null; //è·å–æ–¹æ³•æ‰§è¡Œçš„å‚æ•° //åˆ¤æ–­å½“å‰æ–¹æ³•æ˜¯ä¸æ˜¯é”€å”® if (&quot;saleProduct&quot;.equals(method.getName()))&#123; Float money= (Float) args[0]; //ä¸¤ä¸ªå‚æ•°ï¼šè¢«ä»£ç†ç±»å¯¹è±¡ï¼Œæ–¹æ³•å¢å¼ºçš„å‚æ•° value=method.invoke(producer,money*0.8f); &#125; return value; &#125; &#125;); proxyProducer.saleProduct(10000f); &#125;&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243package com.es.java1;/** * ä¸€ä¸ªç”Ÿäº§è€… */public class Producer implements IProducer&#123; /** * é”€å”® * @param money */ public void saleProduct(float money)&#123; System.out.println(&quot;é”€å”®äº§å“ï¼Œå¹¶æ‹¿åˆ°é’±ï¼š&quot;+money); &#125; /** * å”®å * @param money */ public void afterService(float money)&#123; System.out.println(&quot;æä¾›å”®åæœåŠ¡ï¼Œå¹¶æ‹¿åˆ°é’±ï¼š&quot;+money); &#125;&#125;-------------------------------------------------------------------/** * å¯¹ç”Ÿäº§å‚å®¶è¦æ±‚çš„æ¥å£ */public interface IProducer &#123; /** * é”€å”® * @param money */ public void saleProduct(float money); /** * å”®å * @param money */ public void afterService(float money);&#125; 1.2 åŸºäºå­ç±»çš„åŠ¨æ€ä»£ç†123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657/** * @author yinhuidong * @createTime 2020-03-02-1:08 */public class Test4 &#123; @Test public void test() &#123; final Producer producer = new Producer(); /** * åŠ¨æ€ä»£ç†ï¼š * ç‰¹ç‚¹ï¼šå­—èŠ‚ç éšç”¨éšåˆ›å»ºï¼Œéšç”¨éšåŠ è½½ * ä½œç”¨ï¼šä¸ä¿®æ”¹æºç çš„åŸºç¡€ä¸Šå¯¹æ–¹æ³•å¢å¼º * åˆ†ç±»ï¼š * åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç† * åŸºäºå­ç±»çš„åŠ¨æ€ä»£ç† * åŸºäºå­ç±»çš„åŠ¨æ€ä»£ç†ï¼š * æ¶‰åŠçš„ç±»ï¼šEnhancer * æä¾›è€…ï¼šç¬¬æ–¹cglibåº“ * å¦‚ä½•åˆ›å»ºä»£ç†å¯¹è±¡ï¼š * ä½¿ç”¨Enhancerç±»ä¸­çš„createæ–¹æ³• * åˆ›å»ºä»£ç†å¯¹è±¡çš„è¦æ±‚ï¼š * è¢«ä»£ç†ç±»æ˜¯æœ€ç»ˆç±» * createæ–¹æ³•çš„å‚æ•°ï¼š * Classï¼šå­—èŠ‚ç  * å®ƒæ˜¯ç”¨äºæŒ‡å®šè¢«ä»£ç†å¯¹è±¡çš„å­—èŠ‚ç ã€‚ * * Callbackï¼šç”¨äºæä¾›å¢å¼ºçš„ä»£ç  * å®ƒæ˜¯è®©æˆ‘ä»¬å†™å¦‚ä½•ä»£ç†ã€‚æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯äº›ä¸€ä¸ªè¯¥æ¥å£çš„å®ç°ç±»ï¼Œé€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯åŒ¿åå†…éƒ¨ç±»ï¼Œä½†ä¸æ˜¯å¿…é¡»çš„ã€‚ * æ­¤æ¥å£çš„å®ç°ç±»éƒ½æ˜¯è°ç”¨è°å†™ã€‚ * æˆ‘ä»¬ä¸€èˆ¬å†™çš„éƒ½æ˜¯è¯¥æ¥å£çš„å­æ¥å£å®ç°ç±»ï¼šMethodInterceptor */ Producer cglibProducer = (Producer) Enhancer.create(producer.getClass(), new MethodInterceptor() &#123; /** * æ‰§è¡Œè¢«ä»£ç†å¯¹è±¡çš„ä»»ä½•æ–¹æ³•éƒ½ä¼šç»è¿‡è¯¥æ–¹æ³• * @param proxy * @param method * @param args * ä»¥ä¸Šä¸ªå‚æ•°å’ŒåŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†ä¸­invokeæ–¹æ³•çš„å‚æ•°æ˜¯ä¸€æ ·çš„ * @param methodProxy ï¼šå½“å‰æ‰§è¡Œæ–¹æ³•çš„ä»£ç†å¯¹è±¡ * @return * @throws Throwable */ public Object intercept(Object proxy, Method method, Object[] args, MethodProxy methodProxy) throws Throwable &#123; //æä¾›å¢å¼ºçš„ä»£ç  Object returnValue = null; //1.è·å–æ–¹æ³•æ‰§è¡Œçš„å‚æ•° Float money = (Float) args[0]; //2.åˆ¤æ–­å½“å‰æ–¹æ³•æ˜¯ä¸æ˜¯é”€å”® if (&quot;saleProduct&quot;.equals(method.getName())) &#123; returnValue = method.invoke(producer, money * 0.8f); &#125; return returnValue; &#125; &#125;); cglibProducer.saleProduct(12000f); &#125;&#125; 1234567891011121314151617181920212223package com.es.java2;/** * ä¸€ä¸ªç”Ÿäº§è€… */public class Producer &#123; /** * é”€å”® * @param money */ public void saleProduct(float money)&#123; System.out.println(&quot;é”€å”®äº§å“ï¼Œå¹¶æ‹¿åˆ°é’±ï¼š&quot;+money); &#125; /** * å”®å * @param money */ public void afterService(float money)&#123; System.out.println(&quot;æä¾›å”®åæœåŠ¡ï¼Œå¹¶æ‹¿åˆ°é’±ï¼š&quot;+money); &#125;&#125; 1.3 ä½¿ç”¨åŠ¨æ€ä»£ç†å¯¹springè¿›è¡Œæ–¹æ³•å¢å¼ºæ¥å£å’Œå®ç°ç±» 12345678910111213141516171819202122public interface MyInterface &#123; public int add(int a,int b); public int del(int a,int b); public int che(int a,int b); public int div(int a,int b);&#125;----------------------------------------------------------public class java1 implements MyInterface&#123; public int add(int a,int b)&#123; return a+b; &#125; public int del(int a,int b)&#123; return a-b; &#125; public int che(int a,int b)&#123; return a*b; &#125; public int div(int a,int b)&#123; return a/b; &#125;&#125; BeanFactory 123456789101112131415161718192021222324public class BeanFactory &#123; private java1 java; public void setJava(java1 java) &#123; this.java = java; &#125; public MyInterface getBean()&#123; MyInterface proxyJava = (MyInterface) Proxy.newProxyInstance( java.getClass().getClassLoader(), java.getClass().getInterfaces(), new InvocationHandler() &#123; public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; Object value = null; System.out.println(&quot;æ–¹æ³•æ‰§è¡Œå‰....&quot;); value = method.invoke(java, args); System.out.println(&quot;æ–¹æ³•æ‰§è¡Œä¹‹å....&quot;); return value; &#125; &#125; ); return proxyJava; &#125;&#125; æµ‹è¯•ç±» 1234567891011121314151617181920212223@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration(&quot;classpath:applicationContext.xml&quot;)public class Test1 &#123; @Autowired @Qualifier(&quot;proxyJava&quot;) private MyInterface myInterface; @Test public void test1()&#123; System.out.println(myInterface.add(1, 2)); &#125; @Test public void test2()&#123; System.out.println(myInterface.del(1, 2)); &#125; @Test public void test3()&#123; System.out.println(myInterface.che(1, 2)); &#125; @Test public void test4()&#123; System.out.println(myInterface.div(1, 2)); &#125;&#125; é…ç½®æ–‡ä»¶ 1234567&lt;bean id=&quot;factory&quot; class=&quot;com.es.factory.BeanFactory&quot;&gt; &lt;property name=&quot;java&quot; ref=&quot;java&quot;&gt;&lt;/property&gt;&lt;/bean&gt;&lt;bean id=&quot;java&quot; class=&quot;com.es.java1.java1&quot;&gt;&lt;/bean&gt;&lt;bean id=&quot;proxyJava&quot; factory-bean=&quot;factory&quot; factory-method=&quot;getBean&quot;&gt;&lt;/bean&gt; 2.AOP2.1 AOPç›¸å…³æ¦‚å¿µAOPï¼šå…¨ç§°æ˜¯ Aspect Oriented Programming å³ï¼šé¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚å°±æ˜¯æŠŠæˆ‘ä»¬ç¨‹åºé‡å¤çš„ä»£ç æŠ½å–å‡ºæ¥ï¼Œåœ¨éœ€è¦æ‰§è¡Œçš„æ—¶å€™ï¼Œä½¿ç”¨åŠ¨æ€ä»£ç†çš„æŠ€æœ¯ï¼Œåœ¨ä¸ä¿®æ”¹æºç çš„åŸºç¡€ä¸Šï¼Œå¯¹æˆ‘ä»¬çš„å·²æœ‰æ–¹æ³•è¿›è¡Œå¢å¼ºã€‚ ä½œç”¨ï¼š åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œä¸ä¿®æ”¹æºç å¯¹å·²æœ‰æ–¹æ³•è¿›è¡Œå¢å¼ºã€‚ ä¼˜åŠ¿ï¼š å‡å°‘é‡å¤ä»£ç  æé«˜å¼€å‘æ•ˆç‡ ç»´æŠ¤æ–¹ä¾¿ AOP ç›¸å…³æœ¯è¯­ Joinpoint(è¿æ¥ç‚¹): æ‰€è°“è¿æ¥ç‚¹æ˜¯æŒ‡é‚£äº›è¢«æ‹¦æˆªåˆ°çš„ç‚¹ã€‚åœ¨ spring ä¸­,è¿™äº›ç‚¹æŒ‡çš„æ˜¯æ–¹æ³•,å› ä¸º spring åªæ”¯æŒæ–¹æ³•ç±»å‹çš„è¿æ¥ç‚¹ã€‚ Pointcut(åˆ‡å…¥ç‚¹): æ‰€è°“åˆ‡å…¥ç‚¹æ˜¯æŒ‡æˆ‘ä»¬è¦å¯¹å“ªäº› Joinpoint è¿›è¡Œæ‹¦æˆªçš„å®šä¹‰ã€‚ Advice(é€šçŸ¥/å¢å¼º): æ‰€è°“é€šçŸ¥æ˜¯æŒ‡æ‹¦æˆªåˆ° Joinpoint ä¹‹åæ‰€è¦åšçš„äº‹æƒ…å°±æ˜¯é€šçŸ¥ã€‚ é€šçŸ¥çš„ç±»å‹ï¼šå‰ç½®é€šçŸ¥,åç½®é€šçŸ¥,å¼‚å¸¸é€šçŸ¥,æœ€ç»ˆé€šçŸ¥,ç¯ç»•é€šçŸ¥ã€‚ Introduction(å¼•ä»‹): å¼•ä»‹æ˜¯ä¸€ç§ç‰¹æ®Šçš„é€šçŸ¥åœ¨ä¸ä¿®æ”¹ç±»ä»£ç çš„å‰æä¸‹, Introduction å¯ä»¥åœ¨è¿è¡ŒæœŸä¸ºç±»åŠ¨æ€åœ°æ·»åŠ ä¸€äº›æ–¹æ³•æˆ– Fieldã€‚ Target(ç›®æ ‡å¯¹è±¡):è¢«ä»£ç†å¯¹è±¡ ä»£ç†çš„ç›®æ ‡å¯¹è±¡ã€‚ Weaving(ç»‡å…¥): æ˜¯æŒ‡æŠŠå¢å¼ºåº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡æ¥åˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚ spring é‡‡ç”¨åŠ¨æ€ä»£ç†ç»‡å…¥ï¼Œè€Œ AspectJ é‡‡ç”¨ç¼–è¯‘æœŸç»‡å…¥å’Œç±»è£…è½½æœŸç»‡å…¥ã€‚ Proxyï¼ˆä»£ç†: ä¸€ä¸ªç±»è¢« AOP ç»‡å…¥å¢å¼ºåï¼Œå°±äº§ç”Ÿä¸€ä¸ªç»“æœä»£ç†ç±»ã€‚ Aspect(åˆ‡é¢): æ˜¯åˆ‡å…¥ç‚¹å’Œé€šçŸ¥ï¼ˆå¼•ä»‹çš„ç»“åˆ â€‹ Spring æ¡†æ¶ç›‘æ§åˆ‡å…¥ç‚¹æ–¹æ³•çš„æ‰§è¡Œã€‚ä¸€æ—¦ç›‘æ§åˆ°åˆ‡å…¥ç‚¹æ–¹æ³•è¢«è¿è¡Œï¼Œä½¿ç”¨ä»£ç†æœºåˆ¶ï¼ŒåŠ¨æ€åˆ›å»ºç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œæ ¹æ®é€šçŸ¥ç±»åˆ«ï¼Œåœ¨ä»£ç†å¯¹è±¡çš„å¯¹åº”ä½ç½®ï¼Œå°†é€šçŸ¥å¯¹åº”çš„åŠŸèƒ½ç»‡å…¥ï¼Œå®Œæˆå®Œæ•´çš„ä»£ç é€»è¾‘è¿è¡Œã€‚â€‹ 2.2 åŸºäºxmlå½¢å¼çš„é…ç½®2.2.1 é…ç½®æ­¥éª¤12345678910111213141516171819202122232425262728293031323334353637383940&lt;!--springä¸­åŸºäºXMLçš„AOPé…ç½®æ­¥éª¤ 1ã€æŠŠé€šçŸ¥Beanä¹Ÿäº¤ç»™springæ¥ç®¡ç† 2ã€ä½¿ç”¨aop:configæ ‡ç­¾è¡¨æ˜å¼€å§‹AOPçš„é…ç½® 3ã€ä½¿ç”¨aop:aspectæ ‡ç­¾è¡¨æ˜é…ç½®åˆ‡é¢ idå±æ€§ï¼šæ˜¯ç»™åˆ‡é¢æä¾›ä¸€ä¸ªå”¯ä¸€æ ‡è¯† refå±æ€§ï¼šæ˜¯æŒ‡å®šé€šçŸ¥ç±»beançš„Idã€‚ 4ã€åœ¨aop:aspectæ ‡ç­¾çš„å†…éƒ¨ä½¿ç”¨å¯¹åº”æ ‡ç­¾æ¥é…ç½®é€šçŸ¥çš„ç±»å‹ æˆ‘ä»¬ç°åœ¨ç¤ºä¾‹æ˜¯è®©printLogæ–¹æ³•åœ¨åˆ‡å…¥ç‚¹æ–¹æ³•æ‰§è¡Œä¹‹å‰ä¹‹å‰ï¼šæ‰€ä»¥æ˜¯å‰ç½®é€šçŸ¥ aop:beforeï¼šè¡¨ç¤ºé…ç½®å‰ç½®é€šçŸ¥ methodå±æ€§ï¼šç”¨äºæŒ‡å®šLoggerç±»ä¸­å“ªä¸ªæ–¹æ³•æ˜¯å‰ç½®é€šçŸ¥ pointcutå±æ€§ï¼šç”¨äºæŒ‡å®šåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œè¯¥è¡¨è¾¾å¼çš„å«ä¹‰æŒ‡çš„æ˜¯å¯¹ä¸šåŠ¡å±‚ä¸­å“ªäº›æ–¹æ³•å¢å¼º åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„å†™æ³•ï¼š å…³é”®å­—ï¼šexecution(è¡¨è¾¾å¼) è¡¨è¾¾å¼ï¼š è®¿é—®ä¿®é¥°ç¬¦ è¿”å›å€¼ åŒ…å.åŒ…å.åŒ…å...ç±»å.æ–¹æ³•å(å‚æ•°åˆ—è¡¨) æ ‡å‡†çš„è¡¨è¾¾å¼å†™æ³•ï¼š public void com.itheima.service.impl.AccountServiceImpl.saveAccount() è®¿é—®ä¿®é¥°ç¬¦å¯ä»¥çœç•¥ void com.itheima.service.impl.AccountServiceImpl.saveAccount() è¿”å›å€¼å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼Œè¡¨ç¤ºä»»æ„è¿”å›å€¼ * com.itheima.service.impl.AccountServiceImpl.saveAccount() åŒ…åå¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼Œè¡¨ç¤ºä»»æ„åŒ…ã€‚ä½†æ˜¯å‡ çº§åŒ…ï¼Œå°±éœ€è¦å†™å‡ ä¸ª*. * *.*.*.*.AccountServiceImpl.saveAccount()) åŒ…åå¯ä»¥ä½¿ç”¨..è¡¨ç¤ºå½“å‰åŒ…åŠå…¶å­åŒ… * *..AccountServiceImpl.saveAccount() ç±»åå’Œæ–¹æ³•åéƒ½å¯ä»¥ä½¿ç”¨*æ¥å®ç°é€šé… * *..*.*() å‚æ•°åˆ—è¡¨ï¼š å¯ä»¥ç›´æ¥å†™æ•°æ®ç±»å‹ï¼š åŸºæœ¬ç±»å‹ç›´æ¥å†™åç§° int å¼•ç”¨ç±»å‹å†™åŒ…å.ç±»åçš„æ–¹å¼ java.lang.String å¯ä»¥ä½¿ç”¨é€šé…ç¬¦è¡¨ç¤ºä»»æ„ç±»å‹ï¼Œä½†æ˜¯å¿…é¡»å‚æ•° å¯ä»¥ä½¿ç”¨..è¡¨ç¤ºæ— å‚æ•°å‡å¯ï¼Œå‚æ•°å¯ä»¥æ˜¯ä»»æ„ç±»å‹ å…¨é€šé…å†™æ³•ï¼š * *..*.*(..) å®é™…å¼€å‘ä¸­åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„é€šå¸¸å†™æ³•ï¼š åˆ‡åˆ°ä¸šåŠ¡å±‚å®ç°ç±»ä¸‹çš„æ‰€æ–¹æ³• * com.itheima.service.impl.*.*(..)--&gt; é…ç½®æ–‡ä»¶ 1234567891011121314151617181920212223242526&lt;!--é…ç½®bean--&gt;&lt;bean id=&quot;java&quot; class=&quot;com.es.java1.java1&quot;&gt;&lt;/bean&gt;&lt;bean id=&quot;logging&quot; class=&quot;com.es.java2.Logging&quot;&gt;&lt;/bean&gt;&lt;!-- é…ç½®aop --&gt;&lt;aop:config&gt; &lt;!-- é…ç½®åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ idå±æ€§ç”¨äºæŒ‡å®šè¡¨è¾¾å¼çš„å”¯ä¸€æ ‡è¯†ã€‚expressionå±æ€§ç”¨äºæŒ‡å®šè¡¨è¾¾å¼å†…å®¹ æ­¤æ ‡ç­¾å†™åœ¨aop:aspectæ ‡ç­¾å†…éƒ¨åªèƒ½å½“å‰åˆ‡é¢ä½¿ç”¨ã€‚ å®ƒè¿˜å¯ä»¥å†™åœ¨aop:aspectå¤–é¢ï¼Œæ­¤æ—¶å°±å˜æˆäº†æ‰€åˆ‡é¢å¯ç”¨ --&gt; &lt;aop:pointcut id=&quot;a&quot; expression=&quot;execution(public int com.es.java1.java1.*(int,int))&quot;&gt;&lt;/aop:pointcut&gt; &lt;!--é…ç½®åˆ‡é¢--&gt; &lt;aop:aspect id=&quot;log&quot; ref=&quot;logging&quot;&gt; &lt;!-- é…ç½®é€šçŸ¥çš„ç±»å‹ï¼Œå¹¶ä¸”å»ºç«‹é€šçŸ¥æ–¹æ³•å’Œåˆ‡å…¥ç‚¹æ–¹æ³•çš„å…³è”--&gt; &lt;!-- é…ç½®å‰ç½®é€šçŸ¥ï¼šåœ¨åˆ‡å…¥ç‚¹æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œ --&gt; &lt;aop:before method=&quot;before&quot; pointcut=&quot;execution(public int com.es.java1.java1.*(int,int))&quot;&gt;&lt;/aop:before&gt; &lt;!-- é…ç½®åç½®é€šçŸ¥ï¼šåœ¨åˆ‡å…¥ç‚¹æ–¹æ³•æ­£å¸¸æ‰§è¡Œä¹‹åå€¼ã€‚å®ƒå’Œå¼‚å¸¸é€šçŸ¥æ°¸è¿œåªèƒ½æ‰§è¡Œä¸€ä¸ª--&gt; &lt;aop:after-returning method=&quot;afterReturn&quot; pointcut-ref=&quot;a&quot;&gt;&lt;/aop:after-returning&gt; &lt;!-- é…ç½®å¼‚å¸¸é€šçŸ¥ï¼šåœ¨åˆ‡å…¥ç‚¹æ–¹æ³•æ‰§è¡Œäº§ç”Ÿå¼‚å¸¸ä¹‹åæ‰§è¡Œã€‚å®ƒå’Œåç½®é€šçŸ¥æ°¸è¿œåªèƒ½æ‰§è¡Œä¸€ä¸ª--&gt; &lt;aop:after-throwing method=&quot;afterThrowing&quot; pointcut-ref=&quot;a&quot;&gt;&lt;/aop:after-throwing&gt; &lt;!-- é…ç½®æœ€ç»ˆé€šçŸ¥ï¼šæ— è®ºåˆ‡å…¥ç‚¹æ–¹æ³•æ˜¯å¦æ­£å¸¸æ‰§è¡Œå®ƒéƒ½ä¼šåœ¨å…¶åé¢æ‰§è¡Œ --&gt; &lt;aop:after method=&quot;after&quot; pointcut-ref=&quot;a&quot;&gt;&lt;/aop:after&gt; &lt;!-- é…ç½®ç¯ç»•é€šçŸ¥ è¯¦ç»†çš„æ³¨é‡Š :Loggerç±»ä¸­--&gt; &lt;aop:around method=&quot;around&quot; pointcut-ref=&quot;a&quot;&gt;&lt;/aop:around&gt; &lt;/aop:aspect&gt;&lt;/aop:config&gt; å®ç°ç±» 1234567891011121314public class java1 implements MyInterface&#123; public int add(int a,int b)&#123; return a+b; &#125; public int del(int a,int b)&#123; return a-b; &#125; public int che(int a,int b)&#123; return a*b; &#125; public int div(int a,int b)&#123; return a/b; &#125;&#125; æµ‹è¯•ç±» 1234567891011@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration(locations = &quot;classpath:applicationContext.xml&quot;)public class Test1 &#123; @Autowired @Qualifier(&quot;java&quot;) private MyInterface java; @Test public void test1()&#123; java.div(1, 1); &#125;&#125; æ—¥å¿—ç±» 123456789101112131415161718192021222324252627282930313233343536373839404142434445public class Logging &#123; public void before()&#123; System.out.println(&quot;â˜…â˜…â˜…å‰ç½®â˜…â˜…â˜…&quot;); &#125; public void afterReturn()&#123; System.out.println(&quot;â˜…â˜…â˜…åç½®â˜…â˜…â˜…&quot;); &#125; public void afterThrowing()&#123; System.out.println(&quot;â˜…â˜…â˜…å¼‚å¸¸â˜…â˜…â˜…&quot;); &#125; public void after()&#123; System.out.println(&quot;â˜…â˜…â˜…æœ€ç»ˆâ˜…â˜…â˜…&quot;); &#125; /** * ç¯ç»•é€šçŸ¥ * é—®é¢˜ï¼š * å½“æˆ‘ä»¬é…ç½®äº†ç¯ç»•é€šçŸ¥ä¹‹åï¼Œåˆ‡å…¥ç‚¹æ–¹æ³•æ²¡æ‰§è¡Œï¼Œè€Œé€šçŸ¥æ–¹æ³•æ‰§è¡Œäº†ã€‚ * åˆ†æï¼š * é€šè¿‡å¯¹æ¯”åŠ¨æ€ä»£ç†ä¸­çš„ç¯ç»•é€šçŸ¥ä»£ç ï¼Œå‘ç°åŠ¨æ€ä»£ç†çš„ç¯ç»•é€šçŸ¥æ˜ç¡®çš„åˆ‡å…¥ç‚¹æ–¹æ³•è°ƒç”¨ï¼Œè€Œæˆ‘ä»¬çš„ä»£ç ä¸­æ²¡ã€‚ * è§£å†³ï¼š * Springæ¡†æ¶ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ¥å£ï¼šProceedingJoinPointã€‚è¯¥æ¥å£ä¸€ä¸ªæ–¹æ³•proceed()ï¼Œæ­¤æ–¹æ³•å°±ç›¸å½“äºæ˜ç¡®è°ƒç”¨åˆ‡å…¥ç‚¹æ–¹æ³•ã€‚ * è¯¥æ¥å£å¯ä»¥ä½œä¸ºç¯ç»•é€šçŸ¥çš„æ–¹æ³•å‚æ•°ï¼Œåœ¨ç¨‹åºæ‰§è¡Œæ—¶ï¼Œspringæ¡†æ¶ä¼šä¸ºæˆ‘ä»¬æä¾›è¯¥æ¥å£çš„å®ç°ç±»ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚ * * springä¸­çš„ç¯ç»•é€šçŸ¥ï¼š * å®ƒæ˜¯springæ¡†æ¶ä¸ºæˆ‘ä»¬æä¾›çš„ä¸€ç§å¯ä»¥åœ¨ä»£ç ä¸­æ‰‹åŠ¨æ§åˆ¶å¢å¼ºæ–¹æ³•ä½•æ—¶æ‰§è¡Œçš„æ–¹å¼ã€‚ */ public Object around(ProceedingJoinPoint pjp)&#123; Object value=null; //è·å–æ–¹æ³•æ‰§è¡Œçš„å‚æ•° Object []args=pjp.getArgs(); //è·å–æ–¹æ³•å String methodName = pjp.getSignature().getName(); try &#123; System.out.println(&quot;â˜…â˜…â˜…å‰ç½®â˜…â˜…â˜…&quot;+methodName+&quot;...&quot;+Arrays.toString(args)); value=pjp.proceed(args); System.out.println(&quot;â˜…â˜…â˜…åç½®â˜…â˜…â˜…&quot;+methodName+&quot;...&quot;+Arrays.toString(args)+&quot;...&quot;+value); return value; &#125; catch (Throwable throwable) &#123; System.out.println(&quot;â˜…â˜…â˜…å¼‚å¸¸â˜…â˜…â˜…&quot;+methodName+&quot;...&quot;+Arrays.toString(args)); throw new RuntimeException(throwable); &#125;finally &#123; System.out.println(&quot;â˜…â˜…â˜…æœ€ç»ˆâ˜…â˜…â˜…&quot;+methodName+&quot;...&quot;+Arrays.toString(args)+&quot;...&quot;+value); &#125; &#125;&#125; 2.3 åŸºäºæ³¨è§£çš„é…ç½®2.3.1 æ­¥éª¤ é¦–å…ˆåœ¨é…ç½®æ–‡ä»¶é‡Œå¼€å¯å£°æ˜å¼aopæ³¨è§£æ”¯æŒ 12&lt;!--å¼€å¯å£°æ˜å¼äº‹åŠ¡æ³¨è§£--&gt;&lt;aop:aspectj-autoproxy&gt;&lt;/aop:aspectj-autoproxy&gt; åœ¨loggingç±»ä¸Šå£°æ˜å…¶ä¸ºä¸€ä¸ªåˆ‡é¢ç±» 1@Aspect//å£°æ˜ä¸€ä¸ªåˆ‡é¢ åœ¨ç±»ä¸­å£°æ˜ä¸€ä¸ªæ–¹æ³•ä½œä¸ºåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ 1234@Pointcut(&quot;execution(public * com.es.java1.java1.*(..))&quot;)public void pointcut()&#123;&#125; åœ¨å„ä¸ªæ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£ è®¾ç½®åˆ‡é¢ä¼˜å…ˆçº§ 1@Order(2)//é€šè¿‡@Order(2)æ³¨è§£æŒ‡å®šåˆ‡é¢ä¼˜å…ˆçº§ï¼Œvalueå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œé»˜è®¤æ˜¯intæœ€å¤§å€¼ã€‚ 2.3.2 æ¡ˆä¾‹ é…ç½®æ–‡ä»¶ 1234 &lt;!--å¼€å¯å£°æ˜å¼äº‹åŠ¡æ³¨è§£--&gt;&lt;aop:aspectj-autoproxy&gt;&lt;/aop:aspectj-autoproxy&gt; &lt;!--è®¾ç½®è‡ªåŠ¨æ‰«æçš„åŒ…--&gt;&lt;context:component-scan base-package=&quot;com.es&quot;&gt;&lt;/context:component-scan&gt; æ—¥å¿—ç±» 1234567891011121314151617181920212223242526272829303132333435363738394041package com.es.utils;import org.aspectj.lang.JoinPoint;import org.aspectj.lang.ProceedingJoinPoint;import org.aspectj.lang.annotation.*;import org.springframework.stereotype.Component;import java.util.Arrays;/** * @author yinhuidong * @createTime 2020-03-04-16:37 */@Component(&quot;logging&quot;)@Aspectpublic class Logging &#123; @Before(value=&quot;execution(* com.es.java1.*.*(..))&quot;) public void before(JoinPoint jp)&#123; Object[] args = jp.getArgs(); String name = jp.getSignature().getName(); System.out.println(&quot;before...&quot;+name+&quot;...&quot;+Arrays.toString(args)); &#125; @AfterReturning(value=&quot;execution(* com.es.java1.*.*(..))&quot;,returning = &quot;result&quot;) public void afterReturning(JoinPoint jp,Object result)&#123; Object[] args = jp.getArgs(); String name = jp.getSignature().getName(); System.out.println(&quot;afterReturning...&quot;+name+&quot;...&quot;+Arrays.toString(args)+&quot;...&quot;+result); &#125; @AfterThrowing(value=&quot;execution(* com.es.java1.*.*(..))&quot;,throwing = &quot;e&quot;) public void afterThrowing(JoinPoint jp,Exception e)&#123; Object[] args = jp.getArgs(); String name = jp.getSignature().getName(); System.out.println(&quot;afterThrowing...&quot;+name+&quot;...&quot;+Arrays.toString(args)+&quot;...&quot;+e); &#125; @After(&quot;execution(* com.es.java1.*.*(..))&quot;) public void after(JoinPoint jp)&#123; Object[] args = jp.getArgs(); String name = jp.getSignature().getName(); System.out.println(&quot;after...&quot;+name+&quot;...&quot;+Arrays.toString(args)); &#125;&#125; å®ç°ç±» 123456789@Component(&quot;add&quot;)public class Add &#123; public void add(int a ,int b)&#123; System.out.println(a+b); &#125; public int del(int a, int b)&#123; return a-b; &#125;&#125; æµ‹è¯•ç±» 1234567891011@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration(locations = &quot;classpath:applicationContext.xml&quot;)public class Test1 &#123; @Autowired private Add add; @Test public void test1()&#123; add.add(1,1); System.out.println(add.del(1, 1)); &#125;&#125; è¡¥å……ï¼š 12345678910//é…ç½®é€šç”¨çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼@Pointcut(value = &quot;execution(* com.es.dao.impl.ComputerDaoImpl.*(..))&quot;)public void pointCut()&#123;&#125;//å¼•ç”¨é€šç”¨çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼@Before(&quot;pointCut()&quot;)public void before(JoinPoint point)&#123; System.out.println(&quot;å‰ç½®é€šçŸ¥--&gt;&quot;+&quot;æ–¹æ³•åï¼š&quot;+point.getSignature().getName()+&quot;å‚æ•°åˆ—è¡¨ï¼š&quot;+ Arrays.asList(point.getArgs()));&#125; å…­ï¼Œspringçš„äº‹åŠ¡1.åŸºäºAOPçš„äº‹åŠ¡å¤„ç†æ¨¡æ‹Ÿ1.1 æ­¥éª¤ åˆ›å»ºä¸€ä¸ªé“¾æ¥å·¥å…·ç±»ï¼Œè´Ÿè´£ä»çº¿ç¨‹è·å–è¿æ¥ï¼Œå¹¶å®ç°ä¸çº¿ç¨‹çš„ç»‘å®šã€‚ åˆ›å»ºå’Œäº‹åŠ¡ç®¡ç†ç›¸å…³çš„å·¥å…·ç±»ï¼Œè´Ÿè´£å¤„ç†äº‹åŠ¡æ“ä½œ åˆ©ç”¨aopå®ç°äº‹åŠ¡å¤„ç† â€‹ 1.2 æ¡ˆä¾‹é…ç½®æ–‡ä»¶ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:jdbc=&quot;http://www.springframework.org/schema/jdbc&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-4.2.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.2.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.2.xsd&quot;&gt; &lt;!--é…ç½®dao--&gt; &lt;bean id=&quot;accountDao&quot; class=&quot;com.es.dao.impl.AccountDaoImpl&quot;&gt; &lt;property name=&quot;runner&quot; ref=&quot;runner&quot;&gt;&lt;/property&gt; &lt;property name=&quot;connectionUtils&quot; ref=&quot;connection&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;!--é…ç½®service--&gt; &lt;bean id=&quot;accountService&quot; class=&quot;com.es.service.impl.AccountServiceImpl&quot;&gt; &lt;property name=&quot;accountDao&quot; ref=&quot;accountDao&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;!--é…ç½®queryRunner--&gt; &lt;bean id=&quot;runner&quot; class=&quot;org.apache.commons.dbutils.QueryRunner&quot;&gt; &lt;!--&lt;constructor-arg name=&quot;ds&quot; ref=&quot;dataSource&quot;&gt;&lt;/constructor-arg&gt;--&gt; &lt;/bean&gt; &lt;!--é…ç½®æ•°æ®æº--&gt; &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt; &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;&gt;&lt;/property&gt; &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/eesy&quot;&gt;&lt;/property&gt; &lt;property name=&quot;password&quot; value=&quot;yhd666&quot;&gt;&lt;/property&gt; &lt;property name=&quot;username&quot; value=&quot;root&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;!--é…ç½®transactionManager--&gt; &lt;bean id=&quot;transactionManager&quot; class=&quot;com.es.utils.TransactionManager&quot;&gt; &lt;property name=&quot;connectionUtils&quot; ref=&quot;connection&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;!--é…ç½®ConnectionUtils--&gt; &lt;bean id=&quot;connection&quot; class=&quot;com.es.utils.ConnectionUtils&quot;&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;!--é…ç½®aop--&gt; &lt;aop:config&gt; &lt;!--é…ç½®åˆ‡å…¥ç‚¹è¡¨è¾¾å¼--&gt; &lt;aop:pointcut id=&quot;txAdvice&quot; expression=&quot;execution(* com.es.service.impl.*.*(..))&quot;&gt;&lt;/aop:pointcut&gt; &lt;aop:aspect id=&quot;txA&quot; ref=&quot;transactionManager&quot;&gt; &lt;aop:before method=&quot;beginTransaction&quot; pointcut-ref=&quot;txAdvice&quot;&gt;&lt;/aop:before&gt; &lt;aop:after-returning method=&quot;commit&quot; pointcut-ref=&quot;txAdvice&quot;&gt;&lt;/aop:after-returning&gt; &lt;aop:after-throwing method=&quot;rollback&quot; pointcut-ref=&quot;txAdvice&quot;&gt;&lt;/aop:after-throwing&gt; &lt;aop:after method=&quot;release&quot; pointcut-ref=&quot;txAdvice&quot;&gt;&lt;/aop:after&gt; &lt;/aop:aspect&gt; &lt;/aop:config&gt;&lt;/beans&gt; æŒä¹…å±‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293package com.es.dao.impl;import com.es.dao.IAccountDao;import com.es.domain.Account;import com.es.utils.ConnectionUtils;import org.apache.commons.dbutils.QueryRunner;import org.apache.commons.dbutils.handlers.BeanHandler;import org.apache.commons.dbutils.handlers.BeanListHandler;import org.springframework.jdbc.core.BeanPropertyRowMapper;import org.springframework.jdbc.core.support.JdbcDaoSupport;import org.springframework.stereotype.Repository;import java.util.List;/** * è´¦æˆ·çš„æŒä¹…å±‚å®ç°ç±» */public class AccountDaoImpl implements IAccountDao &#123; private QueryRunner runner; private ConnectionUtils connectionUtils; public void setRunner(QueryRunner runner) &#123; this.runner = runner; &#125; public void setConnectionUtils(ConnectionUtils connectionUtils) &#123; this.connectionUtils = connectionUtils; &#125; public List&lt;Account&gt; findAllAccount() &#123; try&#123; return runner.query(connectionUtils.getThreadConnection(),&quot;select * from account&quot;,new BeanListHandler&lt;Account&gt;(Account.class)); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public Account findAccountById(Integer accountId) &#123; try&#123; return runner.query(connectionUtils.getThreadConnection(),&quot;select * from account where id = ? &quot;,new BeanHandler&lt;Account&gt;(Account.class),accountId); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public void saveAccount(Account account) &#123; try&#123; runner.update(connectionUtils.getThreadConnection(),&quot;insert into account(name,money)values(?,?)&quot;,account.getName(),account.getMoney()); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public void updateAccount(Account account) &#123; try&#123; runner.update(connectionUtils.getThreadConnection(),&quot;update account set name=?,money=? where id=?&quot;,account.getName(),account.getMoney(),account.getId()); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public void deleteAccount(Integer accountId) &#123; try&#123; runner.update(connectionUtils.getThreadConnection(),&quot;delete from account where id=?&quot;,accountId); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125; public Account findAccountByName(String accountName) &#123; try&#123; List&lt;Account&gt; accounts = runner.query(connectionUtils.getThreadConnection(),&quot;select * from account where name = ? &quot;,new BeanListHandler&lt;Account&gt;(Account.class),accountName); if(accounts == null || accounts.size() == 0)&#123; return null; &#125; if(accounts.size() &gt; 1)&#123; throw new RuntimeException(&quot;ç»“æœé›†ä¸å”¯ä¸€ï¼Œæ•°æ®æœ‰é—®é¢˜&quot;); &#125; return accounts.get(0); &#125;catch (Exception e) &#123; throw new RuntimeException(e); &#125; &#125;&#125; æœåŠ¡å±‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849package com.es.service.impl;import com.es.dao.IAccountDao;import com.es.domain.Account;import com.es.service.IAccountService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;/** * è´¦æˆ·çš„ä¸šåŠ¡å±‚å®ç°ç±» * * äº‹åŠ¡æ§åˆ¶åº”è¯¥éƒ½æ˜¯åœ¨ä¸šåŠ¡å±‚ */public class AccountServiceImpl implements IAccountService&#123; private IAccountDao accountDao; public void setAccountDao(IAccountDao accountDao) &#123; this.accountDao = accountDao; &#125; public Account findAccountById(Integer accountId) &#123; return accountDao.findAccountById(accountId); &#125; public void transfer(String sourceName, String targetName, Float money) &#123; System.out.println(&quot;transfer....&quot;); //2.1æ ¹æ®åç§°æŸ¥è¯¢è½¬å‡ºè´¦æˆ· Account source = accountDao.findAccountByName(sourceName); //2.2æ ¹æ®åç§°æŸ¥è¯¢è½¬å…¥è´¦æˆ· Account target = accountDao.findAccountByName(targetName); //2.3è½¬å‡ºè´¦æˆ·å‡é’± source.setMoney(source.getMoney()-money); //2.4è½¬å…¥è´¦æˆ·åŠ é’± target.setMoney(target.getMoney()+money); //2.5æ›´æ–°è½¬å‡ºè´¦æˆ· accountDao.updateAccount(source); int i=1/0; //2.6æ›´æ–°è½¬å…¥è´¦æˆ· accountDao.updateAccount(target); &#125;&#125; è¿æ¥å·¥å…·ç±» 12345678910111213141516171819202122232425262728293031323334353637383940414243444546package com.es.utils;import javax.sql.DataSource;import java.sql.Connection;/** * è¿æ¥çš„å·¥å…·ç±»ï¼Œå®ƒç”¨äºä»æ•°æ®æºä¸­è·å–ä¸€ä¸ªè¿æ¥ï¼Œå¹¶ä¸”å®ç°å’Œçº¿ç¨‹çš„ç»‘å®š */public class ConnectionUtils &#123; private ThreadLocal&lt;Connection&gt; tl = new ThreadLocal&lt;Connection&gt;(); private DataSource dataSource; public void setDataSource(DataSource dataSource) &#123; this.dataSource = dataSource; &#125; /** * è·å–å½“å‰çº¿ç¨‹ä¸Šçš„è¿æ¥ * @return */ public Connection getThreadConnection() &#123; try&#123; //1.å…ˆä»ThreadLocalä¸Šè·å– Connection conn = tl.get(); //2.åˆ¤æ–­å½“å‰çº¿ç¨‹ä¸Šæ˜¯å¦è¿æ¥ if (conn == null) &#123; //3.ä»æ•°æ®æºä¸­è·å–ä¸€ä¸ªè¿æ¥ï¼Œå¹¶ä¸”å­˜å…¥ThreadLocalä¸­ conn = dataSource.getConnection(); tl.set(conn); &#125; //4.è¿”å›å½“å‰çº¿ç¨‹ä¸Šçš„è¿æ¥ return conn; &#125;catch (Exception e)&#123; throw new RuntimeException(e); &#125; &#125; /** * æŠŠè¿æ¥å’Œçº¿ç¨‹è§£ç»‘ */ public void removeConnection()&#123; tl.remove(); &#125;&#125; äº‹åŠ¡å¤„ç†ç±» 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162package com.es.utils;import org.springframework.stereotype.Component;/** * å’Œäº‹åŠ¡ç®¡ç†ç›¸å…³çš„å·¥å…·ç±»ï¼Œå®ƒåŒ…å«äº†ï¼Œå¼€å¯äº‹åŠ¡ï¼Œæäº¤äº‹åŠ¡ï¼Œå›æ»šäº‹åŠ¡å’Œé‡Šæ”¾è¿æ¥ */public class TransactionManager &#123; private ConnectionUtils connectionUtils; public void setConnectionUtils(ConnectionUtils connectionUtils) &#123; this.connectionUtils = connectionUtils; &#125; /** * å¼€å¯äº‹åŠ¡ */ public void beginTransaction()&#123; try &#123; connectionUtils.getThreadConnection().setAutoCommit(false); &#125;catch (Exception e)&#123; e.printStackTrace(); &#125; &#125; /** * æäº¤äº‹åŠ¡ */ public void commit()&#123; try &#123; connectionUtils.getThreadConnection().commit(); &#125;catch (Exception e)&#123; e.printStackTrace(); &#125; &#125; /** * å›æ»šäº‹åŠ¡ */ public void rollback()&#123; try &#123; connectionUtils.getThreadConnection().rollback(); &#125;catch (Exception e)&#123; e.printStackTrace(); &#125; &#125; /** * é‡Šæ”¾è¿æ¥ */ public void release()&#123; try &#123; connectionUtils.getThreadConnection().close();//è¿˜å›è¿æ¥æ± ä¸­ connectionUtils.removeConnection(); &#125;catch (Exception e)&#123; e.printStackTrace(); &#125; &#125;&#125; 2.springçš„äº‹åŠ¡é…ç½®2.1 springä¸­åŸºäºxmlçš„äº‹åŠ¡é…ç½®2.2.1 é…ç½®æ­¥éª¤springä¸­åŸºäºXMLçš„å£°æ˜å¼äº‹åŠ¡æ§åˆ¶é…ç½®æ­¥éª¤â€‹ é…ç½®äº‹åŠ¡ç®¡ç†å™¨ é…ç½®äº‹åŠ¡çš„é€šçŸ¥ æ­¤æ—¶æˆ‘ä»¬éœ€è¦å¯¼å…¥äº‹åŠ¡çš„çº¦æŸ txåç§°ç©ºé—´å’Œçº¦æŸï¼ŒåŒæ—¶ä¹Ÿéœ€è¦aopçš„ ä½¿ç”¨tx:adviceæ ‡ç­¾é…ç½®äº‹åŠ¡é€šçŸ¥ å±æ€§ï¼š idï¼šç»™äº‹åŠ¡é€šçŸ¥èµ·ä¸€ä¸ªå”¯ä¸€æ ‡è¯† transaction-managerï¼šç»™äº‹åŠ¡é€šçŸ¥æä¾›ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨å¼•ç”¨ é…ç½®AOPä¸­çš„é€šç”¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ å»ºç«‹äº‹åŠ¡é€šçŸ¥å’Œåˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„å¯¹åº”å…³ç³» é…ç½®äº‹åŠ¡çš„å±æ€§ æ˜¯åœ¨äº‹åŠ¡çš„é€šçŸ¥tx:adviceæ ‡ç­¾çš„å†…éƒ¨ â€‹ é…ç½®äº‹åŠ¡çš„å±æ€§â€‹ isolationï¼šç”¨äºæŒ‡å®šäº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚é»˜è®¤å€¼æ˜¯DEFAULTï¼Œè¡¨ç¤ºä½¿ç”¨æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚ propagationï¼šç”¨äºæŒ‡å®šäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºã€‚é»˜è®¤å€¼æ˜¯REQUIREDï¼Œè¡¨ç¤ºä¸€å®šä¼šæœ‰äº‹åŠ¡ï¼Œå¢åˆ æ”¹çš„é€‰æ‹©ã€‚æŸ¥è¯¢æ–¹æ³•å¯ä»¥é€‰æ‹©SUPPORTSã€‚ read-onlyï¼šç”¨äºæŒ‡å®šäº‹åŠ¡æ˜¯å¦åªè¯»ã€‚åªæŸ¥è¯¢æ–¹æ³•æ‰èƒ½è®¾ç½®ä¸ºtrueã€‚é»˜è®¤å€¼æ˜¯falseï¼Œè¡¨ç¤ºè¯»å†™ã€‚ timeoutï¼šç”¨äºæŒ‡å®šäº‹åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯-1ï¼Œè¡¨ç¤ºæ°¸ä¸è¶…æ—¶ã€‚å¦‚æœæŒ‡å®šäº†æ•°å€¼ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚ rollback-forï¼šç”¨äºæŒ‡å®šä¸€ä¸ªå¼‚å¸¸ï¼Œå½“äº§ç”Ÿè¯¥å¼‚å¸¸æ—¶ï¼Œäº‹åŠ¡å›æ»šï¼Œäº§ç”Ÿå…¶ä»–å¼‚å¸¸æ—¶ï¼Œäº‹åŠ¡ä¸å›æ»šã€‚æ²¡æœ‰é»˜è®¤å€¼ã€‚è¡¨ç¤ºä»»ä½•å¼‚å¸¸éƒ½å›æ»šã€‚ no-rollback-forï¼šç”¨äºæŒ‡å®šä¸€ä¸ªå¼‚å¸¸ï¼Œå½“äº§ç”Ÿè¯¥å¼‚å¸¸æ—¶ï¼Œäº‹åŠ¡ä¸å›æ»šï¼Œäº§ç”Ÿå…¶ä»–å¼‚å¸¸æ—¶äº‹åŠ¡å›æ»šã€‚æ²¡æœ‰é»˜è®¤å€¼ã€‚è¡¨ç¤ºä»»ä½•å¼‚å¸¸éƒ½å›æ»šã€‚ â€‹ 2.2.2 æ¡ˆä¾‹é…ç½®æ–‡ä»¶ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:jdbc=&quot;http://www.springframework.org/schema/jdbc&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-4.2.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.2.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.2.xsd&quot;&gt; &lt;context:component-scan base-package=&quot;com.es&quot;&gt;&lt;/context:component-scan&gt; &lt;bean id=&quot;accountDao&quot; class=&quot;com.es.dao.impl.AccountDaoImpl&quot;&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;bean id=&quot;account&quot; class=&quot;com.es.domain.Account&quot;&gt;&lt;/bean&gt; &lt;bean id=&quot;accountService&quot; class=&quot;com.es.service.impl.AccountServiceImpl&quot;&gt; &lt;property name=&quot;accountDao&quot; ref=&quot;accountDao&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt; &lt;property name=&quot;username&quot; value=&quot;root&quot;&gt;&lt;/property&gt; &lt;property name=&quot;password&quot; value=&quot;yhd666&quot;&gt;&lt;/property&gt; &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql:///eesy&quot;&gt;&lt;/property&gt; &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;!-- springä¸­åŸºäºXMLçš„å£°æ˜å¼äº‹åŠ¡æ§åˆ¶é…ç½®æ­¥éª¤ 1ã€é…ç½®äº‹åŠ¡ç®¡ç†å™¨ 2ã€é…ç½®äº‹åŠ¡çš„é€šçŸ¥ æ­¤æ—¶æˆ‘ä»¬éœ€è¦å¯¼å…¥äº‹åŠ¡çš„çº¦æŸ txåç§°ç©ºé—´å’Œçº¦æŸï¼ŒåŒæ—¶ä¹Ÿéœ€è¦aopçš„ ä½¿ç”¨tx:adviceæ ‡ç­¾é…ç½®äº‹åŠ¡é€šçŸ¥ å±æ€§ï¼š idï¼šç»™äº‹åŠ¡é€šçŸ¥èµ·ä¸€ä¸ªå”¯ä¸€æ ‡è¯† transaction-managerï¼šç»™äº‹åŠ¡é€šçŸ¥æä¾›ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨å¼•ç”¨ 3ã€é…ç½®AOPä¸­çš„é€šç”¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ 4ã€å»ºç«‹äº‹åŠ¡é€šçŸ¥å’Œåˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„å¯¹åº”å…³ç³» 5ã€é…ç½®äº‹åŠ¡çš„å±æ€§ æ˜¯åœ¨äº‹åŠ¡çš„é€šçŸ¥tx:adviceæ ‡ç­¾çš„å†…éƒ¨ --&gt; &lt;!--é…ç½®äº‹åŠ¡ç®¡ç†å™¨--&gt; &lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;!--é…ç½®äº‹åŠ¡çš„é€šçŸ¥--&gt; &lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;transactionManager&quot;&gt; &lt;!-- é…ç½®äº‹åŠ¡çš„å±æ€§ isolationï¼šç”¨äºæŒ‡å®šäº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚é»˜è®¤å€¼æ˜¯DEFAULTï¼Œè¡¨ç¤ºä½¿ç”¨æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚ propagationï¼šç”¨äºæŒ‡å®šäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºã€‚é»˜è®¤å€¼æ˜¯REQUIREDï¼Œè¡¨ç¤ºä¸€å®šä¼šæœ‰äº‹åŠ¡ï¼Œå¢åˆ æ”¹çš„é€‰æ‹©ã€‚æŸ¥è¯¢æ–¹æ³•å¯ä»¥é€‰æ‹©SUPPORTSã€‚ read-onlyï¼šç”¨äºæŒ‡å®šäº‹åŠ¡æ˜¯å¦åªè¯»ã€‚åªæŸ¥è¯¢æ–¹æ³•æ‰èƒ½è®¾ç½®ä¸ºtrueã€‚é»˜è®¤å€¼æ˜¯falseï¼Œè¡¨ç¤ºè¯»å†™ã€‚ timeoutï¼šç”¨äºæŒ‡å®šäº‹åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯-1ï¼Œè¡¨ç¤ºæ°¸ä¸è¶…æ—¶ã€‚å¦‚æœæŒ‡å®šäº†æ•°å€¼ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚ rollback-forï¼šç”¨äºæŒ‡å®šä¸€ä¸ªå¼‚å¸¸ï¼Œå½“äº§ç”Ÿè¯¥å¼‚å¸¸æ—¶ï¼Œäº‹åŠ¡å›æ»šï¼Œäº§ç”Ÿå…¶ä»–å¼‚å¸¸æ—¶ï¼Œäº‹åŠ¡ä¸å›æ»šã€‚æ²¡æœ‰é»˜è®¤å€¼ã€‚è¡¨ç¤ºä»»ä½•å¼‚å¸¸éƒ½å›æ»šã€‚ no-rollback-forï¼šç”¨äºæŒ‡å®šä¸€ä¸ªå¼‚å¸¸ï¼Œå½“äº§ç”Ÿè¯¥å¼‚å¸¸æ—¶ï¼Œäº‹åŠ¡ä¸å›æ»šï¼Œäº§ç”Ÿå…¶ä»–å¼‚å¸¸æ—¶äº‹åŠ¡å›æ»šã€‚æ²¡æœ‰é»˜è®¤å€¼ã€‚è¡¨ç¤ºä»»ä½•å¼‚å¸¸éƒ½å›æ»šã€‚ --&gt; &lt;tx:attributes&gt; &lt;tx:method name=&quot;*&quot; isolation=&quot;DEFAULT&quot; propagation=&quot;REQUIRED&quot; timeout=&quot;-1&quot; read-only=&quot;false&quot;/&gt; &lt;tx:method name=&quot;find*&quot; isolation=&quot;DEFAULT&quot; propagation=&quot;SUPPORTS&quot; read-only=&quot;true&quot; timeout=&quot;-1&quot;/&gt; &lt;/tx:attributes&gt; &lt;/tx:advice&gt; &lt;aop:config&gt; &lt;aop:pointcut id=&quot;pointCut&quot; expression=&quot;execution(* com.es.service.impl.*.*(..))&quot;&gt;&lt;/aop:pointcut&gt; &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut-ref=&quot;pointCut&quot;&gt;&lt;/aop:advisor&gt; &lt;/aop:config&gt;&lt;/beans&gt; æŒä¹…å±‚ 12345678910111213141516171819202122232425262728293031323334353637package com.es.dao.impl;import com.es.dao.IAccountDao;import com.es.domain.Account;import org.springframework.jdbc.core.BeanPropertyRowMapper;import org.springframework.jdbc.core.support.JdbcDaoSupport;import java.util.List;/** * è´¦æˆ·çš„æŒä¹…å±‚å®ç°ç±» */public class AccountDaoImpl extends JdbcDaoSupport implements IAccountDao &#123; public Account findAccountById(Integer accountId) &#123; List&lt;Account&gt; accounts = super.getJdbcTemplate().query(&quot;select * from account where id = ?&quot;,new BeanPropertyRowMapper&lt;Account&gt;(Account.class),accountId); return accounts.isEmpty()?null:accounts.get(0); &#125; public Account findAccountByName(String accountName) &#123; List&lt;Account&gt; accounts = super.getJdbcTemplate().query(&quot;select * from account where name = ?&quot;,new BeanPropertyRowMapper&lt;Account&gt;(Account.class),accountName); if(accounts.isEmpty())&#123; return null; &#125; if(accounts.size()&gt;1)&#123; throw new RuntimeException(&quot;ç»“æœé›†ä¸å”¯ä¸€&quot;); &#125; return accounts.get(0); &#125; public void updateAccount(Account account) &#123; super.getJdbcTemplate().update(&quot;update account set name=?,money=? where id=?&quot;,account.getName(),account.getMoney(),account.getId()); &#125;&#125; æœåŠ¡å±‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647package com.es.service.impl;import com.es.dao.IAccountDao;import com.es.domain.Account;import com.es.service.IAccountService;/** * è´¦æˆ·çš„ä¸šåŠ¡å±‚å®ç°ç±» * * äº‹åŠ¡æ§åˆ¶åº”è¯¥éƒ½æ˜¯åœ¨ä¸šåŠ¡å±‚ */public class AccountServiceImpl implements IAccountService&#123; private IAccountDao accountDao; public void setAccountDao(IAccountDao accountDao) &#123; this.accountDao = accountDao; &#125; public Account findAccountById(Integer accountId) &#123; return accountDao.findAccountById(accountId); &#125; public void transfer(String sourceName, String targetName, Float money) &#123; System.out.println(&quot;transfer....&quot;); //2.1æ ¹æ®åç§°æŸ¥è¯¢è½¬å‡ºè´¦æˆ· Account source = accountDao.findAccountByName(sourceName); //2.2æ ¹æ®åç§°æŸ¥è¯¢è½¬å…¥è´¦æˆ· Account target = accountDao.findAccountByName(targetName); //2.3è½¬å‡ºè´¦æˆ·å‡é’± source.setMoney(source.getMoney()-money); //2.4è½¬å…¥è´¦æˆ·åŠ é’± target.setMoney(target.getMoney()+money); //2.5æ›´æ–°è½¬å‡ºè´¦æˆ· accountDao.updateAccount(source); // int i=1/0; //2.6æ›´æ–°è½¬å…¥è´¦æˆ· accountDao.updateAccount(target); &#125;&#125; æµ‹è¯•ç±» 123456789101112131415161718192021import com.es.service.IAccountService;import org.junit.Test;import org.junit.runner.RunWith;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.test.context.ContextConfiguration;import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;/** * @author yinhuidong * @createTime 2020-03-03-12:03 */@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration(locations = &quot;classpath:applicationContext.xml&quot;)public class Test1 &#123; @Autowired private IAccountService service; @Test public void test1()&#123; service.transfer(&quot;aaa&quot;,&quot;bbb&quot;,1000f); &#125;&#125; 2.2 springä¸­åŸºäºæ³¨è§£çš„äº‹åŠ¡é…ç½®2.2.1 é…ç½®æ­¥éª¤ åœ¨é…ç½®æ–‡ä»¶é…ç½®äº‹åŠ¡ç®¡ç†å™¨ å¼€å§‹å£°æ˜å¼äº‹åŠ¡çš„æ”¯æŒ åœ¨å¯¹åº”çš„æ–¹æ³•ä¸ŠåŠ @Transcationalæ³¨è§£ï¼Œäº‹åŠ¡å£°æ˜æ³¨è§£:è¯¥æ³¨è§£å¯ä»¥æ·»åŠ åˆ°ç±»æˆ–è€…æ–¹æ³•ä¸Š å±æ€§ï¼š propagation:ç”¨æ¥è®¾ç½®äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºï¼šä¸€ä¸ªæ–¹æ³•è¿è¡Œåœ¨ä¸€ä¸ªå¼€å¯äº†äº‹åŠ¡çš„æ–¹æ³•ä¸­ï¼Œå½“å‰æ–¹æ³•æ˜¯ä½¿ç”¨åŸæœ‰çš„äº‹åŠ¡è¿˜æ˜¯å¼€å¯æ–°äº‹ç‰© required:å¦‚æœæœ‰äº‹åŠ¡å°±ä½¿ç”¨ï¼Œæ²¡æœ‰å°±å¼€å¯ä¸€ä¸ªæ–°çš„ï¼ˆé»˜è®¤ï¼‰ required_new:å¿…é¡»å¼€å¯æ–°äº‹ç‰© supportsï¼šå¦‚æœæœ‰äº‹åŠ¡å°±è¿è¡Œï¼Œå¦åˆ™ä¹Ÿä¸å¼€å¯æ–°çš„äº‹åŠ¡ no_supports:å³ä½¿æœ‰äº‹åŠ¡ä¹Ÿä¸ç”¨â€‹ 2.2.2 æ¡ˆä¾‹é…ç½®æ–‡ä»¶ 123456789101112131415161718192021222324252627282930313233343536&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:jdbc=&quot;http://www.springframework.org/schema/jdbc&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-4.2.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.2.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.2.xsd&quot;&gt; &lt;bean id=&quot;jdbcTemplate&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;context:property-placeholder location=&quot;classpath:druid.properties&quot;&gt;&lt;/context:property-placeholder&gt; &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt; &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;driverClassName&#125;&quot;&gt;&lt;/property&gt; &lt;property name=&quot;url&quot; value=&quot;$&#123;url&#125;&quot;&gt;&lt;/property&gt; &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot;&gt;&lt;/property&gt; &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;!-- springä¸­åŸºäºæ³¨è§£ çš„å£°æ˜å¼äº‹åŠ¡æ§åˆ¶é…ç½®æ­¥éª¤ 1ã€é…ç½®äº‹åŠ¡ç®¡ç†å™¨ 2ã€å¼€å¯springå¯¹æ³¨è§£äº‹åŠ¡çš„æ”¯æŒ 3ã€åœ¨éœ€è¦äº‹åŠ¡æ”¯æŒçš„åœ°æ–¹ä½¿ç”¨@Transactionalæ³¨è§£ --&gt; &lt;!-- é…ç½®äº‹åŠ¡ç®¡ç†å™¨ --&gt; &lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;!-- å¼€å¯springå¯¹æ³¨è§£äº‹åŠ¡çš„æ”¯æŒ--&gt; &lt;tx:annotation-driven&gt;&lt;/tx:annotation-driven&gt; &lt;!--ç»„ä»¶æ‰«æ--&gt; &lt;context:component-scan base-package=&quot;com.es&quot;&gt;&lt;/context:component-scan&gt;&lt;/beans&gt; æŒä¹…å±‚ 1234567891011121314151617181920212223242526272829/** * è´¦æˆ·çš„æŒä¹…å±‚å®ç°ç±» */@Repository(&quot;accountDao&quot;)public class AccountDaoImpl implements IAccountDao &#123; @Autowired private JdbcTemplate jdbcTemplate; public Account findAccountById(Integer accountId) &#123; List&lt;Account&gt; accounts = jdbcTemplate.query(&quot;select * from account where id = ?&quot;,new BeanPropertyRowMapper&lt;Account&gt;(Account.class),accountId); return accounts.isEmpty()?null:accounts.get(0); &#125; public Account findAccountByName(String accountName) &#123; List&lt;Account&gt; accounts = jdbcTemplate.query(&quot;select * from account where name = ?&quot;,new BeanPropertyRowMapper&lt;Account&gt;(Account.class),accountName); if(accounts.isEmpty())&#123; return null; &#125; if(accounts.size()&gt;1)&#123; throw new RuntimeException(&quot;ç»“æœé›†ä¸å”¯ä¸€&quot;); &#125; return accounts.get(0); &#125; public void updateAccount(Account account) &#123; jdbcTemplate.update(&quot;update account set name=?,money=? where id=?&quot;,account.getName(),account.getMoney(),account.getId()); &#125;&#125; æœåŠ¡å±‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243/** * è´¦æˆ·çš„ä¸šåŠ¡å±‚å®ç°ç±» * * äº‹åŠ¡æ§åˆ¶åº”è¯¥éƒ½æ˜¯åœ¨ä¸šåŠ¡å±‚ */@Service(&quot;accountService&quot;)@Transactional(readOnly = false,propagation = Propagation.SUPPORTS)public class AccountServiceImpl implements IAccountService&#123; @Autowired private IAccountDao accountDao; public void setAccountDao(IAccountDao accountDao) &#123; this.accountDao = accountDao; &#125; public Account findAccountById(Integer accountId) &#123; return accountDao.findAccountById(accountId); &#125; @Transactional(readOnly = false,propagation = Propagation.REQUIRED) public void transfer(String sourceName, String targetName, Float money) &#123; System.out.println(&quot;transfer....&quot;); //2.1æ ¹æ®åç§°æŸ¥è¯¢è½¬å‡ºè´¦æˆ· Account source = accountDao.findAccountByName(sourceName); //2.2æ ¹æ®åç§°æŸ¥è¯¢è½¬å…¥è´¦æˆ· Account target = accountDao.findAccountByName(targetName); //2.3è½¬å‡ºè´¦æˆ·å‡é’± source.setMoney(source.getMoney()-money); //2.4è½¬å…¥è´¦æˆ·åŠ é’± target.setMoney(target.getMoney()+money); //2.5æ›´æ–°è½¬å‡ºè´¦æˆ· accountDao.updateAccount(source); int i=1/0; //2.6æ›´æ–°è½¬å…¥è´¦æˆ· accountDao.updateAccount(target); &#125;&#125; æµ‹è¯•ç±»â€‹ 12345678910@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration(locations = &quot;classpath:applicationContext.xml&quot;)public class Test1 &#123; @Autowired private IAccountService service; @Test public void test1()&#123; service.transfer(&quot;aaa&quot;,&quot;bbb&quot;,1000f); &#125;&#125;","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[åäº”]äº‹åŠ¡å¢å¼ºå™¨æºç åˆ†æ","slug":"Spring/Spring[åäº”]äº‹åŠ¡å¢å¼ºå™¨æºç åˆ†æ","date":"2022-01-11T06:11:10.808Z","updated":"2022-01-11T06:18:09.756Z","comments":true,"path":"2022/01/11/Spring/Spring[åäº”]äº‹åŠ¡å¢å¼ºå™¨æºç åˆ†æ/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E5%8D%81%E4%BA%94]%E4%BA%8B%E5%8A%A1%E5%A2%9E%E5%BC%BA%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","excerpt":"","text":"åœ¨ä¸Šä¸€ç¯‡å›é¡¾äº†ä¸€ä¸‹ä¼ ç»Ÿçš„JDBCäº‹åŠ¡ï¼Œå¹¶åˆ†æäº†Springè§£æäº‹åŠ¡æ ‡ç­¾ï¼Œåˆ›å»ºäº‹åŠ¡ä»£ç†å¯¹è±¡çš„æºç ï¼Œæœ¬ç¯‡æˆ‘ä»¬æ¥åˆ†æåœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œçš„å‰åï¼Œäº‹åŠ¡å¢å¼ºå™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ 1.ç›¸å…³æ¥å£ åœ¨åˆ†æäº‹åŠ¡å¢å¼ºå™¨çš„æºç ä¹‹å‰ï¼Œå…ˆæ¥è¿‡ä¸€äº›æ¥å£ï¼Œæ˜ç¡®æ¥å£çš„ä½œç”¨å’Œæ¥å£ä¹‹é—´çš„å…³ç³»ã€‚ java jdbcè§„èŒƒæ¥å£ï¼šDataSourceã€ Connection äº‹åŠ¡å±æ€§æ‰¿è½½å¯¹è±¡ï¼šTransactionAttribute äº‹åŠ¡ç®¡ç†å™¨ï¼šTransactionManagerã€PlatformTransactionManager æ•°æ®åº“é“¾æ¥holderï¼šConnectionHolder SpringæŠ½è±¡å‡ºæ¥çš„äº‹åŠ¡å¯¹è±¡ï¼šJdbcTransactionObjectSupportã€DataSourceTransactionObject SpringæŠ½è±¡å‡ºæ¥çš„äº‹åŠ¡çŠ¶æ€ï¼ˆåŒ…è£…â€œäº‹åŠ¡å¯¹è±¡â€ï¼Œåšäº†ä¸€äº›å¢å¼ºï¼‰ï¼šAbstractTransactionStatusã€DefaultTransactionStatus SpringæŠ½è±¡å‡ºæ¥çš„äº‹åŠ¡ä¿¡æ¯ï¼ˆé›†å¤§æˆè€…â€œtxMgrâ€ã€â€œtxStatusâ€ã€â€œtxAttrâ€â€¦ï¼‰ï¼šTransactionInfo 2.äº‹åŠ¡å¢å¼ºå™¨ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æäº‹åŠ¡å¢å¼ºå™¨æºç ã€‚ â€‹ äº‹åŠ¡å¢å¼ºå™¨çš„å…¥å£è‡ªç„¶æ˜¯**invoke()**ã€‚â€‹ â€‹ 1234567891011121314151617181920212223242526272829303132333435363738/** * äº‹åŠ¡å¢å¼ºå™¨çš„å…¥å£ * invocationï¼šåç»­äº‹åŠ¡å¢å¼ºå™¨å‘åé©±åŠ¨äº‹åŠ¡æ‹¦æˆªå™¨çš„æ—¶å€™è¿˜éœ€è¦ä½¿ç”¨å®ƒ * @param invocation the method invocation joinpoint * @return * @throws Throwable */@Override@Nullablepublic Object invoke(MethodInvocation invocation) throws Throwable &#123; // Work out the target class: may be &#123;@code null&#125;. // The TransactionAttributeSource should be passed the target class // as well as the method, which may be from an interface. /*éœ€è¦è¢«äº‹åŠ¡å¢å¼ºå™¨å¢å¼ºçš„ç›®æ ‡ç±»å‹ * invocation.getThis() æ‹¿åˆ°ç›®æ ‡å¯¹è±¡ * */ Class&lt;?&gt; targetClass = (invocation.getThis() != null ? AopUtils.getTargetClass(invocation.getThis()) : null); // å‚æ•°ä¸€ï¼šç›®æ ‡æ–¹æ³• //å‚æ•°äºŒï¼šç›®æ ‡å¯¹è±¡ç±»å‹ //å‚æ•°ä¸‰ï¼š return invokeWithinTransaction(invocation.getMethod(), targetClass, new CoroutinesInvocationCallback() &#123; @Override @Nullable public Object proceedWithInvocation() throws Throwable &#123; return invocation.proceed(); &#125; @Override public Object getTarget() &#123; return invocation.getThis(); &#125; @Override public Object[] getArguments() &#123; return invocation.getArguments(); &#125; &#125;);&#125; æˆ‘ä»¬ç›´æ¥å¾€ä¸‹çœ‹**invokeWithinTransaction()**ã€‚â€‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162&#123; Object result; final ThrowableHolder throwableHolder = new ThrowableHolder(); // It&#x27;s a CallbackPreferringPlatformTransactionManager: pass a TransactionCallback in. try &#123; result = ((CallbackPreferringPlatformTransactionManager) ptm).execute(txAttr, status -&gt; &#123; TransactionInfo txInfo = prepareTransactionInfo(ptm, txAttr, joinpointIdentification, status); try &#123; Object retVal = invocation.proceedWithInvocation(); if (retVal != null &amp;&amp; vavrPresent &amp;&amp; VavrDelegate.isVavrTry(retVal)) &#123; // Set rollback-only in case of Vavr failure matching our rollback rules... retVal = VavrDelegate.evaluateTryFailure(retVal, txAttr, status); &#125; return retVal; &#125; catch (Throwable ex) &#123; if (txAttr.rollbackOn(ex)) &#123; // A RuntimeException: will lead to a rollback. if (ex instanceof RuntimeException) &#123; throw (RuntimeException) ex; &#125; else &#123; throw new ThrowableHolderException(ex); &#125; &#125; else &#123; // A normal return value: will lead to a commit. throwableHolder.throwable = ex; return null; &#125; &#125; finally &#123; cleanupTransactionInfo(txInfo); &#125; &#125;); &#125; catch (ThrowableHolderException ex) &#123; throw ex.getCause(); &#125; catch (TransactionSystemException ex2) &#123; if (throwableHolder.throwable != null) &#123; logger.error(&quot;Application exception overridden by commit exception&quot;, throwableHolder.throwable); ex2.initApplicationException(throwableHolder.throwable); &#125; throw ex2; &#125; catch (Throwable ex2) &#123; if (throwableHolder.throwable != null) &#123; logger.error(&quot;Application exception overridden by commit exception&quot;, throwableHolder.throwable); &#125; throw ex2; &#125; // Check result state: It might indicate a Throwable to rethrow. if (throwableHolder.throwable != null) &#123; throw throwableHolder.throwable; &#125; return result; &#125; &#125; è¿™ä¸ªæ–¹æ³•çš„å†…å®¹å¾ˆå¤šï¼šâ€‹ è·å–äº‹åŠ¡æ³¨è§£è§£æå™¨ï¼Œè§£æäº‹åŠ¡æ³¨è§£ è·å–äº‹åŠ¡åç§° åˆ¤æ–­å¦‚æœæ˜¯å£°æ˜å¼äº‹åŠ¡ **createTransactionIfNecessary()** åˆ›å»ºä¸€ä¸ªæœ€ä¸Šå±‚çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«æ‰€æœ‰çš„äº‹åŠ¡èµ„æº é©±åŠ¨æ–¹æ³•å¢å¼ºé€»è¾‘ç»§ç»­å¾€ä¸‹æ‰§è¡Œ **completeTransactionAfterThrowing(txInfo, ex)**æ‰§è¡Œä¸šåŠ¡ä»£ç å‡ºç°å¼‚å¸¸æ—¶çš„é€»è¾‘ **cleanupTransactionInfo(txInfo)**è¿˜åŸç°åœºé€»è¾‘ **commitTransactionAfterReturning(txInfo)**æäº¤äº‹åŠ¡é€»è¾‘ åˆ¤æ–­å¦‚æœæ˜¯ç¼–ç¨‹å¼äº‹åŠ¡ï¼Œèµ°ç¼–ç¨‹å¼äº‹åŠ¡çš„é€»è¾‘â€¦. â€‹ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æè¿™å‡ ä¸ªæ ¸å¿ƒé€»è¾‘ã€‚â€‹ 3.åˆ›å»ºæœ€ä¸Šå±‚çš„äº‹åŠ¡ä¸Šä¸‹æ–‡â€‹ è¿™é‡Œæ˜¯äº‹åŠ¡çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ¶‰åŠåˆ°äº‹åŠ¡åµŒå¥—å’Œä¼ æ’­è¡Œä¸ºï¼Œéš”ç¦»çº§åˆ«ã€‚â€‹ 1234567891011121314151617181920212223242526272829303132protected TransactionInfo createTransactionIfNecessary(@Nullable PlatformTransactionManager tm, @Nullable TransactionAttribute txAttr, final String joinpointIdentification) &#123; // If no name specified, apply method identification as transaction name. if (txAttr != null &amp;&amp; txAttr.getName() == null) &#123; //è¿›è¡Œä¸€ä¸ªåŒ…è£…ï¼Œæä¾›äº‹åŠ¡å txAttr = new DelegatingTransactionAttribute(txAttr) &#123; @Override public String getName() &#123; return joinpointIdentification; &#125; &#125;; &#125; //äº‹åŠ¡çŠ¶æ€å¯¹è±¡ TransactionStatus status = null; if (txAttr != null) &#123; if (tm != null) &#123; //æ ¹æ®äº‹ç‰©å±æ€§åˆ›å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œäº‹åŠ¡çŠ¶æ€ï¼šä¸€èˆ¬æƒ…å†µä¸‹åŒ…è£…ç€äº‹åŠ¡å¯¹è±¡ï¼›ç‰¹æ®Šæƒ…å†µ status.Transaction æœ‰å¯èƒ½ä¸ºç©º //æ–¹æ³•ä¸Šçš„æ³¨è§£ä¸º @Transactionalä¸Šçš„æ³¨è§£ ä¼ æ’­è¡Œä¸ºè®¾ç½®ä¸ºäº† NOT_SUPPORTED || NEVER //å…·ä½“çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³• status = tm.getTransaction(txAttr); &#125; else &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Skipping transactional joinpoint [&quot; + joinpointIdentification + &quot;] because no transaction manager has been configured&quot;); &#125; &#125; &#125; //åŒ…è£…æˆä¸€ä¸ªä¸Šå±‚çš„äº‹åŠ¡ä¸Šä¸‹æ–‡å¯¹è±¡ return prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);&#125; è·å–äº‹åŠ¡çŠ¶æ€å¯¹è±¡ åŒ…è£…æˆäº‹åŠ¡ä¸Šä¸‹æ–‡å¯¹è±¡ ä¸»è¦çš„é€»è¾‘åœ¨è¿™é‡Œ**getTransaction()**ã€‚\u0000 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859@Overridepublic final TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException &#123; // äº‹åŠ¡å±æ€§ä¿¡æ¯ TransactionDefinition def = (definition != null ? definition : TransactionDefinition.withDefaults()); //è·å–äº‹åŠ¡å¯¹è±¡ï¼Œéå¸¸å…³é”® Object transaction = doGetTransaction(); boolean debugEnabled = logger.isDebugEnabled(); //æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰æ˜¯é‡å…¥çš„äº‹åŠ¡çš„æƒ…å†µ //aå¼€å¯äº‹åŠ¡ aè°ƒç”¨b ï¼Œbä¹ŸåŠ äº†äº‹åŠ¡æ³¨è§£ ï¼Œå¼€å¯äº†äº‹åŠ¡çš„æƒ…å†µ if (isExistingTransaction(transaction)) &#123; //äº‹åŠ¡é‡å…¥çš„åˆ†æ”¯é€»è¾‘ ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°äº†ä¼ æ’­è¡Œä¸º // Existing transaction found -&gt; check propagation behavior to find out how to behave. return handleExistingTransaction(def, transaction, debugEnabled); &#125; //æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜å½“å‰çº¿ç¨‹æ²¡æœ‰ç»‘å®šè¿æ¥èµ„æºï¼Œæ²¡å¼€å¯äº‹åŠ¡ // Check definition settings for new transaction. if (def.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123; throw new InvalidTimeoutException(&quot;Invalid transaction timeout&quot;, def.getTimeout()); &#125; //ä½¿ç”¨å½“å‰äº‹åŠ¡ï¼Œæ²¡æœ‰äº‹åŠ¡å°±ä¼šæŠ›å‡ºå¼‚å¸¸ // No existing transaction found -&gt; check propagation behavior to find out how to proceed. if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123; throw new IllegalTransactionStateException( &quot;No existing transaction found for transaction marked with propagation &#x27;mandatory&#x27;&quot;); &#125; //PROPAGATION_REQUIRED PROPAGATION_REQUIRES_NEW PROPAGATION_NESTED åˆ™è¿›å…¥ else if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED || def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW || def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123; //æŒ‚èµ·äº†ä¸ªå¯‚å¯ï¼Œå› ä¸ºçº¿ç¨‹å¹¶æ²¡æœ‰ç»‘å®šäº‹åŠ¡ SuspendedResourcesHolder suspendedResources = suspend(null); if (debugEnabled) &#123; logger.debug(&quot;Creating new transaction with name [&quot; + def.getName() + &quot;]: &quot; + def); &#125; try &#123; //çº¿ç¨‹æœªå¼€å¯äº‹åŠ¡æ—¶ï¼Œè¿™ä¸‰ç§æƒ…å†µéƒ½ä¼šå»å¼€å¯ä¸€ä¸ªæ–°çš„äº‹ç‰© //å¼€å¯äº‹åŠ¡çš„é€»è¾‘ return startTransaction(def, transaction, debugEnabled, suspendedResources); &#125; catch (RuntimeException | Error ex) &#123; resume(null, suspendedResources); throw ex; &#125; &#125; else &#123; //èµ°åˆ°è¿™é‡Œæ˜¯ä»€ä¹ˆæƒ…å†µï¼Ÿ support || not support || never //æ²¡æœ‰ä½¿ç”¨æ–°çš„äº‹åŠ¡ // Create &quot;empty&quot; transaction: no actual transaction, but potentially synchronization. if (def.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123; logger.warn(&quot;Custom isolation level specified but no actual transaction initiated; &quot; + &quot;isolation level will effectively be ignored: &quot; + def); &#125; boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS); return prepareTransactionStatus(def, null, true, newSynchronization, debugEnabled, null); &#125;&#125; è·å–äº‹åŠ¡å±æ€§ä¿¡æ¯&amp;äº‹åŠ¡å¯¹è±¡ å¦‚æœæ˜¯äº‹åŠ¡é‡å…¥çš„é€»è¾‘ï¼Œå°±åšäº‹åŠ¡é‡å…¥é€»è¾‘çš„å¤„ç† åˆ¤æ–­å½“å‰äº‹åŠ¡å¦‚æœè¶…æ—¶äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸ PROPAGATION_MANDATORYï¼Œæœ‰å°±ä½¿ç”¨å½“å‰äº‹åŠ¡ï¼Œæ²¡æœ‰å°±æŠ›å¼‚å¸¸ PROPAGATION_REQUIRED PROPAGATION_REQUIRES_NEW PROPAGATION_NESTED å¼€å¯ä¸€ä¸ªæ–°çš„äº‹ç‰© support || not support || never æ²¡æœ‰ä½¿ç”¨æ–°çš„äº‹åŠ¡ï¼Œä¸ä¼šä¸»åŠ¨å¼€å¯ æœ€ç»ˆæ„å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡ **doGetTransaction() è·å–äº‹åŠ¡å¯¹è±¡ã€‚**â€‹ **handleExistingTransaction()å¤„ç†äº‹åŠ¡é‡å…¥çš„é€»è¾‘ã€‚**â€‹ **startTransaction()å¼€å¯æ–°äº‹ç‰©çš„é€»è¾‘ã€‚**â€‹ 3.1 è·å–äº‹åŠ¡å¯¹è±¡1234567891011121314151617@Overrideprotected Object doGetTransaction() &#123; //å…ˆåˆ›å»ºäº‹åŠ¡å¯¹è±¡ DataSourceTransactionObject txObject = new DataSourceTransactionObject(); //äº‹åŠ¡çš„ä¿å­˜ç‚¹ï¼Œè¿™ä¸ªç”±äº‹åŠ¡ç®¡ç†å™¨æ§åˆ¶ txObject.setSavepointAllowed(isNestedTransactionAllowed()); //TransactionSynchronizationManager äº‹åŠ¡åŒæ­¥ç®¡ç†å™¨ //ä»tlä¸­è·å–è¿æ¥èµ„æºï¼Œæœ‰å¯èƒ½æ‹¿åˆ°nullï¼Œä¹Ÿæœ‰å¯èƒ½ä¸æ˜¯null //ä»€ä¹ˆæ—¶å€™æ˜¯nullï¼Œä»€ä¹ˆæ—¶å€™ä¸æ˜¯nullï¼Ÿ //==null:äº‹åŠ¡æ–¹æ³•aè°ƒç”¨äº†éäº‹åŠ¡æ–¹æ³•b //!=null:äº‹åŠ¡æ–¹æ³•aè°ƒç”¨äº†äº‹åŠ¡æ–¹æ³•b ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(obtainDataSource()); //ä¸ºäº‹åŠ¡å¯¹è±¡èµ‹èƒ½ï¼Œå‚æ•°äºŒä¼ é€’çš„falseï¼Œ è¡¨ç¤ºå½“å‰äº‹åŠ¡æ˜¯å¦æ–°åˆ†é…äº†è¿æ¥èµ„æºï¼Œè€Œä¸æ˜¯å’Œä¸Šå±‚äº‹åŠ¡å…±äº«ï¼Œé»˜è®¤æ˜¯falseï¼Œè¡¨ç¤ºå…±äº«ã€‚ txObject.setConnectionHolder(conHolder, false); return txObject;&#125; 3.2å¤„ç†äº‹åŠ¡é‡å…¥123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105private TransactionStatus handleExistingTransaction( TransactionDefinition definition, /*äº‹åŠ¡å±æ€§*/Object transaction/*äº‹åŠ¡å¯¹è±¡*/, boolean debugEnabled) throws TransactionException &#123; /* è¿›å…¥è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æŒæœ‰ä¸€ä¸ªäº‹åŠ¡äº†ï¼Œéœ€è¦æ ¹æ®æ–°æ–¹æ³•çš„äº‹åŠ¡æ³¨è§£ä¼ æ’­è¡Œä¸ºï¼Œèµ°ä¸åŒçš„é€»è¾‘ */ //PROPAGATION_NEVERï¼šéœ€è¦æŠ›å¼‚å¸¸ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) &#123; throw new IllegalTransactionStateException( &quot;Existing transaction found for transaction marked with propagation &#x27;never&#x27;&quot;); &#125; //PROPAGATION_NOT_SUPPORTEDï¼šæœ‰äº‹åŠ¡å°±æŒ‚èµ·å½“å‰äº‹åŠ¡ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) &#123; if (debugEnabled) &#123; logger.debug(&quot;Suspending current transaction&quot;); &#125; //çœ‹ä¸€ä¸‹æŒ‚èµ·çš„é€»è¾‘ Object suspendedResources = suspend(transaction); boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS); //å°†æŒ‚èµ·äº‹åŠ¡è¿”å›çš„ æŒ‚èµ·æŒæœ‰è€…å¯¹è±¡(è¿™é‡Œé¢æŒæœ‰ä¸Šä¸€ä¸ªäº‹åŠ¡å¯¹è±¡çš„è¿æ¥èµ„æºå’Œçº¿ç¨‹ä¸Šä¸‹æ–‡å‚æ•°) ç»™äº‹åŠ¡çŠ¶æ€å¯¹è±¡èµ‹èƒ½ //step into åˆ›å»ºä¸€ä¸ªæ–°çš„ äº‹åŠ¡çŠ¶æ€å¯¹è±¡ ï¼Œè¿™é‡Œçš„ç¬¬äºŒä¸ªå‚æ•° äº‹åŠ¡ ä¸ºnull ï¼›è¡¨ç¤ºçº¿ç¨‹æ‰§è¡Œåˆ°å½“å‰æ–¹æ³•æ‰§è¡Œåˆ°äº‹åŠ¡å¢å¼ºçš„åç½®å¤„ç†é€»è¾‘çš„æ—¶å€™ //æäº¤äº‹åŠ¡çš„æ—¶å€™ä¼šæ£€æŸ¥äº‹åŠ¡çŠ¶æ€çš„äº‹åŠ¡æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæ²¡æœ‰å€¼ï¼ŒSpringå°±ä¸ä¼šåšæäº¤çš„æ“ä½œã€‚ //å‚æ•°6ï¼šsuspendedResources çº¿ç¨‹æ‰§è¡Œåˆ°åç½®å¤„ç†çš„é€»è¾‘çš„æ—¶å€™ï¼Œæ‰§è¡Œåˆ°æ¢å¤ç°åœºçš„æ—¶å€™ä¼šæ£€æŸ¥è¿™ä¸ªå‚æ•°æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼ä¼šè¿›è¡Œæ¢å¤ç°åœºçš„æ“ä½œã€‚ return prepareTransactionStatus( definition, null/*è¯´æ˜å½“å‰çº¿ç¨‹æœªæ‰‹åŠ¨å¼€å¯äº‹åŠ¡ï¼Œè¿æ¥æ˜¯ç›´æ¥ä»æ•°æ®æºæ‹¿çš„ï¼Œä¸éœ€è¦æ‰‹åŠ¨æäº¤äº‹åŠ¡äº†*/, false, newSynchronization, debugEnabled, suspendedResources); &#125; //PROPAGATION_REQUIRES_NEWï¼šæŒ‚èµ·å½“å‰äº‹åŠ¡ï¼Œå¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) &#123; if (debugEnabled) &#123; logger.debug(&quot;Suspending current transaction, creating new transaction with name [&quot; + definition.getName() + &quot;]&quot;); &#125; //æŒ‚èµ·ä¸Šå±‚äº‹åŠ¡ï¼Œæ–°å»ºäº‹åŠ¡ SuspendedResourcesHolder suspendedResources = suspend(transaction); try &#123; //å¼€å¯ä¸€ä¸ªä¸“å±äºå½“å‰æ–¹æ³•çš„æ–°äº‹åŠ¡ï¼Œå› ä¸ºå½“å‰æ–¹æ³•è¢«æŒ‚èµ·çš„äº‹åŠ¡æ‰§è¡Œå®Œå½“å‰æ–¹æ³•åè¿˜è¦å›åˆ°ä¸Šå±‚ç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥ //suspendedResourcesç”¨æ¥æ¢å¤ç°åœº return startTransaction(definition, transaction, debugEnabled, suspendedResources); &#125; catch (RuntimeException | Error beginEx) &#123; resumeAfterBeginException(transaction, suspendedResources, beginEx); throw beginEx; &#125; &#125; //åµŒå¥—äº‹åŠ¡çš„é€»è¾‘ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œ ï¼Œ //å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä¸requiredçš„æ“ä½œç±»ä¼¼ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123; //é»˜è®¤æƒ…å†µä¸‹ï¼Œspringæ˜¯ä¸å¼€å¯è¿™ç§ä¼ æ’­è¡Œä¸ºçš„ï¼Œé™¤éæ‰‹åŠ¨å¼€å¯ï¼Œæ‰€ä»¥é»˜è®¤æ˜¯falseã€‚ if (!isNestedTransactionAllowed()) &#123; throw new NestedTransactionNotSupportedException( &quot;Transaction manager does not allow nested transactions by default - &quot; + &quot;specify &#x27;nestedTransactionAllowed&#x27; property with value &#x27;true&#x27;&quot;); &#125; if (debugEnabled) &#123; logger.debug(&quot;Creating nested transaction with name [&quot; + definition.getName() + &quot;]&quot;); &#125; //ä¸€èˆ¬æˆç«‹ï¼Œé»˜è®¤æ˜¯true if (useSavepointForNestedTransaction()) &#123; // ä¸ºå½“å‰æ–¹æ³•åˆ›å»ºä¸€ä¸ª äº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œå…±äº«çš„ä¸Šå±‚äº‹åŠ¡ï¼Œæ‰§è¡Œçš„æ‰©å±•ç‚¹æ˜¯å¤–å±‚çš„ï¼Œä¹Ÿä¸éœ€è¦æŒ‚èµ·äº‹åŠ¡ã€‚ DefaultTransactionStatus status = prepareTransactionStatus(definition, transaction, false, false, debugEnabled, null); //åˆ›å»ºä¸€ä¸ªä¿å­˜ç‚¹ ï¼Œé‡è¦ï¼ï¼ï¼ status.createAndHoldSavepoint(); return status; &#125; else &#123; // å¼€å¯æ–°äº‹ç‰© return startTransaction(definition, transaction, debugEnabled, null); &#125; &#125; if (debugEnabled) &#123; logger.debug(&quot;Participating in existing transaction&quot;); &#125; //æ˜¯å¦éœ€è¦éªŒè¯ï¼Œé»˜è®¤æ˜¯false if (isValidateExistingTransaction()) &#123; if (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT) &#123; Integer currentIsolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel(); if (currentIsolationLevel == null || currentIsolationLevel != definition.getIsolationLevel()) &#123; Constants isoConstants = DefaultTransactionDefinition.constants; throw new IllegalTransactionStateException(&quot;Participating transaction with definition [&quot; + definition + &quot;] specifies isolation level which is incompatible with existing transaction: &quot; + (currentIsolationLevel != null ? isoConstants.toCode(currentIsolationLevel, DefaultTransactionDefinition.PREFIX_ISOLATION) : &quot;(unknown)&quot;)); &#125; &#125; if (!definition.isReadOnly()) &#123; if (TransactionSynchronizationManager.isCurrentTransactionReadOnly()) &#123; throw new IllegalTransactionStateException(&quot;Participating transaction with definition [&quot; + definition + &quot;] is not marked as read-only but existing transaction is&quot;); &#125; &#125; &#125; /* æ‰§è¡Œåˆ°è¿™é‡Œå°±å‰©ä¸‹ required &amp; supports */ boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER); //prepareTransactionStatusï¼ˆï¼‰ä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œå±äºæ„é€ å™¨é‡è½½é€»è¾‘ //å‚æ•°äºŒï¼šäº‹åŠ¡å¯¹è±¡ -&gt; connHodler æ˜¯ doGetTransaction()çš„æ—¶å€™ä»è¥¿å®‰åŸä¸Šä¸‹æ–‡å†…è·å–çš„ä¸Šå±‚äº‹åŠ¡çš„è¿æ¥èµ„æº //å‚æ•°å…­ï¼šæ˜¯ç©ºï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰æŒ‚èµ·ä»»ä½•äº‹åŠ¡ return prepareTransactionStatus(definition, transaction/*äº‹åŠ¡ä¹Ÿæ˜¯ä½¿ç”¨ä¸Šå±‚çš„*/, false/*è¡¨ç¤ºå¹¶ä¸æ˜¯ä¸€ä¸ªä¸ºè‡ªå·±åˆ›å»ºçš„äº‹åŠ¡ï¼Œä¸ä¸Šå±‚æ–¹æ³•å…±äº«*/, newSynchronization, debugEnabled, null);&#125; PROPAGATION_NEVERï¼šéœ€è¦æŠ›å¼‚å¸¸ PROPAGATION_NOT_SUPPORTEDï¼šæœ‰äº‹åŠ¡å°±æŒ‚èµ·å½“å‰äº‹åŠ¡ PROPAGATION_REQUIRES_NEWï¼šæŒ‚èµ·å½“å‰äº‹åŠ¡ï¼Œå¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ åµŒå¥—äº‹åŠ¡çš„é€»è¾‘ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œ ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä¸requiredçš„æ“ä½œç±»ä¼¼ required &amp; supportsï¼Œä¸ä¼šåˆ›å»ºäº‹åŠ¡å¯¹è±¡ æœ€ç»ˆåˆ›å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡å¹¶è¿”å› â€‹ çœ‹ä¸€ä¸‹åˆ›å»ºäº‹åŠ¡ä¿å­˜ç‚¹çš„é€»è¾‘ï¼Œ**createAndHoldSavepoint()**ã€‚ 123456public void createAndHoldSavepoint() throws TransactionException &#123; /* getSavepointManager()ï¼šè¿™é‡Œå®é™…ä¸Šå°±æ‰§è¡Œåˆ°äº†jdbcçš„æ–¹æ³•ï¼Œåˆ›å»ºä¿å­˜ç‚¹ï¼Œç„¶åä¿å­˜ã€‚ */ setSavepoint(getSavepointManager().createSavepoint());&#125; 3.3 å¼€å¯æ–°äº‹ç‰©1234567891011121314private TransactionStatus startTransaction(TransactionDefinition definition, Object transaction, boolean debugEnabled, @Nullable SuspendedResourcesHolder suspendedResources) &#123; //ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯true ï¼Œè¿™ä¸ªå€¼æ§åˆ¶æ˜¯å¦æ‰§è¡Œäº‹åŠ¡çš„æ‰©å±•é€»è¾‘ï¼Œè¿™ä¸œè¥¿æœ‰ç‚¹ç±»ä¼¼iocçš„åç½®å¤„ç†å™¨ boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER); //åˆ›å»ºé»˜è®¤çš„äº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºtrueï¼Œä¼šä¸ºå½“å‰äº‹åŠ¡åˆ†é… è¿æ¥èµ„æºï¼Œå°±æ˜¯äº‹åŠ¡æ˜¯ä¸“é—¨ä¸ºäº†å½“å‰æ–¹æ³•å¼€å¯çš„ //suspendedResources:è¡¨ç¤ºæŒ‚èµ·çš„äº‹åŠ¡ ï¼Œä»ä¸Šé¢è¿‡æ¥è¿™é‡Œå®é™…ä¸Šæ˜¯nullã€‚ DefaultTransactionStatus status = newTransactionStatus( definition, transaction, true, newSynchronization, debugEnabled, suspendedResources); //å¼€å¯äº‹åŠ¡ æ ¸å¿ƒé€»è¾‘ ï¼Œå‚æ•°ä¸€ï¼šäº‹åŠ¡å¯¹è±¡ï¼›å‚æ•°äºŒï¼šäº‹åŠ¡å±æ€§ doBegin(transaction, definition); //å¤„ç†TransactionSynchronization prepareSynchronization(status, definition); return status;&#125; æ ¸å¿ƒé€»è¾‘åœ¨è¿™é‡Œ**doBegin()**ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263@Overrideprotected void doBegin(Object transaction, TransactionDefinition definition) &#123; //äº‹åŠ¡å¯¹è±¡ DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction; Connection con = null; try &#123;/*åˆ¤æ–­å½“å‰äº‹åŠ¡å¯¹è±¡æ˜¯ä¸æ˜¯æœ‰çº¿ç¨‹èµ„æºï¼Œæ²¡æœ‰å°±ä¼šèµ°ifçš„é€»è¾‘ï¼Œæœ‰å°±è¯´æ˜éœ€è¦ä¸ºå½“å‰æ–¹æ³•åˆ†ä¸ºè¿æ¥èµ„æº*/ if (!txObject.hasConnectionHolder() || txObject.getConnectionHolder().isSynchronizedWithTransaction()) &#123; //é€šè¿‡æ•°æ®æºæ‹¿åˆ°çœŸå®çš„æ•°æ®åº“è¿æ¥ Connection newCon = obtainDataSource().getConnection(); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Acquired Connection [&quot; + newCon + &quot;] for JDBC transaction&quot;); &#125; //é‡ç‚¹ï¼šå°†ä¸Šä¸€æ­¥åˆ›å»ºçš„æ•°æ®åº“è¿æ¥åŒ…è£…ä¸ºConnectionHolderï¼Œå¹¶ä¸”ä¸ºäº‹åŠ¡å¯¹è±¡èµ‹èƒ½ //å‚æ•°äºŒå¾ˆå…³é”®ï¼Œç»™äº‹åŠ¡æ–°ç”³è¯·çš„è€Œè¿æ¥èµ„æºï¼Œé‚£ä¹ˆå°±å°†äº‹åŠ¡å¯¹è±¡çš„ newConnectionHolder è®¾ç½®ä¸ºtrueã€‚è¡¨ç¤ºå½“å‰ç›®æ ‡æ–¹æ³•å¼€å¯äº†ä¸€ä¸ªè‡ªå·±çš„äº‹åŠ¡ã€‚ txObject.setConnectionHolder(new ConnectionHolder(newCon), true); &#125; txObject.getConnectionHolder().setSynchronizedWithTransaction(true); //è·å–äº‹åŠ¡å¯¹è±¡å•†çš„æ•°æ®åº“è¿æ¥ con = txObject.getConnectionHolder().getConnection(); //ä¿®æ”¹æ•°æ®åº“è¿æ¥ä¸Šçš„ä¸€äº›å±æ€§ step into Integer previousIsolationLevel = DataSourceUtils.prepareConnectionForTransaction(con, definition); //å°†è¿æ¥åŸæ¥çš„éš”ç¦»çº§åˆ«ä¿å­˜åˆ°äº‹åŠ¡å¯¹è±¡ï¼Œæ–¹ä¾¿é‡Šæ”¾è¿æ¥çš„æ—¶å€™ï¼Œè®¾ç½®å›åŸæ¥çš„çŠ¶æ€ txObject.setPreviousIsolationLevel(previousIsolationLevel); txObject.setReadOnly(definition.isReadOnly()); //å¦‚æœè¿æ¥çš„è‡ªåŠ¨æäº¤æ˜¯trueï¼Œä¸€èˆ¬ä¼šæˆç«‹ if (con.getAutoCommit()) &#123; //å› ä¸ºæ¥ä¸‹æ¥å°±æ˜¯è®¾ç½®è‡ªåŠ¨æäº¤ä¸ºfalseï¼Œè¿™é‡Œè®¾ç½® must ï¼Œè¡¨ç¤ºå›å¤´é‡Šæ”¾çš„æ—¶å€™è¦è®¾ç½®å›å» txObject.setMustRestoreAutoCommit(true); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Switching JDBC Connection [&quot; + con + &quot;] to manual commit&quot;); &#125; //æºå¤´ï¼Œç›¸å½“äºåœ¨æ•°æ®åº“å¼€å¯äº†äº‹åŠ¡ con.setAutoCommit(false); &#125; //æ²¡å•¥å®é™…çš„ä¸œè¥¿ prepareTransactionalConnection(con, definition); //æ¿€æ´»holderçš„äº‹åŠ¡çŠ¶æ€ txObject.getConnectionHolder().setTransactionActive(true); //è·å–è¶…æ—¶æ—¶é—´ int timeout = determineTimeout(definition); //å¦‚æœæ—¶é—´ä¸ç›¸ç­‰ï¼Œå°±è®¾ç½® if (timeout != TransactionDefinition.TIMEOUT_DEFAULT) &#123; txObject.getConnectionHolder().setTimeoutInSeconds(timeout); &#125; // å¦‚æœæ˜¯æ–°å¼€å¯çš„äº‹åŠ¡ï¼Œåˆ†é…äº†æ–°çš„è¿æ¥å°±ä¼šæˆç«‹ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å°†çº¿ç¨‹å’Œè¿æ¥è¿›è¡Œä¸€ä¸ªç»‘å®š tl if (txObject.isNewConnectionHolder()) &#123; TransactionSynchronizationManager.bindResource(obtainDataSource(), txObject.getConnectionHolder()); &#125; &#125; catch (Throwable ex) &#123; if (txObject.isNewConnectionHolder()) &#123; DataSourceUtils.releaseConnection(con, obtainDataSource()); txObject.setConnectionHolder(null, false); &#125; throw new CannotCreateTransactionException(&quot;Could not open JDBC Connection for transaction&quot;, ex); &#125;&#125; åˆ¤æ–­å½“å‰äº‹åŠ¡å¯¹è±¡æ˜¯ä¸æ˜¯æœ‰çº¿ç¨‹èµ„æºï¼Œæ²¡æœ‰å°±ä¼šèµ°ifçš„é€»è¾‘ï¼Œæœ‰å°±è¯´æ˜éœ€è¦ä¸ºå½“å‰æ–¹æ³•åˆ†ä¸ºè¿æ¥èµ„æº é€šè¿‡æ•°æ®æºæ‹¿åˆ°çœŸå®çš„æ•°æ®åº“è¿æ¥ å°†ä¸Šä¸€æ­¥åˆ›å»ºçš„æ•°æ®åº“è¿æ¥åŒ…è£…ä¸ºConnectionHolderï¼Œå¹¶ä¸”ä¸ºäº‹åŠ¡å¯¹è±¡èµ‹èƒ½ è·å–äº‹åŠ¡å¯¹è±¡å•†çš„æ•°æ®åº“è¿æ¥ ä¿®æ”¹æ•°æ®åº“è¿æ¥ä¸Šçš„ä¸€äº›å±æ€§ å°†è¿æ¥åŸæ¥çš„éš”ç¦»çº§åˆ«ä¿å­˜åˆ°äº‹åŠ¡å¯¹è±¡ï¼Œæ–¹ä¾¿é‡Šæ”¾è¿æ¥çš„æ—¶å€™ï¼Œè®¾ç½®å›åŸæ¥çš„çŠ¶æ€ å¦‚æœè¿æ¥çš„è‡ªåŠ¨æäº¤æ˜¯trueï¼Œæ”¹æˆfalse æ¿€æ´»holderçš„äº‹åŠ¡çŠ¶æ€ è®¾ç½®è¶…æ—¶æ—¶é—´ å¦‚æœæ˜¯æ–°å¼€å¯çš„äº‹åŠ¡ï¼Œåˆ†é…äº†æ–°çš„è¿æ¥å°±ä¼šæˆç«‹ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å°†çº¿ç¨‹å’Œè¿æ¥è¿›è¡Œä¸€ä¸ªç»‘å®š tl 4.å¼‚å¸¸å›æ»šé€»è¾‘12345678910111213141516171819202122232425262728293031323334353637383940414243protected void completeTransactionAfterThrowing(@Nullable TransactionInfo txInfo/*å½“å‰äº‹åŠ¡ä¸Šä¸‹æ–‡*/, Throwable ex/*ç›®æ ‡æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯*/) &#123; if (txInfo != null &amp;&amp; txInfo.getTransactionStatus() != null) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Completing transaction for [&quot; + txInfo.getJoinpointIdentification() + &quot;] after exception: &quot; + ex); &#125; //æ¡ä»¶ä¸€ï¼šä¸€èˆ¬éƒ½æ˜¯æˆç«‹çš„ //æ¡ä»¶äºŒï¼štransactionAttribute.rollbackOn(ex) åˆ¤æ–­ç›®æ ‡æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸æ˜¯å¦éœ€è¦å›æ»šï¼Œæ¡ä»¶æˆç«‹ï¼Œè¯´æ˜éœ€è¦å›æ»šã€‚ if (txInfo.transactionAttribute != null &amp;&amp; txInfo.transactionAttribute.rollbackOn(ex)) &#123; try &#123; //å¦‚æœéœ€è¦å›æ»šï¼Œå°±ä¼šèµ°åˆ°äº‹åŠ¡ç®¡ç†å™¨çš„å›æ»šé€»è¾‘ txInfo.getTransactionManager().rollback(txInfo.getTransactionStatus()/*å½“å‰äº‹åŠ¡çŠ¶æ€å¯¹è±¡*/); &#125; catch (TransactionSystemException ex2) &#123; logger.error(&quot;Application exception overridden by rollback exception&quot;, ex); ex2.initApplicationException(ex); throw ex2; &#125; catch (RuntimeException | Error ex2) &#123; logger.error(&quot;Application exception overridden by rollback exception&quot;, ex); throw ex2; &#125; &#125; else &#123; //æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜å½“å‰äº‹åŠ¡è™½ç„¶æŠ›å‡ºäº†å¼‚å¸¸ï¼Œä½†æ˜¯è¯¥å¼‚å¸¸å¹¶ä¸ä¼šå¯¼è‡´æ•´ä¸ªäº‹åŠ¡å›æ»š // We don&#x27;t roll back on this exception. // Will still roll back if TransactionStatus.isRollbackOnly() is true. try &#123; txInfo.getTransactionManager().commit(txInfo.getTransactionStatus()); &#125; catch (TransactionSystemException ex2) &#123; logger.error(&quot;Application exception overridden by commit exception&quot;, ex); ex2.initApplicationException(ex); throw ex2; &#125; catch (RuntimeException | Error ex2) &#123; logger.error(&quot;Application exception overridden by commit exception&quot;, ex); throw ex2; &#125; &#125; &#125;&#125; åˆ¤æ–­ç›®æ ‡æ–¹æ³•çš„å¼‚å¸¸æ˜¯å¦éœ€è¦å›æ»šï¼Ÿ éœ€è¦ï¼Œ**rollback()**ã€‚ ä¸éœ€è¦ï¼Œ**commit()**ã€‚ â€‹ æ¥çœ‹ä¸€ä¸‹**rollback()**çš„é€»è¾‘ã€‚â€‹ 1234567891011@Overridepublic final void rollback(TransactionStatus status) throws TransactionException &#123; if (status.isCompleted()) &#123; throw new IllegalTransactionStateException( &quot;Transaction is already completed - do not call commit or rollback more than once per transaction&quot;); &#125; DefaultTransactionStatus defStatus = (DefaultTransactionStatus) status; //çœ‹è¿™ä¸ªé€»è¾‘ processRollback(defStatus, false);&#125; ç»§ç»­å¾€ä¸‹çœ‹**processRollback()**ã€‚â€‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475private void processRollback(DefaultTransactionStatus status, boolean unexpected) &#123; try &#123; boolean unexpectedRollback = unexpected; try &#123; //äº‹åŠ¡æ‰©å±•é€»è¾‘çš„è°ƒç”¨ç‚¹ triggerBeforeCompletion(status); //è¯´æ˜å½“å‰äº‹åŠ¡æ˜¯ä¸€ä¸ªå†…åµŒäº‹åŠ¡ ï¼Œå½“å‰æ–¹æ³•ä½¿ç”¨çš„äº‹åŠ¡æ˜¯ä¸Šå±‚çš„äº‹åŠ¡ï¼Œå¦‚æœæœ‰ä¿å­˜ç‚¹ï¼Œå°±å›æ»šåˆ°ä¿å­˜ç‚¹ if (status.hasSavepoint()) &#123; if (status.isDebug()) &#123; logger.debug(&quot;Rolling back transaction to savepoint&quot;); &#125; //å›æ»šåˆ°ä¿å­˜ç‚¹çš„æ“ä½œ status.rollbackToHeldSavepoint(); &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ–¹æ³•æ˜¯ä¸€ä¸ªå¼€å¯äº†ä¸€ä¸ªæ–°çš„äº‹ç‰©çš„æ–¹æ³• else if (status.isNewTransaction()) &#123; if (status.isDebug()) &#123; logger.debug(&quot;Initiating transaction rollback&quot;); &#125; //å§”æ´¾æ¨¡å¼ï¼Œæ ¸å¿ƒé€»è¾‘ doRollback(status); &#125; else &#123; //æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ï¼Œè¿™ä¸ªäº‹åŠ¡ä¸æ˜¯å½“å‰æ–¹æ³•å¼€å¯çš„ ï¼ˆå…±äº«ä¸Šå±‚äº‹åŠ¡ï¼‰|| å½“å‰æ–¹æ³•å‹æ ¹æ²¡å¼€å¯äº‹åŠ¡ï¼ˆnot_supportsï¼Œnever, supportsï¼‰ // Participating in larger transaction //è¯´çš„æ˜¯ç¬¬ä¸€ç§æƒ…å†µï¼šå½“å‰æ–¹æ³•å…±äº«ä¸Šå±‚äº‹åŠ¡ if (status.hasTransaction()) &#123; //æ¡ä»¶ä¸€ï¼šä»€ä¹ˆæ—¶å€™æˆç«‹ï¼Ÿå½“å‰æ–¹æ³•å…±äº«ä¸Šå±‚äº‹åŠ¡ï¼Œä¸šåŠ¡ä»£ç å¼ºåˆ¶è®¾ç½®å½“å‰æ•´ä¸ªäº‹åŠ¡ éœ€è¦å›æ»šçš„è¯ï¼Œå¯ä»¥é€šè¿‡ è®¾ç½® status.isLocalRollbackOnly() = true //æ¡ä»¶äºŒï¼šé»˜è®¤æ˜¯true if (status.isLocalRollbackOnly() || isGlobalRollbackOnParticipationFailure()) &#123; if (status.isDebug()) &#123; logger.debug(&quot;Participating transaction failed - marking existing transaction as rollback-only&quot;); &#125; /* ä¸€ä¸ªå…±äº«ä¸Šå±‚äº‹åŠ¡çš„æ–¹æ³•å¯ä»¥ç›´æ¥å›æ»šå˜›ï¼Ÿä¸è¡Œçš„ï¼Œéœ€è¦å°†å›æ»šçš„æ“ä½œäº¤ç»™ä¸Šå±‚æ–¹æ³•æ¥åšã€‚ å¦‚ä½•äº¤ç»™ï¼Ÿè®¾ç½®status.isLocalRollbackOnly()=trueï¼Œè¿™æ ·çš„è¯ï¼Œçº¿ç¨‹å›åˆ°ä¸Šå±‚äº‹åŠ¡æäº¤é€»è¾‘çš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥è¯¥å­—æ®µï¼Œå‘ç°æ˜¯trueï¼Œå°±ä¼šæ‰§è¡Œå›æ»šé€»è¾‘ */ //è¿™é‡Œå…¶å®å°±æ˜¯è®¾ç½®å›æ»šå­—æ®µä¸ºtrue å…ˆæ‹¿åˆ°äº‹åŠ¡çŠ¶æ€å¯¹è±¡-&gt; äº‹åŠ¡å¯¹è±¡ -&gt; è¿æ¥æŒæœ‰è€… -&gt; è®¾ç½®rollbackOnly =trueã€‚ doSetRollbackOnly(status); &#125; else &#123; if (status.isDebug()) &#123; logger.debug(&quot;Participating transaction failed - letting transaction originator decide on rollback&quot;); &#125; &#125; &#125;//æ²¡æœ‰äº‹åŠ¡ else &#123; logger.debug(&quot;Should roll back transaction but cannot - no transaction available&quot;); &#125; // Unexpected rollback only matters here if we&#x27;re asked to fail early if (!isFailEarlyOnGlobalRollbackOnly()) &#123; unexpectedRollback = false; &#125; &#125; &#125; catch (RuntimeException | Error ex) &#123; //äº‹åŠ¡æ‰©å±•è°ƒç”¨ç‚¹ triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN); throw ex; &#125; //äº‹åŠ¡æ‰©å±•è°ƒç”¨ç‚¹ triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK); // Raise UnexpectedRollbackException if we had a global rollback-only marker if (unexpectedRollback) &#123; throw new UnexpectedRollbackException( &quot;Transaction rolled back because it has been marked as rollback-only&quot;); &#125; &#125; finally &#123; //çœ‹è¿™é‡Œ cleanupAfterCompletion(status); &#125;&#125; å…³æ³¨ä¸¤ä¸ªæ ¸å¿ƒçš„æ–¹æ³•**doRollback() &amp; rollbackToHeldSavepoint()**ã€‚ 1234567891011121314public void rollbackToHeldSavepoint() throws TransactionException &#123; //è·å–äº‹åŠ¡çš„ä¿å­˜ç‚¹ Object savepoint = getSavepoint(); if (savepoint == null) &#123; throw new TransactionUsageException( &quot;Cannot roll back to savepoint - no savepoint associated with current transaction&quot;); &#125; //å›æ»šåˆ°ä¿å­˜ç‚¹ getSavepointManager().rollbackToSavepoint(savepoint); //åˆ é™¤ä¿å­˜ç‚¹ getSavepointManager().releaseSavepoint(savepoint); //æ¸…ç©ºä¿å­˜ç‚¹ setSavepoint(null);&#125; 1234567891011121314@Overrideprotected void doRollback(DefaultTransactionStatus status) &#123; DataSourceTransactionObject txObject = (DataSourceTransactionObject) status.getTransaction(); Connection con = txObject.getConnectionHolder().getConnection(); if (status.isDebug()) &#123; logger.debug(&quot;Rolling back JDBC transaction on Connection [&quot; + con + &quot;]&quot;); &#125; try &#123; con.rollback(); &#125; catch (SQLException ex) &#123; throw translateException(&quot;JDBC rollback&quot;, ex); &#125;&#125; 5.è¿˜åŸç°åœºé€»è¾‘123456protected void cleanupTransactionInfo(@Nullable TransactionInfo txInfo) &#123; if (txInfo != null) &#123; //å¾€ä¸‹çœ‹ txInfo.restoreThreadLocalStatus(); &#125;&#125; æˆ‘ä»¬å¾€ä¸‹çœ‹ 123456private void restoreThreadLocalStatus() &#123; // Use stack to restore old transaction TransactionInfo. // Will be null if none was set. //ç›¸å½“äºäº‹åŠ¡å‡ºæ ˆçš„é€»è¾‘ transactionInfoHolder.set(this.oldTransactionInfo);&#125; è¿™é‡Œå¾ˆç®€å•ï¼Œå°±æ˜¯è®©å½“å‰äº‹åŠ¡å‡ºæ ˆã€‚å°†æ ˆå†…çš„äº‹åŠ¡è®¾ç½®æˆä¸Šä¸€å±‚äº‹åŠ¡ã€‚ 6.æäº¤äº‹åŠ¡é€»è¾‘123456789protected void commitTransactionAfterReturning(@Nullable TransactionInfo txInfo) &#123; if (txInfo != null &amp;&amp; txInfo.getTransactionStatus() != null) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Completing transaction for [&quot; + txInfo.getJoinpointIdentification() + &quot;]&quot;); &#125; //è°ƒç”¨äº‹åŠ¡ç®¡ç†å™¨çš„æäº¤äº‹åŠ¡æ–¹æ³• txInfo.getTransactionManager().commit(txInfo.getTransactionStatus()/*äº‹åŠ¡çŠ¶æ€*/); &#125;&#125; è°ƒç”¨äº†äº‹åŠ¡ç®¡ç†å™¨çš„æäº¤äº‹åŠ¡æ–¹æ³•ã€‚â€‹ 12345678910111213141516171819202122232425262728293031@Overridepublic final void commit(TransactionStatus status) throws TransactionException &#123; if (status.isCompleted()) &#123; throw new IllegalTransactionStateException( &quot;Transaction is already completed - do not call commit or rollback more than once per transaction&quot;); &#125; DefaultTransactionStatus defStatus = (DefaultTransactionStatus) status; //è¯´æ˜æ˜¯ä¸šåŠ¡å¼ºåˆ¶å›æ»š if (defStatus.isLocalRollbackOnly()) &#123; if (defStatus.isDebug()) &#123; logger.debug(&quot;Transactional code has requested rollback&quot;); &#125; //å¤„ç†å›æ»š processRollback(defStatus, false); return; &#125; //shouldCommitOnGlobalRollbackOnly() é»˜è®¤æ˜¯true //defStatus.isGlobalRollbackOnly() å…¶å®å°±æ˜¯defStatus -&gt;txObject-&gt;connHolder-&gt;rollbackOnly å­—æ®µ //ä¸‹å±‚äº‹åŠ¡ä½¿ç”¨ä¸Šå±‚äº‹åŠ¡çš„æ—¶å€™ï¼Œæƒ³å›æ»šï¼Œå°±ä¼šè®¾ç½®è¿™ä¸ªæ ‡è®° if (!shouldCommitOnGlobalRollbackOnly() &amp;&amp; defStatus.isGlobalRollbackOnly()) &#123; if (defStatus.isDebug()) &#123; logger.debug(&quot;Global transaction is marked as rollback-only but transactional code requested commit&quot;); &#125; processRollback(defStatus, true); return; &#125; //å¤„ç†æäº¤ processCommit(defStatus);&#125; æ ¸å¿ƒçš„é€»è¾‘åœ¨**processCommit()**ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576private void processCommit(DefaultTransactionStatus status) throws TransactionException &#123; try &#123; boolean beforeCompletionInvoked = false; try &#123; boolean unexpectedRollback = false; prepareForCommit(status); triggerBeforeCommit(status); triggerBeforeCompletion(status); beforeCompletionInvoked = true; if (status.hasSavepoint()) &#123; if (status.isDebug()) &#123; logger.debug(&quot;Releasing transaction savepoint&quot;); &#125; unexpectedRollback = status.isGlobalRollbackOnly(); //æœ‰ä¿å­˜ç‚¹å°±æ¸…ç† status.releaseHeldSavepoint(); &#125; else if (status.isNewTransaction()) &#123; if (status.isDebug()) &#123; logger.debug(&quot;Initiating transaction commit&quot;); &#125; unexpectedRollback = status.isGlobalRollbackOnly(); //åº•å±‚æäº¤äº‹åŠ¡ doCommit(status); &#125; else if (isFailEarlyOnGlobalRollbackOnly()) &#123; unexpectedRollback = status.isGlobalRollbackOnly(); &#125; // Throw UnexpectedRollbackException if we have a global rollback-only // marker but still didn&#x27;t get a corresponding exception from commit. if (unexpectedRollback) &#123; throw new UnexpectedRollbackException( &quot;Transaction silently rolled back because it has been marked as rollback-only&quot;); &#125; &#125; catch (UnexpectedRollbackException ex) &#123; // can only be caused by doCommit triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK); throw ex; &#125; catch (TransactionException ex) &#123; // can only be caused by doCommit if (isRollbackOnCommitFailure()) &#123; doRollbackOnCommitException(status, ex); &#125; else &#123; triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN); &#125; throw ex; &#125; catch (RuntimeException | Error ex) &#123; if (!beforeCompletionInvoked) &#123; triggerBeforeCompletion(status); &#125; doRollbackOnCommitException(status, ex); throw ex; &#125; // Trigger afterCommit callbacks, with an exception thrown there // propagated to callers but the transaction still considered as committed. try &#123; triggerAfterCommit(status); &#125; finally &#123; triggerAfterCompletion(status, TransactionSynchronization.STATUS_COMMITTED); &#125; &#125; finally &#123; //æ¸…ç†èµ„æºï¼Œæ¯”å¦‚ä¿å­˜ç‚¹ cleanupAfterCompletion(status); &#125;&#125; é€»è¾‘å¾ˆç®€å•ï¼Œæ¸…ç†ä¿å­˜ç‚¹ï¼Œæäº¤äº‹åŠ¡ï¼Œæ‰§è¡Œæ‰©å±•ç‚¹é€»è¾‘ï¼Œæ¸…ç†èµ„æºã€‚â€‹ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹èµ„æºçš„æ¸…ç†**cleanupAfterCompletion(status)**ã€‚â€‹ 123456789101112131415161718192021private void cleanupAfterCompletion(DefaultTransactionStatus status) &#123; //è®¾ç½®å½“å‰æ–¹æ³•çš„äº‹åŠ¡çŠ¶æ€ä¸ºå®ŒæˆçŠ¶æ€ status.setCompleted(); //æ¸…ç†é€»è¾‘ çº¿ç¨‹ä¸Šä¸‹æ–‡å˜é‡ &amp; æ‰©å±•ç‚¹æ³¨å†Œçš„ä¸œè¥¿ if (status.isNewSynchronization()) &#123; TransactionSynchronizationManager.clear(); &#125; //å¦‚æœæ˜¯å¼€å¯çš„æ–°äº‹ç‰©ï¼Œè¿˜åŸç°åœºæ“ä½œ æœ€é‡è¦çš„å°±æ˜¯è§£ç»‘çº¿ç¨‹æŒæœ‰çš„è¿æ¥ if (status.isNewTransaction()) &#123; doCleanupAfterCompletion(status.getTransaction()); &#125; //è¯´æ˜å½“å‰äº‹åŠ¡æ‰§è¡Œçš„æ—¶å€™ï¼ŒæŒ‚èµ·äº†ä¸€ä¸ªä¸Šå±‚çš„äº‹åŠ¡ if (status.getSuspendedResources() != null) &#123; if (status.isDebug()) &#123; logger.debug(&quot;Resuming suspended transaction after completion of inner transaction&quot;); &#125; Object transaction = (status.hasTransaction() ? status.getTransaction() : null); //å”¤é†’ä¸Šå±‚çš„äº‹åŠ¡ resume(transaction, (SuspendedResourcesHolder) status.getSuspendedResources()); &#125;&#125; \u0000çœ‹å‡ ä¸ªæ ¸å¿ƒæ–¹æ³•**doCleanupAfterCompletion()** &amp; **resume()**ã€‚â€‹ 12345678910111213141516171819202122232425262728293031@Overrideprotected void doCleanupAfterCompletion(Object transaction) &#123; DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction; // Remove the connection holder from the thread, if exposed. if (txObject.isNewConnectionHolder()) &#123; TransactionSynchronizationManager.unbindResource(obtainDataSource()); &#125; // Reset connection. Connection con = txObject.getConnectionHolder().getConnection(); try &#123; if (txObject.isMustRestoreAutoCommit()) &#123; con.setAutoCommit(true); &#125; DataSourceUtils.resetConnectionAfterTransaction( con, txObject.getPreviousIsolationLevel(), txObject.isReadOnly()); &#125; catch (Throwable ex) &#123; logger.debug(&quot;Could not reset JDBC Connection after transaction&quot;, ex); &#125; if (txObject.isNewConnectionHolder()) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Releasing JDBC Connection [&quot; + con + &quot;] after transaction&quot;); &#125; DataSourceUtils.releaseConnection(con, this.dataSource); &#125; txObject.getConnectionHolder().clear();&#125; 1234567891011121314151617181920protected final void resume(@Nullable Object transaction, @Nullable SuspendedResourcesHolder resourcesHolder) throws TransactionException &#123; if (resourcesHolder != null) &#123; Object suspendedResources = resourcesHolder.suspendedResources; if (suspendedResources != null) &#123; //é‡æ–°ç»‘å®šä¸Šä¸€ä¸ªäº‹åŠ¡çš„èµ„æº doResume(transaction, suspendedResources); &#125; List&lt;TransactionSynchronization&gt; suspendedSynchronizations = resourcesHolder.suspendedSynchronizations; if (suspendedSynchronizations != null) &#123; //å°†çº¿ç¨‹ä¸Šä¸‹æ–‡å˜é‡æ¢å¤ä¸ºä¸Šä¸€ä¸ªäº‹åŠ¡çš„ç°åœº TransactionSynchronizationManager.setActualTransactionActive(resourcesHolder.wasActive); TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(resourcesHolder.isolationLevel); TransactionSynchronizationManager.setCurrentTransactionReadOnly(resourcesHolder.readOnly); TransactionSynchronizationManager.setCurrentTransactionName(resourcesHolder.name); doResumeSynchronization(suspendedSynchronizations); &#125; &#125;&#125; **doResume()**â€‹ 1234@Overrideprotected void doResume(@Nullable Object transaction, Object suspendedResources) &#123; TransactionSynchronizationManager.bindResource(obtainDataSource(), suspendedResources);&#125; è¡¥å……ä¸€ä¸ªé€»è¾‘**doSuspend()**ã€‚æŒ‚èµ·é€»è¾‘â€‹ 12345678910@Overrideprotected Object doSuspend(Object transaction) &#123; DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction; //å°†äº‹åŠ¡å¯¹è±¡çš„ è¿æ¥æŒæœ‰è€…è®¾ç½®ä¸ºnullï¼Œä¸æƒ³å’Œä¸Šå±‚äº‹åŠ¡å…±äº«è¿æ¥èµ„æº... //å½“å‰æ–¹æ³•æœ‰å¯èƒ½æ˜¯ä¸å¼€å¯äº‹åŠ¡ || è¦å¼€å¯ä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ txObject.setConnectionHolder(null); //è§£ç»‘çº¿ç¨‹ä¸Šçš„äº‹åŠ¡ï¼Œå°†è¿æ¥æŒæœ‰è€…ä»tlç§»é™¤æ‰ï¼Œè¿™æ ·ä¸šåŠ¡å°±ä¸ä¼šå†æ‹¿ä¸Šå±‚äº‹åŠ¡çš„è¿æ¥èµ„æºäº† return TransactionSynchronizationManager.unbindResource(obtainDataSource());&#125; 7.æ€è€ƒä¸æ²‰æ·€äº‹åŠ¡çš„æºç æœ‰ä¸€äº›çç¢ï¼Œè‡³æ­¤æ•´ä¸ªäº‹åŠ¡çš„æºç å…¶å®å·²ç»åˆ†æå®Œäº†ï¼Œä¸ºäº†å½¢æˆä¸€ä¸ªæ¸…æ™°ï¼Œå®Œæ•´çš„é“¾è·¯ï¼Œæˆ‘ç”»äº†ä¸€å¼ äº‹åŠ¡æºç çš„æµç¨‹å›¾ã€‚â€‹ æˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹äº‹åŠ¡çš„æµç¨‹ã€‚@EnableTransactionManagement åˆ©ç”¨TransactionManagementConfigurationSelectorç»™å®¹å™¨ä¸­ä¼šå¯¼å…¥ç»„ä»¶ ç»™å®¹å™¨ä¸­å¯¼å…¥äº†ä¸¤ä¸ªç±»ï¼š 1.AutoProxyRegistrar å¾€å®¹å™¨ä¸­å¯¼å…¥äº†ä¸€ä¸ªç»„ä»¶ï¼šInfrastructureAdvisorAutoProxyCreator è¿™ä¸ªç±»æ˜¯ä»€ä¹ˆï¼Ÿåˆ©ç”¨åç½®å¤„ç†å™¨ï¼ŒåŒ…è£…å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ˆå¢å¼ºå™¨ï¼‰ï¼Œä»£ç†å¯¹è±¡æ‰§è¡Œæ–¹æ³•çš„æ—¶å€™åˆ©ç”¨æ‹¦æˆªå™¨è¿›è¡Œè°ƒç”¨ 2.ProxyTransactionManagementConfiguration ç»™å®¹å™¨ä¸­æ³¨å†Œäº†ä¸‰ä¸ªbeanï¼š 1.äº‹åŠ¡å¢å¼ºå™¨ ï¼šadvisoråˆ‡é¢ 2.äº‹åŠ¡æ³¨è§£è§£æå™¨ï¼šè§£æäº‹åŠ¡æ³¨è§£ï¼Œè·å–æ³¨è§£ä¿¡æ¯ 3.äº‹åŠ¡å¢å¼ºå™¨çš„æ‹¦æˆªå™¨ï¼šæ‹¦æˆªäº‹åŠ¡ç›¸å…³çš„advisoråˆ‡é¢ ctrl + H æŸ¥çœ‹ç±»çš„ç»§æ‰¿å…³ç³»ï¼šè¿™ä¸ªç±»æ˜¯MethodInterceptorçš„å­ç±» åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼š æ‰§è¡Œæ‹¦æˆªå™¨é“¾æ¡ äº‹åŠ¡æ‹¦æˆªå™¨ï¼š 1.å…ˆè·å–äº‹åŠ¡ç›¸å…³çš„å±æ€§ 2.åœ¨è·å–äº‹åŠ¡ç®¡ç†å™¨ï¼Œå¦‚æœäº‹å…ˆæ²¡æœ‰æ·»åŠ å’Œæ‰§è¡Œä»»ä½•äº‹åŠ¡ç®¡ç†å™¨ï¼Œæœ€ç»ˆä¼šä»å®¹å™¨ä¸­æ‹¿å‡ºæ¥ä¸€ä¸ªé»˜è®¤çš„ 3.æ‰§è¡Œç›®æ ‡æ–¹æ³• 1.å¦‚æœæ˜¯å¼‚å¸¸ï¼Œè·å–åˆ°äº‹åŠ¡ç®¡ç†å™¨ï¼Œåˆ©ç”¨äº‹åŠ¡ç®¡ç†å™¨è¿›è¡Œå›æ»š 2.å¦‚æœæ˜¯æ­£å¸¸æ‰§è¡Œï¼Œåˆ©ç”¨äº‹åŠ¡ç®¡ç†å™¨ï¼Œæäº¤äº‹åŠ¡ã€‚ äº‹åŠ¡æ³¨è§£è§£æå™¨å’Œäº‹åŠ¡å¢å¼ºå™¨çš„æ‹¦æˆªå™¨éƒ½åŒ…å«åœ¨äº‹åŠ¡å¢å¼ºå™¨ä¸­ï¼Œä¸ºäº‹åŠ¡å¢å¼ºå™¨èµ‹èƒ½ã€‚\u0000 è‡³æ­¤ï¼Œäº‹åŠ¡æºç åˆ†æå®Œæˆï¼Œåç»­çš„ç¯‡ç« ï¼Œæˆ‘ä»¬ä¼šå»åˆ†æwebè¯·æ±‚çš„ç›¸å…³æµç¨‹ï¼Œæˆ‘æ˜¯äºŒåï¼Œç†Ÿè¯»Javaç”Ÿæ€åœˆæºç ï¼Œç²¾é€šJavaé«˜å¹¶å‘ç¼–ç¨‹ï¼Œæ¬¢è¿ç‚¹èµå…³æ³¨ã€‚","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[åå››]äº‹åŠ¡æ ‡ç­¾è§£æ&åˆ›å»ºä»£ç†å¯¹è±¡","slug":"Spring/Spring[åå››]äº‹åŠ¡æ ‡ç­¾è§£æ&åˆ›å»ºä»£ç†å¯¹è±¡","date":"2022-01-11T06:11:03.124Z","updated":"2022-01-11T06:17:49.759Z","comments":true,"path":"2022/01/11/Spring/Spring[åå››]äº‹åŠ¡æ ‡ç­¾è§£æ&åˆ›å»ºä»£ç†å¯¹è±¡/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E5%8D%81%E5%9B%9B]%E4%BA%8B%E5%8A%A1%E6%A0%87%E7%AD%BE%E8%A7%A3%E6%9E%90&%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1/","excerpt":"","text":"æœ¬ç¯‡æˆ‘ä»¬å¼€å§‹åˆ†æSpringçš„äº‹åŠ¡ï¼Œåœ¨çœ‹æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥åšä¸€äº›é“ºå«ã€‚ 1.JDBC&amp;Springäº‹åŠ¡12345678910111213141516171819202122232425@Testpublic void test() &#123; Connection co = null; try &#123; co = JDBCUtils.getConnection(); co.setAutoCommit(false); String sql1 = &quot;update user_table set balance=balance-? where user=?&quot;; String sql2 = &quot;update user_table set balance=balance+? where user=?&quot;; update(co,sql1,100,&quot;AA&quot;); //System.out.println(10/0); update(co,sql2,100,&quot;BB&quot;); co.commit(); System.out.println(&quot;è½¬è´¦æˆåŠŸï¼&quot;); &#125; catch (SQLException e) &#123; try &#123; co.rollback(); System.out.println(&quot;è½¬è´¦å¤±è´¥ï¼&quot;); &#125; catch (SQLException e1) &#123; e1.printStackTrace(); &#125; &#125; finally &#123; JDBCUtils.closeResource(co,null,null); &#125;&#125; 123456789101112131415public static int update(Connection co, String sql, Object... args) &#123; PreparedStatement ps = null; try &#123; ps = co.prepareStatement(sql); for (int i = 0; i &lt; args.length; i++) &#123; ps.setObject(i + 1, args[i]); &#125; return ps.executeUpdate(); &#125; catch (SQLException e) &#123; e.printStackTrace(); &#125; finally &#123; JDBCUtils.closeResource(null, ps, null); &#125; return 0;&#125; æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹Springäº‹åŠ¡ã€‚ 2.äº‹åŠ¡ä¼ æ’­è¡Œä¸ºâ€‹ æ‰€è°“ spring äº‹åŠ¡çš„ä¼ æ’­å±æ€§ï¼Œå°±æ˜¯å®šä¹‰åœ¨å­˜åœ¨å¤šä¸ªäº‹åŠ¡åŒæ—¶å­˜åœ¨çš„æ—¶å€™ï¼Œspring åº”è¯¥å¦‚ä½•å¤„ç†è¿™äº›äº‹åŠ¡çš„è¡Œä¸ºã€‚è¿™äº›å±æ€§åœ¨ TransactionDefinition ä¸­å®šä¹‰ã€‚â€‹ å¸¸é‡åç§° å¸¸é‡è§£é‡Š PROPAGATION_REQUIRED æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ã€‚è¿™æ˜¯æœ€å¸¸è§çš„é€‰æ‹©ï¼Œä¹Ÿæ˜¯ Springé»˜è®¤çš„äº‹åŠ¡çš„ä¼ æ’­ã€‚ PROPAGATION_REQUIRES_NEW æ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚æ–°å»ºçš„äº‹åŠ¡å°†å’Œè¢«æŒ‚èµ·çš„äº‹åŠ¡æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ï¼Œå¤–å±‚äº‹åŠ¡å¤±è´¥å›æ»šä¹‹åï¼Œä¸èƒ½å›æ»šå†…å±‚äº‹åŠ¡æ‰§è¡Œçš„ç»“æœï¼Œå†…å±‚äº‹åŠ¡å¤±è´¥æŠ›å‡ºå¼‚å¸¸ï¼Œå¤–å±‚äº‹åŠ¡æ•è·ï¼Œä¹Ÿå¯ä»¥ä¸å¤„ç†å›æ»šæ“ä½œ PROPAGATION_SUPPORTS æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚ PROPAGATION_MANDATORY æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ã€‚ PROPAGATION_NOT_SUPPORTED ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œæ“ä½œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œå°±æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚ PROPAGATION_NEVER ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ PROPAGATION_NESTED å¦‚æœä¸€ä¸ªæ´»åŠ¨çš„äº‹åŠ¡å­˜åœ¨ï¼Œåˆ™è¿è¡Œåœ¨ä¸€ä¸ªåµŒå¥—çš„äº‹åŠ¡ä¸­ã€‚å¦‚æœæ²¡æœ‰æ´»åŠ¨äº‹åŠ¡ï¼Œåˆ™æŒ‰REQUIRED å±æ€§æ‰§è¡Œã€‚å®ƒä½¿ç”¨äº†ä¸€ä¸ªå•ç‹¬çš„äº‹åŠ¡ï¼Œè¿™ä¸ªäº‹åŠ¡æ‹¥æœ‰å¤šä¸ªå¯ä»¥å›æ»šçš„ä¿å­˜ç‚¹ã€‚å†…éƒ¨äº‹åŠ¡çš„å›æ»šä¸ä¼šå¯¹å¤–éƒ¨äº‹åŠ¡é€ æˆå½±å“ã€‚å®ƒåªå¯¹DataSourceTransactionManager äº‹åŠ¡ç®¡ç†å™¨èµ·æ•ˆã€‚ 1234567891011121314151617181920PROPAGATION_REQUIREDclass ServiceA &#123; @Autowired ServiceB serviceBï¼› @Transactional void a() &#123; .... serviceB.b(); .... &#125;&#125;class ServiceB &#123; @Transactional void b() &#123; ...... &#125;&#125; çº¿ç¨‹æ‰§è¡Œåˆ°serviceA.a() æ–¹æ³•æ—¶ï¼Œå…¶å®æ˜¯æ‰§è¡Œçš„ ä»£ç†serviceAå¯¹è±¡çš„aæ–¹æ³•ã€‚ æ‰§è¡Œä»£ç†serviceAå¯¹è±¡çš„aæ–¹æ³• æ‰§è¡Œaæ–¹æ³•çš„å¢å¼ºé€»è¾‘-&gt; äº‹åŠ¡å¢å¼ºå™¨ (ç¯ç»•å¢å¼º) äº‹åŠ¡å¢å¼ºå™¨ä¼šåšä»€ä¹ˆäº‹? æå–äº‹åŠ¡æ ‡ç­¾å±æ€§ æ£€æŸ¥å½“å‰çº¿ç¨‹æœ‰æ²¡æœ‰ç»‘å®š conn æ•°æ®åº“è¿æ¥ èµ„æºï¼Ÿ å‘ç°å½“å‰çº¿ç¨‹æœªç»‘å®šï¼ˆTransactionSyncâ€¦Manager#resources æ˜¯ ThreadLocal&lt;Map&lt;obj,obj&gt;&gt;ï¼Œæ£€æŸ¥key:datasource æœ‰æ²¡æœ‰æ•°æ®ï¼‰ å› ä¸ºæœªç»‘å®šconnèµ„æºï¼Œæ‰€ä»¥çº¿ç¨‹ä¸‹ä¸€æ­¥å°±æ˜¯ åˆ° datasource.getConnection() è·å–ä¸€ä¸ªconnèµ„æº å› ä¸ºæ–°è·å–çš„connèµ„æºçš„autocommitæ˜¯trueï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ ä¿®æ”¹ autocommit ä¸ºfalseï¼Œè¡¨ç¤ºæ‰‹åŠ¨æäº¤äº‹åŠ¡ï¼Œè¿™ä¸€æ­¥ä¹Ÿè¡¨ç¤º å¼€å¯äº‹åŠ¡ï¼ˆä¿®æ”¹connå…¶å®ƒ å±æ€§..ï¼‰ ç»‘å®šconnèµ„æºåˆ° TransactionSyncâ€¦Manager#resourcesï¼Œkeyï¼šdatasource æ‰§è¡Œäº‹åŠ¡å¢å¼ºå™¨åé¢çš„å¢å¼ºå™¨.. æœ€åä¸€ä¸ªadviceè°ƒç”¨ targetçš„ç›®æ ‡æ–¹æ³• a() æ–¹æ³• å‡è®¾target aæ–¹æ³• éœ€è¦è®¿é—®æ•°æ®åº“ æ‰§è¡ŒSQL çš„è¯ï¼Œç¨‹åºéœ€è¦è·å–ä¸€ä¸ª conn èµ„æºï¼Œåˆ°å“ªæ‹¿ï¼Ÿ DataSourceUtils.getConnection(datasource) è¿™ä¸€æ­¥æœ€ç»ˆä¼šæ‹¿åˆ° äº‹åŠ¡å¢å¼ºå™¨ å‰ç½®å¢å¼ºé€»è¾‘ å­˜æ”¾åœ¨ TransactionSync..Manager#resources å†…çš„conn èµ„æº æ‰§è¡Œæ–¹æ³•aé€»è¾‘â€¦å¯èƒ½ä¼šæ‰§è¡Œä¸€äº› SQL è¯­å¥â€¦ çº¿ç¨‹æ‰§è¡Œåˆ°è¿™æ ·ä¸€è¡Œä»£ç ï¼šserviceB.b() serviceB å®ƒæ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå› ä¸ºå®ƒä¹Ÿä½¿ç”¨äº† @Transactional æ³¨è§£äº†ï¼ŒSpring ä¼šä¸ºå®ƒåˆ›å»ºä»£ç†çš„ã€‚ æ‰§è¡Œä»£ç†serviceBå¯¹è±¡çš„bæ–¹æ³• æ‰§è¡Œbæ–¹æ³•çš„å¢å¼ºé€»è¾‘-&gt; äº‹åŠ¡å¢å¼ºå™¨ï¼ˆç¯ç»•å¢å¼ºï¼‰ äº‹åŠ¡å¢å¼ºå™¨ä¼šåšä»€ä¹ˆäº‹? æå–äº‹åŠ¡æ ‡ç­¾å±æ€§ æ£€æŸ¥å½“å‰çº¿ç¨‹æœ‰æ²¡æœ‰ç»‘å®š conn æ•°æ®åº“è¿æ¥ èµ„æºï¼Ÿå‘ç°å½“å‰çº¿ç¨‹å·²ç»ç»‘å®šäº† conn æ•°æ®åº“è¿æ¥èµ„æºäº† æ£€æŸ¥äº‹åŠ¡æ³¨è§£å±æ€§ï¼Œå‘ç°è‡ªå·±æ‰“çš„propagation == REQUIREDï¼Œæ‰€ä»¥ç»§ç»­å…±äº« conn æ•°æ®åº“é“¾æ¥èµ„æº æ‰§è¡Œäº‹åŠ¡å¢å¼ºå™¨åé¢çš„å¢å¼ºå™¨.. æœ€åä¸€ä¸ªdeviceè°ƒç”¨ target (serviceB)çš„ç›®æ ‡æ–¹æ³• b() æ–¹æ³• å‡è®¾target bæ–¹æ³• éœ€è¦è®¿é—®æ•°æ®åº“ æ‰§è¡ŒSQL çš„è¯ï¼Œç¨‹åºéœ€è¦è·å–ä¸€ä¸ª conn èµ„æºï¼Œåˆ°å“ªæ‹¿ï¼Ÿ DataSourceUtils.getConnection(datasource) è¿™ä¸€æ­¥æœ€ç»ˆä¼šæ‹¿åˆ° ä»£ç†serviceAå¯¹è±¡å­˜æ”¾åœ¨ TransactionSync..Manager#resources å†…çš„conn èµ„æº æ‰§è¡Œæ–¹æ³•bé€»è¾‘â€¦å¯èƒ½ä¼šæ‰§è¡Œä¸€äº› SQL è¯­å¥â€¦ çº¿ç¨‹ç»§ç»­æ‰§è¡Œ äº‹åŠ¡å¢å¼ºå™¨ ç¯ç»•å¢å¼ºçš„åç½®é€»è¾‘ ï¼ˆä»£ç†serviceB.b() æ–¹æ³•çš„ åç½®å¢å¼ºï¼‰ æ£€æŸ¥å‘ç°ï¼ŒserviceB.b() äº‹åŠ¡å¹¶ä¸æ˜¯ å½“å‰ bæ–¹æ³•å¼€å¯çš„ï¼Œæ‰€ä»¥ åŸºæœ¬ä¸åšä»€ä¹ˆäº‹æƒ….. çº¿ç¨‹ç»§ç»­å›åˆ° ç›®æ ‡ serviceA.a() æ–¹æ³•å†…ï¼Œç»§ç»­æ‰§è¡Œ æ‰§è¡Œæ–¹æ³•aé€»è¾‘â€¦å¯èƒ½ä¼šæ‰§è¡Œä¸€äº› SQL è¯­å¥â€¦ çº¿ç¨‹ç»§ç»­å›åˆ° ä»£ç† serviceA.a() æ–¹æ³•å†…ï¼Œç»§ç»­æ‰§è¡Œ æ‰§è¡Œaæ–¹æ³•çš„å¢å¼ºé€»è¾‘-&gt; äº‹åŠ¡å¢å¼ºå™¨ (ç¯ç»•å¢å¼º-åç½®å¢å¼ºé€»è¾‘) æäº¤äº‹åŠ¡/å›æ»šäº‹åŠ¡ æ¢å¤è¿æ¥çŠ¶æ€ ï¼ˆå°†connçš„autocommit è®¾ç½®å› trueâ€¦ç­‰ç­‰ï¼‰ æ¸…ç†å·¥ä½œï¼ˆå°†ç»‘å®šçš„connèµ„æºä»TransactionSyncâ€¦Manager#resourcesç§»é™¤ï¼‰ conn è¿æ¥å…³é—­ ï¼ˆå½’è¿˜è¿æ¥åˆ°datasourceï¼‰ 1234567891011121314151617181920PROPAGATION_SUPPORTSclass ServiceA &#123; @Autowired ServiceB serviceBï¼› @Transactional void a() &#123; .... serviceB.b(); .... &#125;&#125;class ServiceB &#123; @Transactional(propagation = SUPPORTS) void b() &#123; ...... &#125;&#125; é€»è¾‘å’Œä¸Šé¢å®Œå…¨ä¸€è‡´ã€‚ 12345678class ServiceA &#123; @Transactional(Propagation = SUPPORTS) void a() &#123; .... .... &#125;&#125; çº¿ç¨‹åœ¨æœªç»‘å®šäº‹åŠ¡çš„æƒ…å†µä¸‹ï¼Œå»è°ƒç”¨serviceA.a() æ–¹æ³•ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ çº¿ç¨‹æ‰§è¡Œåˆ°serviceA.a() æ–¹æ³•æ—¶ï¼Œå…¶å®æ˜¯æ‰§è¡Œçš„ ä»£ç†serviceAå¯¹è±¡çš„aæ–¹æ³•ã€‚ æ‰§è¡Œä»£ç†serviceAå¯¹è±¡çš„aæ–¹æ³• æ‰§è¡Œaæ–¹æ³•çš„å¢å¼ºé€»è¾‘-&gt; äº‹åŠ¡å¢å¼ºå™¨ (ç¯ç»•å¢å¼º) äº‹åŠ¡å¢å¼ºå™¨ä¼šåšä»€ä¹ˆäº‹? æå–äº‹åŠ¡æ ‡ç­¾å±æ€§ æ£€æŸ¥å½“å‰çº¿ç¨‹æœ‰æ²¡æœ‰ç»‘å®š conn æ•°æ®åº“è¿æ¥ èµ„æºï¼Ÿ å‘ç°å½“å‰çº¿ç¨‹æœªç»‘å®šï¼ˆTransactionSyncâ€¦Manager#resources æ˜¯ ThreadLocal&lt;Map&lt;obj,obj&gt;&gt;ï¼Œæ£€æŸ¥key:datasource æœ‰æ²¡æœ‰æ•°æ®ï¼‰ å•¥ä¹Ÿä¸ç”¨åš.. æ‰§è¡Œäº‹åŠ¡å¢å¼ºå™¨åé¢çš„å¢å¼ºå™¨.. æœ€åä¸€ä¸ªadviceè°ƒç”¨ targetçš„ç›®æ ‡æ–¹æ³• a() æ–¹æ³• å‡è®¾target aæ–¹æ³• éœ€è¦è®¿é—®æ•°æ®åº“ æ‰§è¡ŒSQL çš„è¯ï¼Œç¨‹åºéœ€è¦è·å–ä¸€ä¸ª conn èµ„æºï¼Œåˆ°å“ªæ‹¿ï¼Ÿ DataSourceUtils.getConnection(datasource) ï¼Œå› ä¸ºäº‹åŠ¡å¢å¼ºå™¨å‰ç½®å¢å¼ºé€»è¾‘ å¹¶æ²¡æœ‰ å‘TransactionSync..Manager#resources å†…ç»‘å®šconnèµ„æº å› ä¸º ä¸Šä¸€æ­¥æœªæ‹¿åˆ° connèµ„æºï¼Œæ‰€ä»¥ DataSourceUtils é€šè¿‡ datasource.getConnection() è·å–äº†ä¸€ä¸ªå…¨æ–°çš„ conn èµ„æºï¼ˆæ³¨æ„ï¼šconn.autocommit == true,æ‰§è¡Œçš„æ¯ä¸€æ¡sql éƒ½æ˜¯ä¸€ä¸ª ç‹¬ç«‹äº‹åŠ¡ï¼ï¼ï¼‰ æ‰§è¡Œæ–¹æ³•aé€»è¾‘â€¦å¯èƒ½ä¼šæ‰§è¡Œä¸€äº› SQL è¯­å¥â€¦ çº¿ç¨‹ç»§ç»­æ‰§è¡Œåˆ°ä»£ç†serviceAå¯¹è±¡çš„aæ–¹æ³• ï¼ˆäº‹åŠ¡å¢å¼ºå™¨-åç½®å¢å¼ºé€»è¾‘ï¼‰ æ£€æŸ¥å‘ç° TrasactionSync..Manager#resources å¹¶æœªç»‘å®šä»»ä½• conn èµ„æºï¼Œæ‰€ä»¥ è¿™ä¸€æ­¥å•¥ä¹Ÿä¸åšäº†â€¦ 1234567891011121314151617181920PROPAGATION_MANDATORY å¾ˆå°‘ä½¿ç”¨..class ServiceA &#123; @Autowired ServiceB serviceBï¼› @Transactional void a() &#123; .... serviceB.b(); .... &#125;&#125;class ServiceB &#123; @Transactional(propagation = MANDATORY) void b() &#123; ...... &#125;&#125; å¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œæƒ…å†µå’Œ PROPAGATION_REQUIRED æ¡ˆä¾‹åˆ†æ å®Œå…¨ä¸€è‡´ã€‚ 12345678class ServiceA &#123; @Transactional(Propagation = MANDATORY) void a() &#123; .... .... &#125;&#125; çº¿ç¨‹åœ¨æœªç»‘å®šäº‹åŠ¡çš„æƒ…å†µä¸‹ï¼Œå»è°ƒç”¨serviceA.a() æ–¹æ³•ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ çº¿ç¨‹æ‰§è¡Œåˆ°serviceA.a() æ–¹æ³•æ—¶ï¼Œå…¶å®æ˜¯æ‰§è¡Œçš„ ä»£ç†serviceAå¯¹è±¡çš„aæ–¹æ³•ã€‚ æ‰§è¡Œä»£ç†serviceAå¯¹è±¡çš„aæ–¹æ³• æ‰§è¡Œaæ–¹æ³•çš„å¢å¼ºé€»è¾‘-&gt; äº‹åŠ¡å¢å¼ºå™¨ (ç¯ç»•å¢å¼º) äº‹åŠ¡å¢å¼ºå™¨ä¼šåšä»€ä¹ˆäº‹? æå–äº‹åŠ¡æ ‡ç­¾å±æ€§ æ£€æŸ¥å½“å‰çº¿ç¨‹æœ‰æ²¡æœ‰ç»‘å®š conn æ•°æ®åº“è¿æ¥ èµ„æºï¼Ÿ å‘ç°å½“å‰çº¿ç¨‹æœªç»‘å®šï¼ˆTransactionSyncâ€¦Manager#resources æ˜¯ ThreadLocal&lt;Map&lt;obj,obj&gt;&gt;ï¼Œæ£€æŸ¥key:datasource æœ‰æ²¡æœ‰æ•°æ®ï¼‰ ç›´æ¥æŠ›å‡ºå¼‚å¸¸â€¦ â€¦ 123456789101112131415161718192021PROPAGATION_REQUIRES_NEWclass ServiceA &#123; @Autowired ServiceB serviceBï¼› @Transactional void a() &#123; .... serviceB.b(); .... &#125;&#125;class ServiceB &#123; @Transactional(propagation = REQUIRES_NEW) void b() &#123; ...... &#125;&#125; çº¿ç¨‹æ‰§è¡Œåˆ°serviceA.a() æ–¹æ³•æ—¶ï¼Œå…¶å®æ˜¯æ‰§è¡Œçš„ ä»£ç†serviceAå¯¹è±¡çš„aæ–¹æ³•ã€‚ æ‰§è¡Œä»£ç†serviceAå¯¹è±¡çš„aæ–¹æ³• æ‰§è¡Œaæ–¹æ³•çš„å¢å¼ºé€»è¾‘-&gt; äº‹åŠ¡å¢å¼ºå™¨ (ç¯ç»•å¢å¼º) äº‹åŠ¡å¢å¼ºå™¨ä¼šåšä»€ä¹ˆäº‹? æå–äº‹åŠ¡æ ‡ç­¾å±æ€§ æ£€æŸ¥å½“å‰çº¿ç¨‹æœ‰æ²¡æœ‰ç»‘å®š conn æ•°æ®åº“è¿æ¥ èµ„æºï¼Ÿ å‘ç°å½“å‰çº¿ç¨‹æœªç»‘å®šï¼ˆTransactionSyncâ€¦Manager#resources æ˜¯ ThreadLocal&lt;Map&lt;obj,obj&gt;&gt;ï¼Œæ£€æŸ¥key:datasource æœ‰æ²¡æœ‰æ•°æ®ï¼‰ å› ä¸ºæœªç»‘å®šconnèµ„æºï¼Œæ‰€ä»¥çº¿ç¨‹ä¸‹ä¸€æ­¥å°±æ˜¯ åˆ° datasource.getConnection() è·å–ä¸€ä¸ªconnèµ„æº å› ä¸ºæ–°è·å–çš„connèµ„æºçš„autocommitæ˜¯trueï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ ä¿®æ”¹ autocommit ä¸ºfalseï¼Œè¡¨ç¤ºæ‰‹åŠ¨æäº¤äº‹åŠ¡ï¼Œè¿™ä¸€æ­¥ä¹Ÿè¡¨ç¤º å¼€å¯äº‹åŠ¡ï¼ˆä¿®æ”¹connå…¶å®ƒ å±æ€§..ï¼‰ ç»‘å®šconnèµ„æºåˆ° TransactionSyncâ€¦Manager#resourcesï¼Œkeyï¼šdatasource æ‰§è¡Œäº‹åŠ¡å¢å¼ºå™¨åé¢çš„å¢å¼ºå™¨.. æœ€åä¸€ä¸ªadviceè°ƒç”¨ targetçš„ç›®æ ‡æ–¹æ³• a() æ–¹æ³• å‡è®¾target aæ–¹æ³• éœ€è¦è®¿é—®æ•°æ®åº“ æ‰§è¡ŒSQL çš„è¯ï¼Œç¨‹åºéœ€è¦è·å–ä¸€ä¸ª conn èµ„æºï¼Œåˆ°å“ªæ‹¿ï¼Ÿ DataSourceUtils.getConnection(datasource) è¿™ä¸€æ­¥æœ€ç»ˆä¼šæ‹¿åˆ° äº‹åŠ¡å¢å¼ºå™¨ å‰ç½®å¢å¼ºé€»è¾‘ å­˜æ”¾åœ¨ TransactionSync..Manager#resources å†…çš„conn èµ„æº æ‰§è¡Œæ–¹æ³•aé€»è¾‘â€¦å¯èƒ½ä¼šæ‰§è¡Œä¸€äº› SQL è¯­å¥â€¦ çº¿ç¨‹æ‰§è¡Œåˆ°è¿™æ ·ä¸€è¡Œä»£ç ï¼šserviceB.b() serviceB å®ƒæ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå› ä¸ºå®ƒä¹Ÿä½¿ç”¨äº† @Transactional æ³¨è§£äº†ï¼ŒSpring ä¼šä¸ºå®ƒåˆ›å»ºä»£ç†çš„ã€‚ æ‰§è¡Œä»£ç†serviceBå¯¹è±¡çš„bæ–¹æ³• æ‰§è¡Œbæ–¹æ³•çš„å¢å¼ºé€»è¾‘-&gt; äº‹åŠ¡å¢å¼ºå™¨ï¼ˆç¯ç»•å¢å¼ºï¼‰ äº‹åŠ¡å¢å¼ºå™¨ä¼šåšä»€ä¹ˆäº‹? æå–äº‹åŠ¡æ ‡ç­¾å±æ€§ æ£€æŸ¥å‘ç°å½“å‰çº¿ç¨‹å·²ç»ç»‘å®šäº†connèµ„æºï¼ˆå¹¶ä¸”æ‰‹åŠ¨å¼€å¯äº†äº‹åŠ¡..ï¼‰ï¼Œåˆå‘ç° å½“å‰æ–¹æ³•çš„ ä¼ æ’­è¡Œä¸ºï¼šREQUIRES_NEW ï¼Œéœ€è¦å¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡.. å°†å·²ç»ç»‘å®šçš„connèµ„æº ä¿å­˜åˆ° suspand å˜é‡å†… å› ä¸º REQUIRES_NEW ä¸ä¼šå’Œä¸Šå±‚å…±äº«åŒä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ åˆåˆ° datasource.getConnection() è·å–äº†ä¸€ä¸ªå…¨æ–°çš„ conn æ•°æ®åº“è¿æ¥èµ„æº å› ä¸ºæ–°è·å–çš„connèµ„æºçš„autocommitæ˜¯trueï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ ä¿®æ”¹ autocommit ä¸ºfalseï¼Œè¡¨ç¤ºæ‰‹åŠ¨æäº¤äº‹åŠ¡ï¼Œè¿™ä¸€æ­¥ä¹Ÿè¡¨ç¤º å¼€å¯äº‹åŠ¡ï¼ˆä¿®æ”¹connå…¶å®ƒ å±æ€§..ï¼‰ ç»‘å®šconnèµ„æºåˆ° TransactionSyncâ€¦Manager#resourcesï¼Œkeyï¼šdatasource æ‰§è¡Œäº‹åŠ¡å¢å¼ºå™¨åé¢çš„å¢å¼ºå™¨.. æœ€åä¸€ä¸ªadviceè°ƒç”¨ target ï¼ˆserviceBï¼‰çš„ç›®æ ‡æ–¹æ³• b() æ–¹æ³• å‡è®¾target bæ–¹æ³• éœ€è¦è®¿é—®æ•°æ®åº“ æ‰§è¡ŒSQL çš„è¯ï¼Œç¨‹åºéœ€è¦è·å–ä¸€ä¸ª conn èµ„æºï¼Œåˆ°å“ªæ‹¿ï¼Ÿ DataSourceUtils.getConnection(datasource) è¿™ä¸€æ­¥æœ€ç»ˆä¼šæ‹¿åˆ° äº‹åŠ¡å¢å¼ºå™¨ å‰ç½®å¢å¼ºé€»è¾‘ å­˜æ”¾åœ¨ TransactionSync..Manager#resources å†…çš„conn èµ„æº æ‰§è¡Œæ–¹æ³•aé€»è¾‘â€¦å¯èƒ½ä¼šæ‰§è¡Œä¸€äº› SQL è¯­å¥â€¦ çº¿ç¨‹ç»§ç»­æ‰§è¡Œ äº‹åŠ¡å¢å¼ºå™¨ ç¯ç»•å¢å¼ºçš„åç½®é€»è¾‘ ï¼ˆä»£ç†serviceB.b() æ–¹æ³•çš„ åç½®å¢å¼ºï¼‰ æ£€æŸ¥å‘ç°ï¼ŒserviceB.b() äº‹åŠ¡æ˜¯ bæ–¹æ³•å¼€å¯çš„ï¼Œæ‰€ä»¥ éœ€è¦åšä¸€äº›äº‹æƒ…äº† æ‰§è¡Œbæ–¹æ³•çš„å¢å¼ºé€»è¾‘-&gt; äº‹åŠ¡å¢å¼ºå™¨ (ç¯ç»•å¢å¼º-åç½®å¢å¼ºé€»è¾‘) æäº¤äº‹åŠ¡/å›æ»šäº‹åŠ¡ æ¢å¤è¿æ¥çŠ¶æ€ ï¼ˆå°†connçš„autocommit è®¾ç½®å› trueâ€¦ç­‰ç­‰ï¼‰ æ¸…ç†å·¥ä½œï¼ˆå°†ç»‘å®šçš„connèµ„æºä»TransactionSyncâ€¦Manager#resourcesç§»é™¤ï¼‰ conn è¿æ¥å…³é—­ ï¼ˆå½’è¿˜è¿æ¥åˆ°datasourceï¼‰ æ£€æŸ¥suspand å‘ç° è¯¥å˜é‡æœ‰å€¼ï¼Œéœ€è¦æ‰§è¡Œ æ¢å¤ç°åœºçš„å·¥ä½œ resume() æ¢å¤ç°åœº å°†suspand æŒ‚èµ·çš„ conn èµ„æºå†æ¬¡ ç»‘å®šåˆ° TransactionSyncâ€¦Manager#resources å†…ï¼Œæ–¹ä¾¿ serviceA ç»§ç»­ä½¿ç”¨å®ƒçš„connèµ„æº ï¼ˆå®ƒè‡ªå·±çš„äº‹åŠ¡ï¼‰ çº¿ç¨‹ç»§ç»­å›åˆ° serviceA.a() æ–¹æ³•å†… ç»§ç»­æ‰§è¡Œä¸€äº›sql â€¦æ³¨æ„ è¿™é‡Œå®ƒä½¿ç”¨çš„ conn æ˜¯ serviceA ç”³è¯·çš„ conn çº¿ç¨‹ç»§ç»­æ‰§è¡Œ äº‹åŠ¡å¢å¼ºå™¨ ç¯ç»•å¢å¼ºçš„åç½®é€»è¾‘ ï¼ˆä»£ç†serviceA.a() æ–¹æ³•çš„ åç½®å¢å¼ºï¼‰ æ£€æŸ¥å‘ç°ï¼ŒserviceA.a() äº‹åŠ¡æ˜¯ aæ–¹æ³•å¼€å¯çš„ï¼Œæ‰€ä»¥ éœ€è¦åšä¸€äº›äº‹æƒ…äº† æ‰§è¡Œaæ–¹æ³•çš„å¢å¼ºé€»è¾‘-&gt; äº‹åŠ¡å¢å¼ºå™¨ (ç¯ç»•å¢å¼º-åç½®å¢å¼ºé€»è¾‘) æäº¤äº‹åŠ¡/å›æ»šäº‹åŠ¡ æ¢å¤è¿æ¥çŠ¶æ€ ï¼ˆå°†connçš„autocommit è®¾ç½®å› trueâ€¦ç­‰ç­‰ï¼‰ æ¸…ç†å·¥ä½œï¼ˆå°†ç»‘å®šçš„connèµ„æºä»TransactionSyncâ€¦Manager#resourcesç§»é™¤ï¼‰ conn è¿æ¥å…³é—­ ï¼ˆå½’è¿˜è¿æ¥åˆ°datasourceï¼‰ 3.éš”ç¦»çº§åˆ«3.1 Mysql éš”ç¦»çº§åˆ« éš”ç¦»çº§åˆ«çš„å€¼ å¯¼è‡´çš„é—®é¢˜ Read-Uncommitted 0 å¯¼è‡´è„è¯» Read-Committed 1 é¿å…è„è¯»ï¼Œå…è®¸ä¸å¯é‡å¤è¯»å’Œå¹»è¯» Repeatable-Read 2 é¿å…è„è¯»ï¼Œä¸å¯é‡å¤è¯»ï¼Œå…è®¸å¹»è¯» Serializable 3 ä¸²è¡ŒåŒ–è¯»ï¼Œäº‹åŠ¡åªèƒ½ä¸€ä¸ªä¸€ä¸ªæ‰§è¡Œï¼Œé¿å…äº†è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€‚æ‰§è¡Œæ•ˆç‡æ…¢ï¼Œä½¿ç”¨æ—¶æ…é‡ è„è¯»ï¼šä¸€äº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œäº†å¢åˆ æ”¹ï¼Œä½†æœªæäº¤ï¼Œå¦ä¸€äº‹åŠ¡å¯ä»¥è¯»å–åˆ°æœªæäº¤çš„æ•°æ®ã€‚å¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡è¿™æ—¶å€™å›æ»šäº†ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªäº‹åŠ¡å°±è¯»åˆ°äº†è„æ•°æ®ã€‚ ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡ä¸­å‘ç”Ÿäº†ä¸¤æ¬¡è¯»æ“ä½œï¼Œç¬¬ä¸€æ¬¡è¯»æ“ä½œå’Œç¬¬äºŒæ¬¡æ“ä½œä¹‹é—´ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè¿™æ—¶å€™ä¸¤æ¬¡è¯»å–çš„æ•°æ®æ˜¯ä¸ä¸€è‡´çš„ã€‚ å¹»è¯»ï¼šç¬¬ä¸€ä¸ªäº‹åŠ¡å¯¹ä¸€å®šèŒƒå›´çš„æ•°æ®è¿›è¡Œæ‰¹é‡ä¿®æ”¹ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡åœ¨è¿™ä¸ªèŒƒå›´å¢åŠ ä¸€æ¡æ•°æ®ï¼Œè¿™æ—¶å€™ç¬¬ä¸€ä¸ªäº‹åŠ¡å°±ä¼šä¸¢å¤±å¯¹æ–°å¢æ•°æ®çš„ä¿®æ”¹ã€‚ éš”ç¦»çº§åˆ«è¶Šé«˜ï¼Œè¶Šèƒ½ä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ï¼Œä½†æ˜¯å¯¹å¹¶å‘æ€§èƒ½çš„å½±å“ä¹Ÿè¶Šå¤§ã€‚å¤§å¤šæ•°çš„æ•°æ®åº“é»˜è®¤éš”ç¦»çº§åˆ«ä¸º Read Commitedï¼Œæ¯”å¦‚ SqlServerã€Oracleå°‘æ•°æ•°æ®åº“é»˜è®¤éš”ç¦»çº§åˆ«ä¸ºï¼šRepeatable Read æ¯”å¦‚ï¼š MySQL InnoDBã€‚â€‹ 3.2 Spring å¸¸é‡ è§£é‡Š ISOLATION_DEFAULT è¿™æ˜¯ä¸ª PlatfromTransactionManager é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼Œä½¿ç”¨æ•°æ®åº“é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚å¦å¤–å››ä¸ªä¸ JDBC çš„éš”ç¦»çº§åˆ«ç›¸å¯¹åº”ã€‚ ISOLATION_READ_UNCOMMITTED è¿™æ˜¯äº‹åŠ¡æœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå®ƒå…è®¸å¦å¤–ä¸€ä¸ªäº‹åŠ¡å¯ä»¥çœ‹åˆ°è¿™ä¸ªäº‹åŠ¡æœªæäº¤çš„æ•°æ®ã€‚è¿™ç§éš”ç¦»çº§åˆ«ä¼šäº§ç”Ÿè„è¯»ï¼Œä¸å¯é‡å¤è¯»å’Œå¹»åƒè¯»ã€‚ ISOLATION_READ_COMMITTED ä¿è¯ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹çš„æ•°æ®æäº¤åæ‰èƒ½è¢«å¦å¤–ä¸€ä¸ªäº‹åŠ¡è¯»å–ã€‚å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¸èƒ½è¯»å–è¯¥äº‹åŠ¡æœªæäº¤çš„æ•°æ®ã€‚ ISOLATION_REPEATABLE_READ è¿™ç§äº‹åŠ¡éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ï¼Œä¸å¯é‡å¤è¯»ã€‚ä½†æ˜¯å¯èƒ½å‡ºç°å¹»åƒè¯»ã€‚ ISOLATION_SERIALIZABLE è¿™æ˜¯èŠ±è´¹æœ€é«˜ä»£ä»·ä½†æ˜¯æœ€å¯é çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚äº‹åŠ¡è¢«å¤„ç†ä¸ºé¡ºåºæ‰§è¡Œã€‚ 4.äº‹åŠ¡åµŒå¥—è¿™é‡Œå†…å®¹åœ¨å®é™…å¼€å‘ä¸­æ¯”è¾ƒé‡è¦ï¼Œå› æ­¤æˆ‘ä»¬å†æ¥åšä¸€ä¸‹ç®€å•çš„å›é¡¾ã€‚ å‡è®¾å¤–å±‚äº‹åŠ¡ Service A çš„ Method A() è°ƒç”¨ å†…å±‚ Service B çš„ Method B() PROPAGATION_REQUIRED(Spring é»˜è®¤) å¦‚æœ ServiceB.MethodB() çš„äº‹åŠ¡çº§åˆ«å®šä¹‰ä¸º PROPAGATION_REQUIREDï¼Œé‚£ä¹ˆæ‰§è¡ŒServiceA.MethodA() çš„æ—¶å€™ Spring å·²ç»èµ·äº†äº‹åŠ¡ï¼Œè¿™æ—¶è°ƒç”¨ ServiceB.MethodB()ï¼ŒServiceB.MethodB() çœ‹åˆ°è‡ªå·±å·²ç»è¿è¡Œåœ¨ ServiceA.MethodA() çš„äº‹åŠ¡å†…éƒ¨ï¼Œå°±ä¸å†èµ·æ–°çš„äº‹åŠ¡ã€‚ å‡å¦‚ ServiceB.MethodB() è¿è¡Œçš„æ—¶å€™å‘ç°è‡ªå·±æ²¡æœ‰åœ¨äº‹åŠ¡ä¸­ï¼Œä»–å°±ä¼šä¸ºè‡ªå·±åˆ†é…ä¸€ä¸ªäº‹åŠ¡ã€‚ è¿™æ ·ï¼Œåœ¨ ServiceA.MethodA() æˆ–è€…åœ¨ ServiceB.MethodB() å†…çš„ä»»ä½•åœ°æ–¹å‡ºç°å¼‚å¸¸ï¼Œäº‹åŠ¡éƒ½ä¼šè¢«å›æ»šã€‚ PROPAGATION_REQUIRES_NEW æ¯”å¦‚æˆ‘ä»¬è®¾è®¡ ServiceA.MethodA() çš„äº‹åŠ¡çº§åˆ«ä¸º PROPAGATION_REQUIREDï¼ŒServiceB.MethodB() çš„äº‹åŠ¡çº§åˆ«ä¸º PROPAGATION_REQUIRES_NEWã€‚é‚£ä¹ˆå½“æ‰§è¡Œåˆ° ServiceB.MethodB() çš„æ—¶å€™ï¼ŒServiceA.MethodA() æ‰€åœ¨çš„äº‹åŠ¡å°±ä¼šæŒ‚èµ·ï¼ŒServiceB.MethodB() ä¼šèµ·ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œç­‰å¾… ServiceB.MethodB() çš„äº‹åŠ¡å®Œæˆä»¥åï¼Œå®ƒæ‰ç»§ç»­æ‰§è¡Œã€‚ ä»– ä¸ PROPAGATION_REQUIRED çš„ äº‹ åŠ¡ åŒº åˆ« åœ¨ äº äº‹ åŠ¡ çš„ å› æ»š ç¨‹ åº¦ äº† ã€‚ å›  ä¸ºServiceB.MethodB() æ˜¯æ–°èµ·ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆå°±æ˜¯å­˜åœ¨ä¸¤ä¸ªä¸åŒçš„äº‹åŠ¡ã€‚å¦‚æœServiceB.MethodB() å·² ç» æ äº¤ ï¼Œ é‚£ ä¹ˆ ServiceA.MethodA() å¤± è´¥ å› æ»š ï¼ŒServiceB.MethodB() æ˜¯ä¸ä¼šå›æ»šçš„ã€‚å¦‚æœ ServiceB.MethodB() å¤±è´¥å›æ»šï¼Œå¦‚æœä»–æŠ›å‡ºçš„å¼‚å¸¸è¢« ServiceA.MethodA() æ•è·ï¼ŒServiceA.MethodA() äº‹åŠ¡ä»ç„¶å¯èƒ½æäº¤(ä¸»è¦çœ‹ B æŠ›å‡ºçš„å¼‚å¸¸æ˜¯ä¸æ˜¯ A ä¼šå›æ»šçš„å¼‚å¸¸)ã€‚ PROPAGATION_SUPPORTSå‡è®¾ ServiceB.MethodB() çš„äº‹åŠ¡çº§åˆ«ä¸º PROPAGATION_SUPPORTSï¼Œé‚£ä¹ˆå½“æ‰§è¡Œåˆ°ServiceB.MethodB()æ—¶ï¼Œå¦‚æœå‘ç° ServiceA.MethodA()å·²ç»å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œåˆ™åŠ å…¥å½“å‰çš„äº‹åŠ¡ï¼Œå¦‚æœå‘ç° ServiceA.MethodA()æ²¡æœ‰å¼€å¯äº‹åŠ¡ï¼Œåˆ™è‡ªå·±ä¹Ÿä¸å¼€å¯äº‹åŠ¡ã€‚è¿™ç§æ—¶å€™ï¼Œå†…éƒ¨æ–¹æ³•çš„äº‹åŠ¡æ€§å®Œå…¨ä¾èµ–äºæœ€å¤–å±‚çš„äº‹åŠ¡ã€‚ PROPAGATION_NESTEDç° åœ¨ çš„ æƒ… å†µ å°± å˜ å¾— æ¯” è¾ƒ å¤ æ‚ äº† , ServiceB.MethodB() çš„ äº‹ åŠ¡ å± æ€§ è¢« é… ç½® ä¸ºPROPAGATION_NESTED, æ­¤æ—¶ä¸¤è€…ä¹‹é—´åˆå°†å¦‚ä½•åä½œå‘¢? ServiceB.MethodB() å¦‚æœ rollback, é‚£ä¹ˆå†…éƒ¨äº‹åŠ¡(å³ ServiceB.MethodB()) å°†å›æ»šåˆ°å®ƒæ‰§è¡Œå‰çš„ SavePointè€Œå¤–éƒ¨äº‹åŠ¡(å³ ServiceA.MethodA()) å¯ä»¥æœ‰ä»¥ä¸‹ä¸¤ç§å¤„ç†æ–¹å¼: æ•è·å¼‚å¸¸ï¼Œæ‰§è¡Œå¼‚å¸¸åˆ†æ”¯é€»è¾‘ 1234567void MethodA() &#123; try &#123; ServiceB.MethodB(); &#125; catch (SomeException) &#123; // æ‰§è¡Œå…¶ä»–ä¸šåŠ¡, å¦‚ ServiceC.MethodC(); &#125;&#125; è¿™ ç§ æ–¹ å¼ ä¹Ÿ æ˜¯ åµŒ å¥— äº‹ åŠ¡ æœ€ æœ‰ ä»· å€¼ çš„ åœ° æ–¹ , å®ƒ èµ· åˆ° äº† åˆ† æ”¯ æ‰§ è¡Œ çš„ æ•ˆ æœ , å¦‚ æœServiceB.MethodB()å¤±è´¥, é‚£ä¹ˆæ‰§è¡Œ ServiceC.MethodC(), è€Œ ServiceB.MethodB()å·²ç»å›æ»šåˆ°å®ƒæ‰§è¡Œä¹‹å‰çš„ SavePoint, æ‰€ä»¥ä¸ä¼šäº§ç”Ÿè„æ•°æ®(ç›¸å½“äºæ­¤æ–¹æ³•ä»æœªæ‰§è¡Œè¿‡),è¿™ ç§ ç‰¹ æ€§ å¯ ä»¥ ç”¨ åœ¨ æŸ äº› ç‰¹ æ®Š çš„ ä¸š åŠ¡ ä¸­ , è€Œ PROPAGATION_REQUIRED å’ŒPROPAGATION_REQUIRES_NEW éƒ½æ²¡æœ‰åŠæ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚ å¤–éƒ¨äº‹åŠ¡å›æ»š/æäº¤ ä»£ç ä¸åšä»»ä½•ä¿®æ”¹, é‚£ä¹ˆå¦‚æœå†…éƒ¨äº‹åŠ¡(ServiceB.MethodB())rollback, é‚£ä¹ˆé¦–å…ˆ ServiceB.MethodB() å›æ»šåˆ°å®ƒæ‰§è¡Œä¹‹å‰çš„ SavePoint(åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¼šå¦‚æ­¤), å¤–éƒ¨äº‹åŠ¡(å³ ServiceA.MethodA()) å°†æ ¹æ®å…·ä½“çš„é…ç½®å†³å®šè‡ªå·±æ˜¯commit è¿˜æ˜¯ rollbackã€‚ â€‹ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹äº‹åŠ¡çš„æºç ã€‚ 5.Springäº‹åŠ¡æ ‡ç­¾è§£æ1234567891011121314151617&lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt; &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;driverClassName&#125;&quot;&gt;&lt;/property&gt; &lt;property name=&quot;url&quot; value=&quot;$&#123;url&#125;&quot;&gt;&lt;/property&gt; &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot;&gt;&lt;/property&gt; &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot;&gt;&lt;/property&gt;&lt;/bean&gt;&lt;!-- springä¸­åŸºäºæ³¨è§£ çš„å£°æ˜å¼äº‹åŠ¡æ§åˆ¶é…ç½®æ­¥éª¤ 1ã€é…ç½®äº‹åŠ¡ç®¡ç†å™¨ 2ã€å¼€å¯springå¯¹æ³¨è§£äº‹åŠ¡çš„æ”¯æŒ 3ã€åœ¨éœ€è¦äº‹åŠ¡æ”¯æŒçš„åœ°æ–¹ä½¿ç”¨@Transactionalæ³¨è§£ --&gt;&lt;!-- é…ç½®äº‹åŠ¡ç®¡ç†å™¨ --&gt;&lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;&gt;&lt;/property&gt;&lt;/bean&gt;&lt;!-- å¼€å¯springå¯¹æ³¨è§£äº‹åŠ¡çš„æ”¯æŒ--&gt;&lt;tx:annotation-driven&gt;&lt;/tx:annotation-driven&gt; è¿™æ˜¯å¼€å¯Springäº‹åŠ¡éœ€è¦åœ¨é…ç½®æ–‡ä»¶å†™çš„ä¸€äº›é…ç½®æ ‡ç­¾ï¼Œä¸»è¦å°±æ˜¯æœ€åä¸€è¡Œï¼Œå¼€å¯äº‹åŠ¡åŠŸèƒ½ã€‚â€‹ è¿™ä¸ªæ ‡ç­¾ä¸æ˜¯Springçš„åŸç”Ÿæ ‡ç­¾ï¼Œæ‰€ä»¥éœ€è¦é¢å¤–çš„è§£æå™¨æ¥è§£æã€‚åœ¨spring-txåŒ…ä¸‹çš„META-INFç›®å½•ä¸‹ï¼Œæœ‰ä¸€ä¸ªspring.handlersé…ç½®æ–‡ä»¶ï¼Œé‡Œé¢æ³¨å†Œäº†äº‹åŠ¡æ ‡ç­¾çš„è§£æå™¨ã€‚â€‹ æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªè§£æå™¨ã€‚â€‹ 12345678910111213141516171819202122232425/** * è¿™ä¸ªç±»å°±æ˜¯äº‹åŠ¡æ ‡ç­¾è§£æå™¨ï¼Œæ³¨æ„è¿™é‡Œæœ‰ä¸€ä¸ªinitæ–¹æ³•ï¼ŒåŠ è½½ä¸€äº›å½“å‰è§£æå™¨èƒ½å¤Ÿè§£æçš„beanæ ‡ç­¾ï¼Œç»™è§£æå™¨èµ‹èƒ½ã€‚ */public class TxNamespaceHandler extends NamespaceHandlerSupport &#123; static final String TRANSACTION_MANAGER_ATTRIBUTE = &quot;transaction-manager&quot;; static final String DEFAULT_TRANSACTION_MANAGER_BEAN_NAME = &quot;transactionManager&quot;; static String getTransactionManagerName(Element element) &#123; return (element.hasAttribute(TRANSACTION_MANAGER_ATTRIBUTE) ? element.getAttribute(TRANSACTION_MANAGER_ATTRIBUTE) : DEFAULT_TRANSACTION_MANAGER_BEAN_NAME); &#125; @Override public void init() &#123; registerBeanDefinitionParser(&quot;advice&quot;, new TxAdviceBeanDefinitionParser()); //æ‹‰çœ‹è¿™ä¸ªæ ‡ç­¾çš„è§£æé€»è¾‘ registerBeanDefinitionParser(&quot;annotation-driven&quot;, new AnnotationDrivenBeanDefinitionParser()); registerBeanDefinitionParser(&quot;jta-transaction-manager&quot;, new JtaTransactionManagerBeanDefinitionParser()); &#125;&#125; ä¸»è¦æ¥çœ‹ä¸‹**AnnotationDrivenBeanDefinitionParser**è§£æå™¨çš„è§£ææ ‡ç­¾é€»è¾‘ã€‚â€‹ 1234567891011121314151617181920@Override@Nullablepublic BeanDefinition parse(Element element, ParserContext parserContext) &#123; //å‘Springå®¹å™¨æ³¨å†Œä¸€ä¸ªBDï¼šTransactionalEventListenerFactory registerTransactionalEventListenerFactory(parserContext); //ä»æ ‡ç­¾é‡Œé¢è·å–modeå±æ€§ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¸é…ç½®è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥èµ°elseçš„é€»è¾‘ String mode = element.getAttribute(&quot;mode&quot;); if (&quot;aspectj&quot;.equals(mode)) &#123; // mode=&quot;aspectj&quot; registerTransactionAspect(element, parserContext); if (ClassUtils.isPresent(&quot;jakarta.transaction.Transactional&quot;, getClass().getClassLoader())) &#123; registerJtaTransactionAspect(element, parserContext); &#125; &#125; else &#123; // mode=&quot;proxy&quot; å¾€ä¸‹èµ° AopAutoProxyConfigurer.configureAutoProxyCreator(element, parserContext); &#125; return null;&#125; ç»§ç»­å¾€ä¸‹èµ°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public static void configureAutoProxyCreator(Element element, ParserContext parserContext) &#123; //å‘Springå®¹å™¨ä¸­æ³¨å†ŒBD -&gt; InfrastructureAdvisorAutoProxyCreator //BDçš„åç§°ï¼šinternalAutoProxyCreator ï¼Œç›¸å½“äºå¾€å®¹å™¨ä¸­åŠ å…¥äº†AOPçš„ç»„ä»¶ AopNamespaceUtils.registerAutoProxyCreatorIfNecessary(parserContext, element); //äº‹åŠ¡åˆ‡é¢çš„åç§° ï¼šorg.springframework.transaction.config.internalTransactionAdvisor String txAdvisorBeanName = TransactionManagementConfigUtils.TRANSACTION_ADVISOR_BEAN_NAME; //å¦‚æœå®¹å™¨ä¸­æ²¡æœ‰äº‹åŠ¡åˆ‡é¢,å°±å¾€å®¹å™¨ä¸­æ³¨å†Œä¸€ä¸ªäº‹åŠ¡åˆ‡é¢ if (!parserContext.getRegistry().containsBeanDefinition(txAdvisorBeanName)) &#123; //æŠŠæ ‡ç­¾åŒ…è£…æˆä¸€ä¸ªå¯¹è±¡ Object eleSource = parserContext.extractSource(element); // Create the TransactionAttributeSource definition. RootBeanDefinition sourceDef = new RootBeanDefinition( &quot;org.springframework.transaction.annotation.AnnotationTransactionAttributeSource&quot;); sourceDef.setSource(eleSource); sourceDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE); String sourceName = parserContext.getReaderContext().registerWithGeneratedName(sourceDef); // Create the TransactionInterceptor definition. äº‹åŠ¡å¢å¼ºå™¨ RootBeanDefinition interceptorDef = new RootBeanDefinition(TransactionInterceptor.class); interceptorDef.setSource(eleSource); interceptorDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE); //å¾€bdä¸­æ³¨å†Œä¿¡æ¯ äº‹åŠ¡ç®¡ç†å™¨ registerTransactionManager(element, interceptorDef); //å¾€bdé‡Œé¢æ³¨å†Œäº‹åŠ¡å±æ€§ä¿¡æ¯ interceptorDef.getPropertyValues().add(&quot;transactionAttributeSource&quot;, new RuntimeBeanReference(sourceName)); String interceptorName = parserContext.getReaderContext().registerWithGeneratedName(interceptorDef); // Create the TransactionAttributeSourceAdvisor definition. RootBeanDefinition advisorDef = new RootBeanDefinition(BeanFactoryTransactionAttributeSourceAdvisor.class); advisorDef.setSource(eleSource); advisorDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE); advisorDef.getPropertyValues().add(&quot;transactionAttributeSource&quot;, new RuntimeBeanReference(sourceName)); advisorDef.getPropertyValues().add(&quot;adviceBeanName&quot;, interceptorName); if (element.hasAttribute(&quot;order&quot;)) &#123; advisorDef.getPropertyValues().add(&quot;order&quot;, element.getAttribute(&quot;order&quot;)); &#125; parserContext.getRegistry().registerBeanDefinition(txAdvisorBeanName, advisorDef); CompositeComponentDefinition compositeDef = new CompositeComponentDefinition(element.getTagName(), eleSource); compositeDef.addNestedComponent(new BeanComponentDefinition(sourceDef, sourceName)); compositeDef.addNestedComponent(new BeanComponentDefinition(interceptorDef, interceptorName)); compositeDef.addNestedComponent(new BeanComponentDefinition(advisorDef, txAdvisorBeanName)); parserContext.registerComponent(compositeDef); &#125;&#125; ä¸»è¦å°±æ˜¯å¾€å®¹å™¨ä¸­æ³¨å†Œäº†å‡ ä¸ªbeanã€‚æˆ‘ä»¬é€šè¿‡ä¸€å¼ å›¾æ¥çœ‹ä¸€ä¸‹ã€‚â€‹ â€‹ 6.åˆ›å»ºä»£ç†å¯¹è±¡ä¸Šé¢è¯´åˆ°ï¼Œè§£æäº‹åŠ¡æ ‡ç­¾çš„æ—¶å€™ä¼šå¾€Springå®¹å™¨ä¸­æ³¨å…¥ä¸€ä¸ªç±»**InfrastructureAdvisorAutoProxyCreator**ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„ç»§æ‰¿å…³ç³»ã€‚â€‹ \u0000è¿™ä¸ªæ˜¯æ˜¯ä¸€ä¸ªæŠ½è±¡è‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåç½®å¤„ç†å™¨ã€‚è¿™é‡Œå°±å’ŒAOPçš„é€»è¾‘å…³è”èµ·æ¥äº†ã€‚æˆ‘ä»¬ç›´æ¥çœ‹AOPåˆ›å»ºä»£ç†å¯¹è±¡çš„åç½®å¤„ç†å™¨çš„æ–¹æ³•ã€‚â€‹ 1234567891011121314@Overridepublic Object postProcessAfterInitialization(@Nullable Object bean/*springå®¹å™¨å®Œå…¨åˆå§‹åŒ–å®Œæ¯•çš„å¯¹è±¡*/, String beanName/*beanåç§°*/) &#123; if (bean != null) &#123; /*è·å–ç¼“å­˜å»ºï¼šå¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯beanNameï¼Œå¦‚æœæ˜¯å·¥å‚beanå¯¹è±¡ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ &amp; */ Object cacheKey = getCacheKey(bean.getClass(), beanName); /*é˜²æ­¢é‡å¤ä»£ç†æŸä¸ªbeanå®ä¾‹*/ if (this.earlyProxyReferences.remove(cacheKey) != bean) &#123; /*åˆ¤æ–­æ˜¯å¦éœ€è¦åŒ…è£… AOPæ“ä½œçš„å…¥å£*/ return wrapIfNecessary(bean, beanName, cacheKey); &#125; &#125; return bean;&#125; è¿™é‡Œçš„é€»è¾‘å‰é¢å·²ç»è§£é‡Šè¿‡ï¼Œç›´æ¥å¾€ä¸‹èµ°ã€‚â€‹ 123456789101112131415161718192021222324252627282930313233343536373839404142protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123; /*æ¡ä»¶ä¸€èˆ¬ä¸æˆç«‹ï¼Œå› ä¸ºæ­£å¸¸æƒ…å†µä¸‹å¾ˆå°‘ä½¿ç”¨TargetSourceCreator å»åˆ›å»ºå¯¹è±¡ã€‚BeforeInstantiationé˜¶æ®µ*/ if (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123; return bean; &#125; /* * å¦‚æœå½“å‰beanå¯¹è±¡ä¸éœ€è¦å¢å¼ºå¤„ç† * åˆ¤æ–­æ˜¯åœ¨BeforeInstantiationé˜¶æ®µé˜¶æ®µåšçš„ */ if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123; return bean; &#125; /* * æ¡ä»¶ä¸€ï¼šåˆ¤æ–­å½“å‰beanç±»å‹æ˜¯å¦æ˜¯åŸºç¡€æ¡†æ¶ç±»å‹çš„å®ä¾‹ï¼Œä¸èƒ½è¢«å¢å¼º * æ¡ä»¶äºŒï¼šåˆ¤æ–­å½“å‰beannameæ˜¯å¦æ˜¯æ˜¯å¿½ç•¥çš„beanï¼Œä¸éœ€è¦è¢«å¢å¼º */ if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123; //è¿›å…¥è¿™é‡Œè¡¨ç¤ºä¸éœ€è¦å¢å¼º this.advisedBeans.put(cacheKey, Boolean.FALSE); //ç›´æ¥è¿”å›ä¸Šå±‚ return bean; &#125; //æŸ¥æ‰¾é€‚åˆå½“å‰ç±»çš„é€šçŸ¥ éå¸¸é‡è¦ ï¼ï¼ï¼ Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); //åˆ¤æ–­å½“å‰æŸ¥è¯¢å‡ºæ¥çš„é€šçŸ¥æ˜¯ä¸æ˜¯ç©ºï¼Œå¦‚æœä¸æ˜¯ç©ºï¼Œè¯´æ˜èµ°å¢å¼ºé€»è¾‘ if (specificInterceptors != DO_NOT_PROXY) &#123; //è®°å¾—æ”¾åœ¨ç¼“å­˜true this.advisedBeans.put(cacheKey, Boolean.TRUE); /*çœŸæ­£å»åˆ›å»ºä»£ç†å¯¹è±¡*/ Object proxy = createProxy( bean.getClass()/*ç›®æ ‡å¯¹è±¡*/, beanName/*beanName*/, specificInterceptors/*åŒ¹é…å½“å‰ç›®æ ‡å¯¹è±¡classçš„æ‹¦æˆªå™¨*/, new SingletonTargetSource(bean)/*æŠŠå½“å‰beanè¿›è¡Œäº†ä¸€ä¸ªå°è£…*/); //ä¿å­˜ä»£ç†å¯¹è±¡ç±»å‹ this.proxyTypes.put(cacheKey, proxy.getClass()); //è¿”å›ä»£ç†å¯¹è±¡ return proxy; &#125; //æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜æ²¡æŸ¥åˆ°è¿™ä¸ªç±»ç›¸å…³çš„é€šçŸ¥ï¼Œæ²¡æ³•å¢å¼ºï¼Œç›´æ¥è¿”å› this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean;&#125; çœ‹ä¸€ä¸‹**getAdvicesAndAdvisorsForBean()**ã€‚â€‹ 12345678910111213@Override@Nullableprotected Object[] getAdvicesAndAdvisorsForBean( Class&lt;?&gt; beanClass, String beanName, @Nullable TargetSource targetSource) &#123; //æŸ¥è¯¢åˆé€‚å½“å‰ç±»å‹çš„é€šçŸ¥ List&lt;Advisor&gt; advisors = findEligibleAdvisors(beanClass, beanName); //é€šçŸ¥ä¸ºç©ºè¿”å›ç©º if (advisors.isEmpty()) &#123; return DO_NOT_PROXY; &#125; //å¦åˆ™è½¬æˆä¸€ä¸ªæ•°ç»„è¿”å› return advisors.toArray();&#125; ç»§ç»­å¾€ä¸‹ã€‚ 123456789101112protected List&lt;Advisor&gt; findEligibleAdvisors(Class&lt;?&gt; beanClass, String beanName) &#123; /*è·å–åˆ°å½“å‰é¡¹ç›®é‡Œé¢æ‰€æœ‰å¯ä»¥ä½¿ç”¨çš„å¢å¼ºå™¨*/ List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors(); /*å°†ä¸Šä¸€æ­¥è·å–åˆ°çš„å…¨éƒ¨å¢å¼ºå™¨è¿›è¡Œè¿‡æ»¤ï¼Œç•™ä¸‹é€‚åˆå½“å‰ç±»çš„*/ List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName); /*åœ¨è¿™ä¸€æ­¥ï¼Œä¼šåœ¨indexä¸º0 çš„ä½ç½®æ·»åŠ ä¸€ä¸ªå¢å¼ºå™¨*/ extendAdvisors(eligibleAdvisors); if (!eligibleAdvisors.isEmpty()) &#123; eligibleAdvisors = sortAdvisors(eligibleAdvisors); &#125; return eligibleAdvisors;&#125; ç»§ç»­å¾€ä¸‹çœ‹è¿‡æ»¤å¢å¼ºå™¨çš„é€»è¾‘ã€‚ 12345678910111213141516171819202122232425262728public static List&lt;Advisor&gt; findAdvisorsThatCanApply(List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; clazz) &#123; /*å¦‚æœè¿™ä¸ªç±»å…¨éƒ¨å¯ç”¨çš„å¢å¼ºå™¨ä¸ºç©ºï¼Œç›´æ¥è¿”å›*/ if (candidateAdvisors.isEmpty()) &#123; return candidateAdvisors; &#125; //åŒ¹é…å½“å‰class çš„ advisor ä¿¡æ¯ List&lt;Advisor&gt; eligibleAdvisors = new ArrayList&lt;&gt;(); //ä¸è€ƒè™‘éŸ³é˜¶å¢å¼º for (Advisor candidate : candidateAdvisors) &#123; if (candidate instanceof IntroductionAdvisor &amp;&amp; canApply(candidate, clazz)) &#123; eligibleAdvisors.add(candidate); &#125; &#125; //å‡è®¾ å€¼ä¸ºfalse boolean hasIntroductions = !eligibleAdvisors.isEmpty(); for (Advisor candidate : candidateAdvisors) &#123; if (candidate instanceof IntroductionAdvisor) &#123; // already processed continue; &#125; //åˆ¤æ–­å½“å‰å¢å¼ºå™¨æ˜¯å¦åŒ¹é…class if (canApply(candidate, clazz, hasIntroductions)) &#123; eligibleAdvisors.add(candidate); &#125; &#125; //è¿”å›çš„éƒ½æ˜¯åŒ¹é…å½“å‰classçš„advisor return eligibleAdvisors;&#125; çœ‹è¿™ä¸ªé‡è½½çš„æ–¹æ³•**canApply()**ã€‚â€‹ 123456789101112131415public static boolean canApply(Advisor advisor, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123; if (advisor instanceof IntroductionAdvisor) &#123; return ((IntroductionAdvisor) advisor).getClassFilter().matches(targetClass); &#125; //å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯èµ°è¿™é‡Œï¼Œå› ä¸ºåˆ›å»ºçš„å¢å¼ºå™¨æ˜¯ InstantiationModelAwarePointcutAdvisorImpl else if (advisor instanceof PointcutAdvisor) &#123; PointcutAdvisor pca = (PointcutAdvisor) advisor; //æ–¹æ³•é‡è½½ return canApply(pca.getPointcut(), targetClass, hasIntroductions); &#125; else &#123; // It doesn&#x27;t have a pointcut so we assume it applies. return true; &#125;&#125; Springäº‹åŠ¡å¯¼å…¥åˆ°å®¹å™¨ä¸­çš„å¢å¼ºå™¨æ˜¯å“ªä¸€ä¸ªå‘¢ï¼Ÿå›é¡¾ä¸€ä¸‹ä¸Šé¢çš„å›¾ï¼Œ**BeanFactoryTransactionAttributeSourceAdvisor**ã€‚â€‹ æˆ‘ä»¬ç›´æ¥æ¥åˆ°è¿™ä¸ªbeanã€‚â€‹ è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åœ¨æ¥çœ‹**canApply()**ã€‚â€‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445/*åˆ¤æ–­å½“å‰åˆ‡ç‚¹æ˜¯å¦åŒ¹é…å½“å‰class*/public static boolean canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123; Assert.notNull(pc, &quot;Pointcut must not be null&quot;); //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰classå°±ä¸æ»¡è¶³åˆ‡ç‚¹çš„å®šä¹‰ ï¼Œç›´æ¥è¿”å›ï¼Œå› ä¸ºåé¢æ˜¯åˆ¤æ–­æ–¹æ³•åŒ¹é…çš„é€»è¾‘ï¼Œç›´æ¥è¿”å› if (!pc.getClassFilter().matches(targetClass)) &#123; return false; &#125; //äº‹åŠ¡é€»è¾‘ï¼šBeanFactoryTransactionAttributeSourceAdvisor é‡Œé¢æœ‰ä¸€ä¸ªè¿æ¥ç‚¹ã€‚è¿™ä¸ªæ—¶å€™è·å–åˆ°çš„å®é™…ä¸Šå°±æ˜¯äº‹åŠ¡å¢å¼ºå™¨é‡Œé¢çš„è¿æ¥ç‚¹çš„æ–¹æ³•åŒ¹é…å™¨ã€‚ //å…¶ä»–é€»è¾‘ä¸ç”¨ç®¡ï¼Œæˆ‘ä»¬ç›´æ¥è·³åˆ°æ–¹æ³•åŒ¹é…çš„é€»è¾‘ã€‚ //è·å–æ–¹æ³•åŒ¹é…å™¨ MethodMatcher methodMatcher = pc.getMethodMatcher(); //å¦‚æœæ˜¯trueï¼Œç›´æ¥è¿”å›trueï¼Œå› ä¸ºtrueä¸åšåˆ¤æ–­ï¼Œç›´æ¥åŒ¹é…æ‰€æœ‰æ–¹æ³• if (methodMatcher == MethodMatcher.TRUE) &#123; // No need to iterate the methods if we&#x27;re matching any method anyway... return true; &#125; //skip IntroductionAwareMethodMatcher introductionAwareMethodMatcher = null; if (methodMatcher instanceof IntroductionAwareMethodMatcher) &#123; introductionAwareMethodMatcher = (IntroductionAwareMethodMatcher) methodMatcher; &#125; //ä¿å­˜å½“å‰ç›®æ ‡å¯¹è±¡clazz + ç›®æ ‡å¯¹è±¡ çˆ¶ç±» çˆ·çˆ·ç±» ... çš„æ¥å£ + è‡ªèº«å®ç°çš„æ¥å£ Set&lt;Class&lt;?&gt;&gt; classes = new LinkedHashSet&lt;&gt;(); //åˆ¤æ–­ç›®æ ‡å¯¹è±¡æ˜¯ä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œç¡®ä¿classeså†…å­˜å‚¨çš„æ•°æ®åŒ…æ‹¬ç›®æ ‡å¯¹è±¡çš„classï¼Œè€Œä¸æ˜¯ä»£ç†ç±»class if (!Proxy.isProxyClass(targetClass)) &#123; classes.add(ClassUtils.getUserClass(targetClass)); &#125; classes.addAll(ClassUtils.getAllInterfacesForClassAsSet(targetClass)); //éå†classesï¼Œè·å–å½“å‰classå®šä¹‰çš„methodï¼Œæ•´ä¸ªforå¾ªç¯ä¼šæ£€æŸ¥å½“å‰ç›®æ ‡clazz ä¸Šçº§æ¥å£çš„æ‰€æœ‰æ–¹æ³• //çœ‹çœ‹æ˜¯å¦ä¼šè¢«æ–¹æ³•åŒ¹é…å™¨åŒ¹é…ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ–¹æ³•åŒ¹é…æˆåŠŸï¼Œå°±è¯´æ˜ç›®æ ‡classéœ€è¦è¢«AOPä»£ç†å¢å¼º for (Class&lt;?&gt; clazz : classes) &#123; Method[] methods = ReflectionUtils.getAllDeclaredMethods(clazz); for (Method method : methods) &#123; //äº‹åŠ¡æ³¨é‡Šï¼šæ–¹æ³•åŒ¹é…ï¼šTransactionAttributeSourcePointcut çš„ æ–¹æ³•å®ç°ã€‚ if (introductionAwareMethodMatcher != null ? introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions) : methodMatcher.matches(method, targetClass)) &#123; return true; &#125; &#125; &#125; //æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜å½“å‰ç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½æ²¡æœ‰åŒ¹é…æˆåŠŸï¼Œå½“å‰ç±»ä¸éœ€è¦AOPçš„å¢å¼ºã€‚ return false;&#125; \u0000è¿™é‡Œä¼šè°ƒç”¨åˆ°**TransactionAttributeSourcePointcut**ç±»çš„**matches()**ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚â€‹ 12345@Overridepublic boolean matches(Method method, Class&lt;?&gt; targetClass) &#123; TransactionAttributeSource tas = getTransactionAttributeSource(); return (tas == null || tas.getTransactionAttribute(method, targetClass) != null);&#125; ç»§ç»­å¾€ä¸‹çœ‹ **getTransactionAttribute()**ï¼Œ æ¥åˆ°äº† **AbstractFallbackTransactionAttributeSource**ã€‚\u0000 12345678910111213141516171819202122232425262728293031323334353637383940414243@Override@Nullablepublic TransactionAttribute getTransactionAttribute(Method method, @Nullable Class&lt;?&gt; targetClass) &#123; if (method.getDeclaringClass() == Object.class) &#123; return null; &#125; //ç¼“å­˜çš„é€»è¾‘ // First, see if we have a cached value. Object cacheKey = getCacheKey(method, targetClass); TransactionAttribute cached = this.attributeCache.get(cacheKey); if (cached != null) &#123; // Value will either be canonical value indicating there is no transaction attribute, // or an actual transaction attribute. if (cached == NULL_TRANSACTION_ATTRIBUTE) &#123; return null; &#125; else &#123; return cached; &#125; &#125; else &#123; //çœŸæ­£å»æ‰§è¡Œçš„é€»è¾‘ã€‚ // We need to work it out. è§£æäº‹åŠ¡å±æ€§æ³¨è§£ï¼Œè·å–äº‹åŠ¡å±æ€§ä¿¡æ¯ã€‚ TransactionAttribute txAttr = computeTransactionAttribute(method, targetClass); // Put it in the cache. åŠ ç¼“å­˜ã€‚ if (txAttr == null) &#123; this.attributeCache.put(cacheKey, NULL_TRANSACTION_ATTRIBUTE); &#125; else &#123; String methodIdentification = ClassUtils.getQualifiedMethodName(method, targetClass); if (txAttr instanceof DefaultTransactionAttribute) &#123; DefaultTransactionAttribute dta = (DefaultTransactionAttribute) txAttr; dta.setDescriptor(methodIdentification); dta.resolveAttributeStrings(this.embeddedValueResolver); &#125; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Adding transactional method &#x27;&quot; + methodIdentification + &quot;&#x27; with attribute: &quot; + txAttr); &#125; this.attributeCache.put(cacheKey, txAttr); &#125; return txAttr; &#125;&#125; æŸ¥æ‰¾äº‹ç‰©æ³¨è§£ä¿¡æ¯å¹¶åŠ ç¼“å­˜ã€‚â€‹ **computeTransactionAttribute()**\u0000 123456789101112131415161718192021222324252627282930313233343536373839404142434445@Nullableprotected TransactionAttribute computeTransactionAttribute(Method method, @Nullable Class&lt;?&gt; targetClass) &#123; // Don&#x27;t allow no-public methods as required. if (allowPublicMethodsOnly() &amp;&amp; !Modifier.isPublic(method.getModifiers())) &#123; return null; &#125; //è·å–ç›®æ ‡ç±»ä¸Šçš„methodï¼Œå› ä¸º@Transactionalæ³¨è§£å¯èƒ½æ˜¯æ ‡è®°åœ¨æ¥å£ä¸Šçš„ // The method may be on an interface, but we need attributes from the target class. // If the target class is null, the method will be unchanged. Method specificMethod = AopUtils.getMostSpecificMethod(method, targetClass); //è·å–ç›®æ ‡ç±»ä¸Šçš„æ–¹æ³•çš„æ³¨è§£ä¿¡æ¯ã€‚ // First try is the method in the target class. TransactionAttribute txAttr = findTransactionAttribute(specificMethod); if (txAttr != null) &#123; //è·å–åˆ°äº†å°±è¿”å› return txAttr; &#125; // Second try is the transaction attribute on the target class. //åˆ°å®ç°ç±»çš„æ–¹æ³•ä¸Šå»æ‰¾ txAttr = findTransactionAttribute(specificMethod.getDeclaringClass()); if (txAttr != null &amp;&amp; ClassUtils.isUserLevelMethod(method)) &#123; //æ‰¾åˆ°åˆ™è¿”å› return txAttr; &#125; //æ­¤æ—¶è¯´æ˜æ³¨è§£æ˜¯æ‰“åœ¨äº†æ¥å£ä¸Šï¼Œåˆ°ç›®æ ‡æ¥å£ä¸Šæå–methodä¿¡æ¯ if (specificMethod != method) &#123; // Fallback is to look at the original method. txAttr = findTransactionAttribute(method); if (txAttr != null) &#123; //æ‰¾åˆ°åˆ™è¿”å› return txAttr; &#125; //æ­¤æ—¶è¯´æ˜æ³¨è§£å¯èƒ½æ‰“åœ¨äº†ç›®æ ‡æ¥å£çš„æ–¹æ³•ä¸Šï¼Œåˆ°æ¥å£çš„æ–¹æ³•ä¸Šæå–æ³¨è§£ä¿¡æ¯ // Last fallback is the class of the original method. txAttr = findTransactionAttribute(method.getDeclaringClass()); if (txAttr != null &amp;&amp; ClassUtils.isUserLevelMethod(method)) &#123; return txAttr; &#125; &#125; //è¯´æ˜methodå¹¶æ²¡æœ‰å®šä¹‰äº‹åŠ¡æ³¨è§£ä¿¡æ¯ï¼Œä¸éœ€è¦äº‹åŠ¡æ”¯æŒã€‚ return null;&#125; è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦é€»è¾‘å°±æ˜¯è·å–åˆ°ç±»ï¼Œæ¥å£æˆ–è€…æ–¹æ³•ä¸Šçš„äº‹åŠ¡æ³¨è§£ä¿¡æ¯ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„è§£æäº‹åŠ¡æ³¨è§£çš„é€»è¾‘ã€‚**findTransactionAttribute()**ã€‚â€‹ 123456@Override@Nullableprotected TransactionAttribute findTransactionAttribute(Method method) &#123; return determineTransactionAttribute(method);&#125; æˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªç±»çš„å±æ€§ï¼Œæœ‰ä¸€ä¸ªäº‹åŠ¡æ³¨è§£è§£æå™¨é›†åˆï¼Œè¿™ä¸ªé›†åˆæ˜¯ä½•æ—¶èµ‹å€¼çš„å‘¢ï¼Ÿæ˜¯åœ¨åˆ›å»ºè¿™ä¸ªç±»çš„æ—¶å€™ï¼Œçœ‹æ„é€ å™¨ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ **SpringTransactionAnnotationParser** æ•´ä¸€ä¸ªè§£æå™¨å³å¯ã€‚ 123456789101112131415161718private final Set&lt;TransactionAnnotationParser&gt; annotationParsers; public AnnotationTransactionAttributeSource(boolean publicMethodsOnly) &#123; this.publicMethodsOnly = publicMethodsOnly; if (jta12Present || ejb3Present) &#123; this.annotationParsers = new LinkedHashSet&lt;&gt;(4); this.annotationParsers.add(new SpringTransactionAnnotationParser()); if (jta12Present) &#123; this.annotationParsers.add(new JtaTransactionAnnotationParser()); &#125; if (ejb3Present) &#123; this.annotationParsers.add(new Ejb3TransactionAnnotationParser()); &#125; &#125; else &#123; this.annotationParsers = Collections.singleton(new SpringTransactionAnnotationParser()); &#125; &#125; æˆ‘ä»¬å†å›åˆ°æå–äº‹åŠ¡æ³¨è§£ä¿¡æ¯çš„é€»è¾‘ã€‚**determineTransactionAttribute()**â€‹ 1234567891011@Nullableprotected TransactionAttribute determineTransactionAttribute(AnnotatedElement element) &#123; for (TransactionAnnotationParser parser : this.annotationParsers) &#123; //æˆ‘ä»¬æ¥çœ‹ SpringTransactionAnnotationParser é‡Œé¢çš„é€»è¾‘ TransactionAttribute attr = parser.parseTransactionAnnotation(element); if (attr != null) &#123; return attr; &#125; &#125; return null;&#125; è¿™é‡Œæ˜¯å¾ªç¯æ‰€æœ‰çš„è§£æå™¨ï¼Œæå–è§£æäº‹åŠ¡æ³¨è§£ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥çœ‹ **SpringTransactionAnnotationParser** é‡Œé¢çš„é€»è¾‘ã€‚â€‹ 1234567891011121314@Override@Nullablepublic TransactionAttribute parseTransactionAnnotation(AnnotatedElement element) &#123; //ä»ç±»æˆ–è€…æ–¹æ³•ä¸ŠæŸ¥æ‰¾@Transactionalè¿™ä¸ªæ³¨è§£ AnnotationAttributes attributes = AnnotatedElementUtils.findMergedAnnotationAttributes( element, Transactional.class, false, false); if (attributes != null) &#123; //è§£ææ³¨è§£é˜¶æ®µä¸ºäº‹åŠ¡å±æ€§TransactionAttribute return parseTransactionAnnotation(attributes); &#125; else &#123; return null; &#125;&#125; é¦–å…ˆæ˜¯ä»ç±»æˆ–è€…æ–¹æ³•ä¸ŠæŸ¥æ‰¾åˆ°æ³¨è§£ï¼Œç„¶åé€šè¿‡**parseTransactionAnnotation()**è§£ææ³¨è§£ä¸º**TransactionAttribute**ã€‚â€‹ 12345678910111213141516171819202122232425262728293031323334353637383940/** * è§£æäº‹åŠ¡æ³¨è§£ * @param attributes * @return */protected TransactionAttribute parseTransactionAnnotation(AnnotationAttributes attributes) &#123; RuleBasedTransactionAttribute rbta = new RuleBasedTransactionAttribute(); Propagation propagation = attributes.getEnum(&quot;propagation&quot;); rbta.setPropagationBehavior(propagation.value()); Isolation isolation = attributes.getEnum(&quot;isolation&quot;); rbta.setIsolationLevel(isolation.value()); rbta.setTimeout(attributes.getNumber(&quot;timeout&quot;).intValue()); String timeoutString = attributes.getString(&quot;timeoutString&quot;); Assert.isTrue(!StringUtils.hasText(timeoutString) || rbta.getTimeout() &lt; 0, &quot;Specify &#x27;timeout&#x27; or &#x27;timeoutString&#x27;, not both&quot;); rbta.setTimeoutString(timeoutString); rbta.setReadOnly(attributes.getBoolean(&quot;readOnly&quot;)); rbta.setQualifier(attributes.getString(&quot;value&quot;)); rbta.setLabels(Arrays.asList(attributes.getStringArray(&quot;label&quot;))); List&lt;RollbackRuleAttribute&gt; rollbackRules = new ArrayList&lt;&gt;(); for (Class&lt;?&gt; rbRule : attributes.getClassArray(&quot;rollbackFor&quot;)) &#123; rollbackRules.add(new RollbackRuleAttribute(rbRule)); &#125; for (String rbRule : attributes.getStringArray(&quot;rollbackForClassName&quot;)) &#123; rollbackRules.add(new RollbackRuleAttribute(rbRule)); &#125; for (Class&lt;?&gt; rbRule : attributes.getClassArray(&quot;noRollbackFor&quot;)) &#123; rollbackRules.add(new NoRollbackRuleAttribute(rbRule)); &#125; for (String rbRule : attributes.getStringArray(&quot;noRollbackForClassName&quot;)) &#123; rollbackRules.add(new NoRollbackRuleAttribute(rbRule)); &#125; rbta.setRollbackRules(rollbackRules); return rbta;&#125; è¿™é‡Œå°±æ˜¯å…·ä½“è§£æäº‹åŠ¡æ³¨è§£ä¿¡æ¯çš„é€»è¾‘ã€‚â€‹ é˜¶æ®µæ€§æ¢³ç†ä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘ä»¬åŒ¹é…åˆ°äº†äº‹åŠ¡ç›¸å…³çš„å¢å¼ºå™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å»ä¸ºå½“å‰åŠ äº†Transactionæ³¨è§£çš„beanåˆ›å»ºä»£ç†å¯¹è±¡ã€‚ è‡³æ­¤ï¼Œæˆ‘ä»¬åˆ†æå®Œäº†è§£æäº‹åŠ¡æ ‡ç­¾ï¼Œåˆ›å»ºæ‰“äº†Transactionæ³¨è§£çš„beanåˆ›å»ºä»£ç†å¯¹è±¡çš„æºç æµç¨‹åˆ†æï¼Œæ¥ä¸‹æ¥å°±æ˜¯åˆ†æï¼Œéœ€è¦è¢«äº‹åŠ¡å¢å¼ºçš„ç›®æ ‡æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œäº‹åŠ¡å¢å¼ºå™¨æ˜¯å¦‚ä½•å¯¹ç›®æ ‡æ–¹æ³•åŠ ä¸Šäº‹åŠ¡çš„ã€‚ â€‹","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[åä¸‰]Iocæ•´åˆAopåˆ›å»ºä»£ç†å¯¹è±¡","slug":"Spring/Spring[åä¸‰]Iocæ•´åˆAopåˆ›å»ºä»£ç†å¯¹è±¡","date":"2022-01-11T06:10:54.686Z","updated":"2022-01-11T06:17:27.836Z","comments":true,"path":"2022/01/11/Spring/Spring[åä¸‰]Iocæ•´åˆAopåˆ›å»ºä»£ç†å¯¹è±¡/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E5%8D%81%E4%B8%89]Ioc%E6%95%B4%E5%90%88Aop%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1/","excerpt":"","text":"ä¸´æ—¶è¡¥å……ä¸€ç¯‡å†…å®¹ï¼Œæ˜¨æ™šå¿½ç„¶çœ‹æºç å‘ç°å¿½ç•¥äº†è¿™Iocæ•´åˆAopåˆ›å»ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ï¼Œæœ¬ç¯‡æˆ‘ä»¬æ¥è¡¥å……ä¸€ä¸‹æ ¸å¿ƒçš„é€»è¾‘ã€‚ 1.è§£æxmlæ ‡ç­¾ä¹‹å‰æˆ‘ä»¬è¯´è¿‡äº†æ³¨è§£ç‰ˆå¼€å‘AOPåŠŸèƒ½ï¼Œå¦‚æœæ˜¯xmlç‰ˆçš„éœ€è¦åœ¨é…ç½®æ–‡ä»¶é…ç½®_**&lt;aop:aspectj-autoproxy /&gt;**_ã€‚â€‹ æˆ‘ä»¬å…ˆæ‰¾åˆ°è¿™ä¸ªæ ‡ç­¾çš„è§£æå™¨**AspectJAutoProxyBeanDefinitionParser**ã€‚â€‹ 123456789101112@Override@Nullable/** * @param element åŒ…è£… &lt;aop:aspectj-autoproxy /&gt;æ ‡ç­¾æ•°æ® * @param parserContext å®ƒæŒæœ‰ä¸€ä¸ª readerContext ï¼Œ readerContexté‡Œé¢ æœ‰æŒæœ‰ä¸€ä¸ª registry ï¼Œä¹Ÿå°±æ˜¯ bfã€‚ */public BeanDefinition parse(Element element, ParserContext parserContext) &#123; /*è§£ææ ‡ç­¾ï¼Œåˆ›å»ºä¸€ä¸ªè‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨*/ AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(parserContext, element); extendBeanDefinition(element, parserContext); return null;&#125; \u0000\u0000è¿™ä¸ªæ–¹æ³•å°±æ˜¯è§£ææ ‡ç­¾ï¼Œåˆ›å»ºæŠ½è±¡è‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨ï¼Œæ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œæ˜¯ä¸æ˜¯å’Œå‰é¢çš„æµç¨‹å¾ˆåƒï¼Ÿâ€‹ 12345678910public static void registerAspectJAnnotationAutoProxyCreatorIfNecessary( ParserContext parserContext, Element sourceElement) &#123; /*æ‹¿åˆ° bf ï¼Œ åŒ…è£…æ ‡ç­¾*/ BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary( parserContext.getRegistry(), parserContext.extractSource(sourceElement)); /*æ‰§è¡Œåˆ°è¿™é‡Œï¼Œspringå®¹å™¨ä¸­å·²ç»æœ‰äº†aopç›¸å…³çš„bdä¿¡æ¯ï¼Œæ¥ä¸‹æ¥çš„é€»è¾‘å±äºæ‰©å±• ã€‚ * è¿™é‡Œçš„ä¸»è¦é€»è¾‘å°±æ˜¯å¯¹aopæ ‡ç­¾ä¸Šå¯é…ç½®çš„å±æ€§è¿›è¡Œè§£æã€‚*/ useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement); registerComponentIfNecessary(beanDefinition, parserContext);&#125; å…ˆçœ‹ä¸€ä¸‹è§£ææ ‡ç­¾å±æ€§çš„é€»è¾‘**useClassProxyingIfNecessary()** &amp; **registerComponentIfNecessary()**ã€‚â€‹ 123456789101112131415private static void useClassProxyingIfNecessary(BeanDefinitionRegistry registry, @Nullable Element sourceElement) &#123; /*å±äºæ‰©å±•é€»è¾‘ï¼Œåˆ¤æ–­aopçš„æ ‡ç­¾ä¸Šæœ‰æ²¡æœ‰é…ç½®proxy-target-classå±æ€§ï¼Œè¿™ä¸ªå±æ€§é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¦‚æœå¼€å¯çš„è¯ï¼Œç›®æ ‡å¯¹è±¡ä¸ç®¡æœ‰æ²¡æœ‰å®ç°æ¥å£ï¼Œéƒ½ä¼šä½¿ç”¨cglibçš„ä»£ç†æ–¹å¼*/ if (sourceElement != null) &#123; boolean proxyTargetClass = Boolean.parseBoolean(sourceElement.getAttribute(PROXY_TARGET_CLASS_ATTRIBUTE)); if (proxyTargetClass) &#123; /*è¿™é‡Œçš„é€»è¾‘å°±æ˜¯å‡å¦‚ä½ é…ç½®äº†è¿™ä¸ªå±æ€§æ˜¯trueï¼Œå°±ä¼šæ‹¿åˆ°bdä¿¡æ¯ï¼Œå¾€bdä¿¡æ¯é‡Œé¢åœ¨æ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œè®¾ç½®æˆtrueã€‚*/ AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry); &#125; /*exposeProxyï¼šä¹Ÿæ˜¯å¯ä»¥åœ¨aopæ ‡ç­¾é…ç½®çš„å±æ€§ï¼Œå°±æ˜¯åˆ¤æ–­å½“å‰ä»£ç†å¯¹è±¡æ˜¯å¦è¦æš´éœ²åœ¨aopä¸Šä¸‹æ–‡ï¼Œæ–¹ä¾¿ä»£ç†å¯¹è±¡å†…éƒ¨çš„çœŸå®å¯¹è±¡æ‹¿åˆ°ä»£ç†å¯¹è±¡ã€‚*/ boolean exposeProxy = Boolean.parseBoolean(sourceElement.getAttribute(EXPOSE_PROXY_ATTRIBUTE)); if (exposeProxy) &#123; AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry); &#125; &#125;&#125; è¿™ä¸ªæ–¹æ³•ä¸»è¦å°±æ˜¯å†³å®šç”¨å“ªç§æ–¹å¼åˆ›å»ºä»£ç†å¯¹è±¡ã€‚â€‹ 123456private static void registerComponentIfNecessary(@Nullable BeanDefinition beanDefinition, ParserContext parserContext) &#123; if (beanDefinition != null) &#123; parserContext.registerComponent( new BeanComponentDefinition(beanDefinition, AopConfigUtils.AUTO_PROXY_CREATOR_BEAN_NAME)); &#125;&#125; è¿™ä¸ªå°±æ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯éœ€è¦å°†æŠ½è±¡è‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨æ³¨å†Œåˆ°è§£æå™¨çš„ä¸Šä¸‹æ–‡ã€‚â€‹ 2.æŠ½è±¡è‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨æˆ‘ä»¬æ¥ä¸‹æ¥å›å½’ä¸»çº¿ï¼Œæ¥çœ‹**AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary()**çš„é€»è¾‘ã€‚â€‹ 12345678910@Nullablepublic static BeanDefinition registerAspectJAnnotationAutoProxyCreatorIfNecessary( BeanDefinitionRegistry registry, @Nullable Object source) &#123; /* * å‚æ•°ä¸€ï¼šå›ºå®šç±»å‹ * å‚æ•°äºŒï¼šspringå®¹å™¨ * å‚æ•°ä¸‰ï¼šæ ‡ç­¾ * */ return registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source);&#125; å†å¾€ä¸‹è·Ÿâ€‹ 1234567891011121314151617181920212223242526@Nullableprivate static BeanDefinition registerOrEscalateApcAsRequired( Class&lt;?&gt; cls, BeanDefinitionRegistry registry, @Nullable Object source) &#123; Assert.notNull(registry, &quot;BeanDefinitionRegistry must not be null&quot;); /*åˆ¤æ–­å®¹å™¨é‡Œé¢æœ‰æ²¡æœ‰è¿™ä¸ªåå­—çš„beanï¼Œå¦‚æœæœ‰çš„è¯å°±æ‹¿å‡ºæ¥*/ if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123; BeanDefinition apcDefinition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME); if (!cls.getName().equals(apcDefinition.getBeanClassName())) &#123; int currentPriority = findPriorityForClass(apcDefinition.getBeanClassName()); int requiredPriority = findPriorityForClass(cls); if (currentPriority &lt; requiredPriority) &#123; apcDefinition.setBeanClassName(cls.getName()); &#125; &#125; return null; &#125; /*é€šå¸¸æƒ…å†µä¸‹ï¼Œå…¶å®èµ°ä¸åˆ°ä¸Šé¢çš„é€»è¾‘ï¼Œé™¤éè‡ªå·±æ‰‹å†™äº†aop*/ /*åˆ›å»ºä¸€ä¸ªbdï¼Œå¹¶ä¸”æ³¨å†Œåˆ°å®¹å™¨ä¸­*/ RootBeanDefinition beanDefinition = new RootBeanDefinition(cls); beanDefinition.setSource(source); beanDefinition.getPropertyValues().add(&quot;order&quot;, Ordered.HIGHEST_PRECEDENCE); beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE); registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition); return beanDefinition;&#125; è¿™é‡Œå°±æ˜¯ç»™å®¹å™¨ä¸­æ³¨å†Œäº†ä¸€ä¸ª**beanDefinition**ï¼Œè¿™ä¸ª**beanDefinition**å°±æ˜¯**AbstractAutoProxyCreator**ã€‚â€‹ å‰é¢åœ¨æ³¨è§£æµç¨‹é‡Œé¢æˆ‘ä»¬åˆ†æäº†ï¼ŒIocåœ¨é€šè¿‡**getBean()**åˆ›å»ºå•å®ä¾‹beanå¯¹è±¡çš„æ—¶å€™ï¼Œæ‰§è¡Œåˆ°**initializeBean()**çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œbeançš„åç½®å¤„ç†å™¨ï¼Œæˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹è¿™é‡Œçš„é€»è¾‘ã€‚â€‹ 12345678910111213141516171819202122232425262728293031/** åˆå§‹åŒ–ç»™å®šçš„ bean å®ä¾‹ï¼Œåº”ç”¨å·¥å‚å›è°ƒä»¥åŠ init æ–¹æ³•å’Œ bean åå¤„ç†å™¨ã€‚* ä»createBeanè°ƒç”¨ä¼ ç»Ÿå®šä¹‰çš„ beanï¼Œä»initializeBeanè°ƒç”¨ç°æœ‰ bean å®ä¾‹ã€‚* */protected Object initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) &#123; /*æ£€æŸ¥å½“å‰beanæ˜¯å¦å®ç°äº†awareæ¥å£ï¼Œå†å…·ä½“åˆ¤æ–­å®ç°çš„å“ªä¸ªawareæ¥å£ï¼Œåšä¸€äº›èµ‹èƒ½æ“ä½œã€‚*/ invokeAwareMethods(beanName, bean); Object wrappedBean = bean; if (mbd == null || !mbd.isSynthetic()) &#123; /*åˆå§‹åŒ–ä¹‹å‰ï¼Œåç½®å¤„ç†å™¨çš„è°ƒç”¨ç‚¹*/ wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); &#125; try &#123; /*æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•*/ invokeInitMethods(beanName, wrappedBean, mbd); &#125; catch (Throwable ex) &#123; throw new BeanCreationException( (mbd != null ? mbd.getResourceDescription() : null), beanName, &quot;Invocation of init method failed&quot;, ex); &#125; if (mbd == null || !mbd.isSynthetic()) &#123; /*åˆå§‹åŒ–åçš„åç½®å¤„ç†å™¨æ‰§è¡Œç‚¹*/ /*å…¸å‹åº”ç”¨ï¼šAOPçš„å…·ä½“å®ç°*/ wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); &#125; return wrappedBean;&#125; \u0000é€šå¸¸éƒ½æ˜¯åœ¨æ‰§è¡Œ**invokeInitMethods()**,ä¹‹åçš„åç½®å¤„ç†å™¨çš„afteræ–¹æ³•è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ã€‚â€‹ 1234567891011121314151617@Overridepublic Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException &#123; Object result = existingBean; for (BeanPostProcessor processor : getBeanPostProcessors()) &#123; Object current = processor.postProcessAfterInitialization(result, beanName); /*æ³¨æ„ï¼š * ä¸€æ—¦æŸä¸ªåç½®å¤„ç†å™¨è¿”å›çš„ç»“æœä¸ºç©º * å°±è¿”å›ä¸Šä¸€ä¸ªåç½®å¤„ç†å™¨çš„ç»“æœï¼Œåé¢çš„åç½®å¤„ç†å™¨æ–¹æ³•ä¸åœ¨æ‰§è¡Œ*/ if (current == null) &#123; return result; &#125; result = current; &#125; return result;&#125; è¿™é‡Œæ˜¯åå¤„ç†å™¨çš„é€»è¾‘ã€‚åœ¨è¿™é‡Œå°±ä¼šè°ƒç”¨åˆ°æˆ‘ä»¬å‰é¢æ³¨å†Œåˆ°å®¹å™¨ä¸­çš„**AbstractAutoProxyCreator**ã€‚â€‹ 1234567891011121314@Overridepublic Object postProcessAfterInitialization(@Nullable Object bean/*springå®¹å™¨å®Œå…¨åˆå§‹åŒ–å®Œæ¯•çš„å¯¹è±¡*/, String beanName/*beanåç§°*/) &#123; if (bean != null) &#123; /*è·å–ç¼“å­˜å»ºï¼šå¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯beanNameï¼Œå¦‚æœæ˜¯å·¥å‚beanå¯¹è±¡ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ &amp; */ Object cacheKey = getCacheKey(bean.getClass(), beanName); /*é˜²æ­¢é‡å¤ä»£ç†æŸä¸ªbeanå®ä¾‹*/ if (this.earlyProxyReferences.remove(cacheKey) != bean) &#123; /*åˆ¤æ–­æ˜¯å¦éœ€è¦åŒ…è£… AOPæ“ä½œçš„å…¥å£*/ return wrapIfNecessary(bean, beanName, cacheKey); &#125; &#125; return bean;&#125; æ„å»ºç¼“å­˜key åˆ¤æ–­å¦‚æœ**earlyProxyReferences**é‡Œé¢ç§»é™¤çš„å¯¹è±¡å’Œå½“å‰å®Œå…¨åˆå§‹åŒ–å¥½çš„å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªï¼Œè¯´æ˜ä»€ä¹ˆï¼Ÿè¯´æ˜æœ‰å…¶ä»–åœ°æ–¹é€šè¿‡**FactoryBean**çš„**getObject()**åˆ›å»ºäº†å½“å‰beançš„ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥éœ€è¦ç§»é™¤ã€‚ åˆ¤æ–­æ˜¯å¦éœ€è¦åŒ…è£…**wrapIfNecessary(bean, beanName, cacheKey)** â€‹ 3.earlyProxyReferencesæˆ‘ä»¬å…ˆæ¥åˆ†æä¸‹è¿™ä¸ªå±æ€§ 1private final Map&lt;Object, Object&gt; earlyProxyReferences = new ConcurrentHashMap&lt;&gt;(16); å‡è®¾Aï¼ŒBä¸¤ä¸ªç±»ç°åœ¨å‘ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼Œåˆ›å»ºAçš„æ—¶å€™å‘ç°éœ€è¦Bå¯¹è±¡ï¼Œç„¶åAä¼šæŠŠè‡ªå·±çš„ä»£ç†å¯¹è±¡æ”¾åˆ°ä¸‰çº§ç¼“å­˜ï¼Œç„¶åé€’å½’å»åˆ›å»ºBå¯¹è±¡ã€‚â€‹ 1addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)) å°±æ˜¯è¿™è¡Œä»£ç ï¼Œå‰é¢æˆ‘ä»¬æ˜¯æœ‰è®²è¿‡çš„ï¼Œç„¶åæˆ‘ä»¬ç»§ç»­å¾€ä¸‹è·Ÿã€‚â€‹ 1234567891011121314151617181920/** * è·å–æ—©æœŸbeanå®ä¾‹å¯¹è±¡çš„å¼•ç”¨ï¼Œç”¨æ¥è§£å†³å¾ªç¯ä¾èµ–ã€‚ * è¿™é‡Œè¯´æ˜äº†ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆæ˜¯ä¸‰çº§ç¼“å­˜ä¸æ˜¯äºŒçº§ç¼“å­˜ã€‚ * Obtain a reference for early access to the specified bean, * typically for the purpose of resolving a circular reference. * @param beanName the name of the bean (for error handling purposes) * @param mbd the merged bean definition for the bean * @param bean the raw bean instance * @return the object to expose as bean reference */protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) &#123; Object exposedObject = bean; if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123; for (SmartInstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().smartInstantiationAware) &#123; /*åˆ¤æ–­è¦è¿”å›çš„æ—©æœŸå•å®ä¾‹å¯¹è±¡æ˜¯å¦éœ€è¦å¢å¼ºï¼Œå¦‚æœéœ€è¦å¢å¼ºï¼Œå°±è¿›è¡ŒåŒ…è£…ï¼Œè¿”å›åŒ…è£…å¥½çš„å¯¹è±¡*/ exposedObject = bp.getEarlyBeanReference(exposedObject, beanName); &#125; &#125; return exposedObject;&#125; è¿™é‡Œé¢ä¼šéå†æ‰€æœ‰çš„**SmartInstantiationAwareBeanPostProcessor**ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¿”å›å¢å¼ºçš„å¯¹è±¡ã€‚â€‹ è€Œæˆ‘ä»¬çš„**AbstractAutoProxyCreator**æ°æ°å®ç°äº†**SmartInstantiationAwareBeanPostProcessor**ã€‚\u0000æ‰€ä»¥**getEarlyBeanReference()**ä¼šæ‰§è¡Œ**AbstractAutoProxyCreator**é‡Œé¢çš„ã€‚â€‹ 123456@Overridepublic Object getEarlyBeanReference(Object bean, String beanName) &#123; Object cacheKey = getCacheKey(bean.getClass(), beanName); this.earlyProxyReferences.put(cacheKey, bean); return wrapIfNecessary(bean, beanName, cacheKey);&#125; è¿™é‡Œä¼šæŠŠç›®æ ‡å¯¹è±¡æœ¬èº«Aæ”¾å…¥åˆ°ç¼“å­˜ä¸­ï¼Œè¿”å›Açš„æ—©æœŸä»£ç†å¯¹è±¡ã€‚â€‹ åœ¨æˆ‘ä»¬é€’å½’åˆ›å»ºBçš„çš„æ—¶å€™ï¼Œä¸ºBè¿›è¡Œå±æ€§èµ‹å€¼çš„æ—¶å€™ï¼Œå›å»ä»ç¼“å­˜æ‹¿Aã€‚â€‹ 1234567891011121314151617/*ä»ä¸€çº§ç¼“å­˜æ‹¿*/singletonObject = this.singletonObjects.get(beanName);if (singletonObject == null) &#123; /*ä»äºŒçº§ç¼“å­˜æ‹¿*/ singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null) &#123; /*ä»ä¸‰çº§ç¼“å­˜æ‹¿*/ ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); /*æ¡ä»¶æˆç«‹ï¼šè¯´æ˜ç¬¬ä¸‰çº§ç¼“å­˜æœ‰æ•°æ®ã€‚è¿™é‡Œå°±æ¶‰åŠåˆ°äº†ç¼“å­˜çš„å‡çº§ ï¼Œå¾ˆç®€å• ï¼Œä»ä¸‰çº§æŒªåˆ°äºŒçº§ ï¼Œå†åæ‰‹å¹²æ‰ä¸‰çº§çš„ã€‚*/ if (singletonFactory != null) &#123; singletonObject = singletonFactory.getObject(); this.earlySingletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); &#125; &#125;&#125; â€‹ è¿™é‡Œç¬¬äºŒæ¬¡è°ƒç”¨åˆ°äº†**singletonFactory.getObject()**ï¼Œï¼ˆæ­¤æ—¶æ˜¯Båˆ›å»ºè¿‡ç¨‹ä¸­è·å–Aï¼‰ï¼Œç„¶ååˆä¼šèµ°åˆ°**getEarlyBeanReference()**ã€‚â€‹ 123456@Overridepublic Object getEarlyBeanReference(Object bean, String beanName) &#123; Object cacheKey = getCacheKey(bean.getClass(), beanName); this.earlyProxyReferences.put(cacheKey, bean); return wrapIfNecessary(bean, beanName, cacheKey);&#125; è¿™ä¸ªæ—¶å€™ï¼Œä¼šå°†Açš„ä»£ç†å¯¹è±¡æ”¾åˆ°ç¼“å­˜ï¼Œè¿”å›Açš„ä»£ç†å¯¹è±¡ã€‚â€‹ æ‰€ä»¥å½“æˆ‘ä»¬é€’å½’åˆ›å»ºBåï¼Œå›å¤´ç”¨Bä¸ºAå±æ€§èµ‹å€¼ä¹‹åï¼Œæ‰§è¡ŒAçš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå°±ä¼šèµ°åˆ°æŠ½è±¡è‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨çš„åç½®å¤„ç†å™¨é€»è¾‘ï¼Œç„¶åå†æ¥çœ‹è¿™ä¸ªæ–¹æ³•â€‹ 1234567891011121314@Overridepublic Object postProcessAfterInitialization(@Nullable Object bean/*Açš„ä»£ç†å¯¹è±¡*/, String beanName/*beanåç§°*/) &#123; if (bean != null) &#123; /*è·å–ç¼“å­˜å»ºï¼šå¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯beanNameï¼Œå¦‚æœæ˜¯å·¥å‚beanå¯¹è±¡ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ &amp; */ Object cacheKey = getCacheKey(bean.getClass(), beanName); /*é˜²æ­¢é‡å¤ä»£ç†æŸä¸ªbeanå®ä¾‹*/ if (this.earlyProxyReferences.remove(cacheKey)/*Aæœ¬èº«*/ != bean) &#123; /*åˆ¤æ–­æ˜¯å¦éœ€è¦åŒ…è£… AOPæ“ä½œçš„å…¥å£*/ return wrapIfNecessary(bean, beanName, cacheKey); &#125; &#125; return bean;&#125; **earlyProxyReferences.remove(cacheKey) != bean**ï¼Œå› ä¸ºæ­¤æ—¶ç¼“å­˜é‡Œé¢çš„æ˜¯Açš„ä»£ç†å¯¹è±¡ï¼Œä¼ è¿›æ¥çš„ä¹Ÿæ˜¯Açš„ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥åˆ¤æ–­ç›¸ç­‰ï¼Œç›´æ¥è¿”å›ï¼Œä¸éœ€è¦å†æ¬¡åˆ›å»ºAçš„ä»£ç†å¯¹è±¡ã€‚â€‹ è‡³æ­¤ï¼Œè¿™é‡Œå°±è§£é‡Šæ¸…æ¥šäº†ã€‚â€‹ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä»£ç†å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ã€‚**wrapIfNecessary()**â€‹ 4.æ˜¯å¦éœ€è¦åˆ›å»ºä»£ç†å¯¹è±¡123456789101112131415161718192021222324252627282930313233343536373839404142protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123; /*æ¡ä»¶ä¸€èˆ¬ä¸æˆç«‹ï¼Œå› ä¸ºæ­£å¸¸æƒ…å†µä¸‹å¾ˆå°‘ä½¿ç”¨TargetSourceCreator å»åˆ›å»ºå¯¹è±¡ã€‚BeforeInstantiationé˜¶æ®µ*/ if (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123; return bean; &#125; /* * å¦‚æœå½“å‰beanå¯¹è±¡ä¸éœ€è¦å¢å¼ºå¤„ç† * åˆ¤æ–­æ˜¯åœ¨BeforeInstantiationé˜¶æ®µé˜¶æ®µåšçš„ */ if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123; return bean; &#125; /* * æ¡ä»¶ä¸€ï¼šåˆ¤æ–­å½“å‰beanç±»å‹æ˜¯å¦æ˜¯åŸºç¡€æ¡†æ¶ç±»å‹çš„å®ä¾‹ï¼Œä¸èƒ½è¢«å¢å¼º * æ¡ä»¶äºŒï¼šåˆ¤æ–­å½“å‰beannameæ˜¯å¦æ˜¯æ˜¯å¿½ç•¥çš„beanï¼Œä¸éœ€è¦è¢«å¢å¼º */ if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123; //è¿›å…¥è¿™é‡Œè¡¨ç¤ºä¸éœ€è¦å¢å¼º this.advisedBeans.put(cacheKey, Boolean.FALSE); //ç›´æ¥è¿”å›ä¸Šå±‚ return bean; &#125; //æŸ¥æ‰¾é€‚åˆå½“å‰ç±»çš„é€šçŸ¥ éå¸¸é‡è¦ ï¼ï¼ï¼ Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); //åˆ¤æ–­å½“å‰æŸ¥è¯¢å‡ºæ¥çš„é€šçŸ¥æ˜¯ä¸æ˜¯ç©ºï¼Œå¦‚æœä¸æ˜¯ç©ºï¼Œè¯´æ˜èµ°å¢å¼ºé€»è¾‘ if (specificInterceptors != DO_NOT_PROXY) &#123; //è®°å¾—æ”¾åœ¨ç¼“å­˜true this.advisedBeans.put(cacheKey, Boolean.TRUE); /*çœŸæ­£å»åˆ›å»ºä»£ç†å¯¹è±¡*/ Object proxy = createProxy( bean.getClass()/*ç›®æ ‡å¯¹è±¡*/, beanName/*beanName*/, specificInterceptors/*åŒ¹é…å½“å‰ç›®æ ‡å¯¹è±¡classçš„æ‹¦æˆªå™¨*/, new SingletonTargetSource(bean)/*æŠŠå½“å‰beanè¿›è¡Œäº†ä¸€ä¸ªå°è£…*/); //ä¿å­˜ä»£ç†å¯¹è±¡ç±»å‹ this.proxyTypes.put(cacheKey, proxy.getClass()); //è¿”å›ä»£ç†å¯¹è±¡ return proxy; &#125; //æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜æ²¡æŸ¥åˆ°è¿™ä¸ªç±»ç›¸å…³çš„é€šçŸ¥ï¼Œæ²¡æ³•å¢å¼ºï¼Œç›´æ¥è¿”å› this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean;&#125; â€‹ é€šè¿‡**getAdvicesAndAdvisorsForBean()**æŸ¥æ‰¾é€‚åˆå½“å‰ç±»çš„é€šçŸ¥ã€‚â€‹ ç„¶åé€šè¿‡**createProxy()**å»åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œæœ€ç»ˆè¿”å›ä»£ç†å¯¹è±¡ã€‚â€‹ 5.æŸ¥æ‰¾é€šçŸ¥12345678910111213@Override@Nullableprotected Object[] getAdvicesAndAdvisorsForBean( Class&lt;?&gt; beanClass, String beanName, @Nullable TargetSource targetSource) &#123; //æŸ¥è¯¢åˆé€‚å½“å‰ç±»å‹çš„é€šçŸ¥ List&lt;Advisor&gt; advisors = findEligibleAdvisors(beanClass, beanName); //é€šçŸ¥ä¸ºç©ºè¿”å›ç©º if (advisors.isEmpty()) &#123; return DO_NOT_PROXY; &#125; //å¦åˆ™è½¬æˆä¸€ä¸ªæ•°ç»„è¿”å› return advisors.toArray();&#125; ç»§ç»­å¾€ä¸‹çœ‹**findEligibleAdvisors()**ã€‚\u0000 123456789101112protected List&lt;Advisor&gt; findEligibleAdvisors(Class&lt;?&gt; beanClass, String beanName) &#123; /*è·å–åˆ°å½“å‰é¡¹ç›®é‡Œé¢æ‰€æœ‰å¯ä»¥ä½¿ç”¨çš„å¢å¼ºå™¨*/ List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors(); /*å°†ä¸Šä¸€æ­¥è·å–åˆ°çš„å…¨éƒ¨å¢å¼ºå™¨è¿›è¡Œè¿‡æ»¤ï¼Œç•™ä¸‹é€‚åˆå½“å‰ç±»çš„*/ List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName); /*åœ¨è¿™ä¸€æ­¥ï¼Œä¼šåœ¨indexä¸º0 çš„ä½ç½®æ·»åŠ ä¸€ä¸ªå¢å¼ºå™¨*/ extendAdvisors(eligibleAdvisors); if (!eligibleAdvisors.isEmpty()) &#123; eligibleAdvisors = sortAdvisors(eligibleAdvisors); &#125; return eligibleAdvisors;&#125; è·å–å…¨éƒ¨å¢å¼ºå™¨ï¼Œè¿‡æ»¤æ’åºï¼Œè¿”å›ã€‚â€‹ å…ˆçœ‹ä¸€ä¸‹å¦‚ä½•è·å–çš„ã€‚â€‹ 123456789protected List&lt;Advisor&gt; findCandidateAdvisors() &#123; Assert.state(this.advisorRetrievalHelper != null, &quot;No BeanFactoryAdvisorRetrievalHelper available&quot;); //æŸ¥è¯¢å‡ºæ¥é€šè¿‡ bean çš„æ–¹å¼é…ç½®çš„ å¢å¼ºå™¨ /* * advisorRetrievalHelper æ˜¯æ€ä¹ˆåˆå§‹åŒ–çš„ï¼Ÿ * è¿™ä¸ªç±»å®ç°äº† beanFactoryAwareæ¥å£ ï¼Œåœ¨åˆå§‹åŒ–beanFactoryçš„æ—¶å€™ï¼Œ åˆ›å»ºäº†ä¸€ä¸ª helper å¯¹è±¡ */ return this.advisorRetrievalHelper.findAdvisorBeans();&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public List&lt;Advisor&gt; findAdvisorBeans() &#123; // Determine list of advisor bean names, if not cached already. String[] advisorNames = this.cachedAdvisorBeanNames; if (advisorNames == null) &#123; //é€šè¿‡ bf æŸ¥è¯¢å‡ºæ¥ bd é…ç½®çš„ class æ˜¯ å¢å¼ºå™¨çš„ å­ç±» çš„beanName advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors( this.beanFactory, Advisor.class, true, false); this.cachedAdvisorBeanNames = advisorNames; &#125; //è¦æ˜¯æ²¡æ‹¿åˆ°ï¼Œå°±ç›´æ¥è¿”å›ï¼Œæ²¡å¿…è¦å¾€ä¸‹èµ°äº† if (advisorNames.length == 0) &#123; return new ArrayList&lt;&gt;(); &#125; List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;(); for (String name : advisorNames) &#123; //æ³¨æ„ï¼šå½“å‰çš„helperæ˜¯é€‚é…å™¨åŒ…è£…çš„ï¼ŒçœŸæ­£çš„é€»è¾‘åœ¨é€‚é…å™¨é‡Œé¢ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œé€‚é…å™¨é‡Œé¢çš„è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯è¿”å› true //è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯åˆ¤æ–­å½“å‰ç»™å®šåå­—çš„beanæ˜¯å¦åˆæ ¼ if (isEligibleBean(name)) &#123; //å½“å‰beanå¦‚æœæ˜¯åœ¨åˆ›å»ºä¸­çš„è¯ï¼Œé‚£å°±æ‰“å°ä¸ªæ—¥å¿—ï¼Œè®°å½•ä¸‹ if (this.beanFactory.isCurrentlyInCreation(name)) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Skipping currently created advisor &#x27;&quot; + name + &quot;&#x27;&quot;); &#125; &#125; else &#123; try &#123; //ä» bf æŸ¥è¯¢å‡ºæ¥ å½“å‰è¿™ä¸ªåå­—å’Œç±»å‹çš„å¢å¼ºå™¨å®ä¾‹åŠ å…¥åˆ°å¢å¼ºå™¨åˆ—è¡¨ä¸­ advisors.add(this.beanFactory.getBean(name, Advisor.class)); &#125; catch (BeanCreationException ex) &#123; Throwable rootCause = ex.getMostSpecificCause(); if (rootCause instanceof BeanCurrentlyInCreationException) &#123; BeanCreationException bce = (BeanCreationException) rootCause; String bceBeanName = bce.getBeanName(); if (bceBeanName != null &amp;&amp; this.beanFactory.isCurrentlyInCreation(bceBeanName)) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Skipping advisor &#x27;&quot; + name + &quot;&#x27; with dependency on currently created bean: &quot; + ex.getMessage()); &#125; // Ignore: indicates a reference back to the bean we&#x27;re trying to advise. // We want to find advisors other than the currently created bean itself. continue; &#125; &#125; throw ex; &#125; &#125; &#125; &#125; return advisors;&#125; å†çœ‹ä¸€ä¸‹å¦‚ä½•è¿‡æ»¤å‡ºå½“å‰ç±»éœ€è¦çš„å¢å¼ºå™¨çš„ã€‚â€‹ 123456789101112protected List&lt;Advisor&gt; findAdvisorsThatCanApply( List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; beanClass, String beanName) &#123; ProxyCreationContext.setCurrentProxiedBeanName(beanName); try &#123; /*æ ¸å¿ƒé€»è¾‘*/ return AopUtils.findAdvisorsThatCanApply(candidateAdvisors, beanClass); &#125; finally &#123; ProxyCreationContext.setCurrentProxiedBeanName(null); &#125;&#125; ç»§ç»­å¾€ä¸‹èµ° 12345678910111213141516171819202122232425262728public static List&lt;Advisor&gt; findAdvisorsThatCanApply(List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; clazz) &#123; /*å¦‚æœè¿™ä¸ªç±»å…¨éƒ¨å¯ç”¨çš„å¢å¼ºå™¨ä¸ºç©ºï¼Œç›´æ¥è¿”å›*/ if (candidateAdvisors.isEmpty()) &#123; return candidateAdvisors; &#125; //åŒ¹é…å½“å‰class çš„ advisor ä¿¡æ¯ List&lt;Advisor&gt; eligibleAdvisors = new ArrayList&lt;&gt;(); //ä¸è€ƒè™‘éŸ³é˜¶å¢å¼º for (Advisor candidate : candidateAdvisors) &#123; if (candidate instanceof IntroductionAdvisor &amp;&amp; canApply(candidate, clazz)) &#123; eligibleAdvisors.add(candidate); &#125; &#125; //å‡è®¾ å€¼ä¸ºfalse boolean hasIntroductions = !eligibleAdvisors.isEmpty(); for (Advisor candidate : candidateAdvisors) &#123; if (candidate instanceof IntroductionAdvisor) &#123; // already processed continue; &#125; //åˆ¤æ–­å½“å‰å¢å¼ºå™¨æ˜¯å¦åŒ¹é…class if (canApply(candidate, clazz, hasIntroductions)) &#123; eligibleAdvisors.add(candidate); &#125; &#125; //è¿”å›çš„éƒ½æ˜¯åŒ¹é…å½“å‰classçš„advisor return eligibleAdvisors;&#125; çœ‹ä¸€ä¸‹_**canApply()**_ã€‚â€‹ 123456789101112131415public static boolean canApply(Advisor advisor, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123; if (advisor instanceof IntroductionAdvisor) &#123; return ((IntroductionAdvisor) advisor).getClassFilter().matches(targetClass); &#125; //å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯èµ°è¿™é‡Œï¼Œå› ä¸ºåˆ›å»ºçš„å¢å¼ºå™¨æ˜¯ InstantiationModelAwarePointcutAdvisorImpl else if (advisor instanceof PointcutAdvisor) &#123; PointcutAdvisor pca = (PointcutAdvisor) advisor; //æ–¹æ³•é‡è½½ return canApply(pca.getPointcut(), targetClass, hasIntroductions); &#125; else &#123; // It doesn&#x27;t have a pointcut so we assume it applies. return true; &#125;&#125; \u0000æ–¹æ³•é‡è½½â€‹ 123456789101112131415161718192021222324252627282930313233343536373839404142/*åˆ¤æ–­å½“å‰åˆ‡ç‚¹æ˜¯å¦åŒ¹é…å½“å‰class*/public static boolean canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123; Assert.notNull(pc, &quot;Pointcut must not be null&quot;); //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰classå°±ä¸æ»¡è¶³åˆ‡ç‚¹çš„å®šä¹‰ ï¼Œç›´æ¥è¿”å›ï¼Œå› ä¸ºåé¢æ˜¯åˆ¤æ–­æ–¹æ³•åŒ¹é…çš„é€»è¾‘ï¼Œç›´æ¥è¿”å› if (!pc.getClassFilter().matches(targetClass)) &#123; return false; &#125; //è·å–æ–¹æ³•åŒ¹é…å™¨ MethodMatcher methodMatcher = pc.getMethodMatcher(); //å¦‚æœæ˜¯trueï¼Œç›´æ¥è¿”å›trueï¼Œå› ä¸ºtrueä¸åšåˆ¤æ–­ï¼Œç›´æ¥åŒ¹é…æ‰€æœ‰æ–¹æ³• if (methodMatcher == MethodMatcher.TRUE) &#123; // No need to iterate the methods if we&#x27;re matching any method anyway... return true; &#125; //skip IntroductionAwareMethodMatcher introductionAwareMethodMatcher = null; if (methodMatcher instanceof IntroductionAwareMethodMatcher) &#123; introductionAwareMethodMatcher = (IntroductionAwareMethodMatcher) methodMatcher; &#125; //ä¿å­˜å½“å‰ç›®æ ‡å¯¹è±¡clazz + ç›®æ ‡å¯¹è±¡ çˆ¶ç±» çˆ·çˆ·ç±» ... çš„æ¥å£ + è‡ªèº«å®ç°çš„æ¥å£ Set&lt;Class&lt;?&gt;&gt; classes = new LinkedHashSet&lt;&gt;(); //åˆ¤æ–­ç›®æ ‡å¯¹è±¡æ˜¯ä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œç¡®ä¿classeså†…å­˜å‚¨çš„æ•°æ®åŒ…æ‹¬ç›®æ ‡å¯¹è±¡çš„classï¼Œè€Œä¸æ˜¯ä»£ç†ç±»class if (!Proxy.isProxyClass(targetClass)) &#123; classes.add(ClassUtils.getUserClass(targetClass)); &#125; classes.addAll(ClassUtils.getAllInterfacesForClassAsSet(targetClass)); //éå†classesï¼Œè·å–å½“å‰classå®šä¹‰çš„methodï¼Œæ•´ä¸ªforå¾ªç¯ä¼šæ£€æŸ¥å½“å‰ç›®æ ‡clazz ä¸Šçº§æ¥å£çš„æ‰€æœ‰æ–¹æ³• //çœ‹çœ‹æ˜¯å¦ä¼šè¢«æ–¹æ³•åŒ¹é…å™¨åŒ¹é…ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ–¹æ³•åŒ¹é…æˆåŠŸï¼Œå°±è¯´æ˜ç›®æ ‡classéœ€è¦è¢«AOPä»£ç†å¢å¼º for (Class&lt;?&gt; clazz : classes) &#123; Method[] methods = ReflectionUtils.getAllDeclaredMethods(clazz); for (Method method : methods) &#123; if (introductionAwareMethodMatcher != null ? introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions) : methodMatcher.matches(method, targetClass)) &#123; return true; &#125; &#125; &#125; //æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜å½“å‰ç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½æ²¡æœ‰åŒ¹é…æˆåŠŸï¼Œå½“å‰ç±»ä¸éœ€è¦AOPçš„å¢å¼ºã€‚ return false;&#125; **matches()**ä¸Šä¸€ç¯‡å·²ç»åˆ†æè¿‡äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚â€‹ æŸ¥æ‰¾åˆ°åŒ¹é…å½“å‰ç±»çš„åˆ‡é¢ä»¥åï¼Œæˆ‘ä»¬å†çœ‹ä¸€çœ‹å¦‚ä½•åˆ›å»ºçš„ä»£ç†å¯¹è±¡ã€‚â€‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556protected Object createProxy(Class&lt;?&gt; beanClass, @Nullable String beanName, @Nullable Object[] specificInterceptors, TargetSource targetSource) &#123; /*ç±»å‹æ–­è¨€ï¼Œæˆç«‹*/ if (this.beanFactory instanceof ConfigurableListableBeanFactory) &#123; /*ç»™å½“å‰çš„bdæ·»åŠ äº†ä¸€ä¸ªå±æ€§*/ AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) this.beanFactory, beanName, beanClass); &#125; //åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡çš„å·¥å‚ï¼Œä»–å¿…é¡»æŒæœ‰åˆ›å»ºAOPä»£ç†classçš„ç”Ÿäº§èµ„æ–™ // 1. ç›®æ ‡å¯¹è±¡ //2. å¢å¼ºä¿¡æ¯ ProxyFactory proxyFactory = new ProxyFactory(); //ä»å½“å‰ç±»èµ‹å€¼ä¸€äº›ä¿¡æ¯åˆ°å·¥å‚ proxyFactory.copyFrom(this); //è¯´æ˜å’±ä»¬æœ‰ä½¿ç”¨ xml é…ç½®ä¿®æ”¹è¿‡ aop ProxyTargetClass if (proxyFactory.isProxyTargetClass()) &#123; // Explicit handling of JDK proxy targets (for introduction advice scenarios) if (Proxy.isProxyClass(beanClass)) &#123; // Must allow for introductions; can&#x27;t just set interfaces to the proxy&#x27;s interfaces only. for (Class&lt;?&gt; ifc : beanClass.getInterfaces()) &#123; proxyFactory.addInterface(ifc); &#125; &#125; &#125; else &#123; // No proxyTargetClass flag enforced, let&#x27;s apply our default checks... //å¦‚æœbdå®šä¹‰å†…æœ‰ preserverTargetClass = true ï¼Œé‚£ä¹ˆbdå¯¹åº”çš„classåˆ›å»ºä»£ç†å¯¹è±¡çš„æ—¶å€™ //ä½¿ç”¨cglibï¼Œå¦åˆ™è¿˜å¾—ç»§ç»­åˆ¤æ–­ï¼Œåˆ¤æ–­éœ€è¦ä»£ç†çš„æ¥å£ if (shouldProxyTargetClass(beanClass, beanName)) &#123; proxyFactory.setProxyTargetClass(true); &#125; else &#123; //è¯„ä¼°éœ€è¦ä»£ç†çš„æ¥å£ï¼Œåˆ¤æ–­ä½¿ç”¨ä»€ä¹ˆä»£ç† evaluateProxyInterfaces(beanClass, proxyFactory); &#125; &#125; //æ„å»ºåˆ‡é¢é›†åˆ Advisor[] advisors = buildAdvisors(beanName, specificInterceptors); proxyFactory.addAdvisors(advisors); proxyFactory.setTargetSource(targetSource); //æ‰©å±•ç‚¹ customizeProxyFactory(proxyFactory); proxyFactory.setFrozen(this.freezeProxy); if (advisorsPreFiltered()) &#123; //ä¼ é€’ç»™ä»£ç†å·¥å‚çš„è¿™äº›å¢å¼ºå™¨ä¿¡æ¯åšè¿‡åŸºç¡€åŒ¹é…ï¼Œä¹Ÿå°±æ˜¯classFilteråŒ¹é… proxyFactory.setPreFiltered(true); &#125; // ClassLoader classLoader = getProxyClassLoader(); if (classLoader instanceof SmartClassLoader &amp;&amp; classLoader != beanClass.getClassLoader()) &#123; classLoader = ((SmartClassLoader) classLoader).getOriginalClassLoader(); &#125; return proxyFactory.getProxy(classLoader);&#125; æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº†**proxyFactory.getProxy(classLoader)**ã€‚â€‹ è‡³æ­¤ï¼Œæ•´ä¸ªAOPçš„é€»è¾‘ç®—æ˜¯æ­£å¼å®Œæˆï¼Œä¸‹ä¸€ç¯‡æˆ‘å°†å¸¦é¢†å¤§å®¶ä¸€èµ·åˆ†æä¸‹äº‹åŠ¡çš„æºç ã€‚â€‹ â€‹","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[åäºŒ]Aopæºç åˆ†æ","slug":"Spring/Spring[åäºŒ]Aopæºç åˆ†æ","date":"2022-01-11T06:10:47.608Z","updated":"2022-01-11T06:17:03.028Z","comments":true,"path":"2022/01/11/Spring/Spring[åäºŒ]Aopæºç åˆ†æ/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E5%8D%81%E4%BA%8C]Aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","excerpt":"","text":"ä¸Šä¸€ç¯‡é€šè¿‡ç®€å•çš„åˆ†æï¼Œæˆ‘ä»¬å¤§æ¦‚æ¸…æ¥šäº†æ•´ä¸ªAOPä»£ç å®ç°çš„å¤§ä½“æµç¨‹ã€‚æœ¬ç¯‡æˆ‘ä»¬å°†ä»ä»£ç å…¥æ‰‹ï¼Œä¸€ç‚¹ç‚¹åˆ†è§£AOPçš„å®ç°ä»£ç ã€‚ 1.ä½¿ç”¨AOPçš„ä»£ç å…ˆçœ‹ä¸€æ®µä»£ç ï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨AOPçš„ã€‚â€‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677public class CodeMain &#123; public static void main(String[] args) &#123; //é»˜è®¤ä»£ç†æ‰€æœ‰æ–¹æ³• proxyAllMethods(); //å®šåˆ¶ä»£ç† //proxyMethod(); &#125; /** * é»˜è®¤æƒ…å†µã€‚ä»£ç†æ‰€æœ‰æ–¹æ³• */ private static void proxyAllMethods()&#123; //1.åˆ›å»ºè¢«ä»£ç†å¯¹è±¡ Tiger tiger = new Tiger(); //2.åˆ›å»ºspringä»£ç†å·¥å‚å¯¹è±¡ ProxyFactory //proxyFactory æ˜¯ config + factory çš„å­˜åœ¨ æŒæœ‰ aop æ“ä½œ çš„ æ‰€æœ‰çš„ç”Ÿäº§èµ„æ–™ ProxyFactory proxyFactory = new ProxyFactory(tiger); //3. æ·»åŠ æ‹¦æˆªå™¨ proxyFactory.addAdvice(new MethodInterceptor01()); proxyFactory.addAdvice(new MethodInterceptor02()); //4.è·å–ä»£ç†å¯¹è±¡ï¼Œåˆ†æå¦‚ä½•è·å–çš„ä»£ç†å¯¹è±¡ï¼Ÿ Animals proxy = (Animals) proxyFactory.getProxy(); proxy.eat(&quot;äºº&quot;); System.out.println(&quot;===================================&quot;); proxy.run(); &#125; /** * ä»£ç†æŒ‡å®šçš„æ–¹æ³• */ private static void proxyMethod()&#123; //1.åˆ›å»ºè¢«ä»£ç†å¯¹è±¡ Tiger tiger = new Tiger(); //2.åˆ›å»ºspringä»£ç†å·¥å‚å¯¹è±¡ ProxyFactory //proxyFactory æ˜¯ config + factory çš„å­˜åœ¨ æŒæœ‰ aop æ“ä½œ çš„ æ‰€æœ‰çš„ç”Ÿäº§èµ„æ–™ ProxyFactory proxyFactory = new ProxyFactory(tiger); //3.æ·»åŠ æ–¹æ³•æ‹¦æˆª MyPointCut pointCut = new MyPointCut(); proxyFactory.addAdvisor(new DefaultPointcutAdvisor(pointCut,new MethodInterceptor01())); proxyFactory.addAdvisor(new DefaultPointcutAdvisor(pointCut,new MethodInterceptor02())); //4.è·å–ä»£ç†å¯¹è±¡ åˆ†æå¦‚ä½•è·å¾—ä»£ç†å¯¹è±¡ Animals proxy = (Animals) proxyFactory.getProxy(); proxy.eat(&quot;äººè‚‰&quot;); System.out.println(&quot;===================================&quot;); proxy.run(); &#125; /** * æ–¹æ³•æ‹¦æˆªå™¨ */ private static class MethodInterceptor01 implements MethodInterceptor &#123; @Nullable @Override public Object invoke(@NonNull MethodInvocation invocation) throws Throwable&#123; System.out.println(&quot;method interceptor begin!----1&quot;); Object result = invocation.proceed(); System.out.println(&quot;method interceptor end!---4&quot;); return result; &#125; &#125; private static class MethodInterceptor02 implements MethodInterceptor &#123; @Nullable @Override public Object invoke(@NonNull MethodInvocation invocation) throws Throwable&#123; System.out.println(&quot;method interceptor begin!----2&quot;); Object result = invocation.proceed(); System.out.println(&quot;method interceptor end!----3&quot;); return result; &#125; &#125;&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445interface Animals&#123; void eat(String food); void run();&#125;class Tiger implements Animals&#123; @Override public void eat(String food) &#123; System.out.println(&quot;è€è™åƒ&quot;+food); &#125; @Override public void run() &#123; System.out.println(&quot;è·‘çš„è´¼å¿«ï¼&quot;); &#125;&#125;public class MyPointCut implements Pointcut &#123; @Override public ClassFilter getClassFilter() &#123; return clazz -&gt; true; &#125; @Override public MethodMatcher getMethodMatcher() &#123; return new MethodMatcher() &#123; @Override public boolean matches(Method method, Class&lt;?&gt; targetClass) &#123; return method.getName().equals(&quot;eat&quot;); &#125; @Override public boolean isRuntime() &#123; return false; &#125; @Override public boolean matches(Method method, Class&lt;?&gt; targetClass, Object... args) &#123; return false; &#125; &#125;; &#125;&#125; è¿™æ˜¯ä½¿ç”¨AOPçš„ä¸¤ç§æ–¹å¼ï¼Œé»˜è®¤æ˜¯ä»£ç†å…¨éƒ¨æ–¹æ³•ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ä»£ç†æŒ‡å®šçš„æ–¹æ³•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å¯¹æºç è¿›è¡Œåˆ†æã€‚â€‹ 2.æŠ“æ‰‹123456789101112131415private static void proxyAllMethods()&#123; //1.åˆ›å»ºè¢«ä»£ç†å¯¹è±¡ Tiger tiger = new Tiger(); //2.åˆ›å»ºspringä»£ç†å·¥å‚å¯¹è±¡ ProxyFactory //proxyFactory æ˜¯ config + factory çš„å­˜åœ¨ æŒæœ‰ aop æ“ä½œ çš„ æ‰€æœ‰çš„ç”Ÿäº§èµ„æ–™ ProxyFactory proxyFactory = new ProxyFactory(tiger); //3. æ·»åŠ æ‹¦æˆªå™¨ proxyFactory.addAdvice(new MethodInterceptor01()); proxyFactory.addAdvice(new MethodInterceptor02()); //4.è·å–ä»£ç†å¯¹è±¡ï¼Œåˆ†æå¦‚ä½•è·å–çš„ä»£ç†å¯¹è±¡ï¼Ÿ Animals proxy = (Animals) proxyFactory.getProxy(); proxy.eat(&quot;äºº&quot;); System.out.println(&quot;===================================&quot;); proxy.run();&#125; è¿™é‡Œé¢é¦–å…ˆé¦–å…ˆæ˜¯åˆ›å»ºäº†ä¸€ä¸ªä»£ç†å·¥å‚ï¼Œç„¶åç»™ä»£ç†å·¥å‚æ·»åŠ æ‹¦æˆªå™¨ï¼Œæœ€åé€šè¿‡ä»£ç†å·¥å‚æ¥è·å–ä»£ç†å¯¹è±¡ï¼Œæœ€åé€šè¿‡ä»£ç†å¯¹è±¡æ‰§è¡Œç›®æ ‡æ–¹æ³•ã€‚â€‹ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä»£ç†å·¥å‚ã€‚â€‹ 3.ä»£ç†å·¥å‚123456public ProxyFactory(Object target) &#123; //å°†ç›®æ ‡å¯¹è±¡å°è£…æˆä¸º SingletonTargetSource ä¿å­˜åˆ°çˆ¶ç±»å­—æ®µå†… setTarget(target); //è·å–ç›®æ ‡å¯¹è±¡class çš„æ‰€æœ‰æ¥å£ ï¼Œä¿å­˜åˆ°çˆ¶ç±»å­—æ®µå†… setInterfaces(ClassUtils.getAllInterfaces(target));&#125; åœ¨**ProxyFactory**çš„æ„é€ å™¨å†…å°†ç›®æ ‡å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡å®ç°çš„æ¥å£å°è£…åˆ°äº†çˆ¶ç±»çš„å­—æ®µé‡Œé¢ã€‚â€‹ ä¸Šå›¾æ˜¯**ProxyFactory**çš„ç»§æ‰¿å…³ç³»ï¼Œå¯ä»¥å…ˆç®€å•è¿‡ä¸€ä¸‹ï¼Œæœ‰ä¸€ä¸ªå°è±¡ã€‚â€‹ 4.æ·»åŠ åˆ‡é¢**proxyFactory.addAdvice(new MethodInterceptor01())**\u0000è¿™ä¸€è¡Œä»£ç æ˜¯å¾€ä»£ç†å·¥å‚æ·»åŠ æ‹¦æˆªå™¨/åˆ‡é¢ã€‚â€‹ çœ‹ä¸€ä¸‹æ·»åŠ çš„æµç¨‹â€‹ 12345@Overridepublic void addAdvice(Advice advice) throws AopConfigException &#123; int pos = this.advisors.size(); addAdvice(pos, advice);&#125; é¦–å…ˆæ˜¯è°ƒç”¨äº†**AdvisedSupport**ç±»çš„æ·»åŠ åˆ‡é¢æ–¹æ³•ã€‚â€‹ åœ¨æ·»åŠ åˆ‡é¢çš„æ–¹æ³•é‡Œè·å–äº†å½“å‰ç±»çš„å¢å¼ºå™¨ä¸ªæ•°ã€‚ç„¶åå’Œåˆ‡é¢ä¸€èµ·ä¼ é€’åˆ°é‡è½½çš„æ–¹æ³•é‡Œã€‚â€‹ 12345678910111213141516171819@Overridepublic void addAdvice(int pos, Advice advice) throws AopConfigException &#123; Assert.notNull(advice, &quot;Advice must not be null&quot;); //ä¸è€ƒè™‘ï¼Œå¼•ä»‹å¢å¼ºï¼Œå¾ˆå°‘ç”¨ if (advice instanceof IntroductionInfo) &#123; // We don&#x27;t need an IntroductionAdvisor for this kind of introduction: // It&#x27;s fully self-describing. addAdvisor(pos, new DefaultIntroductionAdvisor(advice, (IntroductionInfo) advice)); &#125; //ä¸è€ƒè™‘ï¼Œå¼•ä»‹å¢å¼ºï¼Œå¾ˆå°‘ç”¨ else if (advice instanceof DynamicIntroductionAdvice) &#123; // We need an IntroductionAdvisor for this kind of introduction. throw new AopConfigException(&quot;DynamicIntroductionAdvice may only be added as part of IntroductionAdvisor&quot;); &#125; else &#123; //springä¸­Adviceå¯¹åº”çš„æ¥å£å°±æ˜¯Advisorï¼ŒSpringä½¿ç”¨AdvisoråŒ…è£…ç€AOPçš„Adviceå®ä¾‹ addAdvisor(pos, new DefaultPointcutAdvisor(advice)); &#125;&#125; â€‹ ç„¶åè°ƒç”¨äº†**addAdvisor()**ï¼Œæ·»åŠ å¢å¼ºå™¨ã€‚â€‹ å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šåˆ‡ç‚¹ï¼Œæ‰€ä»¥åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„åˆ‡ç‚¹çš„å¢å¼ºå™¨**DefaultPointcutAdvisor**ã€‚â€‹ 123456789@Overridepublic void addAdvisor(int pos, Advisor advisor) throws AopConfigException &#123; //å¼•ä»‹ç›¸å…³çš„é€»è¾‘ï¼Œä¸è€ƒè™‘ if (advisor instanceof IntroductionAdvisor) &#123; validateIntroductionAdvisor((IntroductionAdvisor) advisor); &#125; //å§”æ´¾æ¨¡å¼ addAdvisorInternal(pos, advisor);&#125; â€‹ è¿™é‡Œé¢è°ƒç”¨äº†**addAdvisorInternal(pos, advisor)**ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚â€‹ 12345678910111213141516private void addAdvisorInternal(int pos, Advisor advisor) throws AopConfigException &#123; Assert.notNull(advisor, &quot;Advisor must not be null&quot;); //å¦‚æœå½“å‰AOPé…ç½®å·²ç»å†»ç»“äº†ï¼Œä¸èƒ½åœ¨æ·»åŠ åˆ‡é¢äº†ï¼Œæ·»åŠ çš„è¯ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ if (isFrozen()) &#123; throw new AopConfigException(&quot;Cannot add advisor: Configuration is frozen.&quot;); &#125; //å¦‚æœä¼ å…¥çš„åˆ‡é¢çš„ä½ç½®å¤§äºå½“å‰åˆ‡é¢çš„ä¸ªæ•°ï¼ŒæŠ›å¼‚å¸¸ï¼Œå› ä¸ºä½ç½®ä¸‹æ ‡é»˜è®¤ä»-1å¼€å§‹ã€‚ if (pos &gt; this.advisors.size()) &#123; throw new IllegalArgumentException( &quot;Illegal position &quot; + pos + &quot; in advisor list with size &quot; + this.advisors.size()); &#125; //æ·»åŠ å¢å¼ºå™¨ this.advisors.add(pos, advisor); //æ¸…ç†ç¼“å­˜ adviceChanged();&#125; è¿™é‡Œè¿›è¡Œä¸€äº›æ ¡éªŒé€»è¾‘ï¼Œç„¶åæ·»åŠ å¢å¼ºå™¨ï¼Œæ¸…ç†ç¼“å­˜ã€‚â€‹ 5.è·å–ä»£ç†å¯¹è±¡**proxyFactory.getProxy()**\u0000 1234567891011121314151617181920/** * æ ¹æ®å·¥å‚çš„è®¾ç½®åˆ›å»ºä»£ç†å¯¹è±¡ * å¯ä»¥åå¤çš„è°ƒç”¨ã€‚ * å¦‚æœæˆ‘ä»¬æ·»åŠ æˆ–è€…åˆ é™¤æ¥å£ï¼Œæ•ˆæœä¼šæœ‰æ‰€ä¸åŒï¼Œå¯ä»¥æ·»åŠ å’Œåˆ é™¤æ‹¦æˆªå™¨ã€‚ * ä½¿ç”¨é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼šé»˜è®¤æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆå¦‚æœéœ€è¦åˆ›å»ºä»£ç†ï¼‰ */public Object getProxy() &#123; /** * åˆ›å»ºAOP çš„ ä»£ç† ï¼Œé‚£ä¹ˆ AOP çš„ä»£ç†æ˜¯ä»€ä¹ˆ ï¼Ÿ * * AopProxy * * createAopProxy() ï¼šå»åˆ›å»ºä»£ç†å¯¹è±¡çš„é€»è¾‘ * getProxy()ï¼šè·å–åˆ›å»ºå¥½çš„ä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªå®ç°åˆ†åˆ«æ˜¯jdkçš„åŠ¨æ€ä»£ç†å’Œcglibçš„åŠ¨æ€ä»£ç†ã€‚ * CglibAopProxy * JdkDynamicAopProxy * */ return createAopProxy().getProxy();&#125; è¿™é‡Œé¢å…ˆæ˜¯åˆ©ç”¨**createAopProxy()**åˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œç„¶åé€šè¿‡**getProxy()**æ¥è·å–ä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚â€‹ æˆ‘ä»¬å…ˆæ¥åˆ†æ**createAopProxy()**ï¼Œçœ‹ä¸€çœ‹ä»£ç†å¯¹è±¡æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿâ€‹ 12345678910111213141516171819/** * å­ç±»åº”è¯¥è°ƒç”¨å®ƒæ¥è·å¾—ä¸€ä¸ªæ–°çš„ AOP ä»£ç†ã€‚ ä»–ä»¬ä¸åº”è¯¥åˆ›å»ºä¸€ä¸ªAOPä»£ç†thisä½œä¸ºå‚æ•°ã€‚ */protected final synchronized AopProxy createAopProxy() &#123; /** * activeå±æ€§å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œåœ¨åˆ›å»ºç¬¬ä¸€ä¸ªä»£ç†å¯¹è±¡çš„æ—¶å€™ï¼Œä¼šå°†ä»–è®¾ç½®ä¸ºtrueã€‚ */ if (!this.active) &#123; activate(); &#125; /** * åˆ†æä¸€ä¸‹ä¸‹é¢è¿™è¡Œä»£ç çš„æµç¨‹ï¼š * * 1. è·å–aopçš„ä»£ç†å·¥å‚ çœ‹ä¸€ä¸‹AopProxyFactory * 2. ä½¿ç”¨å·¥å‚åˆ›å»ºä¸€ä¸ªaopçš„ä»£ç† ,å¦‚ä½•åˆ›å»ºä»£ç†çš„ï¼Ÿ * */ return getAopProxyFactory().createAopProxy(this);&#125; å…ˆæ˜¯é€šè¿‡**getAopProxyFactory()**è·å–AOPçš„ä»£ç†å·¥å‚ï¼Œç„¶åé€šè¿‡**createAopProxy(this)**ä¼ å…¥å½“å‰ç±»æ¥è·å–ä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚â€‹ 123456789/** * è¿™ä¸ªç±»é‡Œé¢å·²ç»æŒæœ‰äº†ä¸€ä¸ªé»˜è®¤çš„aopçš„ä»£ç†å·¥å‚ * ctrl + h æŸ¥çœ‹å½“å‰ç±»çš„ç»§æ‰¿å…³ç³» * å½“å‰ç±»æ˜¯ ProxyFactoryçš„çˆ¶ç±»ï¼Œæ‰€ä»¥é‡Œé¢çš„ä»£ç†å·¥å‚ä¼šè¢«é»˜è®¤çš„åˆå§‹åŒ–åŠ è½½ * @return */public AopProxyFactory getAopProxyFactory() &#123; return this.aopProxyFactory;&#125; çœ‹ä¸€ä¸‹ä¸Šå›¾ç±»çš„ç»§æ‰¿å…³ç³»ï¼Œå…¶å®åœ¨åˆ›å»º**ProxyFactory**çš„æ—¶å€™ï¼Œéšå¼è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨çš„æ—¶å€™ï¼Œå°±å·²ç»åœ¨**ProxyCreatorSupport**é‡Œé¢åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„AOPä»£ç†å·¥å‚**DefaultAopProxyFactory**ã€‚â€‹ æ¥ä¸‹æ¥å†æ¥çœ‹å¦‚ä½•åˆ›å»ºä¸€ä¸ªAOPä»£ç†å¯¹è±¡çš„ã€‚â€‹ 123456789101112131415161718192021222324252627282930313233343536373839/** * @param config å°±æ˜¯æˆ‘ä»¬çš„ProxyFactoryå¯¹è±¡ï¼ŒProxyFactoryä»–æ˜¯ä¸€ä¸ªé…ç½®ç®¡ç†å¯¹è±¡ * ä¿å­˜ç€åˆ›å»ºä»£ç†å¯¹è±¡æ‰€æœ‰çš„ç”Ÿäº§èµ„æ–™ã€‚ * @return è¿”å›ä¸€ä¸ªAOPçš„ä»£ç†å¯¹è±¡ * @throws AopConfigException å¦‚æœæŸäº›ä¸æœŸæœ›æˆ‘ä»¬ä¿®æ”¹çš„é…ç½®è¢«ä¿®æ”¹ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ */@Overridepublic AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException &#123; /** * æ¡ä»¶ä¸€ï¼šæš‚ä¸”ä¸ç®¡ * æ¡ä»¶äºŒï¼štrue è¡¨ç¤ºå¼ºåˆ¶ä½¿ç”¨cglibä»£ç†ï¼Œ * æ¡ä»¶ä¸‰ï¼štrue è¡¨ç¤ºè¢«ä»£ç†å¯¹è±¡æ²¡æœ‰å®ç°ä»»ä½•æ¥å£æ²¡æœ‰åŠæ³•ä½¿ç”¨jdkçš„åŠ¨æ€ä»£ç†ï¼Œåªèƒ½ä½¿ç”¨cglibçš„åŠ¨æ€ä»£ç† */ if (!NativeDetector.inNativeImage() &amp;&amp; //è¯¥æ¡ä»¶ä¸éœ€è¦è€ƒè™‘ ( config.isOptimize() || //è®¾ç½®äº†è¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆå°±æ˜¯å¼ºåˆ¶ä½¿ç”¨cglibçš„åŠ¨æ€ä»£ç† config.isProxyTargetClass() || //è®¾ç½®äº†è¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆå°±æ˜¯å¼ºåˆ¶ä½¿ç”¨cglibçš„åŠ¨æ€ä»£ç† hasNoUserSuppliedProxyInterfaces(config) //åˆ¤æ–­è¢«ä»£ç†å¯¹è±¡æœ‰æ²¡æœ‰å®ç°æ¥å£ï¼Œæ²¡æœ‰å®ç°æ¥å£ï¼Œé‚£è¿˜ç”¨é”¤å­jdkçš„åŠ¨æ€ä»£ç† ) ) &#123; //èµ°åˆ°è¿™é‡Œçš„è¯ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå°±å·²ç»ä¼šä½¿ç”¨cglibçš„åŠ¨æ€ä»£ç† //è·å–ç›®æ ‡å¯¹è±¡çš„ç±»å‹ï¼Œä¸ºç©ºçš„è¯è‚¯å®šæ²¡æ³•ç»§ç»­å¾€ä¸‹èµ°äº†ï¼Œç›´æ¥å¼‚å¸¸ä¸­æ–­ Class&lt;?&gt; targetClass = config.getTargetClass(); if (targetClass == null) &#123; throw new AopConfigException(&quot;TargetSource cannot determine target class: Either an interface or a target is required for proxy creation.&quot;); &#125; //ç›®æ ‡å¯¹è±¡æ˜¯ä¸€ä¸ªæ¥å£ æˆ–è€… å·²ç»æ˜¯ä¸€ä¸ªè¢«ä»£ç†è¿‡å¾—ç±»å‹ï¼ˆæ­¤æ—¶æ˜¯å¤šé‡ä»£ç†ï¼‰ ï¼Œåªèƒ½ä½¿ç”¨jdkçš„åŠ¨æ€ä»£ç† if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123; return new JdkDynamicAopProxy(config); &#125; //èµ°cglibçš„åŠ¨æ€ä»£ç† return new ObjenesisCglibAopProxy(config); &#125; else &#123; //æ‰§è¡Œåˆ°è¿™é‡Œçš„æƒ…å†µ ï¼š å®ç°äº†æ¥å£,å¤§å¤šæ•°æƒ…å†µæˆ‘ä»¬éƒ½æ˜¯é¢å‘æ¥å£ç¼–ç¨‹ï¼Œèµ°è¿™é‡Œ return new JdkDynamicAopProxy(config); &#125;&#125; æ ¹æ®æ¡ä»¶åˆ¤æ–­æˆ‘ä»¬åˆ°åº•æ˜¯åˆ›å»ºJDKçš„ä»£ç†å¯¹è±¡è¿˜æ˜¯åˆ›å»ºCglibçš„ä»£ç†å¯¹è±¡ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ¡ˆä¾‹ä»£ç çš„ç›®æ ‡ç±»æ˜¯å®ç°äº†æ¥å£çš„ï¼Œæ‰€ä»¥é»˜è®¤ä¼šèµ°jdkçš„åŠ¨æ€ä»£ç†ã€‚â€‹ 6.JdkDynamicAopProxy1234567891011121314151617/** * ä½¿ç”¨ç»™å®šçš„é…ç½®ï¼Œé€šè¿‡æ„é€ å™¨åˆ›å»ºaop çš„åŠ¨jdkæ€ä»£ç†å¯¹è±¡ * è¿™é‡Œçš„configæ˜¯å•¥ï¼Ÿå°±æ˜¯æˆ‘ä»¬çš„ä»£ç†å·¥å‚å¯¹è±¡ */public JdkDynamicAopProxy(AdvisedSupport config) throws AopConfigException &#123; //éç©ºæ–­è¨€ Assert.notNull(config, &quot;AdvisedSupport must not be null&quot;); //å¦‚æœé…ç½®é‡Œé¢çš„åˆ‡é¢æ•°==0 &amp;&amp; é…ç½®é‡Œé¢çš„ç›®æ ‡å¯¹è±¡æ˜¯ç©ºå¯¹è±¡ï¼Œé‚£ä¹ˆä»£ç†æ— æ³•ç»§ç»­å¾€ä¸‹èµ°äº†ï¼Œç›´æ¥æŠ›å¼‚å¸¸ä¸­æ–­ if (config.getAdvisorCount() == 0 &amp;&amp; config.getTargetSource() == AdvisedSupport.EMPTY_TARGET_SOURCE) &#123; throw new AopConfigException(&quot;No advisors and no TargetSource specified&quot;); &#125; this.advised = config; //è·å–å½“å‰è¢«ä»£ç†å¯¹è±¡å®ç°çš„æ¥å£æ•°ç»„ ,å…·ä½“çš„å®ç°é€»è¾‘ï¼Ÿ this.proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(this.advised, true); //æŸ¥æ‰¾æ‰€æœ‰è¢«ä»£ç†çš„æ¥å£ï¼Œå¦‚æœæœ‰equals å’Œ hashcodeå°±æ‰“ä¸ªæ ‡ findDefinedEqualsAndHashCodeMethods(this.proxiedInterfaces);&#125; â€‹ åˆ¤æ–­å¦‚æœé…ç½®é‡Œé¢æ²¡æœ‰è¯¥è¢«ä»£ç†å¯¹è±¡çš„åˆ‡é¢ï¼Œæˆ–è€…è¢«ä»£ç†å¯¹è±¡æ˜¯ç©ºï¼Œé‚£å°±ä¸èƒ½å¾€ä¸‹èµ°äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚â€‹ è·å–å½“å‰è¢«ä»£ç†å¯¹è±¡å®ç°çš„æ¥å£æ•°ç»„**AopProxyUtils.completeProxiedInterfaces(this.advised, true)**ã€‚â€‹ æŸ¥æ‰¾æ‰€æœ‰è¢«ä»£ç†çš„æ¥å£ï¼Œå¦‚æœæœ‰equals å’Œ hashcodeå°±æ‰“ä¸ªæ ‡ã€‚â€‹ çœ‹ä¸€ä¸‹å¦‚ä½•è·å–åˆ°å½“å‰è¢«ä»£ç†å¯¹è±¡å®ç°çš„æ¥å£æ•°ç»„çš„ã€‚â€‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546/** * æ‹¿åˆ°è¢«ä»£ç†å¯¹è±¡çš„æ‰€æœ‰æ¥å£ */static Class&lt;?&gt;[] completeProxiedInterfaces(AdvisedSupport advised, boolean decoratingProxy) &#123; /*ä»proxyFactoryä¸­è·å–æ‰€æœ‰çš„targetæå–å‡ºæ¥çš„æ¥å£*/ Class&lt;?&gt;[] specifiedInterfaces = advised.getProxiedInterfaces(); /*å¦‚æœæ¥å£é•¿åº¦æ˜¯0*/ if (specifiedInterfaces.length == 0) &#123; //æ‹¿åˆ°ç›®æ ‡å¯¹è±¡çš„ç±»å‹ Class&lt;?&gt; targetClass = advised.getTargetClass(); //å¦‚æœç›®æ ‡å¯¹è±¡çš„ç±»å‹ä¸ä¸ºç©º if (targetClass != null) &#123; //å¦‚æœç›®æ ‡å¯¹è±¡æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå°±å°†ç›®æ ‡å¯¹è±¡è®¾ç½®åˆ°æ¥å£åˆ—è¡¨é‡Œé¢ if (targetClass.isInterface()) &#123; advised.setInterfaces(targetClass); &#125; //å¦‚æœç›®æ ‡å¯¹è±¡æ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œé‚£ä¹ˆä¹Ÿå°†ç›®æ ‡å¯¹è±¡è®¾ç½®åˆ°æ¥å£åˆ—è¡¨ else if (Proxy.isProxyClass(targetClass)) &#123; advised.setInterfaces(targetClass.getInterfaces()); &#125; specifiedInterfaces = advised.getProxiedInterfaces(); &#125; &#125; /*åˆ›å»ºä¸€ä¸ªæ–°çš„æ¥å£æ•°ç»„ï¼Œé•¿åº¦æ˜¯åŸæ¥å£æ•°é‡+springè¿½åŠ çš„ä¸‰ä¸ªæ¥å£æ•°é‡*/ List&lt;Class&lt;?&gt;&gt; proxiedInterfaces = new ArrayList&lt;&gt;(specifiedInterfaces.length + 3); for (Class&lt;?&gt; ifc : specifiedInterfaces) &#123; // åªæœ‰éå¯†å°æ¥å£å®é™…ä¸Šæœ‰èµ„æ ¼è¿›è¡ŒJDKä»£ç†(åœ¨JDK 17ä¸Š) if (!ifc.isSealed()) &#123; proxiedInterfaces.add(ifc); &#125; &#125; /*å¦‚æœè¿™ä¸ªæ¥å£é‡Œé¢æ²¡æœ‰SpringProxyè¿™ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå°±éœ€è¦æ·»åŠ ä¸€ä¸ªï¼Œæ‰“æ ‡ï¼Œæ ‡è¯†è¿™ä¸ªä»£ç†å¯¹è±¡æ˜¯Springåˆ›å»ºçš„*/ if (!advised.isInterfaceProxied(SpringProxy.class)) &#123; proxiedInterfaces.add(SpringProxy.class); &#125; /*åˆ¤æ–­ç›®æ ‡å¯¹è±¡çš„æ‰€æœ‰æ¥å£æ˜¯å¦æœ‰adviceæ¥å£ï¼Œæ²¡æœ‰å°±æ‰‹åŠ¨æ·»åŠ */ if (!advised.isOpaque() &amp;&amp; !advised.isInterfaceProxied(Advised.class)) &#123; proxiedInterfaces.add(Advised.class); &#125; //å¦‚æœç›®æ ‡å¯¹è±¡çš„æ‰€æœ‰æ¥å£é‡Œé¢ï¼Œæ²¡æœ‰DecoratingProxyçš„æ¥å£ï¼Œé‚£å°±æ·»åŠ ä¸€ä¸ª if (decoratingProxy &amp;&amp; !advised.isInterfaceProxied(DecoratingProxy.class)) &#123; proxiedInterfaces.add(DecoratingProxy.class); &#125; //è¿”å›æ¥å£ç±»å‹æ•°ç»„ return ClassUtils.toClassArray(proxiedInterfaces);&#125; æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹**getProxy(**)çš„é€»è¾‘ã€‚â€‹ 7.getProxy()12345@Overridepublic Object getProxy() &#123; //è¿™é‡Œå¦‚æœæ²¡æœ‰ä¼ ç±»åŠ è½½å™¨ï¼Œå°±ä½¿ç”¨é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œé»˜è®¤æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ return getProxy(ClassUtils.getDefaultClassLoader());&#125; æ–¹æ³•é‡è½½ï¼Œç»§ç»­å¾€ä¸‹èµ°ã€‚â€‹ 123456789@Overridepublic Object getProxy(@Nullable ClassLoader classLoader) &#123; //æ‰“å°æ—¥å¿—çš„é€»è¾‘ if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Creating JDK dynamic proxy: &quot; + this.advised.getTargetSource()); &#125; //é€šè¿‡jdkçš„åŠ¨æ€ä»£ç†æ¥åˆ›å»ºä»£ç†å¯¹è±¡ this == this::invoke è¯¥æ–¹æ³•æœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªä»£ç†ç±»å¯¹è±¡ return Proxy.newProxyInstance(classLoader, this.proxiedInterfaces, this);&#125; è¿™é‡Œé€šè¿‡JDKçš„åŠ¨æ€ä»£ç†æ¥åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä¸ºå•¥ä¼šä¼ å…¥å½“å‰ç±»**JdkDynamicAopProxy**ï¼Œå› ä¸ºå½“å‰ç±»å®ç°äº†**InvocationHandler**æ¥å£ã€‚â€‹ å› æ­¤ï¼Œå½“ä»£ç†å¯¹è±¡è°ƒç”¨ç›®æ ‡æ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œè¯¥ç±»çš„**invoke()**ã€‚â€‹ 8.ä»£ç†å¯¹è±¡æ‰§è¡Œç›®æ ‡æ–¹æ³•123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293@Override@Nullablepublic Object invoke(Object proxy/*ä»£ç†å¯¹è±¡*/, Method method/*ç›®æ ‡æ–¹æ³•*/, Object[] args/*ç›®æ ‡æ–¹æ³•å¯¹åº”çš„å‚æ•°*/) throws Throwable &#123; Object oldProxy = null; boolean setProxyContext = false; //advised è¿™é‡Œå®é™…ä¸Šå°±æ˜¯proxyFactoryçš„å¼•ç”¨ï¼ŒtargetSource å®é™…ä¸Šå°±æ˜¯ä¸Šå±‚ä¼ é€’å°è£…çš„targetsource TargetSource targetSource = this.advised.targetSource; Object target = null; try &#123; /*å¦‚æœä»£ç†ç±»å®ç°çš„æ¥å£é‡Œé¢æœ‰equalsæ–¹æ³•ï¼Œå°±ä½¿ç”¨é‡Œé¢çš„ï¼Œå¦åˆ™ä½¿ç”¨jdkæä¾›çš„equalsæ–¹æ³•*/ if (!this.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) &#123; return equals(args[0]); &#125; //å¦‚æœä»£ç†ç±»å®ç°çš„æ¥å£é‡Œé¢æä¾›äº†hashcodeæ–¹æ³•ï¼Œå°±æ˜¯ç”¨é‡Œé¢çš„ï¼Œå¦åˆ™ç”¨jdkçš„ else if (!this.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method)) &#123; return hashCode(); &#125; /*æš‚æ—¶å°šæœªç”¨åˆ°ï¼ŒTODO*/ else if (method.getDeclaringClass() == DecoratingProxy.class) &#123; return AopProxyUtils.ultimateTargetClass(this.advised); &#125; else if (!this.advised.opaque &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp; method.getDeclaringClass().isAssignableFrom(Advised.class)) &#123; return AopUtils.invokeJoinpointUsingReflection(this.advised, method, args); &#125; //è¿”å›å€¼ Object retVal; /** * æ˜¯å¦éœ€è¦å°†å½“å‰çš„ä»£ç†å¯¹è±¡è®¾ç½®åœ¨aopä¸Šä¸‹æ–‡ä¸­ * aopä¸Šä¸‹æ–‡å¯¹è±¡å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªthreadLocal * ä¸ºä»€ä¹ˆè¦å¼•å…¥ä¸€ä¸ªaopä¸Šä¸‹æ–‡ï¼Ÿ * ç›®æ ‡å¯¹è±¡A B * é€šè¿‡ä»£ç†çš„æ–¹å¼è°ƒç”¨A.eat() * è¿™ä¸ªeatæ–¹æ³•é‡Œé¢æœ‰æ°æ°è°ƒç”¨åˆ°äº†Bçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™Bå¯¹è±¡å®é™…ä¸Šå¹¶ä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥ * bçš„æ–¹æ³•æ‰§è¡Œå‰åå¹¶ä¸ä¼šè¢«å¢å¼ºï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±å¼•å…¥äº†aopçš„ä¸Šä¸‹æ–‡ */ if (this.advised.exposeProxy) &#123; // å°†å½“å‰ä»£ç†å¯¹è±¡è®¾ç½®åˆ°aopä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶è¿”å›è€çš„ä»£ç†å¯¹è±¡ oldProxy = AopContext.setCurrentProxy(proxy); setProxyContext = true; &#125; /*æ ¹æ®targetSourceæ‹¿åˆ°ç›®æ ‡å¯¹è±¡*/ target = targetSource.getTarget(); /*æ ¹æ®ç›®æ ‡å¯¹è±¡æ‹¿åˆ°ç›®æ ‡å¯¹è±¡çš„ç±»å‹*/ Class&lt;?&gt; targetClass = (target != null ? target.getClass() : null); // è¿™é‡Œæ˜¯æœ€å…³é”®çš„åœ°æ–¹ï¼ŒæŸ¥æ‰¾é€‚åˆè¯¥æ–¹æ³•çš„å¢å¼º å…·ä½“æ˜¯å¦‚ä½•æŸ¥æ‰¾çš„ï¼Ÿ List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass); /*æŸ¥è¯¢å‡ºåŒ¹é…å½“å‰æ–¹æ³•æ‹¦æˆªå™¨çš„æ•°é‡æ˜¯0 è¯´æ˜å½“å‰æ–¹æ³•ä¸éœ€è¦è¢«å¢å¼ºï¼Œç›´æ¥é€šè¿‡åå°„è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•ã€‚*/ if (chain.isEmpty()) &#123; Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args); /*è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•*/ retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse); &#125; else &#123; /*è¯´æ˜æœ‰åŒ¹é…å½“å‰methodçš„æ–¹æ³•æ‹¦æˆªå™¨ï¼Œè¯´æ˜è¦åšå¢å¼ºå¤„ç† */ MethodInvocation invocation = new ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain); /*æ ¸å¿ƒé©±åŠ¨é€»è¾‘åœ¨ReflectiveMethodInvocation*/ retVal = invocation.proceed(); &#125; /*è·å–æ–¹æ³•çš„è¿”å›å€¼ç±»å‹*/ Class&lt;?&gt; returnType = method.getReturnType(); /*å¦‚æœç›®æ ‡æ–¹æ³•è¿”å›ç›®æ ‡å¯¹è±¡ ï¼Œåšä¸€ä¸ªæ›¿æ¢ ï¼Œè¿”å›ä»£ç†å¯¹è±¡*/ if (retVal != null &amp;&amp; retVal == target &amp;&amp; returnType != Object.class &amp;&amp; returnType.isInstance(proxy) &amp;&amp; !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) &#123; retVal = proxy; &#125; //æ–¹æ³•æ˜¯voidç±»å‹ï¼Œä½†æ˜¯è¿”å›å€¼ç±»å‹è¿˜ä¸ä¸ºç©ºï¼Œè¯´æ˜æœ‰é—®é¢˜ï¼ŒæŠ›å¼‚å¸¸ else if (retVal == null &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) &#123; throw new AopInvocationException( &quot;Null return value from advice does not match primitive return type for: &quot; + method); &#125; return retVal; &#125; finally &#123; if (target != null &amp;&amp; !targetSource.isStatic()) &#123; // Must have come from TargetSource. targetSource.releaseTarget(target); &#125; if (setProxyContext) &#123; // å°†ä¸Šæ¬¡è®¾ç½®çš„proxyåœ¨æ­¤è®¾ç½®å›å»åˆ°aopä¸Šä¸‹æ–‡å†… //å› ä¸ºå½“å‰ä»£ç†å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•å·²ç»å®Œæˆäº†ï¼Œéœ€è¦å›åˆ°ä¸Šä¸€å±‚é€»è¾‘ //å±äºæ¢å¤ç°åœºçš„é€»è¾‘ AopContext.setCurrentProxy(oldProxy); &#125; &#125;&#125; \u0000\u0000æŠ›å¼€ä¸€åˆ‡ä¸æ˜¯å¾ˆé‡è¦çš„é€»è¾‘â€‹ åˆ¤æ–­å½“å‰ä»£ç†å¯¹è±¡æ˜¯å¦åº”è¯¥æš´éœ²å‡ºå»ï¼Œaopä¸Šä¸‹æ–‡**AopContext**å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªThreadLocalã€‚â€‹ ä¸ºä»€ä¹ˆè¦å¼•å…¥AOPçš„ä¸Šä¸‹æ–‡ï¼Ÿâ€‹ å‡è®¾æœ‰ç›®æ ‡å¯¹è±¡A,Bã€‚â€‹ é€šè¿‡ä»£ç†çš„æ–¹å¼è°ƒç”¨A.eat()ã€‚â€‹ è¿™ä¸ªeat()æ–¹æ³•é‡Œé¢æ°æ°è°ƒç”¨äº†Bçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™å¯¹è±¡å®é™…ä¸Šå¹¶ä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥Bçš„æ–¹æ³•æ‰§è¡Œå‰åå¹¶ä¸ä¼šè¢«å¢å¼ºï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±å¼•å…¥äº†AOPä¸Šä¸‹æ–‡ã€‚â€‹ é€šè¿‡**getInterceptorsAndDynamicInterceptionAdvice()**æŸ¥æ‰¾åˆ°å½“å‰æ–¹æ³•æ‰§è¡Œå‰åéœ€è¦æ‰§è¡Œçš„å¢å¼ºå™¨ã€‚\u0000å¦‚æœå½“å‰æ–¹æ³•åŒ¹é…çš„å¢å¼ºå™¨æ•°é‡æ˜¯0ï¼Œé‚£ä¹ˆç›´æ¥é€šè¿‡åå°„è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚â€‹ å¦åˆ™è¯´æ˜æœ‰åŒ¹é…çš„å¢å¼ºå™¨ï¼Œéœ€è¦åšå¢å¼ºå¤„ç†ã€‚**retVal=ReflectiveMethodInvocation.proceed(ï¼‰**â€‹ retValå°±æ˜¯æ–¹æ³•çš„è¿”å›å€¼ã€‚â€‹ åˆ¤æ–­å¦‚æœæ–¹æ³•æœ€ç»ˆè¿”å›çš„ç›®æ ‡å¯¹è±¡ï¼Œé‚£å°±æ›¿æ¢æˆä»£ç†å¯¹è±¡ã€‚â€‹ åˆ¤æ–­å¦‚æœæ–¹æ³•æ˜¯voidç±»å‹ï¼Œä½†æ˜¯è¿”å›å€¼ç±»å‹è¿˜ä¸ä¸ºç©ºï¼Œè¯´æ˜æœ‰é—®é¢˜ï¼ŒæŠ›å¼‚å¸¸ã€‚â€‹ æœ€ç»ˆè¿”å›ç»“æœï¼Œå¹¶å°†AOPä¸Šä¸‹æ–‡çš„ä»£ç†å¯¹è±¡è¿˜åŸæˆé‡Œé¢åŸæœ‰çš„å¯¹è±¡ï¼Œå› ä¸ºå½“å‰ä»£ç†å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•å·²ç»å®Œæˆäº†ï¼Œéœ€è¦å›åˆ°ä¸Šä¸€å±‚é€»è¾‘ã€‚\u0000\u0000è‡³æ­¤ï¼ŒAOPæ•´ä¸ªæµç¨‹å°±åˆ†æå®Œäº†ï¼Œå‰©ä¸‹çš„ä¸€äº›æ ¸å¿ƒçš„ç»†èŠ‚ï¼šâ€‹ **getInterceptorsAndDynamicInterceptionAdvice()**æŸ¥æ‰¾åˆ°å½“å‰æ–¹æ³•æ‰§è¡Œå‰åéœ€è¦æ‰§è¡Œçš„å¢å¼ºå™¨ **retVal=ReflectiveMethodInvocation.proceed(ï¼‰**æ‰§è¡Œå¢å¼ºå™¨é€»è¾‘ â€‹ é€šè¿‡å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬å¤§ä½“ä¸Šäº†è§£äº†Springçš„Aopçš„æ‰§è¡Œæµç¨‹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨çœ‹ä¸€äº›æ ¸å¿ƒçš„ç»†èŠ‚ï¼Œå¦‚ä½•æŸ¥æ‰¾ç›®æ ‡æ–¹æ³•çš„å¢å¼ºå™¨ã€‚ 9.æŸ¥æ‰¾å¢å¼ºå™¨**List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);**\u0000 1234567891011121314151617public List&lt;Object&gt; getInterceptorsAndDynamicInterceptionAdvice(Method method, @Nullable Class&lt;?&gt; targetClass) &#123; //å…ˆå°è¯•ä»ç¼“å­˜æ‹¿ MethodCacheKey cacheKey = new MethodCacheKey(method); List&lt;Object&gt; cached = this.methodCache.get(cacheKey); /*å¦‚æœç¼“å­˜ä¸ºç©º*/ if (cached == null) &#123; /*é‚£å°±èµ°æŸ¥æ‰¾é€»è¾‘ï¼Œå¹¶åˆ·æ–°ç¼“å­˜ * advisorChainFactoryä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Ÿ * è¿™ä¸ªæ˜¯åœ¨proxyFactoryé‡Œé¢çš„ä¸€ä¸ªå˜é‡ï¼Œä»£ç†å·¥å‚åˆ›å»ºå‡ºæ¥ï¼Œä»–å°±åˆ›å»ºå‡ºæ¥äº† * */ cached = this.advisorChainFactory.getInterceptorsAndDynamicInterceptionAdvice( this, method, targetClass); this.methodCache.put(cacheKey, cached); &#125; /*æœ€ç»ˆè¿”å›æŸ¥æ‰¾åˆ°çš„å€¼*/ return cached;&#125; æŸ¥æ‰¾ç¼“å­˜ï¼Œå¦‚æœæ²¡å‘½ä¸­åˆ™å»æŸ¥æ‰¾å¹¶æ”¾å…¥ç¼“å­˜æ”¾å›ã€‚æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹æŸ¥æ‰¾é€»è¾‘**this.advisorChainFactory.getInterceptorsAndDynamicInterceptionAdvice()**ã€‚â€‹ è¿™ä¸ª**advisorChainFactory**æ˜¯ä»€ä¹ˆï¼Ÿçœ‹å½“å‰ç±»çš„å±æ€§**AdvisorChainFactory advisorChainFactory = new DefaultAdvisorChainFactory();** ä»è¿™é‡Œæˆ‘ä»¬å°±å®šä½åˆ°äº†çœ‹å“ªä¸ªæ–¹æ³•çš„é€»è¾‘\u0000 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879@Overridepublic List&lt;Object&gt; getInterceptorsAndDynamicInterceptionAdvice( Advised config/*ä»£ç†å·¥å‚*/, Method method/*ç›®æ ‡æ–¹æ³•*/, @Nullable Class&lt;?&gt; targetClass/*ç›®æ ‡å¯¹è±¡ç±»å‹*/) &#123; /** * è¿™ä¸ªæ¥å£æ˜¯åˆ‡é¢é€‚é…å™¨çš„æ³¨å†Œä¸­å¿ƒ * 1.å¯ä»¥æ³¨å†ŒAdvisorAdapter é€‚é…å™¨ç›®çš„ï¼šå°†éadvisorç±»å‹çš„å¢å¼ºåŒ…è£…æˆadvisor ï¼Œå°†advisorç±»å‹çš„å¢å¼ºæå–å‡ºæ¥å¯¹åº”çš„ æ–¹æ³•æ‹¦æˆªå™¨ * * */ AdvisorAdapterRegistry registry = GlobalAdvisorAdapterRegistry.getInstance(); /** * è·å–ä»£ç†å·¥å‚å†…éƒ¨æŒæœ‰çš„å¢å¼ºä¿¡æ¯ * 1. addAdvice * 2. addAdvisor * æœ€ç»ˆåœ¨ä»£ç†å·¥å‚ä¸­éƒ½ä¼šåŒ…è£…æˆ advisor * */ Advisor[] advisors = config.getAdvisors(); /*åˆ›å»ºä¸€ä¸ªæ‹¦æˆªå™¨åˆ—è¡¨ï¼Œé•¿åº¦å°±æ˜¯advisorçš„é•¿åº¦*/ List&lt;Object&gt; interceptorList = new ArrayList&lt;&gt;(advisors.length); /*çœŸå®çš„ç›®æ ‡å¯¹è±¡ç±»å‹*/ Class&lt;?&gt; actualClass = (targetClass != null ? targetClass : method.getDeclaringClass()); /*å¼•ä»‹å¢å¼ºç›¸å…³*/ Boolean hasIntroductions = null; for (Advisor advisor : advisors) &#123; /*åŒ…å«åˆ‡ç‚¹ä¿¡æ¯çš„å¢å¼ºï¼Œå†…éƒ¨é€»è¾‘å°±æ˜¯åšåŒ¹é…ç®—æ³•*/ if (advisor instanceof PointcutAdvisor) &#123; // è½¬æ¢æˆ PointcutAdvisor ç±»å‹ï¼Œå¯ä»¥è·å–åˆ°åˆ‡ç‚¹ä¿¡æ¯ PointcutAdvisor pointcutAdvisor = (PointcutAdvisor) advisor; /*æ¡ä»¶äºŒæˆç«‹ï¼Œè¯´æ˜å½“å‰è¢«ä»£ç†å¯¹è±¡çš„classåŒ¹é…å½“å‰advisoræˆåŠŸï¼Œå¯èƒ½è¢«advisorå¢å¼ºï¼Œå…·ä½“è¿˜è¦çœ‹æ–¹æ³•åŒ¹é…ã€‚ è¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸‹ Pointcut æºç */ if (config.isPreFiltered() || pointcutAdvisor.getPointcut().getClassFilter().matches(actualClass)) &#123; /*è·å–åˆ‡ç‚¹ä¿¡æ¯çš„æ–¹æ³•åŒ¹é…å™¨ï¼Œåšæ–¹æ³•çº§åˆ«çš„åŒ¹é…*/ MethodMatcher mm = pointcutAdvisor.getPointcut().getMethodMatcher(); boolean match; /*å¼•ä»‹ç›¸å…³çš„ï¼Œä¸éœ€è¦è€ƒè™‘*/ if (mm instanceof IntroductionAwareMethodMatcher) &#123; if (hasIntroductions == null) &#123; hasIntroductions = hasMatchingIntroductions(advisors, actualClass); &#125; match = ((IntroductionAwareMethodMatcher) mm).matches(method, actualClass, hasIntroductions); &#125; else &#123; /*è¿›è¡Œæ–¹æ³•åŒ¹é… ç›®æ ‡æ–¹æ³•åŒ¹é…æˆåŠŸ ï¼Œ match = trueï¼Œå½“å‰çš„å¢å¼ºå™¨å¯ä»¥åº”ç”¨åˆ°method*/ match = mm.matches(method, actualClass); &#125; /*åˆ¤æ–­æ˜¯å¦è¿˜éœ€è¦è¿è¡Œæ—¶çš„åŒ¹é…*/ if (match) &#123; /*æå–å‡ºadvisorç±»æŒæœ‰çš„æ‹¦æˆªå™¨ä¿¡æ¯ registryé‡Œé¢åŒ…å«ä¸‰ä¸ªé»˜è®¤çš„å¢å¼ºå™¨*/ MethodInterceptor[] interceptors = registry.getInterceptors(advisor); if (mm.isRuntime()) &#123; /*å¦‚æœæ˜¯è¿è¡Œæ—¶åŒ¹é…ï¼Œé‚£å°±èµ°è¿è¡Œæ—¶åŒ¹é…çš„é€»è¾‘*/ for (MethodInterceptor interceptor : interceptors) &#123; interceptorList.add(new InterceptorAndDynamicMethodMatcher(interceptor, mm)); &#125; &#125; else &#123; /*å°†æ–¹æ³•æ‹¦æˆªå™¨è¿½åŠ åˆ°æ‹¦æˆªå™¨åˆ—è¡¨é‡Œé¢å»*/ interceptorList.addAll(Arrays.asList(interceptors)); &#125; &#125; &#125; &#125; /*ä¸è€ƒè™‘å¼•ä»‹ï¼Œæ‰€ä»¥ç›´æ¥è·³è¿‡*/ else if (advisor instanceof IntroductionAdvisor) &#123; IntroductionAdvisor ia = (IntroductionAdvisor) advisor; if (config.isPreFiltered() || ia.getClassFilter().matches(actualClass)) &#123; Interceptor[] interceptors = registry.getInterceptors(advisor); interceptorList.addAll(Arrays.asList(interceptors)); &#125; &#125; /*é€‚é…æ‰€æœ‰æ–¹æ³•çš„*/ else &#123; Interceptor[] interceptors = registry.getInterceptors(advisor); interceptorList.addAll(Arrays.asList(interceptors)); &#125; &#125; /*è¿”å›æ‰€æœ‰åŒ¹é…å½“å‰æ–¹æ³•çš„æ‹¦æˆªå™¨*/ return interceptorList;&#125; æ–¹æ³•æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬æŒ‘é‡ç‚¹æ…¢æ…¢åˆ†æã€‚â€‹ é¦–å…ˆè·å–åˆ°åˆ‡é¢é€‚é…å™¨çš„æ³¨å†Œä¸­å¿ƒï¼Œåˆ‡é¢é€‚é…å™¨**AdvisorAdapter**æ˜¯åšä»€ä¹ˆçš„ï¼Ÿâ€‹ å°†éadvisorç±»å‹çš„å¢å¼ºåŒ…è£…æˆadvisor ï¼Œå°†advisorç±»å‹çš„å¢å¼ºæå–å‡ºæ¥å¯¹åº”çš„ æ–¹æ³•æ‹¦æˆªå™¨ã€‚â€‹ è·å–ä»£ç†å·¥å‚å†…éƒ¨æŒæœ‰çš„å¢å¼ºä¿¡æ¯â€‹ Advice Advisor æœ€ç»ˆåœ¨ä»£ç†å·¥å‚ä¸­éƒ½ä¼šè¢«åŒ…è£…æˆAdvisorã€‚â€‹ éå†æ‰€æœ‰çš„æ‹¦æˆªå™¨ï¼šâ€‹ å…ˆæ˜¯å¤„ç†åˆ‡ç‚¹ç±»å‹çš„å¢å¼ºå™¨ å…ˆå°†å¢å¼ºå™¨è½¬åŒ–æˆ**PointcutAdvisor**ç±»å‹ åˆ¤æ–­å¦‚æœå½“å‰è¢«ä»£ç†å¯¹è±¡çš„classåŒ¹é…å¢å¼ºå™¨æˆåŠŸï¼Œè¯´æ˜å¯èƒ½å¢å¼ºæˆåŠŸï¼Œè¿˜è¦çœ‹å…·ä½“çš„æ–¹æ³•åŒ¹é…ï¼Œè¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸‹**PointCut** æºç  è·å–åˆ‡ç‚¹ä¿¡æ¯çš„æ–¹æ³•åŒ¹é…å™¨ï¼Œå‡†å¤‡åšæ–¹æ³•çº§åˆ«çš„åŒ¹é… **match = mm.matches(method, actualClass)**è¿›è¡Œå…·ä½“çš„æ–¹æ³•åŒ¹é… åˆ¤æ–­æ˜¯å¦éœ€è¦è¿è¡Œæ—¶åŒ¹é… å¦‚æœéœ€è¦ï¼Œæå–å‡ºå¢å¼ºå™¨æŒæœ‰çš„æ‹¦æˆªå™¨ä¿¡æ¯(registryé‡Œé¢é»˜è®¤æŒæœ‰ä¸‰ä¸ªå¢å¼ºå™¨)ï¼Œèµ°è¿è¡Œæ—¶åŒ¹é…çš„é€»è¾‘ -&gt; å°†**InterceptorAndDynamicMethodMatcher**åŠ å…¥åˆ°æ‹¦æˆªå™¨åˆ—è¡¨ å¦‚æœä¸éœ€è¦ï¼Œå°†æ–¹æ³•æ‹¦æˆªå™¨æ·»åŠ åˆ°æ‹¦æˆªå™¨åˆ—è¡¨ å¤„ç†å¼•ä»‹ç±»å‹çš„å¢å¼ºå™¨ è¿™é‡Œçš„é€»è¾‘æˆ‘ä»¬ä¸éœ€è¦å…³æ³¨ å¤„ç†é€‚é…æ‰€æœ‰æ–¹æ³•çš„å¢å¼ºå™¨ ä»å¢å¼ºå™¨çš„é€‚é…ä¸­å¿ƒè·å–æ‰€æœ‰çš„æ‹¦æˆªå™¨ æœ€ç»ˆè¿”å›åŒ¹é…å½“å‰æ–¹æ³•çš„æ‰€æœ‰æ‹¦æˆªå™¨â€‹ 10.æ–¹æ³•åŒ¹é…è¿™é‡Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹å…·ä½“çš„æ–¹æ³•åŒ¹é…é€»è¾‘ã€‚â€‹ çœ‹ä¸€ä¸‹**AbstractRegexpMethodPointcut**ï¼Œè¯´å®è¯ï¼Œè¥å…»ä»·å€¼ä¸å¤§ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªè¡Œç¢ç£¨ã€‚ 123456789101112131415161718192021222324252627@Overridepublic boolean matches(Method method, Class&lt;?&gt; targetClass) &#123; return (matchesPattern(ClassUtils.getQualifiedMethodName(method, targetClass)) || (targetClass != method.getDeclaringClass() &amp;&amp; matchesPattern(ClassUtils.getQualifiedMethodName(method, method.getDeclaringClass()))));&#125;/** * Match the specified candidate against the configured patterns. * @param signatureString &quot;java.lang.Object.hashCode&quot; style signature * @return whether the candidate matches at least one of the specified patterns */protected boolean matchesPattern(String signatureString) &#123; for (int i = 0; i &lt; this.patterns.length; i++) &#123; boolean matched = matches(signatureString, i); if (matched) &#123; for (int j = 0; j &lt; this.excludedPatterns.length; j++) &#123; boolean excluded = matchesExclusion(signatureString, j); if (excluded) &#123; return false; &#125; &#125; return true; &#125; &#125; return false;&#125; 11.æ‹¦æˆªå™¨çš„æ ¸å¿ƒé©±åŠ¨è·å–åˆ°æ‰€æœ‰çš„åŒ¹é…å½“å‰æ–¹æ³•çš„æ‹¦æˆªå™¨åï¼Œæœ€ç»ˆæˆ‘ä»¬æ˜¯è¦é©±åŠ¨æ‰€æœ‰çš„æ‹¦æˆªå™¨å»æ‰§è¡Œï¼Œæ¥ä¸‹æ¥åˆ†æä¸‹æ‹¦æˆªå™¨çš„æ ¸å¿ƒé©±åŠ¨é€»è¾‘ã€‚**invocation.proceed()**ï¼Œæ ¸å¿ƒé€»è¾‘åœ¨**ReflectiveMethodInvocation**ä¸­ã€‚â€‹ 123456789101112131415161718192021222324252627282930@Override@Nullablepublic Object proceed() throws Throwable &#123; // å› ä¸ºä»-1å¼€å§‹ï¼Œå¦‚æœå½“å‰æ‹¦æˆªå™¨ä¸‹æ ‡ == æ‹¦æˆªå™¨æ•°é‡-1 ï¼Œè¯´æ˜æ‰€æœ‰æ–¹æ³•æ‹¦æˆªå™¨éƒ½æ‰§è¡Œè¿‡äº†ï¼Œæ¥ä¸‹æ¥éœ€è¦æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³• if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) &#123; /*è°ƒç”¨è¿æ¥ç‚¹*/ return invokeJoinpoint(); &#125; /*è·å–ä¸‹ä¸€ä¸ªæ–¹æ³•æ‹¦æˆªå™¨*/ Object interceptorOrInterceptionAdvice = this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex); /*åˆ¤æ–­æ˜¯å¦éœ€è¦è¿è¡Œæ—¶åŒ¹é…*/ if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) &#123; InterceptorAndDynamicMethodMatcher dm = (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice; Class&lt;?&gt; targetClass = (this.targetClass != null ? this.targetClass : this.method.getDeclaringClass()); if (dm.methodMatcher.matches(this.method, targetClass, this.arguments)) &#123; return dm.interceptor.invoke(this); &#125; else &#123; return proceed(); &#125; &#125; /*å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šèµ°åˆ°elseè¿™é‡Œé™æ€åŒ¹é…*/ else &#123; // è®©å½“å‰æ–¹æ³•æ‹¦æˆªå™¨æ‰§è¡Œinvokeå³å¯ ï¼Œå¹¶ä¸”å°†å½“å‰å¯¹è±¡ä¼ é€’è¿›å» return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this); &#125;&#125; åˆ¤æ–­æ˜¯å¦æ‰€æœ‰æ‹¦æˆªå™¨éƒ½æ‰§è¡Œå®Œäº†ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œæ‰§è¡Œç›®æ ‡æ–¹æ³•**invokeJoinpoint()**ã€‚â€‹ \u0000è·å–ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦åšè¿è¡Œæ—¶åŒ¹é…ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯èµ°é™æ€åŒ¹é…çš„é€»è¾‘ã€‚â€‹ è®©å½“å‰æ–¹æ³•æ‹¦æˆªå™¨æ‰§è¡Œ**invoke()**ã€‚â€‹ 12345678910@Override@Nullablepublic Object invoke(MethodInvocation mi) throws Throwable &#123; try &#123; return mi.proceed(); &#125; finally &#123; invokeAdviceMethod(getJoinPointMatch(), null, null); &#125;&#125; â€‹ é€šè¿‡è¿™æ ·ç±»ä¼¼é€’å½’çš„é“¾å¼è°ƒç”¨ï¼Œæ¯ä¸€ä¸ªæ‹¦æˆªå™¨ç­‰å¾…ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨æ‰§è¡Œå®Œæˆè¿”å›ä»¥ååœ¨æ‰§è¡Œï¼Œæ‹¦æˆªå™¨çš„æœºåˆ¶ä¿è¯äº†é€šçŸ¥æ–¹æ³•ä¸ç›®æ ‡æ–¹æ³•çš„æ‰§è¡Œé¡ºåºã€‚â€‹ å†æ¥çœ‹ä¸‹å¦‚ä½•è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚**invokeJoinpoint()**â€‹ 1234@Nullableprotected Object invokeJoinpoint() throws Throwable &#123; return AopUtils.invokeJoinpointUsingReflection(this.target, this.method, this.arguments);&#125; \u0000ç»§ç»­å¾€ä¸‹è¿½ã€‚â€‹ 12345678910111213141516171819202122@Nullablepublic static Object invokeJoinpointUsingReflection(@Nullable Object target, Method method, Object[] args) throws Throwable &#123; // Use reflection to invoke the method. try &#123; ReflectionUtils.makeAccessible(method); return method.invoke(target, args); &#125; catch (InvocationTargetException ex) &#123; // Invoked method threw a checked exception. // We must rethrow it. The client won&#x27;t see the interceptor. throw ex.getTargetException(); &#125; catch (IllegalArgumentException ex) &#123; throw new AopInvocationException(&quot;AOP configuration seems to be invalid: tried calling method [&quot; + method + &quot;] on target [&quot; + target + &quot;]&quot;, ex); &#125; catch (IllegalAccessException ex) &#123; throw new AopInvocationException(&quot;Could not access method [&quot; + method + &quot;]&quot;, ex); &#125;&#125; æœ€ç»ˆé€šè¿‡æš´åŠ›åå°„æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œã€‚â€‹ 12.åˆ‡ç‚¹è¡¨è¾¾å¼**PointCut**â€‹ 123456789101112131415161718192021222324public interface Pointcut &#123; /** * Return the ClassFilter for this pointcut. * @return the ClassFilter (never &#123;@code null&#125;) * * ç±»è¿‡æ»¤å™¨ï¼šåˆ¤æ–­æŸä¸ªç±»æ˜¯å¦ç¬¦åˆåˆ‡ç‚¹ä½ç½® */ ClassFilter getClassFilter(); /** * Return the MethodMatcher for this pointcut. * @return the MethodMatcher (never &#123;@code null&#125;) * æ–¹æ³•åŒ¹é…å™¨ï¼šåˆ¤æ–­ç±»ä¸­æŸä¸ªæ–¹æ³•æ˜¯å¦åŒ¹é…æ¡ä»¶ï¼ŒåŒ¹é…æ¡ä»¶çš„æ–¹æ³•æ‰ä¼šè¢«å¢å¼º */ MethodMatcher getMethodMatcher(); /** * Canonical Pointcut instance that always matches. */ Pointcut TRUE = TruePointcut.INSTANCE;&#125; å‰é¢æ¡ˆä¾‹ä»£ç ä¸­ï¼Œæœ‰ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±å®ç°çš„åˆ‡ç‚¹ï¼Œå¯ä»¥å›é¡¾ä¸€ä¸‹ã€‚ æœ€ç»ˆå›é¡¾ä¸‹å¼€å¤´çš„ä¸€å¼ å›¾ï¼Œæ˜ç¡®ä¸‹**Advised --æŒæœ‰--&gt; Advisor --æŒæœ‰--&gt; Advice --å­ç±»--&gt;Interceptor --å­ç±»--&gt;MethodInterceptor**å…³ç³»ï¼šâ€‹ è‡³æ­¤ï¼Œæ•´ä¸ªAOPçš„å…¨éƒ¨æµç¨‹å·²ç»æ¢³ç†æ¸…æ™°ã€‚ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°†å¼€å§‹åˆ†æSpringçš„äº‹åŠ¡ã€‚â€‹ â€‹","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[å]Aopçš„ä¸¤ç§å®ç°æ–¹å¼","slug":"Spring/Spring[å]Aopçš„ä¸¤ç§å®ç°æ–¹å¼","date":"2022-01-11T06:00:15.970Z","updated":"2022-01-11T06:08:00.592Z","comments":true,"path":"2022/01/11/Spring/Spring[å]Aopçš„ä¸¤ç§å®ç°æ–¹å¼/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E5%8D%81]Aop%E7%9A%84%E4%B8%A4%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/","excerpt":"","text":"æœ¬ç¯‡å¼€å§‹Aopçš„ç›¸å…³çš„å†…å®¹ï¼Œaopçš„åº•å±‚ä½¿ç”¨åˆ°äº†åŠ¨æ€ä»£ç†çš„ï¼Œæˆ‘ä»¬é’ˆå¯¹ä¸€ä¸ªæ–¹æ³•å¯ä»¥é…ç½®å¤šä¸ªåˆ‡é¢ï¼Œä¹Ÿå°±å®ç°äº†å¤šé‡ä»£ç†ã€‚æœ¬ç¯‡å…ˆä¸çœ‹æºç ï¼Œä»å¼€å‘è€…çš„è§’åº¦è§‚æœ›å¦‚ä½•å®ç°å¤šé‡ä»£ç†ã€‚ â€‹ ä¸€ï¼Œä»£ç†æ¨¡å¼ä»£ç†æ¨¡å¼çš„å®šä¹‰ï¼šç”±äºæŸäº›åŸå› éœ€è¦ç»™æŸå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶å¯¹è¯¥å¯¹è±¡çš„è®¿é—®ã€‚è¿™æ—¶ï¼Œè®¿é—®å¯¹è±¡ä¸é€‚åˆæˆ–è€…ä¸èƒ½ç›´æ¥å¼•ç”¨ç›®æ ‡å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡ä½œä¸ºè®¿é—®å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´çš„ä¸­ä»‹ã€‚ä»£ç†æ¨¡å¼çš„ç»“æ„æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯é€šè¿‡å®šä¹‰ä¸€ä¸ªç»§æ‰¿æŠ½è±¡ä¸»é¢˜çš„ä»£ç†æ¥åŒ…å«çœŸå®ä¸»é¢˜ï¼Œä»è€Œå®ç°å¯¹çœŸå®ä¸»é¢˜çš„è®¿é—®ã€‚ä»£ç†æ¨¡å¼çš„ä¸»è¦è§’è‰²å¦‚ä¸‹ã€‚ æŠ½è±¡ä¸»é¢˜ï¼ˆSubjectï¼‰ç±»ï¼šé€šè¿‡æ¥å£æˆ–æŠ½è±¡ç±»å£°æ˜çœŸå®ä¸»é¢˜å’Œä»£ç†å¯¹è±¡å®ç°çš„ä¸šåŠ¡æ–¹æ³•ã€‚ çœŸå®ä¸»é¢˜ï¼ˆReal Subjectï¼‰ç±»ï¼šå®ç°äº†æŠ½è±¡ä¸»é¢˜ä¸­çš„å…·ä½“ä¸šåŠ¡ï¼Œæ˜¯ä»£ç†å¯¹è±¡æ‰€ä»£è¡¨çš„çœŸå®å¯¹è±¡ï¼Œæ˜¯æœ€ç»ˆè¦å¼•ç”¨çš„å¯¹è±¡ã€‚ ä»£ç†ï¼ˆProxyï¼‰ç±»ï¼šæä¾›äº†ä¸çœŸå®ä¸»é¢˜ç›¸åŒçš„æ¥å£ï¼Œå…¶å†…éƒ¨å«æœ‰å¯¹çœŸå®ä¸»é¢˜çš„å¼•ç”¨ï¼Œå®ƒå¯ä»¥è®¿é—®ã€æ§åˆ¶æˆ–æ‰©å±•çœŸå®ä¸»é¢˜çš„åŠŸèƒ½ã€‚ åœ¨ä»£ç ä¸­ï¼Œä¸€èˆ¬ä»£ç†ä¼šè¢«ç†è§£ä¸ºä»£ç å¢å¼ºï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨åŸä»£ç é€»è¾‘å‰åå¢åŠ ä¸€äº›ä»£ç é€»è¾‘ï¼Œè€Œä½¿è°ƒç”¨è€…æ— æ„ŸçŸ¥ã€‚æ ¹æ®ä»£ç†çš„åˆ›å»ºæ—¶æœŸï¼Œä»£ç†æ¨¡å¼åˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ã€‚ é™æ€ï¼šç”±ç¨‹åºå‘˜åˆ›å»ºä»£ç†ç±»æˆ–ç‰¹å®šå·¥å…·è‡ªåŠ¨ç”Ÿæˆæºä»£ç å†å¯¹å…¶ç¼–è¯‘ï¼Œåœ¨ç¨‹åºè¿è¡Œå‰ä»£ç†ç±»çš„ .class æ–‡ä»¶å°±å·²ç»å­˜åœ¨äº†ã€‚ åŠ¨æ€ï¼šåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œè¿ç”¨åå°„æœºåˆ¶åŠ¨æ€åˆ›å»ºè€Œæˆã€‚ 1.JDKçš„åŠ¨æ€ä»£ç† åŠ¨æ€ä»£ç† ç‰¹ç‚¹ï¼šå­—èŠ‚ç éšç”¨éšä¿®æ”¹ï¼Œéšç”¨éšåŠ è½½ ä½œç”¨ï¼šåœ¨ä¸ä¿®æ”¹æºç çš„åŸºç¡€ä¸Šåœ¨è¿è¡Œæ—¶åŠ¨æ€çš„å¯¹æ–¹æ³•è¿›è¡Œå¢å¼º åˆ†ç±»ï¼š åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç† åŸºäºå­ç±»çš„åŠ¨æ€ä»£ç† åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç† æ¶‰åŠçš„ç±»ï¼šProxy æä¾›è€…ï¼šJDKå®˜æ–¹ å¦‚ä½•åˆ›å»ºä»£ç†å¯¹è±¡ ä½¿ç”¨Proxyç±»çš„**newProxyInstance()** åˆ›å»ºä»£ç†å¯¹è±¡çš„è¦æ±‚ è¢«ä»£ç†ç±»æœ€å°‘å®ç°ä¸€ä¸ªæ¥å£ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸èƒ½ä½¿ç”¨ **newProxyInstance()**çš„å‚æ•° ClassLoaderï¼šç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ä»£ç†å¯¹è±¡å­—èŠ‚ç æ–‡ä»¶ï¼›å’Œè¢«ä»£ç†å¯¹è±¡ä½¿ç”¨ç›¸åŒçš„ç±»åŠ è½½å™¨ã€‚ Class[]ï¼šå­—èŠ‚ç æ•°ç»„ï¼Œç”¨äºè®©ä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†å¯¹è±¡å®ç°ç›¸åŒæ–¹æ³•çš„ã€‚ InvocationHandlerï¼šç”¨äºæä¾›å¢å¼ºçš„ä»£ç ï¼Œä»–æ˜¯è®©æˆ‘ä»¬è‡ªå®šä¹‰å¦‚ä½•ä»£ç†ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯å†™ä¸€ä¸ªè¯¥æ¥å£çš„å®ç°ç±»ã€‚ ç®€å•çš„å®ç°12345678910111213141516171819202122232425262728293031323334353637public class Test1 &#123; @Test public void test1()&#123; //è¢«ä»£ç†ç±»å¯¹è±¡è¦å£°æ˜ä¸ºæœ€ç»ˆçš„ final Producer producer=new Producer(); //ä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†ç±»å¯¹è±¡è¦å®ç°åŒä¸€ä¸ªæ¥å£ IProducer proxyProducer = (IProducer) Proxy.newProxyInstance(producer.getClass().getClassLoader(), producer.getClass().getInterfaces(), new InvocationHandler() &#123; /** * ä½œç”¨ï¼šæ‰§è¡Œè¢«ä»£ç†å¯¹è±¡çš„ä»»ä½•æ¥å£æ–¹æ³•éƒ½ä¼šç»è¿‡è¯¥æ–¹æ³• * æ–¹æ³•å‚æ•°çš„å«ä¹‰ * @param proxy ä»£ç†å¯¹è±¡çš„å¼•ç”¨ * 1. å¯ä»¥ä½¿ç”¨åå°„è·å–ä»£ç†å¯¹è±¡çš„ä¿¡æ¯ï¼ˆä¹Ÿå°±æ˜¯proxy.getClass().getName()ã€‚ * 2. å¯ä»¥å°†ä»£ç†å¯¹è±¡è¿”å›ä»¥è¿›è¡Œè¿ç»­è°ƒç”¨ï¼Œè¿™å°±æ˜¯proxyå­˜åœ¨çš„ç›®çš„ï¼Œå› ä¸ºthiså¹¶ä¸æ˜¯ä»£ç†å¯¹è±¡ã€‚ * @param method å½“å‰æ‰§è¡Œçš„æ–¹æ³• * @param args å½“å‰æ‰§è¡Œæ–¹æ³•æ‰€éœ€çš„å‚æ•° * @return å’Œè¢«ä»£ç†å¯¹è±¡æ–¹æ³•ç›¸åŒçš„è¿”å›å€¼ * @throws Throwable */ public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; Object value=null; //è·å–æ–¹æ³•æ‰§è¡Œçš„å‚æ•° //åˆ¤æ–­å½“å‰æ–¹æ³•æ˜¯ä¸æ˜¯é”€å”® if (&quot;saleProduct&quot;.equals(method.getName()))&#123; Float money= (Float) args[0]; //ä¸¤ä¸ªå‚æ•°ï¼šè¢«ä»£ç†ç±»å¯¹è±¡ï¼Œæ–¹æ³•å¢å¼ºçš„å‚æ•° value=method.invoke(producer,money*0.8f); &#125; return value; &#125; &#125;); proxyProducer.saleProduct(10000f); &#125;&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243package com.es.java1;/** * ä¸€ä¸ªç”Ÿäº§è€… */public class Producer implements IProducer&#123; /** * é”€å”® * @param money */ public void saleProduct(float money)&#123; System.out.println(&quot;é”€å”®äº§å“ï¼Œå¹¶æ‹¿åˆ°é’±ï¼š&quot;+money); &#125; /** * å”®å * @param money */ public void afterService(float money)&#123; System.out.println(&quot;æä¾›å”®åæœåŠ¡ï¼Œå¹¶æ‹¿åˆ°é’±ï¼š&quot;+money); &#125;&#125;-------------------------------------------------------------------/** * å¯¹ç”Ÿäº§å‚å®¶è¦æ±‚çš„æ¥å£ */public interface IProducer &#123; /** * é”€å”® * @param money */ public void saleProduct(float money); /** * å”®å * @param money */ public void afterService(float money);&#125; 2.cglibåŠ¨æ€ä»£ç† åŸºäºå­ç±»çš„åŠ¨æ€ä»£ç† æ¶‰åŠçš„ç±»ï¼šEnhancer ï¼Œæä¾›è€…ï¼šç¬¬æ–¹cglibåº“ å¦‚ä½•åˆ›å»ºä»£ç†å¯¹è±¡ï¼š ä½¿ç”¨Enhancerç±»ä¸­çš„createæ–¹æ³• åˆ›å»ºä»£ç†å¯¹è±¡çš„è¦æ±‚ï¼š è¢«ä»£ç†ç±»æ˜¯æœ€ç»ˆç±» createæ–¹æ³•çš„å‚æ•°ï¼š Classï¼šå­—èŠ‚ç  ï¼šå®ƒæ˜¯ç”¨äºæŒ‡å®šè¢«ä»£ç†å¯¹è±¡çš„å­—èŠ‚ç ã€‚ Callbackï¼šç”¨äºæä¾›å¢å¼ºçš„ä»£ç  ï¼šå®ƒæ˜¯è®©æˆ‘ä»¬å†™å¦‚ä½•ä»£ç†ã€‚æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯äº›ä¸€ä¸ªè¯¥æ¥å£çš„å®ç°ç±»ã€‚ æˆ‘ä»¬ä¸€èˆ¬å†™çš„éƒ½æ˜¯è¯¥æ¥å£çš„å­æ¥å£å®ç°ç±»ï¼š**MethodInterceptor** ç®€å•çš„å®ç°12345678910111213141516171819202122232425262728293031323334/** * @author yinhuidong * @createTime 2020-03-02-1:08 */public class Test4 &#123; @Test public void test() &#123; final Producer producer = new Producer(); Producer cglibProducer = (Producer) Enhancer.create(producer.getClass(), new MethodInterceptor() &#123; /** * æ‰§è¡Œè¢«ä»£ç†å¯¹è±¡çš„ä»»ä½•æ–¹æ³•éƒ½ä¼šç»è¿‡è¯¥æ–¹æ³• * @param proxy * @param method * @param args * ä»¥ä¸Šä¸ªå‚æ•°å’ŒåŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†ä¸­invokeæ–¹æ³•çš„å‚æ•°æ˜¯ä¸€æ ·çš„ * @param methodProxy ï¼šå½“å‰æ‰§è¡Œæ–¹æ³•çš„ä»£ç†å¯¹è±¡ * @return * @throws Throwable */ public Object intercept(Object proxy, Method method, Object[] args, MethodProxy methodProxy) throws Throwable &#123; //æä¾›å¢å¼ºçš„ä»£ç  Object returnValue = null; //1.è·å–æ–¹æ³•æ‰§è¡Œçš„å‚æ•° Float money = (Float) args[0]; //2.åˆ¤æ–­å½“å‰æ–¹æ³•æ˜¯ä¸æ˜¯é”€å”® if (&quot;saleProduct&quot;.equals(method.getName())) &#123; returnValue = method.invoke(producer, money * 0.8f); &#125; return returnValue; &#125; &#125;); cglibProducer.saleProduct(12000f); &#125;&#125; äºŒï¼Œå¤šé‡ä»£ç†1.åŸºäºè´£ä»»é“¾æ¨¡å¼çš„å¤šé‡ä»£ç†1.1 è¢«ä»£ç†çš„æ–¹æ³•123456789public interface Animal &#123; void eat(String food);&#125;public class Cat implements Animal&#123; @Override public void eat(String food) &#123; System.out.println(&quot;çŒ«åƒ&quot;+food+&quot;!&quot;); &#125;&#125; 1.2å°è£…ç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•12345678910111213141516171819202122232425262728293031323334353637383940414243444546public class TargetMethod &#123; /** * ç›®æ ‡å¯¹è±¡ */ private Object target; /** * ç›®æ ‡æ–¹æ³• */ private Method method; /** * æ–¹æ³•å‚æ•° */ private Object[] args; public TargetMethod(Object target, Method method, Object[] args) &#123; this.target = target; this.method = method; this.args = args; &#125; public Object getTarget() &#123; return target; &#125; public void setTarget(Object target) &#123; this.target = target; &#125; public Method getMethod() &#123; return method; &#125; public void setMethod(Method method) &#123; this.method = method; &#125; public Object[] getArgs() &#123; return args; &#125; public void setArgs(Object[] args) &#123; this.args = args; &#125;&#125; 1.3 æŠ½è±¡çš„è´£ä»»é“¾èŠ‚ç‚¹å’Œé©±åŠ¨è´£ä»»é“¾å¾€ä¸‹æ‰§è¡Œçš„å¤´èŠ‚ç‚¹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public abstract class AbstractSlot &#123; TargetMethod targetMethod; AbstractSlot next; abstract Object invoke(TargetMethod targetMethod); private boolean hasNextSlot() &#123; return next != null; &#125; public Object proceed(TargetMethod targetMethod) throws Exception &#123; return hasNextSlot() ? next.invoke(targetMethod) : targetMethod.getMethod() .invoke( targetMethod.getTarget(), targetMethod.getArgs() ); &#125; public AbstractSlot(TargetMethod targetMethod, AbstractSlot next) &#123; this.targetMethod = targetMethod; this.next = next; &#125; public TargetMethod getTargetMethod() &#123; return targetMethod; &#125; public void setTargetMethod(TargetMethod targetMethod) &#123; this.targetMethod = targetMethod; &#125; public AbstractSlot getNext() &#123; return next; &#125; public void setNext(AbstractSlot next) &#123; this.next = next; &#125; public AbstractSlot() &#123; &#125; public static class Head extends AbstractSlot&#123; @Override Object invoke(TargetMethod targetMethod) &#123; return null; &#125; &#125;&#125; 1.4 å¯¹æ–¹æ³•å¢å¼ºçš„ç±»1234567891011121314151617181920212223242526public class JdkDynamic implements InvocationHandler &#123; Object target ; AbstractSlot head; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; return head.proceed(new TargetMethod( target,method,args )); &#125; public Object getProxy()&#123; return Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), this ); &#125; public JdkDynamic(Object target, AbstractSlot head) &#123; this.target = target; this.head = head; &#125;&#125; 1.5æµ‹è¯•ç±»12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class Main &#123; public static void main(String[] args) &#123; AbstractSlot.Head head = new AbstractSlot.Head(); AbstractSlot first = new First(); AbstractSlot second=new Second(); first.setNext(second); head.setNext(first); JdkDynamic jdkDynamic = new JdkDynamic(new Cat(),head); Animal proxy = (Animal) jdkDynamic.getProxy(); proxy.eat(&quot;äº‹ç‰©&quot;); &#125; private static class First extends AbstractSlot&#123; @Override Object invoke(TargetMethod targetMethod) &#123; Object result = null; System.out.println(&quot;å¢å¼ºé€»è¾‘&quot;); try &#123; result= proceed(targetMethod); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; System.out.println(&quot;å¢å¼ºé€»è¾‘&quot;); return result; &#125; &#125; private static class Second extends AbstractSlot&#123; @Override Object invoke(TargetMethod targetMethod) &#123; Object result = null; System.out.println(&quot;å¢å¼ºé€»è¾‘&quot;); try &#123; result= proceed(targetMethod); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; System.out.println(&quot;å¢å¼ºé€»è¾‘&quot;); return result; &#125; &#125;&#125; 2.åŸºäºæ‹¦æˆªå™¨çš„å¤šé‡ä»£ç†2.1 æ‹¦æˆªå™¨12345678910111213141516171819202122232425262728public interface MyInterceptor &#123; Object invoke(MyInvocation myInvocation);&#125;class One implements MyInterceptor&#123; @Override public Object invoke(MyInvocation myInvocation) &#123; Object result = null; System.out.println(&quot;1&quot;); result=myInvocation.proceed(); System.out.println(&quot;4&quot;); return result; &#125;&#125;class Two implements MyInterceptor&#123; @Override public Object invoke(MyInvocation myInvocation) &#123; Object result = null; System.out.println(&quot;2&quot;); result=myInvocation.proceed(); System.out.println(&quot;3&quot;); return result; &#125;&#125; 2.2 å¢å¼ºå™¨123456789101112131415161718192021222324252627282930313233343536public interface MyInvocation &#123; Object proceed();&#125;class MyInvocationImpl implements MyInvocation&#123; List&lt;MyInterceptor&gt; interceptors = new ArrayList&lt;&gt;(); int size =0; TargetMethod targetMethod; @Override public Object proceed() &#123; try &#123; return size == interceptors.size()? targetMethod.getMethod() .invoke( targetMethod.getTarget(), targetMethod.getArgs() ): interceptors.get(size++) .invoke(this); &#125; catch (IllegalAccessException | InvocationTargetException e) &#123; e.printStackTrace(); &#125; return null; &#125; public MyInvocationImpl(List&lt;MyInterceptor&gt; interceptors, TargetMethod targetMethod) &#123; this.interceptors = interceptors; this.targetMethod = targetMethod; &#125;&#125; 2.3 å¯¹æ–¹æ³•çš„å¢å¼ºç±»12345678910111213141516171819202122232425262728293031323334public class JdkProxy implements InvocationHandler &#123; Object target; List&lt;MyInterceptor&gt; interceptors = new ArrayList&lt;&gt;(); public void add(MyInterceptor a) &#123; interceptors.add(a); &#125; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; return new MyInvocationImpl( interceptors, new TargetMethod( target, method, args ) ).proceed(); &#125; public Object getProxy()&#123; return Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), this ); &#125; public JdkProxy(Object target) &#123; this.target = target; &#125;&#125; 2.4 æµ‹è¯•ç±»12345678910public class Main &#123; public static void main(String[] args) &#123; JdkProxy jdkProxy = new JdkProxy(new Cat()); jdkProxy.add(new One()); jdkProxy.add(new Two()); ((Animal) jdkProxy.getProxy()).eat(&quot;äº‹åŠ¡&quot;); &#125;&#125; ä¸‰ï¼ŒAOPç›¸å…³æ¦‚å¿µ AOPï¼šå…¨ç§°æ˜¯ Aspect Oriented Programming å³ï¼šé¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚å°±æ˜¯æŠŠæˆ‘ä»¬ç¨‹åºé‡å¤çš„ä»£ç æŠ½å–å‡ºæ¥ï¼Œåœ¨éœ€è¦æ‰§è¡Œçš„æ—¶å€™ï¼Œä½¿ç”¨åŠ¨æ€ä»£ç†çš„æŠ€æœ¯ï¼Œåœ¨ä¸ä¿®æ”¹æºç çš„åŸºç¡€ä¸Šï¼Œå¯¹æˆ‘ä»¬çš„å·²æœ‰æ–¹æ³•è¿›è¡Œå¢å¼ºã€‚â€‹ ä½œç”¨ï¼šåœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œä¸ä¿®æ”¹æºç å¯¹å·²æœ‰æ–¹æ³•è¿›è¡Œå¢å¼ºã€‚ ä¼˜åŠ¿ï¼šå‡å°‘é‡å¤ä»£ç æé«˜å¼€å‘æ•ˆç‡ç»´æŠ¤æ–¹ä¾¿ AOP ç›¸å…³æœ¯è¯­ Joinpoint(è¿æ¥ç‚¹):æ‰€è°“è¿æ¥ç‚¹æ˜¯æŒ‡é‚£äº›è¢«æ‹¦æˆªåˆ°çš„ç‚¹ã€‚åœ¨ spring ä¸­,è¿™äº›ç‚¹æŒ‡çš„æ˜¯æ–¹æ³•,å› ä¸º spring åªæ”¯æŒæ–¹æ³•ç±»å‹çš„è¿æ¥ç‚¹ã€‚ Pointcut(åˆ‡å…¥ç‚¹):æ‰€è°“åˆ‡å…¥ç‚¹æ˜¯æŒ‡æˆ‘ä»¬è¦å¯¹å“ªäº› Joinpoint è¿›è¡Œæ‹¦æˆªçš„å®šä¹‰ã€‚ Advice(é€šçŸ¥/å¢å¼º):æ‰€è°“é€šçŸ¥æ˜¯æŒ‡æ‹¦æˆªåˆ° Joinpoint ä¹‹åæ‰€è¦åšçš„äº‹æƒ…å°±æ˜¯é€šçŸ¥ã€‚é€šçŸ¥çš„ç±»å‹ï¼šå‰ç½®é€šçŸ¥,åç½®é€šçŸ¥,å¼‚å¸¸é€šçŸ¥,æœ€ç»ˆé€šçŸ¥,ç¯ç»•é€šçŸ¥ã€‚ Introduction(å¼•ä»‹):å¼•ä»‹æ˜¯ä¸€ç§ç‰¹æ®Šçš„é€šçŸ¥åœ¨ä¸ä¿®æ”¹ç±»ä»£ç çš„å‰æä¸‹, Introduction å¯ä»¥åœ¨è¿è¡ŒæœŸä¸ºç±»åŠ¨æ€åœ°æ·»åŠ ä¸€äº›æ–¹æ³•æˆ– Fieldã€‚ Target(ç›®æ ‡å¯¹è±¡):è¢«ä»£ç†å¯¹è±¡ä»£ç†çš„ç›®æ ‡å¯¹è±¡ã€‚ Weaving(ç»‡å…¥):æ˜¯æŒ‡æŠŠå¢å¼ºåº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡æ¥åˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚spring é‡‡ç”¨åŠ¨æ€ä»£ç†ç»‡å…¥ï¼Œè€Œ AspectJ é‡‡ç”¨ç¼–è¯‘æœŸç»‡å…¥å’Œç±»è£…è½½æœŸç»‡å…¥ã€‚ Proxyï¼ˆä»£ç†:ä¸€ä¸ªç±»è¢« AOP ç»‡å…¥å¢å¼ºåï¼Œå°±äº§ç”Ÿä¸€ä¸ªç»“æœä»£ç†ç±»ã€‚ Aspect(åˆ‡é¢):æ˜¯åˆ‡å…¥ç‚¹å’Œé€šçŸ¥ï¼ˆå¼•ä»‹çš„ç»“åˆï¼‰ â€‹ Spring æ¡†æ¶ç›‘æ§åˆ‡å…¥ç‚¹æ–¹æ³•çš„æ‰§è¡Œã€‚ä¸€æ—¦ç›‘æ§åˆ°åˆ‡å…¥ç‚¹æ–¹æ³•è¢«è¿è¡Œï¼Œä½¿ç”¨ä»£ç†æœºåˆ¶ï¼ŒåŠ¨æ€åˆ›å»ºç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œæ ¹æ®é€šçŸ¥ç±»åˆ«ï¼Œåœ¨ä»£ç†å¯¹è±¡çš„å¯¹åº”ä½ç½®ï¼Œå°†é€šçŸ¥å¯¹åº”çš„åŠŸèƒ½ç»‡å…¥ï¼Œå®Œæˆå®Œæ•´çš„ä»£ç é€»è¾‘è¿è¡Œã€‚â€‹ è‡³æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡ä¸¤ç§æ–¹å¼å®Œæˆäº†å¤šé‡ä»£ç†å®ç°AOPï¼Œä¹Ÿç®€å•ä»‹ç»äº†ä¸¤ç§å®ç°åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œå’ŒAOPç›¸å…³çš„ä¸€äº›æ¦‚å¿µã€‚ä¸‹ä¸€ç¯‡å°†å¼€å§‹åˆ†ææ³¨è§£ç‰ˆAopæºç ã€‚ â€‹","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[ä¹]ä¸‰çº§ç¼“å­˜&å¾ªç¯ä¾èµ–","slug":"Spring/Spring[ä¹]ä¸‰çº§ç¼“å­˜&å¾ªç¯ä¾èµ–","date":"2022-01-11T06:00:05.852Z","updated":"2022-01-11T06:08:29.459Z","comments":true,"path":"2022/01/11/Spring/Spring[ä¹]ä¸‰çº§ç¼“å­˜&å¾ªç¯ä¾èµ–/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E4%B9%9D]%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98&%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/","excerpt":"","text":"ä¸Šä¸€ç¯‡è¡¥å……äº†ä¸€ä¸‹Springçš„ç»„ä»¶ï¼Œæ³¨è§£å’Œæ‰©å±•ç‚¹ï¼Œåœ¨å¼€å‘ä¸­å¦‚æœæ¸…æ¥šçš„äº†è§£è¿™äº›ä¸œè¥¿ï¼Œä¼šå¯¹ä½ çš„æ¡ˆä¾‹è®¾è®¡ï¼Œäº§ç”Ÿæ„æƒ³ä¸åˆ°çš„æ•ˆæœã€‚æˆ‘å‘¢ï¼Œåªæ˜¯å¯¹è¿™äº›ç»„ä»¶æ³¨è§£æ‰©å±•ç‚¹è¿›è¡Œä¸€ä¸ªä»‹ç»åˆ†æï¼Œå…·ä½“çš„å¦‚ä½•ä¸ºä¸šåŠ¡èµ‹èƒ½è¿˜éœ€è¦ç»“åˆå®é™…çš„å¼€å‘åœºæ™¯ã€‚ ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Ÿ æœ‰å‡ ç§å¾ªç¯ä¾èµ–ï¼Ÿ Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ Springä¸ºä»€ä¹ˆç”¨ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼Œç”¨äºŒçº§å¯ä¸å¯ä»¥ï¼Ÿ å½“ç›®æ ‡å¯¹è±¡äº§ç”Ÿä»£ç†å¯¹è±¡æ—¶ï¼ŒSpringå®¹å™¨ä¸­(ç¬¬ä¸€çº§ç¼“å­˜)åˆ°åº•å­˜å‚¨çš„æ˜¯è°ï¼Ÿä¸€ï¼Œé—®é¢˜&amp;ç­”æ¡ˆ1.ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ– ç±»å’Œç±»ä¹‹é—´çš„ä¾èµ–å…³ç³»å½¢æˆäº†é—­ç¯ï¼Œå°±å«åšå¾ªç¯ä¾èµ–ã€‚â€‹ 2.æœ‰å‡ ç§å¾ªç¯ä¾èµ– é€šè¿‡æ„é€ æ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥æ—¶äº§ç”Ÿçš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚ é€šè¿‡setteræ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥ä¸”æ˜¯åœ¨å¤šä¾‹(åŸå‹)æ¨¡å¼ä¸‹äº§ç”Ÿçš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚ é€šè¿‡setteræ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥ä¸”æ˜¯åœ¨å•ä¾‹æ¨¡å¼ä¸‹äº§ç”Ÿçš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚ â€‹ æ³¨æ„ï¼šåœ¨Springä¸­ï¼Œåªæœ‰ã€ç¬¬ä¸‰ç§æ–¹å¼ã€‘çš„å¾ªç¯ä¾èµ–é—®é¢˜è¢«è§£å†³äº†ï¼Œå…¶ä»–ä¸¤ç§æ–¹å¼åœ¨é‡åˆ°å¾ªç¯ä¾èµ–é—®é¢˜æ—¶éƒ½ä¼šäº§ç”Ÿå¼‚å¸¸ã€‚ ç¬¬ä¸€ç§æ„é€ æ–¹æ³•æ³¨å…¥çš„æƒ…å†µä¸‹ï¼Œåœ¨newå¯¹è±¡çš„æ—¶å€™å°±ä¼šå µå¡ä½äº†ï¼Œå…¶å®ä¹Ÿå°±æ˜¯â€å…ˆæœ‰é¸¡è¿˜æ˜¯å…ˆæœ‰è›‹â€œçš„å†å²éš¾é¢˜ã€‚ ç¬¬äºŒç§setteræ–¹æ³•&amp;&amp;å¤šä¾‹çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸€æ¬¡getBean()æ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„Beanï¼Œå¦‚æ­¤åå¤ä¸‹å»å°±ä¼šæœ‰æ— ç©·æ— å°½çš„Beanäº§ç”Ÿäº†ï¼Œæœ€ç»ˆå°±ä¼šå¯¼è‡´OOMé—®é¢˜çš„å‡ºç°ã€‚ å›é¡¾ä¸€ä¸‹å•å®ä¾‹beanåˆ›å»ºçš„è¿‡ç¨‹â€‹ 3.Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ï¼Ÿ ä¸‹è½½åŸå›¾å¯ç‚¹å‡»è¿™é‡Œâ€‹ 1.Aåˆ›å»ºè¿‡ç¨‹ä¸­éœ€è¦Bï¼Œäºæ˜¯Aå°†è‡ªå·±æ”¾åˆ°ä¸‰çº§ç¼“å­˜å»å®ä¾‹åŒ–B 2.Bå®ä¾‹åŒ–çš„æ—¶å€™å‘ç°éœ€è¦Aï¼Œäºæ˜¯Bå…ˆæŸ¥ä¸€çº§ç¼“å­˜ï¼Œæ²¡æœ‰ï¼Œå†æŸ¥äºŒçº§ç¼“å­˜ï¼Œæ²¡æœ‰ï¼Œå†æŸ¥ä¸‰çº§ç¼“å­˜ï¼Œæ‰¾åˆ°äº†Aï¼Œç„¶åæŠŠä¸‰çº§ç¼“å­˜é‡Œé¢çš„Aæ”¾åˆ°äºŒçº§ç¼“å­˜é‡Œé¢ï¼Œå¹¶åˆ é™¤ä¸‰çº§ç¼“å­˜é‡Œé¢çš„Aã€‚ 3.Bé¡ºåˆ©åˆå§‹åŒ–å®Œæ¯•ï¼Œå°†è‡ªå·±æ”¾åˆ°ä¸€çº§ç¼“å­˜é‡Œé¢ï¼ˆæ­¤æ—¶Bé‡Œé¢çš„Aè¿˜æœªåˆ›å»ºå®Œï¼‰ï¼Œç„¶åæ¥ç€å›æ¥åˆ›å»ºAï¼Œæ­¤æ—¶Bå·²ç»åˆ›å»ºç»“æŸï¼Œç›´æ¥ä»ä¸€çº§ç¼“å­˜é‡Œé¢æ‹¿åˆ°Bï¼Œç„¶åå®Œæˆåˆ›å»ºï¼Œå¹¶å°†Aè‡ªå·±æ”¾åˆ°ä¸€çº§ç¼“å­˜é‡Œé¢ã€‚ springè§£å†³å¾ªç¯ä¾èµ–ä¾é çš„æ˜¯Beançš„ä¸­é—´æ€è¿™ä¸ªæ¦‚å¿µï¼Œè€Œè¿™ä¸ªä¸­é—´æ€æŒ‡çš„æ˜¯å·²ç»å®ä¾‹åŒ–ä½†è¿˜æ²¡åˆå§‹åŒ–çš„çŠ¶æ€â€”â€“&gt;åŠæˆå“ã€‚â€‹ 12345678910//DefaultSingletonBeanRegistry//ä¸€çº§ç¼“å­˜ï¼šå®ä¾‹åŒ–å®Œçš„beanprivate final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);//ä¸‰çº§ç¼“å­˜ï¼šå•ä¾‹beanå·¥å‚private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16);//äºŒçº§ç¼“å­˜ï¼šæ—©æœŸæš´éœ²çš„beanprivate final Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;&gt;(16); 4.Springä¸ºä»€ä¹ˆç”¨ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼Œç”¨äºŒçº§å¯ä¸å¯ä»¥ï¼Ÿä¸ºä»€ä¹ˆç¬¬ä¸‰çº§ç¼“å­˜è¦ä½¿ç”¨ObjectFactoryï¼Ÿéœ€è¦æå‰äº§ç”Ÿä»£ç†å¯¹è±¡ã€‚â€‹ â€‹ ä»€ä¹ˆæ—¶å€™å°†Beançš„å¼•ç”¨æå‰æš´éœ²ç»™ç¬¬ä¸‰çº§ç¼“å­˜çš„ObjectFactoryæŒæœ‰ï¼Ÿæ—¶æœºå°±æ˜¯åœ¨ç¬¬ä¸€æ­¥å®ä¾‹åŒ–ä¹‹åï¼Œç¬¬äºŒæ­¥ä¾èµ–æ³¨å…¥ä¹‹å‰ï¼Œå®Œæˆæ­¤æ“ä½œã€‚â€‹ è‡³æ­¤ï¼Œæˆ‘å°±è§£é‡Šæ¸…æ¥šäº†æ•´ä¸ªä¸‰çº§ç¼“å­˜å’Œå¾ªç¯ä¾èµ–ã€‚ä¸å¾—ä¸æ„Ÿæ…¨ï¼Œåœ¨æˆ‘å¤§ä¸‰çš„æ—¶å€™ï¼Œè¿™é“é¢˜è¿˜å·ç§°æ˜¯é˜¿é‡ŒP7çš„é¢è¯•é¢˜ï¼Œå¤§å››çš„æ—¶å€™ï¼Œæˆ‘å°±è¿ç»­å››åœºé¢è¯•è¢«é—®åˆ°ï¼Œè¡Œä¸šå†…å·å•Šã€‚","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[å…«]æ³¨è§£&ç»„ä»¶ç¯‡","slug":"Spring/Spring[å…«]æ³¨è§£&ç»„ä»¶ç¯‡","date":"2022-01-11T05:59:54.649Z","updated":"2022-01-11T06:08:57.690Z","comments":true,"path":"2022/01/11/Spring/Spring[å…«]æ³¨è§£&ç»„ä»¶ç¯‡/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E5%85%AB]%E6%B3%A8%E8%A7%A3&%E7%BB%84%E4%BB%B6%E7%AF%87/","excerpt":"","text":"å†™åœ¨å‰é¢ å†™åœ¨å‰é¢ï¼šæœ€è¿‘åœ¨ç¼–è¯‘æœ€æ–°ç‰ˆspringæºç çš„æ—¶å€™ï¼Œè¸©äº†å†™å°å‘ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹æœ€æ–°çš„å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/spring-projects/spring-frameworkåœ¨build from sourceé‡Œé¢å£°æ˜äº†æœ€æ–°çš„ç¼–è¯‘è¿‡ç¨‹ï¼šhttps://github.com/spring-projects/spring-framework/wiki/Build-from-Sourceç”±äºæœ€è¿‘springåšäº†ä¸€äº›å‡çº§ï¼Œæƒ³è¦åœ¨æœ¬åœ°æ„å»ºspringæºç ï¼Œéœ€è¦ä½¿ç”¨jdk17ã€‚æ­¤å¤–ï¼Œæœ€è¿‘gradleçš„è¯­æ³•ä¹Ÿå› ä¸ºç‰ˆæœ¬çš„åŸå› ï¼Œæ”¹åŠ¨å¾ˆå¤§ã€‚æƒ³è¦åœ¨springæºç é‡Œé¢å¯¹gradleè¿›è¡Œä¸€äº›å®šåˆ¶åŒ–é…ç½®çš„æ—¶å€™ï¼Œå¯ä»¥å‚ç…§gradleå®˜ç½‘ã€‚https://gradle.org/releases/ 1.æ³¨è§£1.1æ€»è§ˆ @Bean å®¹å™¨ä¸­æ³¨å†Œç»„ä»¶ @Primary åŒç±»ç»„ä»¶å¦‚æœæœ‰å¤šä¸ªï¼Œæ ‡æ³¨ä¸»ç»„ä»¶ @DependsOn ç»„ä»¶ä¹‹é—´å£°æ˜ä¾èµ–å…³ç³» @Lazy ç»„ä»¶æ‡’åŠ è½½ï¼ˆæœ€åä½¿ç”¨çš„æ—¶å€™æ‰ä¼šå»åˆ›å»ºï¼‰ @Scope å£°æ˜ç»„ä»¶çš„ä½œç”¨èŒƒå›´ @Configuration å£°æ˜è¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œæ›¿æ¢xml @Component @Controller @Service @Repository @Indexed åŠ é€Ÿæ³¨è§£ï¼Œæ‰€æœ‰æ ‡æ³¨äº†@Indexedçš„ç»„ä»¶ï¼Œç›´æ¥ä¼šå¯åŠ¨å¿«é€ŸåŠ è½½ @Order æ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆå·¥ä½œ @ComponentScan åŒ…æ‰«æ @Conditional æ¡ä»¶æ³¨å…¥ @Import å¯¼å…¥ç¬¬ä¸‰æ–¹jaråŒ…ä¸­çš„ç»„ä»¶ï¼Œæˆ–è€…å®šåˆ¶æ‰¹é‡å¯¼å…¥ç»„ä»¶é€»è¾‘ @ImportResource å¯¼å…¥ä»¥å‰çš„xmlé…ç½®æ–‡ä»¶ï¼Œè®©å…¶ç”Ÿæ•ˆ @Profile åŸºäºå¤šç¯å¢ƒæ¿€æ´» @PropertySource å¤–éƒ¨propertiesé…ç½®æ–‡ä»¶å’ŒjavaBeanè¿›è¡Œç»‘å®šï¼Œç»“åˆConfigurationProperties @PropertySources @PropertySourceçš„ç»„åˆæ³¨è§£ @Autowired è‡ªåŠ¨è£…é… @Qualifier ç²¾å‡†æŒ‡å®š @Resource jsr250è§„èŒƒçš„jdkè‡ªå¸¦æ³¨è§£ @Value å–å€¼ï¼Œè®¡ç®—æœºç¯å¢ƒå˜é‡ï¼Œjvmç³»ç»Ÿ xxx @Lookup å•ä¾‹ç»„ä»¶ä¾èµ–éå•ä¾‹ç»„ä»¶ï¼Œéå•ä¾‹ç»„ä»¶è·å–éœ€è¦ä½¿ç”¨æ–¹æ³•1.2.æ¡ˆä¾‹com.yhd.annotation.AnnoMainTestâ€‹ 2.ç»„ä»¶ä¸SPIæ‰©å±•ç‚¹æœºåˆ¶2.1æ€»è§ˆ åŸºç¡€æ¥å£ Resource+ResourceLoader å°†æ¥è‡ªå„ç§ä¸åŒæ¸ é“çš„é…ç½®æ–‡ä»¶ç­‰è¿›è¡Œä¸€å±‚æŠ½è±¡å°è£…ï¼Œè®©å¼€å‘äººå‘˜ä¸å¿…å…³æ³¨äºåº•å±‚çš„ç»†èŠ‚å®ç°ï¼Œé€šè¿‡èµ„æºåŠ è½½å™¨åŠ è½½èµ„æºã€‚ BeanFactory iocå®¹å™¨é¡¶å±‚æ¥å£ âœ… BeanDefinition ä»resourceè§£æå‡ºbeançš„å®šä¹‰ä¿¡æ¯ âœ… BeanDefinitionReader beanå®šä¹‰ä¿¡æ¯è¯»å–å™¨ ï¼Œä»resource è¯»å–è§£æ BeanDefinition BeanDefinitionRegistry beanå®šä¹‰ä¿¡æ¯çš„æ³¨å†Œä¸­å¿ƒ è§£æå‡ºæ¥çš„BeanDefinitionä¿¡æ¯ä¼šè¢«æ³¨å†Œåˆ°è¿™é‡Œ ApplicationContext iocæ ¸å¿ƒæ¥å£ âœ… Aware å®ç°xxxAwareæ¥å£æ˜¯ä¸ºäº†èƒ½å¤Ÿè·å–åˆ°xxxç›¸å…³çš„ä¸€äº›å±æ€§ âœ… BeanNameAware BeanFactoryAware ApplicationEventPublisherAware ApplicationContextAware ApplicationStartupAware BeanClassLoaderAware ImportAware EnvironmentAware ç”Ÿå‘½å‘¨æœŸ-åç½®å¤„ç†å™¨ BeanFactoryPostProcessor âœ… BeanDefinitionRegistryPostProcessor âœ… InitializingBean âœ… DisposableBean âœ… BeanPostProcessor âœ… SmartInitializingSingleton âœ… ç›‘å¬å™¨ ApplicationListener âœ…2.2æ¡ˆä¾‹ \u0000com.yhd.annotation.AnnoMainTestâ€‹ è¡¥å……ï¼šspringæºç åœ°å€ï¼šhttps://gitee.com/yin_huidong/spring.gitâ€‹ \u0000æ­¤æºç mainåˆ†æ”¯ä¸ºæ‰‹åŠ¨ç¿»è¯‘å¥½çš„ä¸­æ–‡æ³¨é‡Šç‰ˆspringæºç ã€‚ ä¸€ï¼Œç»„ä»¶æ³¨å†Œ1.Configuration&amp;Bean@Configurationæ³¨è§£æ ‡è¯†çš„ç±»æ ‡è¯†è¿™æ˜¯ä¸€ä¸ªSpringçš„é…ç½®ç±»ã€‚â€‹ @Beanæ³¨è§£ï¼šç»™å®¹å™¨ä¸­æ³¨å†Œä¸€ä¸ªbeanï¼Œidé»˜è®¤æ˜¯æ–¹æ³•åä½œä¸ºidã€‚â€‹ valueï¼šæŒ‡å®šidå initMethodï¼šæŒ‡å®šåˆå§‹åŒ–æ–¹æ³• destoryMethodï¼šæŒ‡å®šé”€æ¯æ–¹æ³• â€‹ 1.1 SpringConfig12345678@Configurationpublic class SpringConfig &#123; @Bean(value = &quot;person&quot;,initMethod = &quot;init&quot;,destroyMethod = &quot;destroy&quot;) public Person person()&#123; return new Person(1,&quot;äºŒå&quot;); &#125;&#125; 1.2 Person1234567891011121314151617@Data@AllArgsConstructor@NoArgsConstructorpublic class Person &#123; private Integer id; private String name ; public void init()&#123; System.out.println(&quot;init()...&quot;); &#125; public void destroy()&#123; System.out.println(&quot;destroy()...&quot;); &#125;&#125; 1.3 Test12345678910public class TestA &#123; ApplicationContext ioc = new AnnotationConfigApplicationContext(SpringConfig.class); @Test public void testBean()&#123; Person person = ioc.getBean(&quot;person&quot;, Person.class); System.out.println(&quot;person = &quot; + person); &#125;&#125; 2.RunWith&amp;ContextConfiguration@RunWithï¼šSpringæ•´åˆJunit4ã€‚â€‹ @ContextConfigurationï¼šæŒ‡å®šé…ç½®ç±»ã€‚â€‹ 1234567891011@RunWith(SpringRunner.class)@ContextConfiguration(classes = &#123;SpringConfig.class&#125;)public class TestA &#123; @Autowired private Person person; @Test public void testBean()&#123; System.out.println(&quot;person = &quot; + person); &#125;&#125; 3.ComponentScan@ComponentScan(â€œcom.yhdâ€) ç»„ä»¶æ‰«æ value:æŒ‡å®šæ‰«æçš„åŒ… includeFilters = &#123;@ComponentScan.Filter(type = FilterType.ANNOTATION,classes = Controller.class)&#125; åªåŒ…å«å“ªäº›åŒ…ï¼ˆéœ€è¦æŒ‡æ˜ï¼šuseDefaultFilters = falseï¼‰ type type:FilterType.ANNOTATION:æŒ‰ç…§æ³¨è§£è¿‡æ»¤type=FilterType.ASSIGNABLE_TYPEï¼šæŒ‰ç…§ç±»å‹è¿‡æ»¤type=ASPECTJ,åˆ‡é¢type=REGEX,æ­£åˆ™type=CUSTOMï¼Œå®šåˆ¶ï¼ˆéœ€è¦å®ç°TypeFilteræ¥å£ï¼‰ excludeFilters:æŒ‡æ˜æ’é™¤å“ªäº›åŒ…ä¸è¢«æ‰«æ â€‹ 3.1 SpringConfig1234567891011121314@Configuration@ComponentScan(value = &quot;com.yhd&quot;, includeFilters = &#123; @ComponentScan.Filter(type = FilterType.ANNOTATION, classes = Controller.class), @ComponentScan.Filter(type = FilterType.ASSIGNABLE_TYPE) &#125;, excludeFilters = &#123;&#125;, useDefaultFilters = true)public class SpringConfig &#123; @Bean(value = &quot;person&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;destroy&quot;) public Person person() &#123; return new Person(1, &quot;äºŒå&quot;); &#125;&#125; 3.2 Test12345678910111213141516@RunWith(SpringRunner.class)@ContextConfiguration(classes = &#123;SpringConfig.class&#125;)public class TestA &#123; @Autowired private ApplicationContext ioc; @Test public void test()&#123; //æŸ¥çœ‹å®¹å™¨ä¸­beançš„åå­— String[] names = ioc.getBeanDefinitionNames(); for (String name : names) &#123; System.out.println(&quot;name = &quot; + name); &#125; &#125;&#125; 4.Scopeä½œç”¨ï¼šè®¾ç½®ç»„ä»¶ä½œç”¨åŸŸã€‚â€‹ @Scope é»˜è®¤æ˜¯å•ä¾‹çš„ç‚¹å‡»è¿›å…¥è¯¥æ³¨è§£ï¼Œåœ¨æ­¤ç‚¹å‡»è¿›å…¥æ–‡æ¡£æ³¨é‡Šä¸­çš„ConfigurableBeanFactoryå¯ä»¥çœ‹åˆ°è¯¥æ³¨è§£çš„å‡ ä¸ªå–å€¼ï¼š singleton å•ä¾‹ prototype å¤šä¾‹ request åŒä¸€æ¬¡è¯·æ±‚ session åŒä¸€ä¸ªsessionä½œç”¨åŸŸ åœ¨scope=singletonæ—¶ï¼Œå¯¹è±¡åœ¨å®¹å™¨å·²åˆ›å»ºç«‹å³åŠ å…¥å®¹å™¨ã€‚åœ¨scope=prototypeæ—¶ï¼Œå¯¹è±¡æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™éƒ½ä¼šæ·»åŠ åˆ°å®¹å™¨ã€‚â€‹ 4.1 SpringConfig123456789@Configurationpublic class SpringConfig &#123; @Bean(value = &quot;person&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;destroy&quot;) @Scope(&quot;prototype&quot;) public Person person() &#123; return new Person(1, &quot;äºŒå&quot;); &#125;&#125; 4.2 Test123456@Testpublic void test()&#123; Person p1 = ioc.getBean(&quot;person&quot;, Person.class); Person p2 = ioc.getBean(&quot;person&quot;, Person.class); System.out.println(p1==p2?&quot;true&quot;:&quot;false&quot;);//false&#125; 5.Lazy@Lazy æ‡’åŠ è½½å•å®ä¾‹beanï¼Œé»˜è®¤åœ¨å®¹å™¨åˆ›å»ºæ—¶å€™æ·»åŠ å¯¹è±¡ã€‚æ‡’åŠ è½½ï¼šå®¹å™¨å¯åŠ¨ä¸åˆ›å»ºå¯¹è±¡ï¼Œç¬¬ä¸€æ¬¡è·å–/ä½¿ç”¨æ—¶åœ¨åˆ›å»ºå¯¹è±¡å¹¶åˆå§‹åŒ–ã€‚â€‹ 5.1 SpringConfig12345678910@Configurationpublic class SpringConfig &#123; @Lazy @Bean(value = &quot;person&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;destroy&quot;) public Person person() &#123; System.out.println(&quot;personå·²ç»åŠ è½½åˆ°å®¹å™¨ä¸­ï¼&quot;); return new Person(1, &quot;äºŒå&quot;); &#125;&#125; 5.2 Test1234@Testpublic void test()&#123; Person person = ioc.getBean(&quot;person&quot;, Person.class);&#125; å¯¹æ¯”åŠ ä¸Šè¿™ä¸ªæ³¨è§£å‰åï¼Œå®¹å™¨ä¸­å•å®ä¾‹beançš„å˜åŒ–ï¼šâ€‹ 6.Conditional@Conditionalç‚¹å‡»è¿›å…¥Class&lt;? extends Condition&gt;[] value();å‘ç°è¿™ä¸ªæ³¨è§£é‡Œé¢çš„valueå±æ€§éœ€è¦ä¼ å…¥ä¸€ä¸ªConditionæ•°ç»„ï¼Œç‚¹å‡»è¿›å…¥Conditionboolean matches(ConditionContext context, AnnotatedTypeMetadata metadata);å› æ­¤ï¼Œå¯ä»¥å®ç°Conditionæ¥å£ï¼Œæ¥ä½¿ç”¨è¯¥æ³¨è§£â€‹ å½“è¯¥æ³¨è§£åŠ åœ¨æ–¹æ³•ä¸Šï¼Œæ ‡è¯†æ»¡è¶³æ¡ä»¶æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šæ‰§è¡Œå½“è¯¥æ³¨è§£åŠ åœ¨ç±»ä¸Šæ—¶ï¼Œè¡¨ç¤ºæ»¡è¶³æ¡ä»¶æ—¶ï¼Œè¯¥ç±»é‡Œé¢çš„æ‰€æœ‰æ–¹æ³•æ‰ä¼šæ‰§è¡Œï¼Œå¦åˆ™ä¸€ä¸ªéƒ½ä¸æ‰§è¡Œã€‚â€‹ 123456789101112@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface Conditional &#123; /** * All &#123;@link Condition&#125;s that must &#123;@linkplain Condition#matches match&#125; * in order for the component to be registered. */ Class&lt;? extends Condition&gt;[] value();&#125; 1234567891011121314@FunctionalInterfacepublic interface Condition &#123; /** * Determine if the condition matches. * @param context the condition context * @param metadata metadata of the &#123;@link org.springframework.core.type.AnnotationMetadata class&#125; * or &#123;@link org.springframework.core.type.MethodMetadata method&#125; being checked * @return &#123;@code true&#125; if the condition matches and the component can be registered, * or &#123;@code false&#125; to veto the annotated component&#x27;s registration */ boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata);&#125; 6.1 æ¡ˆä¾‹ï¼šæ ¹æ®å½“å‰ç³»ç»Ÿç¯å¢ƒå°†å¯¹åº”çš„beanåŠ å…¥åˆ°å®¹å™¨6.1.1 SpringConfig1234567891011121314151617@Configurationpublic class SpringConfig &#123; @Bean(&quot;person&quot;) @Conditional(&#123;Mac.class&#125;) public Person person() &#123; System.out.println(&quot;personå·²ç»åŠ è½½åˆ°å®¹å™¨ä¸­ï¼&quot;); return new Person(1, &quot;äºŒå&quot;); &#125; @Bean(&quot;person2&quot;) @Conditional(&#123;Linux.class&#125;) public Person person2() &#123; System.out.println(&quot;personå·²ç»åŠ è½½åˆ°å®¹å™¨ä¸­ï¼&quot;); return new Person(1, &quot;äºŒå&quot;); &#125;&#125; 6.1.2 æ¡ä»¶ç±»12345678public class Mac implements Condition &#123; @Override public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) &#123; return context.getEnvironment().getProperty(&quot;os.name&quot;).contains(&quot;Mac&quot;); &#125;&#125; 123456public class Linux implements Condition &#123; @Override public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) &#123; return context.getEnvironment().getProperty(&quot;os.name&quot;).contains(&quot;linux&quot;); &#125;&#125; 6.1.3 Test12345678910111213141516@RunWith(SpringRunner.class)@ContextConfiguration(classes = &#123;SpringConfig.class&#125;)public class TestA &#123; @Autowired private ApplicationContext ioc; @Test public void test()&#123; Person person = ioc.getBean(&quot;person&quot;, Person.class); Person person2 = ioc.getBean(&quot;person2&quot;, Person.class); System.out.println(person); System.out.println(person2); &#125;&#125; 7.Importç”¨æ¥å¿«é€Ÿå¯¼å…¥ä¸€ä¸ªbeanï¼Œé»˜è®¤ç±»åæ˜¯è¯¥ç±»çš„å…¨é™å®šç±»åï¼Œå•ä¾‹ã€‚â€‹ 7.1 SpringConfig123456789101112131415161718@Configuration@Import(&#123;Dog.class&#125;)public class SpringConfig &#123; @Bean(&quot;person&quot;) @Conditional(&#123;Mac.class&#125;) public Person person() &#123; System.out.println(&quot;personå·²ç»åŠ è½½åˆ°å®¹å™¨ä¸­ï¼&quot;); return new Person(1, &quot;äºŒå&quot;); &#125; @Bean(&quot;person2&quot;) @Conditional(&#123;Linux.class&#125;) public Person person2() &#123; System.out.println(&quot;personå·²ç»åŠ è½½åˆ°å®¹å™¨ä¸­ï¼&quot;); return new Person(1, &quot;äºŒå&quot;); &#125;&#125; 7.2 Test12345678910@Testpublic void test()&#123; Dog dog = ioc.getBean(Dog.class); assert dog!=null; dog.setId(1); dog.setName(&quot;asdfg&quot;); System.out.println(&quot;dog = &quot; + dog);&#125; 8.ImportSelector123456789public @interface Import &#123; /** * &#123;@link Configuration&#125;, &#123;@link ImportSelector&#125;, &#123;@link ImportBeanDefinitionRegistrar&#125; * or regular component classes to import. */ Class&lt;?&gt;[] value();&#125; ç‚¹å‡»æŸ¥çœ‹@Importæ³¨è§£å¯ä»¥å‘ç°ï¼šâ€‹ é‡Œé¢è¿˜å¯ä»¥ä¼ å…¥{@link Configuration}, {@link ImportSelector}, {@link ImportBeanDefinitionRegistrar}â€‹ importSelectorå…¶å®å°±æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å®ç°å®ƒæ¥ä¼ å…¥impotæ³¨è§£ã€‚â€‹ 8.1 MyImportSelector123456public class MyImportSelector implements ImportSelector &#123; @Override public String[] selectImports(AnnotationMetadata importingClassMetadata) &#123; return new String[]&#123;&quot;com.yhd.pojo.Person&quot;,&quot;com.yhd.pojo.Dog&quot;&#125;; &#125;&#125; 8.2 SpringConfig12345@Configuration@Import(&#123;MyImportSelector.class&#125;)public class SpringConfig &#123; &#125; 8.3 Test12345678910111213@RunWith(SpringRunner.class)@ContextConfiguration(classes = &#123;SpringConfig.class&#125;)public class TestA &#123; @Autowired private ApplicationContext ioc; @Test public void test()&#123; String[] names = ioc.getBeanDefinitionNames(); for (String name : names) System.out.println(name); &#125;&#125; 9.ImportBeanDefinitionRegistrar1234567public interface ImportBeanDefinitionRegistrar &#123; public void registerBeanDefinitions( AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry);&#125; 9.1 MyImportBeanDefinitionRegistrar123456public class MyImportBeanDefinitionRegistrar implements ImportBeanDefinitionRegistrar &#123; @Override public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123; registry.registerBeanDefinition(&quot;dog&quot;, new RootBeanDefinition(&quot;com.yhd.pojo.Dog&quot;)); &#125;&#125; 9.2 MyImportBeanDefinitionRegistrar12345@Configuration@Import(&#123;MyImportBeanDefinitionRegistrar.class&#125;)public class SpringConfig &#123;&#125; 9.3 Test12345678910111213@RunWith(SpringRunner.class)@ContextConfiguration(classes = &#123;SpringConfig.class&#125;)public class TestA &#123; @Autowired private ApplicationContext ioc; @Test public void test()&#123; String[] names = ioc.getBeanDefinitionNames(); for (String name : names) System.out.println(name); &#125;&#125; 10.FactoryBeanâ€‹ springçš„å·¥å‚æ¨¡å¼é€ Bean å¦‚æœä¼ å…¥idè·å–åˆ°çš„æ˜¯å·¥å‚é€ çš„bean å¦‚æœä¼ å…¥çš„æ˜¯&amp;idè·å–åˆ°çš„æ˜¯å·¥å‚æœ¬èº« â€‹ 10.1 PersonFactory12345678910111213141516public class PersonFactory implements FactoryBean&lt;Person&gt; &#123; @Override public Person getObject() throws Exception &#123; return new Person(1,&quot;FactoryBean&quot;); &#125; @Override public Class&lt;?&gt; getObjectType() &#123; return Person.class; &#125; @Override public boolean isSingleton() &#123; return true; &#125;&#125; 10.2 SpringConfig12345678@Configurationpublic class SpringConfig &#123; @Bean public PersonFactory personFactory()&#123; return new PersonFactory(); &#125;&#125; 10.3 Test12345678910111213141516171819@RunWith(SpringRunner.class)@ContextConfiguration(classes = &#123;SpringConfig.class&#125;)public class TestA &#123; @Autowired private ApplicationContext ioc; @Test public void test()&#123; PersonFactory personFactory = (PersonFactory) ioc.getBean(&quot;&amp;personFactory&quot;); System.out.println(&quot;personFactory = &quot; + personFactory); Person person = (Person) ioc.getBean(&quot;personFactory&quot;); System.out.println(&quot;person = &quot; + person); /*personFactory = com.yhd.factory.PersonFactory@6e20b53a person = Person(id=1, name=FactoryBean)*/ &#125;&#125; 10.4 åŸç†1234public interface BeanFactory &#123; //moreèƒ½è·å–åˆ°å·¥å‚beançš„æ–¹æ³•å°±æ˜¯åœ¨idå‰åŠ ä¸Šå‰ç¼€&amp; String FACTORY_BEAN_PREFIX = &quot;&amp;&quot;; 11.LookUpâ€‹ å¦‚æœæœ‰ä¸€ä¸ªç±»C,éœ€è¦ç”¨åˆ°ç±»B,å¦‚æœä½¿ç”¨@Autowiredæ³¨è§£æ³¨å…¥B,é‚£ä¹ˆBæ¯æ¬¡è°ƒç”¨éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œå³ä½¿Bä¸æ˜¯å•ä¾‹çš„ï¼Œç°åœ¨æˆ‘å¸Œæœ›æ¯æ¬¡è°ƒç”¨Béƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå®ç°æ–¹æ¡ˆæœ‰2ä¸ªï¼šâ€‹ 11.1 æ¯æ¬¡ä»å®¹å™¨ä¸­è·å–B123456789101112131415161718192021@Component@Scope(scopeName= ConfigurableBeanFactory.SCOPE_PROTOTYPE) //åŸå‹ ä¹Ÿå°±æ˜¯éå•ä¾‹public class B &#123; public void sayHi()&#123; System.out.println(&quot;hi&quot;); &#125;&#125;@Componentpublic class C implements ApplicationContextAware &#123; private ApplicationContext applicationContext; public void hello()&#123; B b = (B)applicationContext.getBean(&quot;b&quot;); b.sayHi(); &#125; @Override public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123; this.applicationContext=applicationContext; &#125;&#125; 11.2 ä½¿ç”¨@lookupæ³¨è§£12345678910111213141516171819@Component@Scope(scopeName= ConfigurableBeanFactory.SCOPE_PROTOTYPE) //åŸå‹ ä¹Ÿå°±æ˜¯éå•ä¾‹public class B &#123; public void sayHi()&#123; System.out.println(&quot;hi&quot;); &#125;&#125;@Componentpublic abstract class C &#123; public void hello()&#123; B b = getB(); b.sayHi(); &#125; @Lookup public abstract B getB(); //ä¸€èˆ¬éƒ½æ˜¯æŠ½è±¡æ–¹æ³•&#125; äºŒï¼Œç”Ÿå‘½å‘¨æœŸ1.@BeanæŒ‡å®šåˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•beançš„ç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»ºï¼Œåˆå§‹åŒ–ï¼Œä½¿ç”¨ï¼Œé”€æ¯ã€‚â€‹ å®¹å™¨ç®¡ç†beançš„ç”Ÿå‘½å‘¨æœŸï¼šæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰åˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•ï¼Œå®¹å™¨åœ¨beanè¿›è¡Œåˆ°å½“å‰ç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™ï¼Œæ¥è°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„åˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•ã€‚â€‹ å•ä¾‹æ¨¡å¼ï¼šå…ˆæ˜¯æ‰§è¡Œå¯¹è±¡çš„æ— å‚æ„é€ ï¼Œèµ‹å€¼åï¼Œæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ï¼Œåœ¨åˆ›å»ºå®¹å™¨çš„æ—¶å€™åŠ å…¥å¯¹è±¡ï¼Œåœ¨å®¹å™¨å…³é—­æ—¶ï¼Œæ‰§è¡Œé”€æ¯æ–¹æ³•ã€‚â€‹ å¤šä¾‹æ¨¡å¼ï¼šå…ˆåˆ›å»ºå®¹å™¨ï¼Œæ¯æ¬¡è°ƒç”¨å¯¹è±¡æ—¶ï¼Œè°ƒç”¨æ— å‚æ„é€ æ–¹æ³•ï¼Œèµ‹å€¼åï¼Œæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ã€‚å¯¹è±¡çš„é”€æ¯ç”±javaåƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ã€‚â€‹ 1.1 å•ä¾‹1234567891011121314151617181920@Data@AllArgsConstructorpublic class Person &#123; private Integer id; private String name ; public void init()&#123; System.out.println(&quot;init()...&quot;); &#125; public void destroy()&#123; System.out.println(&quot;destroy()...&quot;); &#125; public Person()&#123; System.out.println(&quot;constructor()....&quot;); &#125;&#125; 12345678@Configurationpublic class SpringConfig &#123; @Bean(value = &quot;person&quot;,initMethod = &quot;init&quot;,destroyMethod = &quot;destroy&quot;) public Person person()&#123; return new Person(); &#125;&#125; 12345678910111213@RunWith(SpringRunner.class)@ContextConfiguration(classes = &#123;SpringConfig.class&#125;)public class TestA &#123; @Autowired private ApplicationContext ioc; //constructor @Test public void test()&#123; Person person = ioc.getBean(&quot;person&quot;, Person.class); System.out.println(&quot;person = &quot; + person); &#125;&#125; 1.2 å¤šä¾‹12345678@Configurationpublic class SpringConfig &#123; @Scope(value = &quot;prototype&quot;) @Bean(value = &quot;person&quot;,initMethod = &quot;init&quot;,destroyMethod = &quot;destroy&quot;) public Person person()&#123; return new Person(); &#125;&#125; 2.å®ç°æ¥å£å®Œæˆå¯¹è±¡çš„åˆå§‹åŒ–å’Œé”€æ¯InitializingBean, DisposableBeanâ€‹ 1234567891011121314151617181920212223@Data@AllArgsConstructorpublic class Person implements InitializingBean, DisposableBean &#123; private Integer id; private String name ; public Person()&#123; System.out.println(&quot;constructor()....&quot;); &#125; @Override public void destroy() throws Exception &#123; System.out.println(&quot;destroy()....&quot;); &#125; @Override public void afterPropertiesSet() throws Exception &#123; System.out.println(&quot;afterPropertiesSet()....&quot;); &#125; &#125; 12345678@Configurationpublic class SpringConfig &#123; @Bean(value = &quot;person&quot;) public Person person()&#123; return new Person(); &#125;&#125; 1234567891011121314@RunWith(SpringRunner.class)@ContextConfiguration(classes = &#123;SpringConfig.class&#125;)public class TestA &#123; @Autowired private ApplicationContext ioc; //constructor @Test public void test()&#123; System.out.println(&quot;å®¹å™¨åˆ›å»ºæˆåŠŸï¼&quot;); Person person = ioc.getBean(&quot;person&quot;, Person.class); System.out.println(&quot;person = &quot; + person); &#125;&#125; 3.BeanPostProcessorbeançš„åç½®å¤„ç†å™¨ï¼Œåœ¨beançš„åˆå§‹åŒ–å‰ååšä¸€äº›å¤„ç†å·¥ä½œï¼Œéœ€è¦åŠ å…¥åˆ°å®¹å™¨ä¸­ã€‚â€‹ 1234567891011121314public class MyBeanPostProcessor implements BeanPostProcessor &#123; @Override public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123; System.out.println(&quot;åˆå§‹åŒ–å‰&quot;); return BeanPostProcessor.super.postProcessBeforeInitialization(bean, beanName); &#125; @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; System.out.println(&quot;åˆå§‹åŒ–å&quot;); return BeanPostProcessor.super.postProcessAfterInitialization(bean, beanName); &#125;&#125; 123456789@Configuration@Import(MyBeanPostProcessor.class)public class SpringConfig &#123; @Bean(value = &quot;person&quot;) public Person person()&#123; return new Person(); &#125;&#125; 4.BeanFactoryPostProcessorbeanå·¥å‚çš„åç½®å¤„ç†å™¨ï¼Œå¯ä»¥åœ¨springè§£æå®Œé…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºå¯¹è±¡ä¹‹å‰ï¼Œå¯¹beançš„å®šä¹‰ä¿¡æ¯è¿›è¡Œä¿®æ”¹ã€‚ 12345678910111213@Componentpublic class Computer &#123; String name; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125;&#125; 12345678910@Componentpublic class MyBeanFactoryPostProcessor implements BeanFactoryPostProcessor &#123; @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123; System.out.println(&quot;=======BeanFactoryPostProcessor=========&quot;); BeanDefinition person = beanFactory.getBeanDefinition(&quot;computer&quot;); person.setScope(BeanDefinition.SCOPE_PROTOTYPE); System.out.println(&quot;=======BeanFactoryPostProcessor=========&quot;); &#125;&#125; 123456789101112/** * é»˜è®¤Computerå¯¹è±¡æ˜¯å•å®ä¾‹çš„ï¼Œ * é€šè¿‡beanFactoryçš„åç½®å¤„ç†å™¨å¤„ç†ä¹‹åï¼Œå˜æˆåŸå‹çš„ * &lt;p&gt; * æ‰§è¡Œæ—¶æœºï¼šæ‰“æ–­ç‚¹ */private static void testBeanFactoryPostProcessor() &#123; /*iocå®¹å™¨åˆ›å»ºçš„12ä¸ªæ ¸å¿ƒæ–¹æ³•é‡Œé¢*/ Computer computer = ioc.getBean(Computer.class); Computer computer2 = ioc.getBean(Computer.class); System.out.println(computer == computer2);&#125; 5.BeanDefinitionRegistryPostProcessorä»–æ˜¯beanå·¥å‚åç½®å¤„ç†å™¨çš„å­ç±»æ’æ’­ä¸€æ¡å¹¿å‘Šï¼šBeanFactoryPostProcessorå’ŒBeanDefinitionRegistryPostProcessorä¹‹é—´çš„å…³ç³»ï¼ŸBeanDefinitionRegistryPostProcessor æ˜¯ BeanFactoryPostProcessorçš„å­ç±»å’Œæ‰©å±•å®ƒé‡Œé¢ æäº†ä¸€ä¸ªæ–°çš„æ–¹æ³• postProcessBeanDefinitionRegistry ï¼Œå¯ä»¥å¾€å®¹å™¨ä¸­æ³¨å†Œæ›´å¤šçš„bdä¿¡æ¯ã€‚æ‰©å±•ç‚¹ï¼šâ‘ BeanFactoryPostProcessor å¯¹bdä¿¡æ¯è¿›è¡Œä¿®æ”¹â‘¡postProcessBeanDefinitionRegistry æ·»åŠ æ›´å¤šçš„bdä¿¡æ¯ 12public class RegistryBean &#123;&#125; 123456789101112131415161718@Componentpublic class MyBeanDefinitionRegistryPostProcessor implements BeanDefinitionRegistryPostProcessor &#123; @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123; /*è¿™ä¸ªæ˜¯å¥¹çš„çˆ¶ç±»é‡Œé¢çš„æ–¹æ³• å¯¹ bdä¿¡æ¯è¿›è¡Œä¿®æ”¹*/ &#125; @Override public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException &#123; /*è¿™ä¸ªæ˜¯ç»™ä»–æœ¬èº«çš„æ–¹æ³•ï¼Œå¯ä»¥æ·»åŠ é¢å¤–çš„ bd ä¿¡æ¯*/ GenericBeanDefinition beanDefinition = new GenericBeanDefinition(); beanDefinition.setBeanClass(RegistryBean.class); //beanDefinition.setScope(); registry.registerBeanDefinition(&quot;registryBean&quot;,beanDefinition); &#125;&#125; 1234private static void testBeanDefinitionRegistryPostProcessor() &#123; RegistryBean registryBean = ioc.getBean(&quot;registryBean&quot;, RegistryBean.class); System.out.println(&quot;registryBean = &quot; + registryBean);&#125; 6.SmartInitializingSingletonåœ¨æ‰€æœ‰çš„å•å®ä¾‹bean é€šè¿‡getBeanæ–¹æ³•å®Œæˆåˆå§‹åŒ–ä¹‹å,å°±ä¼šå»æŸ¥æ‰¾è¿™ä¸ªç±»å‹çš„SmartInitializingSingleton çš„ ç»„ä»¶ ï¼Œæ‰§è¡Œé‡Œé¢çš„ æ–¹æ³•. 1234567@Componentpublic class MySmartInitializingSingleton implements SmartInitializingSingleton &#123; @Override public void afterSingletonsInstantiated() &#123; System.out.println(&quot;æ–­ç‚¹è°ƒè¯•ã€‚ã€‚ã€‚ã€‚&quot;); &#125;&#125; 7.Lifecycle &amp;&amp; SmartLifecycleå®¹å™¨åˆ›å»ºå®Œæˆä¹‹åçš„å›è°ƒï¼Œç›¸å½“äºä¼ é€’çš„å‚æ•°autoStartUpOnlyæ˜¯å¹²å˜›çš„ï¼Ÿè¡¨ç¤ºåªå¯åŠ¨SmartLifeCycleç”Ÿå‘½å‘¨æœŸå¯¹è±¡ï¼Œå¹¶ä¸”å¯åŠ¨çš„å¯¹è±¡autoStartUpOnlyå¿…é¡»æ˜¯trueï¼Œä¸ä¼šå¯åŠ¨æ™®é€šçš„ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ï¼Œfalseçš„æ—¶å€™ï¼Œä¼šå¯åŠ¨å…¨éƒ¨çš„ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ã€‚ 1234567891011121314151617181920public class DemoLifeCycle implements Lifecycle &#123; private boolean running =false; @Override public void start() &#123; this.running=true; System.out.println(&quot;demo one start!&quot;); &#125; @Override public void stop() &#123; this.running=false; System.out.println(&quot;demo one stop!&quot;); &#125; @Override public boolean isRunning() &#123; return running; &#125;&#125; 1234567891011121314151617181920public class DemoSmartLifeCycle implements SmartLifecycle &#123; private boolean running = false; @Override public void start() &#123; this.running=true; System.out.println(&quot;demo two start!&quot;); &#125; @Override public void stop() &#123; this.running=false; System.out.println(&quot;demo two stop!&quot;); &#125; @Override public boolean isRunning() &#123; return running; &#125;&#125; ä¸‰ï¼Œå±æ€§èµ‹å€¼1.Value@Valueæ³¨è§£å¯ä»¥ç»™å±æ€§èµ‹å€¼ï¼Œæ”¯æŒSPELè¡¨è¾¾å¼ï¼Œ${},,åŸºæœ¬æ•°å€¼ã€‚â€‹ 12345678910111213@Data@AllArgsConstructorpublic class Person &#123; @Value(&quot;1&quot;) private Integer id; @Value(&quot;äºŒå&quot;) private String name ; public Person()&#123; System.out.println(&quot;constructor()....&quot;); &#125; &#125; 2.PropertySource@PropertySourceåŠ è½½å¤–éƒ¨å±æ€§æ–‡ä»¶â€‹ æ”¯æŒä¸€æ¬¡å†™å¤šä¸ªï¼Œæ ‡æ³¨åœ¨é…ç½®ç±»ä¸Šã€‚â€‹ 12person.name=äºŒåperson.age=20 123456789@Data@AllArgsConstructor@NoArgsConstructorpublic class Person &#123; @Value(&quot;$&#123;person.age&#125;&quot;) private Integer id; @Value(&quot;$&#123;person.name&#125;&quot;) private String name ;&#125; 123456789@Configuration@PropertySource(&quot;classpath:person.properties&quot;)public class SpringConfig &#123; @Bean(value = &quot;person&quot;) public Person person()&#123; return new Person(); &#125;&#125; å››ï¼Œè‡ªåŠ¨è£…é…Springåˆ©ç”¨ä¾èµ–æ³¨å…¥DIï¼Œå®Œæˆå¯¹IOCå®¹å™¨ä¸­å„ä¸ªç»„ä»¶çš„ä¾èµ–å…³ç³»èµ‹å€¼ã€‚â€‹ 1.@Autowired &amp;&amp; @Qualifier &amp;&amp; @Primary é»˜è®¤ä¼˜å…ˆæŒ‰ç…§ç±»å‹å»å®¹å™¨ä¸­æ‰¾å¯¹åº”çš„ç»„ä»¶ï¼Œioc.getBean(BookDao.class); å¦‚æœæ‰¾åˆ°å¤šä¸ªç›¸åŒç±»å‹çš„ç»„ä»¶ï¼Œå†è®²å±æ€§çš„åç§°ä½œä¸ºç»„ä»¶çš„idå»å®¹å™¨ä¸­æŸ¥æ‰¾ioc.getBean(&quot;bookDao&quot;); @Qualifier(&quot;bookDao&quot;),ä½¿ç”¨@QualifieræŒ‡å®šè¦è£…é…çš„ç»„ä»¶çš„idï¼Œè€Œä¸æ˜¯ä½¿ç”¨å±æ€§å è‡ªåŠ¨è£…é…é»˜è®¤ä¸€å®šè¦å°†å±æ€§èµ‹å€¼å¥½ï¼Œæ²¡æœ‰å°±ä¼šæŠ¥é”™.å¯ä»¥ä½¿ç”¨@Autowiredï¼ˆrequired=falseï¼‰ @Primary è®©Springè¿›è¡Œè‡ªåŠ¨è£…é…çš„æ—¶å€™ï¼Œé»˜è®¤ä½¿ç”¨é¦–é€‰beanï¼Œä¹Ÿå¯ä»¥ç»§ç»­ä½¿ç”¨@QualifieræŒ‡å®šéœ€è¦è£…é…çš„beançš„id â€‹ 2.@Resource &amp;&amp; @Injectspringè¿˜æ”¯æŒä½¿ç”¨@Resourceï¼ˆjsr250ï¼‰å’Œ@injectï¼ˆjsr330ï¼‰ã€javaè§„èŒƒçš„æ³¨è§£ã€‘â€‹ @Resourceï¼šå¯ä»¥å’Œ@Autowiredä¸€æ ·å®ç°è‡ªåŠ¨è£…é…ï¼Œé»˜è®¤æŒ‰ç…§ç»„ä»¶åç§°è¿›è¡Œè£…é….ä¸æ”¯æŒ@Primaryå’Œrequired=falseâ€‹ @Injectï¼šéœ€è¦å¯¼å…¥javax.injectåŒ…ï¼Œæ²¡æœ‰required=falseâ€‹ 3.æ–¹æ³•ï¼Œæ„é€ å™¨ä½ç½®çš„è‡ªåŠ¨æ³¨å…¥@Autowiredï¼šæ„é€ å™¨ï¼Œå‚æ•°ï¼Œæ–¹æ³•ï¼Œå±æ€§ï¼Œéƒ½æ˜¯ä»å®¹å™¨ä¸­è·å–å‚æ•°ç»„ä»¶çš„å€¼ã€‚ æ ‡æ³¨åœ¨æ–¹æ³•ä¸Šï¼š@Bean+æ–¹æ³•å‚æ•°ï¼Œå‚æ•°ä»å®¹å™¨ä¸­è·å–ï¼Œé»˜è®¤ä¸å†™@Autowiredæ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œéƒ½èƒ½è‡ªåŠ¨è£…é… æ ‡åœ¨æ„é€ å™¨ä¸Šï¼šå¦‚æœç»„ä»¶åªæœ‰ä¸€ä¸ªæ„é€ å™¨ï¼Œè¿™ä¸ªæœ‰å‚æ„é€ å™¨çš„@Autowiredå¯ä»¥çœç•¥ æ”¾åœ¨å‚æ•°ä½ç½® â€‹ 3.1 æ„é€ å™¨æ³¨å…¥12345678@Component@Data@AllArgsConstructor@NoArgsConstructorpublic class Person &#123; private Integer id; private String name ;&#125; 12345678910111213@Component@Data@NoArgsConstructorpublic class Dog &#123; private Person person; @Autowired //æ­¤å¤„æ³¨è§£å¯ä»¥çœç•¥ private Dog(Person person)&#123; this.person=person; &#125;&#125; 12345678910111213@RunWith(SpringRunner.class)@ContextConfiguration(classes = &#123;SpringConfig.class&#125;)public class TestA &#123; @Autowired private ApplicationContext ioc; //constructor @Test public void test()&#123; Dog dog = ioc.getBean(&quot;dog&quot;, Dog.class); System.out.println(&quot;dog = &quot; + dog); &#125;&#125; 3.2 set()æ³¨å…¥12345678910111213@Component@Data@NoArgsConstructorpublic class Dog &#123; private Person person; @Autowired //æ­¤å¤„çš„æ³¨è§£ä¸èƒ½çœç•¥ public void setPerson(Person person)&#123; this.person=person; &#125;&#125; 3.3 @Beançš„æ–¹å¼123456789101112131415@Configurationpublic class SpringConfig &#123; @Bean(value = &quot;person&quot;) public Person person() &#123; return new Person(); &#125; @Bean(value = &quot;dog&quot;) @Autowired //æ­¤å¤„çš„æ³¨è§£å¯ä»¥çœç•¥ä¸å†™ public Dog dog(Person person) &#123; return new Dog(person); &#125;&#125; 4.Awareæ¥å£ï¼Œè‡ªå®šä¹‰ç»„ä»¶ä½¿ç”¨Springåº•å±‚çš„ç»„ä»¶è‡ªå®šä¹‰æ¥å£æƒ³è¦ä½¿ç”¨Springåº•å±‚çš„ä¸€äº›ç»„ä»¶ï¼ˆApplicationContextï¼ŒBeanFactoryï¼Œxxxï¼‰â€‹ è‡ªå®šä¹‰æ¥å£å®ç°xxxAwareï¼Œåœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨æ¥å£è§„å®šçš„æ–¹æ³•æ³¨å…¥ç›¸å…³ç»„ä»¶ï¼ŒAwareå§Springåº•å±‚çš„ä¸€äº›æ¥å£æ³¨å…¥åˆ°è‡ªå®šä¹‰çš„Beanä¸­â€‹ xxxAwareï¼šåŠŸèƒ½ï¼šä½¿ç”¨xxxProcessorâ€‹ ApplicationContextAware--&gt;ApplicationContextAwareProcessorâ€‹ 1234567891011121314151617@Componentpublic class Dog implements ApplicationContextAware, BeanFactoryAware &#123; private ApplicationContext ioc; private BeanFactory beanFactory; @Override public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123; //è‡ªæ­¤å¤„æ‰“æ–­ç‚¹ this.ioc=applicationContext; &#125; @Override public void setBeanFactory(BeanFactory beanFactory) throws BeansException &#123; //æ­¤å¤„æ‰“æ–­ç‚¹ this.beanFactory=beanFactory; &#125;&#125; 5.@Profileæ ¹æ®ç¯å¢ƒè£…é…@Profile:æŒ‡å®šç»„ä»¶åœ¨é‚£ä¸ªç¯å¢ƒçš„æƒ…å†µä¸‹æ‰èƒ½è¢«æ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œä¸æŒ‡å®šï¼Œä»»ä½•ç¯å¢ƒä¸‹éƒ½èƒ½æ³¨å†Œè¿™ä¸ªç»„ä»¶ åŠ äº†ç¯å¢ƒæ ‡è¯†çš„beanï¼Œåªæœ‰è¿™ä¸ªç¯å¢ƒè¢«æ¿€æ´»çš„æ—¶å€™æ‰èƒ½æ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œé»˜è®¤æ˜¯defaultç¯å¢ƒ å†™åœ¨é…ç½®ç±»ä¸Šï¼Œåªæœ‰æ˜¯æŒ‡å®šçš„ç¯å¢ƒçš„æ—¶å€™ï¼Œæ•´ä¸ªé…ç½®ç±»é‡Œé¢çš„æ‰€æœ‰é…ç½®æ‰èƒ½å¼€å§‹ç”Ÿæ•ˆ æ²¡æœ‰æ ‡è¯†ç¯å¢ƒæ ‡è¯†çš„beanåœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½æ˜¯åŠ è½½çš„ã€‚ â€‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748@Configuration@PropertySource(&quot;classpath:jdbc.properties&quot;)public class SpringConfig implements EmbeddedValueResolverAware &#123; @Value(&quot;$&#123;jdbc.username&#125;&quot;) private String name; private StringValueResolver resolver; private String driver; @Profile(&quot;dev&quot;) @Bean(&quot;dev&quot;) public DataSource dataSource1(@Value(&quot;$&#123;jdbc.password&#125;&quot;) String pwd)&#123; DruidDataSource source = new DruidDataSource(); source.setName(name); source.setPassword(pwd); source.setDriverClassName(driver); source.setUrl(&quot;jdbc:mysql:///test&quot;); return source; &#125; @Profile(&quot;pro&quot;) @Bean(&quot;pro&quot;) public DataSource dataSource2(@Value(&quot;$&#123;jdbc.password&#125;&quot;) String pwd)&#123; DruidDataSource source = new DruidDataSource(); source.setName(name); source.setPassword(pwd); source.setDriverClassName(driver); source.setUrl(&quot;jdbc:mysql:///ssm&quot;); return source; &#125; @Profile(&quot;test&quot;) @Bean(&quot;test&quot;) public DataSource dataSource3(@Value(&quot;$&#123;jdbc.password&#125;&quot;) String pwd)&#123; DruidDataSource source = new DruidDataSource(); source.setName(name); source.setPassword(pwd); source.setDriverClassName(driver); source.setUrl(&quot;jdbc:mysql:///zuoye&quot;); return source; &#125; @Override public void setEmbeddedValueResolver(StringValueResolver resolver) &#123; this.resolver=resolver; driver = resolver.resolveStringValue(&quot;$&#123;jdbc.driverClassName&#125;&quot;); &#125;&#125; æ¿€æ´»ç¯å¢ƒï¼š ä½¿ç”¨å‘½ä»¤è¡ŒåŠ¨æ€å‚æ•°ï¼šåœ¨è™šæ‹Ÿæœºå‚æ•°ä½ç½®åŠ è½½ï¼š -Dspring.profiles.active=test ä»£ç æ–¹å¼æ¿€æ´» â€‹ 123456789101112@Testpublic void test() &#123; AnnotationConfigApplicationContext ioc = new AnnotationConfigApplicationContext(); ioc.getEnvironment().setActiveProfiles(&quot;dev&quot;); ioc.register(SpringConfig4.class); ioc.refresh(); String[] names = ioc.getBeanNamesForType(DataSource.class); for (String name : names) &#123; System.out.println(name); &#125;&#125; äº”ï¼Œäº‹ä»¶é©±åŠ¨1.ApplicationListener &amp;&amp; ApplicationEventé€šè¿‡è‡ªå®šä¹‰ä¸åŒç±»å‹çš„äº‹ä»¶ï¼Œä½¿ç”¨ä¸åŒçš„ç›‘å¬å™¨ç›‘å¬ä¸åŒç±»å‹çš„äº‹ä»¶ï¼Œåšåˆ°jvmè¿›ç¨‹å†…çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œäº‹ä»¶é©±åŠ¨ï¼Œè§£è€¦ã€‚ 1234567891011121314151617public class MyEvent extends ApplicationEvent &#123; String message; public MyEvent(Object source) &#123; super(source); &#125; public MyEvent(Object source,String message) &#123; super(source); this.message=message; &#125; public void print()&#123; System.out.println(&quot;å‘å¸ƒäº†ä¸€ä¸ªäº‹ä»¶ï¼š&quot;+message); &#125;&#125; 12345678public class MyListener implements ApplicationListener&lt;MyEvent&gt; &#123; @Override public void onApplicationEvent(MyEvent event) &#123; event.print(); &#125;&#125; 1234567/** * æµ‹è¯•spring çš„ ioc å®¹å™¨çš„äº‹ä»¶å‘å¸ƒ */private static void testPublishEvent() &#123; ApplicationContext ioc = new ClassPathXmlApplicationContext(CONFIG_LOCATION); ioc.publishEvent(new MyEvent(&quot;&quot;, &quot;è¿™æ˜¯æˆ‘è‡ªå®šä¹‰çš„ä¸€ä¸ªäº‹ä»¶&quot;));&#125; 2.@EventListenerå¯¹ä¸Šé¢å†™æ³•çš„ä¸€ä¸ªä¼˜åŒ–ï¼Œæ›´åŠ ç®€æ´ï¼Œå¼€å‘é‡æ›´å°‘ï¼Œæ‡’äººå¿…å¤‡ç¥å™¨ã€‚ 12345678private static void testEventListener() &#123; ioc.publishEvent(new ApplicationEvent(&quot;helloï¼Œspring&quot;) &#123; @Override public Object getSource() &#123; return super.getSource(); &#125; &#125;);&#125; 12345678@Componentpublic class MyEventListener &#123; @EventListener(classes = ApplicationEvent.class) public void listener(ApplicationEvent event)&#123; System.out.println(&quot;event = &quot; + event); &#125;&#125;","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[ä¸ƒ]initializeBean()","slug":"Spring/Spring[ä¸ƒ]initializeBean()","date":"2022-01-11T05:59:43.828Z","updated":"2022-01-11T06:09:21.774Z","comments":true,"path":"2022/01/11/Spring/Spring[ä¸ƒ]initializeBean()/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E4%B8%83]initializeBean()/","excerpt":"","text":"ä¸Šä¸€ç¯‡åˆ†æäº†å•å®ä¾‹beanåˆ›å»ºè¿‡ç¨‹ä¸­çš„å±æ€§èµ‹å€¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æï¼Œå•å®ä¾‹beanå±æ€§èµ‹å€¼ä¹‹åçš„åˆå§‹åŒ–**initializeBean()**ã€‚ 1. initializeBean()123456789101112131415161718192021222324252627protected Object initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) &#123; /*æ£€æŸ¥å½“å‰beanæ˜¯å¦å®ç°äº†awareæ¥å£ï¼Œå†å…·ä½“åˆ¤æ–­å®ç°çš„å“ªä¸ªawareæ¥å£ï¼Œåšä¸€äº›èµ‹èƒ½æ“ä½œã€‚*/ invokeAwareMethods(beanName, bean); Object wrappedBean = bean; if (mbd == null || !mbd.isSynthetic()) &#123; /*åˆå§‹åŒ–ä¹‹å‰ï¼Œåç½®å¤„ç†å™¨çš„è°ƒç”¨ç‚¹*/ wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); &#125; try &#123; /*æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•*/ invokeInitMethods(beanName, wrappedBean, mbd); &#125; catch (Throwable ex) &#123; throw new BeanCreationException( (mbd != null ? mbd.getResourceDescription() : null), beanName, &quot;Invocation of init method failed&quot;, ex); &#125; if (mbd == null || !mbd.isSynthetic()) &#123; /*åˆå§‹åŒ–åçš„åç½®å¤„ç†å™¨æ‰§è¡Œç‚¹*/ /*å…¸å‹åº”ç”¨ï¼šAOPçš„å…·ä½“å®ç°*/ wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); &#125; return wrappedBean;&#125; åœ¨åˆå§‹åŒ–ä¹‹å‰ï¼ŒæŠŠå½“å‰beanå®ç°çš„æ‰€æœ‰Awareæ¥å£éƒ½æ‰§è¡Œä¸€éã€‚**invokeAwareMethods()**åœ¨åˆå§‹åŒ–ä¹‹å‰ï¼Œè°ƒç”¨åç½®å¤„ç†å™¨ã€‚**applyBeanPostProcessorsBeforeInitialization()**æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ã€‚**invokeInitMethods()**æ‰§è¡Œåç½®å¤„ç†å™¨çš„è°ƒç”¨ç‚¹ï¼Œå…¸å‹çš„å®ç°å…¶å®å°±æ˜¯AOPã€‚**applyBeanPostProcessorsAfterInitialization()**è¿”å›åŒ…è£…å¯¹è±¡ã€‚â€‹ 2.invokeAwareMethods()12345678910111213141516private void invokeAwareMethods(String beanName, Object bean) &#123; if (bean instanceof Aware) &#123; if (bean instanceof BeanNameAware) &#123; ((BeanNameAware) bean).setBeanName(beanName); &#125; if (bean instanceof BeanClassLoaderAware) &#123; ClassLoader bcl = getBeanClassLoader(); if (bcl != null) &#123; ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl); &#125; &#125; if (bean instanceof BeanFactoryAware) &#123; ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.this); &#125; &#125;&#125; æ‰§è¡Œç›¸å…³çš„Awareæ¥å£æ–¹æ³•ã€‚ 3.applyBeanPostProcessorsBeforeInitialization()â€‹ 123456789101112131415@Overridepublic Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName) throws BeansException &#123; Object result = existingBean; /*beanPostProcessorçš„æ‰§è¡Œé€»è¾‘*/ for (BeanPostProcessor processor : getBeanPostProcessors()) &#123; Object current = processor.postProcessBeforeInitialization(result, beanName); if (current == null) &#123; return result; &#125; result = current; &#125; return result;&#125; å¾ªç¯æ‰€æœ‰çš„åç½®å¤„ç†å™¨ï¼Œæ‰§è¡Œå‰ç½®æ–¹æ³•ï¼Œå¦‚æœæœ‰ä¸€ä¸ªè¿”å›ç»“æœä¸ºç©ºï¼Œç›´æ¥çŸ­è·¯ï¼Œåé¢çš„éƒ½ä¸æ‰§è¡Œäº†ã€‚â€‹ 4.invokeInitMethods()1234567891011121314151617181920212223protected void invokeInitMethods(String beanName, Object bean, @Nullable RootBeanDefinition mbd) throws Throwable &#123; /*å¦‚æœæ˜¯å®ç°äº†InitializingBeanæ¥å£*/ boolean isInitializingBean = (bean instanceof InitializingBean); if (isInitializingBean &amp;&amp; (mbd == null || !mbd.isExternallyManagedInitMethod(&quot;afterPropertiesSet&quot;))) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; /*æ‰§è¡ŒafterPropertiesSetæ–¹æ³•*/ ((InitializingBean) bean).afterPropertiesSet(); &#125; if (mbd != null &amp;&amp; bean.getClass() != NullBean.class) &#123; /*åˆ¤æ–­é‡å†™initæ–¹æ³•æ²¡ï¼Ÿ*/ String initMethodName = mbd.getInitMethodName(); if (StringUtils.hasLength(initMethodName) &amp;&amp; !(isInitializingBean &amp;&amp; &quot;afterPropertiesSet&quot;.equals(initMethodName)) &amp;&amp; !mbd.isExternallyManagedInitMethod(initMethodName)) &#123; /*æ‰§è¡Œé‡å†™çš„initæ–¹æ³•*/ invokeCustomInitMethod(beanName, bean, mbd); &#125; &#125;&#125; åˆ¤æ–­å®ç°äº†**InitializingBean**æ¥å£çš„ï¼Œæ‰§è¡Œé‡Œé¢çš„æ–¹æ³•ã€‚åˆ¤æ–­é‡å†™äº†åˆå§‹åŒ–æ–¹æ³•çš„ï¼Œæ‰§è¡Œé‡å†™çš„æ–¹æ³•ã€‚ 4.1 invokeCustomInitMethod()1234567891011121314151617181920212223242526272829303132333435363738394041424344protected void invokeCustomInitMethod(String beanName, Object bean, RootBeanDefinition mbd) throws Throwable &#123; /*ä»bdè·å–initæ–¹æ³•*/ String initMethodName = mbd.getInitMethodName(); Assert.state(initMethodName != null, &quot;No init method set&quot;); /* * isNonPublicAccessAllowed éå…¬å¼€è®¿é—® * * è¿™é‡Œå®Œæˆä¹‹åå°±ä¼šè·å–åˆ°é€šè¿‡initæ–¹æ³•å®šä¹‰çš„æ–¹æ³•å¯¹è±¡ã€‚ * */ Method initMethod = (mbd.isNonPublicAccessAllowed() ? BeanUtils.findMethod(bean.getClass(), initMethodName) : ClassUtils.getMethodIfAvailable(bean.getClass(), initMethodName)); /*å¦‚æœinitæ–¹æ³•ä¸ºç©º*/ if (initMethod == null) &#123; if (mbd.isEnforceInitMethod()) &#123; throw new BeanDefinitionValidationException(&quot;Could not find an init method named &#x27;&quot; + initMethodName + &quot;&#x27; on bean with name &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; else &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;No default init method named &#x27;&quot; + initMethodName + &quot;&#x27; found on bean with name &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; // Ignore non-existent default lifecycle methods. return; &#125; &#125; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Invoking init method &#x27;&quot; + initMethodName + &quot;&#x27; on bean with name &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; /*å°†initæ–¹æ³•è½¬æ¢æˆæ¥å£å±‚é¢è·å–çš„initMethod*/ Method methodToInvoke = ClassUtils.getInterfaceMethodIfPossible(initMethod); try &#123; /*åå°„æ‰§è¡Œæ–¹æ³•*/ ReflectionUtils.makeAccessible(methodToInvoke); methodToInvoke.invoke(bean); &#125; catch (InvocationTargetException ex) &#123; throw ex.getTargetException(); &#125;&#125; ç»è¿‡ä¸€äº›åˆ—å¤„ç†ï¼Œåå°„è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ã€‚ 5.applyBeanPostProcessorsAfterInitialization()1234567891011121314151617@Overridepublic Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException &#123; Object result = existingBean; for (BeanPostProcessor processor : getBeanPostProcessors()) &#123; Object current = processor.postProcessAfterInitialization(result, beanName); /*æ³¨æ„ï¼š * ä¸€æ—¦æŸä¸ªåç½®å¤„ç†å™¨è¿”å›çš„ç»“æœä¸ºç©º * å°±è¿”å›ä¸Šä¸€ä¸ªåç½®å¤„ç†å™¨çš„ç»“æœï¼Œåé¢çš„åç½®å¤„ç†å™¨æ–¹æ³•ä¸åœ¨æ‰§è¡Œ*/ if (current == null) &#123; return result; &#125; result = current; &#125; return result;&#125; åˆå§‹åŒ–ä¹‹åï¼Œéå†æ‰€æœ‰çš„åç½®å¤„ç†å™¨ï¼Œæ‰§è¡Œåç½®å¤„ç†å™¨çš„åç½®æ–¹æ³•ï¼Œå¦‚æœæœ‰ä¸€ä¸ªè¿”å›ç»“æœæ˜¯ç©ºï¼Œç›´æ¥è¿”å›ï¼Œåé¢çš„åç½®å¤„ç†å™¨éƒ½ä¸æ‰§è¡Œäº†ã€‚â€‹ è‡³æ­¤ï¼Œæ•´ä¸ªiocå®¹å™¨çš„åˆ·æ–°æµç¨‹å°±éƒ½åˆ†æå®Œäº†ï¼Œé‡ç‚¹å°±åœ¨äºå•å®ä¾‹beançš„åˆ›å»ºæµç¨‹ï¼Œé¦–å…ˆä¼šå»**getBean() doGetBean() getSinglton() createBean() doCreateBean() populateBean() initializeBean()**ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†ä¼šå»åˆ†æSpringçš„ä¸‰çº§ç¼“å­˜å’Œå¾ªç¯ä¾èµ–ã€‚","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[å…­]populateBean()","slug":"Spring/Spring[å…­]populateBean()","date":"2022-01-11T05:59:34.475Z","updated":"2022-01-11T06:09:48.766Z","comments":true,"path":"2022/01/11/Spring/Spring[å…­]populateBean()/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E5%85%AD]populateBean()/","excerpt":"","text":"åœ¨ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬åˆ†æå®Œäº†**createBean()**ï¼Œå¹¶è¯¦è§£è®²è§£äº†ä¸‰ä¸­åˆ›å»ºå•å®ä¾‹beanå¯¹è±¡çš„æ–¹æ³•ï¼Œåœ¨beanå®ä¾‹åˆ›å»ºå‡ºæ¥ä¹‹åï¼Œå°±æ˜¯å¯¹beançš„å±æ€§èµ‹å€¼å’Œåˆå§‹åŒ–æ“ä½œï¼Œæœ¬ç¯‡æˆ‘ä»¬ç»§ç»­å¾€ä¸‹åˆ†æã€‚ 1.populateBean()1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) &#123; /*è¿™é‡Œæ˜¯åˆ¤æ–­å‡å¦‚beanWrapperæ˜¯ç©ºï¼Œä½†æ˜¯mbdä¸­çš„å±æ€§è¿˜æœ‰å€¼ï¼Œé‚£å°±è¯´æ˜éœ€è¦æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºæ²¡æ³•ç»™ä¸€ä¸ªnullèµ‹å€¼ã€‚*/ if (bw == null) &#123; if (mbd.hasPropertyValues()) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Cannot apply property values to null instance&quot;); &#125; else &#123; // Skip property population phase for null instance. return; &#125; &#125; /*åœ¨è®¾ç½®å±æ€§ä¹‹å‰ï¼Œç»™ä»»ä½•å®ä¾‹åŒ–çš„beanåå¤„ç†å™¨ä¿®æ”¹beançŠ¶æ€çš„æœºä¼šã€‚ä¾‹å¦‚ï¼Œè¿™å¯ä»¥ç”¨æ¥æ”¯æŒå„ç§ç±»å‹çš„å±æ€§æ³¨å…¥ã€‚*/ /* * mbd.isSynthetic()é»˜è®¤æ˜¯falseï¼Œå–åæˆç«‹ã€‚ * åˆ¤æ–­æœ‰æ²¡æœ‰instantiationAwareBeanPostProcessorsï¼Œæ¡ä»¶æˆç«‹è¯´æ˜æœ‰ã€‚ */ if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123; /*è¿™é‡Œåˆæ˜¯åç½®å¤„ç†å™¨çš„ä¸€ä¸ªè°ƒç”¨ç‚¹ï¼šå®ä¾‹åŒ–ä¹‹åçš„è°ƒç”¨ï¼Œè°ƒç”¨çš„æ˜¯åç½®å¤„ç†å™¨çš„afterInstantiationæ–¹æ³•ã€‚*/ for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123; /*è¿”å›å€¼å°†å†³å®šå½“å‰å®ä¾‹éœ€è¦åœ¨è¿›è¡Œä¾èµ–æ³¨å…¥å¤„ç†ï¼Œé»˜è®¤è¿”å›true*/ if (!bp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123; return; &#125; &#125; &#125; /*ä¸‹é¢æ˜¯å¤„ç†ä¾èµ–æ³¨å…¥çš„é€»è¾‘*/ /*ä¸‰å…ƒè¿ç®—ç¬¦è·å–å±æ€§ï¼Œæœ‰å°±æŠŠå±æ€§èµ‹å€¼ç»™pvs ï¼Œæ²¡æœ‰å°±ç»™ä¸€ä¸ªnull*/ PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null); int resolvedAutowireMode = mbd.getResolvedAutowireMode(); /*è¿™é‡Œåˆ¤æ–­ä¾èµ–æ³¨å…¥æ˜¯æŒ‰ç…§åå­—æ³¨å…¥è¿˜æ˜¯æŒ‰ç…§ç±»å‹æ³¨å…¥ï¼Œæ ¹æ®ä¸åŒçš„é€‰æ‹©èµ°ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚*/ if (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123; /*å§å±æ€§è¿›è¡Œä¸€ä¸ªåŒ…è£…*/ MutablePropertyValues newPvs = new MutablePropertyValues(pvs); // Add property values based on autowire by name if applicable. /*æŒ‰ç…§åå­—æ³¨å…¥ï¼Œæ ¹æ®å­—æ®µåç§°æŸ¥æ‰¾ä¾èµ–beanå®Œæˆæ³¨å…¥*/ if (resolvedAutowireMode == AUTOWIRE_BY_NAME) &#123; autowireByName(beanName, mbd, bw, newPvs); &#125; // Add property values based on autowire by type if applicable. /*æŒ‰ç…§ç±»å‹æ³¨å…¥*/ if (resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123; autowireByType(beanName, mbd, bw, newPvs); &#125; /*ç›¸å½“äºå¤„ç†äº†ä¾èµ–æ•°æ®åçš„pvs*/ pvs = newPvs; &#125; /*è¡¨ç¤ºå½“å‰æ˜¯å¦æ‹¥æœ‰instantiationAwareBeanPostProcessorséœ€è¦æ‰§è¡Œ*/ boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors(); /*æ˜¯å¦éœ€è¦è¿›è¡Œä¾èµ–æ£€å¯Ÿï¼Œä¸é‡è¦*/ boolean needsDepCheck = (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE); PropertyDescriptor[] filteredPds = null; if (hasInstAwareBpps) &#123; if (pvs == null) &#123; pvs = mbd.getPropertyValues(); &#125; /*åç½®å¤„ç†å™¨çš„è°ƒç”¨ç‚¹*/ for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123; /*å…¸å‹åº”ç”¨ï¼š@Autowired æ³¨è§£çš„æ³¨å…¥*/ PropertyValues pvsToUse = bp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName); if (pvsToUse == null) &#123; if (filteredPds == null) &#123; filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching); &#125; pvsToUse = bp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName); if (pvsToUse == null) &#123; return; &#125; &#125; pvs = pvsToUse; &#125; &#125; if (needsDepCheck) &#123; if (filteredPds == null) &#123; filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching); &#125; checkDependencies(beanName, mbd, filteredPds, pvs); &#125; if (pvs != null) &#123; /*å°†å®Œæˆä¾èµ–æ³¨å…¥ï¼ˆåˆå¹¶åçš„pvsï¼‰çš„ä¿¡æ¯åº”ç”¨åˆ°å®ä¾‹ä¸Šå»*/ /** * 1.å¯¹manè¿›è¡Œå±æ€§èµ‹å€¼çš„è¿‡ç¨‹ * 2.å¯¹womenè¿›è¡Œå±æ€§èµ‹å€¼ */ applyPropertyValues(beanName, mbd, bw, pvs); &#125;&#125; \u0000 ä¸Šæ¥ä¸€å¥—ç»„åˆæ‹³ï¼Œå…ˆåˆ¤æ–­å‡å¦‚beanåŒ…è£…å¯¹è±¡æ˜¯ç©ºçš„ï¼Œä½†æ˜¯mbdä¸­çš„å±æ€§è¿˜æœ‰å€¼ï¼Œé‚£å°±è¯´æ˜éœ€è¦æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºæ²¡æ³•ç»™ä¸€ä¸ªnullèµ‹å€¼ã€‚ æ¥ä¸‹æ¥å°±æ˜¯åœ¨å±æ€§èµ‹å€¼ä¹‹å‰ï¼Œç»™ä»»ä½•å®ä¾‹åŒ–çš„beanåç½®å¤„ç†å™¨ä¿®æ”¹beançŠ¶æ€çš„æœºä¼šã€‚ä¾‹å¦‚ï¼Œè¿™å¯ä»¥ç”¨æ¥æ”¯æŒå„ç§ç±»å‹çš„å±æ€§æ³¨å…¥ã€‚**InstantiationAwareBeanPostProcessors** è¿™é‡Œåˆæ˜¯ä¸€ä¸ªåç½®å¤„ç†å™¨çš„è°ƒç”¨ç‚¹ï¼Œå®ä¾‹åŒ–ä¹‹åçš„è°ƒç”¨ï¼Œè°ƒç”¨çš„æ˜¯åç½®å¤„ç†å™¨çš„**afterInstantiation**æ–¹æ³•ã€‚è¿™ä¸ªå¤„ç†å™¨çš„è¿”å›å€¼å°†å†³å®šå½“å‰beanå®ä¾‹æ˜¯å¦è¦è¿›è¡Œå±æ€§æ³¨å…¥ï¼Œè¿”å›falseåˆ™è¡¨ç¤ºç›´æ¥è¿”å›ï¼Œé»˜è®¤è¿”å›trueã€‚\u0000 åˆ¤æ–­ä¾èµ–æ³¨å…¥æŒ‰ç…§åå­—æ³¨å…¥è¿˜æ˜¯æŒ‰ç…§ç±»å‹æ³¨å…¥ï¼Œæ ¹æ®ä¸åŒçš„é€‰æ‹©èµ°ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚æ³¨æ„è¿™é‡Œçš„å¤„ç†å¹¶ä¸æ˜¯ç›´æ¥æ³¨å…¥åˆ°beanä¸­ï¼Œè€Œæ˜¯è§£æåˆ°pvsä¸­ã€‚ ä»€ä¹ˆæ—¶å€™èµ°è¿™é‡Œï¼Ÿå¿…é¡»æ˜¾å¼çš„æŒ‡å®šäº†é…ç½®äº†ä¾èµ–ï¼Œæ‰ä¼šèµ°è¿™é‡Œã€‚ å¦‚æœæ˜¯æŒ‰ç…§åå­—æ³¨å…¥ï¼Œå°±æ‰§è¡Œ**autowireByName()**ã€‚ å¦‚æœæ˜¯æŒ‰ç…§ç±»å‹æ³¨å…¥ï¼Œå°±æ‰§è¡Œ**autowireByType()**ã€‚ â€‹ åˆ¤æ–­å½“å‰æ˜¯å¦è¿˜æœ‰**InstantiationAwareBeanPostProcessors**éœ€è¦æ‰§è¡Œã€‚ åˆ¤æ–­å½“å‰æ˜¯å¦éœ€è¦è¿›è¡Œä¾èµ–æ£€æŸ¥ã€ å¦‚æœè¿˜æœ‰**InstantiationAwareBeanPostProcessors**éœ€è¦æ‰§è¡Œï¼Œå¾ªç¯æ‰§è¡Œåç½®å¤„ç†å™¨çš„æ–¹æ³• å¦‚æœéœ€è¦ä¾èµ–æ£€æŸ¥ï¼Œå°±èµ°ä¾èµ–æ£€æŸ¥çš„é€»è¾‘ å¦‚æœåˆå¹¶åçš„ä¾èµ–ä¿¡æ¯ï¼ˆpvsï¼‰ä¸ä¸ºç©ºï¼Œå°±æ‰§è¡Œ**applyPropertyValues()**è¿›è¡Œå±æ€§èµ‹å€¼ã€‚ â€‹ æ¥ä¸‹æ¥åˆ†æä¸¤ç§å±æ€§æ³¨å…¥çš„æ–¹å¼ï¼ŒæŒ‰ç…§åå­—æ³¨å…¥&amp;æŒ‰ç…§ç±»å‹æ³¨å…¥ã€‚ 2.autowireByName()\u0000 1234567891011121314151617181920212223242526protected void autowireByName( String beanName, AbstractBeanDefinition mbd, BeanWrapper bw, MutablePropertyValues pvs) &#123; /*beanå®ä¾‹ä¸­æœ‰è¯¥å­—æ®µï¼Œä¸”æœ‰è¯¥å­—æ®µçš„setteræ–¹æ³•ï¼Œä½†æ˜¯åœ¨bdä¸­æ²¡æœ‰propertyå±æ€§ã€‚*/ String[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw); /*ä¾¿åˆ©æŸ¥æ‰¾å‡ºæ¥çš„é›†åˆï¼Œå®Œæˆä¾èµ–æ³¨å…¥ã€‚*/ for (String propertyName : propertyNames) &#123; /*æ¡ä»¶æˆç«‹è¯´æ˜beanFactoryå­˜åœ¨å½“å‰å±æ€§çš„beanå®ä¾‹ï¼Œå¯ä»¥æ³¨å…¥ï¼Œè¯´æ˜æ‰¾åˆ°å¯¹åº”çš„ä¾èµ–ä¿¡æ¯æ•°æ®äº†*/ if (containsBean(propertyName)) &#123; /*æ‹¿åˆ°å±æ€§æ‰€å¯¹åº”çš„beanå®ä¾‹*/ Object bean = getBean(propertyName); /*åœ¨å±æ€§é‡Œé¢è¿½åŠ ä¸€ä¸ªproperty*/ pvs.add(propertyName, bean); /*ç®¡ç†ä¾èµ–ä¿¡æ¯*/ registerDependentBean(propertyName, beanName); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Added autowiring by name from bean name &#x27;&quot; + beanName + &quot;&#x27; via property &#x27;&quot; + propertyName + &quot;&#x27; to bean named &#x27;&quot; + propertyName + &quot;&#x27;&quot;); &#125; &#125; else &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Not autowiring property &#x27;&quot; + propertyName + &quot;&#x27; of bean &#x27;&quot; + beanName + &quot;&#x27; by name: no matching bean found&quot;); &#125; &#125; &#125;&#125; æ€»ç»“ï¼šautowireByNameä¸»è¦å®Œæˆä»¥ä¸‹é€»è¾‘ï¼šâ€‹ è·å–éœ€è¦å¡«å……å¯¹è±¡å¾—éç®€å•ç±»å‹å¾—å±æ€§åï¼› éå†ç¬¬ä¸€æ­¥è·å–å¾—å±æ€§åï¼Œè°ƒç”¨getBeanæ–¹æ³•ä»å®¹å™¨ä¸­è·å–æ­¤å±æ€§åå¯¹åº”çš„objectï¼› ç„¶åï¼Œå¦‚æœèƒ½æ‰¾åˆ°ï¼Œåˆ™æŠŠæ­¤å±æ€§åå’Œobjectå¯¹è±¡ä¿å­˜åˆ°pvsçš„propertyValueListé‡Œé¢ã€‚ 3.autowireByType()\u0000 12345678910111213141516171819202122232425262728293031323334353637383940414243444546protected void autowireByType( String beanName, AbstractBeanDefinition mbd, BeanWrapper bw, MutablePropertyValues pvs) &#123; /*è·å–ç±»å‹è½¬æ¢å™¨*/ TypeConverter converter = getCustomTypeConverter(); if (converter == null) &#123; converter = bw; &#125; Set&lt;String&gt; autowiredBeanNames = new LinkedHashSet&lt;&gt;(4); /*æ‹¿åˆ°å±æ€§ä¿¡æ¯ï¼Œå¾ªç¯éå†*/ String[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw); for (String propertyName : propertyNames) &#123; try &#123; PropertyDescriptor pd = bw.getPropertyDescriptor(propertyName); // Don&#x27;t try autowiring by type for type Object: never makes sense, // even if it technically is a unsatisfied, non-simple property. /*å¦‚æœä¸æ˜¯Objectç±»å‹*/ if (Object.class != pd.getPropertyType()) &#123; /*æ‹¿åˆ°setteræ–¹æ³•*/ MethodParameter methodParam = BeanUtils.getWriteMethodParameter(pd); // Do not allow eager init for type matching in case of a prioritized post-processor. boolean eager = !(bw.getWrappedInstance() instanceof PriorityOrdered); /*åŒ…è£…æˆä¸€ä¸ªä¾èµ–æè¿°ä¿¡æ¯å¯¹è±¡*/ DependencyDescriptor desc = new AutowireByTypeDependencyDescriptor(methodParam, eager); /*è§£æå™¨æ ¹æ®ä¾èµ–æè¿°ä¿¡æ¯æŸ¥æ‰¾å¯¹è±¡ï¼Œæˆ–è€… å®¹å™¨æ²¡æœ‰è¯¥å¯¹è±¡å®ä¾‹çš„è¯ï¼Œä½†æ˜¯æœ‰è¯¥ç±»å‹çš„bdçš„è¯ï¼Œä¹Ÿä¼šè°ƒç”¨getBeanByTypeç”Ÿæˆå¯¹è±¡ã€‚*/ Object autowiredArgument = resolveDependency(desc, beanName, autowiredBeanNames, converter); /*æŸ¥è¯¢å‡ºæ¥çš„ä¾èµ–å¯¹è±¡åŠ å…¥åˆ°pvsé‡Œé¢*/ if (autowiredArgument != null) &#123; pvs.add(propertyName, autowiredArgument); &#125; /*å°†æŸ¥è¯¢åˆ°çš„ä¾èµ–å¯¹è±¡æ³¨å†Œ*/ for (String autowiredBeanName : autowiredBeanNames) &#123; registerDependentBean(autowiredBeanName, beanName); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Autowiring by type from bean name &#x27;&quot; + beanName + &quot;&#x27; via property &#x27;&quot; + propertyName + &quot;&#x27; to bean named &#x27;&quot; + autowiredBeanName + &quot;&#x27;&quot;); &#125; &#125; autowiredBeanNames.clear(); &#125; &#125; catch (BeansException ex) &#123; throw new UnsatisfiedDependencyException(mbd.getResourceDescription(), beanName, propertyName, ex); &#125; &#125;&#125; è·å–å½“å‰å¯¹è±¡çš„éç®€å•ç±»å‹çš„å±æ€§åæ•°ç»„propertyNamesï¼› éå†å±æ€§åæ•°ç»„propertyNamesï¼Œè·å–å½“å‰å±æ€§åå¤šå¯¹åº”çš„ç±»å‹filedTypeï¼› é€šè¿‡filedTypeæ‰¾åˆ°åŒ¹é…çš„å€™é€‰Beanå¯¹è±¡ï¼› æŠŠå±æ€§åä»¥åŠbeanå¯¹è±¡æ·»åŠ åˆ°pvsçš„propertyValueListé‡Œé¢ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯æŒ‰ç…§åå­—æ³¨å…¥è¿˜æ˜¯æŒ‰ç…§ç±»å‹çš„æ³¨å…¥æ–¹å¼ï¼Œå…¶å®é‡Œé¢éƒ½ä¼šè°ƒç”¨åŒä¸€ä¸ªå…¬å…±çš„æ–¹æ³•ã€‚**unsatisfiedNonSimpleProperties()**ï¼Œæ¥ä¸‹æ¥åˆ†æè¿™ä¸ªæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ã€‚ 123456789101112131415161718192021protected String[] unsatisfiedNonSimpleProperties(AbstractBeanDefinition mbd, BeanWrapper bw) &#123; Set&lt;String&gt; result = new TreeSet&lt;&gt;(); /*æ‹¿åˆ°é…ç½®çš„propertiesé›†åˆ*/ PropertyValues pvs = mbd.getPropertyValues(); /*æ‹¿åˆ°beançš„æ‰€æœ‰å­—æ®µä¿¡æ¯ï¼Œç„¶åä¾¿åˆ©æ‰€æœ‰çš„å­—æ®µä¿¡æ¯*/ PropertyDescriptor[] pds = bw.getPropertyDescriptors(); /* * æ¡ä»¶1æˆç«‹è¯´æ˜ å½“å‰å­—æ®µæœ‰setteræ–¹æ³• * æ¡ä»¶2æˆç«‹è¯´æ˜ å½“å‰å­—æ®µç±»å‹æ˜¯å¦åœ¨å¿½ç•¥è‡ªåŠ¨æ³¨å…¥åˆ—è¡¨ä¸­ï¼Œæ¡ä»¶æˆç«‹ï¼Œè¯´æ˜ä¸åœ¨ã€‚ * æ¡ä»¶3æˆç«‹è¯´æ˜ å½“å‰å­—æ®µä¸åœ¨xmlæˆ–è€…å…¶ä»–æ–¹å¼çš„é…ç½®ä¸­é…ç½®è¿‡ã€‚ * æ¡ä»¶4æˆç«‹è¯´æ˜ å½“å‰å­—æ®µç±»å‹æ˜¯ä¸æ˜¯ç®€å•çš„å…«ç§åŸºæœ¬æ•°æ®ç±»å‹ã€‚åŸºæœ¬æ•°æ®ç±»å‹ä¸å…è®¸è‡ªåŠ¨æ³¨å…¥ã€‚å½“å‰å­—æ®µä¸æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ã€‚ * */ for (PropertyDescriptor pd : pds) &#123; if (pd.getWriteMethod() != null &amp;&amp; !isExcludedFromDependencyCheck(pd) &amp;&amp; !pvs.contains(pd.getName()) &amp;&amp; !BeanUtils.isSimpleProperty(pd.getPropertyType())) &#123; result.add(pd.getName()); &#125; &#125; return StringUtils.toStringArray(result);&#125; è¿‡æ»¤å‡ºmbdä¸­ç¬¦åˆä¾èµ–æ³¨å…¥æ¡ä»¶çš„å±æ€§ã€‚ 4.applyPropertyValues()å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬èµ°å±æ€§æ³¨å…¥çš„é€»è¾‘ï¼Œå…¶å®éƒ½æ˜¯å¯¹è§£æå‡ºæ¥çš„ä¾èµ–beanè¿›è¡Œæ³¨å…¥ã€‚æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹å¤§è‡´çš„æµç¨‹ï¼Œçœ‹ä¸€ä¸‹æ ¸å¿ƒçš„é€»è¾‘å³å¯ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697protected void applyPropertyValues(String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs) &#123; // ä¸ºç©ºç›´æ¥è¿”å› if (pvs == null || pvs.isEmpty()) &#123; return; &#125; MutablePropertyValues mpvs = null; List&lt;PropertyValue&gt; original; if (System.getSecurityManager() != null) &#123; if (bw instanceof BeanWrapperImpl) &#123; ((BeanWrapperImpl) bw).setSecurityContext(getAccessControlContext()); &#125; &#125; if (pvs instanceof MutablePropertyValues) &#123; mpvs = (MutablePropertyValues) pvs; if (mpvs.isConverted()) &#123; // å¦‚æœå·²è¢«è®¾ç½®è½¬æ¢å®Œæˆï¼Œç›´æ¥å®Œæˆé…ç½® try &#123; bw.setPropertyValues(mpvs); return; &#125; catch (BeansException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Error setting property values&quot;, ex); &#125; &#125; original = mpvs.getPropertyValueList(); &#125; else &#123; original = Arrays.asList(pvs.getPropertyValues()); &#125; TypeConverter converter = getCustomTypeConverter(); if (converter == null) &#123; converter = bw; &#125; // åˆ›å»ºBeanDefinitionValueResolverè§£æå™¨ï¼Œç”¨æ¥è§£ææœªè¢«è§£æçš„PropertyValueã€‚ BeanDefinitionValueResolver valueResolver = new BeanDefinitionValueResolver(this, beanName, mbd, converter); // å¼€å§‹éå†æ£€æŸ¥originalä¸­çš„å±æ€§ï¼Œå¯¹æœªè¢«è§£æçš„å…ˆè§£æ/å·²è§£æçš„ç›´æ¥åŠ å…¥deepCopyä¸­ï¼Œæœ€åå†å¡«å……åˆ°å…·ä½“çš„Beanå®ä¾‹ä¸­ List&lt;PropertyValue&gt; deepCopy = new ArrayList&lt;PropertyValue&gt;(original.size()); boolean resolveNecessary = false; for (PropertyValue pv : original) &#123; // å¦‚æœå±æ€§å·²ç»è½¬åŒ–ï¼Œç›´æ¥æ·»åŠ  if (pv.isConverted()) &#123; deepCopy.add(pv); &#125; else &#123; String propertyName = pv.getName(); Object originalValue = pv.getValue(); // æ ¸å¿ƒé€»è¾‘ï¼Œè§£æè·å–å®é™…çš„å€¼ // å¯¹äºRuntimeReferenceï¼Œä¼šè§£ææ‹¿åˆ°å…·ä½“çš„beanName,æœ€ç»ˆé€šè¿‡getBean(beanName)æ‹¿åˆ°å…·ä½“çš„å¯¹è±¡ Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue); Object convertedValue = resolvedValue; // åˆ¤æ–­æ˜¯å¦å¯ä»¥è½¬æ¢ boolean convertible = bw.isWritableProperty(propertyName) &amp;&amp; !PropertyAccessorUtils.isNestedOrIndexedProperty(propertyName); if (convertible) &#123; // å°è¯•è¿›è¡Œè½¬æ¢ convertedValue = convertForProperty(resolvedValue, propertyName, bw, converter); &#125; // é¿å…éœ€è¦é‡å¤è½¬æ¢ï¼Œè®¾å®šå·²è½¬æ¢ if (resolvedValue == originalValue) &#123; if (convertible) &#123; pv.setConvertedValue(convertedValue); &#125; deepCopy.add(pv); &#125; else if (convertible &amp;&amp; originalValue instanceof TypedStringValue &amp;&amp; !((TypedStringValue) originalValue).isDynamic() &amp;&amp; !(convertedValue instanceof Collection || ObjectUtils.isArray(convertedValue))) &#123; pv.setConvertedValue(convertedValue); deepCopy.add(pv); &#125; else &#123; resolveNecessary = true; deepCopy.add(new PropertyValue(pv, convertedValue)); &#125; &#125; &#125; if (mpvs != null &amp;&amp; !resolveNecessary) &#123; mpvs.setConverted(); &#125; // å®Œæˆè®¾ç½® try &#123; bw.setPropertyValues(new MutablePropertyValues(deepCopy)); &#125; catch (BeansException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Error setting property values&quot;, ex); &#125;&#125; â€‹ ä¸»è¦æ˜¯å…³å¿ƒä¸‹ï¼Œè§£æå‡ºæ¥çš„ä¾èµ–ï¼Œå¦‚æœæ³¨å…¥åˆ°å½“å‰æ­£åœ¨æ‰§è¡Œå±æ€§èµ‹å€¼çš„beanå¯¹è±¡ã€‚â€‹ **valueResolver.resolveValueIfNecessary()** åˆ©ç”¨å€¼è§£æå™¨è§£æå½“å‰beanå®ä¾‹æ‰€ä¾èµ–çš„beanå®ä¾‹ã€‚â€‹ **resolveReference()**é€šè¿‡è¿™ä¸ªæ–¹æ³•å»æ‹¿åˆ°å½“å‰å±æ€§èµ‹å€¼çš„beanéœ€è¦æ³¨å…¥çš„beanã€‚â€‹ **this.beanFactory.getBean()** æœ€ç»ˆè¿™é‡Œåˆé€’å½’å›åˆ°äº†getBean()å»è·å–æ‰€éœ€è¦çš„beanå¯¹è±¡ã€‚â€‹ **registerDependentBean()**åœ¨è·å–åˆ°beanå¯¹è±¡ä¹‹åï¼Œä¼šå°†è·å–åˆ°çš„beanå¯¹è±¡æ³¨å†Œåˆ°å½“å‰beanæ‰€ä¾èµ–çš„beané›†åˆã€‚â€‹ è‡³æ­¤ï¼Œå•å®ä¾‹beançš„å±æ€§èµ‹å€¼å¤§ä½“æµç¨‹æˆ‘ä»¬å°±åˆ†æå®Œäº†ï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†å»åˆ†æå•å®ä¾‹beançš„åˆå§‹åŒ–é€»è¾‘ã€‚ \u0000\u0000\u0000","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[äº”]createBean()","slug":"Spring/Spring[äº”]createBean()","date":"2022-01-11T05:59:23.628Z","updated":"2022-01-11T06:10:12.056Z","comments":true,"path":"2022/01/11/Spring/Spring[äº”]createBean()/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E4%BA%94]createBean()/","excerpt":"","text":"åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œåˆ†æäº†getBean()æ–¹æ³•çš„è¯¦ç»†æµç¨‹ï¼Œé‡Œé¢æ¶‰åŠåˆ°äº†å•å®ä¾‹beançš„åˆ›å»ºï¼ŒcreateBean(),æœ¬ç¯‡å°†åˆ†æè¿™ä¸ªæ–¹æ³•ï¼Œåˆ†æä¸€ä¸‹Springä¸­å•å®ä¾‹å¯¹è±¡æ—¶å¦‚ä½•åˆ›å»ºå‡ºæ¥çš„ã€‚ 1.createBean1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677@Overrideprotected Object createBean(String beanName, RootBeanDefinition mbd,/*æŒ‰ç…§ä¼ é€’çš„å‚æ•°æ„å»ºbeançš„å®ä¾‹å¹¶ä¸”è¿”å›ï¼Œä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨åˆ°å‚æ•°*/ @Nullable Object[] args) throws BeanCreationException &#123; /* * åˆ›å»ºå®ä¾‹ä½¿ç”¨çš„beanå®šä¹‰ä¿¡æ¯ * */ RootBeanDefinition mbdToUse = mbd; /* * æ£€æŸ¥å½“å‰beançš„å®šä¹‰ä¿¡æ¯æ˜¯å¦æœ‰classä¿¡æ¯ï¼Œå¦‚æœæœ‰çš„è¯è¿”å›classç±»å‹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œä½¿ç”¨ç±»åŠ è½½å™¨åŠ è½½classå®ä¾‹åŠ è½½åˆ°jvmï¼Œå¹¶è¿”å›classå¯¹è±¡ * * */ Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName); /* * æ¡ä»¶ä¸€ï¼šæ‹¿åˆ°äº†beanå®šä¹‰ä¿¡æ¯ å®ä¾‹åŒ–æ—¶å€™éœ€è¦çš„çœŸå®classå¯¹è±¡ * æ¡ä»¶äºŒï¼šè¯´æ˜beanå®šä¹‰ä¿¡æ¯åœ¨è§£æbeanå¯¹è±¡ä¹‹å‰ï¼ˆresolveBeanClass()ï¼‰æ˜¯æ²¡æœ‰classå¯¹è±¡çš„ * æ¡ä»¶ä¸‰ï¼šè¯´æ˜mbdæœ‰className * * éƒ½æˆç«‹ä¹‹åå°±ä¼šå»é‡æ–°åˆå§‹åŒ–mbdå¯¹è±¡ï¼Œè¿›è¡Œä¸€å±‚åŒ…è£…ã€‚ * */ if (resolvedClass != null &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != null) &#123; mbdToUse = new RootBeanDefinition(mbd); mbdToUse.setBeanClass(resolvedClass); &#125; try &#123; /* * é¢„å¤„ç† æ–¹æ³•é‡å†™çš„é€»è¾‘ã€‚ã€‚ ç»™é‡å†™çš„æ–¹æ³•æ‰“ä¸€ä¸ªæ ‡ã€‚ * */ mbdToUse.prepareMethodOverrides(); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanDefinitionStoreException(mbdToUse.getResourceDescription(), beanName, &quot;Validation of method overrides failed&quot;, ex); &#125; try &#123; /* * é€šè¿‡åç½®å¤„ç†å™¨åœ¨è¿™é‡Œè¿”å›ä¸€ä¸ªä»£ç†çš„å®ä¾‹å¯¹è±¡ * è¿™é‡Œçš„ä»£ç†å¯¹è±¡ä¸æ˜¯spring çš„ aop çš„å®ç°ã€‚ * å®ä¾‹åŒ–ä¹‹å‰ å¹¶ä¸æ˜¯initæ‰§è¡Œå‰å åç½®å¤„ç†å™¨çš„æ‰§è¡Œæœºä¼š * */ Object bean = resolveBeforeInstantiation(beanName, mbdToUse); /*å¦‚æœå¯¹è±¡ä¸ä¸ºç©ºï¼Œç›´æ¥è¿”å›ã€‚*/ if (bean != null) &#123; return bean; &#125; &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbdToUse.getResourceDescription(), beanName, &quot;BeanPostProcessor before instantiation of bean failed&quot;, ex); &#125; try &#123; /* * çœŸæ­£çš„åˆ›å»ºbeançš„é€»è¾‘ï¼Œspringé‡Œé¢çœŸæ­£å¹²æ´»çš„æ–¹æ³•éƒ½æ˜¯ä»¥doå¼€å¤´ * åˆ›å»ºbeanå®ä¾‹ æ‰§è¡Œä¾èµ–æ³¨å…¥ æ‰§è¡Œinit åç½®å¤„ç†å™¨çš„é€»è¾‘ * */ /** * 1.ç¬¬ä¸€æ¬¡åˆ›å»ºmançš„é€»è¾‘ * 2.åˆ›å»ºwomen */ Object beanInstance = doCreateBean(beanName, mbdToUse, args); return beanInstance; &#125; catch (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123; throw ex; &#125; catch (Throwable ex) &#123; throw new BeanCreationException( mbdToUse.getResourceDescription(), beanName, &quot;Unexpected exception during bean creation&quot;, ex); &#125;&#125; é¦–å…ˆä½¿ç”¨**resolveBeanClass()**è§£æå‡ºå½“å‰beançš„ç±»å‹ å¦‚æœè§£æå‡ºçš„beanç±»å‹ä¸ä¸ºç©ºï¼Œå¹¶ä¸”mbdé‡Œé¢æ²¡æœ‰beançš„ç±»å‹ï¼Œå¹¶ä¸”mbdçš„classNameä¸ä¸ºç©º åˆ›å»ºä¸€ä¸ªæ–°çš„**RootBeanDefinition**,å°†Classç±»å‹è®¾ç½®è¿›å» å¤„ç†æ–¹æ³•é‡å†™çš„é€»è¾‘**prepareMethodOverrides()** **resolveBeforeInstantiation() **é€šè¿‡åç½®å¤„ç†å™¨åœ¨è¿™é‡Œå°è¯•è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œçš„ä»£ç†å¹¶ä¸æ˜¯Aopçš„å®ç°ï¼Œæ­¤æ—¶æ˜¯å®ä¾‹åŒ–ä¹‹å‰ï¼Œå¹¶ä¸æ˜¯**init()**æ‰§è¡Œå‰å å¦‚æœåç½®å¤„ç†å™¨æˆåŠŸè¿”å›äº†å¯¹è±¡ï¼Œç›´æ¥è¿”å› å¦‚æœåç½®å¤„ç†å™¨æ²¡æœ‰è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé‚£å°±å°†åˆ›å»ºbeançš„é€»è¾‘å§”æ´¾ç»™**doCreateBean()**,è¿”å›åˆ›å»ºå¥½çš„beanå®ä¾‹å¯¹è±¡ã€‚ â€‹ æŒ‰ç…§æ‰§è¡Œæµç¨‹æ¥åˆ†æï¼Œæˆ‘ä»¬å…ˆåˆ†æ**resolveBeanClass()**æ–¹æ³•ã€‚ 2.resolveBeanClass()123456789101112131415161718@Nullableprotected Class&lt;?&gt; resolveBeanClass(RootBeanDefinition mbd, String beanName, Class&lt;?&gt;... typesToMatch) throws CannotLoadBeanClassException &#123; try &#123; if (mbd.hasBeanClass()) &#123; return mbd.getBeanClass(); &#125; return doResolveBeanClass(mbd, typesToMatch); &#125; catch (ClassNotFoundException ex) &#123; throw new CannotLoadBeanClassException(mbd.getResourceDescription(), beanName, mbd.getBeanClassName(), ex); &#125; catch (LinkageError err) &#123; throw new CannotLoadBeanClassException(mbd.getResourceDescription(), beanName, mbd.getBeanClassName(), err); &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå…¶å®åˆæ˜¯ä¸€ä¸ªå§”æ´¾æ¨¡å¼ã€‚**doResolveBeanClass()**ã€‚â€‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960@Nullableprivate Class&lt;?&gt; doResolveBeanClass(RootBeanDefinition mbd, Class&lt;?&gt;... typesToMatch) throws ClassNotFoundException &#123; ClassLoader beanClassLoader = getBeanClassLoader(); ClassLoader dynamicLoader = beanClassLoader; boolean freshResolve = false; if (!ObjectUtils.isEmpty(typesToMatch)) &#123; // When just doing type checks (i.e. not creating an actual instance yet), // use the specified temporary class loader (e.g. in a weaving scenario). ClassLoader tempClassLoader = getTempClassLoader(); if (tempClassLoader != null) &#123; dynamicLoader = tempClassLoader; freshResolve = true; if (tempClassLoader instanceof DecoratingClassLoader) &#123; DecoratingClassLoader dcl = (DecoratingClassLoader) tempClassLoader; for (Class&lt;?&gt; typeToMatch : typesToMatch) &#123; dcl.excludeClass(typeToMatch.getName()); &#125; &#125; &#125; &#125; String className = mbd.getBeanClassName(); if (className != null) &#123; Object evaluated = evaluateBeanDefinitionString(className, mbd); if (!className.equals(evaluated)) &#123; // A dynamically resolved expression, supported as of 4.2... if (evaluated instanceof Class) &#123; return (Class&lt;?&gt;) evaluated; &#125; else if (evaluated instanceof String) &#123; className = (String) evaluated; freshResolve = true; &#125; else &#123; throw new IllegalStateException(&quot;Invalid class name expression result: &quot; + evaluated); &#125; &#125; if (freshResolve) &#123; // When resolving against a temporary class loader, exit early in order // to avoid storing the resolved Class in the bean definition. if (dynamicLoader != null) &#123; try &#123; return dynamicLoader.loadClass(className); &#125; catch (ClassNotFoundException ex) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Could not load class [&quot; + className + &quot;] from &quot; + dynamicLoader + &quot;: &quot; + ex); &#125; &#125; &#125; return ClassUtils.forName(className, dynamicLoader); &#125; &#125; // Resolve regularly, caching the result in the BeanDefinition... return mbd.resolveBeanClass(beanClassLoader);&#125; è¿™é‡Œé¢æ²¡æœ‰ä»€ä¹ˆæ ¸å¿ƒçš„é€»è¾‘ï¼Œä¸ä½œå…·ä½“åˆ†æã€‚å…³æ³¨ä¸€ä¸‹é‡è¦çš„é€»è¾‘ï¼Œåœ¨beanå®ä¾‹åˆ›å»ºä¹‹å‰å°è¯•è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚â€‹ 3.å®ä¾‹åŒ–ä¹‹å‰å°è¯•è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡**resolveBeforeInstantiation()**â€‹ 1234567891011121314151617181920212223242526protected Object resolveBeforeInstantiation(String beanName, RootBeanDefinition mbd) &#123; Object bean = null; if (!Boolean.FALSE.equals(mbd.beforeInstantiationResolved)) &#123; // hasInstantiationAwareBeanPostProcessors() çœ‹å½“å‰éœ€è¦æ‰§è¡Œçš„é›†åˆé‡Œé¢ //æ˜¯å¦æœ‰ç›¸å…³çš„åç½®å¤„ç†å™¨ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œæ¡ä»¶æˆç«‹ ï¼Œæ‰èƒ½æ‰§è¡Œif é‡Œé¢çš„é€»è¾‘ if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123; Class&lt;?&gt; targetType = determineTargetType(beanName, mbd); if (targetType != null) &#123; /* * æ‰§è¡Œbean å®ä¾‹åŒ– å‰åçš„åç½®å¤„ç†å™¨ before æ–¹æ³•ï¼Œé»˜è®¤æ˜¯è¿”å›nullï¼Œå¦‚æœæƒ³è¦åšç‰¹æ®Šçš„é€»è¾‘å¤„ç† * å¯ä»¥è‡ªå·±ç»§æ‰¿æ¥å£è¿›è¡Œæ‰©å±•ã€‚éœ€è¦ç»§æ‰¿çš„æ¥å£ï¼šInstantiationAwareBeanPostProcessor * */ bean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName); /* * å¦‚æœbeançœŸçš„åœ¨è¿™é‡Œåˆ›å»ºå‡ºæ¥äº†ï¼Œé‚£ä¹ˆï¼Œä¸‹é¢å°±ä¼šæ‰§è¡Œbeanå®ä¾‹åŒ–åçš„åç½®å¤„ç†å™¨é€»è¾‘ * */ if (bean != null) &#123; bean = applyBeanPostProcessorsAfterInitialization(bean, beanName); &#125; &#125; &#125; mbd.beforeInstantiationResolved = (bean != null); &#125; return bean;&#125; å¦‚æœæœ‰**InstantiationAwareBeanPostProcessors**è¿™ä¸ªç±»å‹çš„åç½®å¤„ç†å™¨ è·å–è¢«ä»£ç†å¯¹è±¡çš„ç±»å‹ å¦‚æœç±»å‹ä¸ä¸ºç©º æ‰§è¡Œbeanå®ä¾‹åŒ–å‰åçš„åç½®å¤„ç†å™¨çš„before()ï¼Œé»˜è®¤æ˜¯è¿”å›nullã€‚å¦‚æœæƒ³è¦åšç‰¹æ®Šçš„é€»è¾‘å¤„ç†ï¼Œå¯ä»¥è‡ªå·±ç»§æ‰¿æ¥å£è¿›è¡Œæ‰©å±•ã€‚**applyBeanPostProcessorsBeforeInstantiation()** \u0000 å¦‚æœæœ‰ç‰¹æ®Šå¤„ç†çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯è¿”å›äº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé‚£å°±æ‰§è¡Œbeanå®ä¾‹åŒ–åçš„åç½®å¤„ç†å™¨æ–¹æ³•ã€‚**applyBeanPostProcessorsAfterInitialization()** è¿”å›åç½®å¤„ç†å™¨åˆ›å»ºçš„beanå¯¹è±¡3.1 applyBeanPostProcessorsBeforeInstantiation()12345678910ã€ @Nullable protected Object applyBeanPostProcessorsBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) &#123; for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123; Object result = bp.postProcessBeforeInstantiation(beanClass, beanName); if (result != null) &#123; return result; &#125; &#125; return null; &#125; éå†æ‰€æœ‰çš„åç½®å¤„ç†å™¨ï¼Œæ‰§è¡Œåç½®å¤„ç†å™¨çš„å‰ç½®æ–¹æ³•ï¼Œå¦‚æœæŸä¸€ä¸ªåç½®å¤„ç†å™¨è¿”å›äº†ä¸€ä¸ªä¸ä¸ºç©ºçš„å¯¹è±¡ï¼Œç›´æ¥è¿”å›è¯¥å¯¹è±¡ï¼Œåé¢çš„åç½®å¤„ç†å™¨çš„æ–¹æ³•ä¸åœ¨æ‰§è¡Œã€‚3.2 applyBeanPostProcessorsAfterInitialization()1234567891011121314151617@Overridepublic Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException &#123; Object result = existingBean; for (BeanPostProcessor processor : getBeanPostProcessors()) &#123; Object current = processor.postProcessAfterInitialization(result, beanName); /*æ³¨æ„ï¼š * ä¸€æ—¦æŸä¸ªåç½®å¤„ç†å™¨è¿”å›çš„ç»“æœä¸ºç©º * å°±è¿”å›ä¸Šä¸€ä¸ªåç½®å¤„ç†å™¨çš„ç»“æœï¼Œåé¢çš„åç½®å¤„ç†å™¨æ–¹æ³•ä¸åœ¨æ‰§è¡Œ*/ if (current == null) &#123; return result; &#125; result = current; &#125; return result;&#125; éå†æ‰€æœ‰çš„åç½®å¤„ç†å™¨ï¼Œæ‰§è¡Œåç½®å¤„ç†å™¨çš„åç½®æ–¹æ³•ï¼Œå¦‚æœæŸä¸€ä¸ªåç½®å¤„ç†å™¨è¿”å›äº†nullï¼Œç›´æ¥è¿”å›nullï¼Œåé¢çš„åç½®å¤„ç†å™¨çš„æ–¹æ³•ä¸åœ¨æ‰§è¡Œã€‚â€‹ **InstantiationAwareBeanPostProcessors**çš„é€»è¾‘å¯ä»¥çœ‹å‰é¢çš„Springç»„ä»¶ä¸æ³¨è§£ç¯‡ï¼Œå†æ¬¡ä¸å†èµ˜è¿°ã€‚â€‹ 4.doCreateBean()123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145protected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException &#123; // BeanWrapperï¼šä¸€ä¸ªåŒ…è£…çš„beanå®ä¾‹ï¼Œç»§æ‰¿äº†å¯é…ç½®çš„å±æ€§è®¿é—®å™¨ BeanWrapper instanceWrapper = null; /*å¦‚æœæ˜¯å•å®ä¾‹beanå¯¹è±¡ï¼Œæ¸…ç†ç¼“å­˜å¹¶è¿”å›è¯¥å¯¹è±¡ï¼Œè¿™é‡Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯æ‹¿ä¸åˆ°çš„ï¼Œå› ä¸ºè¿˜æœªåˆ›å»ºbeanå¯¹è±¡å®ä¾‹ã€‚*/ if (mbd.isSingleton()) &#123; instanceWrapper = this.factoryBeanInstanceCache.remove(beanName); &#125; /*å¦‚æœä¸Šé¢çš„é€»è¾‘æ²¡æ‹¿åˆ°ï¼Œè¯´æ˜è¿˜æ˜¯æ­£å¸¸çš„é€»è¾‘ï¼Œæ‰§è¡Œåˆ›å»ºbeanå®ä¾‹çš„æ–¹æ³•å¹¶ä¸”åŒ…è£…åˆ°wrapperä¸­ã€‚*/ if (instanceWrapper == null) &#123; /** * 1.ç¬¬ä¸€æ¬¡èµ°åˆ°è¿™é‡Œæ˜¯å»åˆ›å»ºman * 2.åˆ›å»ºwomen */ instanceWrapper = createBeanInstance(beanName, mbd, args); &#125; /*è·å–åŒ…è£…å¥½çš„beanå®ä¾‹å¯¹è±¡*/ Object bean = instanceWrapper.getWrappedInstance(); /*æ‹¿åˆ°beanå®ä¾‹çš„Classç±»å‹*/ Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass(); /*å¦‚æœbeanç±»å‹ä¸ä¸ºç©ºï¼Œå°†beanç±»å‹è®¾ç½®åˆ°mergedBeanDefinitionä¸­*/ if (beanType != NullBean.class) &#123; mbd.resolvedTargetType = beanType; &#125; /*å…è®¸post-processors åœ¨æ­¤åˆ»å¯¹ merged bean definition è¿›è¡Œä¿®æ”¹*/ synchronized (mbd.postProcessingLock) &#123; /*å¦‚æœåç½®å¤„ç†å™¨çš„é€»è¾‘è¿˜å°šæœªæ‰§è¡Œï¼Œé‚£å°±åœ¨æ­¤åˆ»æ‰§è¡Œï¼Œæ‰§è¡Œä¹‹åå°†æ˜¯å¦æ‰§è¡Œè¿‡ä¿®æ”¹ä¸ºtrueï¼Œè¿™ä¹Ÿå°±é™å®šäº†åç½®å¤„ç†å™¨åªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚*/ if (!mbd.postProcessed) &#123; try &#123; /*æ‰§è¡Œåç½®å¤„ç†å™¨çš„æ ¸å¿ƒé€»è¾‘ï¼šåˆå¹¶bdä¿¡æ¯ï¼Œæ¥ä¸‹æ¥å°±æ˜¯populateå¤„ç†ä¾èµ–ã€‚*/ applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Post-processing of merged bean definition failed&quot;, ex); &#125; mbd.postProcessed = true; &#125; &#125; // Eagerly cache singletons to be able to resolve circular references // even when triggered by lifecycle interfaces like BeanFactoryAware. /* * æå‰åœ°ç¼“å­˜å•ä¾‹ï¼Œä»¥ä¾¿èƒ½å¤Ÿè§£æå¾ªç¯å¼•ç”¨ï¼Œå³ä½¿è¢«ç”Ÿå‘½å‘¨æœŸæ¥å£(å¦‚BeanFactoryAware)è§¦å‘ã€‚ * å…¶å®è¿™é‡Œçš„é€»è¾‘å°±æ˜¯åˆ¤æ–­æ˜¯å¦è¿‡æ—©çš„æš´éœ²æ—©æœŸçš„beanå®ä¾‹ï¼Œå·²ç»åˆå§‹åŒ–ï¼Œä½†æ˜¯æ²¡å®ä¾‹åŒ–ã€‚ * */ boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)); /*å¦‚æœæ”¯æŒæ—©æœŸæš´éœ²å•å®ä¾‹beanå¯¹è±¡*/ if (earlySingletonExposure) &#123; /*æ—¥å¿—æ‰“å°*/ if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Eagerly caching bean &#x27;&quot; + beanName + &quot;&#x27; to allow for resolving potential circular references&quot;); &#125; /*åŠ å…¥åˆ°å•ä¾‹beanå·¥å‚ï¼Œå°†æ—©æœŸbean&#x27;å®ä¾‹ï¼ˆå·²ç»å®ä¾‹åŒ–ä½†æ˜¯å°šæœªåˆå§‹åŒ–ï¼‰çš„å¼•ç”¨åŠ å…¥åˆ°ç¬¬ä¸‰çº§ç¼“å­˜ * getEarlyBeanReferenceï¼ˆï¼‰*/ /** * 1.manç°åœ¨åˆšåˆ›å»ºå‡ºæ¥ï¼Œè¿˜æ²¡æœ‰è¿›è¡Œå±æ€§èµ‹å€¼å’Œåˆå§‹åŒ–ï¼Œæ­¤æ—¶å°†ä»–æ”¾åˆ°ç¬¬ä¸‰çº§ç¼“å­˜ * 2.æ­¤æ—¶çš„womenä¹Ÿæ˜¯é€šè¿‡åå°„åˆšåˆšåˆ›å»ºå‡ºæ¥ï¼Œè¿˜æ²¡æœ‰è¿›è¡Œå±æ€§èµ‹å€¼å’Œåˆå§‹åŒ–çš„é€»è¾‘ï¼Œæ­¤æ—¶æŠŠä»–æ”¾åˆ°äº†ä¸‰çº§ç¼“å­˜ä¸­ */ addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)); &#125; // Initialize the bean instance. Object exposedObject = bean; try &#123; /*å¯¹beanè¿›è¡Œå±æ€§èµ‹å€¼ï¼Œä¾èµ–æ³¨å…¥ã€‚*/ /** * 1.å¯¹manè¿›è¡Œå±æ€§èµ‹å€¼ * 2.å¯¹womenè¿›è¡Œå±æ€§èµ‹å€¼ */ populateBean(beanName, mbd, instanceWrapper); /*ç”Ÿå‘½å‘¨æœŸä¸­çš„åˆå§‹åŒ–æ–¹æ³•çš„è°ƒç”¨*/ /** * 1.womenå…ˆç»è¿‡è¿™é‡Œ */ exposedObject = initializeBean(beanName, exposedObject, mbd); &#125; catch (Throwable ex) &#123; if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123; throw (BeanCreationException) ex; &#125; else &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Initialization of bean failed&quot;, ex); &#125; &#125; if (earlySingletonExposure) &#123; Object earlySingletonReference = getSingleton(beanName, false); //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰beanå®ä¾‹æ˜¯ä»äºŒçº§ç¼“å­˜å°±è·å–åˆ°äº† //è¯´æ˜äº§ç”Ÿäº†ï¼Œå¾ªç¯ä¾èµ–ï¼Œä¸‰çº§ç¼“å­˜ å½“å‰å¯¹è±¡çš„ObjectFactory.getObject()è¢«è°ƒç”¨è¿‡ if (earlySingletonReference != null) &#123; /*ä»€ä¹ˆæ—¶å€™ç›¸ç­‰å‘¢ï¼Ÿ * 1.å½“å‰çš„çœŸå®å®ä¾‹ä¸éœ€è¦è¢«ä»£ç† * 2.å½“å‰å®ä¾‹å·²ç»è¢«ä»£ç†è¿‡ï¼Œï¼Œï¼Œæ˜¯åœ¨ObjectFactory.getObject()æ–¹æ³•è°ƒç”¨çš„æ—¶å€™ï¼Œå®ç°çš„å¢å¼ºä»£ç†*/ if (exposedObject == bean) &#123; exposedObject = earlySingletonReference; &#125; else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123; /*è·å–ä¾èµ–å½“å‰beançš„å…¶ä»–beanName*/ String[] dependentBeans = getDependentBeans(beanName); Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;&gt;(dependentBeans.length); for (String dependentBean : dependentBeans) &#123; /*å¦‚æœä¾èµ–å½“å‰beançš„beanå·²ç»åˆ›å»ºå®Œäº†ï¼Œå°±æŠŠä»–åŠ å…¥åˆ°é›†åˆä¸­å»*/ if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123; actualDependentBeans.add(dependentBean); &#125; &#125; /*å½“å‰beanæ­£åœ¨åˆ›å»ºï¼Œä½†æ˜¯ä¾èµ–å½“å‰beançš„beanå·²ç»åˆ›å»ºå®Œäº†ï¼Œé‚£è¯´æ˜æŒ‡å®šæ˜¯æœ‰é—®é¢˜ï¼Œä¸å¯¹åŠ²ã€‚*/ /** * ä¸ºä»€ä¹ˆæœ‰é—®é¢˜ï¼Ÿ * å› ä¸ºå½“å‰å¯¹è±¡çš„aopæ“ä½œæ˜¯åœ¨å½“å‰æ–¹æ³• initbean å®Œæˆçš„ * åœ¨è¿™ä¹‹å‰ ï¼Œå¤–éƒ¨å…¶ä»–beanæŒæœ‰çš„å½“å‰beanå®ä¾‹ éƒ½æ˜¯å°šæœªå¢å¼ºçš„ã€‚ */ if (!actualDependentBeans.isEmpty()) &#123; throw new BeanCurrentlyInCreationException(beanName, &quot;Bean with name &#x27;&quot; + beanName + &quot;&#x27; has been injected into other beans [&quot; + StringUtils.collectionToCommaDelimitedString(actualDependentBeans) + &quot;] in its raw version as part of a circular reference, but has eventually been &quot; + &quot;wrapped. This means that said other beans do not use the final version of the &quot; + &quot;bean. This is often the result of over-eager type matching - consider using &quot; + &quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;); &#125; &#125; &#125; &#125; // Register bean as disposable. try &#123; /*åˆ¤æ–­å½“å‰beanæ˜¯å¦éœ€è¦æ³¨å†Œä¸€ä¸ªå®¹å™¨å…³é—­æ—¶å€™çš„ææ„å‡½æ•°å›è°ƒ*/ registerDisposableBeanIfNecessary(beanName, bean, mbd); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Invalid destruction signature&quot;, ex); &#125; return exposedObject;&#125; å¦‚æœæ˜¯å•å®ä¾‹beanå¯¹è±¡ï¼Œæ‹¿åˆ°è¯¥å¯¹è±¡ï¼Œå¹¶æ¸…ç†ç¼“å­˜ï¼Œè¿™é‡Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯ä»€ä¹ˆéƒ½æ‹¿ä¸åˆ°çš„ï¼Œå› ä¸ºè¿˜æ²¡æœ‰åˆ›å»ºbeanå¯¹è±¡å®ä¾‹ã€‚ å¦‚æœä¸Šé¢çš„é€»è¾‘ä»€ä¹ˆä¹Ÿæ²¡æœ‰æ‹¿åˆ°ï¼Œè¯´æ˜è¿˜æ˜¯æ­£å¸¸çš„æƒ…å†µï¼Œæ‰§è¡Œåˆ›å»ºbeanå®ä¾‹çš„æ–¹æ³•å¹¶ä¸”åŒ…è£…åˆ°wrapperä¸­ã€‚**createBeanInstance()** è·å–åŒ…è£…å¥½çš„beanå®ä¾‹å¯¹è±¡ï¼Œæ‹¿åˆ°beanå®ä¾‹å¯¹è±¡çš„classç±»å‹ï¼Œå°†ä»–è®¾ç½®åˆ°mbdä¸­ã€‚ åœ¨å±æ€§èµ‹å€¼ä¹‹å‰ï¼Œç»™å°šæœªæ‰§è¡Œçš„åç½®å¤„ç†å™¨æœ€åä¸€æ¬¡æœºä¼šæ¥æ‰§è¡Œï¼Œæ‰§è¡Œä¹‹åä¿®æ”¹æ‰§è¡Œè¿‡çŠ¶æ€ä¸ºtrueï¼Œè¿™ä¹Ÿå°±é™å®šäº†åç½®å¤„ç†å™¨åªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚**applyMergedBeanDefinitionPostProcessors()** åˆ¤æ–­æ˜¯å¦å…è®¸è¿‡æ—©çš„æš´éœ²æ—©æœŸbeanå®ä¾‹çš„å¼•ç”¨(å·²ç»åˆå§‹åŒ–ï¼Œä½†æ˜¯å°šæœªå®ä¾‹åŒ–) å°†æ—©æœŸbeanå®ä¾‹åŠ å…¥åˆ°ä¸‰çº§ç¼“å­˜ å¯¹æ—©æœŸæš´éœ²çš„beanè¿›è¡Œå±æ€§èµ‹å€¼**populateBean()** åœ¨å±æ€§èµ‹å€¼ä¹‹åæ‰§è¡Œbeanå¯¹è±¡çš„åˆå§‹åŒ–æ–¹æ³•**initializeBean()** è¿™é‡Œå¼€å§‹å…¶å®å°±æ˜¯å¾ªç¯ä¾èµ–çš„é€»è¾‘ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯å…è®¸æ—©æœŸæš´éœ²çš„å•å®ä¾‹beanå¯¹è±¡ï¼Œå¦‚æœæ˜¯çš„è¯ ä»ç¼“å­˜ä¸­æ‹¿åˆ°å°è¯•è·å–beanï¼Œ**getSingleton()** å¦‚æœä»ç¼“å­˜æ‹¿åˆ°beanäº†ï¼Œè¯´æ˜å½“å‰beanå®ä¾‹æ˜¯ä»äºŒçº§ç¼“å­˜å°±è·å–åˆ°äº†ï¼Œè¯´æ˜äº§ç”Ÿäº†å¾ªç¯ä¾èµ– å¦‚æœä¾èµ–äºå½“å‰beanå…¶ä»–beanå¯¹è±¡ï¼Œï¼Œå¦‚æœä¾èµ–å½“å‰beançš„å¯¹è±¡éƒ½å·²ç»åˆ›å»ºå®Œäº†ï¼Œé‚£å°±å§ä»–ä»¬åŠ å…¥åˆ°é›†åˆä¸­ã€‚ å½“å‰beanæ­£åœ¨åˆ›å»ºï¼Œä½†æ˜¯ä¾èµ–ä»–çš„beanéƒ½åˆ›å»ºå®Œäº†ï¼Œé‚£å°±è¯´æ˜é€»è¾‘ä¸Šå‡ºç°é—®é¢˜äº† ä¸ºä»€ä¹ˆä¼šå‡ºç°é—®é¢˜ï¼Ÿå› ä¸ºå½“å‰å¯¹è±¡çš„aopæ“ä½œæ˜¯åœ¨å½“å‰æ–¹æ³•çš„initæ–¹æ³•é‡Œé¢æ‰§è¡Œçš„ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œå…¶ä»–å¯¹è±¡æ‹¿åˆ°çš„beanéƒ½æ˜¯å°šæœªå¢å¼ºçš„beanã€‚ åˆ¤æ–­å½“å‰beanæ˜¯å¦éœ€è¦æ³¨å†Œä¸€ä¸ªå®¹å™¨å…³é—­æ—¶å€™æ‰§è¡Œçš„ææ„å‡½æ•°**registerDisposableBeanIfNecessary()** \u0000\u0000è¿™é‡Œé¢å…¶å®ä¸»è¦å…³æ³¨äº”ä¸ªç‚¹ï¼š**createBeanInstance()**ï¼Œ**applyMergedBeanDefinitionPostProcessors()**ï¼Œ**populateBean()**ï¼Œ**initializeBean()**ï¼Œ**registerDisposableBeanIfNecessary()**ã€‚â€‹ 5.createBeanInstance()ä½¿ç”¨é€‚å½“çš„å®ä¾‹åŒ–ç­–ç•¥ä¸ºæŒ‡å®šçš„ bean åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹ï¼šå·¥å‚æ–¹æ³•ï¼Œæ„é€ å‡½æ•°è‡ªåŠ¨è£…é…æˆ–ç®€å•å®ä¾‹åŒ–ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697protected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) &#123; // è§£æbeanå®šä¹‰ä¿¡æ¯ä¸­çš„ bean çš„å®ä¾‹ç±»å‹ Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName); /* * æ¡ä»¶ä¸€ï¼šClass å®ä¾‹ä¸ä¸ºç©º * æ¡ä»¶äºŒï¼šClasså®ä¾‹çš„è®¿é—®æƒé™ä¸æ˜¯å…¬å¼€çš„ * æ¡ä»¶ä¸‰ï¼šCLasså®ä¾‹çš„æƒé™æ²¡æ‰“å¼€ï¼Œæ²¡æ‰“å¼€å°±ä¸èƒ½åå°„æˆ‘è®°å¾—ã€‚ * */ if (beanClass != null &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot; + beanClass.getName()); &#125; /*spring5æ–°ç‰¹æ€§ï¼Œæ²¡ç ”ç©¶*/ Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier(); if (instanceSupplier != null) &#123; return obtainFromSupplier(instanceSupplier, beanName); &#125; /*è¯´æ˜beanæ ‡ç­¾é…ç½®äº† factoryMethodå±æ€§ï¼šåˆ©ç”¨å·¥å‚åˆ›å»ºå¯¹è±¡çš„é€»è¾‘ã€‚*/ if (mbd.getFactoryMethodName() != null) &#123; return instantiateUsingFactoryMethod(beanName, mbd, args); &#125; // åˆ›å»ºç›¸åŒbeançš„æ—¶å€™ï¼Œå¯ä»¥èµ°æ·å¾„ã€‚è§£ææ„é€ å™¨æ¯”è¾ƒè€—æ—¶ï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªå¯¹è±¡åˆ›å»ºä¸¤æ¬¡ï¼Œå¯ä»¥ä¸ç”¨é‚£ä¹ˆéº»çƒ¦ã€‚ /* * resolvedï¼šbdå¯¹åº”çš„æ„é€ ä¿¡æ¯æ˜¯å¦å·²ç»è§£ææˆå¯ä»¥å‘å°„è°ƒç”¨çš„æ„é€ æ–¹æ³•ä¿¡æ¯ * autowireNecessaryï¼šæ˜¯å¦è‡ªåŠ¨åŒ¹é…æ„é€ æ–¹æ³• * * */ boolean resolved = false; boolean autowireNecessary = false; if (args == null) &#123; /* * mbd.resolvedConstructorOrFactoryMethod != null * æ¡ä»¶æˆç«‹ï¼šè¯´æ˜bdçš„æ„é€ ä¿¡æ¯å·²ç»è½¬åŒ–æˆå¯ä»¥åå°„è°ƒç”¨çš„methodï¼Œå¹¶ä¸”è¢«ç¼“å­˜ã€‚ * */ synchronized (mbd.constructorArgumentLock) &#123; if (mbd.resolvedConstructorOrFactoryMethod != null) &#123; /*è¯´æ˜å·²ç»è§£æè¿‡*/ resolved = true; /*åˆ¤æ–­æ„é€ æ–¹æ³•çš„å‚æ•°æ˜¯å¦å·²ç»è¢«è§£æäº†ï¼ŒresolvedConstructorOrFactoryMethod æœ‰å€¼ * ä¸”æ„é€ æ–¹æ³•æœ‰å‚æ•°ï¼Œå¯ä»¥è®¤ä¸ºå­—æ®µå€¼å°±æ˜¯true * è®¾ä¹ˆæƒ…å†µä¸‹ä¸ºfalseï¼Ÿ * 1.resolvedConstructorOrFactoryMethod == null * 2.å½“resolvedConstructorOrFactoryMethod è¡¨ç¤ºçš„æ˜¯é»˜è®¤çš„æ— å‚æ„é€ å™¨çš„æ—¶å€™ * */ autowireNecessary = mbd.constructorArgumentsResolved; &#125; &#125; &#125; /* * å¦‚æœå·²ç»è§£æè¿‡ï¼Œ * * */ if (resolved) &#123; /*å¹¶ä¸”å¯ä»¥è‡ªåŠ¨åŒ¹é…æ„é€ æ–¹æ³•*/ if (autowireNecessary) &#123; /*è‡ªåŠ¨åŒ¹é…æœ‰å‚æ„é€ å™¨*/ return autowireConstructor(beanName, mbd, null, null); &#125; /*æ²¡æœ‰å‚æ•°è§£æï¼Œä¹Ÿå°±æ˜¯æ— å‚æ„é€ æ–¹æ³•å¤„ç†*/ else &#123; /** * 1.ç¬¬ä¸€æ¬¡å»åˆ›å»ºman * 2.åˆ›å»ºwomen */ return instantiateBean(beanName, mbd); &#125; &#125; // Candidate constructors for autowiring? /** * åç½®å¤„ç†å™¨çš„è°ƒç”¨ç‚¹ï¼šSmartInstantiationAwareBeanPostProcessor * è¿™ä¸ªåç½®å¤„ç†å™¨é‡Œé¢é»˜è®¤æ˜¯å®ç°æ–¹æ³•ä¸ºç©ºï¼Œæƒ³è¦æ‰§è¡Œè¿™é‡Œçš„é€»è¾‘å¯ä»¥è‡ªå·±ç»§æ‰¿æ¥å£å®ç° * * å…¸å‹åº”ç”¨ @Autowired æ‰“åœ¨äº†æ„é€ å™¨æ–¹æ³•ä¸Šï¼Œå°±ä¼šç”¨åˆ°åç½®å¤„ç†å™¨ AutowiredAnnotationBeanPostProcessor */ Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName); /* * æ¡ä»¶1ï¼šåç½®å¤„ç†å™¨æŒ‡å®šäº†æ„é€ æ–¹æ³•æ•°ç»„ * æ¡ä»¶2ï¼šä¸€èˆ¬ä¸ä¼šæˆç«‹ã€‚beanæ ‡ç­¾é‡Œé¢é…ç½®äº†autowired=constructor æ‰ä¼šè§¦å‘ * æ¡ä»¶3ï¼šè¯´æ˜beanæ ‡ç­¾ä¸­é…ç½®äº†æ„é€ å‚æ•°ä¿¡æ¯ * æ¡ä»¶4ï¼šgetBeanæ—¶ï¼Œargsæœ‰å‚æ•° * */ if (ctors != null || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR || mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123; return autowireConstructor(beanName, mbd, ctors, args); &#125; /*åˆ¤æ–­æ˜¯å¦åœ¨beanDefinitioné‡Œé¢é…ç½®åå¥½æ„é€ å™¨ï¼Œé»˜è®¤å®ç°æ˜¯nullã€‚*/ // Preferred constructors for default construction? ctors = mbd.getPreferredConstructors(); if (ctors != null) &#123; return autowireConstructor(beanName, mbd, ctors, null); &#125; /*å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯èµ°è¿™é‡Œï¼šæœªæŒ‡å®šæ„é€ å‚æ•°ï¼Œæœªè®¾å®šåå¥½ï¼Œä½¿ç”¨æ— å‚æ„é€ å™¨åˆ›å»ºbeanå®ä¾‹ã€‚*/ // No special handling: simply use no-arg constructor. return instantiateBean(beanName, mbd);&#125; è§£æbdä¸­çš„beanç±»å‹ å¯¹ç±»å‹åšä¸€äº›æ ¡éªŒ åˆ¤æ–­å¦‚æœé…ç½®äº†beanæ ‡ç­¾é‡Œé¢çš„**factoryMethod**å±æ€§ï¼Œèµ°åˆ©ç”¨å·¥å‚åˆ›å»ºå¯¹è±¡çš„é€»è¾‘ã€‚**instantiateUsingFactoryMethod()** è¿›è¡Œä¸€äº›å±æ€§åˆ¤æ–­ï¼Œå…¶å®ä¸»è¦å°±æ˜¯åˆ›å»ºç›¸åŒbeanå¯¹è±¡çš„æ—¶å€™ï¼Œæ²¡æœ‰å¿…è¦å…¨éƒ¨é‡æ–°æ¥åšï¼Œå¯ä»¥èµ°ä¸€äº›æ·å¾„ å¦‚æœå·²ç»è§£æè¿‡&amp;å¯ä»¥è‡ªåŠ¨åŒ¹é…æ„é€ æ–¹æ³•ï¼Œé‚£å°±èµ°è‡ªåŠ¨åŒ¹é…æœ‰å‚æ„é€ å™¨çš„é€»è¾‘ã€‚**autowireConstructor()** å¦‚æœæ˜¯å·²ç»è§£æè¿‡&amp;æ— å‚æ„é€ å™¨çš„å¤„ç†æ–¹æ³•ï¼Œé‚£å°±èµ°**instantiateBean()** æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªåç½®å¤„ç†å™¨çš„è°ƒç”¨ç‚¹ _**SmartInstantiationAwareBeanPostProcessor**_ï¼Œè¿™ä¸ªåç½®å¤„ç†å™¨é‡Œé¢é»˜è®¤å®ç°ä¸ºç©ºï¼Œå¯ä»¥è‡ªå·±æ‰©å±•ã€‚ å…¸å‹çš„åº”ç”¨å°±æ˜¯ @Autowired æ³¨è§£æ‰“åœ¨äº†æ„é€ å™¨ä¸Šï¼Œå°±ä¼šç”¨åˆ°åç½®å¤„ç†å™¨_**AutowiredAnnotationBeanPostProcessor**_ã€‚ åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œæ„é€ å™¨è‡ªåŠ¨æ³¨å…¥çš„é€»è¾‘ **autowireConstructor()** åˆ¤æ–­æ˜¯å¦åœ¨beandefinitioné‡Œé¢é…ç½®äº†åå¥½çš„æ„é€ å™¨ï¼Œé»˜è®¤å®ç°æ˜¯nullï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±èµ°**autowireConstructor()**ã€‚ å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå…¶å®ä¼šèµ°**instantiateBean()**ã€‚ï¼ˆæœªæŒ‡å®šæ„é€ å‚æ•°ï¼Œæœªè®¾ç½®åå¥½ï¼Œä½¿ç”¨æ— å‚æ„é€ å™¨åˆ›å»ºbeanå¯¹è±¡å®ä¾‹ï¼‰ \u0000è¿™é‡Œä¸»è¦å…³å¿ƒä¸‰ä¸ªæ–¹æ³•**instantiateBean()**&amp;**autowireConstructor()**&amp;**instantiateUsingFactoryMethod()**ã€‚â€‹ 5.1 instantiateBean()\u0000 12345678910111213141516171819protected BeanWrapper instantiateBean(String beanName, RootBeanDefinition mbd) &#123; try &#123; /*è·å–å®ä¾‹åŒ–ç­–ç•¥ï¼Œè°ƒç”¨å®ä¾‹åŒ–æ–¹æ³•åˆ›å»ºbeanå®ä¾‹*/ /** * 1.åå°„å»åˆ›å»ºman * 2.åå°„å»åˆ›å»ºwomen */ Object beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, this); /*æ ¹æ®å®ä¾‹åˆ›å»ºbeanå®ä¾‹çš„åŒ…è£…å™¨*/ BeanWrapper bw = new BeanWrapperImpl(beanInstance); /*å¯¹åŒ…è£…å™¨è¿›è¡Œä¸€äº›å‚æ•°ï¼Œå·¥å…·è®¾ç½®*/ initBeanWrapper(bw); return bw; &#125; catch (Throwable ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Instantiation of bean failed&quot;, ex); &#125;&#125; é¦–å…ˆè·å–åˆ°å®ä¾‹åŒ–çš„ç­–ç•¥ï¼Œåå°„å»åˆ›å»ºå¯¹è±¡ï¼Œæ ¹æ®beanå»åˆ›å»ºå¯¹è±¡çš„åŒ…è£…å™¨ï¼Œå¯¹åŒ…è£…å™¨è¿›è¡Œèµ‹èƒ½ã€‚**instantiate()** 12345678910111213141516171819202122232425262728293031@Overridepublic Object instantiate(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner) &#123; // Don&#x27;t override the class with CGLIB if no overrides. /*ä¸è€ƒè™‘æ–¹æ³•è¦†ç›–*/ if (!bd.hasMethodOverrides()) &#123; Constructor&lt;?&gt; constructorToUse; synchronized (bd.constructorArgumentLock) &#123; constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod; if (constructorToUse == null) &#123; final Class&lt;?&gt; clazz = bd.getBeanClass(); if (clazz.isInterface()) &#123; throw new BeanInstantiationException(clazz, &quot;Specified class is an interface&quot;); &#125; try &#123; constructorToUse = clazz.getDeclaredConstructor(); bd.resolvedConstructorOrFactoryMethod = constructorToUse; &#125; catch (Throwable ex) &#123; throw new BeanInstantiationException(clazz, &quot;No default constructor found&quot;, ex); &#125; &#125; &#125; /*å®ä¾‹åŒ–*/ return BeanUtils.instantiateClass(constructorToUse); &#125; else &#123; // Must generate CGLIB subclass. /*æ–¹æ³•è¦†ç›–çš„é€»è¾‘*/ return instantiateWithMethodInjection(bd, beanName, owner); &#125;&#125; **instantiateClass()** 12345678910111213141516171819202122232425262728293031323334353637383940414243public static &lt;T&gt; T instantiateClass(Constructor&lt;T&gt; ctor, Object... args) throws BeanInstantiationException &#123; Assert.notNull(ctor, &quot;Constructor must not be null&quot;); try &#123; ReflectionUtils.makeAccessible(ctor); if (KotlinDetector.isKotlinReflectPresent() &amp;&amp; KotlinDetector.isKotlinType(ctor.getDeclaringClass())) &#123; return KotlinDelegate.instantiateClass(ctor, args); &#125; else &#123; Class&lt;?&gt;[] parameterTypes = ctor.getParameterTypes(); Assert.isTrue(args.length &lt;= parameterTypes.length, &quot;Can&#x27;t specify more arguments than constructor parameters&quot;); /*è¿™é‡Œçš„å‚æ•°æ•°ç»„æ˜¯ä¸ºäº†é˜²æ­¢æŸä¸ªç±»å‹ä¼ è¿‡æ¥çš„å€¼æ˜¯nullï¼Œå¦‚æœæ˜¯nullï¼Œå°±æ˜¯ç”¨é»˜è®¤çš„å€¼*/ Object[] argsWithDefaultValues = new Object[args.length]; for (int i = 0 ; i &lt; args.length; i++) &#123; if (args[i] == null) &#123; Class&lt;?&gt; parameterType = parameterTypes[i]; /*ä»è¿™é‡Œå°±èƒ½çœ‹åˆ°æ˜¯ä¸æ˜¯é€‰ç”¨äº†é»˜è®¤å€¼*/ /* * DEFAULT_TYPE_VALUES :å­˜å„ç§åŸºæœ¬æ•°æ®ç±»å‹çš„é»˜è®¤å€¼ã€‚ * */ argsWithDefaultValues[i] = (parameterType.isPrimitive() ? DEFAULT_TYPE_VALUES.get(parameterType) : null); &#125; else &#123; argsWithDefaultValues[i] = args[i]; &#125; &#125; /*é€šè¿‡æ„é€ å™¨æ¥è¿›è¡Œåå°„å®ä¾‹åŒ–åˆ›å»ºbeanå®ä¾‹ã€‚*/ return ctor.newInstance(argsWithDefaultValues); &#125; &#125; catch (InstantiationException ex) &#123; throw new BeanInstantiationException(ctor, &quot;Is it an abstract class?&quot;, ex); &#125; catch (IllegalAccessException ex) &#123; throw new BeanInstantiationException(ctor, &quot;Is the constructor accessible?&quot;, ex); &#125; catch (IllegalArgumentException ex) &#123; throw new BeanInstantiationException(ctor, &quot;Illegal arguments for constructor&quot;, ex); &#125; catch (InvocationTargetException ex) &#123; throw new BeanInstantiationException(ctor, &quot;Constructor threw exception&quot;, ex.getTargetException()); &#125;&#125; æœ€ç»ˆé€šè¿‡å•å®ä¾‹beançš„æ„é€ å™¨åå°„åˆ›å»ºå¯¹è±¡ã€‚ 5.2autowireConstructor()12345protected BeanWrapper autowireConstructor( String beanName, RootBeanDefinition mbd, @Nullable Constructor&lt;?&gt;[] ctors, @Nullable Object[] explicitArgs) &#123; /*é€šè¿‡æ„é€ å‡½æ•°è§£æå™¨çš„autowireConstructoræ–¹æ³•æ¥åˆ›å»ºbeanå®ä¾‹*/ return new ConstructorResolver(this).autowireConstructor(beanName, mbd, ctors, explicitArgs);&#125; è‡ªåŠ¨è£…é…æ„é€ å‡½æ•°è¡Œä¸ºã€‚å¦‚æœæŒ‡å®šäº†æ˜¾å¼çš„æ„é€ å‡½æ•°å‚æ•°å€¼ï¼Œä¹Ÿå¯ä»¥ï¼Œå°†æ‰€æœ‰å‰©ä½™å‚æ•°ä¸æ¥è‡ªbeanå·¥å‚çš„beanåŒ¹é…ã€‚è¿™å—å¯¹åº”äºæ„é€ å‡½æ•°æ³¨å…¥ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹springçš„beanå·¥å‚èƒ½å¤Ÿæ‰¿è½½æœŸæœ›åŸºäºæ„é€ å‡½æ•°çš„ä¾èµ–é¡¹è§£æçš„ç»„ä»¶ã€‚**autowireConstructor()** 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209public BeanWrapper autowireConstructor(String beanName, RootBeanDefinition mbd, @Nullable Constructor&lt;?&gt;[] chosenCtors, @Nullable Object[] explicitArgs) &#123; /*åˆ›å»ºäº†ä¸€ä¸ªbeanåŒ…è£…å™¨çš„å®ä¾‹*/ BeanWrapperImpl bw = new BeanWrapperImpl(); /*åˆå§‹åŒ–beanåŒ…è£…å™¨*/ this.beanFactory.initBeanWrapper(bw); /*æœ€ç»ˆåå°„è°ƒç”¨çš„æ„é€ å™¨*/ Constructor&lt;?&gt; constructorToUse = null; /*holderæŒæœ‰çš„æ˜¯ï¼šå®ä¾‹åŒ–çš„æ—¶å€™ï¼ŒçœŸæ­£ç”¨åˆ°çš„å‚æ•°*/ ArgumentsHolder argsHolderToUse = null; /*å®ä¾‹åŒ–çš„æ—¶å€™ä½¿ç”¨åˆ°çš„å‚æ•°*/ Object[] argsToUse = null; /*å¦‚æœgetbeanä¼ çš„å‚æ•°ä¸ä¸ºç©ºï¼Œä½¿ç”¨åˆ°çš„å‚æ•°å°±æ˜¯æŒ‡å®šçš„å‚æ•°*/ if (explicitArgs != null) &#123; argsToUse = explicitArgs; &#125; else &#123;/*getBeançš„æ—¶å€™æ²¡æœ‰æŒ‡å®šå‚æ•°*/ /*è¡¨ç¤ºæ„é€ å™¨å‚æ•°éœ€è¦åšç±»å‹è½¬æ¢ï¼Œå‚æ•°å¼•ç”¨*/ Object[] argsToResolve = null; synchronized (mbd.constructorArgumentLock) &#123; /*åˆ°ç¼“å­˜å»çœ‹çœ‹æœ‰æ²¡æœ‰ç¼“å­˜è¿‡æ„é€ å™¨*/ constructorToUse = (Constructor&lt;?&gt;) mbd.resolvedConstructorOrFactoryMethod; /*ç¼“å­˜æœ‰è§£æå¥½çš„æ„é€ å™¨å¹¶ä¸”æ„é€ å™¨å‚æ•°å·²ç»è¢«è§£æè¿‡ è¯´æ˜ä¸æ˜¯ç¬¬ä¸€æ¬¡é€šè¿‡bdç”Ÿæˆå®ä¾‹*/ if (constructorToUse != null &amp;&amp; mbd.constructorArgumentsResolved) &#123; // Found a cached constructor... argsToUse = mbd.resolvedConstructorArguments; if (argsToUse == null) &#123; argsToResolve = mbd.preparedConstructorArguments; &#125; &#125; &#125; /*æ¡ä»¶æˆç«‹è¯´æ˜ï¼šresolvedConstructorArguments==null*/ if (argsToResolve != null) &#123; /*è§£ææ„é€ å‚æ•°*/ argsToUse = resolvePreparedArguments(beanName, mbd, bw, constructorToUse, argsToResolve); &#125; &#125; /*æ¡ä»¶æˆç«‹è¯´æ˜ç¼“å­˜æœºåˆ¶å¤±è´¥ï¼Œæˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œéœ€è¦åŒ¹é…æ„é€ å™¨ã€‚*/ if (constructorToUse == null || argsToUse == null) &#123; // Take specified constructors, if any. /*chosenCtorsä»€ä¹ˆæ—¶å€™æœ‰å€¼å‘¢ï¼Ÿæ„é€ å™¨ä¸Šæœ‰@Autowiredæ³¨è§£çš„æ—¶å€™ã€‚*/ Constructor&lt;?&gt;[] candidates = chosenCtors; /*æ¡ä»¶æˆç«‹è¯´æ˜ï¼šå¤–éƒ¨ç¨‹åºè°ƒç”¨æ–¹æ³•çš„æ—¶å€™å¹¶æ²¡æœ‰æŒ‡å®šå¯é€‰ç”¨çš„æ„é€ å™¨ï¼Œéœ€è¦é€šè¿‡classæ‹¿åˆ°æ„é€ å™¨ä¿¡æ¯*/ if (candidates == null) &#123; Class&lt;?&gt; beanClass = mbd.getBeanClass(); try &#123; /*å¦‚æœéå…¬å¼€çš„æ–¹æ³•ä¹Ÿå…è®¸è®¿é—®å°±è·å–æ‰€æœ‰çš„æ„é€ å™¨ï¼Œå¦åˆ™è·å–å¯ä»¥è®¿é—®çš„æ„é€ å™¨ã€‚*/ candidates = (mbd.isNonPublicAccessAllowed() ? beanClass.getDeclaredConstructors() : beanClass.getConstructors()); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Resolution of declared constructors on bean Class [&quot; + beanClass.getName() + &quot;] from ClassLoader [&quot; + beanClass.getClassLoader() + &quot;] failed&quot;, ex); &#125; &#125; /*æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå¯é€‰ç”¨çš„æ„é€ å™¨åˆ—è¡¨å·²ç»è½¬å¤‡å¥½äº†ï¼Œä½†æ˜¯è¿˜æ²¡ç¡®å®šå…·ä½“æ˜¯å“ªä¸€ä¸ª*/ /*å¦‚æœåªæœ‰ä¸€ä¸ªæ„é€ å™¨å¹¶ä¸”getBeanæ²¡æœ‰æŒ‡å®šæ„é€ å™¨å‚æ•°ï¼Œå¹¶ä¸”beanå®šä¹‰ä¿¡æ¯é‡Œé¢æ²¡æœ‰å‚æ•°ï¼Œé‚£å°±æ˜¯ç”¨é»˜è®¤çš„æ— å‚æ„é€ å™¨*/ if (candidates.length == 1 &amp;&amp; explicitArgs == null &amp;&amp; !mbd.hasConstructorArgumentValues()) &#123; Constructor&lt;?&gt; uniqueCandidate = candidates[0]; if (uniqueCandidate.getParameterCount() == 0) &#123; synchronized (mbd.constructorArgumentLock) &#123; mbd.resolvedConstructorOrFactoryMethod = uniqueCandidate; mbd.constructorArgumentsResolved = true; mbd.resolvedConstructorArguments = EMPTY_ARGS; &#125; bw.setBeanInstance(instantiate(beanName, mbd, uniqueCandidate, EMPTY_ARGS)); return bw; &#125; &#125; // éœ€è¦è§£æåˆ°åº•æ˜¯ç”¨å“ªä¸€ä¸ªæ„é€ å™¨ boolean autowiring = (chosenCtors != null || mbd.getResolvedAutowireMode() == AutowireCapableBeanFactory.AUTOWIRE_CONSTRUCTOR); /*å®Œæˆè§£æåçš„æ„é€ å™¨å‚æ•°å€¼åˆ—è¡¨*/ ConstructorArgumentValues resolvedValues = null; /*æ„é€ å™¨å‚æ•°çš„ä¸ªæ•°*/ int minNrOfArgs; if (explicitArgs != null) &#123; minNrOfArgs = explicitArgs.length; &#125; else &#123; /*ä»beanDefinitionæ‹¿åˆ°æ„é€ å™¨å‚æ•°*/ ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues(); resolvedValues = new ConstructorArgumentValues(); /*å°†æ­¤ bean çš„æ„é€ å‡½æ•°å‚æ•°è§£æä¸º resolveValues å¯¹è±¡ã€‚ è¿™å¯èƒ½æ¶‰åŠæŸ¥æ‰¾å…¶ä»– beanã€‚ æ­¤æ–¹æ³•ä¹Ÿç”¨äºå¤„ç†é™æ€å·¥å‚æ–¹æ³•çš„è°ƒç”¨ã€‚ï¼Œ*/ minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues); &#125; /*ç»™å¯é€‰ç”¨çš„æ„é€ å™¨æ•°ç»„æ’åºï¼Œæ’åºè§„åˆ™ï¼š public &gt; no public more args &gt; no args*/ AutowireUtils.sortConstructors(candidates); /*è¿™ä¸ªå€¼è¶Šä½ï¼Œè¯´æ˜å½“å‰æ„é€ å™¨å‚æ•°åˆ—è¡¨ç±»å‹å’Œæ„é€ å‚æ•°çš„åŒ¹é…å€¼è¶Šé«˜*/ int minTypeDiffWeight = Integer.MAX_VALUE; /*å°šæœªç­›é€‰æˆ–è€…ç­›é€‰å®Œè¿˜æœªç¡®å®šçš„æ„é€ å™¨*/ Set&lt;Constructor&lt;?&gt;&gt; ambiguousConstructors = null; Deque&lt;UnsatisfiedDependencyException&gt; causes = null; /*ç­›é€‰å¯é€‰çš„æ„é€ æ–¹æ³•ï¼Œæ‰¾å‡ºä¸€ä¸ªåŒ¹é…åº¦æœ€é«˜çš„æ„é€ å‡½æ•°*/ for (Constructor&lt;?&gt; candidate : candidates) &#123; /*è·å–å½“å‰å¤„ç†çš„æ„é€ å™¨å‚æ•°ä¸ªæ•°*/ int parameterCount = candidate.getParameterCount(); /*è¿™é‡Œåˆ¤æ–­çš„æŒ‡æ ‡éƒ½æ˜¯ä¸Šé¢å¾ªç¯ç­›é€‰å‡ºæ¥çš„ä¸œè¥¿ * å› ä¸ºcandidatesæ˜¯æ’è¿‡åºçš„ æ’åºè§„åˆ™ï¼špublic &gt; no public &gt; å¤šå‚æ•°çš„ &gt; å‚æ•°å°‘çš„ * å½“å‰ç­›é€‰å‡ºæ¥çš„æ„é€ å™¨ä¼˜å…ˆçº§ä¸€å®šæ˜¯ä¼˜å…ˆäºåé¢çš„æ„é€ å™¨çš„ * */ if (constructorToUse != null &amp;&amp; argsToUse != null &amp;&amp; argsToUse.length &gt; parameterCount) &#123; // Already found greedy constructor that can be satisfied -&gt; // do not look any further, there are only less greedy constructors left. break; &#125;/*è¡¨ç¤ºå½“å‰æ„é€ å™¨å‚æ•° å°äº bdä¸­é…ç½®äº†æ„é€ å™¨å‚æ•°ä¸ªæ•°ï¼Œè¯´æ˜åŒ¹é…ä¸ä¸Šã€‚*/ if (parameterCount &lt; minNrOfArgs) &#123; continue; &#125; /*æ„é€ å™¨å‚æ•°çš„æŒæœ‰å¯¹è±¡*/ ArgumentsHolder argsHolder; /*æ‹¿åˆ°å½“å‰æ„é€ å™¨çš„å‚æ•°ç±»å‹æ•°ç»„*/ Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes(); /*å·²ç»è§£æåçš„æ„é€ å™¨å‚æ•°å€¼ä¸ä¸ºç©ºï¼Œè¯´æ˜bdä¸­æ˜¯æœ‰å‚æ•°çš„ï¼Œéœ€è¦åšåŒ¹é…é€»è¾‘*/ if (resolvedValues != null) &#123; try &#123; /*æ ¹æ®æ„é€ å™¨å‚æ•°æ³¨è§£@ConstructorPropertiesæ‹¿åˆ°æ‰€æœ‰å‚æ•°çš„åå­—*/ String[] paramNames = ConstructorPropertiesChecker.evaluate(candidate, parameterCount); /*å¦‚æœæ•°ç»„çš„åå­—æ˜¯ç©º,é‚£ä¹ˆå°±éƒ½æ˜¯é»˜è®¤çš„åå­—*/ if (paramNames == null) &#123; ParameterNameDiscoverer pnd = this.beanFactory.getParameterNameDiscoverer(); if (pnd != null) &#123; paramNames = pnd.getParameterNames(candidate); &#125; &#125; argsHolder = createArgumentArray(beanName, mbd, resolvedValues, bw, paramTypes, paramNames, getUserDeclaredConstructor(candidate), autowiring, candidates.length == 1); &#125; catch (UnsatisfiedDependencyException ex) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Ignoring constructor [&quot; + candidate + &quot;] of bean &#x27;&quot; + beanName + &quot;&#x27;: &quot; + ex); &#125; // Swallow and try next constructor. if (causes == null) &#123; causes = new ArrayDeque&lt;&gt;(1); &#125; causes.add(ex); continue; &#125; &#125; else &#123; // Explicit arguments given -&gt; arguments length must match exactly. if (parameterCount != explicitArgs.length) &#123; continue; &#125; argsHolder = new ArgumentsHolder(explicitArgs); &#125; /*typeDiffWeightæ•°å€¼è¶Šé«˜è¯´æ˜æ„é€ å™¨ä¸å‚æ•°çš„åŒ¹é…åº¦è¶Šä½ã€‚ * è®¡ç®—å‡ºå½“å‰æ„é€ å™¨å‚æ•°ç±»å‹ä¸å½“å‰æ„é€ å™¨å‚æ•°åŒ¹é…åº¦*/ int typeDiffWeight = (mbd.isLenientConstructorResolution() ? argsHolder.getTypeDifferenceWeight(paramTypes) : argsHolder.getAssignabilityWeight(paramTypes)); // Choose this constructor if it represents the closest match. /*æ¡ä»¶æˆç«‹è¯´æ˜ï¼šå½“å‰å¾ªç¯å¤„ç†çš„æ„é€ å™¨æ¯”ä¸Šä¸€æ¬¡å¸…é€‰å‡ºæ¥çš„æ›´åˆé€‚*/ if (typeDiffWeight &lt; minTypeDiffWeight) &#123; constructorToUse = candidate; argsHolderToUse = argsHolder; argsToUse = argsHolder.arguments; minTypeDiffWeight = typeDiffWeight; ambiguousConstructors = null; &#125; /*æ¡ä»¶æˆç«‹è¯´æ˜ï¼šå½“å‰å¤„ç†çš„æ„é€ å™¨ ä»–è®¡ç®—å‡ºæ¥çš„typeDiffWeightå€¼ä¸ä¸Šä¸€æ¬¡ç­›é€‰å‡ºæ¥çš„æœ€ä¼˜å…ˆçš„æ„é€ å™¨çš„å€¼ä¸€è‡´ï¼Œæœ‰æ¨¡æ£±ä¸¤å¯çš„æƒ…å†µã€‚åŠ å…¥åˆ°æ¨¡æ£±ä¸¤å¯é›†åˆã€‚*/ else if (constructorToUse != null &amp;&amp; typeDiffWeight == minTypeDiffWeight) &#123; if (ambiguousConstructors == null) &#123; ambiguousConstructors = new LinkedHashSet&lt;&gt;(); ambiguousConstructors.add(constructorToUse); &#125; ambiguousConstructors.add(candidate); &#125; &#125; /*æ¡ä»¶æˆç«‹ï¼šæ²¡æ‰¾åˆ°å¯ç”¨æ„é€ å™¨ï¼Œæ‰€ä»¥ç›´æ¥æŠ¥é”™ã€‚*/ if (constructorToUse == null) &#123; if (causes != null) &#123; UnsatisfiedDependencyException ex = causes.removeLast(); for (Exception cause : causes) &#123; this.beanFactory.onSuppressedException(cause); &#125; throw ex; &#125; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Could not resolve matching constructor on bean class [&quot; + mbd.getBeanClassName() + &quot;] &quot; + &quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities)&quot;); &#125; /*æ¡ä»¶æˆç«‹ï¼šæ¨¡æ£±ä¸¤å¯çš„æ„é€ å™¨é›†åˆæœ‰å€¼ï¼Œå¹¶ä¸”beanDefinitioné‡Œé¢çš„æ„é€ å™¨æŒ‡å®šç­–ç•¥æ˜¯ç‹­çª„ç­–ç•¥ï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿè¦æŠ¥é”™ã€‚*/ else if (ambiguousConstructors != null &amp;&amp; !mbd.isLenientConstructorResolution()) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Ambiguous constructor matches found on bean class [&quot; + mbd.getBeanClassName() + &quot;] &quot; + &quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): &quot; + ambiguousConstructors); &#125; /*æ¡ä»¶æˆç«‹ï¼šè¯´æ˜è‡ªåŠ¨åŒ¹é…æˆåŠŸäº†ï¼Œéœ€è¦è¿›è¡Œç¼“å­˜ï¼Œæ–¹ä¾¿åæ¥è€…ç»§ç»­ä½¿ç”¨mergerdbeanDefinitionæ¥åˆ›å»ºå®ä¾‹*/ if (explicitArgs == null &amp;&amp; argsHolderToUse != null) &#123; argsHolderToUse.storeCache(mbd, constructorToUse); &#125; &#125; Assert.state(argsToUse != null, &quot;Unresolved constructor arguments&quot;); /*æ ¹æ®ä¸Šé¢é€‰æ‹©çš„æ„é€ å™¨å’Œè§£æå‡ºæ¥çš„å‚æ•°ï¼Œé€šè¿‡instantiateæ–¹æ³•åå°„åˆ›å»ºbeanå¯¹è±¡å®ä¾‹ï¼Œæœ€ç»ˆå°†å®ä¾‹è®¾ç½®åˆ°beanWrapperçš„beanInstanceå®ä¾‹é‡Œé¢ã€‚*/ bw.setBeanInstance(instantiate(beanName, mbd, constructorToUse, argsToUse)); return bw;&#125; 5.3 instantiateUsingFactoryMethod()12345protected BeanWrapper instantiateUsingFactoryMethod( String beanName, RootBeanDefinition mbd, @Nullable Object[] explicitArgs) &#123; //å·¥å‚æ¨¡å¼åˆ›å»ºå¯¹è±¡çš„æ–¹æ³• return new ConstructorResolver(this).instantiateUsingFactoryMethod(beanName, mbd, explicitArgs);&#125; **instantiateUsingFactoryMethod()**â€‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308public BeanWrapper instantiateUsingFactoryMethod( String beanName, RootBeanDefinition mbd, @Nullable Object[] explicitArgs) &#123; //åˆ›å»ºä¸€ä¸ªç©ºçš„beanå®ä¾‹çš„åŒ…è£…å™¨ BeanWrapperImpl bw = new BeanWrapperImpl(); //è¿›è¡Œä¸€äº›å‚æ•°è®¾ç½®ï¼Œç»™åŒ…è£…å™¨èµ‹èƒ½ this.beanFactory.initBeanWrapper(bw); //å·¥å‚beanå¯¹è±¡çš„å¼•ç”¨ Object factoryBean; //å·¥å‚beanå¯¹è±¡çš„ç±»å‹ Class&lt;?&gt; factoryClass; //æ˜¯ä¸æ˜¯é™æ€å·¥å‚ boolean isStatic; //è·å–å·¥å‚beançš„åå­— String factoryBeanName = mbd.getFactoryBeanName(); //å¦‚æœå·¥å‚beançš„åå­—ä¸ä¸ºç©º if (factoryBeanName != null) &#123; //å¦‚æœå·¥å‚beançš„åå­—å’Œè¦åˆ›å»ºçš„beanåå­—ä¸€æ ·ï¼Œé‚£ä¹ˆè¯´æ˜å‡ºç°é—®é¢˜äº†ï¼Œè¿™ä¸ªæ—¶å€™è¦æŠ›å¼‚å¸¸ if (factoryBeanName.equals(beanName)) &#123; throw new BeanDefinitionStoreException(mbd.getResourceDescription(), beanName, &quot;factory-bean reference points back to the same bean definition&quot;); &#125; //è·å–å·¥å‚beanå¯¹è±¡ factoryBean = this.beanFactory.getBean(factoryBeanName); //å¦‚æœmbdæ˜¯å•å®ä¾‹çš„ &amp;&amp; å½“å‰ä¸€çº§ç¼“å­˜é‡Œé¢åŒ…å«è¿™ä¸ªè¦åˆ›å»ºçš„å•å®ä¾‹bean //è¿™ä¸ªæ—¶å€™è¯´æ˜ä¸æ­£å¸¸ï¼Œä¸ºå•¥å‘¢ï¼Ÿæˆ‘ä»¬è¦é€šè¿‡å·¥å‚æ¨¡å¼åˆ›å»ºçš„beanï¼Œè¢«ä»¥å…¶ä»–æ–¹å¼åˆ›å»ºå‡ºæ¥äº†ï¼Œéæ­£å¸¸é€”å¾„å¾—åˆ°çš„bean if (mbd.isSingleton() &amp;&amp; this.beanFactory.containsSingleton(beanName)) &#123; throw new ImplicitlyAppearedSingletonException(); &#125; //ç»™å½“å‰è¦åˆ›å»ºçš„beanå®ä¾‹å¯¹è±¡æ³¨å†Œä¸€ä¸ªä¾èµ–beanï¼Œè¿™ä¸ªä¾èµ–beanå°±æ˜¯ä»–çš„å·¥å‚bean this.beanFactory.registerDependentBean(factoryBeanName, beanName); factoryClass = factoryBean.getClass(); isStatic = false; &#125; //èµ°åˆ°è¿™é‡Œçš„æƒ…å†µå°±æ˜¯å·¥å‚beanæ²¡æœ‰åå­—ï¼Œä»€ä¹ˆæƒ…å†µä¼šèµ°åˆ°è¿™é‡Œï¼Ÿé€šè¿‡é™æ€å·¥å‚æ¥åˆ›å»ºå¯¹è±¡ else &#123; // It&#x27;s a static factory method on the bean class. //å¦‚æœä¾èµ–é™æ€å·¥å‚æ¥åˆ›å»ºbeanå®ä¾‹å¯¹è±¡çš„è¯ï¼Œé‚£ä¹ˆå¿…é¡»è¦æœ‰å·¥å‚beançš„ç±»å‹ï¼Œå¦åˆ™æ²¡æ³•åˆ›å»º if (!mbd.hasBeanClass()) &#123; throw new BeanDefinitionStoreException(mbd.getResourceDescription(), beanName, &quot;bean definition declares neither a bean class nor a factory-bean reference&quot;); &#125; factoryBean = null; factoryClass = mbd.getBeanClass(); isStatic = true; &#125; //åˆ›å»ºbeanå¯¹è±¡çš„å·¥å‚æ–¹æ³• Method factoryMethodToUse = null; //æŒæœ‰åˆ›å»ºå¯¹è±¡éœ€è¦çš„å‚æ•° ArgumentsHolder argsHolderToUse = null; //åˆ›å»ºå¯¹è±¡éœ€è¦ä½¿ç”¨çš„å‚æ•° Object[] argsToUse = null; //getBean()æ–¹æ³•ä¼ å…¥çš„å‚æ•° if (explicitArgs != null) &#123; argsToUse = explicitArgs; &#125; else &#123;//è¿™é‡Œçš„é€»è¾‘å°±æ˜¯getBean()çš„æ—¶å€™æ²¡æœ‰å‚æ•°ä¼ é€’è¿›æ¥ Object[] argsToResolve = null; synchronized (mbd.constructorArgumentLock) &#123; //è·å–å·²ç»è§£æè¿‡çš„å·¥å‚æ–¹æ³• factoryMethodToUse = (Method) mbd.resolvedConstructorOrFactoryMethod; //å¦‚æœå·¥å‚æ–¹æ³•å·²ç»è§£æè¿‡ï¼Œ&amp;&amp; mbdçš„æ„é€ å™¨å‚æ•°ä¹Ÿå·²ç»è§£æè¿‡ if (factoryMethodToUse != null &amp;&amp; mbd.constructorArgumentsResolved) &#123; // Found a cached factory method... //è¿™é‡Œåº”è¯¥å°±æ˜¯åˆ¤æ–­æ„é€ å™¨å‚æ•°æœ‰æ²¡æœ‰è§£æè¿‡ï¼Œæ²¡æœ‰è§£æè¿‡çš„è¯ï¼Œå°±å»è®¾ç½®è§£æçŠ¶æ€ä¸ºå‡†å¤‡è§£æ argsToUse = mbd.resolvedConstructorArguments; if (argsToUse == null) &#123; argsToResolve = mbd.preparedConstructorArguments; &#125; &#125; &#125; //åˆ¤æ–­æ„é€ å™¨å‚æ•°å°šæœªè§£æè¿‡ï¼Œå°±å»è§£ææ„é€ å™¨å‚æ•° if (argsToResolve != null) &#123; argsToUse = resolvePreparedArguments(beanName, mbd, bw, factoryMethodToUse, argsToResolve); &#125; &#125; //å¦‚æœå·¥å‚æ–¹æ³•ä¸ºç©º || éœ€è¦ä½¿ç”¨çš„å‚æ•°ä¸ºç©º if (factoryMethodToUse == null || argsToUse == null) &#123; // Need to determine the factory method... // Try all methods with this name to see if they match the given arguments. //éœ€è¦ä¸€ä¸ªä¸€ä¸ªæ–¹æ³•å°è¯•ï¼Œå»æ‰¾åˆ°åˆ›å»ºbeanæ‰€éœ€è¦çš„å·¥å‚æ–¹æ³• factoryClass = ClassUtils.getUserClass(factoryClass); List&lt;Method&gt; candidates = null; //å¦‚æœå·¥å‚æ–¹æ³•æ˜¯å”¯ä¸€çš„ &amp;&amp; å½“å‰å°šæœªæœ‰æŒ‡å®šå·¥å‚æ–¹æ³• if (mbd.isFactoryMethodUnique) &#123; if (factoryMethodToUse == null) &#123; //è·å–mbdé‡Œé¢å·²ç»è§£æè¿‡çš„å·¥å‚æ–¹æ³• factoryMethodToUse = mbd.getResolvedFactoryMethod(); &#125; //å¦‚æœmbdé‡Œé¢æœ‰å·²ç»è§£æå¥½çš„å·¥å‚æ–¹æ³•ï¼ŒæŠŠä»–æ”¾åˆ°é›†åˆ if (factoryMethodToUse != null) &#123; candidates = Collections.singletonList(factoryMethodToUse); &#125; &#125; //å¦‚æœæ–¹æ³•åˆ—è¡¨ä¸ºç©ºï¼Œæœ‰ä»€ä¹ˆæƒ…å†µï¼Ÿ //å¯èƒ½æ˜¯ä¸Šé¢mbdé‡Œé¢æ²¡æœ‰å·²ç»æŒ‡å®šçš„å·¥å‚æ–¹æ³• //ä¹Ÿå¯èƒ½æ˜¯å·¥å‚æ–¹æ³•ä¸æ˜¯å”¯ä¸€çš„ï¼Œä¸€ä¸ªç±»æœ‰å¤šä¸ªå·¥å‚æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™å·¥å‚æ–¹æ³•çš„åå­—éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æ–¹æ³•å½¢å‚ä¸åŒ if (candidates == null) &#123; candidates = new ArrayList&lt;&gt;(); //æ‹¿åˆ°å·¥å‚é‡Œé¢çš„æ‰€æœ‰çš„æ–¹æ³• Method[] rawCandidates = getCandidateMethods(factoryClass, mbd); //å¾ªç¯éå†ï¼Œå°†æ»¡è¶³æ¡ä»¶çš„æ–¹æ³•åŠ å…¥åˆ°é›†åˆ //æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼Ÿ æ˜¯é™æ€çš„æ–¹æ³• &amp;&amp; åå­—æ˜¯æŒ‡å®šçš„å·¥å‚æ–¹æ³•çš„åå­— for (Method candidate : rawCandidates) &#123; if (Modifier.isStatic(candidate.getModifiers()) == isStatic &amp;&amp; mbd.isFactoryMethod(candidate)) &#123; candidates.add(candidate); &#125; &#125; &#125; /*æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå…¶å®å¯é€‰ç”¨çš„æ–¹æ³•åˆ—è¡¨å·²ç»éƒ½å¸…é€‰å‡ºæ¥äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å…·ä½“ç¡®å®šæ˜¯å“ªä¸€ä¸ª*/ //å¦‚æœæ°å¥½åªåŒ¹é…åˆ°ä¸€ä¸ªæ–¹æ³• &amp;&amp; å‚æ•°ä¸ºç©º &amp;&amp; è¦åˆ›å»ºçš„å•å®ä¾‹bean çš„æ„é€ å‚æ•°ä¹Ÿä¸ºç©º ï¼Œé‚£è¿™é‡Œå°±æ˜¯ä½¿ç”¨æ— å‚æ„é€ å™¨çš„æƒ…å†µ if (candidates.size() == 1 &amp;&amp; explicitArgs == null &amp;&amp; !mbd.hasConstructorArgumentValues()) &#123; //å°†è¿™ä¸ªæ–¹æ³•æŒ‡å®šä¸ºå”¯ä¸€çš„å·¥å‚æ–¹æ³• Method uniqueCandidate = candidates.get(0); //å¦‚æœå·¥å‚æ–¹æ³•æ²¡æœ‰å½¢å‚ if (uniqueCandidate.getParameterCount() == 0) &#123; //å°†mbdçš„å·¥å‚æ–¹æ³•æŒ‡å®šä¸ºè¿™ä¸ªæ–¹æ³• mbd.factoryMethodToIntrospect = uniqueCandidate; //è®¾ç½®ä¸€äº›å‚æ•°ï¼Œç»™å·¥å‚æ–¹æ³•åˆ›å»ºå¯¹è±¡èµ‹èƒ½ synchronized (mbd.constructorArgumentLock) &#123; mbd.resolvedConstructorOrFactoryMethod = uniqueCandidate; mbd.constructorArgumentsResolved = true; mbd.resolvedConstructorArguments = EMPTY_ARGS; &#125; //é€šè¿‡è¿™ä¸ªåŒ¹é…åˆ°çš„å·¥å‚æ–¹æ³• ï¼Œåˆ©ç”¨ æ— å‚çš„å·¥å‚æ–¹æ³•/æ„é€ å™¨åˆ›å»ºå¯¹è±¡ //å…¶å®æœ¬è´¨ä¸Šè¿˜æ˜¯åˆ©ç”¨åå°„è°ƒç”¨å·¥å‚beançš„å·¥å‚æ–¹æ³• bw.setBeanInstance(instantiate(beanName, mbd, factoryBean, uniqueCandidate, EMPTY_ARGS)); return bw; &#125; &#125; //å¦‚æœåŒ¹é…åˆ°äº†å¤šä¸ªæ–¹æ³• ï¼Œå¯¹åŒ¹é…åˆ°çš„æ–¹æ³•è¿›è¡Œä¸€ä¸ªæ’åº æ’åºè§„åˆ™ ï¼š public &gt; no public &amp;&amp; more args &gt; no args if (candidates.size() &gt; 1) &#123; // explicitly skip immutable singletonList candidates.sort(AutowireUtils.EXECUTABLE_COMPARATOR); &#125; //æ„é€ å‚æ•° ConstructorArgumentValues resolvedValues = null; //å·²è§£æçš„è‡ªåŠ¨è£…é…ä»£ç  == æŒ‡ç¤ºè‡ªåŠ¨è£…é…å¯ä»¥æ»¡è¶³çš„æœ€è´ªå©ªçš„æ„é€ å‡½æ•°çš„å¸¸é‡ //éœ€è¦è§£æåˆ°åº•æ˜¯å“ªä¸€ä¸ªæ–¹æ³• boolean autowiring = (mbd.getResolvedAutowireMode() == AutowireCapableBeanFactory.AUTOWIRE_CONSTRUCTOR); //é€‰æ‹©æƒé‡ å€¼è¶Šä½ï¼Œè¡¨ç¤ºåŒ¹é…åº¦è¶Šé«˜ int minTypeDiffWeight = Integer.MAX_VALUE; //æ¨¡æ£±ä¸¤å¯çš„æ„é€ å™¨é›†åˆ Set&lt;Method&gt; ambiguousFactoryMethods = null; //é€šè¿‡getBean()ä¼ å…¥çš„å‚æ•°çš„ä¸ªæ•°/æ„é€ å™¨å‚æ•°çš„ä¸ªæ•° int minNrOfArgs; //å¦‚æœé€šè¿‡getBean()ä¼ å…¥çš„å‚æ•°ä¸ä¸ºç©º ï¼Œè·å–å‚æ•°çš„ä¸ªæ•° if (explicitArgs != null) &#123; minNrOfArgs = explicitArgs.length; &#125; else &#123; // // getBean()æ²¡æœ‰ä¼ å…¥å‚æ•°ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±å¾—è‡ªå·±å»è§£æbdé‡Œé¢çš„æ„é€ å™¨ if (mbd.hasConstructorArgumentValues()) &#123; //ä»bdå»æ‹¿åˆ°æ„é€ å™¨ ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues(); resolvedValues = new ConstructorArgumentValues(); //å°†å½“å‰beançš„æ–¹æ³•å‚æ•°æˆ–æ„é€ å™¨å‚æ•°è§£æ ï¼Œè¿™é‡Œå¯èƒ½æ¶‰åŠåˆ°æŸ¥æ‰¾å…¶ä»–bean minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues); &#125; else &#123;//è¿™å°±æ˜¯æ— å‚æ„é€ å™¨çš„æƒ…å†µ minNrOfArgs = 0; &#125; &#125; Deque&lt;UnsatisfiedDependencyException&gt; causes = null; //éå†åŒ¹é…åˆ°çš„å¤šä¸ªæ–¹æ³• for (Method candidate : candidates) &#123; //è·å–æ–¹æ³•çš„å‚æ•°ä¸ªæ•° int parameterCount = candidate.getParameterCount(); /*è¿™é‡Œåˆ¤æ–­çš„æŒ‡æ ‡éƒ½æ˜¯ä¸Šé¢å¾ªç¯ç­›é€‰å‡ºæ¥çš„ä¸œè¥¿ * å› ä¸ºcandidatesæ˜¯æ’è¿‡åºçš„ æ’åºè§„åˆ™ï¼špublic &gt; no public &gt; å¤šå‚æ•°çš„ &gt; å‚æ•°å°‘çš„ * å½“å‰ç­›é€‰å‡ºæ¥çš„æ„é€ å™¨ä¼˜å…ˆçº§ä¸€å®šæ˜¯ä¼˜å…ˆäºåé¢çš„æ„é€ å™¨çš„ * */ if (parameterCount &gt;= minNrOfArgs) &#123; ArgumentsHolder argsHolder; //è¿›è¡Œç±»å‹åŒ¹é… Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes(); //å¦‚æœæ˜¾å¼å‚æ•°ä¸ä¸ºç©º if (explicitArgs != null) &#123; // bdä¸­çš„å‚æ•°ä¸ªæ•° å’Œ å½“å‰ç»™å®šçš„å‚æ•°ä¸ªæ•°åŒ¹é…ä¸ä¸Š ï¼Œç›´æ¥æ·˜æ±°å½“å‰æ–¹æ³• if (paramTypes.length != explicitArgs.length) &#123; continue; &#125; //å°†æ˜¾å¼å‚æ•°æ”¾åˆ°holderé‡Œé¢ argsHolder = new ArgumentsHolder(explicitArgs); &#125; else &#123;//è¿™é‡Œæ˜¯æ˜¾å¼å‚æ•°ä¸ºç©ºçš„æƒ…å†µ // å·²è§£æçš„æ„é€ å‡½æ•°å‚æ•°:éœ€è¦ç±»å‹è½¬æ¢å’Œ/æˆ–è‡ªåŠ¨æ³¨å…¥ try &#123; //å­˜æ”¾æ–¹æ³•çš„å‚æ•°åæ•°ç»„ String[] paramNames = null; //å‚æ•°è§£æå™¨ ParameterNameDiscoverer pnd = this.beanFactory.getParameterNameDiscoverer(); if (pnd != null) &#123; //è§£ææ–¹æ³•çš„å‚æ•°åå­— paramNames = pnd.getParameterNames(candidate); &#125; //å¯¹å‚æ•°è¿›è¡Œå°è£… argsHolder = createArgumentArray(beanName, mbd, resolvedValues, bw, paramTypes, paramNames, candidate, autowiring, candidates.size() == 1); &#125; catch (UnsatisfiedDependencyException ex) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Ignoring factory method [&quot; + candidate + &quot;] of bean &#x27;&quot; + beanName + &quot;&#x27;: &quot; + ex); &#125; // Swallow and try next overloaded factory method. if (causes == null) &#123; causes = new ArrayDeque&lt;&gt;(1); &#125; causes.add(ex); continue; &#125; &#125; //è®¡ç®—å½“å‰æ–¹æ³•å‚æ•°å’Œå½“å‰æ–¹æ³•çš„åŒ¹é…åº¦ int typeDiffWeight = (mbd.isLenientConstructorResolution() ? argsHolder.getTypeDifferenceWeight(paramTypes) : argsHolder.getAssignabilityWeight(paramTypes)); // æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜æœ¬æ¬¡çš„åŒ¹é…åº¦é«˜äºä¸Šä¸€è½® if (typeDiffWeight &lt; minTypeDiffWeight) &#123; factoryMethodToUse = candidate; argsHolderToUse = argsHolder; argsToUse = argsHolder.arguments; minTypeDiffWeight = typeDiffWeight; ambiguousFactoryMethods = null; &#125; /* * äº†è§£æ¨¡ç³Šæ€§:å¯¹äºå…·æœ‰ç›¸åŒå‚æ•°æ•°é‡çš„æ–¹æ³•ï¼Œå¦‚æœå­˜åœ¨ç›¸åŒç±»å‹çš„å·®å¼‚æƒé‡ï¼Œåˆ™æ”¶é›†è¿™æ ·çš„å€™é€‰é¡¹ï¼Œå¹¶æœ€ç»ˆå¼•å‘æ¨¡ç³Šæ€§å¼‚å¸¸ã€‚ * ä½†æ˜¯ï¼Œåªåœ¨éå®½æ¾çš„æ„é€ å‡½æ•°è§£ææ¨¡å¼ä¸‹æ‰§è¡Œè¯¥æ£€æŸ¥ï¼Œå¹¶æ˜¾å¼å¿½ç•¥é‡å†™çš„æ–¹æ³•(å…·æœ‰ç›¸åŒçš„å‚æ•°ç­¾å)ã€‚ * */ /*æ¡ä»¶æˆç«‹è¯´æ˜ï¼šå½“å‰å¤„ç†çš„æ„é€ å™¨ ä»–è®¡ç®—å‡ºæ¥çš„typeDiffWeightå€¼ä¸ä¸Šä¸€æ¬¡ç­›é€‰å‡ºæ¥çš„æœ€ä¼˜å…ˆçš„æ„é€ å™¨çš„å€¼ä¸€è‡´ï¼Œæœ‰æ¨¡æ£±ä¸¤å¯çš„æƒ…å†µã€‚åŠ å…¥åˆ°æ¨¡æ£±ä¸¤å¯é›†åˆ*/ else if (factoryMethodToUse != null &amp;&amp; typeDiffWeight == minTypeDiffWeight &amp;&amp; !mbd.isLenientConstructorResolution() &amp;&amp; paramTypes.length == factoryMethodToUse.getParameterCount() &amp;&amp; !Arrays.equals(paramTypes, factoryMethodToUse.getParameterTypes())) &#123; //å¦‚æœæ¨¡æ£±ä¸¤å¯çš„æ„é€ æ–¹æ³•ä¸ºç©ºï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„é›†åˆï¼Œ æŠŠæ»¡è¶³æ¡ä»¶çš„ æ„é€ å™¨æ”¶é›†èµ·æ¥ if (ambiguousFactoryMethods == null) &#123; ambiguousFactoryMethods = new LinkedHashSet&lt;&gt;(); ambiguousFactoryMethods.add(factoryMethodToUse); &#125; //ä¿å­˜æ¨¡æ£±ä¸¤å¯çš„æ„é€ æ–¹æ³• ambiguousFactoryMethods.add(candidate); &#125; &#125; &#125; //å¦‚æœè¦ä½¿ç”¨çš„å·¥å‚æ–¹æ³•ä¸ºç©º æˆ– è¦ä½¿ç”¨çš„å‚æ•°ä¸ºç©ºï¼Œæ„æ€å°±æ˜¯æ²¡æ‰¾åˆ°åˆ›å»ºå¯¹è±¡çš„æ–¹æ³•ï¼Œé‚£å°±å¾—æŠ¥é”™äº†ï¼› if (factoryMethodToUse == null || argsToUse == null) &#123; //å¦‚æœæœ‰å¼‚å¸¸ä¿¡æ¯ï¼Œè®°å½•å¼‚å¸¸ä¿¡æ¯ if (causes != null) &#123; UnsatisfiedDependencyException ex = causes.removeLast(); for (Exception cause : causes) &#123; this.beanFactory.onSuppressedException(cause); &#125; throw ex; &#125; List&lt;String&gt; argTypes = new ArrayList&lt;&gt;(minNrOfArgs); //èµ°åˆ°è¿™é‡Œå°±æ˜¯å¯ç”¨çš„æ–¹æ³•ä¸ºç©ºï¼Œå‚æ•°ä¸ä¸ºç©º if (explicitArgs != null) &#123; //ä¿å­˜å‚æ•°ç±»å‹ for (Object arg : explicitArgs) &#123; argTypes.add(arg != null ? arg.getClass().getSimpleName() : &quot;null&quot;); &#125; &#125; //å¦‚æœæ„é€ å™¨è§£æå‡ºçš„å‚æ•°ä¸ä¸ºç©ºï¼Œè®°å½•æ„é€ å™¨å‚æ•°çš„ç±»å‹ else if (resolvedValues != null) &#123; Set&lt;ValueHolder&gt; valueHolders = new LinkedHashSet&lt;&gt;(resolvedValues.getArgumentCount()); valueHolders.addAll(resolvedValues.getIndexedArgumentValues().values()); valueHolders.addAll(resolvedValues.getGenericArgumentValues()); for (ValueHolder value : valueHolders) &#123; String argType = (value.getType() != null ? ClassUtils.getShortName(value.getType()) : (value.getValue() != null ? value.getValue().getClass().getSimpleName() : &quot;null&quot;)); argTypes.add(argType); &#125; &#125; //å¦åˆ™å°±è¦æŠ›å‡ºå¼‚å¸¸äº† String argDesc = StringUtils.collectionToCommaDelimitedString(argTypes); throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;No matching factory method found on class [&quot; + factoryClass.getName() + &quot;]: &quot; + (mbd.getFactoryBeanName() != null ? &quot;factory bean &#x27;&quot; + mbd.getFactoryBeanName() + &quot;&#x27;; &quot; : &quot;&quot;) + &quot;factory method &#x27;&quot; + mbd.getFactoryMethodName() + &quot;(&quot; + argDesc + &quot;)&#x27;. &quot; + &quot;Check that a method with the specified name &quot; + (minNrOfArgs &gt; 0 ? &quot;and arguments &quot; : &quot;&quot;) + &quot;exists and that it is &quot; + (isStatic ? &quot;static&quot; : &quot;non-static&quot;) + &quot;.&quot;); &#125; //å¦‚æœå·¥å‚æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œé‚£æŒ‡å®šä¸å¯¹ï¼ŒæŠ›å¼‚å¸¸ else if (void.class == factoryMethodToUse.getReturnType()) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Invalid factory method &#x27;&quot; + mbd.getFactoryMethodName() + &quot;&#x27; on class [&quot; + factoryClass.getName() + &quot;]: needs to have a non-void return type!&quot;); &#125; //å¦‚æœæ¨¡æ£±ä¸¤å¯çš„æ–¹æ³•ä¸ä¸ºç©ºï¼ŒæŠ›å¼‚å¸¸ else if (ambiguousFactoryMethods != null) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Ambiguous factory method matches found on class [&quot; + factoryClass.getName() + &quot;] &quot; + &quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): &quot; + ambiguousFactoryMethods); &#125; /*æ¡ä»¶æˆç«‹ï¼šè¯´æ˜è‡ªåŠ¨åŒ¹é…æˆåŠŸäº†ï¼Œéœ€è¦è¿›è¡Œç¼“å­˜ï¼Œæ–¹ä¾¿åæ¥è€…ç»§ç»­ä½¿ç”¨mergerdbeanDefinitionæ¥åˆ›å»ºå®ä¾‹*/ if (explicitArgs == null &amp;&amp; argsHolderToUse != null) &#123; mbd.factoryMethodToIntrospect = factoryMethodToUse; argsHolderToUse.storeCache(mbd, factoryMethodToUse); &#125; &#125; /*æ ¹æ®ä¸Šé¢é€‰æ‹©çš„æ„é€ å™¨å’Œè§£æå‡ºæ¥çš„å‚æ•°ï¼Œé€šè¿‡instantiateæ–¹æ³•åå°„åˆ›å»ºbeanå¯¹è±¡å®ä¾‹ï¼Œæœ€ç»ˆå°†å®ä¾‹è®¾ç½®åˆ°beanWrapperçš„beanInstanceå®ä¾‹é‡Œé¢ã€‚*/ bw.setBeanInstance(instantiate(beanName, mbd, factoryBean, factoryMethodToUse, argsToUse)); return bw;&#125; 6.applyMergedBeanDefinitionPostProcessors()\u0000éå†æ‰€æœ‰çš„åç½®å¤„ç†å™¨è¿›è¡Œæ–¹æ³•è°ƒç”¨ï¼Œå…¸å‹åº”ç”¨ï¼šå¦‚æœå¼€å¯äº†è‡ªåŠ¨ä¾èµ–æ³¨å…¥ï¼Œé‚£ä¹ˆå°±ä¼šå°†ç›¸å…³çš„beanåŠ å…¥åˆ°é›†åˆä¸­ã€‚â€‹ 123456789protected void applyMergedBeanDefinitionPostProcessors(RootBeanDefinition mbd, Class&lt;?&gt; beanType, String beanName) &#123; for (MergedBeanDefinitionPostProcessor processor : getBeanPostProcessorCache().mergedDefinition) &#123; /*è¿™é‡Œæ˜¯åç½®å¤„ç†å™¨ä¸­çš„æ–¹æ³•æ‰§è¡Œçš„é€»è¾‘ * åšäº†ä¸€ä»¶äº‹æƒ…ï¼šæå–å‡ºå½“å‰beanTypeç±»å‹æ•´ä¸ªç»§æ‰¿ä½“ç³»å†…çš„@Autowired @Value @Inject ä¿¡æ¯ å¹¶ä¸”åŒ…è£…æˆä¸€ä¸ªInjectionMetadataçš„ä¸€ä¸ªå¯¹è±¡ * å­˜æ”¾åˆ° AutowiredAnnotationBeanPostProcessor çš„ç¼“å­˜ä¸­ï¼Œkeyæ˜¯beanNameã€‚ * */ processor.postProcessMergedBeanDefinition(mbd, beanType, beanName); &#125;&#125; **MergedBeanDefinitionPostProcessor** 7.registerDisposableBeanIfNecessary()åˆ¤æ–­å½“å‰beanæ˜¯å¦éœ€è¦æ³¨å†Œä¸€ä¸ªéœ€è¦åœ¨å®¹å™¨å…³é—­çš„æ—¶å€™æ‰§è¡Œçš„ææ„å‡½æ•°â€‹ 12345678910111213141516171819202122232425protected void registerDisposableBeanIfNecessary(String beanName, Object bean, RootBeanDefinition mbd) &#123; /*æ¡ä»¶ä¸€ï¼šåŸå‹æ¨¡å¼çš„beanä¸ä¼šæ³¨å†Œææ„å‡½æ•° * æ¡ä»¶äºŒï¼šåˆ¤æ–­å½“å‰beanæ˜¯å¦éœ€è¦æ³¨å†Œææ„å‡½æ•°*/ if (!mbd.isPrototype() &amp;&amp; requiresDestruction(bean, mbd)) &#123; /*å¦‚æœå½“å‰beanå¯¹è±¡æ—¶å•ä¾‹æ¨¡å¼*/ if (mbd.isSingleton()) &#123; // Register a DisposableBean implementation that performs all destruction // work for the given bean: DestructionAwareBeanPostProcessors, // DisposableBean interface, custom destroy method. /*ç»™å½“å‰å•å®ä¾‹beanæ³¨å†Œå›è°ƒé€‚é…å™¨ã€‚é€‚é…å™¨å†… æ ¹æ®å½“å‰beanå®ä¾‹æ˜¯ç»§æ‰¿æ¥å£è¿˜æ˜¯é€šè¿‡è‡ªå®šä¹‰æ¥å†³å®šå…·ä½“è°ƒç”¨å“ªä¸ªæ–¹æ³•ï¼Œå®Œæˆææ„æ“ä½œã€‚*/ registerDisposableBean(beanName, new DisposableBeanAdapter( bean, beanName, mbd, getBeanPostProcessorCache().destructionAware)); &#125; else &#123; /*è¿™æ˜¯è‡ªå®šä¹‰ä½œç”¨åŸŸçš„é€»è¾‘ï¼Œå‹æ ¹ç”¨ä¸åˆ°*/ // A bean with a custom scope... Scope scope = this.scopes.get(mbd.getScope()); if (scope == null) &#123; throw new IllegalStateException(&quot;No Scope registered for scope name &#x27;&quot; + mbd.getScope() + &quot;&#x27;&quot;); &#125; scope.registerDestructionCallback(beanName, new DisposableBeanAdapter( bean, beanName, mbd, getBeanPostProcessorCache().destructionAware)); &#125; &#125;&#125; é¦–å…ˆä¼šè¿›è¡Œæ¡ä»¶è¿‡æ»¤ï¼ŒåŸå‹æ¨¡å¼çš„beanæ’é™¤ï¼Œä¸éœ€è¦æ³¨å†Œçš„beanæ’é™¤ï¼Œæˆ‘ä»¬åªå…³å¿ƒå•å®ä¾‹beançš„æ³¨å†Œé€»è¾‘ï¼Œå…¶ä»–ä½œç”¨åŸŸçš„å¤„ç†é€»è¾‘ä¸éœ€è¦å…³æ³¨ï¼Œåˆ¤æ–­å¦‚æœæ˜¯å•å®ä¾‹beanå¯¹è±¡ï¼Œç»™å½“å‰çš„beanå¯¹è±¡æ³¨å†Œå›è°ƒé€‚é…å™¨ã€‚åœ¨é€‚é…å™¨é‡Œé¢æ ¹æ®å½“å‰beanå®ä¾‹æ˜¯ç»§æ‰¿æ¥å£è¿˜æ˜¯é€šè¿‡è‡ªå®šä¹‰æ¥å†³å®šå…·ä½“è°ƒç”¨å“ªä¸ªæ–¹æ³•å®Œæˆææ„æ“ä½œã€‚â€‹ **DisposableBeanAdapter**\u0000 123456789101112131415161718192021222324252627282930313233343536373839404142@Overridepublic void run() &#123; destroy();&#125;@Overridepublic void destroy() &#123; if (!CollectionUtils.isEmpty(this.beanPostProcessors)) &#123; for (DestructionAwareBeanPostProcessor processor : this.beanPostProcessors) &#123; processor.postProcessBeforeDestruction(this.bean, this.beanName); &#125; &#125; if (this.invokeDisposableBean) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Invoking destroy() on bean with name &#x27;&quot; + this.beanName + &quot;&#x27;&quot;); &#125; try &#123; ((DisposableBean) this.bean).destroy(); &#125; catch (Throwable ex) &#123; String msg = &quot;Invocation of destroy method failed on bean with name &#x27;&quot; + this.beanName + &quot;&#x27;&quot;; if (logger.isDebugEnabled()) &#123; logger.warn(msg, ex); &#125; else &#123; logger.warn(msg + &quot;: &quot; + ex); &#125; &#125; &#125; if (this.destroyMethod != null) &#123; invokeCustomDestroyMethod(this.destroyMethod); &#125; else if (this.destroyMethodName != null) &#123; Method methodToInvoke = determineDestroyMethod(this.destroyMethodName); if (methodToInvoke != null) &#123; invokeCustomDestroyMethod(ClassUtils.getInterfaceMethodIfPossible(methodToInvoke)); &#125; &#125;&#125; æ€»ç»“ä¸€ä¸‹ï¼Œå…¶å®å°±æ˜¯åˆ›å»ºå¯¹è±¡çš„æ—¶å€™åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼šæ— å‚æ„é€ å™¨ï¼Œæœ‰å‚æ„é€ å™¨ï¼Œå·¥å‚æ–¹æ³•ï¼Œåˆ›å»ºå®Œå¯¹è±¡ä¹‹åï¼Œåœ¨æ‰§è¡Œå¯¹åº”çš„åç½®å¤„ç†å™¨(**MergedBeanDefinitionPostProcessor**),æœ€ç»ˆåœ¨åˆ¤æ–­åˆ›å»ºçš„beanå®ä¾‹æ˜¯ä¸æ˜¯éœ€è¦æ³¨å†Œä¸€ä¸ªææ„å‡½æ•°ï¼Œåœ¨å®¹å™¨å…³é—­çš„æ—¶å€™å›è°ƒï¼Œå¦‚æœéœ€è¦å°±åˆ›å»ºå¹¶ä¿å­˜ã€‚","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[å››]getBeanæ–¹æ³•å†…å¹•","slug":"Spring/Spring[å››]getBeanæ–¹æ³•å†…å¹•","date":"2022-01-11T05:59:14.265Z","updated":"2022-01-11T06:06:59.884Z","comments":true,"path":"2022/01/11/Spring/Spring[å››]getBeanæ–¹æ³•å†…å¹•/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E5%9B%9B]getBean%E6%96%B9%E6%B3%95%E5%86%85%E5%B9%95/","excerpt":"","text":"å›é¡¾ä¸€ä¸‹å‰é¢ï¼Œåœ¨**AbstractApplicationContext**ä¸­ï¼Œ**refresh()**å®Œæˆäº†æ•´ä¸ªIOCå®¹å™¨çš„åˆ·æ–°ï¼Œä¸Šå›æˆ‘ä»¬åˆ†æåˆ°äº†åˆå§‹åŒ–å‰©ä¸‹æ‰€æœ‰çš„å•å®ä¾‹beanï¼Œè¿™é‡Œé¢æœ‰å‡ ä¸ªæ ¸å¿ƒçš„åœ°æ–¹ï¼Œ**getBean(),createBean(),populateBean()**,ä¸‰çº§ç¼“å­˜ä¸å¾ªç¯ä¾èµ–ï¼Œå®Œæˆè¿™äº›åï¼Œæ•´ä¸ªIOCå®¹å™¨çš„å¤§ä½“æµç¨‹å°±åˆ†æå®Œäº†ã€‚æœ¬ç¯‡æˆ‘ä»¬æ¥åˆ†æSpringçš„**getBean()**ã€‚ 1.åˆå§‹åŒ–æ‰€æœ‰çš„å•å®ä¾‹beanå¯¹è±¡**finishBeanFactoryInitialization()** 12345678910111213141516171819202122232425262728protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) &#123; // ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–è½¬æ¢æœåŠ¡ if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp; beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123; beanFactory.setConversionService( beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)); &#125; // å¦‚æœå®¹å™¨é‡Œé¢æ²¡æœ‰å­—ç¬¦ä¸²è½¬æ¢å™¨ï¼Œåˆå§‹åŒ–ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢å™¨æ”¾åˆ°å®¹å™¨ä¸­ã€‚ if (!beanFactory.hasEmbeddedValueResolver()) &#123; beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal)); &#125; // å°½æ—©åˆå§‹åŒ–LoadTimeWeaverAware beansï¼Œä»¥ä¾¿å°½æ—©æ³¨å†Œå®ƒä»¬çš„è½¬æ¢å™¨ã€‚ String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false); for (String weaverAwareName : weaverAwareNames) &#123; getBean(weaverAwareName); &#125; // åœæ­¢ä½¿ç”¨ä¸´æ—¶ç±»åŠ è½½å™¨è¿›è¡Œç±»å‹åŒ¹é… beanFactory.setTempClassLoader(null); // å…è®¸ç¼“å­˜æ‰€æœ‰beanå®šä¹‰å…ƒæ•°æ®ï¼Œä¸æœŸæœ›è¿›ä¸€æ­¥çš„æ›´æ”¹ï¼Œå†»ç»“bdä¿¡æ¯ï¼Œå†»ç»“ä¹‹åå°±æ— æ³•å¾€bfæ³¨å†Œbdäº† beanFactory.freezeConfiguration(); // å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„å•å®ä¾‹bean beanFactory.preInstantiateSingletons();&#125; å†»ç»“bdçš„ä¿¡æ¯å®é™…ä¸Šå°±æ˜¯é€šè¿‡ä¸€ä¸ªçŠ¶æ€ä½æ¥æ§åˆ¶çš„ï¼Œè¿™é‡Œé¢æœ€æ ¸å¿ƒçš„ä¸€ä¸ªæ–¹æ³•æˆ–è€…è¯´æ­¥éª¤å°±æ˜¯å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„å•å®ä¾‹beanå¯¹è±¡ã€‚**beanFactory.preInstantiateSingletons()**â€‹ 2.preInstantiateSingletons()12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364@Overridepublic void preInstantiateSingletons() throws BeansException &#123; //æ—¥å¿—æ‰“å° if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Pre-instantiating singletons in &quot; + this); &#125; /*æ‹¿è¿‡æ¥æ‰€æœ‰çš„beanDefinition names ä¿¡æ¯*/ List&lt;String&gt; beanNames = new ArrayList&lt;&gt;(this.beanDefinitionNames); // è§¦å‘æ‰€æœ‰çš„éæ‡’åŠ è½½çš„å•ä¾‹beançš„åˆå§‹åŒ– for (String beanName : beanNames) &#123; //è·å–beançš„å®šä¹‰ä¿¡æ¯ RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName); // beanä¸æ˜¯æŠ½è±¡çš„ æ˜¯å•ä¾‹çš„ ä¸æ˜¯æ‡’åŠ è½½çš„ if (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123; //å¦‚æœæ˜¯å·¥å‚bean if (isFactoryBean(beanName)) &#123; //é€šè¿‡getBeanæ–¹æ³•è·å–bean å‰ç¼€ &amp; æ‹¿åˆ°çš„æ˜¯å·¥å‚bean Object bean = getBean(FACTORY_BEAN_PREFIX + beanName); //å¦‚æœæ‹¿åˆ°çš„beanç¡®å®šæ˜¯å·¥å‚bean if (bean instanceof FactoryBean) &#123; FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean; //åˆ¤æ–­è¿™ä¸ªå·¥å‚beanæ˜¯å¦æœŸæœ›è¢«åˆå§‹åŒ– /*åˆ¤æ–­é€»è¾‘ï¼šSmartFactoryBeané‡Œé¢æœ‰ä¸€ä¸ªisEagerInitæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸ºtrueå°±è¡¨ç¤ºè¿™ä¸ªå·¥å‚beanæ˜¯éœ€è¦ç°åœ¨åˆ›å»ºçš„*/ boolean isEagerInit = (factory instanceof SmartFactoryBean &amp;&amp; ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit()); //å¦‚æœæœŸæœ›è¢«åˆå§‹åŒ– if (isEagerInit) &#123; //é€šè¿‡getBeanèµ°åˆ›å»ºbeançš„é€»è¾‘ getBean(beanName); &#125; &#125; &#125; else &#123;//æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜å°±æ˜¯æ™®é€šçš„å•å®ä¾‹beanï¼Œä¸æ˜¯å·¥å‚beanï¼Œç›´æ¥é€šè¿‡getBeanåˆ›å»ºbean //ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–çš„å…¥å£ï¼š /** * é‡ç‚¹ */ /** * egï¼šman å’Œ women äº§ç”Ÿå¾ªç¯ä¾èµ– * 1.ç¬¬ä¸€æ¬¡æ¥åˆ°è¿™é‡Œæ˜¯é¦–å…ˆå»åˆ›å»ºman */ getBean(beanName); &#125; &#125; &#125; // è§¦å‘æ‰€æœ‰çš„å•å®ä¾‹beançš„åˆå§‹åŒ–åçš„å›è°ƒé€»è¾‘ for (String beanName : beanNames) &#123; //ä»ä¸€çº§ç¼“å­˜è·å–å•å®ä¾‹bean Object singletonInstance = getSingleton(beanName); //ç±»å‹æ–­è¨€ï¼Œæ‰§è¡Œå›è°ƒ /*SmartInitializingSingletoné‡Œé¢æœ‰ä¸€ä¸ªæ–¹æ³• afterSingletonsInstantiated è¿™ä¸ªæ–¹æ³•éœ€è¦åœ¨åˆ›å»ºå¥½å•å®ä¾‹beanä¹‹åè°ƒç”¨ä¸€ä¸‹*/ if (singletonInstance instanceof SmartInitializingSingleton) &#123; StartupStep smartInitialize = this.getApplicationStartup().start(&quot;spring.beans.smart-initialize&quot;) .tag(&quot;beanName&quot;, beanName); SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance; //è¿™é‡Œå°±æ˜¯è§¦å‘åˆå§‹åŒ–åçš„å›è°ƒé€»è¾‘ smartSingleton.afterSingletonsInstantiated(); smartInitialize.end(); &#125; &#125;&#125; è¿™é‡Œæ‹¿åˆ°æ‰€æœ‰çš„**beanDefinition**çš„åå­—ï¼Œç„¶åå¾ªç¯åˆ¤æ–­ï¼šã€ä¸æ˜¯æŠ½è±¡çš„ï¼Œå•å®ä¾‹çš„ï¼Œéæ‡’åŠ è½½çš„ã€‘ï¼Œç„¶åæ ¹æ®æ‹¿åˆ°çš„beanå®šä¹‰ä¿¡æ¯ï¼Œå†åˆ†ä¸º**FactoryBean**å’Œ**Bean**ä¸¤ç§æƒ…å†µè¿›è¡Œå¤„ç†ã€‚ æ¢³ç†ä¸€ä¸‹è¿™é‡Œçš„é‡ç‚¹é€»è¾‘ï¼šâ€‹ åˆå¹¶**beanDefinition**ä¿¡æ¯ **getMergedLocalBeanDefinition(beanName)** è·å–beanå¯¹è±¡ **getBean() ** **SmartInitializingSingleton**å›è°ƒ**afterSingletonsInstantiated() **è§¦å‘å•å®ä¾‹beanåˆå§‹åŒ–åçš„å›è°ƒé€»è¾‘ \u0000æ¥ä¸‹æ¥å…ˆæ¥åˆ†æï¼Œå¦‚ä½•åˆå¹¶beançš„å®šä¹‰ä¿¡æ¯ã€‚â€‹ 3. getMergedLocalBeanDefinition(beanName)1234567891011protected RootBeanDefinition getMergedLocalBeanDefinition(String beanName) throws BeansException &#123; // Quick check on the concurrent map first, with minimal locking. /*ä»ç¼“å­˜è·å–*/ RootBeanDefinition mbd = this.mergedBeanDefinitions.get(beanName); /*ç¼“å­˜æœ‰ï¼Œç›´æ¥è¿”å›*/ if (mbd != null &amp;&amp; !mbd.stale) &#123; return mbd; &#125; /*çœŸæ­£çš„åˆå¹¶ bd çš„é€»è¾‘*/ return getMergedBeanDefinition(beanName, getBeanDefinition(beanName));&#125; é¦–å…ˆä¼šå…ˆå°è¯•ä»ç¼“å­˜æ¥è·å–**beanDefinition**çš„ä¿¡æ¯ï¼Œå¦‚æœç¼“å­˜æœ‰ï¼Œå°±ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±è¦è§¦å‘åˆå¹¶bdçš„é€»è¾‘ã€‚â€‹ 12345protected RootBeanDefinition getMergedBeanDefinition(String beanName, BeanDefinition bd) throws BeanDefinitionStoreException &#123; return getMergedBeanDefinition(beanName, bd, null);&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293protected RootBeanDefinition getMergedBeanDefinition( String beanName, BeanDefinition bd, @Nullable BeanDefinition containingBd) throws BeanDefinitionStoreException &#123; synchronized (this.mergedBeanDefinitions) &#123; /*åˆå¹¶åçš„bdä¿¡æ¯ * */ RootBeanDefinition mbd = null; /*è¡¨ç¤ºå½“å‰beannameå¯¹åº”çš„è¿‡æœŸçš„mbdä¿¡æ¯*/ RootBeanDefinition previous = null; // Check with full lock now in order to enforce the same merged instance. /*null==null*/ if (containingBd == null) &#123; /*ä»ç¼“å­˜æ‹¿ä¿¡æ¯*/ mbd = this.mergedBeanDefinitions.get(beanName); &#125; /*æ¡ä»¶æˆç«‹è¯´æ˜mbd==nullæˆ–è€… è¿‡æœŸ...*/ if (mbd == null || mbd.stale) &#123; /*è¡¨ç¤ºå½“å‰beannameå¯¹åº”çš„è¿‡æœŸçš„mbdä¿¡æ¯*/ previous = mbd; /*æ²¡æœ‰å½“å‰beanName å¯¹åº”çš„ bd æ²¡æœ‰ä½¿ç”¨ç»§æ‰¿ é‚£ä¹ˆå°±ä¸ç”¨å¤„ç†ç»§æ‰¿ */ if (bd.getParentName() == null) &#123; // Use copy of given root bean definition. /*å¦‚æœ mbd æ˜¯ root bean*/ if (bd instanceof RootBeanDefinition) &#123; /*å…‹éš†ä¸€ä»½ä¿å­˜*/ mbd = ((RootBeanDefinition) bd).cloneBeanDefinition(); &#125; else &#123; /*å¦åˆ™ç›´æ¥åˆ›å»ºä¸€ä¸ªroot bean*/ mbd = new RootBeanDefinition(bd); &#125; &#125;/*è¯´æ˜å½“å‰beanName å¯¹åº”çš„ beanDefinition å­˜åœ¨ç»§æ‰¿å…³ç³»*/ else &#123; /*è¡¨ç¤ºbd çš„çˆ¶ä¿¡æ¯*/ BeanDefinition pbd; try &#123; /*å¤„ç†beanName æ‹¿åˆ°å¤„ç†äº†åˆ«åå’Œ&amp;çš„çœŸæ˜¯çˆ¶bd beanName åç§°*/ String parentBeanName = transformedBeanName(bd.getParentName()); /*æ¡ä»¶æˆç«‹ è¯´æ˜ å­ bd å’Œçˆ¶ bd åç§°ä¸ä¸€æ ·ï¼Œå°±æ˜¯æ™®é€šæƒ…å†µ*/ if (!beanName.equals(parentBeanName)) &#123; /*é€’å½’å½“å‰æ–¹æ³•ï¼Œæœ€ç»ˆè¿”å›çˆ¶ bd ä¿¡æ¯*/ pbd = getMergedBeanDefinition(parentBeanName); &#125; else &#123;/*ç‰¹æ®Šï¼šçˆ¶å­bdåç§°ä¸€æ ·*/ BeanFactory parent = getParentBeanFactory(); if (parent instanceof ConfigurableBeanFactory) &#123; pbd = ((ConfigurableBeanFactory) parent).getMergedBeanDefinition(parentBeanName); &#125; else &#123; throw new NoSuchBeanDefinitionException(parentBeanName, &quot;Parent name &#x27;&quot; + parentBeanName + &quot;&#x27; is equal to bean name &#x27;&quot; + beanName + &quot;&#x27;: cannot be resolved without a ConfigurableBeanFactory parent&quot;); &#125; &#125; &#125; catch (NoSuchBeanDefinitionException ex) &#123; throw new BeanDefinitionStoreException(bd.getResourceDescription(), beanName, &quot;Could not resolve parent bean definition &#x27;&quot; + bd.getParentName() + &quot;&#x27;&quot;, ex); &#125; // æŒ‰ç…§çˆ¶bdä¿¡æ¯åˆ›å»º mbd å¯¹è±¡ mbd = new RootBeanDefinition(pbd); // ç”¨å­bd è¦†ç›–mbdä¿¡æ¯ï¼Œä»¥å­bd ä¸ºåŸºå‡† çˆ¶ bdä¸ºè¾… mbd.overrideFrom(bd); &#125; // Set default singleton scope, if not configured before. if (!StringUtils.hasLength(mbd.getScope())) &#123; mbd.setScope(SCOPE_SINGLETON); &#125; // A bean contained in a non-singleton bean cannot be a singleton itself. // Let&#x27;s correct this on the fly here, since this might be the result of // parent-child merging for the outer bean, in which case the original inner bean // definition will not have inherited the merged outer bean&#x27;s singleton status. if (containingBd != null &amp;&amp; !containingBd.isSingleton() &amp;&amp; mbd.isSingleton()) &#123; mbd.setScope(containingBd.getScope()); &#125; // Cache the merged bean definition for the time being // (it might still get re-merged later on in order to pick up metadata changes) if (containingBd == null &amp;&amp; isCacheBeanMetadata()) &#123; /*ç¼“å­˜åˆå¹¶åçš„ mbdä¿¡æ¯*/ this.mergedBeanDefinitions.put(beanName, mbd); &#125; &#125; if (previous != null) &#123; copyRelevantMergedBeanDefinitionCaches(previous, mbd); &#125; return mbd; &#125;&#125; è¿™é‡Œé¢éœ€è¦å…³æ³¨çš„ç‚¹æœ‰ä¸¤ä¸ªï¼šâ€‹ å¦‚ä½•å¤„ç†beançš„åå­— **transformedBeanName()** å¦‚ä½•åˆå¹¶bdä¿¡æ¯ **getMergedBeanDefinition()** â€‹ 4.å¤„ç†beançš„åå­—12345678910protected String transformedBeanName(String name) &#123; /* * è¿”å› BeanFactoryUtils.transformedBeanName(name) å¤„ç†å®Œçš„bean name ï¼Œè¿™é‡Œä¹Ÿå¯èƒ½æ˜¯åˆ«åã€‚ * springçš„beanåˆ«åæ˜¯é€šè¿‡aliasMapä¿å­˜çš„ã€‚ * &#123;C:B,B:A&#125; aæœ‰ä¸€ä¸ªåˆ«åå«åš b bæœ‰ä¸€ä¸ªåˆ«åå«åš c * * é€šè¿‡è¿™ä¸ªæ–¹æ³•canonicalName å»å¤„ç† beançš„åå­— å’Œåˆ«åä¹‹é—´çš„å…³ç³» ï¼Œæœ€ç»ˆè¿”å›çš„æ˜¯ bean çš„çœŸå®åå­—ã€‚ * */ return canonicalName(BeanFactoryUtils.transformedBeanName(name));&#125; 4.1 canonicalName()å¤„ç†beançš„åå­—ä¸åˆ«åã€‚â€‹ 123456789101112131415161718public String canonicalName(String name) &#123; /*å‡è®¾ä¼ å…¥c*/ String canonicalName = name; // Handle aliasing... String resolvedName; do &#123; /*æ ¹æ®cä¼šä»mapæ‹¿åˆ°b*/ resolvedName = this.aliasMap.get(canonicalName); /*å¦‚æœè·å–åˆ°çš„ç»“æœä¸æ˜¯null*/ if (resolvedName != null) &#123; /*èµ‹å€¼å†æ¬¡å¾ªç¯æ‹¿*/ canonicalName = resolvedName; &#125; &#125; /*å½“resolvedNameæ˜¯ç©ºçš„æ—¶å€™ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„canonicalNameä¸€å®šæ˜¯æœ€ç»ˆçš„åå­—ï¼Œè¿”å›å³å¯ã€‚*/ while (resolvedName != null); return canonicalName;&#125; 4.2 BeanFactoryUtils.transformedBeanName(name)1234567891011121314151617181920212223242526public static String transformedBeanName(String name) &#123; /*æ–­è¨€*/ Assert.notNull(name, &quot;&#x27;name&#x27; must not be null&quot;); /*å¦‚æœå½“å‰beanå¯¹è±¡ä¸æ˜¯ &amp; å¼€å¤´ ï¼ˆè¯´æ˜æ˜¯æ­£å¸¸beanå¯¹è±¡å®ä¾‹ï¼‰ ç›´æ¥è¿”å›*/ if (!name.startsWith(BeanFactory.FACTORY_BEAN_PREFIX)) &#123; return name; &#125; /* * è¿™é‡Œæ˜¯æ‹¿å·¥å‚beançš„é€»è¾‘ï¼š * transformedBeanNameCacheï¼šç¼“å­˜å¤„ç†å®Œ&amp;å¼€å¤´çš„beanNameï¼Œæå‡æ€§èƒ½ * map.computeIfAbsent(k,v) è¯´æ˜ï¼š * å½“mapä¸­å¯¹åº”çš„k ==null || v ==null è¿™æ¬¡å†™æ“ä½œå°±ä¼šæˆåŠŸï¼Œå¹¶ä¸”è¿”å› k vï¼Œ * å¦åˆ™å°±ä¼šå¤±è´¥ï¼Œå¹¶ä¸”è¿”å›åŸæœ‰çš„k vã€‚ */ return transformedBeanNameCache.computeIfAbsent(name, beanName -&gt; &#123; /** * å‡è®¾bean name = &amp;abc * åˆ¤æ–­å¦‚æœnameä¸æ˜¯ä»¥ &amp;å¼€å¤´ è·³å‡ºå¾ªç¯ æœ€ç»ˆä¼šè¿”å› abcã€‚ */ do &#123; beanName = beanName.substring(BeanFactory.FACTORY_BEAN_PREFIX.length()); &#125; while (beanName.startsWith(BeanFactory.FACTORY_BEAN_PREFIX)); return beanName; &#125;);&#125; 5.åˆå¹¶bdä¿¡æ¯**getMergedBeanDefinition()**â€‹ 1234567891011protected RootBeanDefinition getMergedLocalBeanDefinition(String beanName) throws BeansException &#123; // Quick check on the concurrent map first, with minimal locking. /*ä»ç¼“å­˜è·å–*/ RootBeanDefinition mbd = this.mergedBeanDefinitions.get(beanName); /*ç¼“å­˜æœ‰ï¼Œç›´æ¥è¿”å›*/ if (mbd != null &amp;&amp; !mbd.stale) &#123; return mbd; &#125; /*çœŸæ­£çš„åˆå¹¶ bd çš„é€»è¾‘*/ return getMergedBeanDefinition(beanName, getBeanDefinition(beanName));&#125; 12345protected RootBeanDefinition getMergedBeanDefinition(String beanName, BeanDefinition bd) throws BeanDefinitionStoreException &#123; return getMergedBeanDefinition(beanName, bd, null);&#125; å†å¾€ä¸‹å…¶å®åˆå›åˆ°äº†ä¸Šé¢çš„**getMergedBeanDefinition()**ï¼Œé€’å½’å»å¤„ç†bdä¿¡æ¯ã€‚ åˆå¹¶å®Œbdä¿¡æ¯ä¹‹åå°±æ˜¯åˆ¤æ–­æ˜¯å¦æ˜¯å·¥å‚beançš„é€»è¾‘ï¼Œæƒ³è¦è·å–å·¥å‚beanï¼Œåœ¨å‰é¢æåˆ°è¿‡ï¼Œéœ€è¦åœ¨beançš„åå­—å‰é¢åŠ ä¸€ä¸ª &amp; ã€‚â€‹ é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦çœ‹å•å®ä¾‹beançš„è·å–è¿‡ç¨‹ï¼Œæ­¤æ—¶æˆ‘ä»¬å»çœ‹ **getBean()**ã€‚â€‹ 6.è·å–å•å®ä¾‹beanå¯¹è±¡**getBean()**â€‹ 12345@Overridepublic Object getBean(String name) throws BeansException &#123; /*çœŸæ­£åŠ è½½beançš„æ–¹æ³•*/ return doGetBean(name, null, null, false);&#125; **doGetBean()** è¿”å›ä¸€ä¸ªæŒ‡å®šçš„beanå®ä¾‹ï¼Œè¿™ä¸ªbeanå¯ä»¥æ˜¯å…±äº«çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å•ä¾‹çš„ã€‚â€‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246protected &lt;T&gt; T doGetBean( String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException &#123; /* * å¤„ç†è½¬æ¢beanåå­—ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªåˆ«åï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå¸¦ç€&amp; å¼€å¤´çš„beanName * åˆ«åï¼šé‡å®šå‘å‡ºæ¥çœŸçš„beanName * &amp;å¼€å¤´ï¼šè¯´æ˜è¦è·å–çš„beanå®ä¾‹å¯¹è±¡å®é™…ä¸Šæ˜¯ä¸€ä¸ªå·¥å‚bean * FactoryBean ï¼šå¦‚æœæŸä¸ªbeançš„é…ç½®ç‰¹åˆ«å¤æ‚ï¼Œä½¿ç”¨springç®¡ç†ä¸å®¹æ˜“...ä¸å¤Ÿçµæ´»ï¼Œæƒ³è¦ä½¿ç”¨ç¼–ç çš„å½¢å¼å»æ„å»ºå®ƒï¼Œ * é‚£ä¹ˆä½ å°±å¯ä»¥æä¾›ä¸€ä¸ªæ„å»ºè¯¥beanå®ä¾‹çš„å·¥å‚ï¼Œè¿™ä¸ªå·¥å‚å°±æ˜¯factoryBeanæ¥å£ * factoryBeanæ¥å£çš„å®ç°ç±»è¿˜æ˜¯éœ€è¦springæ¥ç®¡ç†çš„ã€‚ * è¿™é‡Œå°±æ¶‰åŠåˆ°ä¸¤ç§å¯¹è±¡ï¼šä¸€ç§æ˜¯beanFactoryå®ç°ç±» å¦ä¸€ä¸ªæ˜¯FactoryBeanå†…éƒ¨ç®¡ç†çš„å¯¹è±¡ã€‚ * * å¦‚æœè¦è·å–å·¥å‚beanï¼Œéœ€è¦è·å– &amp; * å¦‚æœè¦æ‹¿factoryBeanå†…éƒ¨ç®¡ç†çš„å¯¹è±¡ï¼Œç›´æ¥ä¼ name ä¸éœ€è¦å¸¦ç€ &amp; */ String beanName = transformedBeanName(name); //ä¿ç•™è¿”å›å€¼çš„ Object beanInstance; /*åˆ°ç¼“å­˜ä¸­è·å–å…±äº«å•å®ä¾‹ ç¬¬ä¸€æ¬¡å»ç¼“å­˜æ‹¿*/ /** * 1.ç¬¬ä¸€æ¬¡ç»è¿‡è¿™é‡Œæ˜¯åˆ›å»ºmançš„æ—¶å€™ï¼Œé¦–å…ˆå»ç¼“å­˜è·å–ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œmanå¯¹è±¡æ—¶ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œæ‰€ä»¥ä»€ä¹ˆéƒ½æ‹¿ä¸åˆ° * 2.æ­¤æ—¶manåœ¨ç¬¬ä¸‰çº§ç¼“å­˜ï¼Œç„¶åå»æ‹¿womenï¼Œè¿™ä¸ªæ—¶å€™womenè¿˜æ²¡åˆ›å»ºï¼Œæ‰€ä»¥é”¤å­ä¹Ÿæ‹¿ä¸åˆ° * 3.ç¬¬ä¸‰æ¬¡ç»è¿‡è¿™é‡Œçš„æ—¶å€™ï¼Œå®é™…ä¸Šå°±æ˜¯womenåˆ›å»ºå®Œäº†ï¼Œæ”¾åˆ°ä¸‰çº§ç¼“å­˜äº†ï¼Œç„¶åå‘ç°å±æ€§èµ‹å€¼çš„æ—¶å€™éœ€è¦manï¼Œåˆé€šè¿‡getBeanæ¥æ‹¿ï¼Œ * è¿™ä¸ªæ—¶å€™ï¼Œåœ¨ç¬¬ä¸‰çº§ç¼“å­˜æ‹¿åˆ°äº†æ—©æœŸå¯¹è±¡çš„å¼•ç”¨ï¼Œç„¶åå¹¶å¯¹manè¿›è¡Œä¸€ä¸ªç¼“å­˜å‡çº§ ï¼Œä» ä¸‰çº§ç¼“å­˜å‡çº§åˆ°äº†äºŒçº§ */ Object sharedInstance = getSingleton(beanName); /*æ­¤æ—¶çš„é€»è¾‘åº”è¯¥æ˜¯ä»äºŒçº§ç¼“å­˜æ‹¿åˆ°äº†æ—©æœŸæš´éœ²çš„beanå®ä¾‹ï¼Œå¹¶ä¸”å±æ€§æ²¡æœ‰å¡«å……*/ /*è¿™é‡Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºbeanå®ä¾‹ï¼Œä¸Šé¢ä»ä¸€çº§ç¼“å­˜å®é™…ä¸Šæ˜¯å•¥ä¹Ÿæ²¡æ‹¿åˆ°ï¼Œæ‰€ä»¥èµ°åˆ°è¿™é‡Œï¼Œå®ä¾‹æ˜¯nullã€‚*/ if (sharedInstance != null &amp;&amp; args == null) &#123; if (logger.isTraceEnabled()) &#123; if (isSingletonCurrentlyInCreation(beanName)) &#123; logger.trace(&quot;Returning eagerly cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;); &#125; else &#123; logger.trace(&quot;Returning cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; &#125; /* * è¿™é‡Œä¸ºä»€ä¹ˆåˆè¦åŒ…è£…ä¸€å±‚å‘¢ï¼Ÿ * ä»iocä¸­æ‹¿åˆ°çš„å¯¹è±¡å¯èƒ½æ˜¯æ™®é€šçš„å•å®ä¾‹ï¼Œä¹Ÿå¯èƒ½æ˜¯FactoryBeanå®ä¾‹ * å¦‚æœæ˜¯FactoryBeanå®ä¾‹ï¼Œè¿˜è¦è€ƒè™‘è¿›è¡Œå¤„ç† ä¸»è¦çœ‹nameå¸¦ä¸å¸¦ &amp; * å¸¦&amp;è¯´æ˜è¿™æ¬¡getBeanæƒ³è¦æ‹¿å·¥å‚beanï¼Œå¦åˆ™æƒ³è¦æ‹¿ FactoryBean å†…éƒ¨ç®¡ç†çš„ bean å®ä¾‹ */ /** * 1.èµ°åˆ°è¿™é‡Œæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿåˆ›å»ºmanï¼Œç„¶åå¯¹manè¿›è¡Œå±æ€§èµ‹å€¼ï¼Œå‘ç°éœ€è¦womenï¼Œç„¶åé€’å½’å»åˆ›å»ºwomenï¼Œç„¶åå¯¹womenè¿›è¡Œå±æ€§èµ‹å€¼ï¼Œ * ç„¶åå‘ç°éœ€è¦manï¼Œç„¶åä»ç¼“å­˜æ‹¿ï¼Œæ°å¥½æ­¤æ—¶ä»ä¸‰çº§ç¼“å­˜æ‹¿åˆ°äº†ï¼Œæ—©æœŸmanå¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè¿™é‡Œå•¥ä¹Ÿæ²¡å¹²ï¼Œç›´æ¥return */ beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, null); &#125; /* * æ‰§è¡Œåˆ°è¿™é‡Œçš„æƒ…å†µï¼šsharedInstance == null || args != null * 1. äºŒçº§ç¼“å­˜æœªæ‹¿åˆ°beanå®ä¾‹ * 2. äºŒçº§ç¼“å­˜æ‹¿åˆ°äº†beanå®ä¾‹ï¼Œä½†æ˜¯å±æ€§å·²ç»å¡«å……å®Œäº† ï¼ï¼ï¼è¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œè¿™æ ·çš„è¯å°±åœ¨ä¸€çº§ç¼“å­˜äº†ã€‚ * * ç¼“å­˜æ²¡æœ‰æƒ³è¦çš„æ•°æ® * 1.åŸå‹å¾ªç¯ä¾èµ–é—®é¢˜çš„åˆ¤å®š */ else &#123; /* * åŸå‹å¾ªç¯ä¾èµ–çš„åˆ¤å®š * egï¼š a(prototype) - b b - a (prototype) * 1.ä¼šåƒæ­£åœ¨åˆ›å»ºä¸­çš„åŸå‹é›†åˆæ·»åŠ  a * 2.åˆ›å»º a æ—©æœŸå¯¹è±¡ äºŒçº§ç¼“å­˜ * 3.å¤„ç† açš„ä¾èµ– å‘ç° a ä¾èµ– b ç±»å‹ * 4.è§¦å‘ spring getBeab(b.class) çš„æ“ä½œ * 5.æ ¹æ® b çš„æ„é€ æ–¹æ³• åå°„åˆ›å»º b çš„æ—©æœŸå®ä¾‹ * 6.spring å¤„ç† b å¯¹è±¡çš„ä¾èµ–å‘ç°ä¾èµ–äº† a * 7.æ‰€ä»¥springç –å¤´å›æ¥å†æ¬¡è·å– a getBean(a.class) * 8.ç¨‹åºå†æ¬¡æ¥åˆ°è¿™é‡Œä¼šåˆ¤æ–­å½“å‰è¦è·å–çš„aå¯¹è±¡æ˜¯ä¸æ˜¯æ­£åœ¨åˆ›å»ºä¸­ å¦‚æœæ˜¯å¾ªç¯ä¾èµ– ä¼šè¿”å›true ï¼Œæœ€ç»ˆæŠ›å‡ºå¼‚å¸¸ ç»“æŸäº†å¾ªç¯ä¾èµ–æ³¨å…¥ */ if (isPrototypeCurrentlyInCreation(beanName)) &#123; throw new BeanCurrentlyInCreationException(beanName); &#125; /*çˆ¶å­å®¹å™¨ç›¸å…³çš„å¤„ç†é€»è¾‘*/ BeanFactory parentBeanFactory = getParentBeanFactory(); if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123; // Not found -&gt; check parent. String nameToLookup = originalBeanName(name); if (parentBeanFactory instanceof AbstractBeanFactory) &#123; return ((AbstractBeanFactory) parentBeanFactory).doGetBean( nameToLookup, requiredType, args, typeCheckOnly); &#125; else if (args != null) &#123; // Delegation to parent with explicit args. return (T) parentBeanFactory.getBean(nameToLookup, args); &#125; else if (requiredType != null) &#123; // No args -&gt; delegate to standard getBean method. return parentBeanFactory.getBean(nameToLookup, requiredType); &#125; else &#123; return (T) parentBeanFactory.getBean(nameToLookup); &#125; &#125; /*ç©¿çš„æ˜¯falseå°±æˆç«‹*/ if (!typeCheckOnly) &#123; /* * å°†æŒ‡å®šçš„ bean æ ‡è®°ä¸ºå·²åˆ›å»ºï¼ˆæˆ–å³å°†åˆ›å»ºï¼‰ã€‚ * å…è®¸ bean å·¥å‚ä¼˜åŒ–å…¶ç¼“å­˜ä»¥é‡å¤åˆ›å»ºæŒ‡å®š beanã€‚ */ /** * 1.ç¬¬ä¸€æ¬¡åˆ›å»ºmançš„æ—¶å€™ï¼Œç»è¿‡è¿™é‡Œï¼Œæ ‡è®°manæ­£åœ¨åˆ›å»ºä¸­ * 2.ç¬¬äºŒæ¬¡ç»è¿‡è¿™é‡Œçš„æ—¶å€™ï¼Œå°±æ˜¯å¯¹manè¿›è¡Œå±æ€§èµ‹å€¼çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°ä¾èµ–womenï¼Œæ‰€ä»¥å»èµ°getBeané€»è¾‘ã€‚è¿™ä¸ªæ—¶å€™å»æ ‡è®°womenä¹Ÿæ˜¯æ­£åœ¨è¢«åˆ›å»ºä¸­ */ markBeanAsCreated(beanName); &#125; StartupStep beanCreation = this.applicationStartup.start(&quot;spring.beans.instantiate&quot;) .tag(&quot;beanName&quot;, name); try &#123; if (requiredType != null) &#123; beanCreation.tag(&quot;beanType&quot;, requiredType::toString); &#125; /*è·å–åˆå¹¶beanDefinitionä¿¡æ¯ * ä¸ºä»€ä¹ˆéœ€è¦åˆå¹¶ï¼Ÿ * bd æ”¯æŒç»§æ‰¿ å­ ä¼š ç»§æ‰¿ çˆ¶äº² çš„æ‰€æœ‰ ä¿¡æ¯ * */ RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); /*åˆ¤æ–­å½“å‰mbdæ˜¯ä¸æ˜¯æŠ½è±¡çš„ï¼Œå¦‚æœæ˜¯æŠ½è±¡çš„ï¼Œéœ€è¦æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºæŠ½è±¡çš„bdä¸èƒ½åˆ›å»ºå®ä¾‹ï¼Œåªèƒ½ä½œä¸ºæ¨¡æ¿è®©å­bdç»§æ‰¿*/ checkMergedBeanDefinition(mbd, beanName, args); // Guarantee initialization of beans that the current bean depends on. /* * depends-on å±æ€§å¤„ç† * &lt;bean name=&quot;A&quot; depends-on=&quot;B&quot; /&gt; * &lt;bean name=&quot;B&quot; /&gt; * * å¾ªç¯ä¾èµ–é—®é¢˜ b - a a - b * springæ˜¯å¤„ç†ä¸äº†è¿™ç§æƒ…å†µçš„ï¼Œéœ€è¦æŠ¥é”™ * springéœ€è¦å‘ç°è¿™ç§æƒ…å†µçš„äº§ç”Ÿï¼š * å¦‚ä½•å‘ç°ï¼Ÿä¾é ä¸¤ä¸ªmap * 1.dependentBeanMap è®°å½•ä¾èµ–å½“å‰beanNameçš„å…¶ä»–beanName * 2.dependenciesForBeanMap è®°å½•å½“å‰beanä¾èµ–çš„å…¶ä»–beané›†åˆ * */ String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) &#123; for (String dep : dependsOn) &#123; /*åˆ¤æ–­å¾ªç¯ä¾èµ–*/ if (isDependent(beanName, dep)) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Circular depends-on relationship between &#x27;&quot; + beanName + &quot;&#x27; and &#x27;&quot; + dep + &quot;&#x27;&quot;); &#125; /* * æ³¨å†Œä¾èµ–å…³ç³» * 1.è®°å½•aä¾èµ–äº†è° * 2.è®°å½•è°ä¾èµ–äº†b * */ registerDependentBean(dep, beanName); try &#123; getBean(dep); &#125; catch (NoSuchBeanDefinitionException ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;&#x27;&quot; + beanName + &quot;&#x27; depends on missing bean &#x27;&quot; + dep + &quot;&#x27;&quot;, ex); &#125; &#125; &#125; // åˆ›å»ºå•å®ä¾‹ if (mbd.isSingleton()) &#123; /*ç¬¬äºŒä¸ª getSingthon() åˆ›å»ºå®ä¾‹å¹¶è¿”å›*/ /** * 1.ç¬¬ä¸€æ¬¡ç»è¿‡è¿™é‡Œæ˜¯å»åˆ›å»ºmanå¯¹è±¡ * 2.åˆ›å»ºwomenå¯¹è±¡ */ sharedInstance = getSingleton(beanName, () -&gt; &#123; try &#123; return createBean(beanName, mbd, args); &#125; catch (BeansException ex) &#123; // Explicitly remove instance from singleton cache: It might have been put there // eagerly by the creation process, to allow for circular reference resolution. // Also remove any beans that received a temporary reference to the bean. destroySingleton(beanName); throw ex; &#125; &#125;); /* * è¿™é‡Œä¸ºä»€ä¹ˆä¸ç›´æ¥è¿”å› ï¼Œè¿˜è°ƒç”¨ è¿™ä¸ªæ–¹æ³•ï¼Ÿ * åˆ›å»ºå‡ºæ¥çš„å•å®ä¾‹beanä¹Ÿå¯èƒ½æ˜¯å·¥å‚beanå¯¹è±¡ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®åå­—åˆ¤æ–­åˆ°åº•è¿”å› * beanå¯¹è±¡è¿˜æ˜¯å·¥å‚bean * */ beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); &#125; /*å¤šä¾‹beançš„åˆ›å»º*/ else if (mbd.isPrototype()) &#123; // It&#x27;s a prototype -&gt; create a new instance. Object prototypeInstance = null; try &#123; /*è®°å½•å½“å‰çº¿ç¨‹ç›¸å…³çš„æ­£åœ¨åˆ›å»ºçš„åŸå‹å¯¹è±¡beanName*/ beforePrototypeCreation(beanName); /*åˆ›å»ºå¯¹è±¡*/ prototypeInstance = createBean(beanName, mbd, args); &#125; finally &#123; /*ä»æ­£åœ¨åˆ›å»ºä¸­çš„é›†åˆä¸­ç§»é™¤*/ afterPrototypeCreation(beanName); &#125; beanInstance = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd); &#125; /*otherä½œç”¨åŸŸï¼š ç•¥ ....*/ else &#123; String scopeName = mbd.getScope(); if (!StringUtils.hasLength(scopeName)) &#123; throw new IllegalStateException(&quot;No scope name defined for bean Â´&quot; + beanName + &quot;&#x27;&quot;); &#125; Scope scope = this.scopes.get(scopeName); if (scope == null) &#123; throw new IllegalStateException(&quot;No Scope registered for scope name &#x27;&quot; + scopeName + &quot;&#x27;&quot;); &#125; try &#123; Object scopedInstance = scope.get(beanName, () -&gt; &#123; beforePrototypeCreation(beanName); try &#123; return createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; &#125;); beanInstance = getObjectForBeanInstance(scopedInstance, name, beanName, mbd); &#125; catch (IllegalStateException ex) &#123; throw new ScopeNotActiveException(beanName, scopeName, ex); &#125; &#125; &#125; catch (BeansException ex) &#123; beanCreation.tag(&quot;exception&quot;, ex.getClass().toString()); beanCreation.tag(&quot;message&quot;, String.valueOf(ex.getMessage())); cleanupAfterBeanCreationFailure(beanName); throw ex; &#125; finally &#123; beanCreation.end(); &#125; &#125; /** * 1.èµ°åˆ°è¿™é‡Œçš„é€»è¾‘ï¼šå¯¹manè¿›è¡Œå±æ€§èµ‹å€¼ï¼Œé€’å½’åˆ›å»ºwomenï¼Œå¯¹womenè¿›è¡Œå±æ€§èµ‹å€¼ï¼Œç„¶åä»ç¼“å­˜æ‹¿åˆ°äº†man */ return adaptBeanInstance(name, beanInstance, requiredType);&#125; è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘æœ‰ç‚¹å¤šï¼Œè¿›è¡Œä¸€ä¸ªç®€å•çš„æ¢³ç†ï¼šâ€‹ é¦–å…ˆä¸Šæ¥å…ˆå¤„ç†beançš„åå­— **transformedBeanName(name)** ç„¶åå°è¯•é€šè¿‡ **getSingleton(beanName) **å»ä¸€çº§ç¼“å­˜æ‹¿æ•°æ®ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™è¿™ä¸ªbeanå¯¹è±¡è¿˜æ²¡æœ‰åˆ›å»ºè¿‡ï¼Œæ­¤æ—¶æ˜¯æ‹¿ä¸åˆ°æ•°æ®çš„ã€‚ å¦‚æœè¯´æ‹¿åˆ°äº†beanå¯¹è±¡ï¼Œé‚£ä¹ˆå°±å†é€šè¿‡ **getObjectForBeanInstance() **å¯¹beanå¯¹è±¡è¿›è¡Œä¸€å±‚åŒ…è£…ã€‚ è¿™é‡Œä¸ºä»€ä¹ˆåˆè¦åŒ…è£…ä¸€å±‚å‘¢ï¼Ÿä»IOCä¸­æ‹¿åˆ°çš„å¯¹è±¡å¯èƒ½æ˜¯æ™®é€šå•å®ä¾‹beanå¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå·¥å‚beanå¯¹è±¡ã€‚å¦‚æœæ˜¯å·¥å‚beanå¯¹è±¡ï¼Œè¿˜éœ€è¦è€ƒè™‘æ˜¯ä¸æ˜¯éœ€è¦å¤„ç†ï¼Œä¸»è¦æ˜¯çœ‹åå­—é‡Œé¢å¸¦ä¸å¸¦ &amp; ã€‚å¦‚æœå¸¦ &amp; ï¼Œå°±æ˜¯æƒ³è¦æ‹¿å·¥å‚æœ¬èº«ï¼Œå¦‚æœä¸å¸¦ &amp; ï¼Œå…¶å®å°±æ˜¯æƒ³æ‹¿å·¥å‚beanç”Ÿäº§çš„å¯¹è±¡ã€‚ æ­£å¸¸ç¬¬ä¸€æ¬¡å»è·å–beanå¯¹è±¡çš„æ—¶å€™ï¼Œæ˜¯åœ¨ç¼“å­˜æ‹¿ä¸åˆ°æ•°æ®çš„ï¼Œæ‰€ä»¥ä¼šèµ°elseçš„é€»è¾‘ã€‚ åˆ¤æ–­æ˜¯ä¸æ˜¯åŸå‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–ï¼Œå¦‚æœæ˜¯çš„è¯ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚ ç„¶åå°±æ˜¯æŠ¤ç†çˆ¶å­å®¹å™¨ç›¸å…³çš„é€»è¾‘ å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºbeanï¼Œå°±ä¼šé€šè¿‡ä¸€ä¸ªçŠ¶æ€ä½æ¥æ ‡è®°beanæ­£åœ¨åˆ›å»ºä¸­ è·å–åˆå¹¶åçš„bdä¿¡æ¯ åˆ¤æ–­å½“å‰beanå¯¹è±¡æ˜¯ä¸æ˜¯æŠ½è±¡çš„ï¼Œå¦‚æœæ˜¯æŠ½è±¡çš„ï¼Œéœ€è¦è·‘å‡ºå¼‚å¸¸ï¼Œå› ä¸ºæŠ½è±¡çš„beanæ˜¯æ¨¡æ¿beanï¼Œä¸èƒ½åˆ›å»ºå®ä¾‹ åˆ¤æ–­æ˜¯ä¸æ˜¯å‘ç”Ÿäº’ç›¸ä¾èµ–ï¼Œæ³¨æ„æ˜¯äº’ç›¸ä¾èµ–ï¼Œä¸æ˜¯å¾ªç¯ä¾èµ–ï¼Œå¦‚æœæ˜¯å‘ç”Ÿäº†äº’ç›¸ä¾èµ–ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ äº’ç›¸ä¾èµ–ï¼šbeanæ ‡ç­¾æˆ–è€…@Bean æ³¨è§£é‡Œé¢é…ç½®äº† **depends-on=&quot;B&quot; a-&gt;b , b-&gt;a**â€‹ å¾ªç¯ä¾èµ–ï¼šaé‡Œé¢æœ‰ä¸ªå±æ€§å«åšbï¼Œbé‡Œé¢æœ‰ä¸ªå±æ€§a\u0000 æ³¨å†Œä¾èµ–å…³ç³»ï¼Œè®°å½•å½“å‰beanä¾èµ–äº†è°ï¼Œè°ä¾èµ–äº†å½“å‰bean åˆ¤æ–­å¦‚æœæ˜¯å•å®ä¾‹beanï¼Œè¿™æ¬¡å°±ä¼šé€šè¿‡**getSingleton()-&gt;createBean()**å»åˆ›å»ºbeanå¯¹è±¡ ç„¶åå†é€šè¿‡**getObjectForBeanInstance() **å¯¹beanå¯¹è±¡è¿›è¡Œä¸€å±‚åŒ…è£… å¦‚æœæ˜¯åŸå‹å®ä¾‹çš„beanå¯¹è±¡ï¼Œå°±ä¼šèµ°å¤šå®ä¾‹beanåˆ›å»ºçš„æµç¨‹ï¼Œå…¶å®è¿˜æ˜¯é€šè¿‡**createBean()**å»åˆ›å»ºå¯¹è±¡ï¼Œåªæ˜¯ä¸ä¼šè¢«ä¸€çº§ç¼“å­˜æ‰€ç¼“å­˜ã€‚ å¯¹äºå…¶ä»–ä½œç”¨åŸŸçš„beanå¯¹è±¡ï¼Œåˆ™èµ°ä»–ä»¬çš„åˆ›å»ºé€»è¾‘ï¼Œå†æ¬¡ä¸ä½œä¸ºé‡ç‚¹å†…å®¹åˆ†æã€‚ æœ€ç»ˆçš„é€»è¾‘**adaptBeanInstance()**å…¶å®å°±æ˜¯å¯¹å¾ªç¯ä¾èµ–çš„å¤„ç†ï¼Œå¯¹ Aå¯¹è±¡å±æ€§èµ‹å€¼çš„æ—¶å€™ï¼Œå‘ç°éœ€è¦Bå¯¹è±¡ã€‚ç„¶åä»ä¸€çº§ç¼“å­˜æ‹¿å‘ç°æ²¡æœ‰ï¼Œå°±èµ°è¿™é‡Œé€’å½’å»åˆ›å»ºBå¯¹è±¡ï¼Œä»ç¼“å­˜æ‹¿åˆ°Aå¯¹è±¡ï¼Œå¯¹Bå¯¹è±¡è¿›è¡Œå±æ€§èµ‹å€¼ã€‚ 7.getSingleton()çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œä»ç¼“å­˜æ¥è·å–beanã€‚è¿™ä¸ªæ–¹æ³•åœ¨ **DefaultSingletonRegistry** ä¸­ã€‚â€‹ 123456@Override@Nullablepublic Object getSingleton(String beanName) &#123; /*æ–¹æ³•é‡è½½ allowEarlyReference æ˜¯å¦å…è®¸æ‹¿åˆ°æ—©æœŸå¼•ç”¨*/ return getSingleton(beanName, true);&#125; \u0000è¿™é‡Œå‘ç”Ÿäº†æ–¹æ³•é‡è½½ã€‚è¿™ä¸ªæ–¹æ³•æŒºå¼çš„ï¼Œæ ¹æ®åç§°æ¥è¿”å›å•å®ä¾‹beanå¯¹è±¡ï¼Œèƒ½å¤Ÿè§£å†³å¾ªç¯ä¾èµ–ã€‚â€‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970@Nullableprotected Object getSingleton(String beanName, boolean allowEarlyReference) &#123; /*é€šè¿‡åå­—å»ä¸€çº§ç¼“å­˜æ‹¿å•å®ä¾‹beanå¯¹è±¡*/ Object singletonObject = this.singletonObjects.get(beanName); /*å¦‚æœæ‹¿åˆ°çš„å¯¹è±¡å®ä¾‹æ˜¯nullï¼Œæœ‰å‡ ç§æƒ…å†µï¼Ÿ * 1.å•å®ä¾‹ç¡®å®æ²¡åˆ›å»ºå‘¢ * 2. å½“å‰æ­£åœ¨åˆ›å»ºä¸­ï¼Œå‘ç”Ÿäº†å¾ªç¯ä¾èµ–äº†ï¼Œè¿™ä¸ªæ—¶å€™å®ä¾‹å…¶å®åœ¨äºŒçº§ç¼“å­˜ * * å¾ªç¯ä¾èµ–ï¼š * A-&gt;B B-&gt;A * å•å®ä¾‹çš„å¾ªç¯ä¾èµ–æœ‰å‡ ç§ï¼Ÿ * 1.æ„é€ æ–¹æ³• æ— è§£ * 2.setter æœ‰è§£ é€šè¿‡ä¸‰çº§ç¼“å­˜ * * ä¸‰çº§ç¼“å­˜å®é™…ä¸Šå¦‚ä½•è§£å†³çš„å¾ªç¯ä¾èµ–ï¼Ÿ * åˆ©ç”¨beançš„ä¸­é—´çŠ¶æ€ ï¼šå·²ç»å®ä¾‹åŒ–ä½†æ˜¯è¿˜æœªåˆå§‹åŒ– * A-B B-&gt;A setterä¾èµ– * 1. å‡è®¾springå…ˆå®ä¾‹åŒ–Aï¼Œé¦–å…ˆæ‹¿åˆ°Açš„æ„é€ æ–¹æ³•ï¼Œåå°„åˆ›å»ºAçš„æ—©æœŸå®ä¾‹å¯¹è±¡ï¼Œè¿™ä¸ªæ—©æœŸå¯¹è±¡è¢«åŒ…è£…äº†ä¸€ä¸‹ï¼Œ * å˜æˆObjectFactoryå¯¹è±¡ï¼Œæ”¾åˆ°ä¸‰çº§ç¼“å­˜ã€‚ * 2. å¤„ç†Açš„ä¾èµ–æ•°æ®ï¼Œæ£€æŸ¥å‘ç° Aä¾èµ–B ï¼Œæ‰€ä»¥ï¼Œspring æ ¹æ® Bçš„ç±»å‹å»å®¹å™¨ä¸­å»getBean(B.class) ,è¿™é‡Œå°±æ˜¯é€’å½’äº† * 3. é¦–å…ˆæ‹¿åˆ°Bçš„æ„é€ æ–¹æ³•ï¼Œåå°„åˆ›å»ºBçš„æ—©æœŸå®ä¾‹å¯¹è±¡ï¼ŒæŠŠBåŒ…è£…æˆObjectFactoryå¯¹è±¡ï¼Œæ”¾åˆ°ä¸‰çº§ç¼“å­˜ã€‚ * 4. å¤„ç†Bde ä¾èµ–æ•°æ®ï¼Œæ£€æŸ¥å‘ç°ï¼ŒBä¾èµ–å¯¹è±¡Aï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ï¼Œspringå°±ä¼šæ ¹æ®Aç±»å‹å»å®¹å™¨å»getBean(A.class) å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™åˆé€’å½’äº† * 5. ç¨‹åºè¿˜ä¼šèµ°åˆ°å½“å‰æ–¹æ³•getSingleton * 6. æ¡ä»¶ä¸€æˆç«‹ï¼Œæ¡ä»¶äºŒæˆç«‹ã€‚ * */ if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123; /*ä»äºŒçº§ç¼“å­˜æ‹¿æ•°æ®*/ singletonObject = this.earlySingletonObjects.get(beanName); /*æ¡ä»¶æˆç«‹è¯´æ˜äºŒçº§ç¼“å­˜æ²¡æœ‰ å»ä¸‰çº§ç¼“å­˜æ‹¿*/ if (singletonObject == null &amp;&amp; allowEarlyReference) &#123; synchronized (this.singletonObjects) &#123; /* * springä¸ºä»€ä¹ˆéœ€è¦æœ‰ä¸‰çº§ç¼“å­˜ï¼Œè€Œä¸æ˜¯åªæœ‰äºŒçº§ç¼“å­˜ï¼Ÿ * AOP é ä»€ä¹ˆå®ç°å‘¢ï¼ŸåŠ¨æ€ä»£ç† jdk cglib * ä»£ç†ï¼šé™æ€ä»£ç†ï¼šéœ€è¦æ‰‹åŠ¨å†™ä»£ç å®ç°æ–°çš„JAVAæ–‡ä»¶ï¼Œè¿™ä¸ªJAVç±»éœ€è¦å’Œä»£ç†å¯¹è±¡å®ç°åŒä¸€ä¸ªæ¥å£ï¼Œå†…éƒ¨ç»´æŠ¤ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡ * ä»£ç†ç±»åœ¨æ¥å£è°ƒç”¨åŸç”Ÿå¯¹è±¡å‰åå¯ä»¥åŠ ä¸€äº›é€»è¾‘ã€‚ * ä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†å¯¹è±¡æ˜¯ä¸¤ä¸ªä¸åŒçš„å†…å­˜åœ°å€ï¼Œä¸€å®šæ˜¯ä¸ä¸€æ ·çš„ * åŠ¨æ€ä»£ç†ï¼š... ä¸éœ€è¦äººä¸ºå†™ä»£ç äº†ï¼Œè€Œæ˜¯ä¾é å­—èŠ‚ç æ¡†æ¶åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼Œç„¶åjvmåœ¨è¿›è¡ŒåŠ è½½ï¼Œç„¶åä¹Ÿæ˜¯ä¸€æ · * ä¹Ÿæ˜¯å»newä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡æ²¡å•¥ç‰¹æ®Šçš„ï¼Œä¹Ÿæ˜¯å†…éƒ¨ä¿ç•™äº†åŸç”Ÿå¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨åŸç”Ÿå¯¹è±¡å‰åå®ç°çš„å­—èŠ‚ç å¢å¼ºã€‚ * ä¸¤è€…å…±åŒç‚¹ï¼šä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†å¯¹è±¡å®é™…ä¸Šéƒ½ä¸æ˜¯åŒä¸€å†…å­˜åœ°å€ * * ä¸‰çº§ç¼“å­˜åœ¨è¿™é‡Œæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ * ä¸‰çº§ç¼“å­˜é‡Œé¢ä¿å­˜çš„æ˜¯å¯¹è±¡å·¥å‚ï¼Œè¿™ä¸ªå¯¹è±¡å·¥å‚å†…éƒ¨ä¿ç•™ç€åŸç”Ÿå¯¹è±¡çš„å¼•ç”¨ï¼ŒObjectFactoryçš„å®ç°ç±»ï¼ŒgetObjectæ–¹æ³•ï¼Œ * éœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼šåˆ°åº•æ˜¯è¿”å›åŸç”Ÿçš„ï¼Œè¿˜æ˜¯å¢å¼ºçš„ï¼Ÿ * getObjectä¼šåˆ¤æ–­å½“å‰æ—©æœŸå®ä¾‹æ˜¯å¦éœ€è¦è¢«å¢å¼ºï¼Œå¦‚æœæ˜¯ é‚£ä¹ˆæå‰å®ŒæˆåŠ¨æ€ä»£ç†å¢å¼ºï¼Œè¿”å›ä»£ç†å¯¹è±¡ï¼Œå¦åˆ™ï¼Œè¿”å›åŸç”Ÿå¯¹è±¡ã€‚ * */ /*ä»ä¸€çº§ç¼“å­˜æ‹¿*/ singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) &#123; /*ä»äºŒçº§ç¼“å­˜æ‹¿*/ singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null) &#123; /*ä»ä¸‰çº§ç¼“å­˜æ‹¿*/ ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); /*æ¡ä»¶æˆç«‹ï¼šè¯´æ˜ç¬¬ä¸‰çº§ç¼“å­˜æœ‰æ•°æ®ã€‚è¿™é‡Œå°±æ¶‰åŠåˆ°äº†ç¼“å­˜çš„å‡çº§ ï¼Œå¾ˆç®€å• ï¼Œä»ä¸‰çº§æŒªåˆ°äºŒçº§ ï¼Œå†åæ‰‹å¹²æ‰ä¸‰çº§çš„ã€‚*/ if (singletonFactory != null) &#123; singletonObject = singletonFactory.getObject(); this.earlySingletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); &#125; &#125; &#125; &#125; &#125; &#125; return singletonObject;&#125; æ¢³ç†ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å¤§ä½“é€»è¾‘ï¼š(æˆ‘ä»¬ç°åœ¨èµ°çš„æ˜¯å•å®ä¾‹beanåˆ›å»ºçš„æµç¨‹ï¼Œæ‰€ä»¥å‡è®¾æˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸€ä¸ªå•å®ä¾‹beanï¼Œæ‰§è¡Œåˆ°äº†è¿™é‡Œï¼Œä¸‰çº§ç¼“å­˜ä¸å¾ªç¯ä¾èµ–çš„é—®é¢˜ä¼šåœ¨åç»­æ–‡ç« åˆ†æã€‚)â€‹ å…ˆæ ¹æ®åå­—å»ä¸€çº§ç¼“å­˜æ‹¿beanï¼Œæ­¤æ—¶æ˜¯æ‹¿ä¸åˆ°çš„ã€‚ åˆ¤æ–­å½“å‰beanï¼Œæ˜¯ä¸æ˜¯å•å®ä¾‹beanå¯¹è±¡ï¼Œæ˜¯ä¸æ˜¯æ­£åœ¨åˆ›å»ºä¸­ï¼Ÿ èµ°è¿™é‡Œçš„é€»è¾‘å°±æ˜¯å‘ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼š å‡è®¾springå…ˆå®ä¾‹åŒ–Aï¼Œé¦–å…ˆæ‹¿åˆ°Açš„æ„é€ æ–¹æ³•ï¼Œåå°„åˆ›å»ºAçš„æ—©æœŸå®ä¾‹å¯¹è±¡ï¼Œè¿™ä¸ªæ—©æœŸå¯¹è±¡è¢«åŒ…è£…äº†ä¸€ä¸‹ï¼Œå˜æˆObjectFactoryå¯¹è±¡ï¼Œæ”¾åˆ°ä¸‰çº§ç¼“å­˜ã€‚\u0000\u00002. å¤„ç†Açš„ä¾èµ–æ•°æ®ï¼Œæ£€æŸ¥å‘ç° Aä¾èµ–B ï¼Œæ‰€ä»¥ï¼Œspring æ ¹æ® Bçš„ç±»å‹å»å®¹å™¨ä¸­å»getBean(B.class) ,è¿™é‡Œå°±æ˜¯é€’å½’äº†\u0000 é¦–å…ˆæ‹¿åˆ°Bçš„æ„é€ æ–¹æ³•ï¼Œåå°„åˆ›å»ºBçš„æ—©æœŸå®ä¾‹å¯¹è±¡ï¼ŒæŠŠBåŒ…è£…æˆObjectFactoryå¯¹è±¡ï¼Œæ”¾åˆ°ä¸‰çº§ç¼“å­˜ã€‚\u0000 å¤„ç†Bde ä¾èµ–æ•°æ®ï¼Œæ£€æŸ¥å‘ç°ï¼ŒBä¾èµ–å¯¹è±¡Aï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ï¼Œspringå°±ä¼šæ ¹æ®Aç±»å‹å»å®¹å™¨å»getBean(A.class) å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™åˆé€’å½’äº†\u0000 ç¨‹åºè¿˜ä¼šèµ°åˆ°å½“å‰æ–¹æ³•getSingleton\u0000 é¦–å…ˆå»äºŒçº§ç¼“å­˜æ‹¿æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™äºŒçº§ç¼“å­˜æ˜¯æ‹¿ä¸åˆ°æ•°æ®çš„ï¼Œæ‰€ä»¥ä¼šç»§ç»­å¾€ä¸‹èµ° å†æ¬¡å°è¯•ä»ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜æ‹¿ï¼Œè¿™ä¸ªæ—¶å€™å…¶å®è¿˜æ˜¯æ‹¿ä¸åˆ°çš„ï¼Œæ‰€ä»¥ä»ä¸‰çº§ç¼“å­˜æ¥æ‹¿ å¦‚æœä¸‰çº§ç¼“å­˜æ‹¿åˆ°äº†æ•°æ®ï¼Œé‚£å°±è¿›è¡Œç¼“å­˜çš„å‡çº§ æŠŠä¸‰çº§ç¼“å­˜çš„å¯¹è±¡æ‹¿åˆ°äºŒçº§ç¼“å­˜ï¼Œä¸‰çº§ç¼“å­˜çš„å¯¹è±¡å¹²æ‰ã€‚ â€‹ 8.æ€è€ƒä¸æ²‰æ·€springä¸ºä»€ä¹ˆéœ€è¦æœ‰ä¸‰çº§ç¼“å­˜ï¼Œè€Œä¸æ˜¯åªæœ‰äºŒçº§ç¼“å­˜ï¼ŸAOP é ä»€ä¹ˆå®ç°å‘¢ï¼ŸåŠ¨æ€ä»£ç† jdk cglibä»£ç†ï¼šé™æ€ä»£ç†ï¼šéœ€è¦æ‰‹åŠ¨å†™ä»£ç å®ç°æ–°çš„JAVAæ–‡ä»¶ï¼Œè¿™ä¸ªJAVç±»éœ€è¦å’Œä»£ç†å¯¹è±¡å®ç°åŒä¸€ä¸ªæ¥å£ï¼Œå†…éƒ¨ç»´æŠ¤ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡ ä»£ç†ç±»åœ¨æ¥å£è°ƒç”¨åŸç”Ÿå¯¹è±¡å‰åå¯ä»¥åŠ ä¸€äº›é€»è¾‘ã€‚ ä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†å¯¹è±¡æ˜¯ä¸¤ä¸ªä¸åŒçš„å†…å­˜åœ°å€ï¼Œä¸€å®šæ˜¯ä¸ä¸€æ ·çš„ åŠ¨æ€ä»£ç†ï¼šâ€¦ ä¸éœ€è¦äººä¸ºå†™ä»£ç äº†ï¼Œè€Œæ˜¯ä¾é å­—èŠ‚ç æ¡†æ¶åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼Œç„¶åjvmåœ¨è¿›è¡ŒåŠ è½½ï¼Œç„¶åä¹Ÿæ˜¯ä¸€æ · ä¹Ÿæ˜¯å»newä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡æ²¡å•¥ç‰¹æ®Šçš„ï¼Œä¹Ÿæ˜¯å†…éƒ¨ä¿ç•™äº†åŸç”Ÿå¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨åŸç”Ÿå¯¹è±¡å‰åå®ç°çš„å­—èŠ‚ç å¢å¼ºã€‚ä¸¤è€…å…±åŒç‚¹ï¼šä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†å¯¹è±¡å®é™…ä¸Šéƒ½ä¸æ˜¯åŒä¸€å†…å­˜åœ°å€â€‹ ä¸‰çº§ç¼“å­˜åœ¨è¿™é‡Œæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿä¸‰çº§ç¼“å­˜é‡Œé¢ä¿å­˜çš„æ˜¯å¯¹è±¡å·¥å‚ï¼Œè¿™ä¸ªå¯¹è±¡å·¥å‚å†…éƒ¨ä¿ç•™ç€åŸç”Ÿå¯¹è±¡çš„å¼•ç”¨ï¼ŒObjectFactoryçš„å®ç°ç±»ï¼ŒgetObjectæ–¹æ³•ï¼Œéœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼šåˆ°åº•æ˜¯è¿”å›åŸç”Ÿçš„ï¼Œè¿˜æ˜¯å¢å¼ºçš„ï¼ŸgetObjectä¼šåˆ¤æ–­å½“å‰æ—©æœŸå®ä¾‹æ˜¯å¦éœ€è¦è¢«å¢å¼ºï¼Œå¦‚æœæ˜¯ é‚£ä¹ˆæå‰å®ŒæˆåŠ¨æ€ä»£ç†å¢å¼ºï¼Œè¿”å›ä»£ç†å¯¹è±¡ï¼Œå¦åˆ™ï¼Œè¿”å›åŸç”Ÿå¯¹è±¡ã€‚â€‹ 9.getObjectForBeanInstance()è¿™ä¸ªæ–¹æ³•æ˜¯è·å–ç»™å®šçš„beanå®ä¾‹å¯¹è±¡ï¼Œå¦‚æœæ˜¯å·¥å‚beanï¼Œåˆ™æ ¹æ®åå­—è¿”å›å·¥å‚æœ¬èº«æˆ–è€…å…¶åˆ›å»ºçš„å¯¹è±¡ã€‚â€‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162/** * è·å–ç»™å®š bean å®ä¾‹çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯ FactoryBeanï¼Œåˆ™æ˜¯ bean å®ä¾‹æœ¬èº«æˆ–å…¶åˆ›å»ºçš„å¯¹è±¡ã€‚ * @param beanInstance å…±äº«å•å®ä¾‹å¯¹è±¡ * @param name æœªå¤„ç† &amp; çš„ name * @param beanName å¤„ç†è¿‡&amp; å’Œåˆ«ååçš„name * @param mbd the merged bean definition åˆå¹¶è¿‡åçš„beanDefinitionä¿¡æ¯ * @return the object to expose for the bean */protected Object getObjectForBeanInstance( Object beanInstance, String name, String beanName, @Nullable RootBeanDefinition mbd) &#123; /*åˆ¤æ–­å½“å‰çš„nameæ˜¯ä¸æ˜¯&amp;å¼€å§‹çš„ï¼Œæ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰è¦è·å–çš„æ˜¯å·¥å‚beanå¯¹è±¡*/ if (BeanFactoryUtils.isFactoryDereference(name)) &#123; if (beanInstance instanceof NullBean) &#123; return beanInstance; &#125; /*æ¡ä»¶æˆç«‹ï¼šè¯´æ˜ä½†å®ä¾‹å¯¹è±¡ä¸æ˜¯å·¥å‚beanæ¥å£çš„å®ç°ç±» ç›´æ¥æŠ¥é”™*/ if (!(beanInstance instanceof FactoryBean)) &#123; throw new BeanIsNotAFactoryException(beanName, beanInstance.getClass()); &#125; /*æ‰“æ ‡ ç»™å½“å‰beanå¯¹åº”çš„mbdæ‰“æ ‡ï¼Œè®°å½•ä»–è¡¨è¾¾çš„å®ä¾‹æ˜¯ä¸€ä¸ªå·¥å‚bean*/ if (mbd != null) &#123; mbd.isFactoryBean = true; &#125; return beanInstance; &#125; /* * æ‰§è¡Œåˆ°è¿™é‡Œæœ‰å‡ ç§æƒ…å†µï¼Ÿ * 1.å½“å‰beanå®ä¾‹æ˜¯æ™®é€šå•å®ä¾‹ * 2.å½“å‰beanå®ä¾‹æ˜¯å·¥å‚beanæ¥å£å®ç°ç±»ï¼Œä½†æ˜¯å½“å‰è¦è·å–çš„æ˜¯å·¥å‚å†…éƒ¨ç®¡ç†çš„beanå®ä¾‹ */ if (!(beanInstance instanceof FactoryBean)) &#123; return beanInstance; &#125; /*ä¿å­˜å·¥å‚beanå®ä¾‹çš„getobjectå€¼å¾—*/ Object object = null; if (mbd != null) &#123; mbd.isFactoryBean = true; &#125; else &#123; /*å°è¯•åˆ°ç¼“å­˜è·å–å·¥å‚bean*/ object = getCachedObjectForFactoryBean(beanName); &#125; /*æ­¤æ—¶è¯´æ˜ç¼“å­˜æ²¡æœ‰ï¼Œéœ€è¦åˆ°å·¥å‚bean getObject è·å–*/ if (object == null) &#123; // Return bean instance from factory. FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance; // æ¡ä»¶ä¸€å‡ ä¹æ’æˆç«‹ æ¡ä»¶äºŒï¼šåˆ¤æ–­springä¸­å½“å‰æ˜¯å¦æœ‰å½“å‰beanNameçš„bdä¿¡æ¯ if (mbd == null &amp;&amp; containsBeanDefinition(beanName)) &#123; /*æ‹¿åˆ°åˆå¹¶åçš„bdä¿¡æ¯ * ä¸ºä»€ä¹ˆæ˜¯åˆå¹¶åçš„å‘¢ï¼Ÿ * å› ä¸ºbdæ”¯æŒç»§æ‰¿çš„ï¼Œåˆå¹¶åçš„bdä¿¡æ¯æ˜¯åŒ…å«ç»§æ‰¿å›æ¥çš„bd * */ mbd = getMergedLocalBeanDefinition(beanName); &#125; /*syntheticé»˜è®¤å€¼æ˜¯false ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ å¦‚æœæ˜¯ true è¡¨ç¤ºæ˜¯ç³»ç»Ÿå¯¹è±¡*/ boolean synthetic = (mbd != null &amp;&amp; mbd.isSynthetic()); /*åˆ°è¿™é‡Œè¯´æ˜ è¯´æ˜çœŸæ­£çš„å»æ‰§è¡Œ getBean() çš„é€»è¾‘ time ã€51ï¼š32ã€‘*/ object = getObjectFromFactoryBean(factory, beanName, !synthetic); &#125; return object;&#125; â€‹ åˆ¤æ–­å½“å‰çš„nameæ˜¯ä¸æ˜¯ &amp; å¼€å§‹çš„ï¼Œæ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰è¦è·å–çš„æ˜¯å·¥å‚beanå¯¹è±¡ å¦‚æœå½“å‰beanç‹¬äº«æ²¡æœ‰å®ç°å·¥å‚beanæ¥å£ï¼Œç›´æ¥æŠ¥é”™ æ‰“æ ‡ï¼šç»™å½“å‰beanå¯¹åº”çš„mbdæ‰“æ ‡ï¼Œè®°å½•ä»–è¡¨è¾¾çš„å®ä¾‹æ˜¯ä¸€ä¸ªå·¥å‚beanå¯¹è±¡ è¿”å›beanå®ä¾‹ åˆ¤æ–­å¦‚æœå½“å‰beanæ²¡æœ‰å®ç°å·¥å‚beanæ¥å£ï¼Œï¼ˆæ€è€ƒä¸€ä¸‹ï¼Œèµ°åˆ°è¿™é‡Œçš„é€»è¾‘ï¼Œå…¶å®è¦ä¹ˆæ˜¯å•å®ä¾‹beanï¼Œè¦ä¹ˆæ˜¯è·å–å·¥å‚beanåˆ›å»ºçš„å¯¹è±¡ï¼‰ï¼Œæ—¢ç„¶æ²¡æœ‰å®ç°å·¥å‚beanæ¥å£ï¼Œæ‰€ä»¥è¿™é‡Œçš„é€»è¾‘å°±æ˜¯å¤„ç†å•å®ä¾‹beançš„ã€‚ ç›´æ¥è¿”å›å°±è¡Œäº† èµ°åˆ°è¿™é‡Œçš„é€»è¾‘å°±æ˜¯ä¸€ç§æƒ…å†µï¼šè·å–å·¥å‚beanåˆ›å»ºçš„beanå¯¹è±¡ã€‚ åœ¨mbdæ‰“æ ‡ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªå·¥å‚beanå¯¹è±¡ å¦‚æœç¼“å­˜é‡Œé¢æ²¡æœ‰å½“å‰beanå·¥å‚ç”Ÿäº§çš„å¯¹è±¡ï¼Œéœ€è¦é€šè¿‡å·¥å‚beançš„**getBean()**å»è·å–ã€‚ åˆ¤æ–­æœ‰æ²¡æœ‰bdä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰å°±åˆå¹¶bdä¿¡æ¯å¾—åˆ°mbdä¿¡æ¯ ç„¶åå†é€šè¿‡**getObjectFromFactoryBean() **æ ¹æ®mbdä¿¡æ¯å»è·å–beanå¯¹è±¡ \u0000 9.1 getObjectFromFactoryBean()è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘ä¸Šå­˜åœ¨é—®é¢˜ï¼Œä½†æ˜¯ä¸å½±å“åˆ†æã€‚â€‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556protected Object getObjectFromFactoryBean(FactoryBean&lt;?&gt; factory, String beanName, boolean shouldPostProcess) &#123; /*å¦‚æœæ˜¯å·²ç»å­˜åœ¨çš„å•å®ä¾‹beanå¯¹è±¡*/ if (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123; /*åŠ é” å†…éƒ¨é€»è¾‘æ˜¯ä¸²è¡ŒåŒ–çš„ï¼Œä¸å­˜åœ¨å¹¶å‘*/ synchronized (getSingletonMutex()) &#123; /*å…ˆä»ç¼“å­˜è·å–*/ Object object = this.factoryBeanObjectCache.get(beanName); if (object == null) &#123; /*è¿™é‡Œå·²ç»æ˜¯ç©ºäº†*/ object = doGetObjectFromFactoryBean(factory, beanName); // Only post-process and store if not put there already during getObject() call above // (e.g. because of circular reference processing triggered by custom getBean calls) Object alreadyThere = this.factoryBeanObjectCache.get(beanName); /*è¿™é‡Œä¸€å®šæ˜¯ç©ºï¼Œå› ä¸ºæ˜¯ä¸²è¡ŒåŒ–çš„æ–¹æ³•ï¼Œæ‰€ä»¥é€»è¾‘æœ‰é—®é¢˜*/ if (alreadyThere != null) &#123; object = alreadyThere; &#125; else &#123; if (shouldPostProcess) &#123; /*åˆ¤æ–­å½“å‰å®ä¾‹æ˜¯å¦è¢«åˆ›å»º é€»è¾‘æœ‰é—®é¢˜ æ˜æ˜ä¸Šé¢å°±æ˜¯æ²¡åˆ›å»º */ if (isSingletonCurrentlyInCreation(beanName)) &#123; // Temporarily return non-post-processed object, not storing it yet.. return object; &#125; beforeSingletonCreation(beanName); try &#123; /*æ‰§è¡Œåç½®å¤„ç†å™¨çš„é€»è¾‘*/ object = postProcessObjectFromFactoryBean(object, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(beanName, &quot;Post-processing of FactoryBean&#x27;s singleton object failed&quot;, ex); &#125; finally &#123; afterSingletonCreation(beanName); &#125; &#125; if (containsSingleton(beanName)) &#123; this.factoryBeanObjectCache.put(beanName, object); &#125; &#125; &#125; return object; &#125; /*å·¥å‚beanå¯¹è±¡å†…éƒ¨ç»´æŠ¤çš„å¯¹è±¡ä¸æ˜¯å•å®ä¾‹ï¼Œæ¯æ¬¡éƒ½æ˜¯ä¸€ä¸ªæ–°å¯¹è±¡*/ &#125; else &#123; /*ç›´æ¥æ‹¿*/ Object object = doGetObjectFromFactoryBean(factory, beanName); if (shouldPostProcess) &#123; try &#123; /*åç½®å¤„ç†å™¨çš„é€»è¾‘*/ object = postProcessObjectFromFactoryBean(object, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(beanName, &quot;Post-processing of FactoryBean&#x27;s object failed&quot;, ex); &#125; &#125; return object; &#125;&#125; ifé‡Œé¢çš„åˆ¤æ–­æ˜¯ä¸ä¼šæˆç«‹çš„ï¼Œæ‰€ä»¥ç›´æ¥çœ‹elseçš„é€»è¾‘ã€‚â€‹ é€šè¿‡å§”æ´¾æ¨¡å¼å§”æ´¾ç»™**doGetObjectFromFactoryBean()**å»æ‹¿beanå¯¹è±¡ï¼Œç„¶åå†æ‰§è¡Œåç½®å¤„ç†å™¨çš„é€»è¾‘ã€‚â€‹ ç»§ç»­å¾€ä¸‹åˆ†æï¼šâ€‹ 9.2 doGetObjectFromFactoryBean()1234567891011121314151617181920212223private Object doGetObjectFromFactoryBean(FactoryBean&lt;?&gt; factory, String beanName) throws BeanCreationException &#123; Object object; try &#123; object = factory.getObject(); &#125; catch (FactoryBeanNotInitializedException ex) &#123; throw new BeanCurrentlyInCreationException(beanName, ex.toString()); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(beanName, &quot;FactoryBean threw exception on object creation&quot;, ex); &#125; // Do not accept a null value for a FactoryBean that&#x27;s not fully // initialized yet: Many FactoryBeans just return null then. if (object == null) &#123; if (isSingletonCurrentlyInCreation(beanName)) &#123; throw new BeanCurrentlyInCreationException( beanName, &quot;FactoryBean which is currently in creation returned null from getObject&quot;); &#125; object = new NullBean(); &#125; return object;&#125; è¿™é‡Œé¢çš„æ ¸å¿ƒä»£ç å…¶å®å°±æ˜¯åªæœ‰ä¸€å¥ï¼šè°ƒç”¨å·¥å‚beançš„**factory.getObject()** è·å–beanå¯¹è±¡ã€‚â€‹ å‰©ä½™çš„**createBean()** &amp; **adaptBeanInstance()**ï¼Œ**createBean()**åˆ›å»ºbeançš„é€»è¾‘ä¼šåœ¨ä¸‹ä¸€ç¯‡ä¸­æ·±å…¥åˆ†æï¼Œ**adaptBeanInstance()**å¾ªç¯ä¾èµ–ç›¸å…³çš„é€»è¾‘ä¼šåœ¨åç»­çš„ä¸‰çº§ç¼“å­˜ä¸å¾ªç¯ä¾èµ–ç¯‡ä¸­åˆ†æï¼Œä¸æœ¬æ¬¡çš„åˆ›å»ºå•å®ä¾‹beanå¯¹è±¡å…³ç³»å¹¶ä¸å¤§ã€‚è‡³æ­¤ï¼Œæ•´ä¸ª**getBean()**å°±åˆ†æå®Œäº†ã€‚â€‹ 10.è§¦å‘æ‰€æœ‰å•å®ä¾‹beanåˆå§‹åŒ–åçš„å›è°ƒé€»è¾‘åœ¨**preInstantiateSingletons()**é‡Œé¢é€šè¿‡ getBean() æ–¹æ³•å®ä¾‹åŒ–å®Œæ‰€æœ‰çš„å•å®ä¾‹beanä»¥åï¼Œå°±ä¼šè§¦å‘æ‰€æœ‰ **SmartInitializingSingleton** çš„ **afterSingletonsInstantiated()**ã€‚\u0000\u0000è¿™ä¸ªç»„ä»¶å…·ä½“çš„ä½œç”¨ï¼Œåœ¨å‰é¢çš„Springç»„ä»¶ä¸æ³¨è§£ç¯‡é‡Œé¢å·²ç»è¯¦ç»†ä»‹ç»è¿‡ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚â€‹ 123456789101112131415// è§¦å‘æ‰€æœ‰çš„å•å®ä¾‹beançš„åˆå§‹åŒ–åçš„å›è°ƒé€»è¾‘for (String beanName : beanNames) &#123; //ä»ä¸€çº§ç¼“å­˜è·å–å•å®ä¾‹bean Object singletonInstance = getSingleton(beanName); //ç±»å‹æ–­è¨€ï¼Œæ‰§è¡Œå›è°ƒ /*SmartInitializingSingletoné‡Œé¢æœ‰ä¸€ä¸ªæ–¹æ³• afterSingletonsInstantiated è¿™ä¸ªæ–¹æ³•éœ€è¦åœ¨åˆ›å»ºå¥½å•å®ä¾‹beanä¹‹åè°ƒç”¨ä¸€ä¸‹*/ if (singletonInstance instanceof SmartInitializingSingleton) &#123; StartupStep smartInitialize = this.getApplicationStartup().start(&quot;spring.beans.smart-initialize&quot;) .tag(&quot;beanName&quot;, beanName); SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance; //è¿™é‡Œå°±æ˜¯è§¦å‘åˆå§‹åŒ–åçš„å›è°ƒé€»è¾‘ smartSingleton.afterSingletonsInstantiated(); smartInitialize.end(); &#125;&#125; ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°†ç»§ç»­åˆ†æbeanå¯¹è±¡çš„åˆ›å»ºé€»è¾‘ **createBean()**ã€‚","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[ä¸‰]è§£æé…ç½®æ–‡ä»¶","slug":"Spring/Spring[ä¸‰]è§£æé…ç½®æ–‡ä»¶","date":"2022-01-11T05:59:03.018Z","updated":"2022-01-11T06:06:28.495Z","comments":true,"path":"2022/01/11/Spring/Spring[ä¸‰]è§£æé…ç½®æ–‡ä»¶/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E4%B8%89]%E8%A7%A3%E6%9E%90%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/","excerpt":"","text":"æœ¬æ¥è¿™ä¸€ç¯‡æ˜¯è¦å†™å¦‚ä½•åŠ è½½æ‰€æœ‰çš„å•å®ä¾‹beanå¯¹è±¡ï¼Œä½†æ˜¯å›é¡¾ç¬¬äºŒç¯‡ï¼Œå‘ç°å¯¹äºè§£æxmlæ–‡ä»¶åŠ è½½beanå®šä¹‰ä¿¡æ¯çš„éƒ¨åˆ†ç†è§£è¡¨è¾¾çš„å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œæ‰€ä»¥åœ¨æ­¤è¡¥å……ä¸€ç¯‡Springè§£æé…ç½®æ–‡ä»¶ï¼ŒåŠ è½½beanå®šä¹‰ä¿¡æ¯çš„æ–‡ç« ã€‚ â€‹ 1.ä»¥refresh()ä½œä¸ºæŠ“æ‰‹**refresh()**ä½œä¸ºå®¹å™¨çš„åˆ·æ–°æ–¹æ³•ï¼Œé‡è¦æ€§ä¸å¿…å¤šè¯´ï¼Œåœ¨é‡Œé¢çš„ç¬¬äºŒä¸ªæ–¹æ³•**obtainFreshBeanFactory()**é‡Œé¢ï¼Œè§£æäº†xmlé…ç½®æ–‡ä»¶æˆ–æ³¨è§£ï¼Œè½½å…¥beanå®šä¹‰èµ„æºä¿¡æ¯ï¼Œè¿”å›äº†ä¸€ä¸ªå…¨æ–°çš„beanå·¥å‚ã€‚æ¥ä¸‹æ¥æ¥åˆ†æ**obtainFreshBeanFactory()**ã€‚â€‹ 2.obtainFreshBeanFactory()è§£æxmlæ–‡ä»¶æˆ–è€…æ³¨è§£ï¼ŒåŠ è½½bean çš„å®šä¹‰ä¿¡æ¯ï¼Œåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„beanå·¥å‚ã€‚â€‹ \u0000 123456protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123; //åˆ·æ–°beanå·¥å‚ refreshBeanFactory(); /**è¿”å›beanå·¥å‚*/ return getBeanFactory();&#125; \u0000 3.refreshBeanFactory()è¿™é‡Œé¢ä¸»è¦å°±æ˜¯åˆ¤æ–­å½“å‰æœ‰æ²¡æœ‰beanå·¥å‚ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå°±æŠŠå·¥å‚å…³äº†ï¼Œé‡æ–°é€ ä¸€ä¸ªï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œç›´æ¥é€ ä¸€ä¸ªã€‚æ€»ä¹‹ä¸€å®šè¦é€ ä¸€ä¸ªæ–°çš„å·¥å‚ã€‚**createBeanFactory()** 12345678910111213141516171819202122232425@Overrideprotected final void refreshBeanFactory() throws BeansException &#123; /*å¦‚æœå·²ç»æœ‰äº†beanå·¥å‚ï¼Œé€šå¸¸æƒ…å†µä¸‹å¹¶ä¸ä¼šï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¼šæœ‰ï¼Ÿé€šè¿‡applicationContextç›´æ¥è°ƒç”¨refreshæ–¹æ³•*/ if (hasBeanFactory()) &#123; /*é”€æ¯é‡Œé¢çš„æ‰€æœ‰bean*/ destroyBeans(); /*å…³é—­beanå·¥å‚*/ closeBeanFactory(); &#125; try &#123; //ä¸ç®¡ä¸Šé¢æ˜¯å¦å·²ç»æœ‰beanå·¥å‚å­˜åœ¨ï¼Œæœ€ç»ˆéƒ½ä¼šèµ°åˆ°è¿™é‡Œï¼Œå»åˆ›å»ºä¸€ä¸ªbeanå·¥å‚ DefaultListableBeanFactory beanFactory = createBeanFactory(); /*è®¾ç½®åºåˆ—åŒ–id*/ beanFactory.setSerializationId(getId()); /*å¯¹å·¥å‚è¿›è¡Œä¸€äº›å®šåˆ¶åŒ–è®¾ç½®*/ customizeBeanFactory(beanFactory); /*åŠ è½½beançš„å®šä¹‰ä¿¡æ¯*/ loadBeanDefinitions(beanFactory); /*å°†å½“å‰ç±»çš„beanå·¥å‚å¼•ç”¨æŒ‡å‘åˆ›å»ºçš„beanå·¥å‚*/ this.beanFactory = beanFactory; &#125; catch (IOException ex) &#123; throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex); &#125;&#125; **createBeanFactory()**è¿”å›ä¸€ä¸ªå…¨æ–°çš„beanå·¥å‚ã€‚â€‹ 123protected DefaultListableBeanFactory createBeanFactory() &#123; return new DefaultListableBeanFactory(getInternalParentBeanFactory());&#125; æ¯æ¬¡å®¹å™¨åˆ·æ–°çš„æ—¶å€™å°è¯•è°ƒç”¨æ­¤æ–¹æ³•ã€‚é»˜è®¤åˆ›å»ºä¸€ä¸ª**DefaultListableBeanFactory**ï¼Œå¹¶å°†æ­¤ä¸Šä¸‹æ–‡çˆ¶çº§çš„å†…éƒ¨beanå·¥å‚ä½œä¸ºçˆ¶beanå·¥å‚ã€‚â€‹ å¯ä»¥å†å­ç±»ä¸­è¦†ç›–ï¼Œä¾‹å¦‚è‡ªå®šä¹‰**DefaultListableBeanFactory**çš„è®¾ç½®ã€‚â€‹ åˆ›å»ºå®Œå·¥å‚äº†ï¼Œå°±è¦å¾€å·¥å‚é‡Œé¢æ”¾ä¸œè¥¿ï¼Œ** loadBeanDefinitions(beanFactory)**ã€‚â€‹ 4.loadBeanDefinitions(beanFactory)è½½å…¥beançš„å®šä¹‰ä¿¡æ¯ **beanDefinition**ã€‚â€‹ 12345678910111213141516@Overrideprotected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException &#123; // åˆ›å»ºä¸€ä¸ªxml çš„beanDefinitionåŠ è½½å™¨ è¿™ä¸ªç©æ„é‡Œé¢æŒæœ‰ä¸€ä¸ªbeanFactoryçš„å¼•ç”¨ XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); /*ç»™beanDefinition åŠ è½½å™¨è®¾ç½®ä¸Šä¸‹æ–‡ç¯å¢ƒ èµ„æºåŠ è½½å™¨ å®ä½“è§£æå™¨*/ /*è¿™ç©æ„æˆ‘è®°å¾—éƒ½æ˜¯ç”¨çš„é»˜è®¤çš„*/ beanDefinitionReader.setEnvironment(this.getEnvironment()); beanDefinitionReader.setResourceLoader(this); beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); /*åˆå§‹åŒ–beanDefinitionåŠ è½½å™¨*/ initBeanDefinitionReader(beanDefinitionReader); /*ä½¿ç”¨beanDefinitionåŠ è½½å™¨åŠ è½½beanDefinitions*/ loadBeanDefinitions(beanDefinitionReader);&#125; é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªbeanå®šä¹‰ä¿¡æ¯çš„åŠ è½½å™¨ **XmlBeanDefinitionReader**ï¼Œç”¨æ¥è§£æxmlæ–‡ä»¶ã€‚â€‹ ç„¶åç»™**XmlBeanDefinitionReader**è®¾ç½®ä¸€äº›ç›¸å…³ä¿¡æ¯ã€‚â€‹ ç„¶ååˆå§‹åŒ– **XmlBeanDefinitionReader**ã€‚**initBeanDefinitionReader(beanDefinitionReader)**â€‹ æœ€åä½¿ç”¨**XmlBeanDefinitionReader**åŠ è½½beançš„å®šä¹‰ä¿¡æ¯ã€‚**loadBeanDefinitions(beanDefinitionReader)**\u0000 5.beanå®šä¹‰ä¿¡æ¯åŠ è½½å™¨**XmlBeanDefinitionReader**â€‹ 123public XmlBeanDefinitionReader(BeanDefinitionRegistry registry) &#123; super(registry);&#125; æ„é€ å™¨é‡Œé¢ä¼ å…¥äº†ä¸€ä¸ª**BeanDefinitionRegistry**ï¼Œç»™çˆ¶ç±»**AbstractBeanDefinitionReader**çš„å±æ€§èµ‹å€¼ã€‚â€‹ â€‹ 6.Beanå®šä¹‰ä¿¡æ¯æ³¨å†Œå™¨**BeanDefinitionRegistry**â€‹ æŒæœ‰beanå®šä¹‰çš„æ³¨å†Œè¡¨æ¥å£ã€‚ä¾‹å¦‚_**RootBeanDefinition**__ å’Œ _**ChildBeanDefinition**_ å®ä¾‹ã€‚_â€‹ é€šå¸¸ç”±åœ¨å†…éƒ¨ä½¿ç”¨_**AbstractBeanDefinition**_å±‚æ¬¡ç»“æ„çš„**beanFactory**å®ç°ã€‚â€‹ è¿™æ˜¯springçš„beanå·¥å‚ä¸­å”¯ä¸€å°è£…**BeanDefinitionRegistry**çš„æ¥å£ã€‚æ ‡å‡†çš„**BeanFactory**æ¥å£ä»…ä»…æ¶µç›–å¯¹å®Œå…¨é…ç½®çš„å·¥å‚çš„å·¥å‚å®ä¾‹çš„è®¿é—®ã€‚â€‹ springçš„**BeanDefinitionRegistry**æœŸå¾…ä½œç”¨äºè¯¥æ¥å£çš„å®ç°ã€‚springä¸­å·²ç»æœ‰çš„å®ç°æ˜¯_**DefaultListableBeanFactory**__ &amp; __**GenericApplicationContext**_ã€‚ 1234567891011121314151617181920212223public interface BeanDefinitionRegistry extends AliasRegistry &#123; /*æ³¨å†Œä¸€ä¸ªbeançš„å®šä¹‰ä¿¡æ¯ï¼Œæ”¯æŒæŒ‡å®šbeançš„åå­—*/ void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) throws BeanDefinitionStoreException; /*æ ¹æ®beançš„åå­—ç§»é™¤æ‰å·²ç»æ³¨å†Œçš„beanDefinition*/ void removeBeanDefinition(String beanName) throws NoSuchBeanDefinitionException; /*æ ¹æ®åå­—æŸ¥æ‰¾BeanDefinition*/ BeanDefinition getBeanDefinition(String beanName) throws NoSuchBeanDefinitionException; /*åˆ¤æ–­æ˜¯å¦åŒ…å«ç»™å®šåå­—çš„BeanDefinitionä¿¡æ¯*/ boolean containsBeanDefinition(String beanName); /*è¿”å›å·²ç»æ³¨å†Œçš„BeanDefinitionåå­—åˆ—è¡¨*/ String[] getBeanDefinitionNames(); /*è¿”å›å·²ç»æ³¨å†Œçš„BeanDefinitionæ•°é‡*/ int getBeanDefinitionCount(); /*ç¡®å®šç»™å®šçš„beanåç§°æ˜¯å¦å·²ç»åœ¨æ³¨å†Œä¸­å¿ƒä½¿ç”¨ï¼Œ æ€ä¹ˆåˆ¤æ–­æ˜¯å¦ä½¿ç”¨å‘¢ï¼Ÿå°±æ˜¯æ˜¯å¦æœ‰åˆ«åæ³¨å†Œåœ¨æ­¤åç§°ä¸‹ï¼Œæˆ–è€…å·²ç»æœ‰æ³¨å†Œåœ¨è¿™é‡Œçš„beanã€‚*/ boolean isBeanNameInUse(String beanName);&#125; 7.åˆå§‹åŒ–beanDefinitionçš„åŠ è½½å™¨**initBeanDefinitionReader(beanDefinitionReader)**â€‹ 123protected void initBeanDefinitionReader(XmlBeanDefinitionReader reader) &#123; reader.setValidating(this.validating);&#125; åˆå§‹åŒ–ç”¨äºåŠ è½½æ¬¡ä¸Šä¸‹æ–‡çš„beanDefinitionçš„beanDefinitionReaderã€‚é»˜è®¤å®ç°ä¸ºç©ºã€‚å¯ä»¥å†å­ç±»ä¸­è¦†ç›–ï¼Œä¾‹å¦‚å…³é—­xmléªŒè¯æˆ–ä½¿ç”¨ä¸åŒçš„_**XmlBeanDefinitionParser**_å®ç°ã€‚â€‹ 8.åŠ è½½beançš„å®šä¹‰ä¿¡æ¯**loadBeanDefinitions(beanDefinitionReader)**â€‹ ä½¿ç”¨ç»™å®šçš„_**XmlBeanDefinitionReader**_åŠ è½½**beanDefinition**ã€‚â€‹ **BeanFactory**çš„ç”Ÿå‘½å‘¨æœŸç”±_**refreshBeanFactory() **_å¤„ç†ï¼Œå› æ­¤æ­¤æ–¹æ³•ä»…ç”¨äºåŠ è½½å’Œæ³¨å†Œ**beanDefinition**ã€‚ 123456789101112131415protected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws BeansException, IOException &#123; /*è¿™é‡Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªé’©å­æ–¹æ³•ï¼Œç»å…¸çš„æ¨¡æ¿æ¨¡å¼ï¼Œå­ç±»æ ¹æ®éœ€è¦å¯¹æ–¹æ³•è¿›è¡Œé‡å†™ï¼Œå®é™…ä¸ŠåŠ è½½xmlçš„æ—¶å€™ï¼Œè¿™é‡Œé”¤å­ä¹Ÿæ²¡æ‹¿åˆ°*/ Resource[] configResources = getConfigResources(); /*å¦‚æœèµ„æºä¸ä¸ºç©ºï¼Œèµ°è¿™é‡Œçš„é€»è¾‘ï¼Œä½†æ˜¯ä¸Šé¢å·²ç»åˆ†æè¿‡ï¼Œå®é™…ä¸Šé”¤å­ä¹Ÿæ²¡æ‹¿åˆ°ï¼Œæ‰€ä»¥èµ°ä¸‹é¢çš„é€»è¾‘*/ if (configResources != null) &#123; reader.loadBeanDefinitions(configResources); &#125; /*è·å–é…ç½®æ–‡ä»¶ä½ç½®*/ String[] configLocations = getConfigLocations(); /*æ­¤æ—¶è¯»å–åˆ°äº†æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶æŒ‡å®šçš„é…ç½®æ–‡ä»¶ beans.xml*/ if (configLocations != null) &#123; reader.loadBeanDefinitions(configLocations); &#125;&#125; åœ¨è¿™é‡Œæˆ‘ä»¬æ³¨æ„ä¸¤ä¸ªæ–¹æ³•ï¼šâ€‹ **getConfigLocations()** è·å–åˆ°é…ç½®æ–‡ä»¶çš„ä½ç½® **reader.loadBeanDefinitions(configLocations)** ä½¿ç”¨beanå®šä¹‰ä¿¡æ¯çš„åŠ è½½å™¨åŠ è½½**beanDefinition**ã€‚ â€‹ 1234@Nullableprotected String[] getConfigLocations() &#123; return (this.configLocations != null ? this.configLocations : getDefaultConfigLocations());&#125; è¿”å›ä¸€ä¸ªèµ„æºä½ç½®æ•°ç»„ï¼ŒæŒ‡çš„æ˜¯æ„å»ºæ­¤ä¸Šä¸‹æ–‡åº”ç”¨çš„æ—¶å€™ä½¿ç”¨çš„ xmlé…ç½®æ–‡ä»¶ã€‚è¿˜å¯ä»¥åŒ…æ‹¬ä½ç½®æ¨¡å¼ï¼Œè¿™å°†é€šè¿‡_**ResourcePatternResolver**_å¤„ç†ã€‚é»˜è®¤å®ç°è¿”å›nullã€‚å­ç±»å¯ä»¥é‡å†™è¿™ä¸ªæ–¹æ³•ç”¨æ¥æä¾›ä¸€ç»„èµ„æºä½ç½®æ¥åŠ è½½**beanDefinition**ã€‚â€‹ 9.reader.loadBeanDefinitions(configLocations)ç”¨beanå®šä¹‰ä¿¡æ¯çš„åŠ è½½å™¨åŠ è½½**beanDefinition**ã€‚\u0000 123456789101112@Overridepublic int loadBeanDefinitions(String... locations) throws BeanDefinitionStoreException &#123; /*æ–­è¨€ åˆ¤ç©º*/ Assert.notNull(locations, &quot;Location array must not be null&quot;); /*è®°å½•beanDefinitionçš„æ•°é‡*/ int count = 0; /*è¿­ä»£åŠ è½½beanDefinition*/ for (String location : locations) &#123; count += loadBeanDefinitions(location); &#125; return count;&#125; è¿™é‡Œæ˜¯æ ¹æ®é…ç½®æ–‡ä»¶çš„ä½ç½®æ•°ç»„è¿›è¡Œå¾ªç¯è¿­ä»£åŠ è½½å¹¶è®°å½•**beanDefinition**çš„æ•°é‡ã€‚â€‹ æ¥åˆ°äº†**AbstractBeanDefinitionReader**çš„**loadBeanDefinitions()**ã€‚â€‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public int loadBeanDefinitions(String location, @Nullable Set&lt;Resource&gt; actualResources) throws BeanDefinitionStoreException &#123; /*è·å–èµ„æºåŠ è½½å™¨*/ ResourceLoader resourceLoader = getResourceLoader(); /*å¦‚æœèµ„æºåŠ è½½å™¨ä¸ºç©ºï¼ŒæŠ›å¼‚å¸¸*/ if (resourceLoader == null) &#123; throw new BeanDefinitionStoreException( &quot;Cannot load bean definitions from location [&quot; + location + &quot;]: no ResourceLoader available&quot;); &#125; /*å¦‚æœèµ„æºåŠ è½½å™¨æ˜¯èµ„æºæ¨¡å¼è§£æå™¨ç±»å‹çš„*/ if (resourceLoader instanceof ResourcePatternResolver) &#123; // Resource pattern matching available. try &#123; /* å°†xmlé…ç½®æ–‡ä»¶åŠ è½½åˆ°resourcesä¸­ï¼Œresourceå…¶å®å°±æ˜¯springåº•å±‚å°è£…äº†å¾ˆå¤šçš„ç»†èŠ‚ï¼Œ æŠ½è±¡å‡ºæ¥çš„èµ„æºé¡¶å±‚æ¥å£ è®©å¼€å‘äººå‘˜ä¸å¿…ä¸“æ³¨äºåº•å±‚é…ç½®æ–‡ä»¶çš„åŠ è½½ç»†èŠ‚ */ Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location); /*åŠ è½½beanDefinition*/ int count = loadBeanDefinitions(resources); /*è¿™ç©æ„ä¸çŸ¥é“æ˜¯å•¥ï¼Œåæ­£æ˜¯ç©ºï¼Œæ²¡å•¥é”¤å­ç”¨*/ if (actualResources != null) &#123; Collections.addAll(actualResources, resources); &#125; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Loaded &quot; + count + &quot; bean definitions from location pattern [&quot; + location + &quot;]&quot;); &#125; return count; &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException( &quot;Could not resolve bean definition resource pattern [&quot; + location + &quot;]&quot;, ex); &#125; &#125;/*èµ°åˆ°è¿™é‡Œè¯´æ˜èµ„æºåŠ è½½å™¨è‚¯å®šä¸æ˜¯èµ„æºæ¨¡å¼è§£æå™¨ç±»å‹çš„*/ else &#123; // åªèƒ½é€šè¿‡ç»å¯¹ç½‘å€åŠ è½½å•ä¸ªèµ„æº Resource resource = resourceLoader.getResource(location); int count = loadBeanDefinitions(resource); if (actualResources != null) &#123; actualResources.add(resource); &#125; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Loaded &quot; + count + &quot; bean definitions from location [&quot; + location + &quot;]&quot;); &#125; return count; &#125;&#125; é¦–å…ˆè·å–åˆ°èµ„æºçš„åŠ è½½å™¨ï¼Œå¦‚æœåŠ è½½å™¨æ˜¯ç©ºï¼Œé‚£å°±è¯´æ˜ç¨‹åºæ— æ³•å¾€ä¸‹æ‰§è¡Œäº†ï¼Œç›´æ¥æŠ›å¼‚å¸¸ã€‚â€‹ å¦‚æœèµ„æºåŠ è½½å™¨æ˜¯èµ„æºè§£æå™¨æ¨¡å¼çš„ï¼ŒåŠ è½½xmlæ–‡ä»¶åˆ°**Resource**æ•°ç»„ä¸­ï¼Œ**Resource**æ˜¯ä»€ä¹ˆåœ¨ä¸Šä¸€ç¯‡ä¸­å·²ç»ä»‹ç»è¿‡äº†ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚â€‹ æ­¤æ—¶åœ¨æ ¹æ®**Resource**æ•°ç»„å»åŠ è½½**beanDefinition**ï¼Œæœ€åè¿”å›åŠ è½½çš„**beanDefinition**çš„æ•°é‡ã€‚ï¼ˆæ³¨æ„ï¼šè¿™é‡Œèµ°çš„æ˜¯elseçš„é€»è¾‘ï¼Œå› ä¸ºé»˜è®¤æˆ‘ä»¬ä¸æ˜¯ä½ç½®æ¨¡å¼ã€‚ï¼‰â€‹ æ³¨æ„è¿™ä¸ªæ—¶å€™æ€è·¯å·²ç»å¾ˆæ˜ç¡®äº†ï¼Œå‡†å¤‡äº†è¿™ä¹ˆå¤šå®é™…ä¸Šåˆ°è¿™é‡Œå°±åˆ†ä¸ºäº†ä¸¤æ­¥ï¼šâ€‹ åŠ è½½xmlé…ç½®æ–‡ä»¶ **getResource(location)** é€šè¿‡xmlé…ç½®æ–‡ä»¶å»åŠ è½½**beanDefinition** **loadBeanDefinitions(resource)** â€‹ 10.åŠ è½½xmlé…ç½®æ–‡ä»¶æ¥åˆ°**DefaultResourceLoader**ã€‚â€‹ 12345678910111213141516171819202122232425262728293031@Overridepublic Resource getResource(String location) &#123; Assert.notNull(location, &quot;Location must not be null&quot;); //å¾ªç¯éå†ä½¿ç”¨è§£æå™¨è§£æè¯¥locationçš„èµ„æºï¼Œå¦‚æœèµ„æºä¸ä¸ºç©ºï¼Œç›´æ¥è¿”å› for (ProtocolResolver protocolResolver : getProtocolResolvers()) &#123; Resource resource = protocolResolver.resolve(location, this); if (resource != null) &#123; return resource; &#125; &#125; /*ä»¥/å¼€å¤´é‚£ä¹ˆæ ¹æ®pathå»å¯»æ‰¾*/ if (location.startsWith(&quot;/&quot;)) &#123; return getResourceByPath(location); &#125; /*ä»¥classpathå¼€å¤´ï¼Œé‚£ä¹ˆæŠ½è±¡ä¸ºClassPathResource*/ else if (location.startsWith(CLASSPATH_URL_PREFIX)) &#123; return new ClassPathResource(location.substring(CLASSPATH_URL_PREFIX.length()), getClassLoader()); &#125; else &#123; try &#123; /*å…¶ä»–æƒ…å†µé‡‡ç”¨urlResourceæ¥åŠ è½½*/ URL url = new URL(location); return (ResourceUtils.isFileURL(url) ? new FileUrlResource(url) : new UrlResource(url)); &#125; catch (MalformedURLException ex) &#123; // No URL -&gt; resolve as resource path. return getResourceByPath(location); &#125; &#125;&#125; æ¥ä¸‹æ¥å°±æ˜¯åŠ è½½**beanDefinition**ä¿¡æ¯ã€‚\u0000 11.åŠ è½½beanDefinition**loadBeanDefinitions(resource)**â€‹ æ¥åˆ°äº† **XmlBeanDefinitionReader**ã€‚â€‹ 123456@Overridepublic int loadBeanDefinitions(Resource resource) throws BeanDefinitionStoreException &#123; //1.å°†resourceåŒ…è£…æˆå¸¦æœ‰ç¼–ç æ ¼å¼çš„EncodedResource //2.é‡è½½è°ƒç”¨loadBeanDefinitions() return loadBeanDefinitions(new EncodedResource(resource));&#125; æˆ‘ä»¬æ¥åˆ°é‡è½½çš„æ–¹æ³•ã€‚**loadBeanDefinitions(resource)**â€‹ 1234567891011121314151617181920212223242526272829303132333435363738394041public int loadBeanDefinitions(EncodedResource encodedResource) throws BeanDefinitionStoreException &#123; //è·³è¿‡æ–­è¨€ æ—¥å¿— Assert.notNull(encodedResource, &quot;EncodedResource must not be null&quot;); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Loading XML bean definitions from &quot; + encodedResource); &#125; //è·å–å¼•ç”¨ï¼šå½“å‰çº¿ç¨‹å·²ç»åŠ è½½è¿‡çš„encodingResourceèµ„æº Set&lt;EncodedResource&gt; currentResources = this.resourcesCurrentlyBeingLoaded.get(); //å°†å½“å‰çš„encodingResourceåŠ å…¥åˆ°threadlocalçš„setä¸­ï¼ŒåŠ å…¥å¤±è´¥è¯´æ˜å½“å‰èµ„æºå·²ç»åŠ è½½è¿‡äº†ï¼Œä¸èƒ½é‡å¤åŠ è½½ï¼Œéœ€è¦æŠ›å‡ºå¼‚å¸¸ if (!currentResources.add(encodedResource)) &#123; throw new BeanDefinitionStoreException( &quot;Detected cyclic loading of &quot; + encodedResource + &quot; - check your import definitions!&quot;); &#125; //jdkæ–°ç‰ˆæœ¬çš„è¯­æ³•ç³– æ‹¿åˆ°èµ„æºçš„è¾“å…¥æµ try (InputStream inputStream = encodedResource.getResource().getInputStream()) &#123; //å› ä¸ºæ¥ä¸‹æ¥è¦ä½¿ç”¨ saxè§£æå™¨ï¼Œè§£æxmlæ–‡ä»¶ ï¼Œæ‰€ä»¥éœ€è¦å°†è¾“å…¥æµåŒ…è£…æˆinputsourceï¼Œ //inputsourceæ˜¯saxä¸­è¡¨ç¤ºèµ„æºçš„å¯¹è±¡ InputSource inputSource = new InputSource(inputStream); //è®¾ç½®å­—ç¬¦ç¼–ç  springæºç ä¸­åˆ¤æ–­é€»è¾‘ç‰¹åˆ«å¤š ï¼Œç¨³å®šåŒ–çš„æ¡†æ¶å¹¶ä¸ç›¸ä¿¡ä¸€åˆ‡å¤–éƒ¨çš„è¾“å…¥ //è¿™ä¹Ÿæ˜¯è½¯ä»¶æ¶æ„åŸåˆ™ä¸­çš„è§„èŒƒä¹‹ä¸€ ç¨³å®šæ€§ä½“ç° if (encodedResource.getEncoding() != null) &#123; inputSource.setEncoding(encodedResource.getEncoding()); &#125; //çœŸæ­£å¹²æ´»çš„é€»è¾‘ ï¼ŒåŠ è½½beanDefinitionçš„å…¥å£ return doLoadBeanDefinitions(inputSource, encodedResource.getResource()); &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException( &quot;IOException parsing XML document from &quot; + encodedResource.getResource(), ex); &#125; finally &#123; //å› ä¸ºresourcesCurrentlyBeingLoadedè¡¨ç¤ºå½“å‰çº¿ç¨‹æ­£åœ¨åŠ è½½çš„redource //æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜èµ„æºå·²ç»åŠ è½½å®Œäº†æˆ–è€…å¤±è´¥äº† //æ‰€ä»¥éœ€è¦å°†å½“å‰èµ„æºç§»é™¤å‡ºå» currentResources.remove(encodedResource); //setæ²¡æœ‰æ•°æ®äº†ï¼Œè¯´æ˜æ²¡å•¥ä¹±ç”¨äº†ï¼Œæ¸…ç†ä¸€ä¸‹å†…å­˜ é˜²æ­¢threadlocalå†…å­˜æ³„æ¼ if (currentResources.isEmpty()) &#123; this.resourcesCurrentlyBeingLoaded.remove(); &#125; &#125;&#125; è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªå§”æ´¾æ¨¡å¼ï¼Œå°†çœŸæ­£å¹²æ´»çš„é€»è¾‘äº¤ç»™äº†**doLoadBeanDefinitions()**ã€‚\u0000 1234567891011121314151617181920protected int doLoadBeanDefinitions(InputSource inputSource, Resource resource) throws BeanDefinitionStoreException &#123; try &#123; //æŠŠ resource è½¬æ¢æˆç¨‹åºå±‚é¢å¯ä»¥è¯†åˆ«çš„æœ‰å±‚æ¬¡ç»“æ„çš„documentå¯¹è±¡ Document doc = doLoadDocument(inputSource, resource); //è§£ææ–‡æ¡£å¯¹è±¡ï¼Œç”ŸæˆbeanDefinitionæ³¨å†Œåˆ°beanFactoryä¸­ï¼Œæœ€ç»ˆè¿”å›æ–°æ³¨å†Œåˆ°beanFactoryçš„beanDefinitionæ•°é‡ int count = registerBeanDefinitions(doc, resource); //æ—¥å¿—æ‰“å° if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Loaded &quot; + count + &quot; bean definitions from &quot; + resource); &#125; //è¿”å›æ–°æ³¨å†Œ beanå®šä¹‰ä¿¡æ¯çš„æ•°é‡ return count; &#125; catch (BeanDefinitionStoreException ex) &#123; throw ex; &#125; //è¿™é‡Œçœç•¥éƒ¨åˆ†catchçš„é€»è¾‘&#125; è¿™é‡Œå†æ¬¡åˆ†æˆäº†ä¸¤æ­¥ï¼šâ€‹ å°†**Resource**è½¬æ¢æˆ**Document**ã€‚ **doLoadDocument(inputSource, resource)** è§£ææ–‡æ¡£å¯¹è±¡ï¼Œç”Ÿæˆ**beanDefinition**æ³¨å†Œåˆ°**BeanFactory**ã€‚ **registerBeanDefinitions(doc, resource)** â€‹ 12.Resourceè½¬åŒ–æˆDocument**doLoadDocument(inputSource, resource)**â€‹ 1234567891011121314protected Document doLoadDocument(InputSource inputSource, Resource resource) throws Exception &#123; //è¿™ä¸ªæ–¹æ³•å°±æ˜¯å°†inputSourceè½¬åŒ–æˆå¯ä»¥è¯†åˆ«çš„æ–‡æ¡£å¯¹è±¡ //é€šè¿‡æ–‡æ¡£åŠ è½½å™¨æ¥è½¬åŒ–çš„ //1. getEntityResolverï¼Ÿ è¿™ä¸ªå®ä½“è§£æå™¨ //springå®˜ç½‘è¯´æ˜ï¼šå¦‚æœsaxåº”ç”¨ç¨‹åºä¸­éœ€è¦å®ç°è‡ªå®šä¹‰å¤„ç†å¤–éƒ¨å®ä½“ï¼Œåˆ™å¿…é¡»å®ç°æ­¤æ¥å£å¹¶ä½¿ç”¨setEntityResolveræ–¹æ³•å‘saxé©±åŠ¨å™¨æ³¨å†Œä¸€ä¸ªå®ä¾‹ //ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºè§£æä¸€ä¸ªxmlï¼Œsaxé¦–å…ˆè¯»å–xmlæ–‡æ¡£ä¸Šçš„å£°æ˜ï¼Œæ ¹æ®å£°æ˜å»å¯»æ‰¾ç›¸åº”çš„DTD/XSDå®šä¹‰ï¼Œä»¥ä¾¿å¯¹æ–‡æ¡£è¿›è¡Œä¸€ä¸ªæ ¡éªŒã€‚ //é»˜è®¤çš„å¯»æ‰¾æ ¡éªŒè§„åˆ™ï¼Œå³é€šè¿‡ç½‘ç»œæ¥ä¸‹è½½å“åº”çš„DTD/XSDå£°æ˜ï¼Œåœ¨è¿›è¡Œæ ¡éªŒã€‚å¹¶ä¸”ä¸‹è½½çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªæ¼«é•¿ä¸”ä¸å¯æ§çš„è¿‡ç¨‹ï¼Œå½“ä¸‹åœ¨å¤±è´¥åï¼Œè¿™é‡Œè¿˜ä¼šæŠ›å‡ºå¼‚å¸¸ //é‚£ä¹ˆæœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥é¿å…ç›´æ¥ä»ç½‘ç»œä¸Šä¸‹è½½å‘¢ï¼Ÿä½¿ç”¨EntityResolver //EntityResolverçš„ä½œç”¨æ˜¯é¡¹ç›®æœ¬èº«å¯ä»¥æä¾›ä¸€ä¸ªå¦‚ä½•å¯»æ‰¾DTD/XSDå£°æ˜çš„æ–¹æ³•ï¼Œå³è®©ç¨‹åºæ¥å®ç°å¯»æ‰¾å®šä¹‰å£°æ˜çš„è¿‡ç¨‹ï¼Œæ¯”å¦‚æˆ‘ä»¬å°†å®šä¹‰æ–‡ä»¶ //æ”¾åˆ°é¡¹ç›®çš„æŸä¸ªåœ°æ–¹ï¼Œåœ¨å®ç°æ—¶ç›´æ¥å°†æ­¤æ–‡ä»¶è¯»å–å¹¶è¿”å›ç»™saxå³å¯ï¼Œè¿™æ ·é¿å…äº†é€šè¿‡ç½‘ç»œæ¥å¯»æ‰¾å¯¹åº”çš„å£°æ˜ã€‚ //2.éªŒè¯æ¨¡å¼æ˜¯æ€ä¹ˆè·å–çš„ï¼ŸgetValidationModeForResource() return this.documentLoader.loadDocument(inputSource, getEntityResolver(), this.errorHandler, getValidationModeForResource(resource), isNamespaceAware());&#125; **getValidationModeForResource(resource)**â€‹ 123456789101112131415161718protected int getValidationModeForResource(Resource resource) &#123; //è·å–é»˜è®¤çš„validationMode int validationModeToUse = getValidationMode(); //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜setè¿‡é»˜è®¤å€¼ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ä¼šèµ°è¿™é‡Œï¼Œéƒ½æ˜¯ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹ if (validationModeToUse != VALIDATION_AUTO) &#123; return validationModeToUse; &#125; //è‡ªåŠ¨æ£€æŸ¥xmlä½¿ç”¨çš„æ˜¯å“ªç§éªŒè¯æ¨¡å¼ï¼Ÿç”±è¿™ä¸ªæ–¹æ³•å†³å®š int detectedMode = detectValidationMode(resource); if (detectedMode != VALIDATION_AUTO) &#123; return detectedMode; &#125; // Hmm, we didn&#x27;t get a clear indication... Let&#x27;s assume XSD, // since apparently no DTD declaration has been found up until // detection stopped (before finding the document&#x27;s root tag). return VALIDATION_XSD;&#125; **documentLoader.loadDocument()**â€‹ 1234567891011@Overridepublic Document loadDocument(InputSource inputSource, EntityResolver entityResolver, ErrorHandler errorHandler, int validationMode, boolean namespaceAware) throws Exception &#123; DocumentBuilderFactory factory = createDocumentBuilderFactory(validationMode, namespaceAware); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Using JAXP provider [&quot; + factory.getClass().getName() + &quot;]&quot;); &#125; DocumentBuilder builder = createDocumentBuilder(factory, entityResolver, errorHandler); return builder.parse(inputSource);&#125; **DocumentBuilder.parse() **å°±æ˜¯çœŸæ­£çš„è§£æé€»è¾‘ã€‚â€‹ 13.è§£ææ–‡æ¡£å¯¹è±¡æ³¨å†Œåˆ°BeanFactory**registerBeanDefinitions()** è§£ææ–‡æ¡£å¯¹è±¡ï¼Œç”ŸæˆbeanDefinitionæ³¨å†Œåˆ°beanFactoryä¸­ï¼Œæœ€ç»ˆè¿”å›æ–°æ³¨å†Œåˆ°beanFactoryçš„beanDefinitionæ•°é‡ã€‚\u0000 123456789101112public int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException &#123; //åˆ›å»ºä¸€ä¸ª BeanDefinitionDocumentReader ä¸€å¯¹ä¸€å¤„ç† æ¯ä¸ªæ–‡æ¡£å¯¹è±¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ª BeanDefinitionDocumentReader å¯¹è±¡ BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader(); //getRegistry ä¼šè¿”å›ç¨‹åºåˆ›å»ºçš„beanFactoryå®ä¾‹ //countBefore è§£ædocä¹‹å‰ï¼Œbfä¸­å·²ç»æœ‰çš„bdæ•°é‡ int countBefore = getRegistry().getBeanDefinitionCount(); //è§£ææ–‡æ¡£ï¼Œå¹¶ä¸”æ³¨å†Œåˆ°bfä¸­ //xmlReaderContext :åŒ…å«æœ€ä¸»è¦çš„å‚æ•°æ˜¯å½“å‰ this -&gt; xmlBeanDefinitionReader -&gt; bf documentReader.registerBeanDefinitions(doc, createReaderContext(resource)); //è¿”å›å€¼ è¿”å›æ–°æ³¨å†Œçš„bdæ•°é‡ æœ€æ–°çš„ - æ³¨å†Œä¹‹å‰çš„ return getRegistry().getBeanDefinitionCount() - countBefore;&#125; çœ‹é‡è½½çš„æ–¹æ³•â€‹ 12345678@Overridepublic void registerBeanDefinitions(Document doc, XmlReaderContext readerContext) &#123; //å¼•ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡ this.readerContext = readerContext; //doc.getDocumentElement() æ‹¿å‡ºæ–‡æ¡£ä»£è¡¨çš„xmlçš„é¡¶å±‚æ ‡ç­¾ &lt;beans&gt;&lt;/beans&gt; /*çœŸæ­£çš„è§£æxmlçš„é€»è¾‘*/ doRegisterBeanDefinitions(doc.getDocumentElement());&#125; åˆæ˜¯ä¸€ä¸ªå§”æ´¾æ¨¡å¼ï¼Œç»ˆäºæ¥åˆ°äº†è§£æxmlçš„é€»è¾‘ï¼Œè¿™é‡Œçš„é€»è¾‘å…¶å®æ²¡æœ‰ä»€ä¹ˆå¯ä»¥å­¦ä¹ çš„ç‚¹ï¼Œè¿½åˆ°è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†ä¸²èµ·æ¥æ•´ä¸ªè§£æxmlæ–‡ä»¶çš„æµç¨‹ï¼Œå…·ä½“è§£æxmlçš„è¿‡ç¨‹ä¸åšé‡ç‚¹è¯´æ˜ã€‚â€‹ 1234567891011121314151617181920212223242526272829303132333435protected void doRegisterBeanDefinitions(Element root) &#123; BeanDefinitionParserDelegate parent = this.delegate; //æ–¹æ³•è¿”å›ä¸€ä¸ªbeansæ ‡ç­¾ è§£æå™¨å¯¹è±¡ this.delegate = createDelegate(getReaderContext(), root, parent); //è§£æå™¨å¯¹è±¡å»åˆ¤æ–­æ˜¯ä¸æ˜¯é»˜è®¤çš„å‘½åç©ºé—´ ä¸€èˆ¬æƒ…å†µä¸‹ æ¡ä»¶æˆç«‹ if (this.delegate.isDefaultNamespace(root)) &#123; //è·å– profile å±æ€§ï¼Œ ç¯å¢ƒ Dev prod test String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE); //æ¡ä»¶æˆç«‹ è¯´æ˜ beans æ ‡ç­¾ä¸Š æœ‰ profile å±æ€§ if (StringUtils.hasText(profileSpec)) &#123; //å°†å±æ€§å€¼æŒ‰ç…§,æ‹†åˆ†æˆå­—ç¬¦ä¸²æ•°ç»„ String[] specifiedProfiles = StringUtils.tokenizeToStringArray( profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS); // We cannot use Profiles.of(...) since profile expressions are not supported // in XML config. See SPR-12458 for details. // Environment.acceptsProfiles(String [] args) æ¡ä»¶æˆç«‹ ï¼šè¯´æ˜beans æ ‡ç­¾å¯ä»¥ç»§ç»­è§£æ bd //è¿™é‡Œå–å ï¼Œæ‰€ä»¥ å°±æ˜¯ ifé‡Œé¢æ•´ä¸ªæ¡ä»¶æˆç«‹ ï¼Œè¯´æ˜è¯¥ beans æ ‡ç­¾ä¸åœ¨ç»§ç»­è§£æ ï¼Œç›´æ¥è¿”å› if (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Skipped XML bean definition file due to specified profiles [&quot; + profileSpec + &quot;] not matching: &quot; + getReaderContext().getResource()); &#125; return; &#125; &#125; &#125; //è¿™é‡Œæ˜¯ç•™ç»™å­ç±»çš„æ‰©å±•ç‚¹ preProcessXml(root); parseBeanDefinitions(root, this.delegate); //è¿™é‡Œä¹Ÿæ˜¯ç•™ç»™å­ç±»æ‰©å±• ä½“ç°çš„è½¯ä»¶è®¾è®¡æ¨¡å¼çš„å¼€é—­åŸåˆ™ postProcessXml(root); this.delegate = parent;&#125; å·²ç»èµ°åˆ°äº†è¿™é‡Œï¼Œå¤§æ¦‚çœ‹ä¸€ä¸‹é‡Œé¢çš„é€»è¾‘ã€‚â€‹ **parseBeanDefinitions(root, this.delegate)**â€‹ 12345678910111213141516171819202122232425protected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) &#123; /*æ¡ä»¶æˆç«‹è¯´æ˜rootæ˜¯springç¼ºçœçš„å‘½åç©ºé—´*/ if (delegate.isDefaultNamespace(root)) &#123; /*è¿™é‡Œè·å–çš„ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå…¶å®éƒ½æ˜¯beanæ ‡ç­¾*/ NodeList nl = root.getChildNodes(); /*è¿­ä»£å¤„ç†æ¯ä¸€ä¸ªå­æ ‡ç­¾*/ for (int i = 0; i &lt; nl.getLength(); i++) &#123; Node node = nl.item(i); if (node instanceof Element) &#123; Element ele = (Element) node; /*è¯´æ˜å­æ ‡ç­¾ä¹Ÿæ˜¯é»˜è®¤çš„springæ ‡ç­¾*/ if (delegate.isDefaultNamespace(ele)) &#123; /*é»˜è®¤æ ‡ç­¾è§£æé€»è¾‘ step into*/ parseDefaultElement(ele, delegate); &#125;/*è‡ªå®šä¹‰æ ‡ç­¾è§£æé€»è¾‘*/ else &#123; delegate.parseCustomElement(ele); &#125; &#125; &#125; &#125;/*rootä¸æ˜¯é»˜è®¤çš„å‘½åç©ºé—´ï¼Œè§£æè‡ªå®šä¹‰æ ‡ç­¾é€»è¾‘*/ else &#123; delegate.parseCustomElement(root); &#125;&#125; å› ä¸ºæˆ‘ä»¬æ²¡æœ‰è‡ªå®šä¹‰æ ‡ç­¾ï¼Œæ‰€ä»¥çœ‹é»˜è®¤æ ‡ç­¾çš„è§£æé€»è¾‘ **parseDefaultElement(ele, delegate)**ã€‚â€‹ 1234567891011121314151617private void parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) &#123; /*æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜æ­¤æ—¶æ˜¯importæ ‡ç­¾*/ if (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123; importBeanDefinitionResource(ele); &#125;/*æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯aliasåˆ«åæ ‡ç­¾*/ else if (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123; processAliasRegistration(ele); &#125;/*æ­¤æ—¶è¯´æ˜æ˜¯beanæ ‡ç­¾*/ else if (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123; /*è§£æbeanæ ‡ç­¾*/ processBeanDefinition(ele, delegate); &#125;/*è¯´æ˜æ˜¯åµŒå¥—beansæ ‡ç­¾*/ else if (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123; // é€’å½’åˆ°ä¸Šå±‚é‡æ–°æ¥äº† doRegisterBeanDefinitions(ele); &#125;&#125; \u0000ç»§ç»­çœ‹ä¸€ä¸‹beanæ ‡ç­¾çš„è§£æé€»è¾‘**processBeanDefinition(ele, delegate)**ã€‚ 1234567891011121314151617181920protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) &#123; /*ç”¨è§£æå™¨å¯¹è±¡è§£ææ ‡ç­¾ hodleré‡Œé¢åŒ…å«ä¸‰ä¸ªå±æ€§ï¼šbeanDefinitionï¼ŒbeanNameï¼ŒAliasåˆ«åä¿¡æ¯*/ BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele); if (bdHolder != null) &#123; /*å¦‚æœå½“å‰hodleréœ€è¦è¢«è£…é¥°ï¼Œæ‰§è¡Œè£…é¥°é€»è¾‘ ä¸»è¦æ˜¯å¤„ç†è‡ªå®šä¹‰å±æ€§*/ bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder); try &#123; // Register the final decorated instance. /*æ³¨å†Œå½“å‰beanå€’å®¹å™¨ä¸­ é€šè¿‡readerContextæ‹¿åˆ°XMLBeanDefinitionæ‹¿åˆ°beanFactory*/ BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry()); &#125; catch (BeanDefinitionStoreException ex) &#123; getReaderContext().error(&quot;Failed to register bean definition with name &#x27;&quot; + bdHolder.getBeanName() + &quot;&#x27;&quot;, ele, ex); &#125; // Send registration event. /*å‘é€ä¸€ä¸ªbeanæ³¨å†Œå®Œæˆçš„äº‹ä»¶*/ getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder)); &#125;&#125; **BeanDefinitionReaderUtils.registerBeanDefinition()** å•å®ä¾‹beançš„æ³¨å†Œé€»è¾‘ã€‚â€‹ 12345678910111213141516public static void registerBeanDefinition( BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry) throws BeanDefinitionStoreException &#123; // Register bean definition under primary name. String beanName = definitionHolder.getBeanName(); registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition()); // Register aliases for bean name, if any. String[] aliases = definitionHolder.getAliases(); if (aliases != null) &#123; for (String alias : aliases) &#123; registry.registerAlias(beanName, alias); &#125; &#125;&#125; æœ€ç»ˆå°†**beanDefinition**æ”¾åˆ°äº†**beanDefinitionMap**é‡Œé¢ï¼Œè‡³æ­¤æ•´ä¸ªè§£æxmlé…ç½®æ–‡ä»¶ï¼ŒåŠ è½½**beanDefinition**å¹¶è¿”å›å…¨æ–°**BeanFactory**çš„é€»è¾‘ç»“æŸäº†ã€‚â€‹ â€‹ â€‹ â€‹","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[äºŒ]IOCå®¹å™¨åˆå§‹åŒ–","slug":"Spring/Spring[äºŒ]Iocå®¹å™¨çš„åˆå§‹åŒ–","date":"2022-01-11T05:58:52.126Z","updated":"2022-01-11T06:06:02.565Z","comments":true,"path":"2022/01/11/Spring/Spring[äºŒ]Iocå®¹å™¨çš„åˆå§‹åŒ–/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E4%BA%8C]Ioc%E5%AE%B9%E5%99%A8%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/","excerpt":"","text":"ä»ä¸Šå±‚è§†è§’å…¥æ‰‹ï¼Œè§‚æµ‹Springå®¹å™¨çš„åˆå§‹åŒ–å·¥ä½œã€‚ 1.åˆå§‹å‡†å¤‡é¦–å…ˆåœ¨Springçš„æºç å·¥ç¨‹é‡Œé¢åˆ›å»ºä¸€æ®µä»£ç ï¼Œé€šè¿‡ç®€å•çš„è¿è¡Œä»£ç ï¼Œæ¥è¿½è¸ªSpring ioc å®¹å™¨çš„æ•´ä¸ªå¯åŠ¨æµç¨‹ã€‚ 12345678910111213141516171819202122232425262728293031public class IocMainTest &#123; private static final String CONFIG_LOCATION = &quot;applicationContext.xml&quot;; public static void main(String[] args) &#123; //è‡ªå®šä¹‰ ioc å®¹å™¨è¿›è¡Œæ‰©å±• testDiyIoc(); &#125; private static void testDiyIoc() &#123; MyClassPathXmlApplicationContext ioc = new MyClassPathXmlApplicationContext(CONFIG_LOCATION); Person person = ioc.getBean(&quot;person&quot;, Person.class); System.out.println(&quot;person = &quot; + person); &#125; &#125;public class MyClassPathXmlApplicationContext extends ClassPathXmlApplicationContext &#123; public MyClassPathXmlApplicationContext(String...configLocations)&#123; super(configLocations); &#125; @Override protected void initPropertySources()&#123; System.out.println(&quot;è¿™æ˜¯æˆ‘è‡ªå·±å®šä¹‰çš„iocå®¹å™¨&quot;); //getEnvironment().setRequiredProperties(&quot;ES_HOME&quot;); &#125;&#125; ç¨‹åºå¯åŠ¨ä¹‹åï¼Œé¦–å…ˆä¼šè¿›å…¥è‡ªå®šä¹‰çš„iocå®¹å™¨ï¼Œç„¶åé€šè¿‡æ„é€ å™¨æ˜¾å¼è°ƒç”¨**super()**æ–¹æ³•æ¥åˆ°**ClassPathXmlApplicationContext**ã€‚ 1234567891011121314public ClassPathXmlApplicationContext( String[] configLocations, boolean refresh, @Nullable ApplicationContext parent) throws BeansException &#123; //è°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼ŒAbstractApplicationContext /*æ¨¡æ¿æ–¹æ³•æ¨¡å¼ å’Œ é’©å­æ–¹æ³• æ˜“äºæ‰©å±• å¼€é—­åŸåˆ™*/ super(parent); //è§£æé…ç½®æ–‡ä»¶è·¯å¾„ setConfigLocations(configLocations); /*refresh æ˜¯è¡¨ç¤ºä¸€ä¸ªå®¹å™¨æ˜¯å¦åˆ·æ–°è¿‡å¾—æ ‡è¯†ç¬¦ï¼Œå¦‚æœå®¹å™¨è¿˜æ²¡æœ‰åˆ·æ–°è¿‡å°±è¿›è¡Œå®¹å™¨åˆ·æ–°ï¼Œå®é™…ä¸Šè¿™é‡Œæ˜¯ä¸€ä¸ªåŒç«¯æ£€æµ‹é”*/ if (refresh) &#123; /*spring ioc å®¹å™¨åˆ·æ–°æ–¹æ³•*/ refresh(); &#125;&#125; è¿™é‡Œé¢ä¸»è¦æ˜¯åšäº†ä¸¤ä»¶äº‹ï¼šâ€‹ è§£æé…ç½®æ–‡ä»¶è·¯å¾„ **setConfigLocations()** åˆ¤æ–­å®¹å™¨æ˜¯å¦åˆ·æ–°è¿‡ï¼Œå¦‚æœå°šæœªåˆ·æ–°ï¼Œé‚£ä¹ˆåˆ·æ–°iocå®¹å™¨ **refresh()** â€‹ 2.è§£æé…ç½®æ–‡ä»¶1234567891011121314151617public void setConfigLocations(@Nullable String... locations) &#123; /*å¦‚æœlocationï¼=null ä¹Ÿå°±æ˜¯è¯´é…ç½®æ–‡ä»¶ä¸ä¸ºç©ºï¼Œspringæ‰«æåˆ°äº†é…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä»¥xmlçš„å½¢å¼å¯åŠ¨springå®¹å™¨*/ if (locations != null) &#123; /*æ–­è¨€ï¼šé…ç½®æ–‡ä»¶æ‰€åœ¨ä½ç½®ä¸èƒ½ä¸ºç©º*/ Assert.noNullElements(locations, &quot;Config locations must not be null&quot;); /*å¼•ç”¨*/ this.configLocations = new String[locations.length]; /*è¿­ä»£è§£æè·¯å¾„*/ for (int i = 0; i &lt; locations.length; i++) &#123; /*è§£æè·¯å¾„*/ this.configLocations[i] = resolvePath(locations[i]).trim(); &#125; &#125; else &#123; this.configLocations = null; &#125;&#125; å¦‚æœæˆ‘ä»¬ç¨‹åºæ˜¯æœ‰xmlçš„springé…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆè¯¥æ–‡ä»¶è¢«æ‰«æåˆ°ä»¥åï¼Œï¼ˆå½“ç„¶å¯èƒ½ä¸æ­¢ä¸€ä¸ª)ï¼Œå›å»è¿­ä»£è§£æé…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚ **resolvePath()**â€‹ 123protected String resolvePath(String path) &#123; return getEnvironment().resolveRequiredPlaceholders(path);&#125; è§£æç»™å®šçš„è·¯å¾„ï¼Œå¦‚æœæœ‰å¿…è¦çš„è¯ï¼Œç”¨ç›¸åº”çš„ç¯å¢ƒå±æ€§å€¼æ›¿æ¢å ä½ç¬¦ï¼Œåº”ç”¨äºé…ç½®ä½ç½®ã€‚**resolveRequiredPlaceholders()**â€‹ 12345@Overridepublic String resolveRequiredPlaceholders(String text) throws IllegalArgumentException &#123; /*å ä½ç¬¦è§£æå™¨è§£æå¹¶æ›¿æ¢å ä½ç¬¦*/ return this.propertyResolver.resolveRequiredPlaceholders(text);&#125; è¿™é‡Œå…¶å®æ˜¯å°†è§£æçš„é€»è¾‘äº¤ç»™äº†å±æ€§è§£æå™¨ã€‚**resolveRequiredPlaceholders()** 123456789@Overridepublic String resolveRequiredPlaceholders(String text) throws IllegalArgumentException &#123; if (this.strictHelper == null) &#123; /*å¦‚æœå ä½ç¬¦è§£æå™¨ä¸ºç©ºï¼Œå°±åˆ›å»ºä¸€ä¸ªå ä½ç¬¦è§£æå™¨*/ this.strictHelper = createPlaceholderHelper(false); &#125; /*çœŸæ­£å»è§£æå ä½ç¬¦çš„æ“ä½œ*/ return doResolvePlaceholders(text, this.strictHelper);&#125; åœ¨è¿™ä¸ªæŠ½è±¡çš„è§£æå™¨é‡Œé¢åˆé€šè¿‡å§”æ´¾æ¨¡å¼å§”æ´¾ç»™äº†çœŸæ­£çš„è§£æå ä½ç¬¦æ“ä½œçš„æ–¹æ³•ã€‚ **doResolvePlaceholders()**â€‹ è¿™é‡Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ï¼Ÿè¿™å…¶å®æ˜¯ä¸¤ä¸ªæ‰©å±•ç‚¹ï¼Œå¼€å‘äººå‘˜å¯ä»¥è‡ªå·±ç»§æ‰¿è¿™ä¸¤ä¸ªæŠ½è±¡ç±»ï¼Œé‡å†™å¯¹åº”çš„æ–¹æ³•ï¼Œæ¥å®ç°å®šåˆ¶åŒ–çš„è§£æå ä½ç¬¦çš„é€»è¾‘ã€‚â€‹ 1234private String doResolvePlaceholders(String text, PropertyPlaceholderHelper helper) &#123; /*ä½¿ç”¨ä¼ å…¥çš„å±æ€§å ä½ç¬¦è§£æå™¨å»è§£æå¹¶æ›¿æ¢å ä½ç¬¦*/ return helper.replacePlaceholders(text, this::getPropertyAsRawString);&#125; è¿™é‡Œäº¤ç»™äº†çœŸæ­£çš„å±æ€§è§£æå™¨**PropertyPlaceholderHelper**å»è§£æå±æ€§å ä½ç¬¦ã€‚â€‹ 12345public String replacePlaceholders(String value, PlaceholderResolver placeholderResolver) &#123; Assert.notNull(value, &quot;&#x27;value&#x27; must not be null&quot;); /*è§£æå­—ç¬¦ä¸²ç±»å‹çš„å€¼*/ return parseStringValue(value, placeholderResolver, null);&#125; å°†æ‰€æœ‰æ ¼å¼çš„**$&#123;name&#125;**å ä½ç¬¦æ›¿æ¢ä¸ºä»æä¾›çš„**PropertyPlaceHolderHelper**ï¼Œ**PlaceHolderResolver**è¿”å›çš„å€¼ã€‚â€‹ å†å¾€ä¸‹å°±æ˜¯å…·ä½“çš„è§£æå­—ç¬¦ä¸²çš„é€»è¾‘ï¼Œæ²¡æœ‰ä»€ä¹ˆç»§ç»­çš„å¿…è¦ã€‚â€‹ è¿™é‡Œé¢ä¸»è¦ä½“ç°çš„å°±æ˜¯åˆ©ç”¨**æŠ½è±¡ç±»** å’Œ **å§”æ´¾æ¨¡å¼** æä¾›äº†é»˜è®¤çš„å±æ€§è§£æå™¨å®ç°ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æä¾›è‡ªå·±çš„è§£æå™¨ï¼Œåªéœ€è¦ç»§æ‰¿ç›¸åº”çš„æŠ½è±¡ç±»ï¼Œå®ç°ç›¸åº”çš„æŠ½è±¡æ–¹æ³•ã€‚â€‹ 3.å®¹å™¨åˆ·æ–°è§£æå®Œé…ç½®æ–‡ä»¶è·¯å¾„ä»¥åï¼Œå°±æ˜¯åˆ¤æ–­å®¹å™¨æ˜¯å¦å·²ç»åˆ·æ–°è¿‡ï¼Œå¦‚æœå°šæœªåˆ·æ–°ï¼Œå°±ä¼šè¿›è¡Œå®¹å™¨çš„åˆ·æ–°åŠ¨ä½œã€‚ **AbstractApplicationContext.refresh()**â€‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677@Overridepublic void refresh() throws BeansException, IllegalStateException &#123; //åŠ é”æ˜¯å› ä¸ºiocå®¹å™¨åªèƒ½æœ‰ä¸€ä¸ªï¼Œé˜²æ­¢é‡å¤åˆ›å»º synchronized (this.startupShutdownMonitor) &#123; //å‡†å¤‡å¼€å§‹å®¹å™¨åˆ·æ–° StartupStep contextRefresh = this.applicationStartup.start(&quot;spring.context.refresh&quot;); // è·å–å½“å‰ç³»ç»Ÿçš„æ—¶é—´ï¼Œç»™å®¹å™¨è®¾ç½®åŒæ­¥é”æ ‡è¯† prepareRefresh(); // è§£æxmlé…ç½®æ–‡ä»¶æˆ–æ³¨è§£ beanå®šä¹‰èµ„æºçš„è½½å…¥ï¼Œè·å–ä¸€ä¸ªå…¨æ–°çš„beanå·¥å‚ ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // ç»™å®¹å™¨ä¸­æ³¨å†Œä¸€äº›ç»„ä»¶ï¼Œæ·»åŠ åˆ‡é¢ï¼Œç±»åŠ è½½å™¨ï¼Œè¡¨è¾¾å¼è§£æå™¨ï¼Œæ³¨è§£è§£æå™¨ï¼Œäº‹ä»¶å¤„ç†å™¨ prepareBeanFactory(beanFactory); try &#123; //ä¸ºå®¹å™¨çš„æŸäº›å­ç±»æŒ‡å®šåç½®å¤„ç†å™¨ï¼Œå­ç±»å¯ä»¥é€šè¿‡é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œ // åœ¨beanå·¥å‚åˆ›å»ºå¹¶é¢„å¤‡å®Œæˆä»¥ååšè¿›ä¸€æ­¥çš„è®¾ç½® /*å¯ä»¥åœ¨bdåˆ›å»ºå‡ºå®ä¾‹ä¹‹å‰ï¼Œå¯¹bdä¿¡æ¯åšè¿›ä¸€æ­¥çš„ä¿®æ”¹*/ postProcessBeanFactory(beanFactory); StartupStep beanPostProcess = this.applicationStartup.start(&quot;spring.context.beans.post-process&quot;); /** * æ‰§è¡Œbeanå·¥å‚çš„åç½®å¤„ç†å™¨ï¼Œå…ˆæ‰§è¡Œbeanå®šä¹‰æ³¨å†Œåç½®å¤„ç†å™¨ï¼Œåœ¨æ‰§è¡Œbeanå·¥å‚çš„åç½®å¤„ç†å™¨ã€‚ * æ‰§è¡Œé¡ºåºï¼šå…ˆæ‰§è¡Œå®ç°äº†ä¼˜å…ˆçº§æ¥å£çš„ï¼Œåœ¨æ‰§è¡Œå¸¦æœ‰orderçš„ï¼Œæœ€åæ‰§è¡Œå…¶ä»–çš„ã€‚ */ invokeBeanFactoryPostProcessors(beanFactory); // è·å–æ‰€æœ‰çš„åç½®å¤„ç†å™¨ï¼Œå…ˆæ³¨å†Œå¸¦ä¼˜å…ˆçº§çš„ï¼Œåœ¨æ³¨å†Œå¸¦orderçš„ï¼Œ // åœ¨æ³¨å†Œå‰©ä¸‹çš„ã€‚æ³¨å†Œä¸€ä¸ªApplicationListenerDetectorï¼Œ // åœ¨beanå®Œæˆåˆ›å»ºåæ£€æŸ¥æ˜¯æ˜¯å¦æ˜¯ApplicationListenerï¼Œå¦‚æœæ˜¯ï¼Œæ·»åŠ åˆ°å®¹å™¨ã€‚ registerBeanPostProcessors(beanFactory); beanPostProcess.end(); // åšä¸€äº›å›½é™…åŒ–ç›¸å…³çš„æ“ä½œ initMessageSource(); // åˆå§‹åŒ–äº‹ä»¶æ´¾å‘å™¨ï¼šè·å–beanFactoryï¼Œ // ä»beanFactoryè·å–äº‹ä»¶æ´¾å‘å™¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªæ”¾åˆ°å®¹å™¨ä¸­ã€‚ initApplicationEventMulticaster(); // ç•™ç»™å­å®¹å™¨ï¼Œå­å®¹å™¨å¯ä»¥å†å®¹å™¨åˆ·æ–°çš„æ—¶å€™åŠ å…¥è‡ªå·±çš„é€»è¾‘ã€‚ onRefresh(); // ä¸ºäº‹ä»¶æ´¾å‘å™¨æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œæ´¾å‘ä¸€äº›æ—©æœŸäº‹ä»¶ã€‚ registerListeners(); // åˆå§‹åŒ–å‰©ä¸‹çš„æ‰€æœ‰çš„éæ‡’åŠ è½½çš„å•å®ä¾‹beanã€‚ finishBeanFactoryInitialization(beanFactory); // åˆå§‹åŒ–å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¤„ç†å™¨ï¼Œ // å›è°ƒonRefresh()ï¼Œå¹¶å‘å¸ƒå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚ finishRefresh(); &#125; catch (BeansException ex) &#123; if (logger.isWarnEnabled()) &#123; logger.warn(&quot;Exception encountered during context initialization - &quot; + &quot;cancelling refresh attempt: &quot; + ex); &#125; // Destroy already created singletons to avoid dangling resources. destroyBeans(); // Reset &#x27;active&#x27; flag. cancelRefresh(ex); // Propagate exception to caller. throw ex; &#125; finally &#123; // Reset common introspection caches in Spring&#x27;s core, since we // might not ever need metadata for singleton beans anymore... resetCommonCaches(); contextRefresh.end(); &#125; &#125;&#125; â€‹ è¿™ä¸ªæ–¹æ³•å¾ˆé•¿ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯iocå®¹å™¨çš„æ ¸å¿ƒï¼Œè¿™é‡Œé¢æ¶‰åŠåˆ°çš„å…³äºSpringçš„é¢å¤–çš„çŸ¥è¯†ä¹Ÿæ¯”è¾ƒç¹å¤šï¼Œåœ¨æ­¤ä¼šå¯¹ç›¸å…³å†…å®¹è¿›è¡Œä¸€ä¸€åˆ—ä¸¾ã€‚ 4.å±æ€§èµ„æºè®¾ç½®ä¸æ ¡éªŒâ€‹ é¦–å…ˆä¼šå»è·å–å½“å‰ç³»ç»Ÿçš„æ—¶é—´ï¼Œç»™å®¹å™¨è®¾ç½®åŒæ­¥é”æ ‡è¯†ã€‚ **prepareRefresh()**â€‹ 12345678910111213141516171819202122232425262728293031323334353637protected void prepareRefresh() &#123; // è·å–å½“å‰ç³»ç»Ÿçš„æ—¶é—´ this.startupDate = System.currentTimeMillis(); //å…³é—­çŠ¶æ€è®¾ç½®ä¸ºfalse this.closed.set(false); //æ¿€æ´»çŠ¶æ€è®¾ç½®ä¸ºtrue this.active.set(true); //æ—¥å¿—æ‰“å° if (logger.isDebugEnabled()) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Refreshing &quot; + this); &#125; else &#123; logger.debug(&quot;Refreshing &quot; + getDisplayName()); &#125; &#125; // ç•™ç»™å­ç±»æ‰©å±•ï¼šå¯ä»¥åšä¸€äº›èµ„æºåˆå§‹åŒ– initPropertySources(); // æ£€éªŒå¿…é¡»æœ‰ç¯å¢ƒå˜é‡ ï¼Œç»“åˆä¸Šé¢çš„æ–¹æ³•å¯ä»¥è®¾ç½®å“ªäº›å±æ€§æ˜¯å¿…å¡«çš„ /*demoï¼šMyClassPathXmlApplicationContext*/ getEnvironment().validateRequiredProperties(); // è·å–å®¹å™¨æ—©æœŸçš„äº‹ä»¶ç›‘å¬å™¨ if (this.earlyApplicationListeners == null) &#123; this.earlyApplicationListeners = new LinkedHashSet&lt;&gt;(this.applicationListeners); &#125; else &#123; // å¦‚æœå·²ç»æœ‰äº†ï¼Œå°±å…ˆæ¸…ç©º åœ¨push this.applicationListeners.clear(); this.applicationListeners.addAll(this.earlyApplicationListeners); &#125; // å…è®¸è¿™äº›æ—©æœŸäº‹ä»¶åœ¨å®¹å™¨åˆ·æ–°ä¹‹åå‘å¸ƒå‡ºå» this.earlyApplicationEvents = new LinkedHashSet&lt;&gt;();&#125; \u0000è¿™é‡Œé¢å¯ä»¥å…³æ³¨ä¸€ä¸‹å‡ ä¸ªæ‰©å±•ç‚¹ï¼šâ€‹ å¯ä»¥å†å­ç±»åšä¸€äº›èµ„æºåˆå§‹åŒ–çš„æ–¹æ³• **initPropertySources()** å¯¹ä¸Šä¸€æ­¥è®¾ç½®çš„å±æ€§å˜é‡è¿›è¡Œæ ¡éªŒ **validateRequiredProperties()** â€‹ éšåä¼šè·å–åˆ°å®¹å™¨æ—©æœŸçš„ä¸€äº›äº‹ä»¶ç›‘å¬å™¨ï¼Œè¿™äº›æ—©æœŸäº‹ä»¶ä¼šåœ¨å®¹å™¨åˆ·æ–°æˆåŠŸä¹‹åå‘å¸ƒå‡ºå»ã€‚â€‹ 5.è§£æé…ç½®æ–‡ä»¶è¿™ä¸€æ­¥ä¸»è¦çš„æ“ä½œå°±æ˜¯è§£æSpringçš„é…ç½®æ–‡ä»¶æˆ–è€…æ³¨è§£æ ‡è¯†çš„é…ç½®ç±»ï¼ŒåŠ è½½beançš„å®šä¹‰ä¿¡æ¯ **BeanDefinition**ï¼Œç®€ç§°bdã€‚æœ€ååˆ›å»ºä¸€ä¸ª**BeanFactory**ï¼Œç®€ç§°bfã€‚â€‹ **obtainFreshBeanFactory()**\u0000 123456protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123; //åˆ·æ–°beanå·¥å‚ refreshBeanFactory(); /**è¿”å›beanå·¥å‚*/ return getBeanFactory();&#125; è¿™é‡Œé¢ä¸»è¦çš„é€»è¾‘å°±åœ¨äºbeanå·¥å‚çš„åˆ·æ–°ã€‚ **refreshBeanFactory()**â€‹ 1234567891011121314151617181920212223242526@Overrideprotected final void refreshBeanFactory() throws BeansException &#123; /*å¦‚æœå·²ç»æœ‰äº†beanå·¥å‚ï¼Œé€šå¸¸æƒ…å†µä¸‹å¹¶ä¸ä¼šï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¼šæœ‰ï¼Ÿé€šè¿‡applicationContextç›´æ¥è°ƒç”¨refreshæ–¹æ³•*/ if (hasBeanFactory()) &#123; /*é”€æ¯é‡Œé¢çš„æ‰€æœ‰bean*/ destroyBeans(); /*å…³é—­beanå·¥å‚*/ closeBeanFactory(); &#125; try &#123; //ä¸ç®¡ä¸Šé¢æ˜¯å¦å·²ç»æœ‰beanå·¥å‚å­˜åœ¨ï¼Œæœ€ç»ˆéƒ½ä¼šèµ°åˆ°è¿™é‡Œï¼Œå»åˆ›å»ºä¸€ä¸ªbeanå·¥å‚ DefaultListableBeanFactory beanFactory = createBeanFactory(); /*è®¾ç½®åºåˆ—åŒ–id*/ beanFactory.setSerializationId(getId()); /*å¯¹å·¥å‚è¿›è¡Œä¸€äº›å®šåˆ¶åŒ–è®¾ç½®*/ customizeBeanFactory(beanFactory); /*åŠ è½½beançš„å®šä¹‰ä¿¡æ¯*/ loadBeanDefinitions(beanFactory); /*å°†å½“å‰ç±»çš„beanå·¥å‚å¼•ç”¨æŒ‡å‘åˆ›å»ºçš„beanå·¥å‚*/ this.beanFactory = beanFactory; &#125; catch (IOException ex) &#123; throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex); &#125;&#125; è¿™é‡Œå¯ä»¥å…³æ³¨ä¸¤ç‚¹ï¼šâ€‹ å¦‚ä½•åˆ›å»ºä¸€ä¸ªbeanå·¥å‚ **createBeanFactory()** åŠ è½½bdçš„ä¿¡æ¯ **loadBeanDefinitions(beanFactory)** â€‹ 5.1 åˆ›å»ºbeanå·¥å‚123protected DefaultListableBeanFactory createBeanFactory() &#123; return new DefaultListableBeanFactory(getInternalParentBeanFactory());&#125; ä¸ºå½“å‰çš„å®¹å™¨ä¸Šä¸‹æ–‡åˆ›å»ºäº†ä¸€ä¸ªå†…éƒ¨beanå·¥å‚ï¼Œæ¯æ¬¡åˆ·æ–°çš„æ—¶å€™ä¼šå°è¯•è°ƒç”¨å½“å‰æ–¹æ³•ã€‚é»˜è®¤æ˜¯åˆ›å»ºäº†ä¸€ä¸ª_**DefaultListableBeanFactory**_ï¼Œå¹¶ä¸”å°†æ­¤ä¸Šä¸‹æ–‡çˆ¶çº§çš„å†…éƒ¨beanä½œä¸ºçˆ¶ beanå·¥å‚ã€‚å¯ä»¥å†å­ç±»ä¸­è¦†ç›–ï¼Œä¾‹å¦‚è‡ªå®šä¹‰_**DefaultListableBeanFactory**_çš„è®¾ç½®ã€‚â€‹ 5.2 BeanFactoryä¸Šé¢æåˆ°äº†ä¸€ä¸ª**DefaultListableBeanFactory**ï¼Œé‚£ä¹ˆéƒ½æœ‰å“ªäº›beanå·¥å‚å‘¢ï¼Ÿä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šbeanå·¥å‚å‘¢ï¼Ÿâ€‹ æ¥åˆ°**BeanFactory**çš„é¡¶å±‚æ¥å£ï¼Œ**BeanFactory** ä½œä¸ºé¡¶å±‚æ¥å£ï¼Œæä¾›äº†ä¸€äº›åˆ—æ“ä½œå·¥å‚å†…å¯¹è±¡çš„æ–¹æ³•ï¼Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„ã€‚â€‹ 123456/** * * å¯¹FactoryBeançš„è½¬ä¹‰å®šä¹‰ï¼Œå› ä¸ºå¦‚æœä½¿ç”¨beançš„åå­—æ£€ç´¢ FactoryBean å¾—åˆ°çš„å¯¹è±¡ * æ˜¯å·¥å‚ç”Ÿæˆçš„å¯¹è±¡ï¼Œå¦‚æœæƒ³è¦å¾—åˆ°å·¥å‚æœ¬èº«ï¼Œéœ€è¦è½¬ä¹‰ã€‚ */String FACTORY_BEAN_PREFIX = &quot;&amp;&quot;; \u0000è¿™æ˜¯å†³å®šä½ è·å–å½“å‰å·¥å‚è¿˜æ˜¯å½“å‰å·¥å‚å†…å¯¹è±¡çš„ä¸€ä¸ªé‡è¦æ ‡è¯†ç¬¦å·ï¼Œåˆ‡è®°ã€‚**&amp;**â€‹ æ¥ä¸‹æ¥å†å»çœ‹ **BeanFactory**çš„ç»§æ‰¿å…³ç³»ï¼Œä½œä¸ºé¡¶å±‚æ¥å£ï¼Œæˆ‘ä»¬è‡ªç„¶æ˜¯ä»ä¸Šå¾€ä¸‹çœ‹ã€‚â€‹ \u0000è¿™é‡Œé¢åˆ—ä¸¾äº†å‡ ä¸ªé‡è¦çš„Beanå·¥å‚ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œ**DefaultListableBeanFactory**æœ¬èº«å…¶å®æ˜¯beanå·¥å‚çš„é‡è¦å®ç°ç±»ã€‚â€‹ ä»å›¾ä¸Šçš„ç»§æ‰¿å…³ç³»å¯ä»¥çœ‹å‡ºï¼š**ListableBeanFactory**ã€**HierarchicalBeanFactory** å’Œ **AutowireCapableBeanFactory**ã€‚â€‹ ä¸ºä»€ä¹ˆè¦å®šä¹‰è¿™ä¹ˆå¤šå±‚æ¬¡çš„æ¥å£å‘¢ï¼Ÿâ€‹ ä¸»è¦æ˜¯ä¸ºäº†åŒºåˆ†åœ¨Springå†…éƒ¨æ“ä½œè¿‡ç¨‹ä¸­å¯¹è±¡çš„ä¼ é€’å’Œè½¬åŒ–è¿‡ç¨‹ï¼Œå¯¹å¯¹è±¡çš„æ•°æ®è®¿é—®æ‰€åšçš„ä¸€äº›é™åˆ¶ã€‚è¿™ä¸‰ä¸ªæ¥å£å…±åŒå®šä¹‰äº† Beançš„é›†åˆï¼ŒBeanä¹‹é—´å…³ç³»ï¼ŒBeanè¡Œä¸ºã€‚â€‹ åœ¨ **BeanFactory** é‡Œåªå¯¹ IOC å®¹å™¨çš„åŸºæœ¬è¡Œä¸ºä½œäº†å®šä¹‰ï¼Œæ ¹æœ¬ä¸å…³å¿ƒä½ çš„ Bean æ˜¯å¦‚ä½•å®šä¹‰æ€æ ·åŠ è½½çš„ã€‚æ­£å¦‚æˆ‘ä»¬åªå…³å¿ƒå·¥å‚é‡Œå¾—åˆ°ä»€ä¹ˆçš„äº§å“å¯¹è±¡ï¼Œè‡³äºå·¥å‚æ˜¯æ€ä¹ˆç”Ÿäº§è¿™äº›å¯¹è±¡çš„ï¼Œè¿™ä¸ªåŸºæœ¬çš„æ¥å£ä¸å…³å¿ƒã€‚è¦çŸ¥é“å·¥å‚æ˜¯å¦‚ä½•äº§ç”Ÿå¯¹è±¡çš„ï¼Œéœ€è¦çœ‹å…·ä½“çš„ IOC å®¹å™¨å®ç°ï¼ŒSpring æä¾›äº†è®¸å¤š IOC å®¹å™¨çš„ å® ç° ã€‚ **ApplicationContext**æ˜¯Springæä¾›çš„ä¸€ä¸ªé«˜çº§çš„iocå®¹å™¨ï¼Œä»–é™¤äº†èƒ½å¤Ÿæä¾›iocå®¹å™¨çš„åŸºæœ¬åŠŸèƒ½ä»¥å¤–ï¼Œè¿˜æœªç”¨æˆ·æä¾›äº†ä¸€äº›é™„åŠ çš„æœåŠ¡ï¼šâ€‹ æ”¯æŒä¿¡æ¯æºï¼Œå¯ä»¥å®ç°å›½é™…åŒ–ã€‚ **MessageSource** è®¿é—®èµ„æº **ResourcePatternResolver** æ”¯æŒåº”ç”¨äº‹ä»¶ **ApplicationEventPublisher** â€‹ å®¹å™¨æœ¬èº«å…¶å®ä¹Ÿæ˜¯æ‰©å±•ç‚¹ï¼Œæ”¯æŒæˆ‘ä»¬é€šè¿‡ç±»çš„ç»§æ‰¿æ¥åšä¸€äº›å®šåˆ¶åŒ–å®ç°ã€‚â€‹ 5.3åŠ è½½BeanDefinition**loadBeanDefinitions(beanFactory)**åœ¨**AbstractApplicationContext**å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œäº¤ç»™å­ç±»å»å®ç°ã€‚æ‰¾åˆ°å…·ä½“çš„å®ç°**AbstractXmlApplicationContext**ã€‚â€‹ 12345678910111213141516@Overrideprotected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException &#123; // åˆ›å»ºä¸€ä¸ªxml çš„beanDefinitionåŠ è½½å™¨ è¿™ä¸ªç©æ„é‡Œé¢æŒæœ‰ä¸€ä¸ªbeanFactoryçš„å¼•ç”¨ XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); /*ç»™beanDefinition åŠ è½½å™¨è®¾ç½®ä¸Šä¸‹æ–‡ç¯å¢ƒ èµ„æºåŠ è½½å™¨ å®ä½“è§£æå™¨*/ /*è¿™ç©æ„æˆ‘è®°å¾—éƒ½æ˜¯ç”¨çš„é»˜è®¤çš„*/ beanDefinitionReader.setEnvironment(this.getEnvironment()); beanDefinitionReader.setResourceLoader(this); beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); /*åˆå§‹åŒ–beanDefinitionåŠ è½½å™¨*/ initBeanDefinitionReader(beanDefinitionReader); /*ä½¿ç”¨beanDefinitionåŠ è½½å™¨åŠ è½½beanDefinitions*/ loadBeanDefinitions(beanDefinitionReader);&#125; è¿™é‡Œé¢éœ€è¦å…³æ³¨ä¸¤ä¸ªæ–¹æ³•ï¼š åˆå§‹åŒ–**beanDefinition**åŠ è½½å™¨ **initBeanDefinitionReader()** ä½¿ç”¨**beanDefinition**åŠ è½½å™¨åŠ è½½**beanDefinitions** **loadBeanDefinitions()** â€‹ ä¸è¿‡åœ¨åˆ†æè¿™ä¸¤ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œå…ˆæ˜ç¡®ä¸€ä¸‹**BeanDefinition**ã€‚â€‹ 5.4BeanDefinitionä»€ä¹ˆæ˜¯BeanDefinitionï¼Ÿâ€‹ **BeanDefinition**ä½œä¸ºå®šä¹‰Spring Bean æ–‡ä»¶ä¸­beançš„æ¥å£ï¼Œå¯ä»¥è¯´æ˜¯beançš„æŠ½è±¡çš„æ•°æ®ç»“æ„ï¼Œå®ƒåŒ…æ‹¬å±æ€§å‚æ•°ï¼Œæ„é€ å™¨å‚æ•°ï¼Œä»¥åŠå…¶ä»–å…·ä½“çš„å‚æ•°ã€‚â€‹ ç»§æ‰¿å…³ç³»â€‹ **BeanDefinition**ç»§æ‰¿äº†**AttributeAccessor**å’Œ**BeanMetaDataElement**æ¥å£ï¼Œæ‹¥æœ‰äº†å¯¹å…ƒæ•°æ®è®¿é—®çš„åŠŸèƒ½ã€‚â€‹ çœ‹ä¸€ä¸‹å…·ä½“çš„ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107public interface BeanDefinition extends AttributeAccessor, BeanMetadataElement &#123; /*å•ä¾‹çš„ä½œç”¨åŸŸ*/ String SCOPE_SINGLETON = ConfigurableBeanFactory.SCOPE_SINGLETON; /*å¤šä¾‹ä½œç”¨åŸŸ*/ String SCOPE_PROTOTYPE = ConfigurableBeanFactory.SCOPE_PROTOTYPE; /*ç”¨æˆ·*/ int ROLE_APPLICATION = 0; /*æŸäº›å¤æ‚çš„é…ç½®*/ int ROLE_SUPPORT = 1; /*å®Œå…¨å†…éƒ¨ä½¿ç”¨*/ int ROLE_INFRASTRUCTURE = 2; /*è®¾ç½®çˆ¶ç±»çš„åå­—*/ void setParentName(@Nullable String parentName); /*è·å–çˆ¶ç±»çš„åå­—*/ @Nullable String getParentName(); /*è®¾ç½®classç±»å‹å*/ void setBeanClassName(@Nullable String beanClassName); /*è¿”å›å½“å‰beançš„åå­—ï¼ˆå¹¶ä¸æ˜¯å‡†ç¡®çš„åå­—ï¼Œæœ‰äº›childBeanDefinitionæ˜¯ç»§æ‰¿è‡ªçˆ¶beançš„åå­—ï¼‰*/ /*æ‰€ä»¥ä¸èƒ½ä¾é è¯¥åå­—ç¡®å®šclassçš„ç±»å‹*/ @Nullable String getBeanClassName(); /*è®¾ç½®ä½œç”¨åŸŸ*/ void setScope(@Nullable String scope); /*è·å–ä½œç”¨åŸŸ*/ @Nullable String getScope(); /*è®¾ç½®æ‡’åŠ è½½*/ void setLazyInit(boolean lazyInit); /*åˆ¤æ–­æ˜¯å¦æ‡’åŠ è½½*/ boolean isLazyInit(); /*è®¾ç½®ä¾èµ–çš„bean*/ void setDependsOn(@Nullable String... dependsOn); /*ä¾èµ–çš„bean*/ @Nullable String[] getDependsOn(); /*è®¾ç½®ä¼˜å…ˆæ³¨å…¥å…¶ä»–bean*/ void setAutowireCandidate(boolean autowireCandidate); /*æ˜¯å¦ä¼˜å…ˆæ³¨å…¥å…¶ä»–bean*/ boolean isAutowireCandidate(); /*è®¾ç½®ä¼˜å…ˆè‡ªåŠ¨è£…é…*/ void setPrimary(boolean primary); /*è¿™ä¸ªbeanæ˜¯å¦ä¼˜å…ˆè‡ªåŠ¨è£…é…*/ boolean isPrimary(); /*è®¾ç½®å·¥å‚beançš„åå­—*/ void setFactoryBeanName(@Nullable String factoryBeanName); /*è¿”å›å·¥å‚beançš„åå­—*/ @Nullable String getFactoryBeanName(); /*è®¾ç½®å·¥å‚æ–¹æ³•å*/ void setFactoryMethodName(@Nullable String factoryMethodName); /*è¿”å›å·¥å‚æ–¹æ³•å*/ @Nullable String getFactoryMethodName(); /*è·å–æ„é€ å‡½æ•°çš„å€¼*/ ConstructorArgumentValues getConstructorArgumentValues(); /*åˆ¤æ–­æ˜¯å¦æœ‰æ„é€ å™¨å‚æ•°*/ default boolean hasConstructorArgumentValues() &#123; return !getConstructorArgumentValues().isEmpty(); &#125; /*è·å–å‚æ•°çš„å€¼*/ MutablePropertyValues getPropertyValues(); /*åˆ¤æ–­æ˜¯å¦æœ‰å±æ€§å‚æ•°*/ default boolean hasPropertyValues() &#123; return !getPropertyValues().isEmpty(); &#125; /*è®¾ç½®åˆå§‹åŒ–æ–¹æ³•*/ void setInitMethodName(@Nullable String initMethodName); /*è·å–åˆå§‹åŒ–æ–¹æ³•çš„åå­—*/ @Nullable String getInitMethodName(); /*è®¾ç½®é”€æ¯æ–¹æ³•çš„åå­—*/ void setDestroyMethodName(@Nullable String destroyMethodName); /*è·å–é”€æ¯æ–¹æ³•çš„åå­—*/ @Nullable String getDestroyMethodName(); /*è®¾ç½®è§’è‰²*/ void setRole(int role); /*è·å–è§’è‰²*/ int getRole(); /*è®¾ç½®æè¿°ä¿¡æ¯*/ void setDescription(@Nullable String description); /*è·å–æè¿°ä¿¡æ¯*/ @Nullable String getDescription(); // Read-only attributes ResolvableType getResolvableType(); /*æ˜¯å¦æ˜¯å•ä¾‹çš„*/ boolean isSingleton(); /*æ˜¯å¦æ˜¯å¤šä¾‹çš„*/ boolean isPrototype(); /*æ˜¯å¦æ˜¯æŠ½è±¡bean*/ boolean isAbstract(); /*è·å–èµ„æºæè¿°*/ @Nullable String getResourceDescription(); /*æœ‰äº›beanDeFInitionä¼šä½¿ç”¨beanDefinitionResourceè¿›è¡ŒåŒ…è£…ï¼Œå°†beanDefinitionæè¿°ä¸ºä¸€ä¸ªèµ„æº*/ @Nullable BeanDefinition getOriginatingBeanDefinition();&#125; å…·ä½“å®ç°â€‹ **RootBeanDefinition**ã€**GenericBeanDefinition**ã€**ChildBeanDefinition** **RootBeanDefinition**æ˜¯æœ€å¸¸ç”¨çš„å®ç°ç±»ï¼Œå®ƒå¯¹åº”ä¸€èˆ¬æ€§çš„å…ƒç´ æ ‡ç­¾ï¼Œ**GenericBeanDefinition**æ˜¯è‡ª2.5ä»¥åæ–°åŠ å…¥çš„beanæ–‡ä»¶é…ç½®å±æ€§å®šä¹‰ç±»ï¼Œæ˜¯ä¸€ç«™å¼æœåŠ¡ç±»ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ä»¥å®šä¹‰çˆ¶å’Œå­ï¼Œçˆ¶ç”¨**RootBeanDefinition**è¡¨ç¤ºï¼Œè€Œå­ç”¨**ChildBeanDefiniton**è¡¨ç¤ºï¼Œè€Œæ²¡æœ‰çˆ¶çš„å°±ä½¿ç”¨**RootBeanDefinition**è¡¨ç¤ºã€‚ **AnnotatedGenericBeanDefinition** ä»¥**@Configuration**æ³¨è§£æ ‡è®°çš„ä¼šè§£æä¸º**AnnotatedGenericBeanDefinition**ã€‚ **ConfigurationClassBeanDefinition** ä»¥**@Bean**æ³¨è§£æ ‡è®°çš„ä¼šè§£æä¸º**ConfigurationClassBeanDefinition**ã€‚ **ScannedGenericBeanDefinition** ä»¥**@Component**æ³¨è§£æ ‡è®°çš„ä¼šè§£æä¸º**ScannedGenericBeanDefinition**ã€‚â€‹ â€‹ æ€»ç»“ä¸€ä¸‹ï¼šå¦‚æœæŠŠiocå®¹å™¨çœ‹æˆæ˜¯ä¸€ä¸ªé£æœºåœºï¼Œé‚£ä¹ˆé‡Œé¢çš„beanå¯¹è±¡å°±æ˜¯ä¸€ä¸ªä¸ªçš„é£æœºï¼Œbdåˆ™æ˜¯å¯¹åº”çš„é€ é£æœºç”¨çš„å›¾çº¸ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ‹¿åˆ°å›¾çº¸ï¼Œæ ¹æ®å›¾çº¸æ‰èƒ½é€ é£æœºã€‚â€‹ 5.5 åˆå§‹åŒ–BeanDefinitionåŠ è½½å™¨**initBeanDefinitionReader()** 123protected void initBeanDefinitionReader(XmlBeanDefinitionReader reader) &#123; reader.setValidating(this.validating);&#125; åˆå§‹åŒ–åŠ è½½æ­¤ä¸Šä¸‹æ–‡çš„beanå®šä¹‰ä¿¡æ¯çš„beanå®šä¹‰è¯»å–å™¨ï¼Œé»˜è®¤å®ç°ä¸ºç©ºã€‚å¯ä»¥åœ¨å­ç±»ä¸­è¦†ç›–ï¼Œä¾‹å¦‚å…³é—­xmléªŒè¯æˆ–è€…ä½¿ç”¨ä¸åŒçš„_**XmlBeanDefinitionParser**__ å®ç°ã€‚_â€‹ 5.6 åŠ è½½beanå®šä¹‰ä¿¡æ¯**loadBeanDefinitions()\u0000** 1234567891011121314protected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws BeansException, IOException &#123; /*è¿™é‡Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªé’©å­æ–¹æ³•ï¼Œç»å…¸çš„æ¨¡æ¿æ¨¡å¼ï¼Œå­ç±»æ ¹æ®éœ€è¦å¯¹æ–¹æ³•è¿›è¡Œé‡å†™ï¼Œå®é™…ä¸ŠåŠ è½½xmlçš„æ—¶å€™ï¼Œè¿™é‡Œé”¤å­ä¹Ÿæ²¡æ‹¿åˆ°*/ Resource[] configResources = getConfigResources(); /*å¦‚æœèµ„æºä¸ä¸ºç©ºï¼Œèµ°è¿™é‡Œçš„é€»è¾‘ï¼Œä½†æ˜¯ä¸Šé¢å·²ç»åˆ†æè¿‡ï¼Œå®é™…ä¸Šé”¤å­ä¹Ÿæ²¡æ‹¿åˆ°ï¼Œæ‰€ä»¥èµ°ä¸‹é¢çš„é€»è¾‘*/ if (configResources != null) &#123; reader.loadBeanDefinitions(configResources); &#125; /*è·å–é…ç½®æ–‡ä»¶ä½ç½®*/ String[] configLocations = getConfigLocations(); /*æ­¤æ—¶è¯»å–åˆ°äº†æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶æŒ‡å®šçš„é…ç½®æ–‡ä»¶ beans.xml*/ if (configLocations != null) &#123; reader.loadBeanDefinitions(configLocations); &#125;&#125; 1234567891011121314151617public int loadBeanDefinitions(String... locations) throws BeanDefinitionStoreException &#123; /*æ–­è¨€ åˆ¤ç©º*/ Assert.notNull(locations, &quot;Location array must not be null&quot;); /*è®°å½•beanDefinitionçš„æ•°é‡*/ int count = 0; /*è¿­ä»£åŠ è½½beanDefinition*/ for (String location : locations) &#123; count += loadBeanDefinitions(location); &#125; return count;&#125;@Overridepublic int loadBeanDefinitions(String location) throws BeanDefinitionStoreException &#123; /*æ–¹æ³•é‡è½½*/ return loadBeanDefinitions(location, null);&#125; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public int loadBeanDefinitions(String location, @Nullable Set&lt;Resource&gt; actualResources) throws BeanDefinitionStoreException &#123; /*è·å–èµ„æºåŠ è½½å™¨*/ ResourceLoader resourceLoader = getResourceLoader(); /*å¦‚æœèµ„æºåŠ è½½å™¨ä¸ºç©ºï¼ŒæŠ›å¼‚å¸¸*/ if (resourceLoader == null) &#123; throw new BeanDefinitionStoreException( &quot;Cannot load bean definitions from location [&quot; + location + &quot;]: no ResourceLoader available&quot;); &#125; /*å¦‚æœèµ„æºåŠ è½½å™¨æ˜¯èµ„æºæ¨¡å¼è§£æå™¨ç±»å‹çš„*/ if (resourceLoader instanceof ResourcePatternResolver) &#123; // Resource pattern matching available. try &#123; /* å°†xmlé…ç½®æ–‡ä»¶åŠ è½½åˆ°resourcesä¸­ï¼Œresourceå…¶å®å°±æ˜¯springåº•å±‚å°è£…äº†å¾ˆå¤šçš„ç»†èŠ‚ï¼Œ æŠ½è±¡å‡ºæ¥çš„èµ„æºé¡¶å±‚æ¥å£ è®©å¼€å‘äººå‘˜ä¸å¿…ä¸“æ³¨äºåº•å±‚é…ç½®æ–‡ä»¶çš„åŠ è½½ç»†èŠ‚ */ Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location); /*åŠ è½½beanDefinition*/ int count = loadBeanDefinitions(resources); /*è¿™ç©æ„ä¸çŸ¥é“æ˜¯å•¥ï¼Œåæ­£æ˜¯ç©ºï¼Œæ²¡å•¥é”¤å­ç”¨*/ if (actualResources != null) &#123; Collections.addAll(actualResources, resources); &#125; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Loaded &quot; + count + &quot; bean definitions from location pattern [&quot; + location + &quot;]&quot;); &#125; return count; &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException( &quot;Could not resolve bean definition resource pattern [&quot; + location + &quot;]&quot;, ex); &#125; &#125;/*èµ°åˆ°è¿™é‡Œè¯´æ˜èµ„æºåŠ è½½å™¨è‚¯å®šä¸æ˜¯èµ„æºæ¨¡å¼è§£æå™¨ç±»å‹çš„*/ else &#123; // åªèƒ½é€šè¿‡ç»å¯¹ç½‘å€åŠ è½½å•ä¸ªèµ„æº Resource resource = resourceLoader.getResource(location); int count = loadBeanDefinitions(resource); if (actualResources != null) &#123; actualResources.add(resource); &#125; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Loaded &quot; + count + &quot; bean definitions from location [&quot; + location + &quot;]&quot;); &#125; return count; &#125;&#125; 1234567891011@Overridepublic int loadBeanDefinitions(Resource... resources) throws BeanDefinitionStoreException &#123; /*æ–­è¨€*/ Assert.notNull(resources, &quot;Resource array must not be null&quot;); int count = 0; /*è¿­ä»£éå†åŠ è½½*/ for (Resource resource : resources) &#123; count += loadBeanDefinitions(resource); &#125; return count;&#125; æœ€ç»ˆå°†åŠ è½½åˆ°çš„æ‰€æœ‰**beanDefinition**ä¿¡æ¯æ³¨å†Œåˆ°**BeanDefinitionRegistry**ã€‚è¿™ä¸ª**BeanDefinitionRegistry**è¢«**AbstractBeanDefinitionReader**æŒæœ‰ã€‚ 5.7 Resourceè¿™é‡Œé¢æ¶‰åŠåˆ°äº†ä¸€ä¸ªå¯¹è±¡ï¼Œ**Resource**ã€‚â€‹ SpringæŠŠå…¶èµ„æºåšäº†ä¸€ä¸ªæŠ½è±¡ï¼Œåº•å±‚ä½¿ç”¨ç»Ÿä¸€çš„èµ„æºè®¿é—®æ¥å£æ¥è®¿é—®Springçš„æ‰€æœ‰èµ„æºã€‚å³ï¼šä¸ç®¡ä»€ä¹ˆæ ¼å¼çš„æ–‡ä»¶ï¼Œä¹Ÿä¸ç®¡æ–‡ä»¶åœ¨å“ªé‡Œï¼Œåˆ°Springåº•å±‚ï¼Œéƒ½åªæœ‰ä¸€ä¸ªè®¿é—®æ¥å£ï¼Œ**Resource**ã€‚â€‹ ç±»ç»“æ„å›¾ ç±»å’Œæ¥å£çš„åˆ†æ å¯ä»¥çœ‹åˆ°æœ‰å››ä¸ªæ¯”è¾ƒé‡è¦çš„æ¥å£ï¼š**InputStreamSource**ã€**Resource**ã€**WritableResource**ã€**ContextResource**ã€‚ **InputStreamSource** 12345public interface InputStreamSource &#123; InputStream getInputStream() throws IOException;&#125; **Resource**æ¥å£ â€‹ æ¥å£ä¸­å®šä¹‰äº†å¯¹äºèµ„æºçš„åˆ¤æ–­ã€å¯¹èµ„æºçš„è·å–ã€å¯¹èµ„æºæè¿°çš„è·å–ã€‚é€šè¿‡è¯¥æ¥å£å¯ä»¥å¯¹èµ„æºè¿›è¡Œæœ‰æ•ˆçš„æ“ä½œã€‚ä½†æ˜¯**Resource**æ¥å£æ³¨é‡äºå¯¹èµ„æºçš„è¯»å–ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142/** * æ¥å£ä¸­å®šä¹‰äº†å¯¹äºèµ„æºçš„åˆ¤æ–­ã€å¯¹èµ„æºçš„è·å–ã€å¯¹èµ„æºæè¿°çš„è·å–ã€‚é€šè¿‡è¯¥æ¥å£å¯ä»¥å¯¹èµ„æºè¿›è¡Œæœ‰æ•ˆçš„æ“ä½œã€‚ä½†æ˜¯Resourceæ¥å£æ³¨é‡äºå¯¹èµ„æºçš„è¯»å–ã€‚ */public interface Resource extends InputStreamSource &#123; /*åˆ¤æ–­æ˜¯å¦å­˜åœ¨*/ boolean exists(); /*åˆ¤æ–­æ˜¯å¦å¯è¯»*/ default boolean isReadable() &#123; return exists(); &#125; /*åˆ¤æ–­æ˜¯å¦å¯ä»¥é‡å¤è¯»å–ï¼Œå¦‚æœä¸ºtrueè¡¨ç¤ºä¸å¯ä»¥é‡å¤è¯»å–ï¼Œåœ¨è¯»å–å®Œæˆä¹‹åï¼Œéœ€è¦å…³é—­æµ*/ default boolean isOpen() &#123; return false; &#125; /*åˆ¤æ–­æ˜¯å¦æ˜¯æ–‡ä»¶*/ default boolean isFile() &#123; return false; &#125; /*è·å–URLåœ°å€*/ URL getURL() throws IOException; /*è·å–URLåœ°å€*/ URI getURI() throws IOException; /*è·å–æ–‡ä»¶*/ File getFile() throws IOException; /*é»˜è®¤é€šè¿‡è¾“å…¥æµè·å–nioçš„åªè¯»å­—èŠ‚æµç®¡é“*/ default ReadableByteChannel readableChannel() throws IOException &#123; return Channels.newChannel(getInputStream()); &#125; /*èµ„æºé•¿åº¦*/ long contentLength() throws IOException; /*ä¸Šæ¬¡æ›´æ–°æ—¶é—´*/ long lastModified() throws IOException; /*æ ¹æ®èµ„æºçš„å½“å‰ä½ç½®ï¼Œè·å–ç›¸å¯¹ä½ç½®çš„å…¶ä»–èµ„æº*/ Resource createRelative(String relativePath) throws IOException; /*è¿”å›èµ„æºåç§°*/ @Nullable String getFilename(); /*è¿”å›èµ„æºæè¿°*/ String getDescription();&#125; **WritableResource** å› ä¸ºResourceæ¥å£ä¸»è¦æ˜¯æ³¨é‡å¯¹èµ„æºçš„è¯»å–ï¼Œå½“æˆ‘ä»¬å¯¹èµ„æºè¿›è¡Œå†™å…¥çš„æ—¶å€™ï¼Œéœ€è¦è·å–å¯¹åº”çš„åˆ¤æ–­å’Œè¾“å‡ºæµã€‚WritableResourceæ¥å£ä¸»è¦å®šä¹‰äº†å¯¹å†™å…¥çš„æ”¯æŒã€‚ 12345678910111213public interface WritableResource extends Resource &#123; /*è¿”å›èµ„æºæ˜¯å¦å¯ä»¥è¢«å†™å…¥*/ default boolean isWritable() &#123; return true; &#125; /*è·å–èµ„æºçš„å†™å…¥æµ*/ OutputStream getOutputStream() throws IOException; /*é»˜è®¤æä¾›çš„æ”¯æŒå†™çš„nioå­—èŠ‚ç®¡é“*/ default WritableByteChannel writableChannel() throws IOException &#123; return Channels.newChannel(getOutputStream()); &#125;&#125; **ContextResource** æœ‰äº›èµ„æºæ˜¯ç›¸å¯¹äºå½“å‰å®¹å™¨çš„ï¼Œç”¨æ¥è·å–å®¹å™¨ä¸­çš„èµ„æºã€‚ 12345public interface ContextResource extends Resource &#123; String getPathWithinContext();&#125; å­˜åœ¨ä¸€ä¸ª**AbstractResource**çš„æŠ½è±¡ç±»ï¼Œæ‰€æœ‰çš„å¯¹äºèµ„æºè·å–éƒ½ç»§æ‰¿è‡ª**AbstractResource**æŠ½è±¡ç±»ã€‚ å…¶ä½™çš„éƒ½æ˜¯å…·ä½“çš„å®ç°ç±»ï¼Œç”¨æ¥åŠ è½½æŒ‡å®šçš„èµ„æºã€‚ â€‹ å¯¹èµ„æºçš„åŠ è½½â€‹ Springæ¡†æ¶ä¸ºäº†æ›´æ–¹ä¾¿çš„è·å–èµ„æºï¼Œå°½é‡å¼±åŒ–ç¨‹åºå‘˜å¯¹å„ä¸ª**Resource**æ¥å£çš„å®ç°ç±»çš„æ„ŸçŸ¥ï¼Œå®šä¹‰äº†å¦ä¸€ä¸ª**ResourceLoader**æ¥å£ã€‚æ¥å£æœ‰ä¸€ä¸ªç‰¹åˆ«é‡è¦çš„æ–¹æ³•ï¼š**Resource getResource(String location);** è¿”å›**Resource**å®ä¾‹ã€‚å› æ­¤ç¨‹åºçŒ¿åœ¨ä½¿ç”¨springå®¹å™¨çš„æ—¶å€™ï¼Œå¯ä»¥ä¸å»è¿‡äºè®¡è¾ƒæ¯”è¾ƒåº•å±‚çš„**Resource**å®ç°ï¼Œä¹Ÿä¸éœ€è¦è‡ªå·±åˆ›å»º**Resource**çš„å®ç°ç±»ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨**ResourceLoader**è·å–åˆ°beanå®¹å™¨æœ¬èº«çš„**Resource**ï¼Œè¿›è€Œè·å–åˆ°ç›¸å…³çš„èµ„æºä¿¡æ¯ã€‚â€‹ **ResourceLoader** åªèƒ½å¯¹**classpath**è·¯å¾„ä¸‹é¢çš„èµ„æºè¿›è¡ŒåŠ è½½ï¼Œå¹¶ä¸”åªä¼šåŠ è½½æŒ‡å®šçš„æ–‡ä»¶ 123456789101112131415161718/** * Springæ¡†æ¶ä¸ºäº†æ›´æ–¹ä¾¿çš„è·å–èµ„æºï¼Œå°½é‡å¼±åŒ–ç¨‹åºå‘˜å¯¹å„ä¸ªResourceæ¥å£çš„å®ç°ç±»çš„æ„ŸçŸ¥ï¼Œå®šä¹‰äº†å¦ä¸€ä¸ªResourceLoaderæ¥å£ã€‚ * æ¥å£æœ‰ä¸€ä¸ªç‰¹åˆ«é‡è¦çš„æ–¹æ³•ï¼šResource getResource(String location)ï¼Œè¿”å›Resourceå®ä¾‹ã€‚å› æ­¤ç¨‹åºå‘˜åœ¨ä½¿ç”¨Springå®¹å™¨æ—¶ï¼Œ * å¯ä»¥ä¸å»è¿‡äºè®¡è¾ƒåº•å±‚Resourceçš„å®ç°ï¼Œä¹Ÿä¸éœ€è¦è‡ªå·±åˆ›å»ºResourceå®ç°ç±»ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ReourceLoaderï¼Œè·å–åˆ°beanå®¹å™¨æœ¬èº«çš„Resourceï¼Œ * è¿›è€Œå–åˆ°ç›¸å…³çš„èµ„æºä¿¡æ¯ã€‚ */public interface ResourceLoader &#123; /** Pseudo URL prefix for loading from the class path: &quot;classpath:&quot;. */ String CLASSPATH_URL_PREFIX = ResourceUtils.CLASSPATH_URL_PREFIX; /*ç”¨æ¥æ ¹æ®locationæ¥è·å–æŒ‡å®šçš„èµ„æº*/ Resource getResource(String location); /*è·å–ç±»åŠ è½½å™¨*/ @Nullable ClassLoader getClassLoader();&#125; **ResourcePatternResolver** è¡¨ç¤ºä¼šåŠ è½½æ‰€æœ‰è·¯å¾„ä¸‹é¢çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬jaråŒ…ä¸­çš„æ–‡ä»¶ã€‚åŒæ—¶**locationPattern**å¯ä»¥è®¾ç½®ä¸ºè¡¨è¾¾å¼æ¥åŠ è½½å¯¹åº”çš„æ–‡ä»¶ã€‚ 123456789101112131415/*è¡¨ç¤ºä¼šåŠ è½½æ‰€æœ‰è·¯å¾„ä¸‹é¢çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬jaråŒ…ä¸­çš„æ–‡ä»¶ã€‚åŒæ—¶locationPatternå¯ä»¥è®¾ç½®ä¸ºè¡¨è¾¾å¼æ¥åŠ è½½å¯¹åº”çš„æ–‡ä»¶ã€‚*/public interface ResourcePatternResolver extends ResourceLoader &#123; /** * è¡¨ç¤ºä¼šåŠ è½½æ‰€æœ‰è·¯å¾„ä¸‹é¢çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬jaråŒ…ä¸­ */ String CLASSPATH_ALL_URL_PREFIX = &quot;classpath*:&quot;; /** * æ ¹æ® */ Resource[] getResources(String locationPattern) throws IOException;&#125; åŒºåˆ«ï¼šâ€‹ **classpath**: ï¼šè¡¨ç¤ºä»ç±»è·¯å¾„ä¸­åŠ è½½èµ„æºï¼Œ**classpath**:å’Œ**classpath**:/æ˜¯ç­‰ä»·çš„ï¼Œéƒ½æ˜¯ç›¸å¯¹äºç±»çš„æ ¹è·¯å¾„ã€‚èµ„æºæ–‡ä»¶åº“æ ‡å‡†çš„åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨JARæˆ–ZIPçš„ç±»åŒ…ä¸­ã€‚â€‹ **classpath**:*ï¼šå‡è®¾å¤šä¸ªJARåŒ…æˆ–æ–‡ä»¶ç³»ç»Ÿç±»è·¯å¾„éƒ½æœ‰ä¸€ä¸ªç›¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œ**classpath**:åªä¼šåœ¨ç¬¬ä¸€ä¸ªåŠ è½½çš„ç±»è·¯å¾„ä¸‹æŸ¥æ‰¾ï¼Œè€Œ**classpath***:ä¼šæ‰«ææ‰€æœ‰è¿™äº›JARåŒ…åŠç±»è·¯å¾„ä¸‹å‡ºç°çš„åŒåæ–‡ä»¶ã€‚â€‹ **DefaultResourceLoader** springå®ç°çš„é»˜è®¤çš„åŠ è½½å™¨ï¼Œä¸€èˆ¬å…¶ä»–çš„åŠ è½½å™¨ä¼šç»§æ‰¿è¯¥ç±»ï¼Œå¹¶é‡å†™**getResourceByPath**æ–¹æ³•ã€‚ 123456789101112131415161718192021222324252627282930@Overridepublic Resource getResource(String location) &#123; Assert.notNull(location, &quot;Location must not be null&quot;); //å¾ªç¯éå†ä½¿ç”¨è§£æå™¨è§£æè¯¥locationçš„èµ„æºï¼Œå¦‚æœèµ„æºä¸ä¸ºç©ºï¼Œç›´æ¥è¿”å› for (ProtocolResolver protocolResolver : getProtocolResolvers()) &#123; Resource resource = protocolResolver.resolve(location, this); if (resource != null) &#123; return resource; &#125; &#125; /*ä»¥/å¼€å¤´é‚£ä¹ˆæ ¹æ®pathå»å¯»æ‰¾*/ if (location.startsWith(&quot;/&quot;)) &#123; return getResourceByPath(location); &#125; /*ä»¥classpathå¼€å¤´ï¼Œé‚£ä¹ˆæŠ½è±¡ä¸ºClassPathResource*/ else if (location.startsWith(CLASSPATH_URL_PREFIX)) &#123; return new ClassPathResource(location.substring(CLASSPATH_URL_PREFIX.length()), getClassLoader()); &#125; else &#123; try &#123; /*å…¶ä»–æƒ…å†µé‡‡ç”¨urlResourceæ¥åŠ è½½*/ URL url = new URL(location); return (ResourceUtils.isFileURL(url) ? new FileUrlResource(url) : new UrlResource(url)); &#125; catch (MalformedURLException ex) &#123; // No URL -&gt; resolve as resource path. return getResourceByPath(location); &#125; &#125;&#125; **PathMatchingResourcePatternResolver**â€‹ Springæä¾›äº†ä¸€ä¸ª**ResourcePatternResolver**å®ç°**PathMatchingResourcePatternResolver**ï¼Œå®ƒæ˜¯åŸºäºæ¨¡å¼åŒ¹é…çš„ï¼Œé»˜è®¤ä½¿ç”¨**AntPathMatcher**è¿›è¡Œè·¯å¾„åŒ¹é…ï¼Œå®ƒé™¤äº†æ”¯æŒ**ResourceLoader**æ”¯æŒçš„å‰ç¼€å¤–ï¼Œè¿˜é¢å¤–æ”¯æŒâ€œ**classpath**:â€ç”¨äºåŠ è½½æ‰€æœ‰åŒ¹é…çš„ç±»è·¯å¾„**Resource**ï¼Œ**ResourceLoader**ä¸æ”¯æŒå‰ç¼€â€œ**classpath**:â€ã€‚â€‹ 6.prepareBeanFactory(beanFactory)ç»™å®¹å™¨ä¸­æ³¨å†Œä¸€äº›ç»„ä»¶ï¼Œæ·»åŠ åˆ‡é¢ï¼Œç±»åŠ è½½å™¨ï¼Œè¡¨è¾¾å¼è§£æå™¨ï¼Œæ³¨è§£è§£æå™¨ï¼Œäº‹ä»¶å¤„ç†å™¨ã€‚ **prepareBeanFactory()**â€‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123; // Tell the internal bean factory to use the context&#x27;s class loader etc. /*ç±»åŠ è½½å™¨*/ beanFactory.setBeanClassLoader(getClassLoader()); if (!shouldIgnoreSpel) &#123; /*è¡¨è¾¾å¼è§£æå™¨*/ beanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader())); &#125; /*å±æ€§ç¼–è¾‘å™¨*/ beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment())); // ç»™å½“å‰å·¥å‚è®¾ç½®ä¸Šä¸‹æ–‡å›è°ƒ beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this)); beanFactory.ignoreDependencyInterface(EnvironmentAware.class); beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class); beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class); beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class); beanFactory.ignoreDependencyInterface(MessageSourceAware.class); beanFactory.ignoreDependencyInterface(ApplicationContextAware.class); beanFactory.ignoreDependencyInterface(ApplicationStartupAware.class); // BeanFactoryæ¥å£æœªåœ¨æ™®é€šå·¥å‚ä¸­æ³¨å†Œä¸ºå¯è§£æç±»å‹ã€‚ // æ³¨å†Œæ¶ˆæ¯èµ„æºçš„è§£æå™¨ beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory); beanFactory.registerResolvableDependency(ResourceLoader.class, this); beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this); beanFactory.registerResolvableDependency(ApplicationContext.class, this); // å°†ç”¨äºæ£€æµ‹å†…éƒ¨beansçš„æ—©æœŸåç½®å¤„ç†å™¨æ³¨å†Œä¸ºApplicationListenersã€‚ beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(this)); // Detect a LoadTimeWeaver and prepare for weaving, if found. if (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123; beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory)); // Set a temporary ClassLoader for type matching. beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader())); &#125; // Register default environment beans. if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123; beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment()); &#125; if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123; beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties()); &#125; if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123; beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment()); &#125; if (!beanFactory.containsLocalBean(APPLICATION_STARTUP_BEAN_NAME)) &#123; beanFactory.registerSingleton(APPLICATION_STARTUP_BEAN_NAME, getApplicationStartup()); &#125;&#125; 7.postProcessBeanFactory(beanFactory)â€‹ ä¸ºå®¹å™¨çš„æŸäº›å­ç±»æŒ‡å®šåç½®å¤„ç†å™¨ï¼Œå­ç±»å¯ä»¥é€šè¿‡é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨beanå·¥å‚åˆ›å»ºå¹¶é¢„å¤‡å®Œæˆä»¥ååšè¿›ä¸€æ­¥çš„è®¾ç½®ï¼Œå¯ä»¥åœ¨bdåˆ›å»ºå‡ºå®ä¾‹å¯¹è±¡ä¹‹å‰ï¼Œå¯¹bdä¿¡æ¯åšè¿›ä¸€æ­¥ä¿®æ”¹ã€‚**postProcessBeanFactory()** è¿™ä¹Ÿæ˜¯springæä¾›çš„ä¸€ä¸ªæ‰©å±•ç‚¹ã€‚â€‹ 12protected void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123;&#125; 8.æ‰§è¡Œbeanå·¥å‚çš„åç½®å¤„ç†å™¨æ‰§è¡Œbeanå·¥å‚çš„åç½®å¤„ç†å™¨ï¼Œå…ˆæ‰§è¡Œbeanå®šä¹‰æ³¨å†Œåç½®å¤„ç†å™¨ï¼Œåœ¨æ‰§è¡Œbeanå·¥å‚çš„åç½®å¤„ç†å™¨ã€‚æ‰§è¡Œé¡ºåºï¼šå…ˆæ‰§è¡Œå®ç°äº†ä¼˜å…ˆçº§æ¥å£çš„ï¼Œåœ¨æ‰§è¡Œå¸¦æœ‰orderçš„ï¼Œæœ€åæ‰§è¡Œå…¶ä»–çš„ã€‚â€‹ **invokeBeanFactoryPostProcessors(beanFactory)**â€‹ 1234567891011protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123; //æ‰§è¡Œbeanå·¥å‚çš„åç½®å¤„ç†å™¨ PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors()); // Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime // (e.g. through an @Bean method registered by ConfigurationClassPostProcessor) if (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.getTempClassLoader() == null &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123; beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory)); beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader())); &#125;&#125; **\u0000invokeBeanFactoryPostProcessors()** 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171public static void invokeBeanFactoryPostProcessors( ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors) &#123; //åˆå§‹åŒ–ä¸€ä¸ªsetåˆ—è¡¨ï¼Œå­˜å‚¨å·²ç»æ‰§è¡Œè¿‡çš„beanName Set&lt;String&gt; processedBeans = new HashSet&lt;&gt;(); //ç±»å‹æ–­è¨€ï¼šå¦‚æœæ˜¯BeanDefinitionRegistryç±»å‹çš„ //æ„æ€å°±æ˜¯ï¼šå½“å‰ beanFactory æ˜¯ beanDefinition çš„æ³¨å†Œä¸­å¿ƒ ï¼Œ bd å…¨éƒ¨æ³¨å†Œåˆ° bfã€‚ if (beanFactory instanceof BeanDefinitionRegistry) &#123; //ç±»å‹è½¬æ¢ bf -&gt; bdæ³¨å†Œä¸­å¿ƒ BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory; //å­˜å‚¨BeanFactoryPostProcessor List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = new ArrayList&lt;&gt;(); /*å­˜å‚¨BeanDefinitionRegistryPostProcessor*/ List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = new ArrayList&lt;&gt;(); /** * BeanFactoryPostProcessor å’Œ BeanDefinitionRegistryPostProcessor ä¹‹é—´çš„å…³ç³» ï¼Ÿ * BeanDefinitionRegistryPostProcessor æ˜¯ BeanFactoryPostProcessor çš„å­ç±»ã€‚ * å®ƒé‡Œé¢ æäº†ä¸€ä¸ªæ–°çš„æ–¹æ³• postProcessBeanDefinitionRegistry ï¼Œå¯ä»¥å¾€å®¹å™¨ä¸­æ³¨å†Œæ›´å¤šçš„bdä¿¡æ¯ã€‚ * æ‰©å±•ç‚¹ï¼š * â‘ BeanFactoryPostProcessor å¯¹bdä¿¡æ¯è¿›è¡Œä¿®æ”¹ * â‘¡postProcessBeanDefinitionRegistry æ·»åŠ æ›´å¤šçš„bdä¿¡æ¯ */ //å¤„ç†ApplicationContexté‡Œé¢ç¡¬ç¼–ç æ³¨å†Œçš„beanFactoryPostProcessor for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123; /*å¦‚æœå½“å‰åç½®å¤„ç†å™¨çš„ç±»å‹æ˜¯BeanDefinitionRegistryPostProcessor*/ if (postProcessor instanceof BeanDefinitionRegistryPostProcessor) &#123; /*å°†åç½®å¤„ç†å™¨è½¬æ¢ä¸ºBeanDefinitionRegistryPostProcessorç±»å‹*/ BeanDefinitionRegistryPostProcessor registryProcessor = (BeanDefinitionRegistryPostProcessor) postProcessor; /*æ‰§è¡Œåç½®å¤„ç†å™¨çš„æ–¹æ³• è¿™é‡Œåˆæ˜¯ä¸€ä¸ªåç½®å¤„ç†å™¨çš„è°ƒç”¨ç‚¹*/ registryProcessor.postProcessBeanDefinitionRegistry(registry); /*å°†æ‰§è¡Œå®Œçš„åç½®å¤„ç†å™¨åŠ å…¥åˆ°é›†åˆä¸­*/ registryProcessors.add(registryProcessor); &#125; else &#123;/*æ­¤æ—¶è¯´æ˜åç½®å¤„ç†å™¨æ˜¯ä¸€ä¸ªBeanFactoryPostProcessorï¼Œç›´æ¥åŠ å…¥åˆ°BeanFactoryPostProcessorçš„é›†åˆä¸­ã€‚åç»­ç»Ÿä¸€æ‰§è¡Œã€‚*/ regularPostProcessors.add(postProcessor); &#125; &#125; // è¿™é‡Œä¸è¦åˆå§‹åŒ–FactoryBeans:æˆ‘ä»¬éœ€è¦ä¿ç•™æ‰€æœ‰å¸¸è§„beançš„æœªåˆå§‹åŒ–çŠ¶æ€ï¼Œ // è®©beanå·¥å‚çš„åå¤„ç†å™¨åº”ç”¨äºå®ƒä»¬ï¼åœ¨å®ç°ä¼˜å…ˆçº§çš„bean definition registryåå¤„ç†å™¨ã€ // Orderedã€Orderedç­‰ä¹‹é—´è¿›è¡Œåˆ†ç¦»ã€‚ /*å½“å‰é˜¶æ®µçš„registryåç½®å¤„ç†å™¨é›†åˆ*/ List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = new ArrayList&lt;&gt;(); // é¦–å…ˆæ‰§è¡Œå®ç°äº†ä¸»æ’åºæ¥å£çš„åç½®å¤„ç†å™¨ PriorityOrdered String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) &#123; /*åˆ¤æ–­å¯¹åº”çš„beanæ˜¯å¦å®ç°äº†ä¸»æ’åºæ¥å£ï¼Œå¦‚æœå®ç°äº†ï¼Œå°±è®©è¯¥åç½®å¤„ç†å™¨æ·»åŠ åˆ°é›†åˆã€‚*/ if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); /*å·²ç»æ‰§è¡Œçš„åç½®å¤„ç†å™¨åå­—é›†åˆï¼Œå› ä¸ºæ¥ä¸‹æ¥é©¬ä¸Šè¦æ‰§è¡Œè¿™äº›åç½®å¤„ç†å™¨äº†ã€‚*/ processedBeans.add(ppName); &#125; &#125; /*å¯¹åç½®å¤„ç†å™¨è¿›è¡Œæ’åº æ ¹æ® getOrder() è¿”å›çš„å€¼è¿›è¡Œå‡åºæ’åº*/ sortPostProcessors(currentRegistryProcessors, beanFactory); /*æ³¨å†Œæ‰€æœ‰çš„åç½®å¤„ç†å™¨*/ registryProcessors.addAll(currentRegistryProcessors); /*è°ƒç”¨å½“å‰åç½®å¤„ç†å™¨çš„ç›¸å…³æ¥å£æ–¹æ³• æ‰§è¡Œ BeanDefinitionRegistryPostProcessor çš„ postProcessBeanDefinitionRegistry()*/ invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup()); /*æ¸…ç©ºå½“å‰é˜¶æ®µä¸´æ—¶çš„é›†åˆ*/ currentRegistryProcessors.clear(); // æ¥ç€æ‰§è¡Œå®ç°äº†Orderedæ¥å£çš„åç½®å¤„ç†å™¨ è¿™é‡Œçš„åç½®å¤„ç†å™¨æ˜¯æ™®é€šæ’åºåç½®å¤„ç†å™¨ postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) &#123; /*ç¡®ä¿æ¯ä¸€ä¸ªåç½®å¤„ç†å™¨åªæ‰§è¡Œä¸€æ¬¡*/ if (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); &#125; &#125; sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup()); currentRegistryProcessors.clear(); // æœ€åå°†å‰©ä¸‹çš„åç½®å¤„ç†å™¨é€ä¸ªæ‰§è¡Œ /*è¿™ä¸ªå˜é‡æ§åˆ¶æ˜¯å¦éœ€è¦å¾ªç¯*/ boolean reiterate = true; while (reiterate) &#123; reiterate = false; /*ä»beanå·¥å‚æ‹¿BeanDefinitionRegistryPostProcessorçš„åç½®å¤„ç†å™¨*/ postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); /*å¾ªç¯åˆ¤æ–­æ‰§è¡Œæ²¡æ‰§è¡Œè¿‡å¾—*/ for (String ppName : postProcessorNames) &#123; if (!processedBeans.contains(ppName)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); /*è¿™é‡Œä¸ºä»€ä¹ˆå§å˜é‡è®¾ç½®ä¸ºtrueï¼Ÿå› ä¸ºæ–°æ³¨å†Œçš„åç½®å¤„ç†å™¨ï¼Œå¯èƒ½ä¹Ÿæ˜¯å¾€å®¹å™¨ä¸­æ³¨å†Œçš„ registry ç±»å‹çš„åç½®å¤„ç†å™¨*/ reiterate = true; &#125; &#125; sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup()); currentRegistryProcessors.clear(); &#125; /*è¿™é‡Œæ˜¯æ‰§è¡ŒBeanDefinitionRegistryPostProcessor çš„çˆ¶ç±» BeanFactoryPostProcessor çš„æ–¹æ³•*/ // ä¸Šé¢é‡å¤ä¸‰éæ˜¯ä¸ºäº†æ‰§è¡Œ BeanDefinitionRegistryPostProcessor çš„æ–¹æ³•ï¼Œ // ä½†æ˜¯ï¼ŒBeanDefinitionRegistryPostProcessor è¿˜ç»§æ‰¿äº† BeanFactoryPostProcessor // è¿™é‡Œæ˜¯ä¸ºäº†æ‰§è¡Œæ‰€æœ‰åç½®å¤„ç†å™¨çš„ // ï¼ˆBeanFactoryPostProcessorï¼‰çš„ postProcessBeanFactoryæ–¹æ³•ã€‚ invokeBeanFactoryPostProcessors(registryProcessors, beanFactory); /*è¿™ä¸ªæ–¹æ³•å°±æ˜¯æ‰§è¡ŒBeanFactoryPostProcessorçš„æ–¹æ³•*/ invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory); &#125; /*å¤„ç†ä¸æ˜¯ BeanDefinitionRegistry ç±»å‹çš„åç½®å¤„ç†å™¨*/ else &#123; // è°ƒç”¨ä¸Šä¸‹æ–‡å®ä¾‹æ³¨å†Œçš„åç½®å¤„ç†å™¨ invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory); &#125; /** * ä¸Šé¢å¤„ç†çš„æ˜¯ç¡¬ç¼–ç çš„BeanDefinitionRegistryå’ŒBeanFactoryPostProcessorçš„åç½®å¤„ç†å™¨ã€‚ * ä¸‹é¢å¤„ç†å™¨çš„æ˜¯æ™®é€šçš„åç½®å¤„ç†å™¨ã€‚ */ // ä¸è¦åœ¨è¿™é‡Œåˆå§‹åŒ–FactoryBeans:æˆ‘ä»¬éœ€è¦ä¿ç•™æ‰€æœ‰å¸¸è§„beansæœªåˆå§‹åŒ–ä»¥è®©beanå·¥å‚åå¤„ç†å™¨åº”ç”¨äºå®ƒä»¬ï¼ /*è·å–å®¹å™¨å†…æ³¨å†Œçš„æ‰€æœ‰BeanFactoryPostProcessoré›†åˆã€‚è¿˜æ˜¯å¤„ç†ä¸»æ’åºï¼Œæ™®é€šæ’åºï¼Œä¸ºæ’åºçš„åç½®å¤„ç†å™¨é›†åˆ*/ String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false); // åœ¨å®ç°ä¼˜å…ˆçº§æœ‰åºã€æœ‰åºå’Œå…¶ä»–çš„BeanFactoryPostProcessorsä¹‹é—´è¿›è¡Œåˆ†ç¦»ã€‚ List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;&gt;(); List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;&gt;(); List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;&gt;(); for (String ppName : postProcessorNames) &#123; /*åŒ…å«è¯´æ˜å·²ç»æ‰§è¡Œè¿‡äº†ï¼Œç›´æ¥å•¥ä¹Ÿä¸åšè·³è¿‡å³å¯*/ if (processedBeans.contains(ppName)) &#123; // skip - already processed in first phase above &#125; else if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class)); &#125; else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; orderedPostProcessorNames.add(ppName); &#125; else &#123; nonOrderedPostProcessorNames.add(ppName); &#125; &#125; // é¦–å…ˆï¼Œæ‰§è¡Œå¸¦æœ‰ä¼˜å…ˆçº§æ¥å£çš„ sortPostProcessors(priorityOrderedPostProcessors, beanFactory); invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory); // æ¥ç€æ‰§è¡Œå®ç°äº†orderæ¥å£çš„ List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;&gt;(orderedPostProcessorNames.size()); for (String postProcessorName : orderedPostProcessorNames) &#123; orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class)); &#125; sortPostProcessors(orderedPostProcessors, beanFactory); invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory); // æœ€åæ‰§è¡Œå…¶ä»–å‰©ä½™çš„ List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size()); for (String postProcessorName : nonOrderedPostProcessorNames) &#123; nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class)); &#125; invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory); // å†…å­˜æ¸…ç†ï¼Œå¸®åŠ©GC beanFactory.clearMetadataCache(); /*æ€è€ƒï¼šä¸ºä»€ä¹ˆspringè¦æŠŠè¿™é‡Œä»£ç é€»è¾‘å†™çš„è¿™ä¹ˆéº»çƒ¦ï¼Ÿä¸ºäº†æ¡†æ¶çš„å¥å£®æ€§ï¼Œæä¾›æ›´å¥½çš„æ‰©å±•æ€§ï¼Œæ–¹ä¾¿åœ¨ä¸åŒé˜¶æ®µï¼Œé’ˆå¯¹ä¸åŒçš„éœ€æ±‚è¿›è¡Œæ‰©å±•ã€‚*/&#125; 9.æ³¨å†Œåç½®å¤„ç†å™¨è·å–æ‰€æœ‰çš„åç½®å¤„ç†å™¨ï¼Œå…ˆæ³¨å†Œå®ç°ä¸»æ’åºæ¥å£çš„ï¼Œåœ¨æ³¨å†Œå®ç°Orderæ¥å£çš„ï¼Œæœ€åæ³¨å†Œå‰©ä¸‹çš„ã€‚â€‹ æ³¨å†Œä¸€ä¸ª**ApplicationListenerDetector**ï¼Œåœ¨beanå®Œæˆåˆ›å»ºåæ£€æŸ¥æ˜¯å¦æ˜¯**ApplicationListener**ï¼Œå¦‚æœæ˜¯ï¼Œæ·»åŠ åˆ°å®¹å™¨ã€‚â€‹ 12345678/** * å®ä¾‹åŒ–å¹¶æ³¨å†Œæ‰€æœ‰ BeanPostProcessor beanï¼Œå¦‚æœç»™å‡ºï¼Œåˆ™éµå®ˆæ˜¾å¼é¡ºåºã€‚ * å¿…é¡»åœ¨åº”ç”¨ç¨‹åº bean çš„ä»»ä½•å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ã€‚ */protected void registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123; //æ³¨å†Œæ‰€æœ‰çš„åç½®å¤„ç†å™¨ PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this);&#125; **\u0000registerBeanPostProcessors()** 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374public static void registerBeanPostProcessors( ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) &#123; //è·å–åˆ°æ‰€æœ‰çš„BeanPostProcessoråç½®å¤„ç†å™¨çš„beanNameæ•°ç»„ String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false); // æ³¨å†Œbeanåç½®å¤„ç†å™¨æ£€æŸ¥å™¨ï¼Œå½“beanåœ¨beanåç½®å¤„ç†å™¨å®ä¾‹åŒ–æœŸé—´åˆ›å»ºæ—¶ï¼Œ // å³å½“beanä¸é€‚åˆè¢«æ‰€æœ‰beanåç½®å¤„ç†å™¨å¤„ç†æ—¶ï¼Œå®ƒä¼šè®°å½•ä¸€æ¡ä¿¡æ¯ã€‚ /*åç½®å¤„ç†å™¨æ•°é‡ï¼Œè®¡ç®—æ–¹å¼beanFactoryå·²ç»æœ‰çš„æ•°é‡+1+åæ³¨å†Œçš„ã€‚1ï¼Ÿä¸‹é¢ä¸€è¡Œæ‰‹åŠ¨ç¡¬åŠ çš„*/ int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length; /*BeanPostProcessorCheckerï¼Ÿ step into æ£€æŸ¥åˆ›å»ºbeanå®ä¾‹çš„æ—¶å€™ï¼Œåç½®å¤„ç†å™¨æ˜¯å¦å·²ç»å…¨éƒ¨æ³¨å†Œå®Œæ¯•ï¼Œå¦‚æœæœªå®Œæ¯•ï¼Œæ—¥å¿—æç¤ºã€‚*/ beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount)); // åˆ†ç¦» å®ç°äº†ä¸»æ’åºæ¥å£çš„åç½®å¤„ç†å™¨ List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;&gt;(); /*å­˜æ”¾mergedBeanDefinitionåç½®å¤„ç†å™¨*/ List&lt;BeanPostProcessor&gt; internalPostProcessors = new ArrayList&lt;&gt;(); /*æ™®é€šæ’åºæ¥å£çš„*/ List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;&gt;(); /*æ²¡æœ‰å®ç°æ’åºæ¥å£çš„*/ List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;&gt;(); /*å¾ªç¯å°†æ‰€æœ‰çš„åç½®å¤„ç†å™¨è¿›è¡Œåˆ†ç¦»å­˜æ”¾*/ for (String ppName : postProcessorNames) &#123; if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); priorityOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; orderedPostProcessorNames.add(ppName); &#125; else &#123; nonOrderedPostProcessorNames.add(ppName); &#125; &#125; // é¦–å…ˆæ³¨å†Œå®ç°äº†ä¼˜å…ˆçº§æ¥å£çš„åç½®å¤„ç†å™¨ sortPostProcessors(priorityOrderedPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors); // å…¶æ¬¡ï¼Œæ³¨å†Œå®ç°äº†orderæ¥å£çš„åç½®å¤„ç†å™¨ List&lt;BeanPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;&gt;(orderedPostProcessorNames.size()); for (String ppName : orderedPostProcessorNames) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); orderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; sortPostProcessors(orderedPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, orderedPostProcessors); // æœ€ç»ˆï¼Œæ³¨å†Œæ‰€æœ‰å‰©ä¸‹çš„æ‰€æœ‰åç½®å¤„ç†å™¨ List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size()); for (String ppName : nonOrderedPostProcessorNames) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); nonOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; //æ³¨å†Œåç½®å¤„ç†å™¨çš„é€»è¾‘ step into registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors); // æœ€åï¼Œå†æ¬¡å¤„ç†internalPostProcessorsï¼Œç¡®ä¿å­˜æ”¾mergedBeanDefinitionåç½®å¤„ç†å™¨åœ¨é“¾è¡¨çš„æœ«å°¾ sortPostProcessors(internalPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, internalPostProcessors); //é‡æ–°æ³¨å†Œåå¤„ç†å™¨æ—¶ï¼Œå°†å†…éƒ¨beansæ£€æµ‹ä¸ºApplicationListenersï¼Œå°†å…¶ç§»åŠ¨åˆ°å¤„ç†å™¨é“¾çš„æœ«ç«¯(ç”¨äºè·å–ä»£ç†ç­‰)ã€‚ beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext));&#125; 10.initMessageSource()\u0000åšä¸€äº›å›½é™…åŒ–ç›¸å…³çš„æ“ä½œã€‚**initMessageSource()**â€‹ 123456789101112131415161718192021222324252627protected void initMessageSource() &#123; ConfigurableListableBeanFactory beanFactory = getBeanFactory(); if (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123; this.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class); // Make MessageSource aware of parent MessageSource. if (this.parent != null &amp;&amp; this.messageSource instanceof HierarchicalMessageSource) &#123; HierarchicalMessageSource hms = (HierarchicalMessageSource) this.messageSource; if (hms.getParentMessageSource() == null) &#123; // Only set parent context as parent MessageSource if no parent MessageSource // registered already. hms.setParentMessageSource(getInternalParentMessageSource()); &#125; &#125; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Using MessageSource [&quot; + this.messageSource + &quot;]&quot;); &#125; &#125; else &#123; // Use empty MessageSource to be able to accept getMessage calls. DelegatingMessageSource dms = new DelegatingMessageSource(); dms.setParentMessageSource(getInternalParentMessageSource()); this.messageSource = dms; beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, this.messageSource); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;No &#x27;&quot; + MESSAGE_SOURCE_BEAN_NAME + &quot;&#x27; bean, using [&quot; + this.messageSource + &quot;]&quot;); &#125; &#125;&#125; 11.åˆå§‹åŒ–äº‹ä»¶æ´¾å‘å™¨**initApplicationEventMulticaster()**\u0000åˆå§‹åŒ–äº‹ä»¶æ´¾å‘å™¨ï¼Œè·å–beanå·¥å‚ï¼Œä»beanå·¥å‚è·å–äº‹ä»¶æ´¾å‘å™¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªæ”¾åˆ°å®¹å™¨ä¸­ã€‚â€‹ 1234567891011121314151617181920212223protected void initApplicationEventMulticaster() &#123; //è·å–beanå·¥å‚ ConfigurableListableBeanFactory beanFactory = getBeanFactory(); //åˆ¤æ–­å®¹å™¨æ˜¯å¦æœ‰äº‹ä»¶æ´¾å‘å™¨ if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123; //å¦‚æœæœ‰å°±è·å–åˆ°å¼•ç”¨ ï¼ˆç”¨æˆ·è‡ªå®šä¹‰äº†ä¸€ä¸ªäº‹ä»¶å¤šæ’­å™¨ï¼‰ /*å¯ä»¥å®ç°APPLICATION_EVENT_MULTICASTERæ¥å£æ¥è‡ªå·±å®ç°ä¸€ä¸ªäº‹ä»¶æ´¾å‘å™¨,é€šè¿‡beançš„æ–¹å¼ä¼ é€’ç»™spring*/ this.applicationEventMulticaster = beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Using ApplicationEventMulticaster [&quot; + this.applicationEventMulticaster + &quot;]&quot;); &#125; &#125; else &#123;//èµ°åˆ°è¿™é‡Œçš„å‰ææ˜¯å®¹å™¨ä¸­æ²¡æœ‰äº‹ä»¶æ´¾å‘å™¨,éœ€è¦ä½¿ç”¨springæ¡†æ¶é»˜è®¤æä¾›çš„äº‹ä»¶æ´¾å‘å™¨ã€‚ //ç›´æ¥é€ ä¸€ä¸ªäº‹ä»¶æ´¾å‘å™¨ this.applicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory); //å°†äº‹ä»¶æ´¾å‘å™¨æ³¨å†Œåˆ°ä¸€çº§ç¼“å­˜ï¼Œäº‹ä»¶æ´¾å‘å™¨æ˜¯å•ä¾‹çš„å…¨å±€é€šç”¨çš„ã€‚ beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, this.applicationEventMulticaster); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;No &#x27;&quot; + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + &quot;&#x27; bean, using &quot; + &quot;[&quot; + this.applicationEventMulticaster.getClass().getSimpleName() + &quot;]&quot;); &#125; &#125;&#125; 12.onRefresh()\u0000ç•™ç»™å­å®¹å™¨ï¼Œå­å®¹å™¨å¯ä»¥åœ¨å®¹å™¨åˆ·æ–°çš„æ—¶å€™åŠ å…¥è‡ªå·±çš„é€»è¾‘ã€‚**onRefresh()**â€‹ 123protected void onRefresh() throws BeansException &#123; // For subclasses: do nothing by default.&#125; 13.æ³¨å†Œç›‘å¬å™¨ä¸ºäº‹ä»¶æ´¾å‘å™¨æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œæ´¾å‘ä¸€äº›æ—©æœŸäº‹ä»¶ã€‚**registerListeners()**â€‹ 123456789101112131415161718192021protected void registerListeners() &#123; // å°†æ‰€æœ‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆç¡¬ç¼–ç çš„ï¼‰æ³¨å†Œåˆ°äº‹ä»¶æ´¾å‘å™¨ for (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123; getApplicationEventMulticaster().addApplicationListener(listener); &#125; // æ³¨å†Œé€šè¿‡beané…ç½®æä¾›çš„ç›‘å¬å™¨ ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ bd çš„æ–¹å¼ æä¾›listener String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false); for (String listenerBeanName : listenerBeanNames) &#123; getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName); &#125; // é€šè¿‡äº‹ä»¶æ´¾å‘å™¨æ´¾å‘å®¹å™¨æ—©æœŸåº”ç”¨ç¨‹åºäº‹ä»¶ è¿™é‡Œå¯ä»¥é€šè¿‡é‡å†™onRefreshæ–¹æ³•ç›´æ¥å¾€earlyApplicationEventsçš„seté›†åˆé‡Œé¢åŠ ã€‚ Set&lt;ApplicationEvent&gt; earlyEventsToProcess = this.earlyApplicationEvents; this.earlyApplicationEvents = null; if (!CollectionUtils.isEmpty(earlyEventsToProcess)) &#123; for (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123; getApplicationEventMulticaster().multicastEvent(earlyEvent); &#125; &#125;&#125; \u0000å…³æ³¨ä¸€ä¸‹ï¼š**ApplicationEventMulticaster.multicastEvent(earlyEvent)** æ´¾å‘äº‹ä»¶ã€‚â€‹ 123456789101112131415161718192021@Overridepublic void multicastEvent(ApplicationEvent event) &#123; multicastEvent(event, resolveDefaultEventType(event));&#125;@Overridepublic void multicastEvent(final ApplicationEvent event, @Nullable ResolvableType eventType) &#123; /*äº‹ä»¶ç±»å‹ä¸ºç©ºå°±æ˜¯ç”¨é»˜è®¤çš„äº‹ä»¶ç±»å‹è§£æå™¨*/ ResolvableType type = (eventType != null ? eventType : resolveDefaultEventType(event)); /*è·å–äº‹ä»¶å¤šæ³¢å™¨çš„çº¿ç¨‹æ± */ Executor executor = getTaskExecutor(); /*æ‹¿åˆ°å½“å‰äº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨ï¼Œä¼¦è½®è®­æ‰€æœ‰çš„ç›‘å¬å™¨ï¼Œå¯¹äº‹ä»¶è¿›è¡Œæ´¾å‘ã€‚*/ for (ApplicationListener&lt;?&gt; listener : getApplicationListeners(event, type)) &#123; if (executor != null) &#123; executor.execute(() -&gt; invokeListener(listener, event)); &#125; else &#123; invokeListener(listener, event); &#125; &#125;&#125; â€‹ **\u0000invokeListener()**â€‹ 12345678910111213141516protected void invokeListener(ApplicationListener&lt;?&gt; listener, ApplicationEvent event) &#123; /*è·å–åˆ°é”™è¯¯å¤„ç†å™¨çš„å¼•ç”¨*/ ErrorHandler errorHandler = getErrorHandler(); if (errorHandler != null) &#123; try &#123; /*çœŸæ­£æ‰§è¡Œæ´¾å‘äº‹ä»¶çš„é€»è¾‘*/ doInvokeListener(listener, event); &#125; catch (Throwable err) &#123; errorHandler.handleError(err); &#125; &#125; else &#123; doInvokeListener(listener, event); &#125;&#125; **doInvokeListener()**â€‹ 1234567891011121314151617181920212223242526private void doInvokeListener(ApplicationListener listener, ApplicationEvent event) &#123; try &#123; /*ç›‘å¬å™¨å‘å¸ƒäº‹ä»¶*/ listener.onApplicationEvent(event); &#125; catch (ClassCastException ex) &#123; String msg = ex.getMessage(); if (msg == null || matchesClassCastMessage(msg, event.getClass()) || (event instanceof PayloadApplicationEvent &amp;&amp; matchesClassCastMessage(msg, ((PayloadApplicationEvent) event).getPayload().getClass()))) &#123; // Possibly a lambda-defined listener which we could not resolve the generic event type for // -&gt; let&#x27;s suppress the exception. Log loggerToUse = this.lazyLogger; if (loggerToUse == null) &#123; loggerToUse = LogFactory.getLog(getClass()); this.lazyLogger = loggerToUse; &#125; if (loggerToUse.isTraceEnabled()) &#123; loggerToUse.trace(&quot;Non-matching event type for listener: &quot; + listener, ex); &#125; &#125; else &#123; throw ex; &#125; &#125;&#125; 13.1 ApplicationListenerApplicationListener &amp;&amp; ApplicationEventé€šè¿‡è‡ªå®šä¹‰ä¸åŒç±»å‹çš„äº‹ä»¶ï¼Œä½¿ç”¨ä¸åŒçš„ç›‘å¬å™¨ç›‘å¬ä¸åŒç±»å‹çš„äº‹ä»¶ï¼Œåšåˆ°jvmè¿›ç¨‹å†…çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œäº‹ä»¶é©±åŠ¨ï¼Œè§£è€¦ã€‚â€‹ 1234567891011121314151617public class MyEvent extends ApplicationEvent &#123; String message; public MyEvent(Object source) &#123; super(source); &#125; public MyEvent(Object source,String message) &#123; super(source); this.message=message; &#125; public void print()&#123; System.out.println(&quot;å‘å¸ƒäº†ä¸€ä¸ªäº‹ä»¶ï¼š&quot;+message); &#125;&#125; 12345678public class MyListener implements ApplicationListener&lt;MyEvent&gt; &#123; @Override public void onApplicationEvent(MyEvent event) &#123; event.print(); &#125;&#125; 1234567/** * æµ‹è¯•spring çš„ ioc å®¹å™¨çš„äº‹ä»¶å‘å¸ƒ */private static void testPublishEvent() &#123; ApplicationContext ioc = new ClassPathXmlApplicationContext(CONFIG_LOCATION); ioc.publishEvent(new MyEvent(&quot;&quot;, &quot;è¿™æ˜¯æˆ‘è‡ªå®šä¹‰çš„ä¸€ä¸ªäº‹ä»¶&quot;));&#125; @EventListenerå¯¹ä¸Šé¢å†™æ³•çš„ä¸€ä¸ªä¼˜åŒ–ï¼Œæ›´åŠ ç®€æ´ï¼Œå¼€å‘é‡æ›´å°‘ï¼Œæ‡’äººå¿…å¤‡ç¥å™¨ã€‚â€‹ 12345678private static void testEventListener() &#123; ioc.publishEvent(new ApplicationEvent(&quot;helloï¼Œspring&quot;) &#123; @Override public Object getSource() &#123; return super.getSource(); &#125; &#125;);&#125; 12345678@Componentpublic class MyEventListener &#123; @EventListener(classes = ApplicationEvent.class) public void listener(ApplicationEvent event)&#123; System.out.println(&quot;event = &quot; + event); &#125;&#125; 14.åˆå§‹åŒ–å‰©ä¸‹æ‰€æœ‰çš„å•å®ä¾‹bean**finishBeanFactoryInitialization(beanFactory)**\u0000 12345678910111213141516171819202122232425262728protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) &#123; // ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–è½¬æ¢æœåŠ¡ if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp; beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123; beanFactory.setConversionService( beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)); &#125; // å¦‚æœå®¹å™¨é‡Œé¢æ²¡æœ‰å­—ç¬¦ä¸²è½¬æ¢å™¨ï¼Œåˆå§‹åŒ–ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢å™¨æ”¾åˆ°å®¹å™¨ä¸­ã€‚ if (!beanFactory.hasEmbeddedValueResolver()) &#123; beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal)); &#125; // å°½æ—©åˆå§‹åŒ–LoadTimeWeaverAware beansï¼Œä»¥ä¾¿å°½æ—©æ³¨å†Œå®ƒä»¬çš„è½¬æ¢å™¨ã€‚ String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false); for (String weaverAwareName : weaverAwareNames) &#123; getBean(weaverAwareName); &#125; // åœæ­¢ä½¿ç”¨ä¸´æ—¶ç±»åŠ è½½å™¨è¿›è¡Œç±»å‹åŒ¹é… beanFactory.setTempClassLoader(null); // å…è®¸ç¼“å­˜æ‰€æœ‰beanå®šä¹‰å…ƒæ•°æ®ï¼Œä¸æœŸæœ›è¿›ä¸€æ­¥çš„æ›´æ”¹ï¼Œå†»ç»“bdä¿¡æ¯ï¼Œå†»ç»“ä¹‹åå°±æ— æ³•å¾€bfæ³¨å†Œbdäº† beanFactory.freezeConfiguration(); // å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„å•å®ä¾‹bean beanFactory.preInstantiateSingletons();&#125; å¦‚ä½•å†»ç»“bdä¿¡æ¯çš„ï¼Ÿ**beanFactory.freezeConfiguration()**â€‹ 123456@Overridepublic void freezeConfiguration() &#123; /*è¿™ä¸ªå­—æ®µå¦‚æœæ˜¯trueï¼Œnameå°±ä¸èƒ½å¾€å®¹å™¨ä¸­æ·»åŠ æ–°çš„beanDefinitionäº†*/ this.configurationFrozen = true; this.frozenBeanDefinitionNames = StringUtils.toStringArray(this.beanDefinitionNames);&#125; **beanFactory.preInstantiateSingletons()**â€‹ è¿™ä¸ªæ–¹æ³•å†…å®¹è¿‡å¤šä¸”åæ ¸å¿ƒå†…å®¹ï¼Œç•™åœ¨ä¸‹ä¸€ç¯‡åˆ†æï¼Œè·³è¿‡è¿™é‡Œï¼ŒåŠ è½½å®Œæ‰€æœ‰çš„å•å®ä¾‹beanä¹‹åï¼Œçœ‹è¿˜è¦åšä»€ä¹ˆæ“ä½œã€‚â€‹ 15.finishRefresh()åˆå§‹åŒ–å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¤„ç†å™¨ï¼Œå›è°ƒ**onRefresh()**,å¹¶å‘å¸ƒå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚**finishRefresh() **\u0000 1234567891011121314151617181920212223protected void finishRefresh() &#123; // æ¸…é™¤ä¸Šä¸‹æ–‡çº§èµ„æºç¼“å­˜(ä¾‹å¦‚æ¥è‡ªæ‰«æçš„ASMå…ƒæ•°æ®)ã€‚ clearResourceCaches(); // ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ã€‚ /*æ¡ˆä¾‹æ¼”ç¤ºï¼šlifecycle package * ä¸¤è€…çš„åŒºåˆ«ï¼š * smartï¼šæ­£å¸¸æƒ…å†µä¸‹å°±ä¼šæ‰§è¡Œ * æ™®é€šçš„ï¼šå¿…é¡»æ˜¾ç¤ºè°ƒç”¨å®¹å™¨.start()/.stop() * */ initLifecycleProcessor(); // é¦–å…ˆå°†åˆ·æ–°ä¼ æ’­åˆ°ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ã€‚å›è°ƒ onRefresh getLifecycleProcessor().onRefresh(); // å‘å¸ƒå®¹å™¨åˆ›å»ºå®Œæˆäº‹ä»¶ publishEvent(new ContextRefreshedEvent(this)); // æ³¨å†Œå®¹å™¨ä¸Šä¸‹æ–‡ if (!NativeDetector.inNativeImage()) &#123; LiveBeansView.registerApplicationContext(this); &#125;&#125; 15.1 ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¤„ç†å™¨**initLifecycleProcessor()**\u0000 1234567891011121314151617181920212223protected void initLifecycleProcessor() &#123; /*è·å–beanå·¥å‚*/ ConfigurableListableBeanFactory beanFactory = getBeanFactory(); /*åˆ¤æ–­å·¥å‚æ˜¯å¦å·²ç»æœ‰ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ï¼Œæœ‰çš„è¯ç›´æ¥è·å–å¼•ç”¨*/ if (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME)) &#123; this.lifecycleProcessor = beanFactory.getBean(LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.class); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Using LifecycleProcessor [&quot; + this.lifecycleProcessor + &quot;]&quot;); &#125; &#125; else &#123; /*æ­¤æ—¶å°±æ˜¯å·¥å‚ç›®å‰è¿˜æ²¡æœ‰çš„é€»è¾‘ï¼Œé‚£ä¹ˆå°±éœ€è¦è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª*/ DefaultLifecycleProcessor defaultProcessor = new DefaultLifecycleProcessor(); defaultProcessor.setBeanFactory(beanFactory); this.lifecycleProcessor = defaultProcessor; /*æ³¨å†Œåˆ°ä¸€çº§ç¼“å­˜*/ beanFactory.registerSingleton(LIFECYCLE_PROCESSOR_BEAN_NAME, this.lifecycleProcessor); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;No &#x27;&quot; + LIFECYCLE_PROCESSOR_BEAN_NAME + &quot;&#x27; bean, using &quot; + &quot;[&quot; + this.lifecycleProcessor.getClass().getSimpleName() + &quot;]&quot;); &#125; &#125;&#125; 15.2 ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¤„ç†å™¨**Lifecycle** &amp;&amp; **SmartLifecycle**â€‹ å®¹å™¨åˆ›å»ºå®Œæˆä¹‹åçš„å›è°ƒï¼Œä¼ é€’çš„å‚æ•°_**autoStartUpOnly**_æ˜¯å¹²å˜›çš„ï¼Ÿâ€‹ è¡¨ç¤ºåªå¯åŠ¨_**SmartLifeCycle**_ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ï¼Œå¹¶ä¸”å¯åŠ¨çš„å¯¹è±¡_**autoStartUpOnly**_å¿…é¡»æ˜¯trueï¼Œä¸ä¼šå¯åŠ¨æ™®é€šçš„ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ï¼Œfalseçš„æ—¶å€™ï¼Œä¼šå¯åŠ¨å…¨éƒ¨çš„ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ã€‚â€‹ 1234567891011121314151617181920public class DemoLifeCycle implements Lifecycle &#123; private boolean running =false; @Override public void start() &#123; this.running=true; System.out.println(&quot;demo one start!&quot;); &#125; @Override public void stop() &#123; this.running=false; System.out.println(&quot;demo one stop!&quot;); &#125; @Override public boolean isRunning() &#123; return running; &#125;&#125; 1234567891011121314151617181920public class DemoSmartLifeCycle implements SmartLifecycle &#123; private boolean running = false; @Override public void start() &#123; this.running=true; System.out.println(&quot;demo two start!&quot;); &#125; @Override public void stop() &#123; this.running=false; System.out.println(&quot;demo two stop!&quot;); &#125; @Override public boolean isRunning() &#123; return running; &#125;&#125; 15.3 å›è°ƒonRefresh()**onRefresh()** 123456789@Overridepublic void onRefresh() &#123; /*ä¼ é€’çš„å‚æ•°autoStartUpOnlyæ˜¯å¹²å˜›çš„ï¼Ÿ * è¡¨ç¤ºåªå¯åŠ¨SmartLifeCycleç”Ÿå‘½å‘¨æœŸå¯¹è±¡ï¼Œå¹¶ä¸”å¯åŠ¨çš„å¯¹è±¡autoStartUpOnlyå¿…é¡»æ˜¯trueï¼Œ * ä¸ä¼šå¯åŠ¨æ™®é€šçš„ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ï¼Œ * falseçš„æ—¶å€™ï¼Œä¼šå¯åŠ¨å…¨éƒ¨çš„ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ã€‚*/ startBeans(true); this.running = true;&#125; **startBeans(true)**â€‹ 12345678910111213141516171819202122232425private void startBeans(boolean autoStartupOnly) &#123; /*è·å–åˆ°æ‰€æœ‰å®ç°äº†ç”Ÿå‘½å‘¨æœŸæ¥å£çš„å¯¹è±¡ï¼ŒåŒ…è£…åˆ°mapå†… kï¼šbeanName v: ç”Ÿå‘½å‘¨æœŸå¯¹è±¡*/ Map&lt;String, Lifecycle&gt; lifecycleBeans = getLifecycleBeans(); /*å› ä¸ºç”Ÿå‘½å‘¨æœŸå¯¹è±¡å¯èƒ½ä¾èµ–å…¶ä»–ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„æ‰§è¡Œç»“æœï¼Œæ‰€ä»¥éœ€è¦æ‰§è¡Œé¡ºåºï¼Œä¾é  smartç”Ÿå‘½å‘¨æœŸæ¥å£å®ç°çš„å¦ä¸€ä¸ªæ¥å£ ï¼Œæ–¹æ³•è¿”å›å€¼è¶Šä½ï¼Œä¼˜å…ˆçº§è¶Šé«˜ */ Map&lt;Integer, LifecycleGroup&gt; phases = new TreeMap&lt;&gt;(); /*éå†åˆ¤æ–­æ»¡è¶³æ¡ä»¶åŠ å…¥åˆ°é›†åˆ * æ¡ä»¶1ï¼šSmartLifecycle * æ¡ä»¶2ï¼šè‡ªå¯åŠ¨ * */ lifecycleBeans.forEach((beanName, bean) -&gt; &#123; if (!autoStartupOnly || (bean instanceof SmartLifecycle &amp;&amp; ((SmartLifecycle) bean).isAutoStartup())) &#123; /*æ’åºå€¼*/ int phase = getPhase(bean); phases.computeIfAbsent( phase, p -&gt; new LifecycleGroup(phase, this.timeoutPerShutdownPhase, lifecycleBeans, autoStartupOnly) ).add(beanName, bean); &#125; &#125;); /*è½®è®­å¯åŠ¨æ‰€æœ‰çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨*/ if (!phases.isEmpty()) &#123; phases.values().forEach(LifecycleGroup::start); &#125;&#125; **start()** 123456789101112131415public void start() &#123; /*membersï¼Ÿçœ‹ä¸Šé¢çš„addæ–¹æ³•ï¼Œç›¸å½“äºåˆ¤æ–­ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¤„ç†å™¨æ˜¯ä¸æ˜¯ç©ºï¼Œå¦‚æœæ˜¯ç©ºçš„è¯å°±æ²¡å¿…è¦å‘ä¸‹æ‰§è¡Œäº†ã€‚*/ if (this.members.isEmpty()) &#123; return; &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Starting beans in phase &quot; + this.phase); &#125; /*å¯¹ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¤„ç†å™¨è¿›è¡Œä¸€ä¸ªæ’åº*/ Collections.sort(this.members); for (LifecycleGroupMember member : this.members) &#123; /*çœŸæ­£æ‰§è¡Œå¯åŠ¨çš„é€»è¾‘*/ doStart(this.lifecycleBeans, member.name, this.autoStartupOnly); &#125;&#125; **doStart()** 123456789101112131415161718192021222324252627282930313233343536/** * å°†æŒ‡å®šçš„ bean ä½œä¸ºç»™å®šçš„ Lifecycle bean é›†çš„ä¸€éƒ¨åˆ†å¯åŠ¨ï¼Œç¡®ä¿é¦–å…ˆå¯åŠ¨å®ƒæ‰€ä¾èµ–çš„ä»»ä½• beanã€‚ * @param lifecycleBeans a Map with bean name as key and Lifecycle instance as value * @param beanName the name of the bean to start */private void doStart(Map&lt;String, ? extends Lifecycle&gt; lifecycleBeans, String beanName, boolean autoStartupOnly) &#123; /*ç¡®ä¿æ¯ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨æ™ºåªèƒ½è¢«å¯åŠ¨ä¸€æ¬¡ï¼Œåœ¨ä¸€ä¸ªåˆ†ç»„å†…è¢«å¯åŠ¨ï¼Œå…¶ä»–åˆ†ç»„å†…å°±çœ‹ä¸åˆ°è¿™ä¸ªç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨*/ Lifecycle bean = lifecycleBeans.remove(beanName); if (bean != null &amp;&amp; bean != this) &#123; /*è·å–å½“å‰å³å°†è¦è¢«å¯åŠ¨çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨é”ä¾èµ–çš„å…¶ä»–beanName*/ String[] dependenciesForBean = getBeanFactory().getDependenciesForBean(beanName); /*å…ˆå¯åŠ¨å½“å‰ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨æ‰€ä¾èµ–çš„å…¶ä»–lifeCycle*/ for (String dependency : dependenciesForBean) &#123; doStart(lifecycleBeans, dependency, autoStartupOnly); &#125; /* * æ¡ä»¶æˆç«‹ï¼šæ‰§è¡Œstartæ–¹æ³• * */ if (!bean.isRunning() &amp;&amp; (!autoStartupOnly || !(bean instanceof SmartLifecycle) || ((SmartLifecycle) bean).isAutoStartup())) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Starting bean &#x27;&quot; + beanName + &quot;&#x27; of type [&quot; + bean.getClass().getName() + &quot;]&quot;); &#125; try &#123; /*å¯åŠ¨å½“å‰lifeCycle*/ bean.start(); &#125; catch (Throwable ex) &#123; throw new ApplicationContextException(&quot;Failed to start bean &#x27;&quot; + beanName + &quot;&#x27;&quot;, ex); &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Successfully started bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; &#125; &#125;&#125; çœ‹å®Œäº†å¯åŠ¨ï¼Œå†çœ‹ä¸€ä¸‹åœæ­¢ã€‚â€‹ **stop()** 12345678910111213/** * åœæ­¢æ‰€æœ‰æ³¨å†Œçš„beanå®ç°Lifecycleå’Œå½“å‰æ­£åœ¨è¿è¡Œã€‚ * ä»»ä½•å®ç°SmartLifecycle bean éƒ½å°†åœ¨å…¶â€œé˜¶æ®µâ€å†…åœæ­¢ï¼Œ * å¹¶ä¸”æ‰€æœ‰é˜¶æ®µéƒ½å°†ä»æœ€é«˜å€¼åˆ°æœ€ä½å€¼æ’åºã€‚ * æ‰€æœ‰æœªå®ç°SmartLifecycleå°†åœ¨é»˜è®¤é˜¶æ®µ 0 ä¸­åœæ­¢ã€‚ * å£°æ˜ä¸ºä¾èµ–å¦ä¸€ä¸ª bean çš„ bean å°†åœ¨ä¾èµ– bean ä¹‹å‰åœæ­¢ï¼Œæ— è®ºå£°æ˜çš„é˜¶æ®µå¦‚ä½•ã€‚ */@Overridepublic void stop() &#123; /*åœæ­¢æ‰€æœ‰çš„bean*/ stopBeans(); this.running = false;&#125; **stopBeans()** 1234567891011121314151617181920212223private void stopBeans() &#123; /*è¿™é‡Œå…¶å®å’Œå¯åŠ¨çš„æ—¶å€™çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ã€‚*/ Map&lt;String, Lifecycle&gt; lifecycleBeans = getLifecycleBeans(); Map&lt;Integer, LifecycleGroup&gt; phases = new HashMap&lt;&gt;(); lifecycleBeans.forEach((beanName, bean) -&gt; &#123; int shutdownPhase = getPhase(bean); LifecycleGroup group = phases.get(shutdownPhase); if (group == null) &#123; group = new LifecycleGroup(shutdownPhase, this.timeoutPerShutdownPhase, lifecycleBeans, false); phases.put(shutdownPhase, group); &#125; group.add(beanName, bean); &#125;); if (!phases.isEmpty()) &#123; List&lt;Integer&gt; keys = new ArrayList&lt;&gt;(phases.keySet()); /*æ³¨æ„è¿™é‡Œæ˜¯åå‘æ’åºï¼Œå¯åŠ¨çš„æ—¶å€™ 1 2 3 4 5 å…³é—­çš„æ—¶å€™å°±æ˜¯ 5 4 3 2 1*/ keys.sort(Collections.reverseOrder()); for (Integer key : keys) &#123; /*çœŸæ­£çš„æ ¸å¿ƒé€»è¾‘åœ¨è¿™é‡Œ*/ phases.get(key).stop(); &#125; &#125;&#125; **stop()** 123456789101112131415161718192021222324252627282930313233343536373839404142 public void stop() &#123; /*å¦‚æœä¸ºç©ºï¼Œè¯´æ˜æ²¡æœ‰å¿…è¦å¾€ä¸‹èµ°äº†ï¼Œç›´æ¥è¿”å›ã€‚*/ if (this.members.isEmpty()) &#123; return; &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Stopping beans in phase &quot; + this.phase); &#125; /*åå‘æ’åº*/ this.members.sort(Collections.reverseOrder()); /*å¹¶å‘å…³é—­smartLifeCycle*/ CountDownLatch latch = new CountDownLatch(this.smartMemberCount); /*ä¿å­˜å½“å‰æ­£å¤„äºå…³é—­ä¸­çš„smartLifeCycle*/ Set&lt;String&gt; countDownBeanNames = Collections.synchronizedSet(new LinkedHashSet&lt;&gt;()); /*all å¤„ç†å™¨*/ Set&lt;String&gt; lifecycleBeanNames = new HashSet&lt;&gt;(this.lifecycleBeans.keySet()); /*å¤„ç†æœ¬åˆ†ç»„å†…éœ€è¦å…³é—­çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨*/ for (LifecycleGroupMember member : this.members) &#123; if (lifecycleBeanNames.contains(member.name)) &#123; /*çœŸæ­£æ‰§è¡Œå…³é—­çš„é€»è¾‘*/ doStop(this.lifecycleBeans, member.name, latch, countDownBeanNames); &#125; else if (member.bean instanceof SmartLifecycle) &#123; // Already removed: must have been a dependent bean from another phase latch.countDown(); &#125; &#125; try &#123; /*å…³é—­ä¸»çº¿ç¨‹ä¼šåœ¨è¿™é‡Œç­‰å¾…æ‰€æœ‰å¼‚æ­¥å…³é—­çš„çº¿ç¨‹å…³é—­å®Œ*/ latch.await(this.timeout, TimeUnit.MILLISECONDS); if (latch.getCount() &gt; 0 &amp;&amp; !countDownBeanNames.isEmpty() &amp;&amp; logger.isInfoEnabled()) &#123; logger.info(&quot;Failed to shut down &quot; + countDownBeanNames.size() + &quot; bean&quot; + (countDownBeanNames.size() &gt; 1 ? &quot;s&quot; : &quot;&quot;) + &quot; with phase value &quot; + this.phase + &quot; within timeout of &quot; + this.timeout + &quot;ms: &quot; + countDownBeanNames); &#125; &#125; catch (InterruptedException ex) &#123; Thread.currentThread().interrupt(); &#125; &#125;&#125; **doStop()** 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354private void doStop(Map&lt;String, ? extends Lifecycle&gt; lifecycleBeans, final String beanName, final CountDownLatch latch, final Set&lt;String&gt; countDownBeanNames) &#123; /*å§è¦å…³é—­çš„å¤„ç†å™¨ä»å…¨å±€çš„é›†åˆç§»é™¤æ‰å¹¶è¿”å›*/ Lifecycle bean = lifecycleBeans.remove(beanName); if (bean != null) &#123; /*è·å–ä¾èµ–å½“å‰beançš„å¤„ç†å™¨*/ String[] dependentBeans = getBeanFactory().getDependentBeans(beanName); /*é€’å½’å…³é—­ä¾èµ–çš„bean*/ for (String dependentBean : dependentBeans) &#123; doStop(lifecycleBeans, dependentBean, latch, countDownBeanNames); &#125; try &#123; if (bean.isRunning()) &#123; if (bean instanceof SmartLifecycle) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Asking bean &#x27;&quot; + beanName + &quot;&#x27; of type [&quot; + bean.getClass().getName() + &quot;] to stop&quot;); &#125; /*å°†å½“å‰çš„å¤„ç†å™¨åæ·»åŠ åˆ°countDownBeanNameså†…ï¼Œè¿™ä¸ªé›†åˆè¡¨ç¤ºæ­£åœ¨å…³é—­çš„smart bean*/ countDownBeanNames.add(beanName); /*æ‰§è¡Œsmart beançš„å…³é—­é€»è¾‘ï¼Œçœ‹è¿™ä¸ªstopå¯ä»¥å¼‚æ­¥å…³é—­ï¼Œå›è°ƒï¼Œ999*/ ((SmartLifecycle) bean).stop(() -&gt; &#123; latch.countDown(); countDownBeanNames.remove(beanName); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Bean &#x27;&quot; + beanName + &quot;&#x27; completed its stop procedure&quot;); &#125; &#125;); &#125; else &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Stopping bean &#x27;&quot; + beanName + &quot;&#x27; of type [&quot; + bean.getClass().getName() + &quot;]&quot;); &#125; /*æ™®é€šç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨çš„å…³é—­é€»è¾‘*/ bean.stop(); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Successfully stopped bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; &#125; &#125; /*å¦‚æœæ˜¯å·²ç»å…³é—­çš„smart beanï¼Œç›´æ¥è·³è¿‡äº†ï¼Œç›¸å½“äº...*/ else if (bean instanceof SmartLifecycle) &#123; // Don&#x27;t wait for beans that aren&#x27;t running... latch.countDown(); &#125; &#125; catch (Throwable ex) &#123; if (logger.isWarnEnabled()) &#123; logger.warn(&quot;Failed to stop bean &#x27;&quot; + beanName + &quot;&#x27;&quot;, ex); &#125; &#125; &#125;&#125; 15.4 å‘å¸ƒå®¹å™¨åˆ›å»ºå®Œæˆäº‹ä»¶**publishEvent(new ContextRefreshedEvent(this))**\u0000 123456789101112131415161718192021222324252627282930protected void publishEvent(Object event, @Nullable ResolvableType eventType) &#123; Assert.notNull(event, &quot;Event must not be null&quot;); // Decorate event as an ApplicationEvent if necessary ApplicationEvent applicationEvent; if (event instanceof ApplicationEvent) &#123; applicationEvent = (ApplicationEvent) event; &#125; else &#123; applicationEvent = new PayloadApplicationEvent&lt;&gt;(this, event); if (eventType == null) &#123; eventType = ((PayloadApplicationEvent&lt;?&gt;) applicationEvent).getResolvableType(); &#125; &#125; // Multicast right now if possible - or lazily once the multicaster is initialized if (this.earlyApplicationEvents != null) &#123; this.earlyApplicationEvents.add(applicationEvent); &#125; else &#123; getApplicationEventMulticaster().multicastEvent(applicationEvent, eventType); &#125; // Publish event via parent context as well... if (this.parent != null) &#123; if (this.parent instanceof AbstractApplicationContext) &#123; ((AbstractApplicationContext) this.parent).publishEvent(event, eventType); &#125; else &#123; this.parent.publishEvent(event); &#125; &#125;&#125; 15.5 æ³¨å†Œå®¹å™¨ä¸Šä¸‹æ–‡**LiveBeansView.**_**registerApplicationContext**_**(this)**â€‹ 12345678910111213141516171819static void registerApplicationContext(ConfigurableApplicationContext applicationContext) &#123; String mbeanDomain = applicationContext.getEnvironment().getProperty(MBEAN_DOMAIN_PROPERTY_NAME); if (mbeanDomain != null) &#123; synchronized (applicationContexts) &#123; if (applicationContexts.isEmpty()) &#123; try &#123; MBeanServer server = ManagementFactory.getPlatformMBeanServer(); applicationName = applicationContext.getApplicationName(); server.registerMBean(new LiveBeansView(), new ObjectName(mbeanDomain, MBEAN_APPLICATION_KEY, applicationName)); &#125; catch (Throwable ex) &#123; throw new ApplicationContextException(&quot;Failed to register LiveBeansView MBean&quot;, ex); &#125; &#125; applicationContexts.add(applicationContext); &#125; &#125;&#125; \u0000è‡³æ­¤ï¼Œæ•´ä¸ª**refresh()**çš„ä¸»æµç¨‹å·²ç»å®Œæˆã€‚å¯¹äºåˆå§‹åŒ–æ‰€æœ‰çš„å•å®ä¾‹beanï¼Œæˆ‘å°†ä¼šåœ¨ä¸‹ä¸€ç¯‡å°½é‡åšä¸€ä¸ªå®Œæ•´çš„åˆ†æã€‚æ­¤å¤–é’ˆå¯¹AOPï¼Œäº‹åŠ¡ï¼Œä¸‰çº§ç¼“å­˜ä¸å¾ªç¯ä¾èµ–ï¼ŒåŠ è½½spring mvcçš„ç»„ä»¶ï¼Œwebç¯å¢ƒä¸‹ä¸€ä¸ªè¯·æ±‚çš„æ‰§è¡Œæµç¨‹ï¼Œæˆ‘éƒ½ä¼šåœ¨åç»­é€è¡Œåˆ†ææºä»£ç ï¼Œåšä¸€äº›å½’çº³æ€»ç»“ã€‚Springå‘å±•è‡³ä»Šï¼Œå·²ç»ä¸å•å•æ˜¯ä¸€ä¸ªJavaçš„æ¡†æ¶ï¼Œæ›´æ˜¯ä¸€ä¸ªç”Ÿæ€ã€‚","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"Spring[ä¸€]åˆå§‹åŒ–WEBç»„ä»¶","slug":"Spring/Spring[ä¸€]åˆå§‹åŒ–Webä¸‰å¤§ç»„ä»¶","date":"2022-01-11T05:58:37.923Z","updated":"2022-01-11T06:05:07.133Z","comments":true,"path":"2022/01/11/Spring/Spring[ä¸€]åˆå§‹åŒ–Webä¸‰å¤§ç»„ä»¶/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/Spring/Spring[%E4%B8%80]%E5%88%9D%E5%A7%8B%E5%8C%96Web%E4%B8%89%E5%A4%A7%E7%BB%84%E4%BB%B6/","excerpt":"","text":"SpringMVCæœ€åæ˜¯é€šè¿‡Tomcatæ¥è¿›è¡Œéƒ¨ç½²çš„ã€‚å½“åœ¨Servletä¸­è¿›è¡Œè¿›è¡Œåº”ç”¨éƒ¨ç½²æ—¶ï¼Œä¸»è¦æ­¥éª¤ä¸º:When a web application is deployed into a container, the following steps must be performed, in this order, before the web application begins processing client requests. Instantiate an instance of each event listener identified by a element in the deployment descriptor. For instantiated listener instances that implement ServletContextListener , call the contextInitialized() method. Instantiate an instance of each filter identified by a element in the deployment descriptor and call each filter instanceâ€™s init() method. Instantiate an instance of each servlet identified by a element that includes a element in the order defined by the load-on-startup element values, and call each servlet instanceâ€™s init() method. å½“åº”ç”¨éƒ¨ç½²åˆ°å®¹å™¨æ—¶ï¼Œåœ¨åº”ç”¨ç›¸åº”å®¢æˆ·çš„è¯·æ±‚ä¹‹å‰ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š åˆ›å»ºå¹¶åˆå§‹åŒ–ç”±å…ƒç´ æ ‡è®°çš„äº‹ä»¶ç›‘å¬å™¨ã€‚ å¯¹äºäº‹ä»¶ç›‘å¬å™¨ï¼Œå¦‚æœå®ç°äº†ServletContextListeneræ¥å£ï¼Œé‚£ä¹ˆè°ƒç”¨å…¶contextInitialized()æ–¹æ³•ã€‚ åˆ›å»ºå’Œåˆå§‹åŒ–ç”±å…ƒç´ æ ‡è®°çš„è¿‡æ»¤å™¨ï¼Œå¹¶è°ƒç”¨å…¶init()æ–¹æ³•ã€‚ æ ¹æ®ä¸­å®šä¹‰çš„é¡ºåºåˆ›å»ºå’Œåˆå§‹åŒ–ç”±å…ƒç´ æ ‡è®°çš„servletï¼Œå¹¶è°ƒç”¨å…¶init()æ–¹æ³•ã€‚æ‰€ä»¥åœ¨Tomcatä¸‹éƒ¨ç½²çš„åº”ç”¨ï¼Œä¼šå…ˆåˆå§‹åŒ–listenerï¼Œç„¶ååˆå§‹åŒ–filterï¼Œæœ€ååˆå§‹åŒ–servletã€‚ ç°åœ¨æ ¹æ®é…ç½®æ–‡ä»¶å’ŒOracleæ‰€è¯´çš„åˆå§‹åŒ–æµç¨‹åˆ†æä¸€ä¸‹ï¼ŒSpringMVCæ˜¯å¦‚ä½•æ¥ä¸€æ­¥æ­¥å¯åŠ¨å®¹å™¨ï¼Œå¹¶åŠ è½½ç›¸å…³ä¿¡æ¯çš„ã€‚ é…ç½®æ–‡ä»¶12345678910111213141516171819202122232425262728293031323334353637383940414243444546&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;web-app xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot; version=&quot;3.1&quot;&gt; &lt;!--å‘Šè¯‰åŠ è½½å™¨ï¼Œå»è¿™ä¸ªä½ç½®å»åŠ è½½springçš„ç›¸å…³é…ç½®--&gt; &lt;context-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;classpath:spring-mvc.xml&lt;/param-value&gt; &lt;/context-param&gt; &lt;!--é…ç½®å‰ç«¯æ§åˆ¶å™¨--&gt; &lt;servlet&gt; &lt;servlet-name&gt;springMvc&lt;/servlet-name&gt; &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt; &lt;!--SpringMVCé…ç½®æ–‡ä»¶--&gt; &lt;init-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;classpath:spring-mvc.xml&lt;/param-value&gt; &lt;/init-param&gt; &lt;load-on-startup&gt;0&lt;/load-on-startup&gt; &lt;/servlet&gt; &lt;servlet-mapping&gt; &lt;servlet-name&gt;springMvc&lt;/servlet-name&gt; &lt;url-pattern&gt;/&lt;/url-pattern&gt; &lt;/servlet-mapping&gt; &lt;listener&gt; &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt; &lt;/listener&gt; &lt;!--è§£å†³ä¹±ç é—®é¢˜çš„filter--&gt; &lt;filter&gt; &lt;filter-name&gt;CharacterEncodingFilter&lt;/filter-name&gt; &lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt; &lt;init-param&gt; &lt;param-name&gt;encoding&lt;/param-name&gt; &lt;param-value&gt;utf-8&lt;/param-value&gt; &lt;/init-param&gt; &lt;/filter&gt; &lt;filter-mapping&gt; &lt;filter-name&gt;CharacterEncodingFilter&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt; &lt;/filter-mapping&gt;&lt;/web-app&gt; 1.åˆå§‹åŒ–Listeneræˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶å®šä¹‰çš„Listenerç±»æ˜¯ContextLoaderListener. ç»§æ‰¿å…³ç³»ï¼šContextLoaderListener ç±»ç»§æ‰¿äº† ContextLoader ç±»å¹¶ä¸”å®ç°äº† ServletContextListener æ¥å£ï¼ŒæŒ‰ç…§å¯åŠ¨ç¨‹åºï¼Œä¼šè°ƒç”¨å…¶ contextInitialized() æ–¹æ³•ã€‚ 123456789/** * è¿™ä¸ªæ–¹æ³•ï¼šåˆå§‹åŒ–åº”ç”¨ä¸Šä¸‹æ–‡ * @param event */@Overridepublic void contextInitialized(ServletContextEvent event) &#123; //è¿™é‡Œå°±è¿›å…¥äº†åˆå§‹åŒ–webå®¹å™¨çš„æ ¸å¿ƒ initWebApplicationContext(event.getServletContext());&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475/** * åˆå§‹åŒ–webåº”ç”¨çš„ä¸Šä¸‹æ–‡ * ServletContextå®˜æ–¹å«servletä¸Šä¸‹æ–‡ã€‚æœåŠ¡å™¨ä¼šä¸ºæ¯ä¸€ä¸ªå·¥ç¨‹åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯ServletContextå¯¹è±¡ã€‚ * è¿™ä¸ªå¯¹è±¡å…¨å±€å”¯ä¸€ï¼Œè€Œä¸”å·¥ç¨‹å†…éƒ¨çš„æ‰€æœ‰servletéƒ½å…±äº«è¿™ä¸ªå¯¹è±¡ã€‚æ‰€ä»¥å«å…¨å±€åº”ç”¨ç¨‹åºå…±äº«å¯¹è±¡ã€‚ * @param servletContext servlet ä¸Šä¸‹æ–‡ * @return */public WebApplicationContext initWebApplicationContext(ServletContext servletContext) &#123; /* * é¦–å…ˆé€šè¿‡ WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE è¿™ä¸ªStringç±»å‹çš„é™æ€å˜é‡è·å–ä¸€ä¸ªRoot ioc å®¹å™¨ï¼Œ * æ ¹æ® ioc å®¹å™¨ä½œä¸ºå…¨å±€å˜é‡å­˜å‚¨åœ¨ application å¯¹è±¡ä¸­ï¼Œå¦‚æœå­˜åœ¨åˆ™æœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ª * * å¦‚æœåœ¨åˆå§‹åŒ– Root WebApplicationContext å³ï¼Œ Root ioc å®¹å™¨çš„æ—¶å€™å‘ç°å·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œ * å› æ­¤web.xmlä¸­åªå…è®¸å­˜åœ¨ä¸€ä¸ªContextLoaderç±»æˆ–å…¶å­ç±»å¯¹è±¡ã€‚ * */ if (servletContext.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE) != null) &#123; throw new IllegalStateException( &quot;Cannot initialize context because there is already a root application context present - &quot; + &quot;check whether you have multiple ContextLoader* definitions in your web.xml!&quot;); &#125; servletContext.log(&quot;Initializing Spring root WebApplicationContext&quot;); Log logger = LogFactory.getLog(ContextLoader.class); if (logger.isInfoEnabled()) &#123; logger.info(&quot;Root WebApplicationContext: initialization started&quot;); &#125; long startTime = System.currentTimeMillis(); try &#123; /*å¦‚æœcontextä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿›è¡Œåˆ›å»º*/ if (this.context == null) &#123; /*step into*/ this.context = createWebApplicationContext(servletContext); &#125; if (this.context instanceof ConfigurableWebApplicationContext) &#123; ConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) this.context; if (!cwac.isActive()) &#123; // The context has not yet been refreshed -&gt; provide services such as // setting the parent context, setting the application context id, etc if (cwac.getParent() == null) &#123; // The context instance was injected without an explicit parent -&gt; // determine parent for root web application context, if any. ApplicationContext parent = loadParentContext(servletContext); cwac.setParent(parent); &#125; /*é…ç½®å¹¶åˆ·æ–°åº”ç”¨çš„root ioc å®¹å™¨ï¼Œè¿™é‡Œä¼šè¿›è¡Œbeançš„åˆ›å»ºå’Œåˆå§‹åŒ–å·¥ä½œï¼Œ * è¿™é‡Œæœ€ç»ˆä¼šè°ƒç”¨ AbstractApplicationContextçš„refreshæ–¹æ³•ã€‚ * å¹¶ä¸”iocå®¹å™¨ä¸­çš„beanç±»ä¼šè¢«æ”¾åœ¨applicationä¸­ã€‚*/ configureAndRefreshWebApplicationContext(cwac, servletContext); &#125; &#125; //ä»¥å±æ€§çš„é…ç½®æ–¹å¼å°†applicationé…ç½®servletContextä¸­ï¼Œå› ä¸ºservletContextæ˜¯æ•´ä¸ªåº”ç”¨å”¯ä¸€çš„ï¼Œæ‰€ä»¥å¯ä»¥æ ¹æ®keyå€¼è·å–åˆ°applicationï¼Œä»è€Œèƒ½å¤Ÿè·å–åˆ°åº”ç”¨çš„æ‰€æœ‰ä¿¡æ¯ servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, this.context); ClassLoader ccl = Thread.currentThread().getContextClassLoader(); if (ccl == ContextLoader.class.getClassLoader()) &#123; currentContext = this.context; &#125; else if (ccl != null) &#123; currentContextPerThread.put(ccl, this.context); &#125; if (logger.isInfoEnabled()) &#123; long elapsedTime = System.currentTimeMillis() - startTime; logger.info(&quot;Root WebApplicationContext initialized in &quot; + elapsedTime + &quot; ms&quot;); &#125; return this.context; &#125; catch (RuntimeException | Error ex) &#123; logger.error(&quot;Context initialization failed&quot;, ex); servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, ex); throw ex; &#125;&#125; 1234567891011121314151617181920212223242526272829303132333435protected void configureAndRefreshWebApplicationContext(ConfigurableWebApplicationContext wac, ServletContext sc) &#123; if (ObjectUtils.identityToString(wac).equals(wac.getId())) &#123; // The application context id is still set to its original default value // -&gt; assign a more useful id based on available information String idParam = sc.getInitParameter(CONTEXT_ID_PARAM); if (idParam != null) &#123; wac.setId(idParam); &#125; else &#123; // Generate default id... wac.setId(ConfigurableWebApplicationContext.APPLICATION_CONTEXT_ID_PREFIX + ObjectUtils.getDisplayString(sc.getContextPath())); &#125; &#125; //å°†ServletContextè®¾ç½®åˆ°applicationçš„å±æ€§ä¸­ wac.setServletContext(sc); //è·å–web.xmlä¸­é…ç½®çš„contextConfigLocationå‚æ•°å€¼ String configLocationParam = sc.getInitParameter(CONFIG_LOCATION_PARAM); if (configLocationParam != null) &#123; wac.setConfigLocation(configLocationParam); &#125; // The wac environment&#x27;s #initPropertySources will be called in any case when the context // is refreshed; do it eagerly here to ensure servlet property sources are in place for // use in any post-processing or initialization that occurs below prior to #refresh ConfigurableEnvironment env = wac.getEnvironment(); if (env instanceof ConfigurableWebEnvironment) &#123; ((ConfigurableWebEnvironment) env).initPropertySources(sc, null); &#125; customizeContext(sc, wac); //è°ƒç”¨åº”ç”¨çš„refreshæ–¹æ³•ï¼Œè¿›è¡ŒIOCå®¹å™¨çš„è£…è½½ wac.refresh();&#125; æ€è€ƒä¸æ²‰æ·€æˆ‘ä»¬åœ¨web.xmlé…ç½®æ–‡ä»¶å®šä¹‰çš„Listenerç±»æ˜¯ContextLoaderListenerç±».ç»§æ‰¿å…³ç³»ï¼šContextLoaderListener ç±»ç»§æ‰¿äº† ContextLoader ç±»å¹¶ä¸”å®ç°äº† ServletContextListener æ¥å£ï¼ŒæŒ‰ç…§å¯åŠ¨ç¨‹åºï¼Œä¼šè°ƒç”¨å…¶ contextInitialized() æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯è°ƒç”¨äº†initWebApplicationContext()æ¥åˆå§‹åŒ–webåº”ç”¨çš„ä¸Šä¸‹æ–‡ï¼Œå†é€šè¿‡configureAndRefreshWebApplicationContext()åŠ è½½web.xmlé‡Œé¢æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼Œç„¶åè°ƒç”¨iocå®¹å™¨çš„åˆ·æ–°æ–¹æ³•ã€‚ 2.åˆå§‹åŒ–Filteråœ¨å®Œæˆäº†å¯¹äº listener çš„åˆå§‹åŒ–æ“ä½œä»¥åï¼Œä¼šè¿›è¡Œ filter çš„åˆ›å»ºå’Œåˆå§‹åŒ–æ“ä½œã€‚æˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ CharacterEncodingFilter ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„å…·ä½“ç±»å›¾ä¿¡æ¯ ctrl+Hã€‚ å› ä¸ºå…¶å®ç°äº† Filter æ¥å£ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨å…¶å¯¹åº”çš„ init(FilterConfig filterConfig) æ–¹æ³•ã€‚åœ¨å…¶çˆ¶ç±» GenericFilterBean ä¸­æœ‰è¯¥æ–¹æ³•çš„å®ç°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142/** * filterçš„åˆå§‹åŒ–æ–¹æ³• * @param filterConfig * @throws ServletException */@Overridepublic final void init(FilterConfig filterConfig) throws ServletException &#123; Assert.notNull(filterConfig, &quot;FilterConfig must not be null&quot;); this.filterConfig = filterConfig; // å°†è®¾ç½®çš„åˆå§‹åŒ–å‚æ•°ä¿¡æ¯è®¾ç½®åˆ°pvsä¸­ PropertyValues pvs = new FilterConfigPropertyValues(filterConfig, this.requiredProperties); if (!pvs.isEmpty()) &#123; try &#123; //å°†å…·ä½“çš„filterç±»è¿›è¡ŒåŒ…è£… BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(this); //åˆ›å»ºå¯¹åº”çš„èµ„æºåŠ è½½å™¨ ResourceLoader resourceLoader = new ServletContextResourceLoader(filterConfig.getServletContext()); Environment env = this.environment; if (env == null) &#123; env = new StandardServletEnvironment(); &#125; bw.registerCustomEditor(Resource.class, new ResourceEditor(resourceLoader, env)); initBeanWrapper(bw); bw.setPropertyValues(pvs, true); &#125; catch (BeansException ex) &#123; String msg = &quot;Failed to set bean properties on filter &#x27;&quot; + filterConfig.getFilterName() + &quot;&#x27;: &quot; + ex.getMessage(); logger.error(msg, ex); throw new NestedServletException(msg, ex); &#125; &#125; // äº¤ç»™å­ç±»å®ç° initFilterBean(); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Filter &#x27;&quot; + filterConfig.getFilterName() + &quot;&#x27; configured for use&quot;); &#125;&#125; 123protected void initFilterBean() throws ServletException &#123; //è¿™é‡Œå¹¶æœªè¿›è¡Œä»»ä½•çš„åˆå§‹åŒ–æ“ä½œã€‚å…¶å®Filterçš„ä¸»è¦ä½œç”¨è¿˜æ˜¯åœ¨æœ‰è¯·æ±‚è¿‡æ¥æ—¶ï¼Œè¿›è¡Œçš„ doFilter() ä¸­çš„å¤„ç†ï¼Œåœ¨å¯åŠ¨é˜¶æ®µï¼Œå¤„ç†æ¯”è¾ƒå°‘ã€‚&#125; æ€è€ƒä¸æ²‰æ·€åœ¨å®Œæˆäº†å¯¹äº listener çš„åˆå§‹åŒ–æ“ä½œä»¥åï¼Œä¼šè¿›è¡Œ filter çš„åˆ›å»ºå’Œåˆå§‹åŒ–æ“ä½œã€‚é€šå¸¸åœ¨web.xmlæ–‡ä»¶é…ç½®çš„æ˜¯ï¼šCharacterEncodingFilter ã€‚é€šè¿‡è¿™ä¸ªç±»çš„ç»§æ‰¿å…³ç³»ï¼Œå†ç»“åˆå®é™…æºç åˆ†æï¼šå› ä¸ºå…¶å®ç°äº† Filter æ¥å£ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨å…¶å¯¹åº”çš„ init(FilterConfig filterConfig) æ–¹æ³•ã€‚åœ¨å…¶çˆ¶ç±» GenericFilterBean ä¸­æœ‰è¯¥æ–¹æ³•çš„å®ç°ã€‚ç„¶ååˆäº¤ç»™äº†å­ç±»ï¼Œä½†æ˜¯å®é™…ä¸Šå•¥ä¹Ÿæ²¡åšï¼Œå…¶å®Filterçš„ä¸»è¦ä½œç”¨è¿˜æ˜¯åœ¨æœ‰è¯·æ±‚è¿‡æ¥æ—¶ï¼Œè¿›è¡Œçš„ doFilter() ä¸­çš„å¤„ç†ï¼Œåœ¨å¯åŠ¨é˜¶æ®µï¼Œå¤„ç†æ¯”è¾ƒå°‘ã€‚ 3.åˆå§‹åŒ–Servletwebåº”ç”¨å¯åŠ¨çš„æœ€åä¸€ä¸ªæ­¥éª¤å°±æ˜¯åˆ›å»ºå’Œåˆå§‹åŒ– Servlet ï¼Œæˆ‘ä»¬å°±ä»æˆ‘ä»¬ä½¿ç”¨çš„ DispatcherServlet è¿™ä¸ªç±»æ¥è¿›è¡Œåˆ†æï¼Œè¿™ä¸ªç±»æ˜¯å‰ç«¯æ§åˆ¶å™¨ï¼Œä¸»è¦ç”¨äºåˆ†å‘ç”¨æˆ·è¯·æ±‚åˆ°å…·ä½“çš„å®ç°ç±»ï¼Œå¹¶è¿”å›å…·ä½“çš„å“åº”ä¿¡æ¯ã€‚ è¿™é‡Œé¢æœ‰ä¸€ä¸ªçœ‹æºç çš„æŠ€å·§ï¼Œå½“åˆ†æåˆ°æŸä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œä¸çŸ¥é“å¦‚ä½•å†å¾€ä¸‹åˆ†æäº†ï¼Œä¹Ÿå°±æ˜¯ç¼ºå°‘ç›¸åº”çš„æŠ“æ‰‹ï¼Œæ€ä¹ˆåŠï¼Ÿ 1.çœ‹ç±»çš„ç»§æ‰¿å…³ç³»ï¼Œä»ç±»çš„ç»§æ‰¿å…³ç³»è§¦å‘ï¼Œå¯»æ‰¾ç›¸åº”çš„æ–¹æ³• 2.çœ‹åˆå§‹åŒ–è¿™ç§çš„æ–¹æ³• ctrl+H æŸ¥çœ‹ç±»çš„ç»§æ‰¿å…³ç³»ï¼ŒDispatcherServlet å®ç°äº†Servlet æ¥å£ï¼Œæ‰€ä»¥æŒ‰ç…§åŠ è½½è¿‡ç¨‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨å…¶ init(ServletConfig config)æ–¹æ³•ã€‚ä»DispatcherServletä¸­å¯»æ‰¾initæ–¹æ³•å‘ç°æ²¡æœ‰ï¼Œè¿™ä¸ªæ—¶å€™æ€ä¹ˆåŠï¼ŸæŒ‰ç…§ç±»çš„ç»§æ‰¿å…³ç³»ï¼Œé€æ­¥å‘ä¸Šå¯»æ‰¾ã€‚æœ€ç»ˆå®šä½åˆ° GenericServlet ä¸­ï¼Œä½†æ˜¯è¿™é‡Œä»€ä¹ˆä¹Ÿæ²¡æœ‰åšï¼Œåªæ˜¯äº¤ç»™äº†å­ç±»å»å®ç°ï¼Œé‚£å°±ç»§ç»­å¯»æ‰¾ï¼Œæœ€ç»ˆå®šä½åˆ°æŠ“æ‰‹ï¼šHttpServletBeanã€‚ 123456789101112131415161718192021222324252627282930313233/** * è¿™ä¸ªæ–¹æ³•å‡ ä¹æ˜¯web-iocå®¹å™¨çš„æ ¸å¿ƒå…¥å£ * å½“å‰ç±»æ˜¯DispatcherServletçš„çˆ·çˆ·ç±» * åŠ è½½DispatcherServletçš„æ—¶å€™ï¼Œä»–çš„çˆ·çˆ·ç±»ä¼šå…ˆåŠ è½½çš„å¹¶ä¸” initæ–¹æ³•ä¼šæ‰§è¡Œ * @throws ServletException */@Overridepublic final void init() throws ServletException &#123; // è®¾ç½®å±æ€§ä¿¡æ¯ PropertyValues pvs = new ServletConfigPropertyValues(getServletConfig(), this.requiredProperties); if (!pvs.isEmpty()) &#123; try &#123; //ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼ï¼Œå¯¹å…·ä½“çš„å®ç°ç±»è¿›è¡Œä¸€ä¸ªåŒ…è£… BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(this); ResourceLoader resourceLoader = new ServletContextResourceLoader(getServletContext()); bw.registerCustomEditor(Resource.class, new ResourceEditor(resourceLoader, getEnvironment())); //å°†web.xmlé‡Œé¢çš„å±æ€§ä¿¡æ¯è®¾ç½®åˆ° bw é‡Œé¢ã€‚ initBeanWrapper(bw); bw.setPropertyValues(pvs, true); &#125; catch (BeansException ex) &#123; if (logger.isErrorEnabled()) &#123; logger.error(&quot;Failed to set bean properties on servlet &#x27;&quot; + getServletName() + &quot;&#x27;&quot;, ex); &#125; throw ex; &#125; &#125; // Let subclasses do whatever initialization they like. //äº¤ç»™å­ç±»æ¥å®ç° initServletBean();&#125; æ¥åˆ°å­ç±»ï¼šFrameworkServletã€‚ 12345678910111213141516171819202122232425262728293031@Overrideprotected final void initServletBean() throws ServletException &#123; getServletContext().log(&quot;Initializing Spring &quot; + getClass().getSimpleName() + &quot; &#x27;&quot; + getServletName() + &quot;&#x27;&quot;); if (logger.isInfoEnabled()) &#123; logger.info(&quot;Initializing Servlet &#x27;&quot; + getServletName() + &quot;&#x27;&quot;); &#125; long startTime = System.currentTimeMillis(); try &#123; //åˆå§‹åŒ–webåº”ç”¨å®¹å™¨ this.webApplicationContext = initWebApplicationContext(); //åˆå§‹åŒ–æ¡†æ¶servlet initFrameworkServlet(); &#125; catch (ServletException | RuntimeException ex) &#123; logger.error(&quot;Context initialization failed&quot;, ex); throw ex; &#125; if (logger.isDebugEnabled()) &#123; String value = this.enableLoggingRequestDetails ? &quot;shown which may lead to unsafe logging of potentially sensitive data&quot; : &quot;masked to prevent unsafe logging of potentially sensitive data&quot;; logger.debug(&quot;enableLoggingRequestDetails=&#x27;&quot; + this.enableLoggingRequestDetails + &quot;&#x27;: request parameters and headers will be &quot; + value); &#125; if (logger.isInfoEnabled()) &#123; logger.info(&quot;Completed initialization in &quot; + (System.currentTimeMillis() - startTime) + &quot; ms&quot;); &#125;&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061/** * è¿™é‡Œä¸»è¦æ˜¯è¿›è¡Œäº†webåº”ç”¨å®¹å™¨ä¸Šä¸‹æ–‡çš„åˆ›å»ºï¼Œå¹¶è¿›è¡Œäº†åˆå§‹åŒ–å·¥ä½œã€‚ * è·Ÿè¸ªä¸€ä¸‹åˆå§‹åŒ–çš„å…·ä½“æµç¨‹ * @return */protected WebApplicationContext initWebApplicationContext() &#123; //è·å–åˆ° root ioc å®¹å™¨ WebApplicationContext rootContext = WebApplicationContextUtils.getWebApplicationContext(getServletContext()); WebApplicationContext wac = null; if (this.webApplicationContext != null) &#123; // A context instance was injected at construction time -&gt; use it wac = this.webApplicationContext; if (wac instanceof ConfigurableWebApplicationContext) &#123; ConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) wac; if (!cwac.isActive()) &#123; // The context has not yet been refreshed -&gt; provide services such as // setting the parent context, setting the application context id, etc if (cwac.getParent() == null) &#123; //å°† root ioc å®¹å™¨è®¾ç½®æˆ servlet çš„iocå®¹å™¨çš„çˆ¶ç±» //å¦‚æœå½“å‰servletå­˜åœ¨ä¸€ä¸ª WebApplicationContext å³ï¼šå­IOCå®¹å™¨ //å¹¶ä¸”ä¸Šä¸‹æ–‡è·å–çš„root ioc å®¹å™¨å­˜åœ¨ï¼Œåˆ™å°†root ioc å®¹å™¨ä½œä¸ºå­ ioc å®¹å™¨çš„çˆ¶å®¹å™¨ cwac.setParent(rootContext); &#125; //é…ç½®å¹¶åˆ·æ–°å­å®¹å™¨ï¼ŒåŠ è½½å­å®¹å™¨ä¸­å¯¹åº”çš„beanå®ä½“ç±» configureAndRefreshWebApplicationContext(cwac); &#125; &#125; &#125; //å¦‚æœå½“å‰servletä¸­ä¸å­˜åœ¨å­iocå®¹å™¨ï¼Œåˆ™å»æŸ¥æ‰¾ if (wac == null) &#123; // No context instance was injected at construction time -&gt; see if one // has been registered in the servlet context. If one exists, it is assumed // that the parent context (if any) has already been set and that the // user has performed any initialization such as setting the context id wac = findWebApplicationContext(); &#125; if (wac == null) &#123; // No context instance is defined for this servlet -&gt; create a local one //å¦‚æœæŸ¥æ‰¾ä¸åˆ°ï¼Œå°±å»åˆ›å»ºä¸€ä¸ª wac = createWebApplicationContext(rootContext); &#125; if (!this.refreshEventReceived) &#123; // Either the context is not a ConfigurableApplicationContext with refresh // support or the context injected at construction time had already been // refreshed -&gt; trigger initial onRefresh manually here. synchronized (this.onRefreshMonitor) &#123; onRefresh(wac); &#125; &#125; if (this.publishContext) &#123; // Publish the context as a servlet context attribute. String attrName = getServletContextAttributeName(); getServletContext().setAttribute(attrName, wac); &#125; return wac;&#125; 12345678910111213141516171819202122232425protected WebApplicationContext createWebApplicationContext(@Nullable ApplicationContext parent) &#123; Class&lt;?&gt; contextClass = getContextClass(); if (!ConfigurableWebApplicationContext.class.isAssignableFrom(contextClass)) &#123; throw new ApplicationContextException( &quot;Fatal initialization error in servlet with name &#x27;&quot; + getServletName() + &quot;&#x27;: custom WebApplicationContext class [&quot; + contextClass.getName() + &quot;] is not of type ConfigurableWebApplicationContext&quot;); &#125; //æ ¹æ®ç±»ä¿¡æ¯åˆå§‹åŒ–ä¸€ä¸ªConfigurableWebApplicationContextå¯¹è±¡ ConfigurableWebApplicationContext wac = (ConfigurableWebApplicationContext) BeanUtils.instantiateClass(contextClass); //è®¾ç½®webä¸Šä¸‹æ–‡ç¯å¢ƒä¿¡æ¯ wac.setEnvironment(getEnvironment()); //è®¾ç½®å…¶çˆ¶ç±»ä¸ºroot ioc å®¹å™¨ï¼Œroot ioc å®¹å™¨æ˜¯æ•´ä¸ªåº”ç”¨å”¯ä¸€çš„ã€‚ wac.setParent(parent); //è®¾ç½®å…¶å…·ä½“çš„é…ç½®ä¿¡æ¯çš„ä½ç½®ï¼Œè¿™é‡Œæ˜¯ classpath:spring-mvc.xml String configLocation = getContextConfigLocation(); if (configLocation != null) &#123; wac.setConfigLocation(configLocation); &#125; //é…ç½®å¹¶åˆ·æ–°webåº”ç”¨çš„iocå®¹å™¨ configureAndRefreshWebApplicationContext(wac); return wac;&#125; 123456789101112131415161718192021222324252627282930313233343536protected void configureAndRefreshWebApplicationContext(ConfigurableWebApplicationContext wac) &#123; if (ObjectUtils.identityToString(wac).equals(wac.getId())) &#123; // The application context id is still set to its original default value // -&gt; assign a more useful id based on available information if (this.contextId != null) &#123; wac.setId(this.contextId); &#125; else &#123; // Generate default id... wac.setId(ConfigurableWebApplicationContext.APPLICATION_CONTEXT_ID_PREFIX + ObjectUtils.getDisplayString(getServletContext().getContextPath()) + &#x27;/&#x27; + getServletName()); &#125; &#125; //é…ç½®å®¹å™¨çš„ç›¸å…³ä¿¡æ¯ wac.setServletContext(getServletContext()); wac.setServletConfig(getServletConfig()); wac.setNamespace(getNamespace()); //é…ç½®å®¹å™¨åº”ç”¨åŠ è½½çš„ç›‘å¬å™¨ wac.addApplicationListener(new SourceFilteringListener(wac, new ContextRefreshListener())); // The wac environment&#x27;s #initPropertySources will be called in any case when the context // is refreshed; do it eagerly here to ensure servlet property sources are in place for // use in any post-processing or initialization that occurs below prior to #refresh ConfigurableEnvironment env = wac.getEnvironment(); if (env instanceof ConfigurableWebEnvironment) &#123; ((ConfigurableWebEnvironment) env).initPropertySources(getServletContext(), getServletConfig()); &#125; postProcessWebApplicationContext(wac); //åº”ç”¨åˆå§‹åŒ–ä¿¡æ¯ applyInitializers(wac); //åˆ·æ–°åŠ è½½é‡Œé¢çš„beanå®ä½“ç±» wac.refresh();&#125; è¿™é‡Œå…¶å®å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªå…¶å®ä¸»è¦æ˜¯æ ¹æ®é…ç½®æ–‡ä»¶ä¿¡æ¯è¿›è¡Œç±»åŠ è½½çš„å·¥ä½œï¼Œå¹¶ä¸”é…ç½®äº†ä¸€ä¸ªå®¹å™¨åŠ è½½ä¿¡æ¯çš„ç›‘å¬å™¨ SourceFilteringListenerã€‚åœ¨æœ€åé€šè¿‡ refresh æ–¹æ³•è¿›è¡Œäº†å®¹å™¨ä¸­å®ä½“ç±»çš„åŠ è½½è¿‡ç¨‹ã€‚è¿™ä¸ªrefreshæ–¹æ³•å’Œæˆ‘ä»¬åœ¨listenerä¸­å®ç°ç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªæ–¹æ³•ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œåœ¨æˆ‘ä»¬åº”ç”¨ä¸­é…ç½®çš„æ‰€æœ‰çš„ç±»éƒ½èƒ½å¤Ÿæ‰«æåˆ°ï¼Œå¹¶ä¸”é…ç½®äº†æˆ‘ä»¬çš„iocå®¹å™¨ä¸­ã€‚å› ä¸ºæˆ‘ä»¬é…ç½®äº†ç›¸å…³çš„å®¹å™¨åŠ è½½çš„ç›‘å¬å™¨ï¼Œåœ¨refreshæ–¹æ³•ä¸­è°ƒç”¨äº† finishRefresh æ–¹æ³•æ—¶ï¼Œå‘é€å¯¹åº”çš„å®¹å™¨åŠ è½½å®Œæˆå¹¿æ’­ä¿¡æ¯ï¼Œä»è€Œèƒ½å¤Ÿè°ƒç”¨æˆ‘ä»¬æ‰€æ³¨å†Œçš„ç›‘å¬å™¨ SourceFilteringListenerã€‚çœ‹ä¸€ä¸‹é‡Œé¢çš„é€»è¾‘~ 12345678protected void onApplicationEventInternal(ApplicationEvent event) &#123; if (this.delegate == null) &#123; throw new IllegalStateException( &quot;Must specify a delegate object or override the onApplicationEventInternal method&quot;); &#125; //è¿™é‡Œçš„delegateï¼Œæ˜¯ä¼ å…¥çš„å…·ä½“çš„ä»£ç†ç±»ï¼Œæ‰€ä»¥åœ¨æ­¤å›åˆ°äº†æˆ‘ä»¬çš„FrameworkServlet this.delegate.onApplicationEvent(event);&#125; 1234567891011public void onApplicationEvent(ContextRefreshedEvent event) &#123; this.refreshEventReceived = true; synchronized (this.onRefreshMonitor) &#123; //æœ€ç»ˆè°ƒç”¨äº†FrameworkServletçš„onApplicationEventæ–¹æ³• onRefresh(event.getApplicationContext()); &#125;&#125;protected void onRefresh(ApplicationContext context) &#123; // åˆæ˜¯ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œäº¤ç»™å­ç±»å»å®ç°&#125; ç»ˆäºæ¥åˆ°äº†æˆ‘ä»¬çš„DispatcherServletã€‚ 12345@Overrideprotected void onRefresh(ApplicationContext context) &#123; //é€šè¿‡é‡å†™çˆ¶ç±»çš„æ‰©å±•ç‚¹æ¥åˆ°è¿™é‡Œ initStrategies(context);&#125; 123456789101112131415161718192021222324252627282930/** * åˆå§‹åŒ–servletä½¿ç”¨çš„ç­–ç•¥ä¿¡æ¯ï¼Œå­ç±»å¯ä»¥é€šè¿‡è¦†å†™è¯¥æ–¹æ³•ç±»å¢åŠ æ›´å¤šçš„å‘ƒç­–ç•¥æ–¹æ³• * Initialize the strategy objects that this servlet uses. * &lt;p&gt;May be overridden in subclasses in order to initialize further strategy objects. */protected void initStrategies(ApplicationContext context) &#123; //åˆå§‹åŒ–MultipartResolver,å¯ä»¥æ”¯æŒæ–‡ä»¶çš„ä¸Šä¼  initMultipartResolver(context); //åˆå§‹åŒ–æœ¬åœ°è§£æå™¨ initLocaleResolver(context); //åˆå§‹åŒ–ä¸»é¢˜è§£æå™¨ initThemeResolver(context); //å¤„ç†å™¨æ˜ å°„å™¨ï¼Œå°†è¯·æ±‚å’Œæ–¹æ³•è¿›è¡Œæ˜ å°„å…³è” initHandlerMappings(context); //å¤„ç†å™¨é€‚é…å™¨ initHandlerAdapters(context); //å¤„ç†å™¨å¼‚å¸¸è§£æå™¨ initHandlerExceptionResolvers(context); //ä»è¯·æ±‚åˆ°è§†å›¾åçš„è½¬æ¢å™¨ initRequestToViewNameTranslator(context); //è§†å›¾è§£æå™¨ initViewResolvers(context); //FlashMapç®¡ç†å™¨ initFlashMapManager(context); /* * å¯ä»¥çœ‹åˆ°é‡Œé¢ä¸»è¦æ˜¯åˆå§‹åŒ–äº†æˆ‘ä»¬çš„æ‰€ä½¿ç”¨åˆ°çš„ä¸€äº›è§£æå™¨å’Œå¤„ç†å™¨ç­‰ã€‚ * å½“æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°±å¯ä»¥æ ¹æ®è¿™äº›è§£æå™¨æ¥è¿›è¡Œè¯·æ±‚çš„è§£æå¤„ç†ã€æ–¹æ³•çš„è°ƒç”¨ã€å¼‚å¸¸çš„å¤„ç†ç­‰ç­‰ã€‚ * åˆ°æ­¤ä¸ºæ­¢ï¼ŒServletçš„åˆå§‹åŒ–å·¥ä½œå°±æ•´ä¸ªå®Œæˆäº†ã€‚æƒ³å½“çš„å¤æ‚ï¼Œä¸»è¦æ˜¯å°†å¾ˆå¤šçš„æ–¹æ³•å®ç°åœ¨çˆ¶ç±»ä¸­è¿›è¡Œäº†å¤„ç†ã€‚å±‚çº§æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦ä¸€ç‚¹ç‚¹è·Ÿè¸ªåˆ†æã€‚ */&#125; æ€è€ƒä¸æ²‰æ·€webåº”ç”¨å¯åŠ¨çš„æœ€åä¸€ä¸ªæ­¥éª¤å°±æ˜¯åˆ›å»ºå’Œåˆå§‹åŒ– Servlet ï¼Œæˆ‘ä»¬å°±ä»æˆ‘ä»¬ä½¿ç”¨çš„ DispatcherServlet è¿™ä¸ªç±»æ¥è¿›è¡Œåˆ†æï¼Œè¿™ä¸ªç±»æ˜¯å‰ç«¯æ§åˆ¶å™¨ï¼Œä¸»è¦ç”¨äºåˆ†å‘ç”¨æˆ·è¯·æ±‚åˆ°å…·ä½“çš„å®ç°ç±»ï¼Œå¹¶è¿”å›å…·ä½“çš„å“åº”ä¿¡æ¯ã€‚çœ‹è¿™ä¸ªç±»çš„ç»§æ‰¿å…³ç³»ï¼šåœ¨HttpServletï¼ˆä»–çš„çˆ·çˆ·ç±»ï¼‰ä¸­ï¼Œå®ç°äº†servletçš„initæ–¹æ³•ï¼ˆå…¶å®å†å¾€é‡Œè¿½æºç ï¼Œå®é™…æ˜¯ä»æºç é‡Œé¢å®ç°çš„ï¼Œç®—æ˜¯ä¸€ä¸ªæ‰©å±•ç‚¹å§ï¼‰ï¼Œè¿™é‡Œä¸»è¦æ˜¯å§”æ´¾ç»™äº†å­ç±»FrameworkServletï¼ˆdispatcherServletçš„çˆ¶ç±»ï¼‰çš„initServletBean()ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯åˆå§‹åŒ–webåº”ç”¨ã€‚é€šè¿‡initWebApplicationContext()é…ç½®å¹¶åˆ·æ–°å­å®¹å™¨ï¼Œè¿™é‡Œå…¶å®å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªå…¶å®ä¸»è¦æ˜¯æ ¹æ®é…ç½®æ–‡ä»¶ä¿¡æ¯è¿›è¡Œç±»åŠ è½½çš„å·¥ä½œï¼Œå¹¶ä¸”é…ç½®äº†ä¸€ä¸ªå®¹å™¨åŠ è½½ä¿¡æ¯çš„ç›‘å¬å™¨ SourceFilteringListenerã€‚åœ¨æœ€åé€šè¿‡ refresh æ–¹æ³•è¿›è¡Œäº†å®¹å™¨ä¸­å®ä½“ç±»çš„åŠ è½½è¿‡ç¨‹ã€‚è¿™ä¸ªrefreshæ–¹æ³•å’Œæˆ‘ä»¬åœ¨listenerä¸­å®ç°ç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªæ–¹æ³•ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œåœ¨æˆ‘ä»¬åº”ç”¨ä¸­é…ç½®çš„æ‰€æœ‰çš„ç±»éƒ½èƒ½å¤Ÿæ‰«æåˆ°ï¼Œå¹¶ä¸”é…ç½®äº†æˆ‘ä»¬çš„iocå®¹å™¨ä¸­ã€‚å› ä¸ºæˆ‘ä»¬é…ç½®äº†ç›¸å…³çš„å®¹å™¨åŠ è½½çš„ç›‘å¬å™¨ï¼Œåœ¨refreshæ–¹æ³•ä¸­è°ƒç”¨äº† finishRefresh æ–¹æ³•æ—¶ï¼Œå‘é€å¯¹åº”çš„å®¹å™¨åŠ è½½å®Œæˆå¹¿æ’­ä¿¡æ¯ï¼Œä»è€Œèƒ½å¤Ÿè°ƒç”¨æˆ‘ä»¬æ‰€æ³¨å†Œçš„ç›‘å¬å™¨ SourceFilteringListenerã€‚çœ‹ä¸€ä¸‹é‡Œé¢çš„é€»è¾‘~è¿™é‡Œé¢å®é™…ä¸Šåˆè°ƒç”¨äº†ä¼ å…¥çš„ä»£ç†ç±»çš„onRefresh()ã€‚è¿™ä¸ªä»£ç†ç±»æ˜¯è°ï¼Ÿå…¶å®å°±æ˜¯DispatcherServletã€‚ä»–çš„onRefresh()å®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†initStrategies()ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢ä¸»è¦æ˜¯åˆå§‹åŒ–äº†æˆ‘ä»¬çš„æ‰€ä½¿ç”¨åˆ°çš„ä¸€äº›è§£æå™¨å’Œå¤„ç†å™¨ç­‰ã€‚å½“æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°±å¯ä»¥æ ¹æ®è¿™äº›è§£æå™¨æ¥è¿›è¡Œè¯·æ±‚çš„è§£æå¤„ç†ã€æ–¹æ³•çš„è°ƒç”¨ã€å¼‚å¸¸çš„å¤„ç†ç­‰ç­‰ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼ŒServletçš„åˆå§‹åŒ–å·¥ä½œå°±æ•´ä¸ªå®Œæˆäº†ã€‚","categories":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"}]},{"title":"MySQL[åå››]redoæ—¥å¿—","slug":"MySQL/MySQL[åå››]redoæ—¥å¿—","date":"2022-01-11T03:17:34.284Z","updated":"2022-01-11T03:25:35.265Z","comments":true,"path":"2022/01/11/MySQL/MySQL[åå››]redoæ—¥å¿—/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E5%8D%81%E5%9B%9B]redo%E6%97%A5%E5%BF%97/","excerpt":"","text":"ä¸€ï¼Œä»€ä¹ˆæ˜¯redoæ—¥å¿—InnoDBå­˜å‚¨å¼•æ“æ˜¯ä»¥é¡µä¸ºå•ä½æ¥ç®¡ç†å­˜å‚¨ç©ºé—´çš„ï¼Œæˆ‘ä»¬çš„CRUDæ“ä½œå…¶å®éƒ½æ˜¯åœ¨è®¿é—®é¡µé¢ã€‚åœ¨çœŸæ­£è®¿é—®é¡µé¢ä¹‹å‰ï¼Œéœ€è¦æŠŠç£ç›˜ä¸­çš„é¡µåŠ è½½åˆ°å†…å­˜çš„BufferPoolï¼Œä¹‹åæ‰èƒ½è®¿é—®ï¼Œä½†æ˜¯å› ä¸ºäº‹åŠ¡è¦ä¿æŒæŒä¹…æ€§ï¼Œå¦‚æœæˆ‘ä»¬ä»…ä»…åœ¨å†…å­˜çš„ç¼“å†²æ± ä¿®æ”¹äº†é¡µé¢ï¼Œå‡è®¾äº‹åŠ¡æäº¤åçªç„¶å‘ç”Ÿæ•…éšœï¼Œå¯¼è‡´å†…å­˜çš„æ•°æ®éƒ½æ¶ˆå¤±äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªå·²ç»æäº¤çš„äº‹åŠ¡åœ¨æ•°æ®åº“åšçš„æ›´æ”¹å°±ä¸¢å¤±äº†ã€‚ å¦‚ä½•ä¿è¯æŒä¹…æ€§å‘¢ï¼Ÿå¯ä»¥åœ¨äº‹åŠ¡æäº¤å®Œæˆä¹‹å‰ï¼ŒæŠŠäº‹åŠ¡ä¿®æ”¹çš„æ‰€æœ‰é¡µé¢éƒ½åˆ·æ–°åˆ°ç£ç›˜ã€‚ä¸è¿‡è¿™æ ·åšå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š åˆ·æ–°ä¸€ä¸ªå®Œæ•´çš„æ•°æ®é¡µè¿‡äºæµªè´¹ éšæœºIOæ•ˆç‡æ¯”è¾ƒä½ äº‹å®ä¸Šä»…ä»…æ˜¯ä¸ºäº†ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œæ²¡æœ‰å¿…è¦æ¯æ¬¡æäº¤äº‹åŠ¡çš„æ—¶å€™å°±æŠŠè¯¥äº‹åŠ¡åœ¨å†…å­˜ä¿®æ”¹è¿‡çš„å…¨éƒ¨é¡µé¢åˆ·æ–°åˆ°ç£ç›˜ï¼Œåªéœ€è¦æŠŠä¿®æ”¹çš„å†…å®¹è®°å½•ä¸€ä¸‹å°±å¥½ï¼Œè¿™æ ·åœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™ä¸ªè®°å½•åˆ·æ–°åˆ°ç£ç›˜ã€‚å³ä½¿ç³»ç»Ÿå› ä¸ºå´©æºƒè€Œé‡å¯åªéœ€è¦æŒ‰ç…§è®°å½•çš„å†…å®¹é‡æ–°æ›´æ–°æ•°æ®é¡µå³å¯æ¢å¤æ•°æ®ï¼Œä¸Šè¿°è®°å½•ä¿®æ”¹çš„å†…å®¹å°±å«åšé‡åšæ—¥å¿—ï¼ˆredo logï¼‰ã€‚ ç›¸æ¯”äºåœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™å°†æ‰€æœ‰ä¿®æ”¹è¿‡çš„å†…å­˜ä¸­çš„é¡µé¢åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‡åšæ—¥å¿—æœ‰ä»¥ä¸‹å¥½å¤„ï¼š redoæ—¥å¿—å ç”¨ç©ºé—´å°ï¼šåœ¨å­˜å‚¨è¡¨ç©ºé—´IDï¼Œé¡µå·ï¼Œåç§»é‡ä»¥åŠéœ€è¦æ›´æ–°çš„å€¼æ—¶ï¼Œéœ€è¦çš„å­˜å‚¨ç©ºé—´å¾ˆå°ã€‚ redoæ—¥å¿—æ˜¯é¡ºåºå†™å…¥ç£ç›˜çš„ï¼šåœ¨æ‰§è¡Œäº‹åŠ¡è¿‡ç¨‹ä¸­ï¼Œæ¯æ‰§è¡Œä¸€æ¡è¯­å¥ï¼Œå°±å¯èƒ½äº§ç”Ÿè‹¥å¹²æ¡redoæ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—æ˜¯æŒ‰ç…§äº§ç”Ÿçš„é¡ºåºå†™å…¥ç£ç›˜çš„ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨é¡ºåºIOã€‚ äºŒï¼Œredoæ—¥å¿—æ ¼å¼é‡åšæ—¥å¿—æœ¬è´¨ä¸Šä»…ä»…æ˜¯è®°å½•äº†ä¸€ä¸‹äº‹åŠ¡å¯¹æ•°æ®åº“è¿›è¡Œäº†å“ªäº›ä¿®æ”¹ã€‚é’ˆå¯¹äº‹åŠ¡å¯¹æ•°æ®åº“çš„ä¸åŒä¿®æ”¹åœºæ™¯MySQLå®šä¹‰äº†å¾ˆå¤šç§é‡åšæ—¥å¿—ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†ç±»å‹çš„é‡åšæ—¥å¿—éƒ½æœ‰ä»¥ä¸‹çš„é€šç”¨ç»“æ„ã€‚ type é‡åšæ—¥å¿—çš„ç±»å‹ space ID è¡¨ç©ºé—´ID page number é¡µå· Data æ—¥å¿—çš„å…·ä½“å†…å®¹ 1. ç®€å•çš„redoæ—¥å¿—ç±»å‹è¡Œæ ¼å¼é‡Œé¢æœ‰ä¸€ä¸ªéšè—åˆ—å«åšrow_idã€‚ä¸ºrow_idè¿›è¡Œèµ‹å€¼çš„æ–¹å¼å¦‚ä¸‹ï¼š æœåŠ¡å™¨ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ¯å½“åƒæŸä¸ªåŒ…å«row_idéšè—åˆ—çš„è¡¨æ’å…¥ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå…¨å±€å˜é‡çš„å€¼å½“åšæ–°è®°å½•row_idçš„å€¼ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªå…¨å±€å˜é‡è‡ªå¢1ã€‚ æ¯å½“è¿™ä¸ªå…¨å±€å˜é‡çš„å€¼æ˜¯256çš„æ•´æ•°å€çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå˜é‡çš„å€¼åˆ·æ–°åˆ°ç³»ç»Ÿè¡¨ç©ºé—´é¡µå·ä¸º7çš„é¡µé¢ä¸­ä¸€ä¸ªå«åšMax Row IDçš„å±æ€§ä¸­ã€‚ å½“ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå°†Max Row IDå±æ€§åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶æŠŠè¿™ä¸ªå€¼åŠ ä¸Š256ä¹‹åèµ‹å€¼ç»™å‰é¢æåˆ°çš„å…¨å±€å˜é‡ã€‚ è¿™ä¸ªMax Row IDå ç”¨çš„å­˜å‚¨ç©ºé—´æ˜¯8å­—èŠ‚ã€‚å½“æŸä¸ªäº‹åŠ¡å‘æŸä¸ªåŒ…å«row_idçš„è¡¨æ’å…¥ä¸€æ¡è®°å½•å¹¶ä¸”è¯¥è®°å½•åˆ†é…çš„row_idå€¼ä¸º256çš„æ•´æ•°å€çš„æ—¶å€™ï¼Œå°±ä¼šåƒç³»ç»Ÿè¡¨ç©ºé—´é¡µå·ä¸º7çš„é¡µé¢çš„ç›¸åº”åç§»é‡å¤„å†™å…¥8å­—èŠ‚çš„å€¼ã€‚ä½†æ˜¯è¿™ä¸ªå†™å…¥æ“ä½œå®é™…ä¸Šæ˜¯åœ¨å†…å­˜ç¼“å†²åŒºå®Œæˆçš„ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™æ¬¡ä¿®æ”¹ä»¥redoæ—¥å¿—çš„å½¢å¼è®°å½•ä¸‹æ¥ï¼Œè¿™æ ·åœ¨äº‹åŠ¡æäº¤ä¹‹åï¼Œå³ä½¿ç³»ç»Ÿå´©æºƒï¼Œä¹Ÿå¯ä»¥å°†è¯¥é¡µé¢æ¢å¤æˆå´©æºƒå‰çš„çŠ¶æ€ã€‚åœ¨è¿™ç§å¯¹é¡µé¢çš„ä¿®æ”¹ç‰¹åˆ«ç®€å•çš„æ—¶å€™ï¼Œé‡åšæ—¥å¿—ä»…ä»…éœ€è¦è®°å½•ä¸€ä¸‹åœ¨æŸä¸ªé¡µé¢çš„æŸä¸ªåç§»é‡å¤„ä¿®æ”¹äº†å‡ ä¸ªå­—èŠ‚çš„å€¼ï¼Œå…·ä½“ä¿®æ”¹åçš„å†…å®¹æ˜¯ä»€ä¹ˆå°±å¯ä»¥äº†ã€‚è¿™ä¹Ÿå«åšç‰©ç†æ—¥å¿—ã€‚ offsetè¡¨ç¤ºé¡µé¢ä¸­çš„åç§»é‡ã€‚å¦‚æœå†™å…¥çš„æ˜¯å­—èŠ‚åºåˆ—ç±»å‹çš„é‡åšæ—¥å¿—ï¼Œè¿˜éœ€è¦æœ‰ä¸€ä¸ªlenå±æ€§è®°å½•å®é™…å†™å…¥çš„é•¿åº¦ã€‚ 2.å¤æ‚çš„redoæ—¥å¿—ç±»å‹æœ‰æ—¶å€™æ‰§è¡Œä¸€æ¡è¯­å¥ä¼šä¿®æ”¹éå¸¸å¤šçš„é¡µé¢ï¼ŒåŒ…æ‹¬ç³»ç»Ÿæ•°æ®é¡µé¢å’Œç”¨æˆ·æ•°æ®é¡µé¢ï¼ˆç”¨æˆ·æ•°æ®æŒ‡çš„å°±æ˜¯èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•å¯¹åº”çš„B+æ ‘ï¼‰ã€‚ è¿™æ—¶æˆ‘ä»¬å¦‚æœä½¿ç”¨ç®€å•çš„ç‰©ç†redoæ—¥å¿—æ¥è®°å½•è¿™äº›ä¿®æ”¹æ—¶ï¼Œå¯ä»¥æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š æ–¹æ¡ˆä¸€ï¼šåœ¨æ¯ä¸ªä¿®æ”¹çš„åœ°æ–¹éƒ½è®°å½•ä¸€æ¡redoæ—¥å¿—ã€‚ä¹Ÿå°±æ˜¯æœ‰å¤šå°‘ä¸ªä¿®æ”¹çš„è®°å½•ï¼Œå°±å†™å¤šå°‘æ¡ç‰©ç†redoæ—¥å¿—ã€‚è¿™æ ·å­è®°å½•redoæ—¥å¿—çš„ç¼ºç‚¹æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå› ä¸ºè¢«ä¿®æ”¹çš„åœ°æ–¹æ˜¯åœ¨å¤ªå¤šäº†ï¼Œå¯èƒ½è®°å½•çš„redoæ—¥å¿—å ç”¨çš„ç©ºé—´éƒ½æ¯”æ•´ä¸ªé¡µé¢å ç”¨çš„ç©ºé—´éƒ½å¤šã€‚ æ–¹æ¡ˆäºŒï¼šå°†æ•´ä¸ªé¡µé¢çš„ç¬¬ä¸€ä¸ªè¢«ä¿®æ”¹çš„å­—èŠ‚åˆ°æœ€åä¸€ä¸ªä¿®æ”¹çš„å­—èŠ‚ä¹‹é—´æ‰€æœ‰çš„æ•°æ®å½“æˆæ˜¯ä¸€æ¡ç‰©ç†redoæ—¥å¿—ä¸­çš„å…·ä½“æ•°æ®ã€‚ç¬¬ä¸€ä¸ªè¢«ä¿®æ”¹çš„å­—èŠ‚åˆ°æœ€åä¸€ä¸ªä¿®æ”¹çš„å­—èŠ‚ä¹‹é—´ä»ç„¶æœ‰è®¸å¤šæ²¡æœ‰ä¿®æ”¹è¿‡çš„æ•°æ®ï¼Œæˆ‘ä»¬æŠŠè¿™äº›æ²¡æœ‰ä¿®æ”¹çš„æ•°æ®ä¹ŸåŠ å…¥åˆ°redoæ—¥å¿—ä¸­å¤ªæµªè´¹äº†ã€‚ æ­£å› ä¸ºä¸Šè¿°ä¸¤ç§ä½¿ç”¨ç‰©ç†redoæ—¥å¿—çš„æ–¹å¼æ¥è®°å½•æŸä¸ªé¡µé¢ä¸­åšäº†å“ªäº›ä¿®æ”¹æ¯”è¾ƒæµªè´¹ï¼ŒInnoDBæå‡ºäº†ä¸€äº›æ–°çš„redoæ—¥å¿—ç±»å‹ã€‚ è¿™äº›ç±»å‹çš„redoæ—¥å¿—æ—¢åŒ…å«ç‰©ç†å±‚é¢çš„æ„æ€ï¼Œä¹ŸåŒ…å«é€»è¾‘å±‚é¢çš„æ„æ€ï¼Œå…·ä½“æŒ‡ï¼š ç‰©ç†å±‚é¢çœ‹ï¼Œè¿™äº›æ—¥å¿—éƒ½æŒ‡æ˜äº†å¯¹å“ªä¸ªè¡¨ç©ºé—´çš„å“ªä¸ªé¡µè¿›è¡Œäº†ä¿®æ”¹ã€‚ é€»è¾‘å±‚é¢çœ‹ï¼Œåœ¨ç³»ç»Ÿå´©æºƒé‡å¯æ—¶ï¼Œå¹¶ä¸èƒ½ç›´æ¥æ ¹æ®è¿™äº›æ—¥å¿—é‡Œçš„è®°è½½ï¼Œå°†é¡µé¢å†…çš„æŸä¸ªåç§»é‡å¤„æ¢å¤æˆæŸä¸ªæ•°æ®ï¼Œè€Œæ˜¯éœ€è¦è°ƒç”¨ä¸€äº›äº‹å…ˆå‡†å¤‡å¥½çš„å‡½æ•°ï¼Œæ‰§è¡Œå®Œè¿™äº›å‡½æ•°åæ‰å¯ä»¥å°†é¡µé¢æ¢å¤æˆç³»ç»Ÿå´©æºƒå‰çš„æ ·å­ã€‚ è¿™ä¸ªç±»å‹ä¸ºMLOG_COMP_REC_INSERTçš„redoæ—¥å¿—å¹¶æ²¡æœ‰è®°å½•PAGE_N_DIR_SLOTSçš„å€¼ä¿®æ”¹ä¸ºäº†ä»€ä¹ˆï¼ŒPAGE_HEAP_TOPçš„å€¼ä¿®æ”¹ä¸ºäº†ä»€ä¹ˆï¼ŒPAGE_N_HEAPçš„å€¼ä¿®æ”¹ä¸ºäº†ä»€ä¹ˆç­‰ç­‰è¿™äº›ä¿¡æ¯ï¼Œè€Œåªæ˜¯æŠŠåœ¨æœ¬é¡µé¢ä¸­æ’å…¥ä¸€æ¡è®°å½•æ‰€æœ‰å¿…å¤‡çš„è¦ç´ è®°äº†ä¸‹æ¥ï¼Œä¹‹åç³»ç»Ÿå´©æºƒé‡å¯æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè°ƒç”¨ç›¸å…³å‘æŸä¸ªé¡µé¢æ’å…¥ä¸€æ¡è®°å½•çš„é‚£ä¸ªå‡½æ•°ï¼Œè€Œredoæ—¥å¿—ä¸­çš„é‚£äº›æ•°æ®å°±å¯ä»¥è¢«å½“æˆæ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°æ‰€éœ€çš„å‚æ•°ï¼Œåœ¨è°ƒç”¨å®Œè¯¥å‡½æ•°åï¼Œé¡µé¢ä¸­çš„PAGE_N_DIR_SLOTSã€PAGE_HEAP_TOPã€PAGE_N_HEAPç­‰ç­‰çš„å€¼ä¹Ÿå°±éƒ½è¢«æ¢å¤åˆ°ç³»ç»Ÿå´©æºƒå‰çš„æ ·å­äº†ã€‚è¿™å°±æ˜¯æ‰€è°“çš„é€»è¾‘æ—¥å¿—çš„æ„æ€ã€‚ æ—¥å¿—æ ¼å¼è¯´äº†ä¸€å †æ ¸å¿ƒå…¶å®å°±æ˜¯ï¼šé‡åšæ—¥å¿—ä¼šæŠŠäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹æ•°æ®åº“æ‰€åšçš„æ‰€æœ‰ä¿®æ”¹éƒ½è®°å½•ä¸‹æ¥ï¼Œåœ¨ä¹‹åç³»ç»Ÿå› ä¸ºå´©æºƒè€Œé‡å¯åå¯ä»¥æŠŠäº‹åŠ¡æ‰€åšçš„ä»»ä½•ä¿®æ”¹éƒ½æ¢å¤è¿‡æ¥ã€‚ ä¸ºäº†èŠ‚çœé‡åšæ—¥å¿—å ç”¨çš„ç©ºé—´å¤§å°ï¼ŒInnoDBè¿˜å¯¹é‡åšæ—¥å¿—ä¸­çš„æŸäº›æ•°æ®è¿›è¡Œäº†å‹ç¼©å¤„ç†ï¼Œæ¯”å¦‚è¡¨ç©ºé—´ID&amp;page number ä¸€èˆ¬å ç”¨4å­—èŠ‚æ¥å­˜å‚¨ï¼Œä½†æ˜¯ç»è¿‡å‹ç¼©ä¹‹åå ç”¨çš„ç©ºé—´å°±æ›´å°äº†ã€‚ ä¸‰ï¼ŒMini-Transcation1.ä»¥ç»„çš„å½¢å¼å†™å…¥redoæ—¥å¿—è¯­å¥åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¿®æ”¹è‹¥å¹²ä¸ªé¡µé¢ã€‚æ¯”å¦‚æˆ‘ä»¬å‰è¾¹è¯´çš„ä¸€æ¡INSERTè¯­å¥å¯èƒ½ä¿®æ”¹ç³»ç»Ÿè¡¨ç©ºé—´é¡µå·ä¸º7çš„é¡µé¢çš„Max Row IDå±æ€§ï¼ˆå½“ç„¶ä¹Ÿå¯èƒ½æ›´æ–°åˆ«çš„ç³»ç»Ÿé¡µé¢ï¼Œåªä¸è¿‡æˆ‘ä»¬æ²¡æœ‰éƒ½åˆ—ä¸¾å‡ºæ¥è€Œå·²ï¼‰ï¼Œè¿˜ä¼šæ›´æ–°èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•å¯¹åº”B+æ ‘ä¸­çš„é¡µé¢ã€‚ç”±äºå¯¹è¿™äº›é¡µé¢çš„æ›´æ”¹éƒ½å‘ç”Ÿåœ¨Buffer Poolä¸­ï¼Œæ‰€ä»¥åœ¨ä¿®æ”¹å®Œé¡µé¢ä¹‹åï¼Œéœ€è¦è®°å½•ä¸€ä¸‹ç›¸åº”çš„redoæ—¥å¿—ã€‚åœ¨æ‰§è¡Œè¯­å¥çš„è¿‡ç¨‹ä¸­äº§ç”Ÿçš„redoæ—¥å¿—è¢«InnoDBäººä¸ºçš„åˆ’åˆ†æˆäº†è‹¥å¹²ä¸ªä¸å¯åˆ†å‰²çš„ç»„ï¼Œæ¯”å¦‚ï¼š æ›´æ–°Max Row IDå±æ€§æ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ å‘èšç°‡ç´¢å¼•å¯¹åº”B+æ ‘çš„é¡µé¢ä¸­æ’å…¥ä¸€æ¡è®°å½•æ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ å‘æŸä¸ªäºŒçº§ç´¢å¼•å¯¹åº”B+æ ‘çš„é¡µé¢ä¸­æ’å…¥ä¸€æ¡è®°å½•æ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ è¿˜æœ‰å…¶ä»–çš„ä¸€äº›å¯¹é¡µé¢çš„è®¿é—®æ“ä½œæ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ã€‚ã€‚ æ€ä¹ˆç†è§£è¿™ä¸ªä¸å¯åˆ†å‰²çš„æ„æ€å‘¢ï¼Ÿæˆ‘ä»¬ä»¥å‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘æ’å…¥ä¸€æ¡è®°å½•ä¸ºä¾‹ï¼Œåœ¨å‘B+æ ‘ä¸­æ’å…¥è¿™æ¡è®°å½•ä¹‹å‰ï¼Œéœ€è¦å…ˆå®šä½åˆ°è¿™æ¡è®°å½•åº”è¯¥è¢«æ’å…¥åˆ°å“ªä¸ªå¶å­èŠ‚ç‚¹ä»£è¡¨çš„æ•°æ®é¡µä¸­ï¼Œå®šä½åˆ°å…·ä½“çš„æ•°æ®é¡µä¹‹åï¼Œæœ‰ä¸¤ç§å¯èƒ½çš„æƒ…å†µï¼š æƒ…å†µä¸€ï¼šè¯¥æ•°æ®é¡µçš„å‰©ä½™çš„ç©ºé—²ç©ºé—´å……è¶³ï¼Œè¶³å¤Ÿå®¹çº³è¿™ä¸€æ¡å¾…æ’å…¥è®°å½•ï¼Œé‚£ä¹ˆäº‹æƒ…å¾ˆç®€å•ï¼Œç›´æ¥æŠŠè®°å½•æ’å…¥åˆ°è¿™ä¸ªæ•°æ®é¡µä¸­ï¼Œè®°å½•ä¸€æ¡ç±»å‹ä¸ºMLOG_COMP_REC_INSERTçš„redoæ—¥å¿—å°±å¥½äº†ï¼Œæˆ‘ä»¬æŠŠè¿™ç§æƒ…å†µç§°ä¹‹ä¸ºä¹è§‚æ’å…¥ã€‚å‡å¦‚æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘é•¿è¿™æ ·ï¼šç°åœ¨æˆ‘ä»¬è¦æ’å…¥ä¸€æ¡é”®å€¼ä¸º10çš„è®°å½•ï¼Œå¾ˆæ˜¾ç„¶éœ€è¦è¢«æ’å…¥åˆ°é¡µbä¸­ï¼Œç”±äºé¡µbç°åœ¨æœ‰è¶³å¤Ÿçš„ç©ºé—´å®¹çº³ä¸€æ¡è®°å½•ï¼Œæ‰€ä»¥ç›´æ¥å°†è¯¥è®°å½•æ’å…¥åˆ°é¡µbä¸­å°±å¥½äº†ï¼Œå°±åƒè¿™æ ·ï¼š æƒ…å†µäºŒï¼šè¯¥æ•°æ®é¡µå‰©ä½™çš„ç©ºé—²ç©ºé—´ä¸è¶³ï¼Œé‚£ä¹ˆäº‹æƒ…å°±æ‚²å‰§äº†ï¼Œæˆ‘ä»¬å‰è¾¹è¯´è¿‡ï¼Œé‡åˆ°è¿™ç§æƒ…å†µè¦è¿›è¡Œæ‰€è°“çš„é¡µåˆ†è£‚æ“ä½œï¼Œä¹Ÿå°±æ˜¯æ–°å»ºä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œç„¶åæŠŠåŸå…ˆæ•°æ®é¡µä¸­çš„ä¸€éƒ¨åˆ†è®°å½•å¤åˆ¶åˆ°è¿™ä¸ªæ–°çš„æ•°æ®é¡µä¸­ï¼Œç„¶åå†æŠŠè®°å½•æ’å…¥è¿›å»ï¼ŒæŠŠè¿™ä¸ªå¶å­èŠ‚ç‚¹æ’å…¥åˆ°å¶å­èŠ‚ç‚¹é“¾è¡¨ä¸­ï¼Œæœ€åè¿˜è¦åœ¨å†…èŠ‚ç‚¹ä¸­æ·»åŠ ä¸€æ¡ç›®å½•é¡¹è®°å½•æŒ‡å‘è¿™ä¸ªæ–°åˆ›å»ºçš„é¡µé¢ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªè¿‡ç¨‹è¦å¯¹å¤šä¸ªé¡µé¢è¿›è¡Œä¿®æ”¹ï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šäº§ç”Ÿå¤šæ¡redoæ—¥å¿—ï¼Œæˆ‘ä»¬æŠŠè¿™ç§æƒ…å†µç§°ä¹‹ä¸ºæ‚²è§‚æ’å…¥ã€‚å‡å¦‚æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘é•¿è¿™æ ·ï¼šç°åœ¨æˆ‘ä»¬è¦æ’å…¥ä¸€æ¡é”®å€¼ä¸º10çš„è®°å½•ï¼Œå¾ˆæ˜¾ç„¶éœ€è¦è¢«æ’å…¥åˆ°é¡µbä¸­ï¼Œä½†æ˜¯ä»å›¾ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ­¤æ—¶é¡µbå·²ç»å¡æ»¡äº†è®°å½•ï¼Œæ²¡æœ‰æ›´å¤šçš„ç©ºé—²ç©ºé—´æ¥å®¹çº³è¿™æ¡æ–°è®°å½•äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œé¡µé¢çš„åˆ†è£‚æ“ä½œï¼Œå°±åƒè¿™æ ·ï¼šå¦‚æœä½œä¸ºå†…èŠ‚ç‚¹çš„é¡µaçš„å‰©ä½™ç©ºé—²ç©ºé—´ä¹Ÿä¸è¶³ä»¥å®¹çº³å¢åŠ ä¸€æ¡ç›®å½•é¡¹è®°å½•ï¼Œé‚£éœ€è¦ç»§ç»­åšå†…èŠ‚ç‚¹é¡µaçš„åˆ†è£‚æ“ä½œï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šä¿®æ”¹æ›´å¤šçš„é¡µé¢ï¼Œä»è€Œäº§ç”Ÿæ›´å¤šçš„redoæ—¥å¿—ã€‚å¦å¤–ï¼Œå¯¹äºæ‚²è§‚æ’å…¥æ¥è¯´ï¼Œç”±äºéœ€è¦æ–°ç”³è¯·æ•°æ®é¡µï¼Œè¿˜éœ€è¦æ”¹åŠ¨ä¸€äº›ç³»ç»Ÿé¡µé¢ï¼Œæ¯”æ–¹è¯´è¦ä¿®æ”¹å„ç§æ®µã€åŒºçš„ç»Ÿè®¡ä¿¡æ¯ä¿¡æ¯ï¼Œå„ç§é“¾è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ¯”å¦‚ä»€ä¹ˆFREEé“¾è¡¨ã€FSP_FREE_FRAGé“¾è¡¨ç­‰ï¼Œæˆ‘ä»¬åœ¨ä»‹ç»è¡¨ç©ºé—´é‚£ä¸€ç¯‡ä¸­ä»‹ç»è¿‡çš„å„ç§ä¸œè¥¿ï¼‰ï¼Œåæ­£æ€»å…±éœ€è¦è®°å½•çš„redoæ—¥å¿—æœ‰äºŒã€ä¸‰åæ¡ã€‚ å…¶å®ä¸å…‰æ˜¯æ‚²è§‚æ’å…¥ä¸€æ¡è®°å½•ä¼šç”Ÿæˆè®¸å¤šæ¡redoæ—¥å¿—ï¼ŒInnoDBä¸ºäº†å…¶ä»–çš„ä¸€äº›åŠŸèƒ½ï¼Œåœ¨ä¹è§‚æ’å…¥æ—¶ä¹Ÿå¯èƒ½äº§ç”Ÿå¤šæ¡redoæ—¥å¿—ã€‚ InnoDBè®¤ä¸ºå‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­æ’å…¥ä¸€æ¡è®°å½•çš„è¿™ä¸ªè¿‡ç¨‹å¿…é¡»æ˜¯åŸå­çš„ï¼Œä¸èƒ½è¯´æ’äº†ä¸€åŠä¹‹åå°±åœæ­¢äº†ã€‚æ¯”æ–¹è¯´åœ¨æ‚²è§‚æ’å…¥è¿‡ç¨‹ä¸­ï¼Œæ–°çš„é¡µé¢å·²ç»åˆ†é…å¥½äº†ï¼Œæ•°æ®ä¹Ÿå¤åˆ¶è¿‡å»äº†ï¼Œæ–°çš„è®°å½•ä¹Ÿæ’å…¥åˆ°é¡µé¢ä¸­äº†ï¼Œå¯æ˜¯æ²¡æœ‰å‘å†…èŠ‚ç‚¹ä¸­æ’å…¥ä¸€æ¡ç›®å½•é¡¹è®°å½•ï¼Œè¿™ä¸ªæ’å…¥è¿‡ç¨‹å°±æ˜¯ä¸å®Œæ•´çš„ï¼Œè¿™æ ·ä¼šå½¢æˆä¸€æ£µä¸æ­£ç¡®çš„B+æ ‘ã€‚æˆ‘ä»¬çŸ¥é“redoæ—¥å¿—æ˜¯ä¸ºäº†åœ¨ç³»ç»Ÿå´©æºƒé‡å¯æ—¶æ¢å¤å´©æºƒå‰çš„çŠ¶æ€ï¼Œå¦‚æœåœ¨æ‚²è§‚æ’å…¥çš„è¿‡ç¨‹ä¸­åªè®°å½•äº†ä¸€éƒ¨åˆ†redoæ—¥å¿—ï¼Œé‚£ä¹ˆåœ¨ç³»ç»Ÿå´©æºƒé‡å¯æ—¶ä¼šå°†ç´¢å¼•å¯¹åº”çš„B+æ ‘æ¢å¤æˆä¸€ç§ä¸æ­£ç¡®çš„çŠ¶æ€ï¼Œè¿™æ˜¯InnoDBæ‰€ä¸èƒ½å¿å—çš„ã€‚æ‰€ä»¥ä»–ä»¬è§„å®šåœ¨æ‰§è¡Œè¿™äº›éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œæ—¶å¿…é¡»ä»¥ç»„çš„å½¢å¼æ¥è®°å½•çš„redoæ—¥å¿—ï¼Œåœ¨è¿›è¡Œç³»ç»Ÿå´©æºƒé‡å¯æ¢å¤æ—¶ï¼Œé’ˆå¯¹æŸä¸ªç»„ä¸­çš„redoæ—¥å¿—ï¼Œè¦ä¹ˆæŠŠå…¨éƒ¨çš„æ—¥å¿—éƒ½æ¢å¤æ‰ï¼Œè¦ä¹ˆä¸€æ¡ä¹Ÿä¸æ¢å¤ã€‚æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿè¿™å¾—åˆ†æƒ…å†µè®¨è®ºï¼š æœ‰çš„éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œä¼šç”Ÿæˆå¤šæ¡redoæ—¥å¿—ï¼Œæ¯”å¦‚å‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­è¿›è¡Œä¸€æ¬¡æ‚²è§‚æ’å…¥å°±éœ€è¦ç”Ÿæˆè®¸å¤šæ¡redoæ—¥å¿—ã€‚å¦‚ä½•æŠŠè¿™äº›redoæ—¥å¿—åˆ’åˆ†åˆ°ä¸€ä¸ªç»„é‡Œè¾¹å„¿å‘¢ï¼ŸInnoDBåšäº†ä¸€ä¸ªå¾ˆç®€å•çš„æ“ä½œï¼Œå°±æ˜¯åœ¨è¯¥ç»„ä¸­çš„æœ€åä¸€æ¡redoæ—¥å¿—åè¾¹åŠ ä¸Šä¸€æ¡ç‰¹æ®Šç±»å‹çš„redoæ—¥å¿—ï¼Œè¯¥ç±»å‹åç§°ä¸ºMLOG_MULTI_REC_ENDï¼Œtypeå­—æ®µå¯¹åº”çš„åè¿›åˆ¶æ•°å­—ä¸º31ï¼Œè¯¥ç±»å‹çš„redoæ—¥å¿—ç»“æ„å¾ˆç®€å•ï¼Œåªæœ‰ä¸€ä¸ªtypeå­—æ®µï¼šæ‰€ä»¥æŸä¸ªéœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œäº§ç”Ÿçš„ä¸€ç³»åˆ—redoæ—¥å¿—å¿…é¡»è¦ä»¥ä¸€ä¸ªç±»å‹ä¸ºMLOG_MULTI_REC_ENDç»“å°¾ï¼Œå°±åƒè¿™æ ·ï¼šè¿™æ ·åœ¨ç³»ç»Ÿå´©æºƒé‡å¯è¿›è¡Œæ¢å¤æ—¶ï¼Œåªæœ‰å½“è§£æåˆ°ç±»å‹ä¸ºMLOG_MULTI_REC_ENDçš„redoæ—¥å¿—ï¼Œæ‰è®¤ä¸ºè§£æåˆ°äº†ä¸€ç»„å®Œæ•´çš„redoæ—¥å¿—ï¼Œæ‰ä¼šè¿›è¡Œæ¢å¤ã€‚å¦åˆ™çš„è¯ç›´æ¥æ”¾å¼ƒå‰è¾¹è§£æåˆ°çš„redoæ—¥å¿—ã€‚ æœ‰çš„éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œåªç”Ÿæˆä¸€æ¡redoæ—¥å¿—ï¼Œæ¯”å¦‚æ›´æ–°Max Row IDå±æ€§çš„æ“ä½œå°±åªä¼šç”Ÿæˆä¸€æ¡redoæ—¥å¿—ã€‚å…¶å®åœ¨ä¸€æ¡æ—¥å¿—åè¾¹è·Ÿä¸€ä¸ªç±»å‹ä¸ºMLOG_MULTI_REC_ENDçš„redoæ—¥å¿—ä¹Ÿæ˜¯å¯ä»¥çš„ï¼ŒInnoDBä¸æƒ³æµªè´¹ä¸€ä¸ªæ¯”ç‰¹ä½ã€‚è™½ç„¶redoæ—¥å¿—çš„ç±»å‹æ¯”è¾ƒå¤šï¼Œä½†æ’‘æ­»äº†ä¹Ÿå°±æ˜¯å‡ åç§ï¼Œæ˜¯å°äº127è¿™ä¸ªæ•°å­—çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ç”¨7ä¸ªæ¯”ç‰¹ä½å°±è¶³ä»¥åŒ…æ‹¬æ‰€æœ‰çš„redoæ—¥å¿—ç±»å‹ï¼Œè€Œtypeå­—æ®µå…¶å®æ˜¯å ç”¨1ä¸ªå­—èŠ‚çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥çœå‡ºæ¥ä¸€ä¸ªæ¯”ç‰¹ä½ç”¨æ¥è¡¨ç¤ºè¯¥éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œåªäº§ç”Ÿå•ä¸€çš„ä¸€æ¡redoæ—¥å¿—ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼šå¦‚æœtypeå­—æ®µçš„ç¬¬ä¸€ä¸ªæ¯”ç‰¹ä½ä¸º1ï¼Œä»£è¡¨è¯¥éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œåªäº§ç”Ÿäº†å•ä¸€çš„ä¸€æ¡redoæ—¥å¿—ï¼Œå¦åˆ™è¡¨ç¤ºè¯¥éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œäº§ç”Ÿäº†ä¸€ç³»åˆ—çš„redoæ—¥å¿—ã€‚ 2.Mini-TransactionMySQLæŠŠå¯¹åº•å±‚é¡µé¢ä¸­çš„ä¸€æ¬¡åŸå­è®¿é—®çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºä¸€ä¸ªMini-Transactionï¼Œç®€ç§°mtrï¼Œæ¯”å¦‚ä¸Šè¾¹æ‰€è¯´çš„ä¿®æ”¹ä¸€æ¬¡Max Row IDçš„å€¼ç®—æ˜¯ä¸€ä¸ªMini-Transactionï¼Œå‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­æ’å…¥ä¸€æ¡è®°å½•çš„è¿‡ç¨‹ä¹Ÿç®—æ˜¯ä¸€ä¸ªMini-Transactionã€‚ä¸€ä¸ªæ‰€è°“çš„mtrå¯ä»¥åŒ…å«ä¸€ç»„redoæ—¥å¿—ï¼Œåœ¨è¿›è¡Œå´©æºƒæ¢å¤æ—¶è¿™ä¸€ç»„redoæ—¥å¿—ä½œä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ã€‚ ä¸€ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«è‹¥å¹²æ¡è¯­å¥ï¼Œæ¯ä¸€æ¡è¯­å¥å…¶å®æ˜¯ç”±è‹¥å¹²ä¸ªmtrç»„æˆï¼Œæ¯ä¸€ä¸ªmtråˆå¯ä»¥åŒ…å«è‹¥å¹²æ¡redoæ—¥å¿—ï¼Œç”»ä¸ªå›¾è¡¨ç¤ºå®ƒä»¬çš„å…³ç³»å°±æ˜¯è¿™æ ·ï¼š å››ï¼Œredoæ—¥å¿—çš„å†™å…¥è¿‡ç¨‹1.redo log blockInnoDBä¸ºäº†æ›´å¥½çš„è¿›è¡Œç³»ç»Ÿå´©æºƒæ¢å¤ï¼Œä»–ä»¬æŠŠé€šè¿‡mtrç”Ÿæˆçš„redoæ—¥å¿—éƒ½æ”¾åœ¨äº†å¤§å°ä¸º512å­—èŠ‚çš„é¡µä¸­ã€‚ä¸ºäº†å’Œè¡¨ç©ºé—´ä¸­çš„é¡µåšåŒºåˆ«ï¼Œæˆ‘ä»¬è¿™é‡ŒæŠŠç”¨æ¥å­˜å‚¨redoæ—¥å¿—çš„é¡µç§°ä¸ºblockã€‚ä¸€ä¸ªredo log blockçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š çœŸæ­£çš„redoæ—¥å¿—éƒ½æ˜¯å­˜å‚¨åˆ°å ç”¨496å­—èŠ‚å¤§å°çš„log block bodyä¸­ï¼Œå›¾ä¸­çš„log block headerå’Œlog block trailerå­˜å‚¨çš„æ˜¯ä¸€äº›ç®¡ç†ä¿¡æ¯ã€‚ å…¶ä¸­log block headerçš„å‡ ä¸ªå±æ€§çš„æ„æ€åˆ†åˆ«å¦‚ä¸‹ï¼š LOG_BLOCK_HDR_NOï¼šæ¯ä¸€ä¸ªblockéƒ½æœ‰ä¸€ä¸ªå¤§äº0çš„å”¯ä¸€æ ‡å·ï¼Œæœ¬å±æ€§å°±è¡¨ç¤ºè¯¥æ ‡å·å€¼ã€‚ LOG_BLOCK_HDR_DATA_LENï¼šè¡¨ç¤ºblockä¸­å·²ç»ä½¿ç”¨äº†å¤šå°‘å­—èŠ‚ï¼Œåˆå§‹å€¼ä¸º12ï¼ˆå› ä¸ºlog block bodyä»ç¬¬12ä¸ªå­—èŠ‚å¤„å¼€å§‹ï¼‰ã€‚éšç€å¾€blockä¸­å†™å…¥çš„redoæ—¥å¿—è¶Šæ¥ä¹Ÿå¤šï¼Œæœ¬å±æ€§å€¼ä¹Ÿè·Ÿç€å¢é•¿ã€‚å¦‚æœlog block bodyå·²ç»è¢«å…¨éƒ¨å†™æ»¡ï¼Œé‚£ä¹ˆæœ¬å±æ€§çš„å€¼è¢«è®¾ç½®ä¸º512ã€‚ LOG_BLOCK_FIRST_REC_GROUPï¼šä¸€æ¡redoæ—¥å¿—ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºä¸€æ¡redoæ—¥å¿—è®°å½•ï¼ˆredo log recordï¼‰ï¼Œä¸€ä¸ªmträ¼šç”Ÿäº§å¤šæ¡redoæ—¥å¿—è®°å½•ï¼Œè¿™äº›redoæ—¥å¿—è®°å½•è¢«ç§°ä¹‹ä¸ºä¸€ä¸ªredoæ—¥å¿—è®°å½•ç»„ï¼ˆredo log record groupï¼‰ã€‚LOG_BLOCK_FIRST_REC_GROUPå°±ä»£è¡¨è¯¥blockä¸­ç¬¬ä¸€ä¸ªmtrç”Ÿæˆçš„redoæ—¥å¿—è®°å½•ç»„çš„åç§»é‡ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯è¿™ä¸ªblocké‡Œç¬¬ä¸€ä¸ªmtrç”Ÿæˆçš„ç¬¬ä¸€æ¡redoæ—¥å¿—çš„åç§»é‡ï¼‰ã€‚ LOG_BLOCK_CHECKPOINT_NOï¼šè¡¨ç¤ºæ‰€è°“çš„checkpointçš„åºå·ï¼Œcheckpointæ˜¯æˆ‘ä»¬åç»­å†…å®¹çš„é‡ç‚¹ï¼Œç°åœ¨å…ˆä¸ç”¨æ¸…æ¥šå®ƒçš„æ„æ€ï¼Œç¨å®‰å‹¿èºã€‚ log block trailerä¸­å±æ€§çš„æ„æ€å¦‚ä¸‹ï¼š LOG_BLOCK_CHECKSUMï¼šè¡¨ç¤ºblockçš„æ ¡éªŒå€¼ï¼Œç”¨äºæ­£ç¡®æ€§æ ¡éªŒï¼Œæˆ‘ä»¬æš‚æ—¶ä¸å…³å¿ƒå®ƒã€‚ 2.redo æ—¥å¿—ç¼“å†²åŒºInnoDBä¸ºäº†è§£å†³ç£ç›˜é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜è€Œå¼•å…¥äº†Buffer Poolã€‚åŒç†ï¼Œå†™å…¥redoæ—¥å¿—æ—¶ä¹Ÿä¸èƒ½ç›´æ¥ç›´æ¥å†™åˆ°ç£ç›˜ä¸Šï¼Œå®é™…ä¸Šåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å°±å‘æ“ä½œç³»ç»Ÿç”³è¯·äº†ä¸€å¤§ç‰‡ç§°ä¹‹ä¸ºredo log bufferçš„è¿ç»­å†…å­˜ç©ºé—´ï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯redoæ—¥å¿—ç¼“å†²åŒºï¼Œä¹Ÿå¯ä»¥ç®€ç§°ä¸ºlog bufferã€‚è¿™ç‰‡å†…å­˜ç©ºé—´è¢«åˆ’åˆ†æˆè‹¥å¹²ä¸ªè¿ç»­çš„redo log blockï¼Œå°±åƒè¿™æ ·ï¼š æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°innodb_log_buffer_sizeæ¥æŒ‡å®šlog bufferçš„å¤§å°ï¼Œåœ¨MySQL 5.7.21è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œè¯¥å¯åŠ¨å‚æ•°çš„é»˜è®¤å€¼ä¸º16MBã€‚ 3.redo log æ—¥å¿—å†™å…¥log bufferå‘log bufferä¸­å†™å…¥redoæ—¥å¿—çš„è¿‡ç¨‹æ˜¯é¡ºåºçš„ï¼Œä¹Ÿå°±æ˜¯å…ˆå¾€å‰è¾¹çš„blockä¸­å†™ï¼Œå½“è¯¥blockçš„ç©ºé—²ç©ºé—´ç”¨å®Œä¹‹åå†å¾€ä¸‹ä¸€ä¸ªblockä¸­å†™ã€‚å½“æˆ‘ä»¬æƒ³å¾€log bufferä¸­å†™å…¥redoæ—¥å¿—æ—¶ï¼Œç¬¬ä¸€ä¸ªé‡åˆ°çš„é—®é¢˜å°±æ˜¯åº”è¯¥å†™åœ¨å“ªä¸ªblockçš„å“ªä¸ªåç§»é‡å¤„ï¼Œæ‰€ä»¥InnoDBç‰¹æ„æä¾›äº†ä¸€ä¸ªç§°ä¹‹ä¸ºbuf_freeçš„å…¨å±€å˜é‡ï¼Œè¯¥å˜é‡æŒ‡æ˜åç»­å†™å…¥çš„redoæ—¥å¿—åº”è¯¥å†™å…¥åˆ°log bufferä¸­çš„å“ªä¸ªä½ç½®ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š ä¸€ä¸ªmtræ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿè‹¥å¹²æ¡redoæ—¥å¿—ï¼Œè¿™äº›redoæ—¥å¿—æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„ç»„ï¼Œæ‰€ä»¥å…¶å®å¹¶ä¸æ˜¯æ¯ç”Ÿæˆä¸€æ¡redoæ—¥å¿—ï¼Œå°±å°†å…¶æ’å…¥åˆ°log bufferä¸­ï¼Œè€Œæ˜¯æ¯ä¸ªmtrè¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ—¥å¿—å…ˆæš‚æ—¶å­˜åˆ°ä¸€ä¸ªåœ°æ–¹ï¼Œå½“è¯¥mtrç»“æŸçš„æ—¶å€™ï¼Œå°†è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å†å…¨éƒ¨å¤åˆ¶åˆ°log bufferä¸­ã€‚æˆ‘ä»¬ç°åœ¨å‡è®¾æœ‰ä¸¤ä¸ªåä¸ºT1ã€T2çš„äº‹åŠ¡ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½åŒ…å«2ä¸ªmtrï¼Œæˆ‘ä»¬ç»™è¿™å‡ ä¸ªmtrå‘½åä¸€ä¸‹ï¼š äº‹åŠ¡T1çš„ä¸¤ä¸ªmtråˆ†åˆ«ç§°ä¸ºmtr_T1_1å’Œmtr_T1_2ã€‚ äº‹åŠ¡T2çš„ä¸¤ä¸ªmtråˆ†åˆ«ç§°ä¸ºmtr_T2_1å’Œmtr_T2_2ã€‚ æ¯ä¸ªmtréƒ½ä¼šäº§ç”Ÿä¸€ç»„redoæ—¥å¿—ï¼Œä¸åŒçš„äº‹åŠ¡å¯èƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œæ‰€ä»¥T1ã€T2ä¹‹é—´çš„mtrå¯èƒ½æ˜¯äº¤æ›¿æ‰§è¡Œçš„ã€‚æ¯å½“ä¸€ä¸ªmtræ‰§è¡Œå®Œæˆæ—¶ï¼Œä¼´éšè¯¥mtrç”Ÿæˆçš„ä¸€ç»„redoæ—¥å¿—å°±éœ€è¦è¢«å¤åˆ¶åˆ°log bufferä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒäº‹åŠ¡çš„mtrå¯èƒ½æ˜¯äº¤æ›¿å†™å…¥log bufferçš„ï¼Œæˆ‘ä»¬ç”»ä¸ªç¤ºæ„å›¾ï¼ˆä¸ºäº†ç¾è§‚ï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ªmträ¸­äº§ç”Ÿçš„æ‰€æœ‰çš„redoæ—¥å¿—å½“ä½œä¸€ä¸ªæ•´ä½“æ¥ç”»ï¼‰ï¼š ä»ç¤ºæ„å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸åŒçš„mträº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å ç”¨çš„å­˜å‚¨ç©ºé—´å¯èƒ½ä¸ä¸€æ ·ï¼Œæœ‰çš„mträº§ç”Ÿçš„redoæ—¥å¿—é‡å¾ˆå°‘ï¼Œæ¯”å¦‚mtr_t1_1ã€mtr_t2_1å°±è¢«æ”¾åˆ°åŒä¸€ä¸ªblockä¸­å­˜å‚¨ï¼Œæœ‰çš„mträº§ç”Ÿçš„redoæ—¥å¿—é‡éå¸¸å¤§ï¼Œæ¯”å¦‚mtr_t1_2äº§ç”Ÿçš„redoæ—¥å¿—ç”šè‡³å ç”¨äº†3ä¸ªblockæ¥å­˜å‚¨ã€‚ äº”ï¼Œredo æ—¥å¿—æ–‡ä»¶1.redoæ—¥å¿—åˆ·ç›˜æ—¶æœºmtrè¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—åœ¨mtrç»“æŸæ—¶ä¼šè¢«å¤åˆ¶åˆ°log bufferä¸­ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹å®ƒä»¬ä¼šè¢«åˆ·æ–°åˆ°ç£ç›˜é‡Œï¼Œæ¯”å¦‚ï¼š log bufferç©ºé—´ä¸è¶³æ—¶log bufferçš„å¤§å°æ˜¯æœ‰é™çš„ï¼ˆé€šè¿‡ç³»ç»Ÿå˜é‡innodb_log_buffer_sizeæŒ‡å®šï¼‰ï¼Œå¦‚æœä¸åœçš„å¾€è¿™ä¸ªæœ‰é™å¤§å°çš„log bufferé‡Œå¡å…¥æ—¥å¿—ï¼Œå¾ˆå¿«å®ƒå°±ä¼šè¢«å¡«æ»¡ã€‚InnoDBè®¤ä¸ºå¦‚æœå½“å‰å†™å…¥log bufferçš„redoæ—¥å¿—é‡å·²ç»å æ»¡äº†log bufferæ€»å®¹é‡çš„å¤§çº¦ä¸€åŠå·¦å³ï¼Œå°±éœ€è¦æŠŠè¿™äº›æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ä¸Šã€‚ äº‹åŠ¡æäº¤æ—¶ä¹‹æ‰€ä»¥ä½¿ç”¨redoæ—¥å¿—ä¸»è¦æ˜¯å› ä¸ºå®ƒå ç”¨çš„ç©ºé—´å°‘ï¼Œè¿˜æ˜¯é¡ºåºå†™ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶å¯ä»¥ä¸æŠŠä¿®æ”¹è¿‡çš„Buffer Poolé¡µé¢åˆ·æ–°åˆ°ç£ç›˜ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯æŒä¹…æ€§ï¼Œå¿…é¡»è¦æŠŠä¿®æ”¹è¿™äº›é¡µé¢å¯¹åº”çš„redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ã€‚ å°†æŸä¸ªè„é¡µåˆ·æ–°åˆ°ç£ç›˜å‰ï¼Œä¼šä¿è¯å…ˆå°†è¯¥è„é¡µå¯¹åº”çš„ redo æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼ˆå†ä¸€æ¬¡ å¼ºè°ƒï¼Œredo æ—¥å¿—æ˜¯é¡ºåºåˆ·æ–°çš„ï¼Œæ‰€ä»¥åœ¨å°†æŸä¸ªè„é¡µå¯¹åº”çš„ redo æ—¥å¿—ä» redo log buffer åˆ·æ–°åˆ°ç£ç›˜æ—¶ï¼Œä¹Ÿä¼šä¿è¯å°†åœ¨å…¶ä¹‹å‰äº§ç”Ÿçš„ redo æ—¥å¿—ä¹Ÿåˆ·æ–°åˆ°ç£ç›˜ï¼‰ã€‚ åå°çº¿ç¨‹ä¸åœçš„åˆ·åå°æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤§çº¦æ¯ç§’éƒ½ä¼šåˆ·æ–°ä¸€æ¬¡log bufferä¸­çš„redoæ—¥å¿—åˆ°ç£ç›˜ã€‚ æ­£å¸¸å…³é—­æœåŠ¡å™¨æ—¶ åšæ‰€è°“çš„checkpointæ—¶ å…¶ä»–çš„ä¸€äº›æƒ…å†µâ€¦ 2.redoæ—¥å¿—æ–‡ä»¶ç»„MySQLçš„æ•°æ®ç›®å½•ï¼ˆä½¿ç”¨SHOW VARIABLES LIKE &#39;datadir&#39;æŸ¥çœ‹ï¼‰ä¸‹é»˜è®¤æœ‰ä¸¤ä¸ªåä¸ºib_logfile0å’Œib_logfile1çš„æ–‡ä»¶ï¼Œlog bufferä¸­çš„æ—¥å¿—é»˜è®¤æƒ…å†µä¸‹å°±æ˜¯åˆ·æ–°åˆ°è¿™ä¸¤ä¸ªç£ç›˜æ–‡ä»¶ä¸­ã€‚å¦‚æœæˆ‘ä»¬å¯¹é»˜è®¤çš„redoæ—¥å¿—æ–‡ä»¶ä¸æ»¡æ„ï¼Œå¯ä»¥é€šè¿‡ä¸‹è¾¹å‡ ä¸ªå¯åŠ¨å‚æ•°æ¥è°ƒèŠ‚ï¼š innodb_log_group_home_dirè¯¥å‚æ•°æŒ‡å®šäº†redoæ—¥å¿—æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œé»˜è®¤å€¼å°±æ˜¯å½“å‰çš„æ•°æ®ç›®å½•ã€‚ innodb_log_file_sizeè¯¥å‚æ•°æŒ‡å®šäº†æ¯ä¸ªredoæ—¥å¿—æ–‡ä»¶çš„å¤§å°ï¼Œåœ¨MySQL 5.7.21è¿™ä¸ªç‰ˆæœ¬ä¸­çš„é»˜è®¤å€¼ä¸º48MBï¼Œ innodb_log_files_in_groupè¯¥å‚æ•°æŒ‡å®šredoæ—¥å¿—æ–‡ä»¶çš„ä¸ªæ•°ï¼Œé»˜è®¤å€¼ä¸º2ï¼Œæœ€å¤§å€¼ä¸º100ã€‚ ç£ç›˜ä¸Šçš„redoæ—¥å¿—æ–‡ä»¶ä¸åªä¸€ä¸ªï¼Œè€Œæ˜¯ä»¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ç»„çš„å½¢å¼å‡ºç°çš„ã€‚è¿™äº›æ–‡ä»¶ä»¥ib_logfile[æ•°å­—]ï¼ˆæ•°å­—å¯ä»¥æ˜¯0ã€1ã€2â€¦ï¼‰çš„å½¢å¼è¿›è¡Œå‘½åã€‚åœ¨å°†redoæ—¥å¿—å†™å…¥æ—¥å¿—æ–‡ä»¶ç»„æ—¶ï¼Œæ˜¯ä»ib_logfile0å¼€å§‹å†™ï¼Œå¦‚æœib_logfile0å†™æ»¡äº†ï¼Œå°±æ¥ç€ib_logfile1å†™ï¼ŒåŒç†ï¼Œib_logfile1å†™æ»¡äº†å°±å»å†™ib_logfile2ï¼Œä¾æ­¤ç±»æ¨ã€‚å¦‚æœå†™åˆ°æœ€åä¸€ä¸ªæ–‡ä»¶è¯¥å’‹åŠï¼Ÿé‚£å°±é‡æ–°è½¬åˆ°ib_logfile0ç»§ç»­å†™ï¼Œæ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ€»å…±çš„redoæ—¥å¿—æ–‡ä»¶å¤§å°å…¶å®å°±æ˜¯ï¼šinnodb_log_file_size Ã— innodb_log_files_in_groupã€‚ å¦‚æœé‡‡ç”¨å¾ªç¯ä½¿ç”¨çš„æ–¹å¼å‘redoæ—¥å¿—æ–‡ä»¶ç»„é‡Œå†™æ•°æ®çš„è¯ï¼Œé‚£å²‚ä¸æ˜¯è¦è¿½å°¾ï¼Œä¹Ÿå°±æ˜¯åå†™å…¥çš„redoæ—¥å¿—è¦†ç›–æ‰å‰è¾¹å†™çš„redoæ—¥å¿—ï¼Ÿå½“ç„¶å¯èƒ½äº†ï¼æ‰€ä»¥InnoDBæå‡ºäº†checkpointçš„æ¦‚å¿µã€‚ 3.redoæ—¥å¿—æ–‡ä»¶æ ¼å¼log bufferæœ¬è´¨ä¸Šæ˜¯ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè¢«åˆ’åˆ†æˆäº†è‹¥å¹²ä¸ª512å­—èŠ‚å¤§å°çš„blockã€‚å°†log bufferä¸­çš„redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜çš„æœ¬è´¨å°±æ˜¯æŠŠblockçš„é•œåƒå†™å…¥æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥redoæ—¥å¿—æ–‡ä»¶å…¶å®ä¹Ÿæ˜¯ç”±è‹¥å¹²ä¸ª512å­—èŠ‚å¤§å°çš„blockç»„æˆã€‚ redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„æ¯ä¸ªæ–‡ä»¶å¤§å°éƒ½ä¸€æ ·ï¼Œæ ¼å¼ä¹Ÿä¸€æ ·ï¼Œéƒ½æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š å‰2048ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å‰4ä¸ªblockæ˜¯ç”¨æ¥å­˜å‚¨ä¸€äº›ç®¡ç†ä¿¡æ¯çš„ã€‚ ä»ç¬¬2048å­—èŠ‚å¾€åæ˜¯ç”¨æ¥å­˜å‚¨log bufferä¸­çš„blocké•œåƒçš„ã€‚ æ‰€ä»¥æˆ‘ä»¬å‰è¾¹æ‰€è¯´çš„å¾ªç¯ä½¿ç”¨redoæ—¥å¿—æ–‡ä»¶ï¼Œå…¶å®æ˜¯ä»æ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„ç¬¬2048ä¸ªå­—èŠ‚å¼€å§‹ç®—ï¼Œç”»ä¸ªç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š æ™®é€šblockçš„æ ¼å¼æˆ‘ä»¬åœ¨äº†è§£log bufferçš„æ—¶å€™éƒ½è¯´è¿‡äº†ï¼Œå°±æ˜¯log block headerã€log block bodyã€log block trialerè¿™ä¸‰ä¸ªéƒ¨åˆ†ã€‚è¿™é‡Œéœ€è¦ä»‹ç»ä¸€ä¸‹æ¯ä¸ªredoæ—¥å¿—æ–‡ä»¶å‰2048ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å‰4ä¸ªç‰¹æ®Šblockçš„æ ¼å¼éƒ½æ˜¯ä»€ä¹ˆä½œç”¨ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™4ä¸ªblockåˆ†åˆ«æ˜¯ï¼š log file headerï¼šæè¿°è¯¥redoæ—¥å¿—æ–‡ä»¶çš„ä¸€äº›æ•´ä½“å±æ€§å„ä¸ªå±æ€§çš„å…·ä½“é‡Šä¹‰å¦‚ä¸‹ï¼š å±æ€§å é•¿åº¦ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰ æè¿° LOG_HEADER_FORMAT 4 redoæ—¥å¿—çš„ç‰ˆæœ¬ï¼Œåœ¨MySQL 5.7.21ä¸­è¯¥å€¼æ°¸è¿œä¸º1 LOG_HEADER_PAD1 4 åšå­—èŠ‚å¡«å……ç”¨çš„ï¼Œæ²¡ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œå¿½ç•¥ï½ LOG_HEADER_START_LSN 8 æ ‡è®°æœ¬redoæ—¥å¿—æ–‡ä»¶å¼€å§‹çš„LSNå€¼ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶åç§»é‡ä¸º2048å­—èŠ‚åˆå¯¹åº”çš„LSNå€¼ã€‚ LOG_HEADER_CREATOR 32 ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ ‡è®°æœ¬redoæ—¥å¿—æ–‡ä»¶çš„åˆ›å»ºè€…æ˜¯è°ã€‚æ­£å¸¸è¿è¡Œæ—¶è¯¥å€¼ä¸ºMySQLçš„ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ï¼š&quot;MySQL 5.7.21&quot;ï¼Œä½¿ç”¨mysqlbackupå‘½ä»¤åˆ›å»ºçš„redoæ—¥å¿—æ–‡ä»¶çš„è¯¥å€¼ä¸º&quot;ibbackup&quot;å’Œåˆ›å»ºæ—¶é—´ã€‚ LOG_BLOCK_CHECKSUM 4 æœ¬blockçš„æ ¡éªŒå€¼ï¼Œæ‰€æœ‰blockéƒ½æœ‰ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒ checkpoint1ï¼šè®°å½•å…³äºcheckpointçš„ä¸€äº›å±æ€§ï¼Œçœ‹ä¸€ä¸‹å®ƒçš„ç»“æ„ï¼šå„ä¸ªå±æ€§çš„å…·ä½“é‡Šä¹‰å¦‚ä¸‹ï¼š å±æ€§å é•¿åº¦ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰ æè¿° LOG_CHECKPOINT_NO 8 æœåŠ¡å™¨åšcheckpointçš„ç¼–å·ï¼Œæ¯åšä¸€æ¬¡checkpointï¼Œè¯¥å€¼å°±åŠ 1ã€‚ LOG_CHECKPOINT_LSN 8 æœåŠ¡å™¨åšcheckpointç»“æŸæ—¶å¯¹åº”çš„LSNå€¼ï¼Œç³»ç»Ÿå´©æºƒæ¢å¤æ—¶å°†ä»è¯¥å€¼å¼€å§‹ã€‚ LOG_CHECKPOINT_OFFSET 8 ä¸Šä¸ªå±æ€§ä¸­çš„LSNå€¼åœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„åç§»é‡ LOG_CHECKPOINT_LOG_BUF_SIZE 8 æœåŠ¡å™¨åœ¨åšcheckpointæ“ä½œæ—¶å¯¹åº”çš„log bufferçš„å¤§å° LOG_BLOCK_CHECKSUM 4 æœ¬blockçš„æ ¡éªŒå€¼ï¼Œæ‰€æœ‰blockéƒ½æœ‰ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒ ç¬¬ä¸‰ä¸ªblockæœªä½¿ç”¨ï¼Œå¿½ç•¥ checkpoint2ï¼šç»“æ„å’Œcheckpoint1ä¸€æ ·ã€‚ å…­ï¼ŒLog Sequence Numberè‡ªç³»ç»Ÿå¼€å§‹è¿è¡Œï¼Œå°±ä¸æ–­çš„åœ¨ä¿®æ”¹é¡µé¢ï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šä¸æ–­çš„ç”Ÿæˆredoæ—¥å¿—ã€‚redoæ—¥å¿—çš„é‡åœ¨ä¸æ–­çš„é€’å¢ã€‚InnoDBä¸ºè®°å½•å·²ç»å†™å…¥çš„redoæ—¥å¿—é‡ï¼Œè®¾è®¡äº†ä¸€ä¸ªç§°ä¹‹ä¸ºLog Sequence Numberçš„å…¨å±€å˜é‡ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼šæ—¥å¿—åºåˆ—å·ï¼Œç®€ç§°lsnã€‚InnoDBè§„å®šåˆå§‹çš„lsnå€¼ä¸º8704ï¼ˆä¹Ÿå°±æ˜¯ä¸€æ¡redoæ—¥å¿—ä¹Ÿæ²¡å†™å…¥æ—¶ï¼Œlsnçš„å€¼ä¸º8704ï¼‰ã€‚ åœ¨å‘log bufferä¸­å†™å…¥redoæ—¥å¿—æ—¶ä¸æ˜¯ä¸€æ¡ä¸€æ¡å†™å…¥çš„ï¼Œè€Œæ˜¯ä»¥ä¸€ä¸ªmtrç”Ÿæˆçš„ä¸€ç»„redoæ—¥å¿—ä¸ºå•ä½è¿›è¡Œå†™å…¥çš„ã€‚è€Œä¸”å®é™…ä¸Šæ˜¯æŠŠæ—¥å¿—å†…å®¹å†™åœ¨äº†log block bodyå¤„ã€‚ä½†æ˜¯åœ¨ç»Ÿè®¡lsnçš„å¢é•¿é‡æ—¶ï¼Œæ˜¯æŒ‰ç…§å®é™…å†™å…¥çš„æ—¥å¿—é‡åŠ ä¸Šå ç”¨çš„log block headerå’Œlog block traileræ¥è®¡ç®—çš„ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š ç³»ç»Ÿç¬¬ä¸€æ¬¡å¯åŠ¨ååˆå§‹åŒ–log bufferæ—¶ï¼Œbuf_freeï¼ˆå°±æ˜¯æ ‡è®°ä¸‹ä¸€æ¡redoæ—¥å¿—åº”è¯¥å†™å…¥åˆ°log bufferçš„ä½ç½®çš„å˜é‡ï¼‰å°±ä¼šæŒ‡å‘ç¬¬ä¸€ä¸ªblockçš„åç§»é‡ä¸º12å­—èŠ‚ï¼ˆlog block headerçš„å¤§å°ï¼‰çš„åœ°æ–¹ï¼Œé‚£ä¹ˆlsnå€¼ä¹Ÿä¼šè·Ÿç€å¢åŠ 12ï¼š å¦‚æœæŸä¸ªmträº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å ç”¨çš„å­˜å‚¨ç©ºé—´æ¯”è¾ƒå°ï¼Œä¹Ÿå°±æ˜¯å¾…æ’å…¥çš„blockå‰©ä½™ç©ºé—²ç©ºé—´èƒ½å®¹çº³è¿™ä¸ªmtræäº¤çš„æ—¥å¿—æ—¶ï¼Œlsnå¢é•¿çš„é‡å°±æ˜¯è¯¥mtrç”Ÿæˆçš„redoæ—¥å¿—å ç”¨çš„å­—èŠ‚æ•°ï¼Œå°±åƒè¿™æ ·ï¼šæˆ‘ä»¬å‡è®¾ä¸Šå›¾ä¸­mtr_1äº§ç”Ÿçš„redoæ—¥å¿—é‡ä¸º200å­—èŠ‚ï¼Œé‚£ä¹ˆlsnå°±è¦åœ¨8716çš„åŸºç¡€ä¸Šå¢åŠ 200ï¼Œå˜ä¸º8916ã€‚ å¦‚æœæŸä¸ªmträº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å ç”¨çš„å­˜å‚¨ç©ºé—´æ¯”è¾ƒå¤§ï¼Œä¹Ÿå°±æ˜¯å¾…æ’å…¥çš„blockå‰©ä½™ç©ºé—²ç©ºé—´ä¸è¶³ä»¥å®¹çº³è¿™ä¸ªmtræäº¤çš„æ—¥å¿—æ—¶ï¼Œlsnå¢é•¿çš„é‡å°±æ˜¯è¯¥mtrç”Ÿæˆçš„redoæ—¥å¿—å ç”¨çš„å­—èŠ‚æ•°åŠ ä¸Šé¢å¤–å ç”¨çš„log block headerå’Œlog block trailerçš„å­—èŠ‚æ•°ï¼Œå°±åƒè¿™æ ·ï¼šæˆ‘ä»¬å‡è®¾ä¸Šå›¾ä¸­mtr_2äº§ç”Ÿçš„redoæ—¥å¿—é‡ä¸º1000å­—èŠ‚ï¼Œä¸ºäº†å°†mtr_2äº§ç”Ÿçš„redoæ—¥å¿—å†™å…¥log bufferï¼Œæˆ‘ä»¬ä¸å¾—ä¸é¢å¤–å¤šåˆ†é…ä¸¤ä¸ªblockï¼Œæ‰€ä»¥lsnçš„å€¼éœ€è¦åœ¨8916çš„åŸºç¡€ä¸Šå¢åŠ 1000 + 12Ã—2 + 4 Ã— 2 = 1032ã€‚ ä»ä¸Šè¾¹çš„æè¿°ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯ä¸€ç»„ç”±mtrç”Ÿæˆçš„redoæ—¥å¿—éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„LSNå€¼ä¸å…¶å¯¹åº”ï¼ŒLSNå€¼è¶Šå°ï¼Œè¯´æ˜redoæ—¥å¿—äº§ç”Ÿçš„è¶Šæ—©ã€‚ 1.flushed_to_disk_lsnredoæ—¥å¿—æ˜¯é¦–å…ˆå†™åˆ°log bufferä¸­ï¼Œä¹‹åæ‰ä¼šè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸Šçš„redoæ—¥å¿—æ–‡ä»¶ã€‚æ‰€ä»¥InnoDBæå‡ºäº†ä¸€ä¸ªç§°ä¹‹ä¸ºbuf_next_to_writeçš„å…¨å±€å˜é‡ï¼Œæ ‡è®°å½“å‰log bufferä¸­å·²ç»æœ‰å“ªäº›æ—¥å¿—è¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­äº†ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºå°±æ˜¯è¿™æ ·ï¼š lsnæ˜¯è¡¨ç¤ºå½“å‰ç³»ç»Ÿä¸­å†™å…¥çš„redoæ—¥å¿—é‡ï¼Œè¿™åŒ…æ‹¬äº†å†™åˆ°log bufferè€Œæ²¡æœ‰åˆ·æ–°åˆ°ç£ç›˜çš„æ—¥å¿—ï¼Œç›¸åº”çš„ï¼ŒInnoDBæå‡ºäº†ä¸€ä¸ªè¡¨ç¤ºåˆ·æ–°åˆ°ç£ç›˜ä¸­çš„redoæ—¥å¿—é‡çš„å…¨å±€å˜é‡ï¼Œç§°ä¹‹ä¸ºflushed_to_disk_lsnã€‚ç³»ç»Ÿç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œè¯¥å˜é‡çš„å€¼å’Œåˆå§‹çš„lsnå€¼æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯8704ã€‚éšç€ç³»ç»Ÿçš„è¿è¡Œï¼Œredoæ—¥å¿—è¢«ä¸æ–­å†™å…¥log bufferï¼Œä½†æ˜¯å¹¶ä¸ä¼šç«‹å³åˆ·æ–°åˆ°ç£ç›˜ï¼Œlsnçš„å€¼å°±å’Œflushed_to_disk_lsnçš„å€¼æ‹‰å¼€äº†å·®è·ã€‚æˆ‘ä»¬æ¨ç†ä¸€ä¸‹ï¼š ç³»ç»Ÿç¬¬ä¸€æ¬¡å¯åŠ¨åï¼Œå‘log bufferä¸­å†™å…¥äº†mtr_1ã€mtr_2ã€mtr_3è¿™ä¸‰ä¸ªmträº§ç”Ÿçš„redoæ—¥å¿—ï¼Œå‡è®¾è¿™ä¸‰ä¸ªmtrå¼€å§‹å’Œç»“æŸæ—¶å¯¹åº”çš„lsnå€¼åˆ†åˆ«æ˜¯ï¼š mtr_1ï¼š8716 ï½ 8916 mtr_2ï¼š8916 ï½ 9948 mtr_3ï¼š9948 ï½ 10000 æ­¤æ—¶çš„lsnå·²ç»å¢é•¿åˆ°äº†10000ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰åˆ·æ–°æ“ä½œï¼Œæ‰€ä»¥æ­¤æ—¶flushed_to_disk_lsnçš„å€¼ä»ä¸º8704ï¼Œå¦‚å›¾ï¼š éšåè¿›è¡Œå°†log bufferä¸­çš„blockåˆ·æ–°åˆ°redoæ—¥å¿—æ–‡ä»¶çš„æ“ä½œï¼Œå‡è®¾å°†mtr_1å’Œmtr_2çš„æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆflushed_to_disk_lsnå°±åº”è¯¥å¢é•¿mtr_1å’Œmtr_2å†™å…¥çš„æ—¥å¿—é‡ï¼Œæ‰€ä»¥flushed_to_disk_lsnçš„å€¼å¢é•¿åˆ°äº†9948ï¼Œå¦‚å›¾ï¼š ç»¼ä¸Šæ‰€è¿°ï¼Œå½“æœ‰æ–°çš„redoæ—¥å¿—å†™å…¥åˆ°log bufferæ—¶ï¼Œé¦–å…ˆlsnçš„å€¼ä¼šå¢é•¿ï¼Œä½†flushed_to_disk_lsnä¸å˜ï¼Œéšåéšç€ä¸æ–­æœ‰log bufferä¸­çš„æ—¥å¿—è¢«åˆ·æ–°åˆ°ç£ç›˜ä¸Šï¼Œflushed_to_disk_lsnçš„å€¼ä¹Ÿè·Ÿç€å¢é•¿ã€‚å¦‚æœä¸¤è€…çš„å€¼ç›¸åŒæ—¶ï¼Œè¯´æ˜log bufferä¸­çš„æ‰€æœ‰redoæ—¥å¿—éƒ½å·²ç»åˆ·æ–°åˆ°ç£ç›˜ä¸­äº†ã€‚ åº”ç”¨ç¨‹åºå‘ç£ç›˜å†™å…¥æ–‡ä»¶æ—¶å…¶å®æ˜¯å…ˆå†™åˆ°æ“ä½œç³»ç»Ÿçš„ç¼“å†²åŒºä¸­å»ï¼Œå¦‚æœæŸä¸ªå†™å…¥æ“ä½œè¦ç­‰åˆ°æ“ä½œç³»ç»Ÿç¡®è®¤å·²ç»å†™åˆ°ç£ç›˜æ—¶æ‰è¿”å›ï¼Œé‚£éœ€è¦è°ƒç”¨ä¸€ä¸‹æ“ä½œç³»ç»Ÿæä¾›çš„fsyncå‡½æ•°ã€‚å…¶å®åªæœ‰å½“ç³»ç»Ÿæ‰§è¡Œäº†fsyncå‡½æ•°åï¼Œflushed_to_disk_lsnçš„å€¼æ‰ä¼šè·Ÿç€å¢é•¿ï¼Œå½“ä»…ä»…æŠŠlog bufferä¸­çš„æ—¥å¿—å†™å…¥åˆ°æ“ä½œç³»ç»Ÿç¼“å†²åŒºå´æ²¡æœ‰æ˜¾å¼çš„åˆ·æ–°åˆ°ç£ç›˜æ—¶ï¼Œå¦å¤–çš„ä¸€ä¸ªç§°ä¹‹ä¸ºwrite_lsnçš„å€¼è·Ÿç€å¢é•¿ã€‚ 2.lsnå€¼å’Œredoæ—¥å¿—æ–‡ä»¶åç§»é‡çš„å¯¹åº”å…³ç³»å› ä¸ºlsnçš„å€¼æ˜¯ä»£è¡¨ç³»ç»Ÿå†™å…¥çš„redoæ—¥å¿—é‡çš„ä¸€ä¸ªæ€»å’Œï¼Œä¸€ä¸ªmträ¸­äº§ç”Ÿå¤šå°‘æ—¥å¿—ï¼Œlsnçš„å€¼å°±å¢åŠ å¤šå°‘ï¼ˆå½“ç„¶æœ‰æ—¶å€™è¦åŠ ä¸Šlog block headerå’Œlog block trailerçš„å¤§å°ï¼‰ï¼Œè¿™æ ·mträº§ç”Ÿçš„æ—¥å¿—å†™åˆ°ç£ç›˜ä¸­æ—¶ï¼Œå¾ˆå®¹æ˜“è®¡ç®—æŸä¸€ä¸ªlsnå€¼åœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„åç§»é‡ï¼Œå¦‚å›¾ï¼š åˆå§‹æ—¶çš„LSNå€¼æ˜¯8704ï¼Œå¯¹åº”æ–‡ä»¶åç§»é‡2048ï¼Œä¹‹åæ¯ä¸ªmtrå‘ç£ç›˜ä¸­å†™å…¥å¤šå°‘å­—èŠ‚æ—¥å¿—ï¼Œlsnçš„å€¼å°±å¢é•¿å¤šå°‘ã€‚ 3.flushé“¾è¡¨ä¸­çš„LSNä¸€ä¸ªmträ»£è¡¨ä¸€æ¬¡å¯¹åº•å±‚é¡µé¢çš„åŸå­è®¿é—®ï¼Œåœ¨è®¿é—®è¿‡ç¨‹ä¸­å¯èƒ½ä¼šäº§ç”Ÿä¸€ç»„ä¸å¯åˆ†å‰²çš„redoæ—¥å¿—ï¼Œåœ¨mtrç»“æŸæ—¶ï¼Œä¼šæŠŠè¿™ä¸€ç»„redoæ—¥å¿—å†™å…¥åˆ°log bufferä¸­ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨mtrç»“æŸæ—¶è¿˜æœ‰ä¸€ä»¶éå¸¸é‡è¦çš„äº‹æƒ…è¦åšï¼Œå°±æ˜¯æŠŠåœ¨mtræ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¿®æ”¹è¿‡çš„é¡µé¢åŠ å…¥åˆ°Buffer Poolçš„flushé“¾è¡¨ã€‚ å½“ç¬¬ä¸€æ¬¡ä¿®æ”¹æŸä¸ªç¼“å­˜åœ¨Buffer Poolä¸­çš„é¡µé¢æ—¶ï¼Œå°±ä¼šæŠŠè¿™ä¸ªé¡µé¢å¯¹åº”çš„æ§åˆ¶å—æ’å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨ï¼Œä¹‹åå†ä¿®æ”¹è¯¥é¡µé¢æ—¶ç”±äºå®ƒå·²ç»åœ¨flushé“¾è¡¨ä¸­äº†ï¼Œå°±ä¸å†æ¬¡æ’å…¥äº†ã€‚ä¹Ÿå°±æ˜¯è¯´flushé“¾è¡¨ä¸­çš„è„é¡µæ˜¯æŒ‰ç…§é¡µé¢çš„ç¬¬ä¸€æ¬¡ä¿®æ”¹æ—¶é—´ä»å¤§åˆ°å°è¿›è¡Œæ’åºçš„ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šåœ¨ç¼“å­˜é¡µå¯¹åº”çš„æ§åˆ¶å—ä¸­è®°å½•ä¸¤ä¸ªå…³äºé¡µé¢ä½•æ—¶ä¿®æ”¹çš„å±æ€§ï¼š oldest_modificationï¼šå¦‚æœæŸä¸ªé¡µé¢è¢«åŠ è½½åˆ°Buffer Poolåè¿›è¡Œç¬¬ä¸€æ¬¡ä¿®æ”¹ï¼Œé‚£ä¹ˆå°±å°†ä¿®æ”¹è¯¥é¡µé¢çš„mtrå¼€å§‹æ—¶å¯¹åº”çš„lsnå€¼å†™å…¥è¿™ä¸ªå±æ€§ã€‚ newest_modificationï¼šæ¯ä¿®æ”¹ä¸€æ¬¡é¡µé¢ï¼Œéƒ½ä¼šå°†ä¿®æ”¹è¯¥é¡µé¢çš„mtrç»“æŸæ—¶å¯¹åº”çš„lsnå€¼å†™å…¥è¿™ä¸ªå±æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´è¯¥å±æ€§è¡¨ç¤ºé¡µé¢æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹åå¯¹åº”çš„ç³»ç»Ÿlsnå€¼ã€‚ æ¥ç€ä¸Šè¾¹flushed_to_disk_lsnçš„ä¾‹å­çœ‹ä¸€ä¸‹ï¼š å‡è®¾mtr_1æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹äº†é¡µaï¼Œé‚£ä¹ˆåœ¨mtr_1æ‰§è¡Œç»“æŸæ—¶ï¼Œå°±ä¼šå°†é¡µaå¯¹åº”çš„æ§åˆ¶å—åŠ å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨ã€‚å¹¶ä¸”å°†mtr_1å¼€å§‹æ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯8716å†™å…¥é¡µaå¯¹åº”çš„æ§åˆ¶å—çš„oldest_modificationå±æ€§ä¸­ï¼ŒæŠŠmtr_1ç»“æŸæ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯8916å†™å…¥é¡µaå¯¹åº”çš„æ§åˆ¶å—çš„newest_modificationå±æ€§ä¸­ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹ï¼ˆoldest_modificationç¼©å†™æˆäº†o_mï¼Œnewest_modificationç¼©å†™æˆäº†n_mï¼‰ï¼š æ¥ç€å‡è®¾mtr_2æ‰§è¡Œè¿‡ç¨‹ä¸­åˆä¿®æ”¹äº†é¡µbå’Œé¡µcä¸¤ä¸ªé¡µé¢ï¼Œé‚£ä¹ˆåœ¨mtr_2æ‰§è¡Œç»“æŸæ—¶ï¼Œå°±ä¼šå°†é¡µbå’Œé¡µcå¯¹åº”çš„æ§åˆ¶å—éƒ½åŠ å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨ã€‚å¹¶ä¸”å°†mtr_2å¼€å§‹æ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯8916å†™å…¥é¡µbå’Œé¡µcå¯¹åº”çš„æ§åˆ¶å—çš„oldest_modificationå±æ€§ä¸­ï¼ŒæŠŠmtr_2ç»“æŸæ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯9948å†™å…¥é¡µbå’Œé¡µcå¯¹åº”çš„æ§åˆ¶å—çš„newest_modificationå±æ€§ä¸­ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹ï¼šä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯æ¬¡æ–°æ’å…¥åˆ°flushé“¾è¡¨ä¸­çš„èŠ‚ç‚¹éƒ½æ˜¯è¢«æ”¾åœ¨äº†å¤´éƒ¨ï¼Œä¹Ÿå°±æ˜¯è¯´flushé“¾è¡¨ä¸­å‰è¾¹çš„è„é¡µä¿®æ”¹çš„æ—¶é—´æ¯”è¾ƒæ™šï¼Œåè¾¹çš„è„é¡µä¿®æ”¹æ—¶é—´æ¯”è¾ƒæ—©ã€‚ æ¥ç€å‡è®¾mtr_3æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹äº†é¡µbå’Œé¡µdï¼Œä¸è¿‡é¡µbä¹‹å‰å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œæ‰€ä»¥å®ƒå¯¹åº”çš„æ§åˆ¶å—å·²ç»è¢«æ’å…¥åˆ°äº†flushé“¾è¡¨ï¼Œæ‰€ä»¥åœ¨mtr_3æ‰§è¡Œç»“æŸæ—¶ï¼Œåªéœ€è¦å°†é¡µdå¯¹åº”çš„æ§åˆ¶å—éƒ½åŠ å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨å³å¯ã€‚æ‰€ä»¥éœ€è¦å°†mtr_3å¼€å§‹æ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯9948å†™å…¥é¡µdå¯¹åº”çš„æ§åˆ¶å—çš„oldest_modificationå±æ€§ä¸­ï¼ŒæŠŠmtr_3ç»“æŸæ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯10000å†™å…¥é¡µdå¯¹åº”çš„æ§åˆ¶å—çš„newest_modificationå±æ€§ä¸­ã€‚å¦å¤–ï¼Œç”±äºé¡µbåœ¨mtr_3æ‰§è¡Œè¿‡ç¨‹ä¸­åˆå‘ç”Ÿäº†ä¸€æ¬¡ä¿®æ”¹ï¼Œæ‰€ä»¥éœ€è¦æ›´æ–°é¡µbå¯¹åº”çš„æ§åˆ¶å—ä¸­newest_modificationçš„å€¼ä¸º10000ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹ï¼š æ€»ç»“ä¸€ä¸‹ä¸Šè¾¹è¯´çš„ï¼Œå°±æ˜¯ï¼šflushé“¾è¡¨ä¸­çš„è„é¡µæŒ‰ç…§ä¿®æ”¹å‘ç”Ÿçš„æ—¶é—´é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§oldest_modificationä»£è¡¨çš„LSNå€¼è¿›è¡Œæ’åºï¼Œè¢«å¤šæ¬¡æ›´æ–°çš„é¡µé¢ä¸ä¼šé‡å¤æ’å…¥åˆ°flushé“¾è¡¨ä¸­ï¼Œä½†æ˜¯ä¼šæ›´æ–°newest_modificationå±æ€§çš„å€¼ã€‚ ä¸ƒï¼Œcheckpointredoæ—¥å¿—æ–‡ä»¶ç»„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œæˆ‘ä»¬ä¸å¾—ä¸é€‰æ‹©å¾ªç¯ä½¿ç”¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„æ–‡ä»¶ï¼Œä½†æ˜¯è¿™ä¼šé€ æˆæœ€åå†™çš„redoæ—¥å¿—ä¸æœ€å¼€å§‹å†™çš„redoæ—¥å¿—è¿½å°¾ï¼Œè¿™æ—¶åº”è¯¥æƒ³åˆ°ï¼šredoæ—¥å¿—åªæ˜¯ä¸ºäº†ç³»ç»Ÿå´©æºƒåæ¢å¤è„é¡µç”¨çš„ï¼Œå¦‚æœå¯¹åº”çš„è„é¡µå·²ç»åˆ·æ–°åˆ°äº†ç£ç›˜ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿ç°åœ¨ç³»ç»Ÿå´©æºƒï¼Œé‚£ä¹ˆåœ¨é‡å¯åä¹Ÿç”¨ä¸ç€ä½¿ç”¨redoæ—¥å¿—æ¢å¤è¯¥é¡µé¢äº†ï¼Œæ‰€ä»¥è¯¥redoæ—¥å¿—ä¹Ÿå°±æ²¡æœ‰å­˜åœ¨çš„å¿…è¦äº†ï¼Œé‚£ä¹ˆå®ƒå ç”¨çš„ç£ç›˜ç©ºé—´å°±å¯ä»¥è¢«åç»­çš„redoæ—¥å¿—æ‰€é‡ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼šåˆ¤æ–­æŸäº›redoæ—¥å¿—å ç”¨çš„ç£ç›˜ç©ºé—´æ˜¯å¦å¯ä»¥è¦†ç›–çš„ä¾æ®å°±æ˜¯å®ƒå¯¹åº”çš„è„é¡µæ˜¯å¦å·²ç»åˆ·æ–°åˆ°ç£ç›˜é‡Œã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹å‰è¾¹çš„é‚£ä¸ªä¾‹å­ï¼š å¦‚å›¾ï¼Œè™½ç„¶mtr_1å’Œmtr_2ç”Ÿæˆçš„redoæ—¥å¿—éƒ½å·²ç»è¢«å†™åˆ°äº†ç£ç›˜ä¸Šï¼Œä½†æ˜¯å®ƒä»¬ä¿®æ”¹çš„è„é¡µä»ç„¶ç•™åœ¨Buffer Poolä¸­ï¼Œæ‰€ä»¥å®ƒä»¬ç”Ÿæˆçš„redoæ—¥å¿—åœ¨ç£ç›˜ä¸Šçš„ç©ºé—´æ˜¯ä¸å¯ä»¥è¢«è¦†ç›–çš„ã€‚ä¹‹åéšç€ç³»ç»Ÿçš„è¿è¡Œï¼Œå¦‚æœé¡µaè¢«åˆ·æ–°åˆ°äº†ç£ç›˜ï¼Œé‚£ä¹ˆå®ƒå¯¹åº”çš„æ§åˆ¶å—å°±ä¼šä»flushé“¾è¡¨ä¸­ç§»é™¤ï¼Œå°±åƒè¿™æ ·å­ï¼š è¿™æ ·mtr_1ç”Ÿæˆçš„redoæ—¥å¿—å°±æ²¡æœ‰ç”¨äº†ï¼Œå®ƒä»¬å ç”¨çš„ç£ç›˜ç©ºé—´å°±å¯ä»¥è¢«è¦†ç›–æ‰äº†ã€‚InnoDBæå‡ºäº†ä¸€ä¸ªå…¨å±€å˜é‡checkpoint_lsnæ¥ä»£è¡¨å½“å‰ç³»ç»Ÿä¸­å¯ä»¥è¢«è¦†ç›–çš„redoæ—¥å¿—æ€»é‡æ˜¯å¤šå°‘ï¼Œè¿™ä¸ªå˜é‡åˆå§‹å€¼ä¹Ÿæ˜¯8704ã€‚ æ¯”æ–¹è¯´ç°åœ¨é¡µaè¢«åˆ·æ–°åˆ°äº†ç£ç›˜ï¼Œmtr_1ç”Ÿæˆçš„redoæ—¥å¿—å°±å¯ä»¥è¢«è¦†ç›–äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€ä¸ªå¢åŠ checkpoint_lsnçš„æ“ä½œï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªè¿‡ç¨‹ç§°ä¹‹ä¸ºåšä¸€æ¬¡checkpointã€‚åšä¸€æ¬¡checkpointå…¶å®å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š æ­¥éª¤ä¸€ï¼šè®¡ç®—ä¸€ä¸‹å½“å‰ç³»ç»Ÿä¸­å¯ä»¥è¢«è¦†ç›–çš„redoæ—¥å¿—å¯¹åº”çš„lsnå€¼æœ€å¤§æ˜¯å¤šå°‘ã€‚redoæ—¥å¿—å¯ä»¥è¢«è¦†ç›–ï¼Œæ„å‘³ç€å®ƒå¯¹åº”çš„è„é¡µè¢«åˆ·åˆ°äº†ç£ç›˜ï¼Œåªè¦æˆ‘ä»¬è®¡ç®—å‡ºå½“å‰ç³»ç»Ÿä¸­è¢«æœ€æ—©ä¿®æ”¹çš„è„é¡µå¯¹åº”çš„oldest_modificationå€¼ï¼Œé‚£å‡¡æ˜¯åœ¨ç³»ç»Ÿlsnå€¼å°äºè¯¥èŠ‚ç‚¹çš„oldest_modificationå€¼æ—¶äº§ç”Ÿçš„redoæ—¥å¿—éƒ½æ˜¯å¯ä»¥è¢«è¦†ç›–æ‰çš„ï¼Œæˆ‘ä»¬å°±æŠŠè¯¥è„é¡µçš„oldest_modificationèµ‹å€¼ç»™checkpoint_lsnã€‚æ¯”æ–¹è¯´å½“å‰ç³»ç»Ÿä¸­é¡µaå·²ç»è¢«åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆflushé“¾è¡¨çš„å°¾èŠ‚ç‚¹å°±æ˜¯é¡µcï¼Œè¯¥èŠ‚ç‚¹å°±æ˜¯å½“å‰ç³»ç»Ÿä¸­æœ€æ—©ä¿®æ”¹çš„è„é¡µäº†ï¼Œå®ƒçš„oldest_modificationå€¼ä¸º8916ï¼Œæˆ‘ä»¬å°±æŠŠ8916èµ‹å€¼ç»™checkpoint_lsnï¼ˆä¹Ÿå°±æ˜¯è¯´åœ¨redoæ—¥å¿—å¯¹åº”çš„lsnå€¼å°äº8916æ—¶å°±å¯ä»¥è¢«è¦†ç›–æ‰ï¼‰ã€‚ æ­¥éª¤äºŒï¼šå°†checkpoint_lsnå’Œå¯¹åº”çš„redoæ—¥å¿—æ–‡ä»¶ç»„åç§»é‡ä»¥åŠæ­¤æ¬¡checkpintçš„ç¼–å·å†™åˆ°æ—¥å¿—æ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ï¼ˆå°±æ˜¯checkpoint1æˆ–è€…checkpoint2ï¼‰ä¸­ã€‚InnoDBç»´æŠ¤äº†ä¸€ä¸ªç›®å‰ç³»ç»Ÿåšäº†å¤šå°‘æ¬¡checkpointçš„å˜é‡checkpoint_noï¼Œæ¯åšä¸€æ¬¡checkpointï¼Œè¯¥å˜é‡çš„å€¼å°±åŠ 1ã€‚æˆ‘ä»¬å‰è¾¹è¯´è¿‡è®¡ç®—ä¸€ä¸ªlsnå€¼å¯¹åº”çš„redoæ—¥å¿—æ–‡ä»¶ç»„åç§»é‡æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œæ‰€ä»¥å¯ä»¥è®¡ç®—å¾—åˆ°è¯¥checkpoint_lsnåœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­å¯¹åº”çš„åç§»é‡checkpoint_offsetï¼Œç„¶åæŠŠè¿™ä¸‰ä¸ªå€¼éƒ½å†™åˆ°redoæ—¥å¿—æ–‡ä»¶ç»„çš„ç®¡ç†ä¿¡æ¯ä¸­ã€‚æˆ‘ä»¬è¯´è¿‡ï¼Œæ¯ä¸€ä¸ªredoæ—¥å¿—æ–‡ä»¶éƒ½æœ‰2048ä¸ªå­—èŠ‚çš„ç®¡ç†ä¿¡æ¯ï¼Œä½†æ˜¯ä¸Šè¿°å…³äºcheckpointçš„ä¿¡æ¯åªä¼šè¢«å†™åˆ°æ—¥å¿—æ–‡ä»¶ç»„çš„ç¬¬ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­ã€‚ä¸è¿‡æˆ‘ä»¬æ˜¯å­˜å‚¨åˆ°checkpoint1ä¸­è¿˜æ˜¯checkpoint2ä¸­å‘¢ï¼ŸInnoDBè§„å®šï¼Œå½“checkpoint_noçš„å€¼æ˜¯å¶æ•°æ—¶ï¼Œå°±å†™åˆ°checkpoint1ä¸­ï¼Œæ˜¯å¥‡æ•°æ—¶ï¼Œå°±å†™åˆ°checkpoint2ä¸­ã€‚ è®°å½•å®Œcheckpointçš„ä¿¡æ¯ä¹‹åï¼Œredoæ—¥å¿—æ–‡ä»¶ç»„ä¸­å„ä¸ªlsnå€¼çš„å…³ç³»å°±åƒè¿™æ ·ï¼š 1.æ‰¹é‡ä»flushé“¾è¡¨ä¸­åˆ·å‡ºè„é¡µä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯åå°çš„çº¿ç¨‹åœ¨å¯¹LRUé“¾è¡¨å’Œflushé“¾è¡¨è¿›è¡Œåˆ·è„æ“ä½œï¼Œè¿™ä¸»è¦å› ä¸ºåˆ·è„æ“ä½œæ¯”è¾ƒæ…¢ï¼Œä¸æƒ³å½±å“ç”¨æˆ·çº¿ç¨‹å¤„ç†è¯·æ±‚ã€‚ä½†æ˜¯å¦‚æœå½“å‰ç³»ç»Ÿä¿®æ”¹é¡µé¢çš„æ“ä½œååˆ†é¢‘ç¹ï¼Œè¿™æ ·å°±å¯¼è‡´å†™æ—¥å¿—æ“ä½œååˆ†é¢‘ç¹ï¼Œç³»ç»Ÿlsnå€¼å¢é•¿è¿‡å¿«ã€‚å¦‚æœåå°çš„åˆ·è„æ“ä½œä¸èƒ½å°†è„é¡µåˆ·å‡ºï¼Œé‚£ä¹ˆç³»ç»Ÿæ— æ³•åŠæ—¶åšcheckpointï¼Œå¯èƒ½å°±éœ€è¦ç”¨æˆ·çº¿ç¨‹åŒæ­¥çš„ä»flushé“¾è¡¨ä¸­æŠŠé‚£äº›æœ€æ—©ä¿®æ”¹çš„è„é¡µï¼ˆoldest_modificationæœ€å°çš„è„é¡µï¼‰åˆ·æ–°åˆ°ç£ç›˜ï¼Œè¿™æ ·è¿™äº›è„é¡µå¯¹åº”çš„redoæ—¥å¿—å°±æ²¡ç”¨äº†ï¼Œç„¶åå°±å¯ä»¥å»åšcheckpointäº†ã€‚ 2.æŸ¥çœ‹ç³»ç»Ÿä¸­çš„å„ç§LSNå€¼æˆ‘ä»¬å¯ä»¥ä½¿ç”¨SHOW ENGINE INNODB STATUSå‘½ä»¤æŸ¥çœ‹å½“å‰InnoDBå­˜å‚¨å¼•æ“ä¸­çš„å„ç§LSNå€¼çš„æƒ…å†µï¼Œæ¯”å¦‚ï¼š 12345678910111213mysql&gt; SHOW ENGINE INNODB STATUS\\G(...çœç•¥å‰è¾¹çš„è®¸å¤šçŠ¶æ€)LOG---Log sequence number 124476971Log flushed up to 124099769Pages flushed up to 124052503Last checkpoint at 1240524940 pending log flushes, 0 pending chkp writes24 log i/o&#x27;s done, 2.00 log i/o&#x27;s/second----------------------(...çœç•¥åè¾¹çš„è®¸å¤šçŠ¶æ€) å…¶ä¸­ï¼š Log sequence numberï¼šä»£è¡¨ç³»ç»Ÿä¸­çš„lsnå€¼ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç³»ç»Ÿå·²ç»å†™å…¥çš„redoæ—¥å¿—é‡ï¼ŒåŒ…æ‹¬å†™å…¥log bufferä¸­çš„æ—¥å¿—ã€‚ Log flushed up toï¼šä»£è¡¨flushed_to_disk_lsnçš„å€¼ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç³»ç»Ÿå·²ç»å†™å…¥ç£ç›˜çš„redoæ—¥å¿—é‡ã€‚ Pages flushed up toï¼šä»£è¡¨flushé“¾è¡¨ä¸­è¢«æœ€æ—©ä¿®æ”¹çš„é‚£ä¸ªé¡µé¢å¯¹åº”çš„oldest_modificationå±æ€§å€¼ã€‚ Last checkpoint atï¼šå½“å‰ç³»ç»Ÿçš„checkpoint_lsnå€¼ã€‚ 3.innodb_flush_log_at_trx_commitçš„ç”¨æ³•ä¸ºäº†ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œç”¨æˆ·çº¿ç¨‹åœ¨äº‹åŠ¡æäº¤æ—¶éœ€è¦å°†è¯¥äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ‰€æœ‰redoæ—¥å¿—éƒ½åˆ·æ–°åˆ°ç£ç›˜ä¸Šã€‚è¿™ä¸€æ¡è¦æ±‚å¤ªç‹ äº†ï¼Œä¼šå¾ˆæ˜æ˜¾çš„é™ä½æ•°æ®åº“æ€§èƒ½ã€‚å¦‚æœå¯¹äº‹åŠ¡çš„æŒä¹…æ€§è¦æ±‚ä¸æ˜¯é‚£ä¹ˆå¼ºçƒˆçš„è¯ï¼Œå¯ä»¥é€‰æ‹©ä¿®æ”¹ä¸€ä¸ªç§°ä¸ºinnodb_flush_log_at_trx_commitçš„ç³»ç»Ÿå˜é‡çš„å€¼ï¼Œè¯¥å˜é‡æœ‰3ä¸ªå¯é€‰çš„å€¼ï¼š 0ï¼šå½“è¯¥ç³»ç»Ÿå˜é‡å€¼ä¸º0æ—¶ï¼Œè¡¨ç¤ºåœ¨äº‹åŠ¡æäº¤æ—¶ä¸ç«‹å³å‘ç£ç›˜ä¸­åŒæ­¥redoæ—¥å¿—ï¼Œè¿™ä¸ªä»»åŠ¡æ˜¯äº¤ç»™åå°çº¿ç¨‹åšçš„ã€‚è¿™æ ·å¾ˆæ˜æ˜¾ä¼šåŠ å¿«è¯·æ±‚å¤„ç†é€Ÿåº¦ï¼Œä½†æ˜¯å¦‚æœäº‹åŠ¡æäº¤åæœåŠ¡å™¨æŒ‚äº†ï¼Œåå°çº¿ç¨‹æ²¡æœ‰åŠæ—¶å°†redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆè¯¥äº‹åŠ¡å¯¹é¡µé¢çš„ä¿®æ”¹ä¼šä¸¢å¤±ã€‚ 1ï¼šå½“è¯¥ç³»ç»Ÿå˜é‡å€¼ä¸º1æ—¶ï¼Œè¡¨ç¤ºåœ¨äº‹åŠ¡æäº¤æ—¶éœ€è¦å°†redoæ—¥å¿—åŒæ­¥åˆ°ç£ç›˜ï¼Œå¯ä»¥ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ã€‚1ä¹Ÿæ˜¯innodb_flush_log_at_trx_commitçš„é»˜è®¤å€¼ã€‚ 2ï¼šå½“è¯¥ç³»ç»Ÿå˜é‡å€¼ä¸º2æ—¶ï¼Œè¡¨ç¤ºåœ¨äº‹åŠ¡æäº¤æ—¶éœ€è¦å°†redoæ—¥å¿—å†™åˆ°æ“ä½œç³»ç»Ÿçš„ç¼“å†²åŒºä¸­ï¼Œä½†å¹¶ä¸éœ€è¦ä¿è¯å°†æ—¥å¿—çœŸæ­£çš„åˆ·æ–°åˆ°ç£ç›˜ã€‚è¿™ç§æƒ…å†µä¸‹å¦‚æœæ•°æ®åº“æŒ‚äº†ï¼Œæ“ä½œç³»ç»Ÿæ²¡æŒ‚çš„è¯ï¼Œäº‹åŠ¡çš„æŒä¹…æ€§è¿˜æ˜¯å¯ä»¥ä¿è¯çš„ï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿä¹ŸæŒ‚äº†çš„è¯ï¼Œé‚£å°±ä¸èƒ½ä¿è¯æŒä¹…æ€§äº†ã€‚ å…«ï¼Œå´©æºƒæ¢å¤åœ¨æœåŠ¡å™¨ä¸æŒ‚çš„æƒ…å†µä¸‹ï¼Œredoæ—¥å¿—ä¸ä»…æ²¡ç”¨ï¼Œåè€Œè®©æ€§èƒ½å˜å¾—æ›´å·®ã€‚ä½†æ˜¯ä¸‡ä¸€æ•°æ®åº“æŒ‚äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨é‡å¯æ—¶æ ¹æ®redoæ—¥å¿—ä¸­çš„è®°å½•å°±å¯ä»¥å°†é¡µé¢æ¢å¤åˆ°ç³»ç»Ÿå´©æºƒå‰çš„çŠ¶æ€ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥å¤§è‡´çœ‹ä¸€ä¸‹æ¢å¤è¿‡ç¨‹ã€‚ 1.ç¡®å®šæ¢å¤çš„èµ·ç‚¹checkpoint_lsnä¹‹å‰çš„redoæ—¥å¿—éƒ½å¯ä»¥è¢«è¦†ç›–ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›redoæ—¥å¿—å¯¹åº”çš„è„é¡µéƒ½å·²ç»è¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­äº†ï¼Œæ—¢ç„¶å®ƒä»¬å·²ç»è¢«åˆ·ç›˜ï¼Œæˆ‘ä»¬å°±æ²¡å¿…è¦æ¢å¤å®ƒä»¬äº†ã€‚å¯¹äºcheckpoint_lsnä¹‹åçš„redoæ—¥å¿—ï¼Œå®ƒä»¬å¯¹åº”çš„è„é¡µå¯èƒ½æ²¡è¢«åˆ·ç›˜ï¼Œä¹Ÿå¯èƒ½è¢«åˆ·ç›˜äº†ï¼Œæˆ‘ä»¬ä¸èƒ½ç¡®å®šï¼Œæ‰€ä»¥éœ€è¦ä»checkpoint_lsnå¼€å§‹è¯»å–redoæ—¥å¿—æ¥æ¢å¤é¡µé¢ã€‚ å½“ç„¶ï¼Œredoæ—¥å¿—æ–‡ä»¶ç»„çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­æœ‰ä¸¤ä¸ªblockéƒ½å­˜å‚¨äº†checkpoint_lsnçš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å½“ç„¶æ˜¯è¦é€‰å–æœ€è¿‘å‘ç”Ÿçš„é‚£æ¬¡checkpointçš„ä¿¡æ¯ã€‚è¡¡é‡checkpointå‘ç”Ÿæ—¶é—´æ—©æ™šçš„ä¿¡æ¯å°±æ˜¯æ‰€è°“çš„checkpoint_noï¼Œåªè¦æŠŠcheckpoint1å’Œcheckpoint2è¿™ä¸¤ä¸ªblockä¸­çš„checkpoint_noå€¼è¯»å‡ºæ¥æ¯”ä¸€ä¸‹å¤§å°ï¼Œå“ªä¸ªçš„checkpoint_noå€¼æ›´å¤§ï¼Œè¯´æ˜å“ªä¸ªblockå­˜å‚¨çš„å°±æ˜¯æœ€è¿‘çš„ä¸€æ¬¡checkpointä¿¡æ¯ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½æ‹¿åˆ°æœ€è¿‘å‘ç”Ÿçš„checkpointå¯¹åº”çš„checkpoint_lsnå€¼ä»¥åŠå®ƒåœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„åç§»é‡checkpoint_offsetã€‚ 2.ç¡®å®šæ¢å¤çš„ç»ˆç‚¹redoæ—¥å¿—æ¢å¤çš„èµ·ç‚¹ç¡®å®šäº†ï¼Œé‚£ç»ˆç‚¹æ˜¯å“ªä¸ªå‘¢ï¼Ÿè¿™ä¸ªè¿˜å¾—ä»blockçš„ç»“æ„è¯´èµ·ã€‚åœ¨å†™redoæ—¥å¿—çš„æ—¶å€™éƒ½æ˜¯é¡ºåºå†™çš„ï¼Œå†™æ»¡äº†ä¸€ä¸ªblockä¹‹åä¼šå†å¾€ä¸‹ä¸€ä¸ªblockä¸­å†™ã€‚ æ™®é€šblockçš„log block headeréƒ¨åˆ†æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºLOG_BLOCK_HDR_DATA_LENçš„å±æ€§ï¼Œè¯¥å±æ€§å€¼è®°å½•äº†å½“å‰blocké‡Œä½¿ç”¨äº†å¤šå°‘å­—èŠ‚çš„ç©ºé—´ã€‚å¯¹äºè¢«å¡«æ»¡çš„blockæ¥è¯´ï¼Œè¯¥å€¼æ°¸è¿œä¸º512ã€‚å¦‚æœè¯¥å±æ€§çš„å€¼ä¸ä¸º512ï¼Œé‚£ä¹ˆå°±æ˜¯å®ƒäº†ï¼Œå®ƒå°±æ˜¯æ­¤æ¬¡å´©æºƒæ¢å¤ä¸­éœ€è¦æ‰«æçš„æœ€åä¸€ä¸ªblockã€‚ 3.æ€ä¹ˆæ¢å¤ç¡®å®šäº†éœ€è¦æ‰«æå“ªäº›redoæ—¥å¿—è¿›è¡Œå´©æºƒæ¢å¤ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ€ä¹ˆè¿›è¡Œæ¢å¤äº†ã€‚å‡è®¾ç°åœ¨çš„redoæ—¥å¿—æ–‡ä»¶ä¸­æœ‰5æ¡redoæ—¥å¿—ï¼Œå¦‚å›¾ï¼š ç”±äºredo 0åœ¨checkpoint_lsnåå‰è¾¹ï¼Œæ¢å¤æ—¶å¯ä»¥ä¸ç®¡å®ƒã€‚ç°åœ¨å¯ä»¥æŒ‰ç…§redoæ—¥å¿—çš„é¡ºåºä¾æ¬¡æ‰«æcheckpoint_lsnä¹‹åçš„å„æ¡redoæ—¥å¿—ï¼ŒæŒ‰ç…§æ—¥å¿—ä¸­è®°è½½çš„å†…å®¹å°†å¯¹åº”çš„é¡µé¢æ¢å¤å‡ºæ¥ã€‚è¿™æ ·æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä¸è¿‡InnoDBè¿˜æ˜¯æƒ³äº†ä¸€äº›åŠæ³•åŠ å¿«è¿™ä¸ªæ¢å¤çš„è¿‡ç¨‹ï¼š ä½¿ç”¨å“ˆå¸Œè¡¨æ ¹æ®redoæ—¥å¿—çš„space IDå’Œpage numberå±æ€§è®¡ç®—å‡ºæ•£åˆ—å€¼ï¼ŒæŠŠspace IDå’Œpage numberç›¸åŒçš„redoæ—¥å¿—æ”¾åˆ°å“ˆå¸Œè¡¨çš„åŒä¸€ä¸ªæ§½é‡Œï¼Œå¦‚æœæœ‰å¤šä¸ªspace IDå’Œpage numberéƒ½ç›¸åŒçš„redoæ—¥å¿—ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹é—´ä½¿ç”¨é“¾è¡¨è¿æ¥èµ·æ¥ï¼ŒæŒ‰ç…§ç”Ÿæˆçš„å…ˆåé¡ºåºé“¾æ¥èµ·æ¥çš„ï¼Œå¦‚å›¾æ‰€ç¤ºï¼šä¹‹åå°±å¯ä»¥éå†å“ˆå¸Œè¡¨ï¼Œå› ä¸ºå¯¹åŒä¸€ä¸ªé¡µé¢è¿›è¡Œä¿®æ”¹çš„redoæ—¥å¿—éƒ½æ”¾åœ¨äº†ä¸€ä¸ªæ§½é‡Œï¼Œæ‰€ä»¥å¯ä»¥ä¸€æ¬¡æ€§å°†ä¸€ä¸ªé¡µé¢ä¿®å¤å¥½ï¼ˆé¿å…äº†å¾ˆå¤šè¯»å–é¡µé¢çš„éšæœºIOï¼‰ï¼Œè¿™æ ·å¯ä»¥åŠ å¿«æ¢å¤é€Ÿåº¦ã€‚å¦å¤–éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼ŒåŒä¸€ä¸ªé¡µé¢çš„redoæ—¥å¿—æ˜¯æŒ‰ç…§ç”Ÿæˆæ—¶é—´é¡ºåºè¿›è¡Œæ’åºçš„ï¼Œæ‰€ä»¥æ¢å¤çš„æ—¶å€™ä¹Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªé¡ºåºè¿›è¡Œæ¢å¤ï¼Œå¦‚æœä¸æŒ‰ç…§ç”Ÿæˆæ—¶é—´é¡ºåºè¿›è¡Œæ’åºçš„è¯ï¼Œé‚£ä¹ˆå¯èƒ½å‡ºç°é”™è¯¯ã€‚æ¯”å¦‚åŸå…ˆçš„ä¿®æ”¹æ“ä½œæ˜¯å…ˆæ’å…¥ä¸€æ¡è®°å½•ï¼Œå†åˆ é™¤è¯¥æ¡è®°å½•ï¼Œå¦‚æœæ¢å¤æ—¶ä¸æŒ‰ç…§è¿™ä¸ªé¡ºåºæ¥ï¼Œå°±å¯èƒ½å˜æˆå…ˆåˆ é™¤ä¸€æ¡è®°å½•ï¼Œå†æ’å…¥ä¸€æ¡è®°å½•ï¼Œè¿™æ˜¾ç„¶æ˜¯é”™è¯¯çš„ã€‚ è·³è¿‡å·²ç»åˆ·æ–°åˆ°ç£ç›˜çš„é¡µé¢checkpoint_lsnä¹‹å‰çš„redoæ—¥å¿—å¯¹åº”çš„è„é¡µç¡®å®šéƒ½å·²ç»åˆ·åˆ°ç£ç›˜äº†ï¼Œä½†æ˜¯checkpoint_lsnä¹‹åçš„redoæ—¥å¿—æˆ‘ä»¬ä¸èƒ½ç¡®å®šæ˜¯å¦å·²ç»åˆ·åˆ°ç£ç›˜ï¼Œä¸»è¦æ˜¯å› ä¸ºåœ¨æœ€è¿‘åšçš„ä¸€æ¬¡checkpointåï¼Œå¯èƒ½åå°çº¿ç¨‹åˆä¸æ–­çš„ä»LRUé“¾è¡¨å’Œflushé“¾è¡¨ä¸­å°†ä¸€äº›è„é¡µåˆ·å‡ºBuffer Poolã€‚è¿™äº›åœ¨checkpoint_lsnä¹‹åçš„redoæ—¥å¿—ï¼Œå¦‚æœå®ƒä»¬å¯¹åº”çš„è„é¡µåœ¨å´©æºƒå‘ç”Ÿæ—¶å·²ç»åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£åœ¨æ¢å¤æ—¶ä¹Ÿå°±æ²¡æœ‰å¿…è¦æ ¹æ®redoæ—¥å¿—çš„å†…å®¹ä¿®æ”¹è¯¥é¡µé¢äº†ã€‚é‚£åœ¨æ¢å¤æ—¶æ€ä¹ˆçŸ¥é“æŸä¸ªredoæ—¥å¿—å¯¹åº”çš„è„é¡µæ˜¯å¦åœ¨å´©æºƒå‘ç”Ÿæ—¶å·²ç»åˆ·æ–°åˆ°ç£ç›˜äº†å‘¢ï¼Ÿè¿™è¿˜å¾—ä»é¡µé¢çš„ç»“æ„è¯´èµ·ï¼Œæ¯ä¸ªé¡µé¢éƒ½æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºFile Headerçš„éƒ¨åˆ†ï¼Œåœ¨File Headeré‡Œæœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºFIL_PAGE_LSNçš„å±æ€§ï¼Œè¯¥å±æ€§è®°è½½äº†æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹é¡µé¢æ—¶å¯¹åº”çš„lsnå€¼ï¼ˆå…¶å®å°±æ˜¯é¡µé¢æ§åˆ¶å—ä¸­çš„newest_modificationå€¼ï¼‰ã€‚å¦‚æœåœ¨åšäº†æŸæ¬¡checkpointä¹‹åæœ‰è„é¡µè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œé‚£ä¹ˆè¯¥é¡µå¯¹åº”çš„FIL_PAGE_LSNä»£è¡¨çš„lsnå€¼è‚¯å®šå¤§äºcheckpoint_lsnçš„å€¼ï¼Œå‡¡æ˜¯ç¬¦åˆè¿™ç§æƒ…å†µçš„é¡µé¢å°±ä¸éœ€è¦é‡å¤æ‰§è¡Œlsnå€¼å°äºFIL_PAGE_LSNçš„redoæ—¥å¿—äº†ï¼Œæ‰€ä»¥æ›´è¿›ä¸€æ­¥æå‡äº†å´©æºƒæ¢å¤çš„é€Ÿåº¦ã€‚ ä¹ï¼ŒLOG_BLOCK_HDR_NOæ˜¯å¦‚ä½•è®¡ç®—çš„å¯¹äºå®é™…å­˜å‚¨redoæ—¥å¿—çš„æ™®é€šçš„log blockæ¥è¯´ï¼Œåœ¨log block headerå¤„æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºLOG_BLOCK_HDR_NOçš„å±æ€§ï¼Œæˆ‘ä»¬è¯´è¿™ä¸ªå±æ€§ä»£è¡¨ä¸€ä¸ªå”¯ä¸€çš„æ ‡å·ã€‚è¿™ä¸ªå±æ€§æ˜¯åˆæ¬¡ä½¿ç”¨è¯¥blockæ—¶åˆ†é…çš„ï¼Œè·Ÿå½“æ—¶çš„ç³»ç»Ÿlsnå€¼æœ‰å…³ã€‚ä½¿ç”¨ä¸‹è¾¹çš„å…¬å¼è®¡ç®—è¯¥blockçš„LOG_BLOCK_HDR_NOå€¼ï¼š 1((lsn / 512) &amp; 0x3FFFFFFFUL) + 1 ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œ0x3FFFFFFFULå¯¹åº”çš„äºŒè¿›åˆ¶æ•°çš„å‰2ä½ä¸º0ï¼Œå30ä½çš„å€¼éƒ½ä¸º1ã€‚ä¸€ä¸ªäºŒè¿›åˆ¶ä½ä¸0åšä¸è¿ç®—ï¼ˆ&amp;ï¼‰çš„ç»“æœè‚¯å®šæ˜¯0ï¼Œä¸€ä¸ªäºŒè¿›åˆ¶ä½ä¸1åšä¸è¿ç®—ï¼ˆ&amp;ï¼‰çš„ç»“æœå°±æ˜¯åŸå€¼ã€‚è®©ä¸€ä¸ªæ•°å’Œ0x3FFFFFFFULåšä¸è¿ç®—çš„æ„æ€å°±æ˜¯è¦å°†è¯¥å€¼çš„å‰2ä¸ªæ¯”ç‰¹ä½çš„å€¼ç½®ä¸º0ï¼Œè¿™æ ·è¯¥å€¼å°±è‚¯å®šå°äºæˆ–ç­‰äº0x3FFFFFFFULäº†ã€‚è¿™ä¹Ÿå°±è¯´æ˜äº†ï¼Œä¸è®ºlsnå¤šå¤§ï¼Œ((lsn / 512) &amp; 0x3FFFFFFFUL)çš„å€¼è‚¯å®šåœ¨0``~~0x3FFFFFFFUL~~ä¹‹é—´ï¼Œå†åŠ 1çš„è¯è‚¯å®šåœ¨~~1~~``0x40000000ULä¹‹é—´ã€‚è€Œ0x40000000ULè¿™ä¸ªå€¼å°±ä»£è¡¨ç€1GBã€‚ä¹Ÿå°±æ˜¯è¯´ç³»ç»Ÿæœ€å¤šèƒ½äº§ç”Ÿä¸é‡å¤çš„LOG_BLOCK_HDR_NOå€¼åªæœ‰1GBä¸ªã€‚InnoDBè§„å®šredoæ—¥å¿—æ–‡ä»¶ç»„ä¸­åŒ…å«çš„æ‰€æœ‰æ–‡ä»¶å¤§å°æ€»å’Œä¸å¾—è¶…è¿‡512GBï¼Œä¸€ä¸ªblockå¤§å°æ˜¯512å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­åŒ…å«çš„blockå—æœ€å¤šä¸º1GBä¸ªï¼Œæ‰€ä»¥æœ‰1GBä¸ªä¸é‡å¤çš„ç¼–å·å€¼ä¹Ÿå°±å¤Ÿç”¨äº†ã€‚ å¦å¤–ï¼ŒLOG_BLOCK_HDR_NOå€¼çš„ç¬¬ä¸€ä¸ªæ¯”ç‰¹ä½æ¯”è¾ƒç‰¹æ®Šï¼Œç§°ä¹‹ä¸ºflush bitï¼Œå¦‚æœè¯¥å€¼ä¸º1ï¼Œä»£è¡¨ç€æœ¬blockæ˜¯åœ¨æŸæ¬¡å°†log bufferä¸­çš„blockåˆ·æ–°åˆ°ç£ç›˜çš„æ“ä½œä¸­çš„ç¬¬ä¸€ä¸ªè¢«åˆ·å…¥çš„blockã€‚ åï¼Œdouble writeâ€‹ 1.è„é¡µåˆ·ç›˜é£é™©â€‹ å…³äºIOçš„æœ€å°å•ä½ï¼š æ•°æ®åº“IOçš„æœ€å°å•ä½æ˜¯16Kï¼ˆMySQLé»˜è®¤ï¼Œoracleæ˜¯8Kï¼‰ æ–‡ä»¶ç³»ç»ŸIOçš„æœ€å°å•ä½æ˜¯4Kï¼ˆä¹Ÿæœ‰1Kçš„ï¼‰ ç£ç›˜IOçš„æœ€å°å•ä½æ˜¯512å­—èŠ‚ å› æ­¤ï¼Œå­˜åœ¨IOå†™å…¥å¯¼è‡´pageæŸåçš„é£é™©ï¼šâ€‹ â€‹â€‹ 2.doublewriteï¼šä¸¤æ¬¡å†™æé«˜innodbçš„å¯é æ€§ï¼Œç”¨æ¥è§£å†³éƒ¨åˆ†å†™å¤±è´¥(partial page writeé¡µæ–­è£‚)ã€‚â€‹ 2.1 Double writeè§£å†³äº†ä»€ä¹ˆé—®é¢˜â€‹ ä¸€ä¸ªæ•°æ®é¡µçš„å¤§å°æ˜¯16Kï¼Œå‡è®¾åœ¨æŠŠå†…å­˜ä¸­çš„è„é¡µå†™åˆ°æ•°æ®åº“çš„æ—¶å€™ï¼Œå†™äº†2Kçªç„¶æ‰ç”µï¼Œä¹Ÿå°±æ˜¯è¯´å‰2Kæ•°æ®æ˜¯æ–°çš„ï¼Œå14Kæ˜¯æ—§çš„ï¼Œé‚£ä¹ˆç£ç›˜æ•°æ®åº“è¿™ä¸ªæ•°æ®é¡µå°±æ˜¯ä¸å®Œæ•´çš„ï¼Œæ˜¯ä¸€ä¸ªåæ‰çš„æ•°æ®é¡µã€‚redoåªèƒ½åŠ ä¸Šæ—§ã€æ ¡æ£€å®Œæ•´çš„æ•°æ®é¡µæ¢å¤ä¸€ä¸ªè„å—ï¼Œä¸èƒ½ä¿®å¤åæ‰çš„æ•°æ®é¡µï¼Œæ‰€ä»¥è¿™ä¸ªæ•°æ®å°±ä¸¢å¤±äº†ï¼Œå¯èƒ½ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦double writeã€‚â€‹ 2.2ä½¿ç”¨æƒ…æ™¯â€‹ å½“æ•°æ®åº“æ­£åœ¨ä»å†…å­˜æƒ³ç£ç›˜å†™ä¸€ä¸ªæ•°æ®é¡µæ˜¯ï¼Œæ•°æ®åº“å®•æœºï¼Œä»è€Œå¯¼è‡´è¿™ä¸ªé¡µåªå†™äº†éƒ¨åˆ†æ•°æ®ï¼Œè¿™å°±æ˜¯éƒ¨åˆ†å†™å¤±æ•ˆï¼Œå®ƒä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚è¿™æ—¶æ˜¯æ— æ³•é€šè¿‡é‡åšæ—¥å¿—æ¢å¤çš„ï¼Œå› ä¸ºé‡åšæ—¥å¿—è®°å½•çš„æ˜¯å¯¹é¡µçš„ç‰©ç†ä¿®æ”¹ï¼Œå¦‚æœé¡µæœ¬èº«å·²ç»æŸåï¼Œé‡åšæ—¥å¿—ä¹Ÿæ— èƒ½ä¸ºåŠ›ã€‚â€‹ 2.3 double writeå·¥ä½œæµç¨‹ doublewriteç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†ä¸ºå†…å­˜ä¸­çš„doublewrite bufferï¼Œå…¶å¤§å°ä¸º2MBï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ç£ç›˜ä¸Šå…±äº«è¡¨ç©ºé—´(ibdata x)ä¸­è¿ç»­çš„128ä¸ªé¡µï¼Œå³2ä¸ªåŒº(extent)ï¼Œå¤§å°ä¹Ÿæ˜¯2Mã€‚ å½“ä¸€ç³»åˆ—æœºåˆ¶è§¦å‘æ•°æ®ç¼“å†²æ± ä¸­çš„è„é¡µåˆ·æ–°æ—¶ï¼Œå¹¶ä¸ç›´æ¥å†™å…¥ç£ç›˜æ•°æ®æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯å…ˆæ‹·è´è‡³å†…å­˜ä¸­çš„doublewrite bufferä¸­ï¼› æ¥ç€ä»ä¸¤æ¬¡å†™ç¼“å†²åŒºåˆ†ä¸¤æ¬¡å†™å…¥ç£ç›˜å…±äº«è¡¨ç©ºé—´ä¸­(è¿ç»­å­˜å‚¨ï¼Œé¡ºåºå†™ï¼Œæ€§èƒ½å¾ˆé«˜)ï¼Œæ¯æ¬¡å†™1MBï¼› å¾…ç¬¬äºŒæ­¥å®Œæˆåï¼Œå†å°†doublewrite bufferä¸­çš„è„é¡µæ•°æ®å†™å…¥å®é™…çš„å„ä¸ªè¡¨ç©ºé—´æ–‡ä»¶(ç¦»æ•£å†™)ï¼›(è„é¡µæ•°æ®å›ºåŒ–åï¼Œå³è¿›è¡Œæ ‡è®°å¯¹åº”doublewriteæ•°æ®å¯è¦†ç›–) 2.4 doublewriteçš„å´©æºƒæ¢å¤â€‹ å¦‚æœæ“ä½œç³»ç»Ÿåœ¨å°†é¡µå†™å…¥ç£ç›˜çš„è¿‡ç¨‹ä¸­å‘ç”Ÿå´©æºƒï¼Œåœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œinnodbå­˜å‚¨å¼•æ“å¯ä»¥ä»å…±äº«è¡¨ç©ºé—´çš„doublewriteä¸­æ‰¾åˆ°è¯¥é¡µçš„ä¸€ä¸ªæœ€è¿‘çš„å‰¯æœ¬ï¼Œå°†å…¶å¤åˆ¶åˆ°è¡¨ç©ºé—´æ–‡ä»¶ï¼Œå†åº”ç”¨redo logï¼Œå°±å®Œæˆäº†æ¢å¤è¿‡ç¨‹ã€‚å› ä¸ºæœ‰å‰¯æœ¬æ‰€ä»¥ä¹Ÿä¸æ‹…å¿ƒè¡¨ç©ºé—´ä¸­æ•°æ®é¡µæ˜¯å¦æŸåã€‚ Qï¼šä¸ºä»€ä¹ˆ_log write_ä¸éœ€è¦_doublewrite_çš„æ”¯æŒï¼ŸAï¼šå› ä¸º_redolog_å†™å…¥çš„å•ä½å°±æ˜¯512å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ç£ç›˜IOçš„æœ€å°å•ä½ï¼Œæ‰€ä»¥æ— æ‰€è°“æ•°æ®æŸåã€‚ â€‹ 3.doublewriteçš„å‰¯ä½œç”¨3.1 double writeå¸¦æ¥çš„å†™è´Ÿè½½ double writeæ˜¯ä¸€ä¸ªbuffer, ä½†å…¶å®å®ƒæ˜¯å¼€åœ¨ç‰©ç†æ–‡ä»¶ä¸Šçš„ä¸€ä¸ªbuffer, å…¶å®ä¹Ÿå°±æ˜¯file, æ‰€ä»¥å®ƒä¼šå¯¼è‡´ç³»ç»Ÿæœ‰æ›´å¤šçš„fsyncæ“ä½œ, è€Œç¡¬ç›˜çš„fsyncæ€§èƒ½æ˜¯å¾ˆæ…¢çš„, æ‰€ä»¥å®ƒä¼šé™ä½mysqlçš„æ•´ä½“æ€§èƒ½ã€‚ ä½†æ˜¯ï¼Œdoublewrite bufferå†™å…¥ç£ç›˜å…±äº«è¡¨ç©ºé—´è¿™ä¸ªè¿‡ç¨‹æ˜¯è¿ç»­å­˜å‚¨ï¼Œæ˜¯é¡ºåºå†™ï¼Œæ€§èƒ½éå¸¸é«˜ï¼Œ(çº¦å å†™çš„10%)ï¼Œç‰ºç‰²ä¸€ç‚¹å†™æ€§èƒ½æ¥ä¿è¯æ•°æ®é¡µçš„å®Œæ•´è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚3.2 ç›‘æ§double writeå·¥ä½œè´Ÿè½½ 12345678mysql&gt; show global status like &#x27;%dblwr%&#x27;;+----------------------------+-------+| Variable_name | Value |+----------------------------+-------+| Innodb_dblwr_pages_written | 7 || Innodb_dblwr_writes | 3 |+----------------------------+-------+2 rows in set (0.00 sec) å…³æ³¨ç‚¹ï¼šInnodb_dblwr_pages_written / Innodb_dblwr_writesâ€‹ å¼€å¯doublewriteåï¼Œæ¯æ¬¡è„é¡µåˆ·æ–°å¿…é¡»è¦å…ˆå†™doublewriteï¼Œè€Œdoublewriteå­˜åœ¨äºç£ç›˜ä¸Šçš„æ˜¯ä¸¤ä¸ªè¿ç»­çš„åŒºï¼Œæ¯ä¸ªåŒºç”±è¿ç»­çš„é¡µç»„æˆï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸€ä¸ªåŒºæœ€å¤šæœ‰64ä¸ªé¡µï¼Œæ‰€ä»¥ä¸€æ¬¡IOå†™å…¥åº”è¯¥å¯ä»¥æœ€å¤šå†™64ä¸ªé¡µã€‚â€‹ è€Œæ ¹æ®ä»¥ä¸Šç³»ç»ŸInnodb_dblwr_pages_writtenä¸Innodb_dblwr_writesçš„æ¯”ä¾‹æ¥çœ‹ï¼Œå¤§æ¦‚åœ¨3å·¦å³ï¼Œè¿œè¿œè¿˜æ²¡åˆ°64(å¦‚æœçº¦ç­‰äº64ï¼Œé‚£ä¹ˆè¯´æ˜ç³»ç»Ÿçš„å†™å‹åŠ›éå¸¸å¤§ï¼Œæœ‰å¤§é‡çš„è„é¡µè¦å¾€ç£ç›˜ä¸Šå†™)ï¼Œæ‰€ä»¥ä»è¿™ä¸ªè§’åº¦ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œç³»ç»Ÿå†™å…¥å‹åŠ›å¹¶ä¸é«˜ã€‚â€‹ 3.3 å…³é—­double writeé€‚åˆçš„åœºæ™¯ æµ·é‡DML ä¸æƒ§æ€•æ•°æ®æŸåå’Œä¸¢å¤± ç³»ç»Ÿå†™è´Ÿè½½æˆä¸ºä¸»è¦è´Ÿè½½1234567mysql&gt; show variables like &#x27;%double%&#x27;;+--------------------+-------+| Variable_name | Value |+--------------------+-------+| innodb_doublewrite | ON |+--------------------+-------+1 row in set (0.04 sec) ä½œä¸ºInnoDBçš„ä¸€ä¸ªå…³é”®ç‰¹æ€§ï¼ŒdoublewriteåŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œä½†æ˜¯åœ¨ä¸Šè¿°ç‰¹æ®Šçš„ä¸€äº›åœºæ™¯ä¹Ÿå¯ä»¥è§†æƒ…å†µå…³é—­ï¼Œæ¥æé«˜æ•°æ®åº“å†™æ€§èƒ½ã€‚é™æ€å‚æ•°ï¼Œé…ç½®æ–‡ä»¶ä¿®æ”¹ï¼Œé‡å¯æ•°æ®åº“ã€‚3.4 ä¸ºä»€ä¹ˆæ²¡æœ‰æŠŠdouble writeé‡Œé¢çš„æ•°æ®å†™åˆ°data pageé‡Œé¢å‘¢ï¼Ÿ double writeé‡Œé¢çš„æ•°æ®æ˜¯è¿ç»­çš„ï¼Œå¦‚æœç›´æ¥å†™åˆ°data pageé‡Œé¢ï¼Œè€Œdata pageçš„é¡µåˆæ˜¯ç¦»æ•£çš„ï¼Œå†™å…¥ä¼šå¾ˆæ…¢ã€‚ double writeé‡Œé¢çš„æ•°æ®æ²¡æœ‰åŠæ³•è¢«åŠæ—¶çš„è¦†ç›–æ‰ï¼Œå¯¼è‡´double writeçš„å‹åŠ›å¾ˆå¤§ï¼›çŸ­æ—¶é—´å†…å¯èƒ½ä¼šå‡ºç°double writeæº¢å‡ºçš„æƒ…å†µã€‚åä¸€ï¼Œæ€»ç»“ redoæ—¥å¿—è®°å½•äº†äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­éƒ½ä¿®æ”¹äº†å“ªäº›å†…å®¹ã€‚ äº‹åŠ¡æäº¤æ—¶åªå°†æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ï¼Œè€Œä¸æ˜¯å°†æ‰€æœ‰ä¿®æ”¹è¿‡çš„é¡µé¢éƒ½åˆ·æ–°åˆ°ç£ç›˜ã€‚è¿™æ ·åšæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š redoæ—¥å¿—å ç”¨çš„ç©ºé—´éå¸¸å° redoæ—¥å¿—æ˜¯é¡ºåºå†™å…¥ç£ç›˜çš„ ä¸€æ¡redoæ—¥å¿—ç”±ä¸‹é¢å‡ éƒ¨åˆ†ç»„æˆã€‚ typeï¼šè¿™æ¡redoæ—¥å¿—çš„ç±»å‹ space ID:è¡¨ç©ºé—´ID page number :é¡µå· dataï¼šè¿™æ¡redoæ—¥å¿—çš„å…·ä½“å†…å®¹ redoæ—¥å¿—çš„ç±»å‹æœ‰ç®€å•å’Œå¤æ‚ä¹‹åˆ†ã€‚ç®€å•ç±»å‹çš„redoæ—¥å¿—æ˜¯çº¯ç²¹çš„ç‰©ç†æ—¥å¿—ï¼Œå¤æ‚ç±»å‹çš„redoæ—¥å¿—å…¼æœ‰ç‰©ç†æ—¥å¿—å’Œé€»è¾‘æ—¥å¿—çš„ç‰¹æ€§ã€‚ ä¸€ä¸ªMTRå¯ä»¥åŒ…å«ä¸€ç»„redoæ—¥å¿—ã€‚åœ¨è¿›è¡Œå´©æºƒæ¢å¤æ—¶ï¼Œè¿™ä¸€ç»„redoæ—¥å¿—ä½œä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“æ¥å¤„ç†ã€‚ redoæ—¥å¿—å­˜æ”¾åœ¨å¤§å°ä¸º512å­—èŠ‚çš„blockä¸­ã€‚æ¯ä¸€ä¸ªblockè¢«åˆ†ä¸º3éƒ¨åˆ†ï¼š log block header log block body log block trailer redoæ—¥å¿—ç¼“å†²åŒºæ˜¯ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œç”±è‹¥å¹²ä¸ªblockç»„æˆï¼›å¯ä»¥é€šè¿‡å¯åŠ¨é€‰é¡¹innodb_log_buffer_size æ¥è°ƒæ•´ä»–çš„å¤§å°ã€‚ redoæ—¥å¿—æ–‡ä»¶ç»„ç”±è‹¥å¹²ä¸ªæ—¥å¿—æ–‡ä»¶ç»„æˆï¼Œè¿™äº›redoæ—¥å¿—æ–‡ä»¶æ˜¯è¢«å¾ªç¯ä½¿ç”¨çš„ã€‚redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­æ¯ä¸ªæ–‡ä»¶çš„å¤§å°éƒ½ä¸€æ ·ï¼Œæ ¼å¼ä¹Ÿä¸€æ ·ï¼Œéƒ½æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼š å‰2048å­—èŠ‚ç”¨æ¥å­˜å‚¨ä¸€äº›ç®¡ç†ä¿¡æ¯ ä»ç¬¬2048å­—èŠ‚å¾€åçš„å­—èŠ‚ç”¨æ¥å­˜å‚¨log bufferä¸­çš„blocké•œåƒ lsnæŒ‡å·²ç»å†™å…¥çš„redoæ—¥å¿—é‡ï¼Œflushed_to_disk_lsnæŒ‡åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„redoæ—¥å¿—é‡ï¼Œflushé“¾è¡¨ä¸­çš„è„é¡µæŒ‰ç…§ä¿®æ”¹å‘ç”Ÿçš„æ—¶é—´é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§oldest_modificationä»£è¡¨çš„lsnå€¼è¿›è¡Œæ’åºã€‚è¢«å¤šæ¬¡æ›´æ–°çš„é¡µé¢ä¸ä¼šé‡å¤æ’å…¥åˆ°flushé“¾è¡¨ï¼Œä½†æ˜¯ä¼šæ›´æ–°newest_modificationå±æ€§çš„å€¼ã€‚checkpoint_lsnè¡¨ç¤ºå½“å‰ç³»ç»Ÿä¸­å¯ä»¥è¢«è¦†ç›–çš„redoæ—¥å¿—æ€»é‡æ˜¯å¤šå°‘ã€‚ redoæ—¥å¿—å ç”¨çš„ç£ç›˜ç©ºé—´åœ¨ä»–å¯¹åº”çš„è„é¡µå·²ç»è¢«åˆ·æ–°åˆ°ç£ç›˜åå³å¯è¢«è¦†ç›–ã€‚æ‰§è¡Œä¸€æ¬¡checkpointçš„æ„æ€å°±æ˜¯å¢åŠ checkpoint_lsnçš„å€¼ï¼Œç„¶åæŠŠç›¸å…³ä¿¡æ¯æ”¾åˆ°æ—¥å¿—æ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­ã€‚ innodb_flush_log_at_trx_commitç³»ç»Ÿå˜é‡æ§åˆ¶ç€åœ¨äº‹åŠ¡æäº¤æ—¶æ˜¯å¦å°†è¯¥äº‹åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„redoåˆ·æ–°åˆ°ç£ç›˜ã€‚ åœ¨å´©æºƒæ¢å¤è¿‡ç¨‹ä¸­ï¼Œä»redoæ—¥å¿—æ–‡ä»¶ç»„ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­å–å‡ºæœ€è¿‘å‘ç”Ÿçš„é‚£æ¬¡checkpointä¿¡æ¯ï¼Œç„¶åä»checkpoint_lsnåœ¨æ—¥å¿—æ–‡ä»¶ç»„ä¸­å¯¹åº”çš„åç§»é‡å¼€å§‹ï¼Œä¸€ç›´æ‰«ææ—¥å¿—æ–‡ä»¶ä¸­çš„blockï¼Œç›´åˆ°æŸä¸ªblockçš„LOG_BLOCK_HDR_DATA_LENå€¼ä¸ç­‰äº512ä¸ºæ­¢ã€‚å†æ¢å¤è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨hashè¡¨å¯åŠ å¿«æ¢å¤è¿‡ç¨‹ï¼Œå¹¶ä¸”ä¼šè·³è¿‡å·²ç»åˆ·æ–°åˆ°ç£ç›˜çš„é¡µé¢ã€‚","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[åä¸‰]äº‹åŠ¡","slug":"MySQL/MySQL[åä¸‰]äº‹åŠ¡","date":"2022-01-11T03:17:20.893Z","updated":"2022-01-11T03:25:11.029Z","comments":true,"path":"2022/01/11/MySQL/MySQL[åä¸‰]äº‹åŠ¡/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E5%8D%81%E4%B8%89]%E4%BA%8B%E5%8A%A1/","excerpt":"","text":"ä¸€ï¼Œäº‹åŠ¡çš„èµ·æº1.åŸå­æ€§ï¼ˆAtomicityï¼‰ç°å®ä¸–ç•Œä¸­è½¬è´¦æ“ä½œæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´è¦ä¹ˆå‹æ ¹å„¿å°±æ²¡è½¬ï¼Œè¦ä¹ˆè½¬è´¦æˆåŠŸï¼Œä¸èƒ½å­˜åœ¨ä¸­é—´çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è½¬äº†ä¸€åŠçš„è¿™ç§æƒ…å†µã€‚è®¾è®¡æ•°æ®åº“çš„å¤§å”ä»¬æŠŠè¿™ç§è¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åšçš„è§„åˆ™ç§°ä¹‹ä¸ºåŸå­æ€§ã€‚ä½†æ˜¯åœ¨ç°å®ä¸–ç•Œä¸­çš„ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ“ä½œå´å¯èƒ½å¯¹åº”ç€æ•°æ®åº“ä¸–ç•Œè‹¥å¹²æ¡ä¸åŒçš„æ“ä½œï¼Œæ•°æ®åº“ä¸­çš„ä¸€æ¡æ“ä½œä¹Ÿå¯èƒ½è¢«åˆ†è§£æˆè‹¥å¹²ä¸ªæ­¥éª¤ï¼ˆæ¯”å¦‚å…ˆä¿®æ”¹ç¼“å­˜é¡µï¼Œä¹‹åå†åˆ·æ–°åˆ°ç£ç›˜ç­‰ï¼‰ï¼Œæœ€è¦å‘½çš„æ˜¯åœ¨ä»»ä½•ä¸€ä¸ªå¯èƒ½çš„æ—¶é—´éƒ½å¯èƒ½å‘ç”Ÿæ„æƒ³ä¸åˆ°çš„é”™è¯¯ï¼ˆå¯èƒ½æ˜¯æ•°æ®åº“æœ¬èº«çš„é”™è¯¯ï¼Œæˆ–è€…æ˜¯æ“ä½œç³»ç»Ÿé”™è¯¯ï¼Œç”šè‡³æ˜¯ç›´æ¥æ–­ç”µä¹‹ç±»çš„ï¼‰è€Œä½¿æ“ä½œæ‰§è¡Œä¸ä¸‹å»ã€‚ä¸ºäº†ä¿è¯åœ¨æ•°æ®åº“ä¸–ç•Œä¸­æŸäº›æ“ä½œçš„åŸå­æ€§ï¼ŒMySQLéœ€è¦ä¿è¯å¦‚æœåœ¨æ‰§è¡Œæ“ä½œçš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼ŒæŠŠå·²ç»åšäº†çš„æ“ä½œæ¢å¤æˆæ²¡æ‰§è¡Œä¹‹å‰çš„æ ·å­ã€‚ 2.éš”ç¦»æ€§ï¼ˆIsolationï¼‰ç°å®ä¸–ç•Œä¸­çš„ä¸¤æ¬¡çŠ¶æ€è½¬æ¢åº”è¯¥æ˜¯äº’ä¸å½±å“çš„ï¼Œæ‰€ä»¥å¯¹äºç°å®ä¸–ç•Œä¸­çŠ¶æ€è½¬æ¢å¯¹åº”çš„æŸäº›æ•°æ®åº“æ“ä½œæ¥è¯´ï¼Œä¸ä»…è¦ä¿è¯è¿™äº›æ“ä½œä»¥åŸå­æ€§çš„æ–¹å¼æ‰§è¡Œå®Œæˆï¼Œè€Œä¸”è¦ä¿è¯å…¶å®ƒçš„çŠ¶æ€è½¬æ¢ä¸ä¼šå½±å“åˆ°æœ¬æ¬¡çŠ¶æ€è½¬æ¢ï¼Œè¿™ä¸ªè§„åˆ™è¢«ç§°ä¹‹ä¸ºéš”ç¦»æ€§ã€‚è¿™æ—¶MySQLå°±éœ€è¦é‡‡å–ä¸€äº›æªæ–½æ¥è®©è®¿é—®ç›¸åŒæ•°æ®çš„ä¸åŒçŠ¶æ€è½¬æ¢å¯¹åº”çš„æ•°æ®åº“æ“ä½œçš„æ‰§è¡Œé¡ºåºæœ‰ä¸€å®šè§„å¾‹ã€‚ 3.ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰æˆ‘ä»¬ç”Ÿæ´»çš„è¿™ä¸ªä¸–ç•Œå­˜åœ¨ç€å½¢å½¢è‰²è‰²çš„çº¦æŸï¼Œæ¯”å¦‚èº«ä»½è¯å·ä¸èƒ½é‡å¤ï¼Œæ€§åˆ«åªèƒ½æ˜¯ç”·æˆ–è€…å¥³ï¼Œé«˜è€ƒçš„åˆ†æ•°åªèƒ½åœ¨0ï½750ä¹‹é—´ï¼Œäººæ°‘å¸é¢å€¼æœ€å¤§åªèƒ½æ˜¯100ï¼ˆç°åœ¨æ˜¯2019å¹´ï¼‰ï¼Œçº¢ç»¿ç¯åªæœ‰3ç§é¢œè‰²ï¼Œæˆ¿ä»·ä¸èƒ½ä¸ºè´Ÿçš„ã€‚ åªæœ‰ç¬¦åˆè¿™äº›çº¦æŸçš„æ•°æ®æ‰æ˜¯æœ‰æ•ˆçš„ã€‚æ•°æ®åº“ä¸–ç•Œåªæ˜¯ç°å®ä¸–ç•Œçš„ä¸€ä¸ªæ˜ å°„ï¼Œç°å®ä¸–ç•Œä¸­å­˜åœ¨çš„çº¦æŸå½“ç„¶ä¹Ÿè¦åœ¨æ•°æ®åº“ä¸–ç•Œä¸­æœ‰æ‰€ä½“ç°ã€‚å¦‚æœæ•°æ®åº“ä¸­çš„æ•°æ®å…¨éƒ¨ç¬¦åˆç°å®ä¸–ç•Œä¸­çš„çº¦æŸï¼ˆall defined rulesï¼‰ï¼Œæˆ‘ä»¬è¯´è¿™äº›æ•°æ®å°±æ˜¯ä¸€è‡´çš„ï¼Œæˆ–è€…è¯´ç¬¦åˆä¸€è‡´æ€§çš„ã€‚ å¦‚ä½•ä¿è¯æ•°æ®åº“ä¸­æ•°æ®çš„ä¸€è‡´æ€§ï¼ˆå°±æ˜¯ç¬¦åˆæ‰€æœ‰ç°å®ä¸–ç•Œçš„çº¦æŸï¼‰å‘¢ï¼Ÿè¿™å…¶å®é ä¸¤æ–¹é¢çš„åŠªåŠ›ï¼š æ•°æ®åº“æœ¬èº«èƒ½ä¸ºæˆ‘ä»¬ä¿è¯ä¸€éƒ¨åˆ†ä¸€è‡´æ€§éœ€æ±‚ï¼ˆå°±æ˜¯æ•°æ®åº“è‡ªèº«å¯ä»¥ä¿è¯ä¸€éƒ¨åˆ†ç°å®ä¸–ç•Œçš„çº¦æŸæ°¸è¿œæœ‰æ•ˆï¼‰ã€‚æˆ‘ä»¬çŸ¥é“MySQLæ•°æ®åº“å¯ä»¥ä¸ºè¡¨å»ºç«‹ä¸»é”®ã€å”¯ä¸€ç´¢å¼•ã€å¤–é”®ã€å£°æ˜æŸä¸ªåˆ—ä¸ºNOT NULLæ¥æ‹’ç»NULLå€¼çš„æ’å…¥ã€‚æ¯”å¦‚è¯´å½“æˆ‘ä»¬å¯¹æŸä¸ªåˆ—å»ºç«‹å”¯ä¸€ç´¢å¼•æ—¶ï¼Œå¦‚æœæ’å…¥æŸæ¡è®°å½•æ—¶è¯¥åˆ—çš„å€¼é‡å¤äº†ï¼Œé‚£ä¹ˆMySQLå°±ä¼šæŠ¥é”™å¹¶ä¸”æ‹’ç»æ’å…¥ã€‚é™¤äº†è¿™äº›æˆ‘ä»¬å·²ç»éå¸¸ç†Ÿæ‚‰çš„ä¿è¯ä¸€è‡´æ€§çš„åŠŸèƒ½ï¼ŒMySQLè¿˜æ”¯æŒCHECKè¯­æ³•æ¥è‡ªå®šä¹‰çº¦æŸï¼Œæ¯”å¦‚è¿™æ ·ï¼šä¸Šè¿°ä¾‹å­ä¸­çš„CHECKè¯­å¥æœ¬æ„æ˜¯æƒ³è§„å®šbalanceåˆ—ä¸èƒ½å­˜å‚¨å°äº0çš„æ•°å­—ï¼Œå¯¹åº”çš„ç°å®ä¸–ç•Œçš„æ„æ€å°±æ˜¯é“¶è¡Œè´¦æˆ·ä½™é¢ä¸èƒ½å°äº0ã€‚ä½†æ˜¯å¾ˆé—æ†¾ï¼ŒMySQLä»…ä»…æ”¯æŒCHECKè¯­æ³•ï¼Œä½†å®é™…ä¸Šå¹¶æ²¡æœ‰ä¸€ç‚¹åµç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿æˆ‘ä»¬ä½¿ç”¨ä¸Šè¿°å¸¦æœ‰CHECKå­å¥çš„å»ºè¡¨è¯­å¥æ¥åˆ›å»ºaccountè¡¨ï¼Œé‚£ä¹ˆåœ¨åç»­æ’å…¥æˆ–æ›´æ–°è®°å½•æ—¶ï¼ŒMySQLå¹¶ä¸ä¼šå»æ£€æŸ¥CHECKå­å¥ä¸­çš„çº¦æŸæ˜¯å¦æˆç«‹ã€‚è™½ç„¶CHECKå­å¥å¯¹ä¸€è‡´æ€§æ£€æŸ¥æ²¡ä»€ä¹ˆåµç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥é€šè¿‡å®šä¹‰è§¦å‘å™¨çš„æ–¹å¼æ¥è‡ªå®šä¹‰ä¸€äº›çº¦æŸæ¡ä»¶ä»¥ä¿è¯æ•°æ®åº“ä¸­æ•°æ®çš„ä¸€è‡´æ€§ã€‚ 1234567CREATE TABLE account ( id INT NOT NULL AUTO_INCREMENT COMMENT &#x27;è‡ªå¢id&#x27;, name VARCHAR(100) COMMENT &#x27;å®¢æˆ·åç§°&#x27;, balance INT COMMENT &#x27;ä½™é¢&#x27;, PRIMARY KEY (id), CHECK (balance &gt;= 0) ); å…¶å®ƒçš„ä¸€äº›æ•°æ®åº“ï¼Œæ¯”å¦‚SQL Serveræˆ–è€…Oracleæ”¯æŒçš„CHECKè¯­æ³•æ˜¯æœ‰å®å®åœ¨åœ¨çš„ä½œç”¨çš„ï¼Œæ¯æ¬¡è¿›è¡Œæ’å…¥æˆ–æ›´æ–°è®°å½•ä¹‹å‰éƒ½ä¼šæ£€æŸ¥ä¸€ä¸‹æ•°æ®æ˜¯å¦ç¬¦åˆCHECKå­å¥ä¸­æŒ‡å®šçš„çº¦æŸæ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œå¦‚æœä¸æˆç«‹çš„è¯å°±ä¼šæ‹’ç»æ’å…¥æˆ–æ›´æ–°ã€‚ æ›´å¤šçš„ä¸€è‡´æ€§éœ€æ±‚éœ€è¦é å†™ä¸šåŠ¡ä»£ç çš„ç¨‹åºå‘˜è‡ªå·±ä¿è¯ã€‚ä¸ºå»ºç«‹ç°å®ä¸–ç•Œå’Œæ•°æ®åº“ä¸–ç•Œçš„å¯¹åº”å…³ç³»ï¼Œç†è®ºä¸Šåº”è¯¥æŠŠç°å®ä¸–ç•Œä¸­çš„æ‰€æœ‰çº¦æŸéƒ½ååº”åˆ°æ•°æ®åº“ä¸–ç•Œä¸­ï¼Œä½†æ˜¯åœ¨æ›´æ”¹æ•°æ®åº“æ•°æ®æ—¶è¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥æ˜¯ä¸€ä¸ªè€—è´¹æ€§èƒ½çš„å·¥ä½œï¼Œæ¯”æ–¹è¯´æˆ‘ä»¬ä¸ºaccountè¡¨å»ºç«‹äº†ä¸€ä¸ªè§¦å‘å™¨ï¼Œæ¯å½“æ’å…¥æˆ–è€…æ›´æ–°è®°å½•æ—¶éƒ½ä¼šæ ¡éªŒä¸€ä¸‹balanceåˆ—çš„å€¼æ˜¯ä¸æ˜¯å¤§äº0ï¼Œè¿™å°±ä¼šå½±å“åˆ°æ’å…¥æˆ–æ›´æ–°çš„é€Ÿåº¦ã€‚ä»…ä»…æ˜¯æ ¡éªŒä¸€è¡Œè®°å½•ç¬¦ä¸ç¬¦åˆä¸€è‡´æ€§éœ€æ±‚å€’ä¹Ÿä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜ï¼Œæœ‰çš„ä¸€è‡´æ€§éœ€æ±‚ç®€ç›´å˜æ€ï¼Œæ¯”æ–¹è¯´é“¶è¡Œä¼šå»ºç«‹ä¸€å¼ ä»£è¡¨è´¦å•çš„è¡¨ï¼Œé‡Œè¾¹å„¿è®°å½•äº†æ¯ä¸ªè´¦æˆ·çš„æ¯ç¬”äº¤æ˜“ï¼Œæ¯ä¸€ç¬”äº¤æ˜“å®Œæˆåï¼Œéƒ½éœ€è¦ä¿è¯æ•´ä¸ªç³»ç»Ÿçš„ä½™é¢ç­‰äºæ‰€æœ‰è´¦æˆ·çš„æ”¶å…¥å‡å»æ‰€æœ‰è´¦æˆ·çš„æ”¯å‡ºã€‚å¦‚æœåœ¨æ•°æ®åº“å±‚é¢å®ç°è¿™ä¸ªä¸€è‡´æ€§éœ€æ±‚çš„è¯ï¼Œæ¯æ¬¡å‘ç”Ÿäº¤æ˜“æ—¶ï¼Œéƒ½éœ€è¦å°†æ‰€æœ‰çš„æ”¶å…¥åŠ èµ·æ¥å‡å»æ‰€æœ‰çš„æ”¯å‡ºï¼Œå†å°†æ‰€æœ‰çš„è´¦æˆ·ä½™é¢åŠ èµ·æ¥ï¼Œçœ‹çœ‹ä¸¤ä¸ªå€¼ç›¸ä¸ç›¸ç­‰ã€‚å¦‚æœè´¦å•è¡¨é‡Œæœ‰å‡ äº¿æ¡è®°å½•ï¼Œå…‰æ˜¯è¿™ä¸ªæ ¡éªŒçš„è¿‡ç¨‹å¯èƒ½å°±è¦è·‘å¥½å‡ ä¸ªå°æ—¶ï¼Œè¿™æ ·çš„æ€§èƒ½ä»£ä»·æ˜¯å®Œå…¨æ‰¿å—ä¸èµ·çš„ã€‚ç°å®ç”Ÿæ´»ä¸­å¤æ‚çš„ä¸€è‡´æ€§éœ€æ±‚æ¯”æ¯”çš†æ˜¯ï¼Œè€Œç”±äºæ€§èƒ½é—®é¢˜æŠŠä¸€è‡´æ€§éœ€æ±‚äº¤ç»™æ•°æ®åº“å»è§£å†³è¿™æ˜¯ä¸ç°å®çš„ï¼Œæ‰€ä»¥è¿™ä¸ªé”…å°±ç”©ç»™äº†ä¸šåŠ¡ç«¯ç¨‹åºå‘˜ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬çš„accountè¡¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸å»ºç«‹è§¦å‘å™¨ï¼Œåªè¦ç¼–å†™ä¸šåŠ¡çš„ç¨‹åºå‘˜åœ¨è‡ªå·±çš„ä¸šåŠ¡ä»£ç é‡Œåˆ¤æ–­ä¸€ä¸‹ï¼Œå½“æŸä¸ªæ“ä½œä¼šå°†balanceåˆ—çš„å€¼æ›´æ–°ä¸ºå°äº0çš„å€¼æ—¶ï¼Œå°±ä¸æ‰§è¡Œè¯¥æ“ä½œå°±å¥½äº†ï¼ åŸå­æ€§å’Œéš”ç¦»æ€§éƒ½ä¼šå¯¹ä¸€è‡´æ€§äº§ç”Ÿå½±å“ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°å®ä¸–ç•Œä¸­è½¬è´¦æ“ä½œå®Œæˆåï¼Œæœ‰ä¸€ä¸ªä¸€è‡´æ€§éœ€æ±‚å°±æ˜¯å‚ä¸è½¬è´¦çš„è´¦æˆ·çš„æ€»çš„ä½™é¢æ˜¯ä¸å˜çš„ã€‚å¦‚æœæ•°æ®åº“ä¸éµå¾ªåŸå­æ€§è¦æ±‚ï¼Œä¹Ÿå°±æ˜¯è½¬äº†ä¸€åŠå°±ä¸è½¬äº†ï¼Œé‚£æœ€åå°±æ˜¯ä¸ç¬¦åˆä¸€è‡´æ€§éœ€æ±‚çš„ï¼›ç±»ä¼¼çš„ï¼Œå¦‚æœæ•°æ®åº“ä¸éµå¾ªéš”ç¦»æ€§è¦æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´å¯èƒ½ä¸ç¬¦åˆä¸€è‡´æ€§éœ€æ±‚äº†ã€‚æ‰€ä»¥è¯´ï¼Œæ•°æ®åº“æŸäº›æ“ä½œçš„åŸå­æ€§å’Œéš”ç¦»æ€§éƒ½æ˜¯ä¿è¯ä¸€è‡´æ€§çš„ä¸€ç§æ‰‹æ®µï¼Œåœ¨æ“ä½œæ‰§è¡Œå®Œæˆåä¿è¯ç¬¦åˆæ‰€æœ‰æ—¢å®šçš„çº¦æŸåˆ™æ˜¯ä¸€ç§ç»“æœã€‚é‚£æ»¡è¶³åŸå­æ€§å’Œéš”ç¦»æ€§çš„æ“ä½œä¸€å®šå°±æ»¡è¶³ä¸€è‡´æ€§ä¹ˆï¼Ÿé‚£å€’ä¹Ÿä¸ä¸€å®šï¼Œé‚£ä¸æ»¡è¶³åŸå­æ€§å’Œéš”ç¦»æ€§çš„æ“ä½œå°±ä¸€å®šä¸æ»¡è¶³ä¸€è‡´æ€§ä¹ˆï¼Ÿè¿™ä¹Ÿä¸ä¸€å®šï¼Œåªè¦æœ€åçš„ç»“æœç¬¦åˆæ‰€æœ‰ç°å®ä¸–ç•Œä¸­çš„çº¦æŸï¼Œé‚£ä¹ˆå°±æ˜¯ç¬¦åˆä¸€è‡´æ€§çš„ã€‚ 4.æŒä¹…æ€§ï¼ˆDurabilityï¼‰å½“ç°å®ä¸–ç•Œçš„ä¸€ä¸ªçŠ¶æ€è½¬æ¢å®Œæˆåï¼Œè¿™ä¸ªè½¬æ¢çš„ç»“æœå°†æ°¸ä¹…çš„ä¿ç•™ï¼Œè¿™ä¸ªè§„åˆ™è¢«MySQLç§°ä¸ºæŒä¹…æ€§ã€‚å½“æŠŠç°å®ä¸–ç•Œçš„çŠ¶æ€è½¬æ¢æ˜ å°„åˆ°æ•°æ®åº“ä¸–ç•Œæ—¶ï¼ŒæŒä¹…æ€§æ„å‘³ç€è¯¥è½¬æ¢å¯¹åº”çš„æ•°æ®åº“æ“ä½œæ‰€ä¿®æ”¹çš„æ•°æ®éƒ½åº”è¯¥åœ¨ç£ç›˜ä¸Šä¿ç•™ä¸‹æ¥ï¼Œä¸è®ºä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆäº‹æ•…ï¼Œæœ¬æ¬¡è½¬æ¢é€ æˆçš„å½±å“éƒ½ä¸åº”è¯¥è¢«ä¸¢å¤±æ‰ã€‚ äºŒï¼Œäº‹åŠ¡çš„æ¦‚å¿µæˆ‘ä»¬æŠŠåŸå­æ€§ï¼ˆAtomicityï¼‰ã€éš”ç¦»æ€§ï¼ˆIsolationï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰å’ŒæŒä¹…æ€§ï¼ˆDurabilityï¼‰è¿™å››ä¸ªè¯å¯¹åº”çš„è‹±æ–‡å•è¯é¦–å­—æ¯æå–å‡ºæ¥å°±æ˜¯Aã€Iã€Cã€Dï¼Œç¨å¾®å˜æ¢ä¸€ä¸‹é¡ºåºå¯ä»¥ç»„æˆä¸€ä¸ªå®Œæ•´çš„è‹±æ–‡å•è¯ï¼šACIDã€‚MySQLå”ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼ŒæŠŠéœ€è¦ä¿è¯åŸå­æ€§ã€éš”ç¦»æ€§ã€ä¸€è‡´æ€§å’ŒæŒä¹…æ€§çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®åº“æ“ä½œç§°ä¹‹ä¸ºä¸€ä¸ªäº‹åŠ¡ï¼ˆè‹±æ–‡åæ˜¯ï¼štransactionï¼‰ã€‚ æˆ‘ä»¬ç°åœ¨çŸ¥é“äº‹åŠ¡æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå®ƒå…¶å®å¯¹åº”ç€ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®åº“æ“ä½œï¼ŒMySQLæ ¹æ®è¿™äº›æ“ä½œæ‰€æ‰§è¡Œçš„ä¸åŒé˜¶æ®µæŠŠäº‹åŠ¡å¤§è‡´ä¸Šåˆ’åˆ†æˆäº†è¿™ä¹ˆå‡ ä¸ªçŠ¶æ€ï¼š æ´»åŠ¨çš„ï¼ˆactiveï¼‰äº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“æ“ä½œæ­£åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¶ï¼Œæˆ‘ä»¬å°±è¯´è¯¥äº‹åŠ¡å¤„åœ¨æ´»åŠ¨çš„çŠ¶æ€ã€‚ éƒ¨åˆ†æäº¤çš„ï¼ˆpartially committedï¼‰å½“äº‹åŠ¡ä¸­çš„æœ€åä¸€ä¸ªæ“ä½œæ‰§è¡Œå®Œæˆï¼Œä½†ç”±äºæ“ä½œéƒ½åœ¨å†…å­˜ä¸­æ‰§è¡Œï¼Œæ‰€é€ æˆçš„å½±å“å¹¶æ²¡æœ‰åˆ·æ–°åˆ°ç£ç›˜æ—¶ï¼Œæˆ‘ä»¬å°±è¯´è¯¥äº‹åŠ¡å¤„åœ¨éƒ¨åˆ†æäº¤çš„çŠ¶æ€ã€‚ å¤±è´¥çš„ï¼ˆfailedï¼‰å½“äº‹åŠ¡å¤„åœ¨æ´»åŠ¨çš„æˆ–è€…éƒ¨åˆ†æäº¤çš„çŠ¶æ€æ—¶ï¼Œå¯èƒ½é‡åˆ°äº†æŸäº›é”™è¯¯ï¼ˆæ•°æ®åº“è‡ªèº«çš„é”™è¯¯ã€æ“ä½œç³»ç»Ÿé”™è¯¯æˆ–è€…ç›´æ¥æ–­ç”µç­‰ï¼‰è€Œæ— æ³•ç»§ç»­æ‰§è¡Œï¼Œæˆ–è€…äººä¸ºçš„åœæ­¢å½“å‰äº‹åŠ¡çš„æ‰§è¡Œï¼Œæˆ‘ä»¬å°±è¯´è¯¥äº‹åŠ¡å¤„åœ¨å¤±è´¥çš„çŠ¶æ€ã€‚ ä¸­æ­¢çš„ï¼ˆabortedï¼‰å¦‚æœäº‹åŠ¡æ‰§è¡Œäº†åŠæˆªè€Œå˜ä¸ºå¤±è´¥çš„çŠ¶æ€ï¼Œé‚£ä¹ˆå°±éœ€è¦æŠŠå·²ç»ä¿®æ”¹çš„æ•°æ®è°ƒæ•´ä¸ºæœªä¿®æ”¹ä¹‹å‰çš„æ•°æ®ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯è¦æ’¤é”€å¤±è´¥äº‹åŠ¡å¯¹å½“å‰æ•°æ®åº“é€ æˆçš„å½±å“ã€‚ä¹¦é¢ä¸€ç‚¹çš„è¯ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ’¤é”€çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºå›æ»šã€‚å½“å›æ»šæ“ä½œæ‰§è¡Œå®Œæ¯•æ—¶ï¼Œä¹Ÿå°±æ˜¯æ•°æ®åº“æ¢å¤åˆ°äº†æ‰§è¡Œäº‹åŠ¡ä¹‹å‰çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å°±è¯´è¯¥äº‹åŠ¡å¤„åœ¨äº†ä¸­æ­¢çš„çŠ¶æ€ã€‚ æäº¤çš„ï¼ˆcommittedï¼‰å½“ä¸€ä¸ªå¤„åœ¨éƒ¨åˆ†æäº¤çš„çŠ¶æ€çš„äº‹åŠ¡å°†ä¿®æ”¹è¿‡çš„æ•°æ®éƒ½åŒæ­¥åˆ°ç£ç›˜ä¸Šä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯´è¯¥äº‹åŠ¡å¤„åœ¨äº†æäº¤çš„çŠ¶æ€ã€‚ éšç€äº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“æ“ä½œæ‰§è¡Œåˆ°ä¸åŒé˜¶æ®µï¼Œäº‹åŠ¡çš„çŠ¶æ€ä¹Ÿåœ¨ä¸æ–­å˜åŒ–ï¼Œä¸€ä¸ªåŸºæœ¬çš„çŠ¶æ€è½¬æ¢å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š ä»å›¾ä¸­å¤§å®¶ä¹Ÿå¯ä»¥çœ‹å‡ºäº†ï¼Œåªæœ‰å½“äº‹åŠ¡å¤„äºæäº¤çš„æˆ–è€…ä¸­æ­¢çš„çŠ¶æ€æ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸæ‰ç®—æ˜¯ç»“æŸäº†ã€‚å¯¹äºå·²ç»æäº¤çš„äº‹åŠ¡æ¥è¯´ï¼Œè¯¥äº‹åŠ¡å¯¹æ•°æ®åº“æ‰€åšçš„ä¿®æ”¹å°†æ°¸ä¹…ç”Ÿæ•ˆï¼Œå¯¹äºå¤„äºä¸­æ­¢çŠ¶æ€çš„äº‹åŠ¡ï¼Œè¯¥äº‹åŠ¡å¯¹æ•°æ®åº“æ‰€åšçš„æ‰€æœ‰ä¿®æ”¹éƒ½ä¼šè¢«å›æ»šåˆ°æ²¡æ‰§è¡Œè¯¥äº‹åŠ¡ä¹‹å‰çš„çŠ¶æ€ã€‚ ä¸‰ï¼ŒMySQLä¸­äº‹åŠ¡çš„è¯­æ³•æˆ‘ä»¬è¯´äº‹åŠ¡çš„æœ¬è´¨å…¶å®åªæ˜¯ä¸€ç³»åˆ—æ•°æ®åº“æ“ä½œï¼Œåªä¸è¿‡è¿™äº›æ•°æ®åº“æ“ä½œç¬¦åˆACIDç‰¹æ€§è€Œå·²ï¼Œé‚£ä¹ˆMySQLä¸­å¦‚ä½•å°†æŸäº›æ“ä½œæ”¾åˆ°ä¸€ä¸ªäº‹åŠ¡é‡Œå»æ‰§è¡Œçš„å‘¢ï¼Ÿ 1.å¼€å¯äº‹åŠ¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹è¾¹ä¸¤ç§è¯­å¥ä¹‹ä¸€æ¥å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼š BEGIN [WORK];BEGINè¯­å¥ä»£è¡¨å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œåè¾¹çš„å•è¯WORKå¯æœ‰å¯æ— ã€‚å¼€å¯äº‹åŠ¡åï¼Œå°±å¯ä»¥ç»§ç»­å†™è‹¥å¹²æ¡è¯­å¥ï¼Œè¿™äº›è¯­å¥éƒ½å±äºåˆšåˆšå¼€å¯çš„è¿™ä¸ªäº‹åŠ¡ã€‚ 1234mysql&gt; BEGIN;Query OK, 0 rows affected (0.00 sec)mysql&gt; åŠ å…¥äº‹åŠ¡çš„è¯­å¥... START TRANSACTION;START TRANSACTIONè¯­å¥å’ŒBEGINè¯­å¥æœ‰ç€ç›¸åŒçš„åŠŸæ•ˆï¼Œéƒ½æ ‡å¿—ç€å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œæ¯”å¦‚è¿™æ ·ï¼šä¸è¿‡æ¯”BEGINè¯­å¥ç‰›é€¼ä¸€ç‚¹å„¿çš„æ˜¯ï¼Œå¯ä»¥åœ¨START TRANSACTIONè¯­å¥åè¾¹è·Ÿéšå‡ ä¸ªä¿®é¥°ç¬¦ï¼Œå°±æ˜¯å®ƒä»¬å‡ ä¸ªï¼š 1234mysql&gt; START TRANSACTION;Query OK, 0 rows affected (0.00 sec)mysql&gt; åŠ å…¥äº‹åŠ¡çš„è¯­å¥... READ ONLYï¼šæ ‡è¯†å½“å‰äº‹åŠ¡æ˜¯ä¸€ä¸ªåªè¯»äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯å±äºè¯¥äº‹åŠ¡çš„æ•°æ®åº“æ“ä½œåªèƒ½è¯»å–æ•°æ®ï¼Œè€Œä¸èƒ½ä¿®æ”¹æ•°æ®ã€‚ å…¶å®åªè¯»äº‹åŠ¡ä¸­åªæ˜¯ä¸å…è®¸ä¿®æ”¹é‚£äº›å…¶ä»–äº‹åŠ¡ä¹Ÿèƒ½è®¿é—®åˆ°çš„è¡¨ä¸­çš„æ•°æ®ï¼Œå¯¹äºä¸´æ—¶è¡¨æ¥è¯´ï¼ˆæˆ‘ä»¬ä½¿ç”¨CREATE TMEPORARY TABLEåˆ›å»ºçš„è¡¨ï¼‰ï¼Œç”±äºå®ƒä»¬åªèƒ½åœ¨å½“å‰ä¼šè¯ä¸­å¯è§ï¼Œæ‰€ä»¥åªè¯»äº‹åŠ¡å…¶å®ä¹Ÿæ˜¯å¯ä»¥å¯¹ä¸´æ—¶è¡¨è¿›è¡Œå¢ã€åˆ ã€æ”¹æ“ä½œçš„ã€‚ READ WRITEï¼šæ ‡è¯†å½“å‰äº‹åŠ¡æ˜¯ä¸€ä¸ªè¯»å†™äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯å±äºè¯¥äº‹åŠ¡çš„æ•°æ®åº“æ“ä½œæ—¢å¯ä»¥è¯»å–æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹æ•°æ®ã€‚ WITH CONSISTENT SNAPSHOTï¼šå¯åŠ¨ä¸€è‡´æ€§è¯»ã€‚ æ¯”å¦‚æˆ‘ä»¬æƒ³å¼€å¯ä¸€ä¸ªåªè¯»äº‹åŠ¡çš„è¯ï¼Œç›´æ¥æŠŠREAD ONLYè¿™ä¸ªä¿®é¥°ç¬¦åŠ åœ¨START TRANSACTIONè¯­å¥åè¾¹å°±å¥½ï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1START TRANSACTION READ ONLY; å¦‚æœæˆ‘ä»¬æƒ³åœ¨START TRANSACTIONåè¾¹è·Ÿéšå¤šä¸ªä¿®é¥°ç¬¦çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨é€—å·å°†ä¿®é¥°ç¬¦åˆ†å¼€ï¼Œæ¯”å¦‚å¼€å¯ä¸€ä¸ªåªè¯»äº‹åŠ¡å’Œä¸€è‡´æ€§è¯»ï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼š 1START TRANSACTION READ ONLY, WITH CONSISTENT SNAPSHOT; æˆ–è€…å¼€å¯ä¸€ä¸ªè¯»å†™äº‹åŠ¡å’Œä¸€è‡´æ€§è¯»ï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼š 1START TRANSACTION READ WRITE, WITH CONSISTENT SNAPSHOT ä¸è¿‡è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼ŒREAD ONLYå’ŒREAD WRITEæ˜¯ç”¨æ¥è®¾ç½®æ‰€è°“çš„äº‹åŠ¡è®¿é—®æ¨¡å¼çš„ï¼Œå°±æ˜¯ä»¥åªè¯»è¿˜æ˜¯è¯»å†™çš„æ–¹å¼æ¥è®¿é—®æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œä¸€ä¸ªäº‹åŠ¡çš„è®¿é—®æ¨¡å¼ä¸èƒ½åŒæ—¶æ—¢è®¾ç½®ä¸ºåªè¯»çš„ä¹Ÿè®¾ç½®ä¸ºè¯»å†™çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½åŒæ—¶æŠŠREAD ONLYå’ŒREAD WRITEæ”¾åˆ°START TRANSACTIONè¯­å¥åè¾¹ã€‚å¦å¤–ï¼Œå¦‚æœæˆ‘ä»¬ä¸æ˜¾å¼æŒ‡å®šäº‹åŠ¡çš„è®¿é—®æ¨¡å¼ï¼Œé‚£ä¹ˆè¯¥äº‹åŠ¡çš„è®¿é—®æ¨¡å¼å°±æ˜¯è¯»å†™æ¨¡å¼ã€‚ 2.æäº¤äº‹åŠ¡å¼€å¯äº‹åŠ¡ä¹‹åå°±å¯ä»¥ç»§ç»­å†™éœ€è¦æ”¾åˆ°è¯¥äº‹åŠ¡ä¸­çš„è¯­å¥äº†ï¼Œå½“æœ€åä¸€æ¡è¯­å¥å†™å®Œäº†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æäº¤è¯¥äº‹åŠ¡äº†ï¼Œæäº¤çš„è¯­å¥ä¹Ÿå¾ˆç®€å•ï¼š 1COMMIT [WORK] COMMITè¯­å¥å°±ä»£è¡¨æäº¤ä¸€ä¸ªäº‹åŠ¡ï¼Œåè¾¹çš„WORKå¯æœ‰å¯æ— ã€‚è½¬è´¦ä¸¾ä¾‹ï¼š 12345678910111213mysql&gt; BEGIN;Query OK, 0 rows affected (0.00 sec)mysql&gt; UPDATE account SET balance = balance - 10 WHERE id = 1;Query OK, 1 row affected (0.02 sec)Rows matched: 1 Changed: 1 Warnings: 0mysql&gt; UPDATE account SET balance = balance + 10 WHERE id = 2;Query OK, 1 row affected (0.00 sec)Rows matched: 1 Changed: 1 Warnings: 0mysql&gt; COMMIT;Query OK, 0 rows affected (0.00 sec) 3.æ‰‹åŠ¨ä¸­æ­¢äº‹åŠ¡å¦‚æœæˆ‘ä»¬å†™äº†å‡ æ¡è¯­å¥ä¹‹åå‘ç°ä¸Šè¾¹çš„æŸæ¡è¯­å¥å†™é”™äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨çš„ä½¿ç”¨ä¸‹è¾¹è¿™ä¸ªè¯­å¥æ¥å°†æ•°æ®åº“æ¢å¤åˆ°äº‹åŠ¡æ‰§è¡Œä¹‹å‰çš„æ ·å­ï¼š 1ROLLBACK [WORK] ROLLBACKè¯­å¥å°±ä»£è¡¨ä¸­æ­¢å¹¶å›æ»šä¸€ä¸ªäº‹åŠ¡ï¼Œåè¾¹çš„WORKå¯æœ‰å¯æ— ç±»ä¼¼çš„ã€‚è½¬è´¦ä¸¾ä¾‹ï¼š 12345678910111213mysql&gt; BEGIN;Query OK, 0 rows affected (0.00 sec)mysql&gt; UPDATE account SET balance = balance - 10 WHERE id = 1;Query OK, 1 row affected (0.00 sec)Rows matched: 1 Changed: 1 Warnings: 0mysql&gt; UPDATE account SET balance = balance + 1 WHERE id = 2;Query OK, 1 row affected (0.00 sec)Rows matched: 1 Changed: 1 Warnings: 0mysql&gt; ROLLBACK;Query OK, 0 rows affected (0.00 sec) è¿™é‡Œéœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼ŒROLLBACKè¯­å¥æ˜¯æˆ‘ä»¬ç¨‹åºå‘˜æ‰‹åŠ¨çš„å»å›æ»šäº‹åŠ¡æ—¶æ‰å»ä½¿ç”¨çš„ï¼Œå¦‚æœäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†æŸäº›é”™è¯¯è€Œæ— æ³•ç»§ç»­æ‰§è¡Œçš„è¯ï¼Œäº‹åŠ¡è‡ªèº«ä¼šè‡ªåŠ¨çš„å›æ»šã€‚ æˆ‘ä»¬è¿™é‡Œæ‰€è¯´çš„å¼€å¯ã€æäº¤ã€ä¸­æ­¢äº‹åŠ¡çš„è¯­æ³•åªæ˜¯é’ˆå¯¹ä½¿ç”¨é»‘æ¡†æ¡†æ—¶é€šè¿‡mysqlå®¢æˆ·ç«¯ç¨‹åºä¸æœåŠ¡å™¨è¿›è¡Œäº¤äº’æ—¶æ§åˆ¶äº‹åŠ¡çš„è¯­æ³•ï¼Œå¦‚æœå¤§å®¶ä½¿ç”¨çš„æ˜¯åˆ«çš„å®¢æˆ·ç«¯ç¨‹åºï¼Œæ¯”å¦‚JDBCä¹‹ç±»çš„ï¼Œé‚£éœ€è¦å‚è€ƒç›¸åº”çš„æ–‡æ¡£æ¥çœ‹çœ‹å¦‚ä½•æ§åˆ¶äº‹åŠ¡ã€‚ 4.æ”¯æŒäº‹åŠ¡çš„å­˜å‚¨å¼•æ“MySQLä¸­å¹¶ä¸æ˜¯æ‰€æœ‰å­˜å‚¨å¼•æ“éƒ½æ”¯æŒäº‹åŠ¡çš„åŠŸèƒ½ï¼Œç›®å‰åªæœ‰InnoDBå’ŒNDBå­˜å‚¨å¼•æ“æ”¯æŒï¼ˆNDBå­˜å‚¨å¼•æ“ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼‰ï¼Œå¦‚æœæŸä¸ªäº‹åŠ¡ä¸­åŒ…å«äº†ä¿®æ”¹ä½¿ç”¨ä¸æ”¯æŒäº‹åŠ¡çš„å­˜å‚¨å¼•æ“çš„è¡¨ï¼Œé‚£ä¹ˆå¯¹è¯¥ä½¿ç”¨ä¸æ”¯æŒäº‹åŠ¡çš„å­˜å‚¨å¼•æ“çš„è¡¨æ‰€åšçš„ä¿®æ”¹å°†æ— æ³•è¿›è¡Œå›æ»šã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æœ‰ä¸¤ä¸ªè¡¨ï¼Œtbl1ä½¿ç”¨æ”¯æŒäº‹åŠ¡çš„å­˜å‚¨å¼•æ“InnoDBï¼Œtbl2ä½¿ç”¨ä¸æ”¯æŒäº‹åŠ¡çš„å­˜å‚¨å¼•æ“MyISAMï¼Œå®ƒä»¬çš„å»ºè¡¨è¯­å¥å¦‚ä¸‹æ‰€ç¤ºï¼š 1234567CREATE TABLE tbl1 ( i int) engine=InnoDB;CREATE TABLE tbl2 ( i int) ENGINE=MyISAM; æˆ‘ä»¬çœ‹çœ‹å…ˆå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå†™ä¸€æ¡æ’å…¥è¯­å¥åå†å›æ»šè¯¥äº‹åŠ¡ï¼Œtbl1å’Œtbl2çš„è¡¨ç°æœ‰ä»€ä¹ˆä¸åŒï¼š 1234567891011121314mysql&gt; SELECT * FROM tbl1;Empty set (0.00 sec)mysql&gt; BEGIN;Query OK, 0 rows affected (0.00 sec)mysql&gt; INSERT INTO tbl1 VALUES(1);Query OK, 1 row affected (0.00 sec)mysql&gt; ROLLBACK;Query OK, 0 rows affected (0.00 sec)mysql&gt; SELECT * FROM tbl1;Empty set (0.00 sec) å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºä½¿ç”¨æ”¯æŒäº‹åŠ¡çš„å­˜å‚¨å¼•æ“çš„tbl1è¡¨æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨æ’å…¥ä¸€æ¡è®°å½•å†å›æ»šåï¼Œtbl1å°±æ¢å¤åˆ°æ²¡æœ‰æ’å…¥è®°å½•æ—¶çš„çŠ¶æ€äº†ã€‚å†çœ‹çœ‹tbl2è¡¨çš„è¡¨ç°ï¼š 12345678910111213141516171819mysql&gt; SELECT * FROM tbl2;Empty set (0.00 sec)mysql&gt; BEGIN;Query OK, 0 rows affected (0.00 sec)mysql&gt; INSERT INTO tbl2 VALUES(1);Query OK, 1 row affected (0.00 sec)mysql&gt; ROLLBACK;Query OK, 0 rows affected, 1 warning (0.01 sec)mysql&gt; SELECT * FROM tbl2;+------+| i |+------+| 1 |+------+1 row in set (0.00 sec) å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶æˆ‘ä»¬ä½¿ç”¨äº†ROLLBACKè¯­å¥æ¥å›æ»šäº‹åŠ¡ï¼Œä½†æ˜¯æ’å…¥çš„é‚£æ¡è®°å½•è¿˜æ˜¯ç•™åœ¨äº†tbl2è¡¨ä¸­ã€‚ 5.è‡ªåŠ¨æäº¤MySQLä¸­æœ‰ä¸€ä¸ªç³»ç»Ÿå˜é‡autocommitï¼š 1234567mysql&gt; SHOW VARIABLES LIKE &#x27;autocommit&#x27;;+---------------+-------+| Variable_name | Value |+---------------+-------+| autocommit | ON |+---------------+-------+1 row in set (0.01 sec) å¯ä»¥çœ‹åˆ°å®ƒçš„é»˜è®¤å€¼ä¸ºONï¼Œä¹Ÿå°±æ˜¯è¯´é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬ä¸æ˜¾å¼çš„ä½¿ç”¨START TRANSACTIONæˆ–è€…BEGINè¯­å¥å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆæ¯ä¸€æ¡è¯­å¥éƒ½ç®—æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ï¼Œè¿™ç§ç‰¹æ€§ç§°ä¹‹ä¸ºäº‹åŠ¡çš„è‡ªåŠ¨æäº¤ã€‚å‡å¦‚æˆ‘ä»¬åœ¨è½¬è´¦æ—¶ä¸ä»¥START TRANSACTIONæˆ–è€…BEGINè¯­å¥æ˜¾å¼çš„å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆä¸‹è¾¹è¿™ä¸¤æ¡è¯­å¥å°±ç›¸å½“äºæ”¾åˆ°ä¸¤ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ä¸­å»æ‰§è¡Œï¼š 12UPDATE account SET balance = balance - 10 WHERE id = 1;UPDATE account SET balance = balance + 10 WHERE id = 2; å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å…³é—­è¿™ç§è‡ªåŠ¨æäº¤çš„åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹è¾¹ä¸¤ç§æ–¹æ³•ä¹‹ä¸€ï¼š æ˜¾å¼çš„çš„ä½¿ç”¨START TRANSACTIONæˆ–è€…BEGINè¯­å¥å¼€å¯ä¸€ä¸ªäº‹åŠ¡ã€‚è¿™æ ·åœ¨æœ¬æ¬¡äº‹åŠ¡æäº¤æˆ–è€…å›æ»šå‰ä¼šæš‚æ—¶å…³é—­æ‰è‡ªåŠ¨æäº¤çš„åŠŸèƒ½ã€‚ æŠŠç³»ç»Ÿå˜é‡autocommitçš„å€¼è®¾ç½®ä¸ºOFFï¼Œå°±åƒè¿™æ ·ï¼šè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å†™å…¥çš„å¤šæ¡è¯­å¥å°±ç®—æ˜¯å±äºåŒä¸€ä¸ªäº‹åŠ¡äº†ï¼Œç›´åˆ°æˆ‘ä»¬æ˜¾å¼çš„å†™å‡ºCOMMITè¯­å¥æ¥æŠŠè¿™ä¸ªäº‹åŠ¡æäº¤æ‰ï¼Œæˆ–è€…æ˜¾å¼çš„å†™å‡ºROLLBACKè¯­å¥æ¥æŠŠè¿™ä¸ªäº‹åŠ¡å›æ»šæ‰ã€‚ 1SET autocommit = OFF; 6.éšå¼æäº¤å½“æˆ‘ä»¬ä½¿ç”¨START TRANSACTIONæˆ–è€…BEGINè¯­å¥å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œæˆ–è€…æŠŠç³»ç»Ÿå˜é‡autocommitçš„å€¼è®¾ç½®ä¸ºOFFæ—¶ï¼Œäº‹åŠ¡å°±ä¸ä¼šè¿›è¡Œè‡ªåŠ¨æäº¤ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬è¾“å…¥äº†æŸäº›è¯­å¥ä¹‹åå°±ä¼šæ‚„æ‚„çš„æäº¤æ‰ï¼Œå°±åƒæˆ‘ä»¬è¾“å…¥äº†COMMITè¯­å¥äº†ä¸€æ ·ï¼Œè¿™ç§å› ä¸ºæŸäº›ç‰¹æ®Šçš„è¯­å¥è€Œå¯¼è‡´äº‹åŠ¡æäº¤çš„æƒ…å†µç§°ä¸ºéšå¼æäº¤ï¼Œè¿™äº›ä¼šå¯¼è‡´äº‹åŠ¡éšå¼æäº¤çš„è¯­å¥åŒ…æ‹¬ï¼š å®šä¹‰æˆ–ä¿®æ”¹æ•°æ®åº“å¯¹è±¡çš„æ•°æ®å®šä¹‰è¯­è¨€ï¼ˆData definition languageï¼Œç¼©å†™ä¸ºï¼šDDLï¼‰ã€‚æ‰€è°“çš„æ•°æ®åº“å¯¹è±¡ï¼ŒæŒ‡çš„å°±æ˜¯æ•°æ®åº“ã€è¡¨ã€è§†å›¾ã€å­˜å‚¨è¿‡ç¨‹ç­‰ç­‰è¿™äº›ä¸œè¥¿ã€‚å½“æˆ‘ä»¬ä½¿ç”¨CREATEã€ALTERã€DROPç­‰è¯­å¥å»ä¿®æ”¹è¿™äº›æ‰€è°“çš„æ•°æ®åº“å¯¹è±¡æ—¶ï¼Œå°±ä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±äºçš„äº‹åŠ¡ï¼Œå°±åƒè¿™æ ·ï¼š 1234567BEGIN;SELECT ... # äº‹åŠ¡ä¸­çš„ä¸€æ¡è¯­å¥UPDATE ... # äº‹åŠ¡ä¸­çš„ä¸€æ¡è¯­å¥... # äº‹åŠ¡ä¸­çš„å…¶å®ƒè¯­å¥CREATE TABLE ... # æ­¤è¯­å¥ä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±äºçš„äº‹åŠ¡ éšå¼ä½¿ç”¨æˆ–ä¿®æ”¹mysqlæ•°æ®åº“ä¸­çš„è¡¨å½“æˆ‘ä»¬ä½¿ç”¨ALTER USERã€CREATE USERã€DROP USERã€GRANTã€RENAME USERã€REVOKEã€SET PASSWORDç­‰è¯­å¥æ—¶ä¹Ÿä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±äºçš„äº‹åŠ¡ã€‚ äº‹åŠ¡æ§åˆ¶æˆ–å…³äºé”å®šçš„è¯­å¥å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æˆ–è€…å›æ»šæ—¶å°±åˆä½¿ç”¨START TRANSACTIONæˆ–è€…BEGINè¯­å¥å¼€å¯äº†å¦ä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œä¼šéšå¼çš„æäº¤ä¸Šä¸€ä¸ªäº‹åŠ¡ï¼Œæ¯”å¦‚è¿™æ ·ï¼šæˆ–è€…å½“å‰çš„autocommitç³»ç»Ÿå˜é‡çš„å€¼ä¸ºOFFï¼Œæˆ‘ä»¬æ‰‹åŠ¨æŠŠå®ƒè°ƒä¸ºONæ—¶ï¼Œä¹Ÿä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±çš„äº‹åŠ¡ã€‚æˆ–è€…ä½¿ç”¨LOCK TABLESã€UNLOCK TABLESç­‰å…³äºé”å®šçš„è¯­å¥ä¹Ÿä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±çš„äº‹åŠ¡ã€‚ 1234567BEGIN;SELECT ... # äº‹åŠ¡ä¸­çš„ä¸€æ¡è¯­å¥UPDATE ... # äº‹åŠ¡ä¸­çš„ä¸€æ¡è¯­å¥... # äº‹åŠ¡ä¸­çš„å…¶å®ƒè¯­å¥BEGIN; # æ­¤è¯­å¥ä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±äºçš„äº‹åŠ¡ åŠ è½½æ•°æ®çš„è¯­å¥æ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨LOAD DATAè¯­å¥æ¥æ‰¹é‡å¾€æ•°æ®åº“ä¸­å¯¼å…¥æ•°æ®æ—¶ï¼Œä¹Ÿä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±çš„äº‹åŠ¡ã€‚ å…³äºMySQLå¤åˆ¶çš„ä¸€äº›è¯­å¥ä½¿ç”¨START SLAVEã€STOP SLAVEã€RESET SLAVEã€CHANGE MASTER TOç­‰è¯­å¥æ—¶ä¹Ÿä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±çš„äº‹åŠ¡ã€‚ å…¶å®ƒçš„ä¸€äº›è¯­å¥ä½¿ç”¨ANALYZE TABLEã€CACHE INDEXã€CHECK TABLEã€FLUSHã€ LOAD INDEX INTO CACHEã€OPTIMIZE TABLEã€REPAIR TABLEã€RESETç­‰è¯­å¥ä¹Ÿä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±çš„äº‹åŠ¡ã€‚ 7.ä¿å­˜ç‚¹å¦‚æœä½ å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶ä¸”å·²ç»æ•²äº†å¾ˆå¤šè¯­å¥ï¼Œå¿½ç„¶å‘ç°ä¸Šä¸€æ¡è¯­å¥æœ‰ç‚¹é—®é¢˜ï¼Œä½ åªå¥½ä½¿ç”¨ROLLBACKè¯­å¥æ¥è®©æ•°æ®åº“çŠ¶æ€æ¢å¤åˆ°äº‹åŠ¡æ‰§è¡Œä¹‹å‰çš„æ ·å­ï¼Œç„¶åä¸€åˆ‡ä»å¤´å†æ¥ï¼Œæ€»æœ‰ä¸€ç§ä¸€å¤œå›åˆ°è§£æ”¾å‰çš„æ„Ÿè§‰ã€‚æ‰€ä»¥MySQLæå‡ºäº†ä¸€ä¸ªä¿å­˜ç‚¹ï¼ˆè‹±æ–‡ï¼šsavepointï¼‰çš„æ¦‚å¿µï¼Œå°±æ˜¯åœ¨äº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“è¯­å¥ä¸­æ‰“å‡ ä¸ªç‚¹ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨ROLLBACKè¯­å¥æ—¶å¯ä»¥æŒ‡å®šä¼šæ»šåˆ°å“ªä¸ªç‚¹ï¼Œè€Œä¸æ˜¯å›åˆ°æœ€åˆçš„åŸç‚¹ã€‚å®šä¹‰ä¿å­˜ç‚¹çš„è¯­æ³•å¦‚ä¸‹ï¼š 1SAVEPOINT ä¿å­˜ç‚¹åç§°; å½“æˆ‘ä»¬æƒ³å›æ»šåˆ°æŸä¸ªä¿å­˜ç‚¹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹è¾¹è¿™ä¸ªè¯­å¥ï¼ˆä¸‹è¾¹è¯­å¥ä¸­çš„å•è¯WORKå’ŒSAVEPOINTæ˜¯å¯æœ‰å¯æ— çš„ï¼‰ï¼š 1ROLLBACK [WORK] TO [SAVEPOINT] ä¿å­˜ç‚¹åç§°; ä¸è¿‡å¦‚æœROLLBACKè¯­å¥åè¾¹ä¸è·Ÿéšä¿å­˜ç‚¹åç§°çš„è¯ï¼Œä¼šç›´æ¥å›æ»šåˆ°äº‹åŠ¡æ‰§è¡Œä¹‹å‰çš„çŠ¶æ€ã€‚ å¦‚æœæˆ‘ä»¬æƒ³åˆ é™¤æŸä¸ªä¿å­˜ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªè¯­å¥ï¼š 1RELEASE SAVEPOINT ä¿å­˜ç‚¹åç§°; ä¸‹è¾¹è¿˜æ˜¯ä»¥è½¬è´¦çš„ä¾‹å­å±•ç¤ºä¸€ä¸‹ä¿å­˜ç‚¹çš„ç”¨æ³•ï¼Œåœ¨æ‰§è¡Œå®Œæ‰£é™¤ç¬¬ä¸€ä¸ªè´¦æˆ·çš„é’±10å…ƒçš„è¯­å¥ä¹‹åæ‰“ä¸€ä¸ªä¿å­˜ç‚¹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243mysql&gt; SELECT * FROM account;+----+--------+---------+| id | name | balance |+----+--------+---------+| 1 | ç‹—å“¥ | 11 || 2 | çŒ«çˆ· | 2 |+----+--------+---------+2 rows in set (0.00 sec)mysql&gt; BEGIN;Query OK, 0 rows affected (0.00 sec)mysql&gt; UPDATE account SET balance = balance - 10 WHERE id = 1;Query OK, 1 row affected (0.01 sec)Rows matched: 1 Changed: 1 Warnings: 0mysql&gt; SAVEPOINT s1; # ä¸€ä¸ªä¿å­˜ç‚¹Query OK, 0 rows affected (0.00 sec)mysql&gt; SELECT * FROM account;+----+--------+---------+| id | name | balance |+----+--------+---------+| 1 | ç‹—å“¥ | 1 || 2 | çŒ«çˆ· | 2 |+----+--------+---------+2 rows in set (0.00 sec)mysql&gt; UPDATE account SET balance = balance + 1 WHERE id = 2; # æ›´æ–°é”™äº†Query OK, 1 row affected (0.00 sec)Rows matched: 1 Changed: 1 Warnings: 0mysql&gt; ROLLBACK TO s1; # å›æ»šåˆ°ä¿å­˜ç‚¹s1å¤„Query OK, 0 rows affected (0.00 sec)mysql&gt; SELECT * FROM account;+----+--------+---------+| id | name | balance |+----+--------+---------+| 1 | ç‹—å“¥ | 1 || 2 | çŒ«çˆ· | 2 |+----+--------+---------+2 rows in set (0.00 sec)","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[åäºŒ]InnoDBä¹‹BufferPool","slug":"MySQL/MySQL[åäºŒ]InnoDBä¹‹BufferPool","date":"2022-01-11T03:17:09.017Z","updated":"2022-01-11T03:24:53.735Z","comments":true,"path":"2022/01/11/MySQL/MySQL[åäºŒ]InnoDBä¹‹BufferPool/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E5%8D%81%E4%BA%8C]InnoDB%E4%B9%8BBufferPool/","excerpt":"","text":"ä¸€ï¼Œç¼“å­˜çš„é‡è¦æ€§å¯¹äºä½¿ç”¨InnoDBä½œä¸ºå­˜å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼Œä¸ç®¡æ˜¯ç”¨äºå­˜å‚¨ç”¨æˆ·æ•°æ®çš„ç´¢å¼•ï¼ˆåŒ…æ‹¬èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•ï¼‰ï¼Œè¿˜æ˜¯å„ç§ç³»ç»Ÿæ•°æ®ï¼Œéƒ½æ˜¯ä»¥é¡µçš„å½¢å¼å­˜æ”¾åœ¨è¡¨ç©ºé—´ä¸­çš„ï¼Œè€Œæ‰€è°“çš„è¡¨ç©ºé—´åªä¸è¿‡æ˜¯InnoDBå¯¹æ–‡ä»¶ç³»ç»Ÿä¸Šä¸€ä¸ªæˆ–å‡ ä¸ªå®é™…æ–‡ä»¶çš„æŠ½è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„æ•°æ®è¯´åˆ°åº•è¿˜æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„ã€‚ä½†æ˜¯ç£ç›˜å¤ªæ…¢äº†ï¼Œæ‰€ä»¥InnoDBå­˜å‚¨å¼•æ“åœ¨å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚æ—¶ï¼Œå½“éœ€è¦è®¿é—®æŸä¸ªé¡µçš„æ•°æ®æ—¶ï¼Œå°±ä¼šæŠŠå®Œæ•´çš„é¡µçš„æ•°æ®å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿æˆ‘ä»¬åªéœ€è¦è®¿é—®ä¸€ä¸ªé¡µçš„ä¸€æ¡è®°å½•ï¼Œé‚£ä¹Ÿéœ€è¦å…ˆæŠŠæ•´ä¸ªé¡µçš„æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å°†æ•´ä¸ªé¡µåŠ è½½åˆ°å†…å­˜ä¸­åå°±å¯ä»¥è¿›è¡Œè¯»å†™è®¿é—®äº†ï¼Œåœ¨è¿›è¡Œå®Œè¯»å†™è®¿é—®ä¹‹åå¹¶ä¸ç€æ€¥æŠŠè¯¥é¡µå¯¹åº”çš„å†…å­˜ç©ºé—´é‡Šæ”¾æ‰ï¼Œè€Œæ˜¯å°†å…¶ç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·å°†æ¥æœ‰è¯·æ±‚å†æ¬¡è®¿é—®è¯¥é¡µé¢æ—¶ï¼Œå°±å¯ä»¥çœå»ç£ç›˜IOçš„å¼€é”€äº†ã€‚ äºŒï¼ŒInnoDBçš„Buffer Pool 1.å•¥æ˜¯ä¸ªBuffer Poolä¸ºäº†ç¼“å­˜ç£ç›˜ä¸­çš„é¡µï¼Œåœ¨MySQLæœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™å°±å‘æ“ä½œç³»ç»Ÿç”³è¯·äº†ä¸€ç‰‡è¿ç»­çš„å†…å­˜ï¼Œå«åšBuffer Poolï¼ˆä¸­æ–‡åæ˜¯ç¼“å†²æ± ï¼‰ã€‚é‚£å®ƒæœ‰å¤šå¤§å‘¢ï¼Ÿè¿™ä¸ªå…¶å®çœ‹æˆ‘ä»¬æœºå™¨çš„é…ç½®ï¼Œé»˜è®¤æƒ…å†µä¸‹Buffer Poolåªæœ‰128Må¤§å°ï¼Œä½†æ˜¯å¯ä»¥åœ¨å¯åŠ¨æœåŠ¡å™¨çš„æ—¶å€™é…ç½®innodb_buffer_pool_sizeå‚æ•°çš„å€¼ï¼Œå®ƒè¡¨ç¤ºBuffer Poolçš„å¤§å°ï¼Œå°±åƒè¿™æ ·ï¼š 12[server]innodb_buffer_pool_size = 268435456 å…¶ä¸­ï¼Œ268435456çš„å•ä½æ˜¯å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æˆ‘æŒ‡å®šBuffer Poolçš„å¤§å°ä¸º256Mã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒBuffer Poolä¹Ÿä¸èƒ½å¤ªå°ï¼Œæœ€å°å€¼ä¸º5M(å½“å°äºè¯¥å€¼æ—¶ä¼šè‡ªåŠ¨è®¾ç½®æˆ5M)ã€‚ 2.Buffer Poolå†…éƒ¨ç»„æˆBuffer Poolä¸­é»˜è®¤çš„ç¼“å­˜é¡µå¤§å°å’Œåœ¨ç£ç›˜ä¸Šé»˜è®¤çš„é¡µå¤§å°æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯16KBã€‚ä¸ºäº†æ›´å¥½çš„ç®¡ç†è¿™äº›åœ¨Buffer Poolä¸­çš„ç¼“å­˜é¡µï¼ŒInnoDBä¸ºæ¯ä¸€ä¸ªç¼“å­˜é¡µéƒ½åˆ›å»ºäº†ä¸€äº›æ‰€è°“çš„æ§åˆ¶ä¿¡æ¯ï¼Œè¿™äº›æ§åˆ¶ä¿¡æ¯åŒ…æ‹¬è¯¥é¡µæ‰€å±çš„è¡¨ç©ºé—´ç¼–å·ã€é¡µå·ã€ç¼“å­˜é¡µåœ¨Buffer Poolä¸­çš„åœ°å€ã€é“¾è¡¨èŠ‚ç‚¹ä¿¡æ¯ã€ä¸€äº›é”ä¿¡æ¯ä»¥åŠLSNä¿¡æ¯ï¼ˆé”å’ŒLSNå…ˆå¿½ç•¥ï¼‰ï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›åˆ«çš„æ§åˆ¶ä¿¡æ¯ï¼Œæš‚æ—¶çœç•¥ã€‚ æ¯ä¸ªç¼“å­˜é¡µå¯¹åº”çš„æ§åˆ¶ä¿¡æ¯å ç”¨çš„å†…å­˜å¤§å°æ˜¯ç›¸åŒçš„ï¼Œæˆ‘ä»¬å°±æŠŠæ¯ä¸ªé¡µå¯¹åº”çš„æ§åˆ¶ä¿¡æ¯å ç”¨çš„ä¸€å—å†…å­˜ç§°ä¸ºä¸€ä¸ªæ§åˆ¶å—ï¼Œæ§åˆ¶å—å’Œç¼“å­˜é¡µæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå®ƒä»¬éƒ½è¢«å­˜æ”¾åˆ° Buffer Pool ä¸­ï¼Œå…¶ä¸­æ§åˆ¶å—è¢«å­˜æ”¾åˆ° Buffer Pool çš„å‰è¾¹ï¼Œç¼“å­˜é¡µè¢«å­˜æ”¾åˆ° Buffer Pool åè¾¹ã€‚ æ¯ä¸€ä¸ªæ§åˆ¶å—éƒ½å¯¹åº”ä¸€ä¸ªç¼“å­˜é¡µï¼Œé‚£åœ¨åˆ†é…è¶³å¤Ÿå¤šçš„æ§åˆ¶å—å’Œç¼“å­˜é¡µåï¼Œå¯èƒ½å‰©ä½™çš„é‚£ç‚¹å„¿ç©ºé—´ä¸å¤Ÿä¸€å¯¹æ§åˆ¶å—å’Œç¼“å­˜é¡µçš„å¤§å°ï¼Œè¿™ä¸ªç”¨ä¸åˆ°çš„é‚£ç‚¹å„¿å†…å­˜ç©ºé—´å°±è¢«ç§°ä¸ºç¢ç‰‡ã€‚å½“ç„¶ï¼Œå¦‚æœæŠŠBuffer Poolçš„å¤§å°è®¾ç½®çš„åˆšåˆšå¥½çš„è¯ï¼Œä¹Ÿå¯èƒ½ä¸ä¼šäº§ç”Ÿç¢ç‰‡ã€‚ æ¯ä¸ªæ§åˆ¶å—å¤§çº¦å ç”¨ç¼“å­˜é¡µå¤§å°çš„5%ï¼Œåœ¨MySQL5.7.21è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæ¯ä¸ªæ§åˆ¶å—å ç”¨çš„å¤§å°æ˜¯808å­—èŠ‚ã€‚è€Œæˆ‘ä»¬è®¾ç½®çš„innodb_buffer_pool_sizeå¹¶ä¸åŒ…å«è¿™éƒ¨åˆ†æ§åˆ¶å—å ç”¨çš„å†…å­˜ç©ºé—´å¤§å°ï¼Œä¹Ÿå°±æ˜¯è¯´InnoDBåœ¨ä¸ºBuffer Poolå‘æ“ä½œç³»ç»Ÿç”³è¯·è¿ç»­çš„å†…å­˜ç©ºé—´æ—¶ï¼Œè¿™ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ä¸€èˆ¬ä¼šæ¯”innodb_buffer_pool_sizeçš„å€¼å¤§5%å·¦å³ã€‚ 3.freeé“¾è¡¨çš„ç®¡ç†å½“æˆ‘ä»¬æœ€åˆå¯åŠ¨MySQLæœåŠ¡å™¨çš„æ—¶å€™ï¼Œéœ€è¦å®Œæˆå¯¹Buffer Poolçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå°±æ˜¯å…ˆå‘æ“ä½œç³»ç»Ÿç”³è¯·Buffer Poolçš„å†…å­˜ç©ºé—´ï¼Œç„¶åæŠŠå®ƒåˆ’åˆ†æˆè‹¥å¹²å¯¹æ§åˆ¶å—å’Œç¼“å­˜é¡µã€‚ä½†æ˜¯æ­¤æ—¶å¹¶æ²¡æœ‰çœŸå®çš„ç£ç›˜é¡µè¢«ç¼“å­˜åˆ°Buffer Poolä¸­ï¼ˆå› ä¸ºè¿˜æ²¡æœ‰ç”¨åˆ°ï¼‰ï¼Œä¹‹åéšç€ç¨‹åºçš„è¿è¡Œï¼Œä¼šä¸æ–­çš„æœ‰ç£ç›˜ä¸Šçš„é¡µè¢«ç¼“å­˜åˆ°Buffer Poolä¸­ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä»ç£ç›˜ä¸Šè¯»å–ä¸€ä¸ªé¡µåˆ°Buffer Poolä¸­çš„æ—¶å€™è¯¥æ”¾åˆ°å“ªä¸ªç¼“å­˜é¡µçš„ä½ç½®å‘¢ï¼Ÿæˆ–è€…è¯´æ€ä¹ˆåŒºåˆ†Buffer Poolä¸­å“ªäº›ç¼“å­˜é¡µæ˜¯ç©ºé—²çš„ï¼Œå“ªäº›å·²ç»è¢«ä½¿ç”¨äº†å‘¢ï¼Ÿæˆ‘ä»¬æœ€å¥½åœ¨æŸä¸ªåœ°æ–¹è®°å½•ä¸€ä¸‹Buffer Poolä¸­å“ªäº›ç¼“å­˜é¡µæ˜¯å¯ç”¨çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ‰€æœ‰ç©ºé—²çš„ç¼“å­˜é¡µå¯¹åº”çš„æ§åˆ¶å—ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹æ”¾åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œè¿™ä¸ªé“¾è¡¨ä¹Ÿå¯ä»¥è¢«ç§°ä½œfreeé“¾è¡¨ï¼ˆæˆ–è€…è¯´ç©ºé—²é“¾è¡¨ï¼‰ã€‚åˆšåˆšå®Œæˆåˆå§‹åŒ–çš„Buffer Poolä¸­æ‰€æœ‰çš„ç¼“å­˜é¡µéƒ½æ˜¯ç©ºé—²çš„ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªç¼“å­˜é¡µå¯¹åº”çš„æ§åˆ¶å—éƒ½ä¼šè¢«åŠ å…¥åˆ°freeé“¾è¡¨ä¸­ã€‚ ä¸ºäº†ç®¡ç†å¥½è¿™ä¸ªfreeé“¾è¡¨ï¼Œç‰¹æ„ä¸ºè¿™ä¸ªé“¾è¡¨å®šä¹‰äº†ä¸€ä¸ªåŸºèŠ‚ç‚¹ï¼Œé‡Œè¾¹å„¿åŒ…å«ç€é“¾è¡¨çš„å¤´èŠ‚ç‚¹åœ°å€ï¼Œå°¾èŠ‚ç‚¹åœ°å€ï¼Œä»¥åŠå½“å‰é“¾è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ç­‰ä¿¡æ¯ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé“¾è¡¨çš„åŸºèŠ‚ç‚¹å ç”¨çš„å†…å­˜ç©ºé—´å¹¶ä¸åŒ…å«åœ¨ä¸ºBuffer Poolç”³è¯·çš„ä¸€å¤§ç‰‡è¿ç»­å†…å­˜ç©ºé—´ä¹‹å†…ï¼Œè€Œæ˜¯å•ç‹¬ç”³è¯·çš„ä¸€å—å†…å­˜ç©ºé—´ã€‚ é“¾è¡¨åŸºèŠ‚ç‚¹å ç”¨çš„å†…å­˜ç©ºé—´å¹¶ä¸å¤§ï¼Œåœ¨MySQL5.7.21è¿™ä¸ªç‰ˆæœ¬é‡Œï¼Œæ¯ä¸ªåŸºèŠ‚ç‚¹åªå ç”¨40å­—èŠ‚å¤§å°ã€‚åè¾¹æˆ‘ä»¬å³å°†ä»‹ç»è®¸å¤šä¸åŒçš„é“¾è¡¨ï¼Œå®ƒä»¬çš„åŸºèŠ‚ç‚¹å’Œfreeé“¾è¡¨çš„åŸºèŠ‚ç‚¹çš„å†…å­˜åˆ†é…æ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯å•ç‹¬ç”³è¯·çš„ä¸€å—40å­—èŠ‚å¤§å°çš„å†…å­˜ç©ºé—´ï¼Œå¹¶ä¸åŒ…å«åœ¨ä¸ºBuffer Poolç”³è¯·çš„ä¸€å¤§ç‰‡è¿ç»­å†…å­˜ç©ºé—´ä¹‹å†…ã€‚ æœ‰äº†è¿™ä¸ªfreeé“¾è¡¨ä¹‹åï¼Œæ¯å½“éœ€è¦ä»ç£ç›˜ä¸­åŠ è½½ä¸€ä¸ªé¡µåˆ°Buffer Poolä¸­æ—¶ï¼Œå°±ä»freeé“¾è¡¨ä¸­å–ä¸€ä¸ªç©ºé—²çš„ç¼“å­˜é¡µï¼Œå¹¶ä¸”æŠŠè¯¥ç¼“å­˜é¡µå¯¹åº”çš„æ§åˆ¶å—çš„ä¿¡æ¯å¡«ä¸Šï¼ˆå°±æ˜¯è¯¥é¡µæ‰€åœ¨çš„è¡¨ç©ºé—´ã€é¡µå·ä¹‹ç±»çš„ä¿¡æ¯ï¼‰ï¼Œç„¶åæŠŠè¯¥ç¼“å­˜é¡µå¯¹åº”çš„freeé“¾è¡¨èŠ‚ç‚¹ä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œè¡¨ç¤ºè¯¥ç¼“å­˜é¡µå·²ç»è¢«ä½¿ç”¨äº†ã€‚ 4.ç¼“å­˜é¡µçš„å“ˆå¸Œå¤„ç†å½“æˆ‘ä»¬éœ€è¦è®¿é—®æŸä¸ªé¡µä¸­çš„æ•°æ®æ—¶ï¼Œå°±ä¼šæŠŠè¯¥é¡µä»ç£ç›˜åŠ è½½åˆ°Buffer Poolä¸­ï¼Œå¦‚æœè¯¥é¡µå·²ç»åœ¨Buffer Poolä¸­çš„è¯ç›´æ¥ä½¿ç”¨å°±å¯ä»¥äº†ã€‚é‚£ä¹ˆé—®é¢˜ä¹Ÿå°±æ¥äº†ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¯¥é¡µåœ¨ä¸åœ¨Buffer Poolä¸­å‘¢ï¼Ÿéš¾ä¸æˆéœ€è¦ä¾æ¬¡éå†Buffer Poolä¸­å„ä¸ªç¼“å­˜é¡µä¹ˆï¼Ÿ æˆ‘ä»¬å…¶å®æ˜¯æ ¹æ®è¡¨ç©ºé—´å· + é¡µå·æ¥å®šä½ä¸€ä¸ªé¡µçš„ï¼Œä¹Ÿå°±ç›¸å½“äºè¡¨ç©ºé—´å· + é¡µå·æ˜¯ä¸€ä¸ªkeyï¼Œç¼“å­˜é¡µå°±æ˜¯å¯¹åº”çš„valueï¼Œæ€ä¹ˆé€šè¿‡ä¸€ä¸ªkeyæ¥å¿«é€Ÿæ‰¾ç€ä¸€ä¸ªvalueå‘¢ï¼Ÿé‚£è‚¯å®šæ˜¯å“ˆå¸Œè¡¨ã€‚ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨è¡¨ç©ºé—´å· + é¡µå·ä½œä¸ºkeyï¼Œç¼“å­˜é¡µä½œä¸ºvalueåˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œåœ¨éœ€è¦è®¿é—®æŸä¸ªé¡µçš„æ•°æ®æ—¶ï¼Œå…ˆä»å“ˆå¸Œè¡¨ä¸­æ ¹æ®è¡¨ç©ºé—´å· + é¡µå·çœ‹çœ‹æœ‰æ²¡æœ‰å¯¹åº”çš„ç¼“å­˜é¡µï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥ä½¿ç”¨è¯¥ç¼“å­˜é¡µå°±å¥½ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£å°±ä»freeé“¾è¡¨ä¸­é€‰ä¸€ä¸ªç©ºé—²çš„ç¼“å­˜é¡µï¼Œç„¶åæŠŠç£ç›˜ä¸­å¯¹åº”çš„é¡µåŠ è½½åˆ°è¯¥ç¼“å­˜é¡µçš„ä½ç½®ã€‚ 5.flushé“¾è¡¨çš„ç®¡ç†å¦‚æœæˆ‘ä»¬ä¿®æ”¹äº†Buffer Poolä¸­æŸä¸ªç¼“å­˜é¡µçš„æ•°æ®ï¼Œé‚£å®ƒå°±å’Œç£ç›˜ä¸Šçš„é¡µä¸ä¸€è‡´äº†ï¼Œè¿™æ ·çš„ç¼“å­˜é¡µä¹Ÿè¢«ç§°ä¸ºè„é¡µï¼ˆè‹±æ–‡åï¼šdirty pageï¼‰ã€‚æœ€ç®€å•çš„åšæ³•å°±æ˜¯æ¯å‘ç”Ÿä¸€æ¬¡ä¿®æ”¹å°±ç«‹å³åŒæ­¥åˆ°ç£ç›˜ä¸Šå¯¹åº”çš„é¡µä¸Šï¼Œä½†æ˜¯é¢‘ç¹çš„å¾€ç£ç›˜ä¸­å†™æ•°æ®ä¼šä¸¥é‡çš„å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚æ‰€ä»¥æ¯æ¬¡ä¿®æ”¹ç¼“å­˜é¡µåï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸€èˆ¬å¼‚æ­¥åŒæ­¥ç£ç›˜ã€‚ ä½†æ˜¯å¦‚æœä¸ç«‹å³åŒæ­¥åˆ°ç£ç›˜çš„è¯ï¼Œé‚£ä¹‹åå†åŒæ­¥çš„æ—¶å€™æˆ‘ä»¬æ€ä¹ˆçŸ¥é“Buffer Poolä¸­å“ªäº›é¡µæ˜¯è„é¡µï¼Œå“ªäº›é¡µä»æ¥æ²¡è¢«ä¿®æ”¹è¿‡å‘¢ï¼Ÿåˆ›å»ºä¸€ä¸ªå­˜å‚¨è„é¡µçš„é“¾è¡¨ï¼Œå‡¡æ˜¯ä¿®æ”¹è¿‡çš„ç¼“å­˜é¡µå¯¹åº”çš„æ§åˆ¶å—éƒ½ä¼šä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œå› ä¸ºè¿™ä¸ªé“¾è¡¨èŠ‚ç‚¹å¯¹åº”çš„ç¼“å­˜é¡µéƒ½æ˜¯éœ€è¦è¢«åˆ·æ–°åˆ°ç£ç›˜ä¸Šçš„ï¼Œæ‰€ä»¥ä¹Ÿå«flushé“¾è¡¨ã€‚é“¾è¡¨çš„æ„é€ å’Œfreeé“¾è¡¨å·®ä¸å¤šã€‚ 6.LRUé“¾è¡¨çš„ç®¡ç†6.1 ç¼“å­˜ä¸å¤Ÿçš„çª˜å¢ƒBuffer Poolå¯¹åº”çš„å†…å­˜å¤§å°æ¯•ç«Ÿæ˜¯æœ‰é™çš„ï¼Œå¦‚æœéœ€è¦ç¼“å­˜çš„é¡µå ç”¨çš„å†…å­˜å¤§å°è¶…è¿‡äº†Buffer Poolå¤§å°ï¼Œä¹Ÿå°±æ˜¯freeé“¾è¡¨ä¸­å·²ç»æ²¡æœ‰å¤šä½™çš„ç©ºé—²ç¼“å­˜é¡µå’‹åŠï¼Ÿå½“ç„¶æ˜¯æŠŠæŸäº›æ—§çš„ç¼“å­˜é¡µä»Buffer Poolä¸­ç§»é™¤ï¼Œç„¶åå†æŠŠæ–°çš„é¡µæ”¾è¿›æ¥ï¼Œ é‚£ä¹ˆç§»é™¤å“ªäº›ç¼“å­˜é¡µå‘¢ï¼Ÿ æˆ‘ä»¬è®¾ç«‹Buffer Poolçš„åˆè¡·å°±æ˜¯æƒ³å‡å°‘å’Œç£ç›˜çš„IOäº¤äº’ï¼Œæœ€å¥½æ¯æ¬¡åœ¨è®¿é—®æŸä¸ªé¡µçš„æ—¶å€™å®ƒéƒ½å·²ç»è¢«ç¼“å­˜åˆ°Buffer Poolä¸­äº†ã€‚å‡è®¾æˆ‘ä»¬ä¸€å…±è®¿é—®äº†næ¬¡é¡µï¼Œé‚£ä¹ˆè¢«è®¿é—®çš„é¡µå·²ç»åœ¨ç¼“å­˜ä¸­çš„æ¬¡æ•°é™¤ä»¥nå°±æ˜¯æ‰€è°“çš„ç¼“å­˜å‘½ä¸­ç‡ï¼Œæˆ‘ä»¬çš„æœŸæœ›å°±æ˜¯è®©ç¼“å­˜å‘½ä¸­ç‡è¶Šé«˜è¶Šå¥½ã€‚æ‰€ä»¥æ˜¯ç•™ä¸‹æœ€è¿‘å¾ˆé¢‘ç¹ä½¿ç”¨çš„ã€‚ 6.2ç®€å•çš„LRUé“¾è¡¨ç®¡ç†Buffer Poolçš„ç¼“å­˜é¡µå…¶å®ä¹Ÿæ˜¯è¿™ä¸ªé“ç†ï¼Œå½“Buffer Poolä¸­ä¸å†æœ‰ç©ºé—²çš„ç¼“å­˜é¡µæ—¶ï¼Œå°±éœ€è¦æ·˜æ±°æ‰éƒ¨åˆ†æœ€è¿‘å¾ˆå°‘ä½¿ç”¨çš„ç¼“å­˜é¡µã€‚æ€ä¹ˆçŸ¥é“å“ªäº›ç¼“å­˜é¡µæœ€è¿‘é¢‘ç¹ä½¿ç”¨ï¼Œå“ªäº›æœ€è¿‘å¾ˆå°‘ä½¿ç”¨å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å†åˆ›å»ºä¸€ä¸ªé“¾è¡¨ï¼Œç”±äºè¿™ä¸ªé“¾è¡¨æ˜¯ä¸ºäº†æŒ‰ç…§æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„åŸåˆ™å»æ·˜æ±°ç¼“å­˜é¡µçš„ï¼Œæ‰€ä»¥è¿™ä¸ªé“¾è¡¨å¯ä»¥è¢«ç§°ä¸ºLRUé“¾è¡¨ï¼ˆLRUçš„è‹±æ–‡å…¨ç§°ï¼šLeast Recently Usedï¼‰ã€‚å½“æˆ‘ä»¬éœ€è¦è®¿é—®æŸä¸ªé¡µæ—¶ï¼Œå¯ä»¥è¿™æ ·å¤„ç†LRUé“¾è¡¨ï¼š å¦‚æœè¯¥é¡µä¸åœ¨Buffer Poolä¸­ï¼Œåœ¨æŠŠè¯¥é¡µä»ç£ç›˜åŠ è½½åˆ°Buffer Poolä¸­çš„ç¼“å­˜é¡µæ—¶ï¼Œå°±æŠŠè¯¥ç¼“å­˜é¡µå¯¹åº”çš„æ§åˆ¶å—ä½œä¸ºèŠ‚ç‚¹å¡åˆ°é“¾è¡¨çš„å¤´éƒ¨ã€‚ å¦‚æœè¯¥é¡µå·²ç»ç¼“å­˜åœ¨Buffer Poolä¸­ï¼Œåˆ™ç›´æ¥æŠŠè¯¥é¡µå¯¹åº”çš„æ§åˆ¶å—ç§»åŠ¨åˆ°LRUé“¾è¡¨çš„å¤´éƒ¨ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼šåªè¦æˆ‘ä»¬ä½¿ç”¨åˆ°æŸä¸ªç¼“å­˜é¡µï¼Œå°±æŠŠè¯¥ç¼“å­˜é¡µè°ƒæ•´åˆ°LRUé“¾è¡¨çš„å¤´éƒ¨ï¼Œè¿™æ ·LRUé“¾è¡¨å°¾éƒ¨å°±æ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜é¡µäº†ã€‚ æ‰€ä»¥å½“Buffer Poolä¸­çš„ç©ºé—²ç¼“å­˜é¡µä½¿ç”¨å®Œæ—¶ï¼Œåˆ°LRUé“¾è¡¨çš„å°¾éƒ¨æ‰¾äº›ç¼“å­˜é¡µæ·˜æ±°ã€‚ 6.3åˆ’åˆ†åŒºåŸŸçš„LRUé“¾è¡¨ä¸Šè¾¹çš„è¿™ä¸ªç®€å•çš„LRUé“¾è¡¨æœ‰é—®é¢˜ï¼Œå› ä¸ºå­˜åœ¨è¿™ä¸¤ç§æ¯”è¾ƒå°´å°¬çš„æƒ…å†µï¼š æƒ…å†µä¸€ï¼šInnoDBæä¾›äº†ä¸€ä¸ªæœåŠ¡â€”â€”é¢„è¯»ï¼ˆè‹±æ–‡åï¼šread aheadï¼‰ã€‚æ‰€è°“é¢„è¯»ï¼Œå°±æ˜¯InnoDBè®¤ä¸ºæ‰§è¡Œå½“å‰çš„è¯·æ±‚å¯èƒ½ä¹‹åä¼šè¯»å–æŸäº›é¡µé¢ï¼Œå°±é¢„å…ˆæŠŠå®ƒä»¬åŠ è½½åˆ°Buffer Poolä¸­ã€‚æ ¹æ®è§¦å‘æ–¹å¼çš„ä¸åŒï¼Œé¢„è¯»åˆå¯ä»¥ç»†åˆ†ä¸ºä¸‹è¾¹ä¸¤ç§ï¼š çº¿æ€§é¢„è¯»InnoDBæä¾›äº†ä¸€ä¸ªç³»ç»Ÿå˜é‡innodb_read_ahead_thresholdï¼Œå¦‚æœé¡ºåºè®¿é—®äº†æŸä¸ªåŒºï¼ˆextentï¼‰çš„é¡µé¢è¶…è¿‡è¿™ä¸ªç³»ç»Ÿå˜é‡çš„å€¼ï¼Œå°±ä¼šè§¦å‘ä¸€æ¬¡å¼‚æ­¥è¯»å–ä¸‹ä¸€ä¸ªåŒºä¸­å…¨éƒ¨çš„é¡µé¢åˆ°Buffer Poolçš„è¯·æ±‚ï¼Œå¼‚æ­¥è¯»å–æ„å‘³ç€ä»ç£ç›˜ä¸­åŠ è½½è¿™äº›è¢«é¢„è¯»çš„é¡µé¢å¹¶ä¸ä¼šå½±å“åˆ°å½“å‰å·¥ä½œçº¿ç¨‹çš„æ­£å¸¸æ‰§è¡Œã€‚è¿™ä¸ªinnodb_read_ahead_thresholdç³»ç»Ÿå˜é‡çš„å€¼é»˜è®¤æ˜¯56ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶é€šè¿‡å¯åŠ¨å‚æ•°æˆ–è€…æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­ç›´æ¥è°ƒæ•´è¯¥ç³»ç»Ÿå˜é‡çš„å€¼ï¼Œä¸è¿‡å®ƒæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ³¨æ„ä½¿ç”¨SET GLOBALå‘½ä»¤æ¥ä¿®æ”¹ã€‚ InnoDBæ˜¯æ€ä¹ˆå®ç°å¼‚æ­¥è¯»å–çš„å‘¢ï¼Ÿåœ¨Windowsæˆ–è€…Linuxå¹³å°ä¸Šï¼Œå¯èƒ½æ˜¯ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„AIOæ¥å£ï¼Œåœ¨å…¶å®ƒç±»Unixæ“ä½œç³»ç»Ÿä¸­ï¼Œä½¿ç”¨äº†ä¸€ç§æ¨¡æ‹ŸAIOæ¥å£çš„æ–¹å¼æ¥å®ç°å¼‚æ­¥è¯»å–ï¼Œå…¶å®å°±æ˜¯è®©åˆ«çš„çº¿ç¨‹å»è¯»å–éœ€è¦é¢„è¯»çš„é¡µé¢ã€‚ éšæœºé¢„è¯»å¦‚æœBuffer Poolä¸­å·²ç»ç¼“å­˜äº†æŸä¸ªåŒºçš„13ä¸ªè¿ç»­çš„é¡µé¢ï¼Œä¸è®ºè¿™äº›é¡µé¢æ˜¯ä¸æ˜¯é¡ºåºè¯»å–çš„ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡å¼‚æ­¥è¯»å–æœ¬åŒºä¸­æ‰€æœ‰å…¶çš„é¡µé¢åˆ°Buffer Poolçš„è¯·æ±‚ã€‚InnoDBåŒæ—¶æä¾›äº†innodb_random_read_aheadç³»ç»Ÿå˜é‡ï¼Œå®ƒçš„é»˜è®¤å€¼ä¸ºOFFï¼Œä¹Ÿå°±æ„å‘³ç€InnoDBå¹¶ä¸ä¼šé»˜è®¤å¼€å¯éšæœºé¢„è¯»çš„åŠŸèƒ½ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å¼€å¯è¯¥åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹å¯åŠ¨å‚æ•°æˆ–è€…ç›´æ¥ä½¿ç”¨SET GLOBALå‘½ä»¤æŠŠè¯¥å˜é‡çš„å€¼è®¾ç½®ä¸ºONã€‚ å¦‚æœé¢„è¯»åˆ°Buffer Poolä¸­çš„é¡µæˆåŠŸçš„è¢«ä½¿ç”¨åˆ°ï¼Œé‚£å°±å¯ä»¥æå¤§çš„æé«˜è¯­å¥æ‰§è¡Œçš„æ•ˆç‡ã€‚å¯æ˜¯å¦‚æœç”¨ä¸åˆ°å‘¢ï¼Ÿè¿™äº›é¢„è¯»çš„é¡µéƒ½ä¼šæ”¾åˆ°LRUé“¾è¡¨çš„å¤´éƒ¨ï¼Œä½†æ˜¯å¦‚æœæ­¤æ—¶Buffer Poolçš„å®¹é‡ä¸å¤ªå¤§è€Œä¸”å¾ˆå¤šé¢„è¯»çš„é¡µé¢éƒ½æ²¡æœ‰ç”¨åˆ°çš„è¯ï¼Œè¿™å°±ä¼šå¯¼è‡´å¤„åœ¨LRUé“¾è¡¨å°¾éƒ¨çš„ä¸€äº›ç¼“å­˜é¡µä¼šå¾ˆå¿«çš„è¢«æ·˜æ±°æ‰ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„åŠ£å¸é©±é€è‰¯å¸ï¼Œä¼šå¤§å¤§é™ä½ç¼“å­˜å‘½ä¸­ç‡ã€‚ æƒ…å†µäºŒï¼šæœ‰ä¸€äº›æ‰«æå…¨è¡¨çš„æŸ¥è¯¢è¯­å¥ï¼ˆæ¯”å¦‚æ²¡æœ‰å»ºç«‹åˆé€‚çš„ç´¢å¼•æˆ–è€…å‹æ ¹å„¿æ²¡æœ‰WHEREå­å¥çš„æŸ¥è¯¢ï¼‰ã€‚æ‰«æå…¨è¡¨æ„å‘³ç€å°†è®¿é—®åˆ°è¯¥è¡¨æ‰€åœ¨çš„æ‰€æœ‰é¡µï¼å‡è®¾è¿™ä¸ªè¡¨ä¸­è®°å½•éå¸¸å¤šçš„è¯ï¼Œé‚£è¯¥è¡¨ä¼šå ç”¨ç‰¹åˆ«å¤šçš„é¡µï¼Œå½“éœ€è¦è®¿é—®è¿™äº›é¡µæ—¶ï¼Œä¼šæŠŠå®ƒä»¬ç»Ÿç»Ÿéƒ½åŠ è½½åˆ°Buffer Poolä¸­ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€Buffer Poolä¸­çš„æ‰€æœ‰é¡µéƒ½è¢«æ¢äº†ä¸€æ¬¡ï¼Œå…¶ä»–æŸ¥è¯¢è¯­å¥åœ¨æ‰§è¡Œæ—¶åˆå¾—æ‰§è¡Œä¸€æ¬¡ä»ç£ç›˜åŠ è½½åˆ°Buffer Poolçš„æ“ä½œã€‚è€Œè¿™ç§å…¨è¡¨æ‰«æçš„è¯­å¥æ‰§è¡Œçš„é¢‘ç‡ä¹Ÿä¸é«˜ï¼Œæ¯æ¬¡æ‰§è¡Œéƒ½è¦æŠŠBuffer Poolä¸­çš„ç¼“å­˜é¡µæ¢ä¸€æ¬¡ï¼Œè¿™ä¸¥é‡çš„å½±å“åˆ°å…¶ä»–æŸ¥è¯¢å¯¹ Buffer Poolçš„ä½¿ç”¨ï¼Œä»è€Œå¤§å¤§é™ä½äº†ç¼“å­˜å‘½ä¸­ç‡ã€‚ æ€»ç»“ä¸€ä¸‹ä¸Šè¾¹è¯´çš„å¯èƒ½é™ä½Buffer Poolçš„ä¸¤ç§æƒ…å†µï¼š åŠ è½½åˆ°Buffer Poolä¸­çš„é¡µä¸ä¸€å®šè¢«ç”¨åˆ°ã€‚ å¦‚æœéå¸¸å¤šçš„ä½¿ç”¨é¢‘ç‡åä½çš„é¡µè¢«åŒæ—¶åŠ è½½åˆ°Buffer Poolæ—¶ï¼Œå¯èƒ½ä¼šæŠŠé‚£äº›ä½¿ç”¨é¢‘ç‡éå¸¸é«˜çš„é¡µä»Buffer Poolä¸­æ·˜æ±°æ‰ã€‚ å› ä¸ºæœ‰è¿™ä¸¤ç§æƒ…å†µçš„å­˜åœ¨ï¼Œæ‰€ä»¥InnoDBæŠŠè¿™ä¸ªLRUé“¾è¡¨æŒ‰ç…§ä¸€å®šæ¯”ä¾‹åˆ†æˆä¸¤æˆªï¼Œåˆ†åˆ«æ˜¯ï¼š ä¸€éƒ¨åˆ†å­˜å‚¨ä½¿ç”¨é¢‘ç‡éå¸¸é«˜çš„ç¼“å­˜é¡µï¼Œæ‰€ä»¥è¿™ä¸€éƒ¨åˆ†é“¾è¡¨ä¹Ÿå«åšçƒ­æ•°æ®ï¼Œæˆ–è€…ç§°youngåŒºåŸŸã€‚ å¦ä¸€éƒ¨åˆ†å­˜å‚¨ä½¿ç”¨é¢‘ç‡ä¸æ˜¯å¾ˆé«˜çš„ç¼“å­˜é¡µï¼Œæ‰€ä»¥è¿™ä¸€éƒ¨åˆ†é“¾è¡¨ä¹Ÿå«åšå†·æ•°æ®ï¼Œæˆ–è€…ç§°oldåŒºåŸŸã€‚ æˆ‘ä»¬æ˜¯æŒ‰ç…§æŸä¸ªæ¯”ä¾‹å°†LRUé“¾è¡¨åˆ†æˆä¸¤åŠçš„ï¼Œä¸æ˜¯æŸäº›èŠ‚ç‚¹å›ºå®šæ˜¯youngåŒºåŸŸçš„ï¼ŒæŸäº›èŠ‚ç‚¹å›ºå®šæ˜¯oldåŒºåŸŸçš„ï¼Œéšç€ç¨‹åºçš„è¿è¡Œï¼ŒæŸä¸ªèŠ‚ç‚¹æ‰€å±çš„åŒºåŸŸä¹Ÿå¯èƒ½å‘ç”Ÿå˜åŒ–ã€‚é‚£è¿™ä¸ªåˆ’åˆ†æˆä¸¤æˆªçš„æ¯”ä¾‹æ€ä¹ˆç¡®å®šå‘¢ï¼Ÿå¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹ç³»ç»Ÿå˜é‡innodb_old_blocks_pctçš„å€¼æ¥ç¡®å®šoldåŒºåŸŸåœ¨LRUé“¾è¡¨ä¸­æ‰€å çš„æ¯”ä¾‹ï¼Œæ¯”æ–¹è¯´è¿™æ ·ï¼š 1234567mysql&gt; SHOW VARIABLES LIKE &#x27;innodb_old_blocks_pct&#x27;;+-----------------------+-------+| Variable_name | Value |+-----------------------+-------+| innodb_old_blocks_pct | 37 |+-----------------------+-------+1 row in set (0.01 sec) ä»ç»“æœå¯ä»¥çœ‹å‡ºæ¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒoldåŒºåŸŸåœ¨LRUé“¾è¡¨ä¸­æ‰€å çš„æ¯”ä¾‹æ˜¯37%ï¼Œä¹Ÿå°±æ˜¯è¯´oldåŒºåŸŸå¤§çº¦å LRUé“¾è¡¨çš„3/8ã€‚è¿™ä¸ªæ¯”ä¾‹æˆ‘ä»¬æ˜¯å¯ä»¥è®¾ç½®çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¯åŠ¨æ—¶ä¿®æ”¹innodb_old_blocks_pctå‚æ•°æ¥æ§åˆ¶oldåŒºåŸŸåœ¨LRUé“¾è¡¨ä¸­æ‰€å çš„æ¯”ä¾‹ï¼Œæ¯”æ–¹è¯´è¿™æ ·ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š 12[server]innodb_old_blocks_pct = 40 è¿™æ ·æˆ‘ä»¬åœ¨å¯åŠ¨æœåŠ¡å™¨åï¼ŒoldåŒºåŸŸå LRUé“¾è¡¨çš„æ¯”ä¾‹å°±æ˜¯40%ã€‚å½“ç„¶ï¼Œå¦‚æœåœ¨æœåŠ¡å™¨è¿è¡ŒæœŸé—´ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹è¿™ä¸ªç³»ç»Ÿå˜é‡çš„å€¼ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªç³»ç»Ÿå˜é‡å±äºå…¨å±€å˜é‡ï¼Œä¸€ç»ä¿®æ”¹ï¼Œä¼šå¯¹æ‰€æœ‰å®¢æˆ·ç«¯ç”Ÿæ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½è¿™æ ·ä¿®æ”¹ï¼š 1SET GLOBAL innodb_old_blocks_pct = 40; æœ‰äº†è¿™ä¸ªè¢«åˆ’åˆ†æˆyoungå’ŒoldåŒºåŸŸçš„LRUé“¾è¡¨ä¹‹åï¼ŒInnoDBå°±å¯ä»¥é’ˆå¯¹æˆ‘ä»¬ä¸Šè¾¹æåˆ°çš„ä¸¤ç§å¯èƒ½é™ä½ç¼“å­˜å‘½ä¸­ç‡çš„æƒ…å†µè¿›è¡Œä¼˜åŒ–ï¼š é’ˆå¯¹é¢„è¯»çš„é¡µé¢å¯èƒ½ä¸è¿›è¡Œåç»­è®¿é—®æƒ…å†µçš„ä¼˜åŒ–InnoDBè§„å®šï¼Œå½“ç£ç›˜ä¸Šçš„æŸä¸ªé¡µé¢åœ¨åˆæ¬¡åŠ è½½åˆ°Buffer Poolä¸­çš„æŸä¸ªç¼“å­˜é¡µæ—¶ï¼Œè¯¥ç¼“å­˜é¡µå¯¹åº”çš„æ§åˆ¶å—ä¼šè¢«æ”¾åˆ°oldåŒºåŸŸçš„å¤´éƒ¨ã€‚è¿™æ ·é’ˆå¯¹é¢„è¯»åˆ°Buffer Poolå´ä¸è¿›è¡Œåç»­è®¿é—®çš„é¡µé¢å°±ä¼šè¢«é€æ¸ä»oldåŒºåŸŸé€å‡ºï¼Œè€Œä¸ä¼šå½±å“youngåŒºåŸŸä¸­è¢«ä½¿ç”¨æ¯”è¾ƒé¢‘ç¹çš„ç¼“å­˜é¡µã€‚ é’ˆå¯¹å…¨è¡¨æ‰«ææ—¶ï¼ŒçŸ­æ—¶é—´å†…è®¿é—®å¤§é‡ä½¿ç”¨é¢‘ç‡éå¸¸ä½çš„é¡µé¢æƒ…å†µçš„ä¼˜åŒ–åœ¨è¿›è¡Œå…¨è¡¨æ‰«ææ—¶ï¼Œè™½ç„¶é¦–æ¬¡è¢«åŠ è½½åˆ°Buffer Poolçš„é¡µè¢«æ”¾åˆ°äº†oldåŒºåŸŸçš„å¤´éƒ¨ï¼Œä½†æ˜¯åç»­ä¼šè¢«é©¬ä¸Šè®¿é—®åˆ°ï¼Œæ¯æ¬¡è¿›è¡Œè®¿é—®çš„æ—¶å€™åˆä¼šæŠŠè¯¥é¡µæ”¾åˆ°youngåŒºåŸŸçš„å¤´éƒ¨ï¼Œè¿™æ ·ä»ç„¶ä¼šæŠŠé‚£äº›ä½¿ç”¨é¢‘ç‡æ¯”è¾ƒé«˜çš„é¡µé¢ç»™é¡¶ä¸‹å»ã€‚å…¨è¡¨æ‰«ææœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œé‚£å°±æ˜¯å®ƒçš„æ‰§è¡Œé¢‘ç‡éå¸¸ä½ï¼Œè€Œä¸”åœ¨æ‰§è¡Œå…¨è¡¨æ‰«æçš„è¿‡ç¨‹ä¸­ï¼Œå³ä½¿æŸä¸ªé¡µé¢ä¸­æœ‰å¾ˆå¤šæ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯å»å¤šæ¬¡è®¿é—®è¿™ä¸ªé¡µé¢æ‰€èŠ±è´¹çš„æ—¶é—´ä¹Ÿæ˜¯éå¸¸å°‘çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è§„å®šï¼Œåœ¨å¯¹æŸä¸ªå¤„åœ¨oldåŒºåŸŸçš„ç¼“å­˜é¡µè¿›è¡Œç¬¬ä¸€æ¬¡è®¿é—®æ—¶å°±åœ¨å®ƒå¯¹åº”çš„æ§åˆ¶å—ä¸­è®°å½•ä¸‹æ¥è¿™ä¸ªè®¿é—®æ—¶é—´ï¼Œå¦‚æœåç»­çš„è®¿é—®æ—¶é—´ä¸ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶é—´åœ¨æŸä¸ªæ—¶é—´é—´éš”å†…ï¼Œé‚£ä¹ˆè¯¥é¡µé¢å°±ä¸ä¼šè¢«ä»oldåŒºåŸŸç§»åŠ¨åˆ°youngåŒºåŸŸçš„å¤´éƒ¨ï¼Œå¦åˆ™å°†å®ƒç§»åŠ¨åˆ°youngåŒºåŸŸçš„å¤´éƒ¨ã€‚ä¸Šè¿°çš„è¿™ä¸ªé—´éš”æ—¶é—´æ˜¯ç”±ç³»ç»Ÿå˜é‡innodb_old_blocks_timeæ§åˆ¶çš„ï¼š 1234567mysql&gt; SHOW VARIABLES LIKE &#x27;innodb_old_blocks_time&#x27;;+------------------------+-------+| Variable_name | Value |+------------------------+-------+| innodb_old_blocks_time | 1000 |+------------------------+-------+1 row in set (0.01 sec) è¿™ä¸ªinnodb_old_blocks_timeçš„é»˜è®¤å€¼æ˜¯1000ï¼Œå®ƒçš„å•ä½æ˜¯æ¯«ç§’ï¼Œä¹Ÿå°±æ„å‘³ç€å¯¹äºä»ç£ç›˜ä¸Šè¢«åŠ è½½åˆ°LRUé“¾è¡¨çš„oldåŒºåŸŸçš„æŸä¸ªé¡µæ¥è¯´ï¼Œå¦‚æœç¬¬ä¸€æ¬¡å’Œæœ€åä¸€æ¬¡è®¿é—®è¯¥é¡µé¢çš„æ—¶é—´é—´éš”å°äº1sï¼ˆå¾ˆæ˜æ˜¾åœ¨ä¸€æ¬¡å…¨è¡¨æ‰«æçš„è¿‡ç¨‹ä¸­ï¼Œå¤šæ¬¡è®¿é—®ä¸€ä¸ªé¡µé¢ä¸­çš„æ—¶é—´ä¸ä¼šè¶…è¿‡1sï¼‰ï¼Œé‚£ä¹ˆè¯¥é¡µæ˜¯ä¸ä¼šè¢«åŠ å…¥åˆ°youngåŒºåŸŸçš„ã€‚ å½“ç„¶ï¼Œåƒinnodb_old_blocks_pctä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æœåŠ¡å™¨å¯åŠ¨æˆ–è¿è¡Œæ—¶è®¾ç½®innodb_old_blocks_timeçš„å€¼ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æŠŠinnodb_old_blocks_timeçš„å€¼è®¾ç½®ä¸º0ï¼Œé‚£ä¹ˆæ¯æ¬¡æˆ‘ä»¬è®¿é—®ä¸€ä¸ªé¡µé¢æ—¶å°±ä¼šæŠŠè¯¥é¡µé¢æ”¾åˆ°youngåŒºåŸŸçš„å¤´éƒ¨ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œæ­£æ˜¯å› ä¸ºå°†LRUé“¾è¡¨åˆ’åˆ†ä¸ºyoungå’ŒoldåŒºåŸŸè¿™ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆæ·»åŠ äº†innodb_old_blocks_timeè¿™ä¸ªç³»ç»Ÿå˜é‡ï¼Œæ‰ä½¿å¾—é¢„è¯»æœºåˆ¶å’Œå…¨è¡¨æ‰«æé€ æˆçš„ç¼“å­˜å‘½ä¸­ç‡é™ä½çš„é—®é¢˜å¾—åˆ°äº†éåˆ¶ï¼Œå› ä¸ºç”¨ä¸åˆ°çš„é¢„è¯»é¡µé¢ä»¥åŠå…¨è¡¨æ‰«æçš„é¡µé¢éƒ½åªä¼šè¢«æ”¾åˆ°oldåŒºåŸŸï¼Œè€Œä¸å½±å“youngåŒºåŸŸä¸­çš„ç¼“å­˜é¡µã€‚ 6.4 æ›´è¿›ä¸€æ­¥ä¼˜åŒ–LRUé“¾è¡¨å¯¹äºyoungåŒºåŸŸçš„ç¼“å­˜é¡µæ¥è¯´ï¼Œæˆ‘ä»¬æ¯æ¬¡è®¿é—®ä¸€ä¸ªç¼“å­˜é¡µå°±è¦æŠŠå®ƒç§»åŠ¨åˆ°LRUé“¾è¡¨çš„å¤´éƒ¨ï¼Œè¿™æ ·å¼€é”€å¤ªå¤§äº†ï¼Œæ¯•ç«Ÿåœ¨youngåŒºåŸŸçš„ç¼“å­˜é¡µéƒ½æ˜¯çƒ­ç‚¹æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å¯èƒ½è¢«ç»å¸¸è®¿é—®çš„ï¼Œè¿™æ ·é¢‘ç¹çš„å¯¹LRUé“¾è¡¨è¿›è¡ŒèŠ‚ç‚¹ç§»åŠ¨æ“ä½œä¸å¤ªå¥½ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å…¶å®æˆ‘ä»¬è¿˜å¯ä»¥æå‡ºä¸€äº›ä¼˜åŒ–ç­–ç•¥ï¼Œæ¯”å¦‚åªæœ‰è¢«è®¿é—®çš„ç¼“å­˜é¡µä½äºyoungåŒºåŸŸçš„1/4çš„åè¾¹ï¼Œæ‰ä¼šè¢«ç§»åŠ¨åˆ°LRUé“¾è¡¨å¤´éƒ¨ï¼Œè¿™æ ·å°±å¯ä»¥é™ä½è°ƒæ•´LRUé“¾è¡¨çš„é¢‘ç‡ï¼Œä»è€Œæå‡æ€§èƒ½ï¼ˆä¹Ÿå°±æ˜¯è¯´å¦‚æœæŸä¸ªç¼“å­˜é¡µå¯¹åº”çš„èŠ‚ç‚¹åœ¨youngåŒºåŸŸçš„1/4ä¸­ï¼Œå†æ¬¡è®¿é—®è¯¥ç¼“å­˜é¡µæ—¶ä¹Ÿä¸ä¼šå°†å…¶ç§»åŠ¨åˆ°LRUé“¾è¡¨å¤´éƒ¨ï¼‰ã€‚ ä»‹ç»éšæœºé¢„è¯»çš„æ—¶å€™æ›¾è¯´ï¼Œå¦‚æœBuffer Poolä¸­æœ‰æŸä¸ªåŒºçš„13ä¸ªè¿ç»­é¡µé¢å°±ä¼šè§¦å‘éšæœºé¢„è¯»ï¼Œè¿™å…¶å®æ˜¯ä¸ä¸¥è°¨çš„ï¼ˆä½†æ˜¯MySQLæ–‡æ¡£å°±æ˜¯è¿™ä¹ˆè¯´çš„ï¼‰ï¼Œå…¶å®è¿˜è¦æ±‚è¿™13ä¸ªé¡µé¢æ˜¯éå¸¸çƒ­çš„é¡µé¢ï¼Œæ‰€è°“çš„éå¸¸çƒ­ï¼ŒæŒ‡çš„æ˜¯è¿™äº›é¡µé¢åœ¨æ•´ä¸ªyoungåŒºåŸŸçš„å¤´1/4å¤„ã€‚ è¿˜æœ‰é’ˆå¯¹LRUé“¾è¡¨çš„ä¼˜åŒ–æªæ–½ï¼Œæ ¸å¿ƒå°±æ˜¯å°½é‡é«˜æ•ˆçš„æé«˜ Buffer Pool çš„ç¼“å­˜å‘½ä¸­ç‡ã€‚ 7.å…¶ä»–çš„ä¸€äº›é“¾è¡¨ä¸ºäº†æ›´å¥½çš„ç®¡ç†Buffer Poolä¸­çš„ç¼“å­˜é¡µï¼Œé™¤äº†æˆ‘ä»¬ä¸Šè¾¹æåˆ°çš„ä¸€äº›æªæ–½ï¼ŒInnoDBè¿˜å¼•è¿›äº†å…¶ä»–çš„ä¸€äº›é“¾è¡¨ï¼Œæ¯”å¦‚unzip LRUé“¾è¡¨ç”¨äºç®¡ç†è§£å‹é¡µï¼Œzip cleané“¾è¡¨ç”¨äºç®¡ç†æ²¡æœ‰è¢«è§£å‹çš„å‹ç¼©é¡µï¼Œzip freeæ•°ç»„ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½ä»£è¡¨ä¸€ä¸ªé“¾è¡¨ï¼Œå®ƒä»¬ç»„æˆæ‰€è°“çš„ä¼™ä¼´ç³»ç»Ÿæ¥ä¸ºå‹ç¼©é¡µæä¾›å†…å­˜ç©ºé—´ç­‰ç­‰ï¼Œä¸ºäº†æ›´å¥½çš„ç®¡ç†è¿™ä¸ªBuffer Poolå¼•å…¥äº†å„ç§é“¾è¡¨æˆ–å…¶ä»–æ•°æ®ç»“æ„ã€‚ 8.åˆ·æ–°è„é¡µåˆ°ç£ç›˜åå°æœ‰ä¸“é—¨çš„çº¿ç¨‹æ¯éš”ä¸€æ®µæ—¶é—´è´Ÿè´£æŠŠè„é¡µåˆ·æ–°åˆ°ç£ç›˜ï¼Œè¿™æ ·å¯ä»¥ä¸å½±å“ç”¨æˆ·çº¿ç¨‹å¤„ç†æ­£å¸¸çš„è¯·æ±‚ã€‚ä¸»è¦æœ‰ä¸¤ç§åˆ·æ–°è·¯å¾„ï¼š ä»LRUé“¾è¡¨çš„å†·æ•°æ®ä¸­åˆ·æ–°ä¸€éƒ¨åˆ†é¡µé¢åˆ°ç£ç›˜ã€‚åå°çº¿ç¨‹ä¼šå®šæ—¶ä»LRUé“¾è¡¨å°¾éƒ¨å¼€å§‹æ‰«æä¸€äº›é¡µé¢ï¼Œæ‰«æçš„é¡µé¢æ•°é‡å¯ä»¥é€šè¿‡ç³»ç»Ÿå˜é‡innodb_lru_scan_depthæ¥æŒ‡å®šï¼Œå¦‚æœä»é‡Œè¾¹å„¿å‘ç°è„é¡µï¼Œä¼šæŠŠå®ƒä»¬åˆ·æ–°åˆ°ç£ç›˜ã€‚è¿™ç§åˆ·æ–°é¡µé¢çš„æ–¹å¼è¢«ç§°ä¹‹ä¸ºBUF_FLUSH_LRUã€‚ ä»flushé“¾è¡¨ä¸­åˆ·æ–°ä¸€éƒ¨åˆ†é¡µé¢åˆ°ç£ç›˜ã€‚åå°çº¿ç¨‹ä¹Ÿä¼šå®šæ—¶ä»flushé“¾è¡¨ä¸­åˆ·æ–°ä¸€éƒ¨åˆ†é¡µé¢åˆ°ç£ç›˜ï¼Œåˆ·æ–°çš„é€Ÿç‡å–å†³äºå½“æ—¶ç³»ç»Ÿæ˜¯ä¸æ˜¯å¾ˆç¹å¿™ã€‚è¿™ç§åˆ·æ–°é¡µé¢çš„æ–¹å¼è¢«ç§°ä¹‹ä¸ºBUF_FLUSH_LISTã€‚ æœ‰æ—¶å€™åå°çº¿ç¨‹åˆ·æ–°è„é¡µçš„è¿›åº¦æ¯”è¾ƒæ…¢ï¼Œå¯¼è‡´ç”¨æˆ·çº¿ç¨‹åœ¨å‡†å¤‡åŠ è½½ä¸€ä¸ªç£ç›˜é¡µåˆ°Buffer Poolæ—¶æ²¡æœ‰å¯ç”¨çš„ç¼“å­˜é¡µï¼Œè¿™æ—¶å°±ä¼šå°è¯•çœ‹çœ‹LRUé“¾è¡¨å°¾éƒ¨æœ‰æ²¡æœ‰å¯ä»¥ç›´æ¥é‡Šæ”¾æ‰çš„æœªä¿®æ”¹é¡µé¢ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ä¼šä¸å¾—ä¸å°†LRUé“¾è¡¨å°¾éƒ¨çš„ä¸€ä¸ªè„é¡µåŒæ­¥åˆ·æ–°åˆ°ç£ç›˜ï¼ˆå’Œç£ç›˜äº¤äº’æ˜¯å¾ˆæ…¢çš„ï¼Œè¿™ä¼šé™ä½å¤„ç†ç”¨æˆ·è¯·æ±‚çš„é€Ÿåº¦ï¼‰ã€‚è¿™ç§åˆ·æ–°å•ä¸ªé¡µé¢åˆ°ç£ç›˜ä¸­çš„åˆ·æ–°æ–¹å¼è¢«ç§°ä¹‹ä¸ºBUF_FLUSH_SINGLE_PAGEã€‚ å½“ç„¶ï¼Œæœ‰æ—¶å€™ç³»ç»Ÿç‰¹åˆ«ç¹å¿™æ—¶ï¼Œä¹Ÿå¯èƒ½å‡ºç°ç”¨æˆ·çº¿ç¨‹æ‰¹é‡çš„ä»flushé“¾è¡¨ä¸­åˆ·æ–°è„é¡µçš„æƒ…å†µï¼Œå¾ˆæ˜¾ç„¶åœ¨å¤„ç†ç”¨æˆ·è¯·æ±‚è¿‡ç¨‹ä¸­å»åˆ·æ–°è„é¡µæ˜¯ä¸€ç§ä¸¥é‡é™ä½å¤„ç†é€Ÿåº¦çš„è¡Œä¸ºï¼Œè¿™å±äºä¸€ç§è¿«ä¸å¾—å·²çš„æƒ…å†µã€‚ 9.å¤šä¸ªBuffer Poolå®ä¾‹Buffer Poolæœ¬è´¨æ˜¯InnoDBå‘æ“ä½œç³»ç»Ÿç”³è¯·çš„ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œè®¿é—®Buffer Poolä¸­çš„å„ç§é“¾è¡¨éƒ½éœ€è¦åŠ é”å¤„ç†ï¼Œåœ¨Buffer Poolç‰¹åˆ«å¤§è€Œä¸”å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ç‰¹åˆ«é«˜çš„æƒ…å†µä¸‹ï¼Œå•ä¸€çš„Buffer Poolå¯èƒ½ä¼šå½±å“è¯·æ±‚çš„å¤„ç†é€Ÿåº¦ã€‚æ‰€ä»¥åœ¨Buffer Poolç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬æ‹†åˆ†æˆè‹¥å¹²ä¸ªå°çš„Buffer Poolï¼Œæ¯ä¸ªBuffer Pooléƒ½ç§°ä¸ºä¸€ä¸ªå®ä¾‹ï¼Œå®ƒä»¬éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œç‹¬ç«‹çš„å»ç”³è¯·å†…å­˜ç©ºé—´ï¼Œç‹¬ç«‹çš„ç®¡ç†å„ç§é“¾è¡¨ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹å¹¶å‘è®¿é—®æ—¶å¹¶ä¸ä¼šç›¸äº’å½±å“ï¼Œä»è€Œæé«˜å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™é€šè¿‡è®¾ç½®innodb_buffer_pool_instancesçš„å€¼æ¥ä¿®æ”¹Buffer Poolå®ä¾‹çš„ä¸ªæ•°ï¼Œæ¯”æ–¹è¯´è¿™æ ·ï¼š 12[server]innodb_buffer_pool_instances = 2 è¿™æ ·å°±è¡¨æ˜æˆ‘ä»¬è¦åˆ›å»º2ä¸ªBuffer Poolå®ä¾‹ã€‚ æ¯ä¸ªBuffer Poolå®ä¾‹å®é™…å å¤šå°‘å†…å­˜ç©ºé—´å‘¢ï¼Ÿå…¶å®ä½¿ç”¨è¿™ä¸ªå…¬å¼ç®—å‡ºæ¥çš„ï¼š 1innodb_buffer_pool_size/innodb_buffer_pool_instances ä¹Ÿå°±æ˜¯æ€»å…±çš„å¤§å°é™¤ä»¥å®ä¾‹çš„ä¸ªæ•°ï¼Œç»“æœå°±æ˜¯æ¯ä¸ªBuffer Poolå®ä¾‹å ç”¨çš„å¤§å°ã€‚ ä¸è¿‡ä¹Ÿä¸æ˜¯è¯´Buffer Poolå®ä¾‹åˆ›å»ºçš„è¶Šå¤šè¶Šå¥½ï¼Œåˆ†åˆ«ç®¡ç†å„ä¸ªBuffer Poolä¹Ÿæ˜¯éœ€è¦æ€§èƒ½å¼€é”€çš„ï¼ŒInnoDBè§„å®šï¼šå½“innodb_buffer_pool_sizeçš„å€¼å°äº1Gçš„æ—¶å€™è®¾ç½®å¤šä¸ªå®ä¾‹æ˜¯æ— æ•ˆçš„ï¼ŒInnoDBä¼šé»˜è®¤æŠŠinnodb_buffer_pool_instances çš„å€¼ä¿®æ”¹ä¸º1ã€‚è€ŒMySQLå¸Œæœ›åœ¨Buffer Poolå¤§äºæˆ–ç­‰äº1Gçš„æ—¶å€™è®¾ç½®å¤šä¸ªBuffer Poolå®ä¾‹ã€‚ 10.innodb_buffer_pool_chunk_sizeåœ¨MySQL 5.7.5ä¹‹å‰ï¼ŒBuffer Poolçš„å¤§å°åªèƒ½åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶é€šè¿‡é…ç½®innodb_buffer_pool_sizeå¯åŠ¨å‚æ•°æ¥è°ƒæ•´å¤§å°ï¼Œåœ¨æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­æ˜¯ä¸å…è®¸è°ƒæ•´è¯¥å€¼çš„ã€‚ä¸è¿‡MySQLåœ¨5.7.5ä»¥åŠä¹‹åçš„ç‰ˆæœ¬ä¸­æ”¯æŒäº†åœ¨æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­è°ƒæ•´Buffer Poolå¤§å°çš„åŠŸèƒ½ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ¯æ¬¡å½“æˆ‘ä»¬è¦é‡æ–°è°ƒæ•´Buffer Poolå¤§å°æ—¶ï¼Œéƒ½éœ€è¦é‡æ–°å‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œç„¶åå°†æ—§çš„Buffer Poolä¸­çš„å†…å®¹å¤åˆ¶åˆ°è¿™ä¸€å—æ–°ç©ºé—´ï¼Œè¿™æ˜¯æå…¶è€—æ—¶çš„ã€‚æ‰€ä»¥MySQLå†³å®šä¸å†ä¸€æ¬¡æ€§ä¸ºæŸä¸ªBuffer Poolå®ä¾‹å‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å¤§ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯ä»¥ä¸€ä¸ªæ‰€è°“çš„chunkä¸ºå•ä½å‘æ“ä½œç³»ç»Ÿç”³è¯·ç©ºé—´ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªBuffer Poolå®ä¾‹å…¶å®æ˜¯ç”±è‹¥å¹²ä¸ªchunkç»„æˆçš„ï¼Œä¸€ä¸ªchunkå°±ä»£è¡¨ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œé‡Œè¾¹å„¿åŒ…å«äº†è‹¥å¹²ç¼“å­˜é¡µä¸å…¶å¯¹åº”çš„æ§åˆ¶å—ã€‚ æ­£æ˜¯å› ä¸ºå‘æ˜äº†è¿™ä¸ªchunkçš„æ¦‚å¿µï¼Œæˆ‘ä»¬åœ¨æœåŠ¡å™¨è¿è¡ŒæœŸé—´è°ƒæ•´Buffer Poolçš„å¤§å°æ—¶å°±æ˜¯ä»¥chunkä¸ºå•ä½å¢åŠ æˆ–è€…åˆ é™¤å†…å­˜ç©ºé—´ï¼Œè€Œä¸éœ€è¦é‡æ–°å‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸€ç‰‡å¤§çš„å†…å­˜ï¼Œç„¶åè¿›è¡Œç¼“å­˜é¡µçš„å¤åˆ¶ã€‚è¿™ä¸ªæ‰€è°“çš„chunkçš„å¤§å°æ˜¯æˆ‘ä»¬åœ¨å¯åŠ¨æ“ä½œMySQLæœåŠ¡å™¨æ—¶é€šè¿‡innodb_buffer_pool_chunk_sizeå¯åŠ¨å‚æ•°æŒ‡å®šçš„ï¼Œå®ƒçš„é»˜è®¤å€¼æ˜¯134217728ï¼Œä¹Ÿå°±æ˜¯128Mã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œinnodb_buffer_pool_chunk_sizeçš„å€¼åªèƒ½åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶æŒ‡å®šï¼Œåœ¨æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­æ˜¯ä¸å¯ä»¥ä¿®æ”¹çš„ã€‚ ä¸ºä»€ä¹ˆä¸å…è®¸åœ¨æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹innodb_buffer_pool_chunk_sizeçš„å€¼ï¼Ÿå› ä¸ºinnodb_buffer_pool_chunk_sizeçš„å€¼ä»£è¡¨InnoDBå‘æ“ä½œç³»ç»Ÿç”³è¯·çš„ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´çš„å¤§å°ï¼Œå¦‚æœä½ åœ¨æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹äº†è¯¥å€¼ï¼Œå°±æ„å‘³ç€è¦é‡æ–°å‘æ“ä½œç³»ç»Ÿç”³è¯·è¿ç»­çš„å†…å­˜ç©ºé—´å¹¶ä¸”å°†åŸå…ˆçš„ç¼“å­˜é¡µå’Œå®ƒä»¬å¯¹åº”çš„æ§åˆ¶å—å¤åˆ¶åˆ°è¿™ä¸ªæ–°çš„å†…å­˜ç©ºé—´ä¸­ï¼Œè¿™æ˜¯ååˆ†è€—æ—¶çš„æ“ä½œï¼ å¦å¤–ï¼Œè¿™ä¸ªinnodb_buffer_pool_chunk_sizeçš„å€¼å¹¶ä¸åŒ…å«ç¼“å­˜é¡µå¯¹åº”çš„æ§åˆ¶å—çš„å†…å­˜ç©ºé—´å¤§å°ï¼Œæ‰€ä»¥å®é™…ä¸ŠInnoDBå‘æ“ä½œç³»ç»Ÿç”³è¯·è¿ç»­å†…å­˜ç©ºé—´æ—¶ï¼Œæ¯ä¸ªchunkçš„å¤§å°è¦æ¯”innodb_buffer_pool_chunk_sizeçš„å€¼å¤§ä¸€äº›ï¼Œçº¦5%ã€‚ 11.é…ç½®Buffer Poolæ—¶çš„æ³¨æ„äº‹é¡¹ innodb_buffer_pool_sizeå¿…é¡»æ˜¯innodb_buffer_pool_chunk_size Ã— innodb_buffer_pool_instancesçš„å€æ•°ï¼ˆè¿™ä¸»è¦æ˜¯æƒ³ä¿è¯æ¯ä¸€ä¸ªBuffer Poolå®ä¾‹ä¸­åŒ…å«çš„chunkæ•°é‡ç›¸åŒï¼‰ã€‚å‡è®¾æˆ‘ä»¬æŒ‡å®šçš„innodb_buffer_pool_chunk_sizeçš„å€¼æ˜¯128Mï¼Œinnodb_buffer_pool_instancesçš„å€¼æ˜¯16ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå€¼çš„ä¹˜ç§¯å°±æ˜¯2Gï¼Œä¹Ÿå°±æ˜¯è¯´innodb_buffer_pool_sizeçš„å€¼å¿…é¡»æ˜¯2Gæˆ–è€…2Gçš„æ•´æ•°å€ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬åœ¨å¯åŠ¨MySQLæœåŠ¡å™¨æ˜¯è¿™æ ·æŒ‡å®šå¯åŠ¨å‚æ•°çš„ï¼šé»˜è®¤çš„innodb_buffer_pool_chunk_sizeå€¼æ˜¯128Mï¼ŒæŒ‡å®šçš„innodb_buffer_pool_instancesçš„å€¼æ˜¯16ï¼Œæ‰€ä»¥innodb_buffer_pool_sizeçš„å€¼å¿…é¡»æ˜¯2Gæˆ–è€…2Gçš„æ•´æ•°å€ï¼Œä¸Šè¾¹ä¾‹å­ä¸­æŒ‡å®šçš„innodb_buffer_pool_sizeçš„å€¼æ˜¯8Gï¼Œç¬¦åˆè§„å®šï¼Œæ‰€ä»¥åœ¨æœåŠ¡å™¨å¯åŠ¨å®Œæˆä¹‹åæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹è¯¥å˜é‡çš„å€¼å°±æ˜¯æˆ‘ä»¬æŒ‡å®šçš„8Gï¼ˆ8589934592å­—èŠ‚ï¼‰ï¼šå¦‚æœæˆ‘ä»¬æŒ‡å®šçš„innodb_buffer_pool_sizeå¤§äº2Gå¹¶ä¸”ä¸æ˜¯2Gçš„æ•´æ•°å€ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šè‡ªåŠ¨çš„æŠŠinnodb_buffer_pool_sizeçš„å€¼è°ƒæ•´ä¸º2Gçš„æ•´æ•°å€ï¼Œæ¯”æ–¹è¯´æˆ‘ä»¬åœ¨å¯åŠ¨æœåŠ¡å™¨æ—¶æŒ‡å®šçš„innodb_buffer_pool_sizeçš„å€¼æ˜¯9Gï¼šé‚£ä¹ˆæœåŠ¡å™¨ä¼šè‡ªåŠ¨æŠŠinnodb_buffer_pool_sizeçš„å€¼è°ƒæ•´ä¸º10Gï¼Œ10737418240å­—èŠ‚ã€‚ 1mysqld --innodb-buffer-pool-size=8G --innodb-buffer-pool-instances=16 1234567mysql&gt; show variables like &#x27;innodb_buffer_pool_size&#x27;;+-------------------------+------------+| Variable_name | Value |+-------------------------+------------+| innodb_buffer_pool_size | 8589934592 |+-------------------------+------------+1 row in set (0.00 sec) 1mysqld --innodb-buffer-pool-size=9G --innodb-buffer-pool-instances=16 1234567mysql&gt; show variables like &#x27;innodb_buffer_pool_size&#x27;;+-------------------------+-------------+| Variable_name | Value |+-------------------------+-------------+| innodb_buffer_pool_size | 10737418240 |+-------------------------+-------------+1 row in set (0.01 sec) å¦‚æœåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œinnodb_buffer_pool_chunk_size Ã— innodb_buffer_pool_instancesçš„å€¼å·²ç»å¤§äºinnodb_buffer_pool_sizeçš„å€¼ï¼Œé‚£ä¹ˆinnodb_buffer_pool_chunk_sizeçš„å€¼ä¼šè¢«æœåŠ¡å™¨è‡ªåŠ¨è®¾ç½®ä¸ºinnodb_buffer_pool_size/innodb_buffer_pool_instancesçš„å€¼ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬åœ¨å¯åŠ¨æœåŠ¡å™¨æ—¶æŒ‡å®šçš„innodb_buffer_pool_sizeçš„å€¼ä¸º2Gï¼Œinnodb_buffer_pool_instancesçš„å€¼ä¸º16ï¼Œinnodb_buffer_pool_chunk_sizeçš„å€¼ä¸º256Mï¼šç”±äº256M Ã— 16 = 4Gï¼Œè€Œ4G &gt; 2Gï¼Œæ‰€ä»¥innodb_buffer_pool_chunk_sizeå€¼ä¼šè¢«æœåŠ¡å™¨æ”¹å†™ä¸ºinnodb_buffer_pool_size/innodb_buffer_pool_instancesçš„å€¼ï¼Œä¹Ÿå°±æ˜¯ï¼š2G/16 = 128Mï¼ˆ134217728å­—èŠ‚ï¼‰ã€‚ 1mysqld --innodb-buffer-pool-size=2G --innodb-buffer-pool-instances=16 --innodb-buffer-pool-chunk-size=256M 123456789101112131415mysql&gt; show variables like &#x27;innodb_buffer_pool_size&#x27;;+-------------------------+------------+| Variable_name | Value |+-------------------------+------------+| innodb_buffer_pool_size | 2147483648 |+-------------------------+------------+1 row in set (0.01 sec)mysql&gt; show variables like &#x27;innodb_buffer_pool_chunk_size&#x27;;+-------------------------------+-----------+| Variable_name | Value |+-------------------------------+-----------+| innodb_buffer_pool_chunk_size | 134217728 |+-------------------------------+-----------+1 row in set (0.00 sec) 12.Buffer Poolä¸­å­˜å‚¨çš„å…¶å®ƒä¿¡æ¯Buffer Poolçš„ç¼“å­˜é¡µé™¤äº†ç”¨æ¥ç¼“å­˜ç£ç›˜ä¸Šçš„é¡µé¢ä»¥å¤–ï¼Œè¿˜å¯ä»¥å­˜å‚¨é”ä¿¡æ¯ã€è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ç­‰ä¿¡æ¯ã€‚ 13.æŸ¥çœ‹Buffer Poolçš„çŠ¶æ€ä¿¡æ¯MySQLç»™æˆ‘ä»¬æä¾›äº†SHOW ENGINE INNODB STATUSè¯­å¥æ¥æŸ¥çœ‹å…³äºInnoDBå­˜å‚¨å¼•æ“è¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…æ‹¬Buffer Poolçš„ä¸€äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼ˆä¸ºäº†çªå‡ºé‡ç‚¹ï¼Œæˆ‘ä»¬åªæŠŠè¾“å‡ºä¸­å…³äºBuffer Poolçš„éƒ¨åˆ†æå–äº†å‡ºæ¥ï¼‰ï¼š 123456789101112131415161718192021222324252627mysql&gt; SHOW ENGINE INNODB STATUS\\G(...çœç•¥å‰è¾¹çš„è®¸å¤šçŠ¶æ€)----------------------BUFFER POOL AND MEMORY----------------------Total memory allocated 13218349056;Dictionary memory allocated 4014231Buffer pool size 786432Free buffers 8174Database pages 710576Old database pages 262143Modified db pages 124941Pending reads 0Pending writes: LRU 0, flush list 0, single page 0Pages made young 6195930012, not young 78247510485108.18 youngs/s, 226.15 non-youngs/sPages read 2748866728, created 29217873, written 4845680877160.77 reads/s, 3.80 creates/s, 190.16 writes/sBuffer pool hit rate 956 / 1000, young-making rate 30 / 1000 not 605 / 1000Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/sLRU len: 710576, unzip_LRU len: 118I/O sum[134264]:cur[144], unzip sum[16]:cur[0]--------------(...çœç•¥åè¾¹çš„è®¸å¤šçŠ¶æ€)mysql&gt; æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸€ä¸‹è¿™é‡Œè¾¹çš„æ¯ä¸ªå€¼éƒ½ä»£è¡¨ä»€ä¹ˆæ„æ€ï¼š Total memory allocatedï¼šä»£è¡¨Buffer Poolå‘æ“ä½œç³»ç»Ÿç”³è¯·çš„è¿ç»­å†…å­˜ç©ºé—´å¤§å°ï¼ŒåŒ…æ‹¬å…¨éƒ¨æ§åˆ¶å—ã€ç¼“å­˜é¡µã€ä»¥åŠç¢ç‰‡çš„å¤§å°ã€‚ Dictionary memory allocatedï¼šä¸ºæ•°æ®å­—å…¸ä¿¡æ¯åˆ†é…çš„å†…å­˜ç©ºé—´å¤§å°ï¼Œæ³¨æ„è¿™ä¸ªå†…å­˜ç©ºé—´å’ŒBuffer Poolæ²¡å•¥å…³ç³»ï¼Œä¸åŒ…æ‹¬åœ¨Total memory allocatedä¸­ã€‚ Buffer pool sizeï¼šä»£è¡¨è¯¥Buffer Poolå¯ä»¥å®¹çº³å¤šå°‘ç¼“å­˜é¡µï¼Œæ³¨æ„ï¼Œå•ä½æ˜¯é¡µï¼ Free buffersï¼šä»£è¡¨å½“å‰Buffer Poolè¿˜æœ‰å¤šå°‘ç©ºé—²ç¼“å­˜é¡µï¼Œä¹Ÿå°±æ˜¯freeé“¾è¡¨ä¸­è¿˜æœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹ã€‚ Database pagesï¼šä»£è¡¨LRUé“¾è¡¨ä¸­çš„é¡µçš„æ•°é‡ï¼ŒåŒ…å«youngå’Œoldä¸¤ä¸ªåŒºåŸŸçš„èŠ‚ç‚¹æ•°é‡ã€‚ Old database pagesï¼šä»£è¡¨LRUé“¾è¡¨oldåŒºåŸŸçš„èŠ‚ç‚¹æ•°é‡ã€‚ Modified db pagesï¼šä»£è¡¨è„é¡µæ•°é‡ï¼Œä¹Ÿå°±æ˜¯flushé“¾è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ã€‚ Pending readsï¼šæ­£åœ¨ç­‰å¾…ä»ç£ç›˜ä¸ŠåŠ è½½åˆ°Buffer Poolä¸­çš„é¡µé¢æ•°é‡ã€‚å½“å‡†å¤‡ä»ç£ç›˜ä¸­åŠ è½½æŸä¸ªé¡µé¢æ—¶ï¼Œä¼šå…ˆä¸ºè¿™ä¸ªé¡µé¢åœ¨Buffer Poolä¸­åˆ†é…ä¸€ä¸ªç¼“å­˜é¡µä»¥åŠå®ƒå¯¹åº”çš„æ§åˆ¶å—ï¼Œç„¶åæŠŠè¿™ä¸ªæ§åˆ¶å—æ·»åŠ åˆ°LRUçš„oldåŒºåŸŸçš„å¤´éƒ¨ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™çœŸæ­£çš„ç£ç›˜é¡µå¹¶æ²¡æœ‰è¢«åŠ è½½è¿›æ¥ï¼ŒPending readsçš„å€¼ä¼šè·Ÿç€åŠ 1ã€‚ Pending writes LRUï¼šå³å°†ä»LRUé“¾è¡¨ä¸­åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„é¡µé¢æ•°é‡ã€‚ Pending writes flush listï¼šå³å°†ä»flushé“¾è¡¨ä¸­åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„é¡µé¢æ•°é‡ã€‚ Pending writes single pageï¼šå³å°†ä»¥å•ä¸ªé¡µé¢çš„å½¢å¼åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„é¡µé¢æ•°é‡ã€‚ Pages made youngï¼šä»£è¡¨LRUé“¾è¡¨ä¸­æ›¾ç»ä»oldåŒºåŸŸç§»åŠ¨åˆ°youngåŒºåŸŸå¤´éƒ¨çš„èŠ‚ç‚¹æ•°é‡ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œä¸€ä¸ªèŠ‚ç‚¹æ¯æ¬¡åªæœ‰ä»oldåŒºåŸŸç§»åŠ¨åˆ°youngåŒºåŸŸå¤´éƒ¨æ—¶æ‰ä¼šå°†Pages made youngçš„å€¼åŠ 1ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœè¯¥èŠ‚ç‚¹æœ¬æ¥å°±åœ¨youngåŒºåŸŸï¼Œç”±äºå®ƒç¬¦åˆåœ¨youngåŒºåŸŸ1/4åè¾¹çš„è¦æ±‚ï¼Œä¸‹ä¸€æ¬¡è®¿é—®è¿™ä¸ªé¡µé¢æ—¶ä¹Ÿä¼šå°†å®ƒç§»åŠ¨åˆ°youngåŒºåŸŸå¤´éƒ¨ï¼Œä½†è¿™ä¸ªè¿‡ç¨‹å¹¶ä¸ä¼šå¯¼è‡´Pages made youngçš„å€¼åŠ 1ã€‚ Page made not youngï¼šåœ¨å°†innodb_old_blocks_timeè®¾ç½®çš„å€¼å¤§äº0æ—¶ï¼Œé¦–æ¬¡è®¿é—®æˆ–è€…åç»­è®¿é—®æŸä¸ªå¤„åœ¨oldåŒºåŸŸçš„èŠ‚ç‚¹æ—¶ç”±äºä¸ç¬¦åˆæ—¶é—´é—´éš”çš„é™åˆ¶è€Œä¸èƒ½å°†å…¶ç§»åŠ¨åˆ°youngåŒºåŸŸå¤´éƒ¨æ—¶ï¼ŒPage made not youngçš„å€¼ä¼šåŠ 1ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå¯¹äºå¤„åœ¨youngåŒºåŸŸçš„èŠ‚ç‚¹ï¼Œå¦‚æœç”±äºå®ƒåœ¨youngåŒºåŸŸçš„1/4å¤„è€Œå¯¼è‡´å®ƒæ²¡æœ‰è¢«ç§»åŠ¨åˆ°youngåŒºåŸŸå¤´éƒ¨ï¼Œè¿™æ ·çš„è®¿é—®å¹¶ä¸ä¼šå°†Page made not youngçš„å€¼åŠ 1ã€‚ youngs/sï¼šä»£è¡¨æ¯ç§’ä»oldåŒºåŸŸè¢«ç§»åŠ¨åˆ°youngåŒºåŸŸå¤´éƒ¨çš„èŠ‚ç‚¹æ•°é‡ã€‚ non-youngs/sï¼šä»£è¡¨æ¯ç§’ç”±äºä¸æ»¡è¶³æ—¶é—´é™åˆ¶è€Œä¸èƒ½ä»oldåŒºåŸŸç§»åŠ¨åˆ°youngåŒºåŸŸå¤´éƒ¨çš„èŠ‚ç‚¹æ•°é‡ã€‚ Pages readã€createdã€writtenï¼šä»£è¡¨è¯»å–ï¼Œåˆ›å»ºï¼Œå†™å…¥äº†å¤šå°‘é¡µã€‚åè¾¹è·Ÿç€è¯»å–ã€åˆ›å»ºã€å†™å…¥çš„é€Ÿç‡ã€‚ Buffer pool hit rateï¼šè¡¨ç¤ºåœ¨è¿‡å»æŸæ®µæ—¶é—´ï¼Œå¹³å‡è®¿é—®1000æ¬¡é¡µé¢ï¼Œæœ‰å¤šå°‘æ¬¡è¯¥é¡µé¢å·²ç»è¢«ç¼“å­˜åˆ°Buffer Pooläº†ã€‚ young-making rateï¼šè¡¨ç¤ºåœ¨è¿‡å»æŸæ®µæ—¶é—´ï¼Œå¹³å‡è®¿é—®1000æ¬¡é¡µé¢ï¼Œæœ‰å¤šå°‘æ¬¡è®¿é—®ä½¿é¡µé¢ç§»åŠ¨åˆ°youngåŒºåŸŸçš„å¤´éƒ¨äº†ã€‚ éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™é‡Œç»Ÿè®¡çš„å°†é¡µé¢ç§»åŠ¨åˆ°**young**åŒºåŸŸçš„å¤´éƒ¨æ¬¡æ•°ä¸ä»…ä»…åŒ…å«ä»**old**åŒºåŸŸç§»åŠ¨åˆ°**young**åŒºåŸŸå¤´éƒ¨çš„æ¬¡æ•°ï¼Œè¿˜åŒ…æ‹¬ä»**young**åŒºåŸŸç§»åŠ¨åˆ°**young**åŒºåŸŸå¤´éƒ¨çš„æ¬¡æ•°ï¼ˆè®¿é—®æŸä¸ª**young**åŒºåŸŸçš„èŠ‚ç‚¹ï¼Œåªè¦è¯¥èŠ‚ç‚¹åœ¨**young**åŒºåŸŸçš„1/4å¤„å¾€åï¼Œå°±ä¼šæŠŠå®ƒç§»åŠ¨åˆ°**young**åŒºåŸŸçš„å¤´éƒ¨ï¼‰ã€‚ not (young-making rate)ï¼šè¡¨ç¤ºåœ¨è¿‡å»æŸæ®µæ—¶é—´ï¼Œå¹³å‡è®¿é—®1000æ¬¡é¡µé¢ï¼Œæœ‰å¤šå°‘æ¬¡è®¿é—®æ²¡æœ‰ä½¿é¡µé¢ç§»åŠ¨åˆ°youngåŒºåŸŸçš„å¤´éƒ¨ã€‚ éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™é‡Œç»Ÿè®¡çš„æ²¡æœ‰å°†é¡µé¢ç§»åŠ¨åˆ°**young**åŒºåŸŸçš„å¤´éƒ¨æ¬¡æ•°ä¸ä»…ä»…åŒ…å«å› ä¸ºè®¾ç½®äº†**innodb_old_blocks_time**ç³»ç»Ÿå˜é‡è€Œå¯¼è‡´è®¿é—®äº†**old**åŒºåŸŸä¸­çš„èŠ‚ç‚¹ä½†æ²¡æŠŠå®ƒä»¬ç§»åŠ¨åˆ°**young**åŒºåŸŸçš„æ¬¡æ•°ï¼Œè¿˜åŒ…å«å› ä¸ºè¯¥èŠ‚ç‚¹åœ¨**young**åŒºåŸŸçš„å‰1/4å¤„è€Œæ²¡æœ‰è¢«ç§»åŠ¨åˆ°**young**åŒºåŸŸå¤´éƒ¨çš„æ¬¡æ•°ã€‚ LRU lenï¼šä»£è¡¨LRUé“¾è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ã€‚ unzip_LRUï¼šä»£è¡¨unzip_LRUé“¾è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ã€‚ I/O sumï¼šæœ€è¿‘50sè¯»å–ç£ç›˜é¡µçš„æ€»æ•°ã€‚ I/O curï¼šç°åœ¨æ­£åœ¨è¯»å–çš„ç£ç›˜é¡µæ•°é‡ã€‚ I/O unzip sumï¼šæœ€è¿‘50sè§£å‹çš„é¡µé¢æ•°é‡ã€‚ I/O unzip curï¼šæ­£åœ¨è§£å‹çš„é¡µé¢æ•°é‡ã€‚ ä¸‰ï¼Œæ€»ç»“ ç£ç›˜å¤ªæ…¢ï¼Œç”¨å†…å­˜ä½œä¸ºç¼“å­˜å¾ˆæœ‰å¿…è¦ã€‚ Buffer Poolæœ¬è´¨ä¸Šæ˜¯InnoDBå‘æ“ä½œç³»ç»Ÿç”³è¯·çš„ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥é€šè¿‡innodb_buffer_pool_sizeæ¥è°ƒæ•´å®ƒçš„å¤§å°ã€‚ Buffer Poolå‘æ“ä½œç³»ç»Ÿç”³è¯·çš„è¿ç»­å†…å­˜ç”±æ§åˆ¶å—å’Œç¼“å­˜é¡µç»„æˆï¼Œæ¯ä¸ªæ§åˆ¶å—å’Œç¼“å­˜é¡µéƒ½æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œåœ¨å¡«å……è¶³å¤Ÿå¤šçš„æ§åˆ¶å—å’Œç¼“å­˜é¡µçš„ç»„åˆåï¼ŒBuffer Poolå‰©ä½™çš„ç©ºé—´å¯èƒ½äº§ç”Ÿä¸å¤Ÿå¡«å……ä¸€ç»„æ§åˆ¶å—å’Œç¼“å­˜é¡µï¼Œè¿™éƒ¨åˆ†ç©ºé—´ä¸èƒ½è¢«ä½¿ç”¨ï¼Œä¹Ÿè¢«ç§°ä¸ºç¢ç‰‡ã€‚ InnoDBä½¿ç”¨äº†è®¸å¤šé“¾è¡¨æ¥ç®¡ç†Buffer Poolã€‚ freeé“¾è¡¨ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä»£è¡¨ä¸€ä¸ªç©ºé—²çš„ç¼“å­˜é¡µï¼Œåœ¨å°†ç£ç›˜ä¸­çš„é¡µåŠ è½½åˆ°Buffer Poolæ—¶ï¼Œä¼šä»freeé“¾è¡¨ä¸­å¯»æ‰¾ç©ºé—²çš„ç¼“å­˜é¡µã€‚ ä¸ºäº†å¿«é€Ÿå®šä½æŸä¸ªé¡µæ˜¯å¦è¢«åŠ è½½åˆ°Buffer Poolï¼Œä½¿ç”¨è¡¨ç©ºé—´å· + é¡µå·ä½œä¸ºkeyï¼Œç¼“å­˜é¡µä½œä¸ºvalueï¼Œå»ºç«‹å“ˆå¸Œè¡¨ã€‚ åœ¨Buffer Poolä¸­è¢«ä¿®æ”¹çš„é¡µç§°ä¸ºè„é¡µï¼Œè„é¡µå¹¶ä¸æ˜¯ç«‹å³åˆ·æ–°ï¼Œè€Œæ˜¯è¢«åŠ å…¥åˆ°flushé“¾è¡¨ä¸­ï¼Œå¾…ä¹‹åçš„æŸä¸ªæ—¶åˆ»åŒæ­¥åˆ°ç£ç›˜ä¸Šã€‚ LRUé“¾è¡¨åˆ†ä¸ºyoungå’Œoldä¸¤ä¸ªåŒºåŸŸï¼Œå¯ä»¥é€šè¿‡innodb_old_blocks_pctæ¥è°ƒèŠ‚oldåŒºåŸŸæ‰€å çš„æ¯”ä¾‹ã€‚é¦–æ¬¡ä»ç£ç›˜ä¸ŠåŠ è½½åˆ°Buffer Poolçš„é¡µä¼šè¢«æ”¾åˆ°oldåŒºåŸŸçš„å¤´éƒ¨ï¼Œåœ¨innodb_old_blocks_timeé—´éš”æ—¶é—´å†…è®¿é—®è¯¥é¡µä¸ä¼šæŠŠå®ƒç§»åŠ¨åˆ°youngåŒºåŸŸå¤´éƒ¨ã€‚åœ¨Buffer Poolæ²¡æœ‰å¯ç”¨çš„ç©ºé—²ç¼“å­˜é¡µæ—¶ï¼Œä¼šé¦–å…ˆæ·˜æ±°æ‰oldåŒºåŸŸçš„ä¸€äº›é¡µã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®šinnodb_buffer_pool_instancesæ¥æ§åˆ¶Buffer Poolå®ä¾‹çš„ä¸ªæ•°ï¼Œæ¯ä¸ªBuffer Poolå®ä¾‹ä¸­éƒ½æœ‰å„è‡ªç‹¬ç«‹çš„é“¾è¡¨ï¼Œäº’ä¸å¹²æ‰°ã€‚ è‡ªMySQL 5.7.5ç‰ˆæœ¬ä¹‹åï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­è°ƒæ•´Buffer Poolå¤§å°ã€‚æ¯ä¸ªBuffer Poolå®ä¾‹ç”±è‹¥å¹²ä¸ªchunkç»„æˆï¼Œæ¯ä¸ªchunkçš„å¤§å°å¯ä»¥åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶é€šè¿‡å¯åŠ¨å‚æ•°è°ƒæ•´ã€‚ å¯ä»¥ç”¨ä¸‹è¾¹çš„å‘½ä»¤æŸ¥çœ‹Buffer Poolçš„çŠ¶æ€ä¿¡æ¯ï¼š 1SHOW ENGINE INNODB STATUS\\G","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[åä¸€]é«˜æ€§èƒ½MySQLè°ƒä¼˜å®æˆ˜","slug":"MySQL/MySQL[åä¸€]é«˜æ€§èƒ½MySQLè°ƒä¼˜å®æˆ˜","date":"2022-01-11T03:16:57.298Z","updated":"2022-01-11T03:24:28.380Z","comments":true,"path":"2022/01/11/MySQL/MySQL[åä¸€]é«˜æ€§èƒ½MySQLè°ƒä¼˜å®æˆ˜/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E5%8D%81%E4%B8%80]%E9%AB%98%E6%80%A7%E8%83%BDMySQL%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98/","excerpt":"","text":"ä¸€ï¼Œæ•°æ®åº“åº”è¯¥å¦‚ä½•ä¼˜åŒ–æ•°æ®åº“ä¼˜åŒ–æœ‰å¾ˆå¤šå±‚é¢ã€‚ 1.SQLä¸ç´¢å¼•å› ä¸º SQL è¯­å¥æ˜¯åœ¨æˆ‘ä»¬çš„åº”ç”¨ç«¯ç¼–å†™çš„ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­å¯¹ SQL è¯­å¥è¿›è¡Œä¼˜åŒ–ï¼Œæœ€ç»ˆçš„ç›®æ ‡æ˜¯ç”¨åˆ°ç´¢å¼•ã€‚è¿™ä¸ªæ˜¯å®¹æ˜“çš„ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¼˜åŒ–æ‰‹æ®µã€‚ 2.è¡¨ä¸å­˜å‚¨å¼•æ“æ•°æ®æ˜¯å­˜æ”¾åœ¨è¡¨é‡Œé¢çš„ï¼Œè¡¨åˆæ˜¯ä»¥ä¸åŒçš„æ ¼å¼å­˜æ”¾åœ¨å­˜å‚¨å¼•æ“ä¸­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€‰ç”¨ç‰¹å®šçš„å­˜å‚¨å¼•æ“ï¼Œæˆ–è€…å¯¹è¡¨è¿›è¡Œåˆ†åŒºï¼Œå¯¹è¡¨ç»“æ„è¿›è¡Œæ‹†åˆ†æˆ–è€…å†—ä½™å¤„ç†ï¼Œæˆ–è€…å¯¹è¡¨ç»“æ„æ¯”å¦‚å­—æ®µçš„å®šä¹‰è¿›è¡Œä¼˜åŒ–ã€‚ 3.æ¶æ„å¯¹äºæ•°æ®åº“çš„æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å®ƒçš„æ¶æ„è¿›è¡Œä¼˜åŒ–ã€‚å¦‚æœåªæœ‰ä¸€å°æ•°æ®åº“çš„æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œå¤šä¸ªå®ä¾‹ï¼Œåšé›†ç¾¤çš„æ–¹æ¡ˆï¼Œåšè´Ÿè½½å‡è¡¡ã€‚æˆ–è€…åŸºäºä¸»ä»å¤åˆ¶å®ç°è¯»å†™åˆ†ç¦»ï¼Œè®©å†™çš„æœåŠ¡éƒ½è®¿é—® master æœåŠ¡å™¨ï¼Œè¯»çš„è¯·æ±‚éƒ½è®¿é—®ä»æœåŠ¡å™¨ï¼Œslave æœåŠ¡å™¨è‡ªåŠ¨ master ä¸»æœåŠ¡å™¨åŒæ­¥æ•°æ®ã€‚æˆ–è€…åœ¨æ•°æ®åº“å‰é¢åŠ ä¸€å±‚ç¼“å­˜ï¼Œè¾¾åˆ°å‡å°‘æ•°æ®åº“çš„å‹åŠ›ï¼Œæå‡è®¿é—®é€Ÿåº¦çš„ç›®çš„ã€‚ä¸ºäº†åˆ†æ•£æ•°æ®åº“æœåŠ¡çš„å­˜å‚¨å‹åŠ›å’Œè®¿é—®å‹åŠ›ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠä¸åŒçš„æ•°æ®åˆ†å¸ƒåˆ°ä¸åŒçš„æœåŠ¡èŠ‚ç‚¹ï¼Œè¿™ä¸ªå°±æ˜¯åˆ†åº“åˆ†è¡¨ï¼ˆscale outï¼‰ã€‚ æ³¨æ„ä¸»ä»ï¼ˆreplicateï¼‰å’Œåˆ†ç‰‡ï¼ˆshardï¼‰çš„åŒºåˆ«ï¼š ä¸»ä»é€šè¿‡æ•°æ®å†—ä½™å®ç°é«˜å¯ç”¨ï¼Œå’Œå®ç°è¯»å†™åˆ†ç¦»ã€‚ åˆ†ç‰‡é€šè¿‡æ‹†åˆ†æ•°æ®åˆ†æ•£å­˜å‚¨å’Œè®¿é—®å‹åŠ›ã€‚ 4.é…ç½®æ•°æ®åº“é…ç½®çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚è¿æ¥æ•°ï¼Œç¼“å†²åŒºå¤§å°ç­‰ç­‰ï¼Œä¼˜åŒ–é…ç½®çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†æ›´é«˜æ•ˆåœ°åˆ©ç”¨ç¡¬ä»¶ã€‚ 5.æ“ä½œç³»ç»Ÿä¸ç¡¬ä»¶ä»ä¸Šå¾€ä¸‹ï¼Œæˆæœ¬æ”¶ç›Šæ¯”æ…¢æ…¢åœ°åœ¨å¢åŠ ã€‚æ‰€ä»¥è‚¯å®šä¸æ˜¯æŸ¥è¯¢ä¸€æ…¢å°±å †ç¡¬ä»¶ï¼Œå †ç¡¬ä»¶å«åšå‘ä¸Šçš„æ‰©å±•ï¼ˆscale upï¼‰ã€‚ äºŒï¼Œæ…¢æ—¥å¿—æŸ¥è¯¢1.æ¦‚è¿°MySQLçš„æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯MySQLæä¾›çš„ä¸€ç§æ—¥å¿—è®°å½•ï¼Œå®ƒç”¨æ¥è®°å½•åœ¨MySQLä¸­å“åº”æ—¶é—´è¶…è¿‡é˜€å€¼çš„è¯­å¥ï¼Œå…·ä½“æŒ‡è¿è¡Œæ—¶é—´è¶…è¿‡long_query_timeå€¼çš„SQLï¼Œåˆ™ä¼šè¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ã€‚long_query_timeçš„é»˜è®¤å€¼ä¸º10ï¼Œæ„æ€æ˜¯è¿è¡Œ10ç§’ä»¥ä¸Šçš„è¯­å¥ã€‚ç”±ä»–æ¥æŸ¥çœ‹å“ªäº›SQLè¶…å‡ºäº†æˆ‘ä»¬çš„æœ€å¤§å¿è€æ—¶é—´å€¼ï¼Œæ¯”å¦‚ä¸€æ¡sqlæ‰§è¡Œè¶…è¿‡5ç§’é’Ÿï¼Œæˆ‘ä»¬å°±ç®—æ…¢SQLï¼Œå¸Œæœ›èƒ½æ”¶é›†è¶…è¿‡5ç§’çš„sqlï¼Œç»“åˆexplainè¿›è¡Œå…¨é¢åˆ†æã€‚ 2.å®æ“é»˜è®¤æƒ…å†µä¸‹ï¼ŒMySQLæ•°æ®åº“æ²¡æœ‰å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ¥è®¾ç½®è¿™ä¸ªå‚æ•°ã€‚ å½“ç„¶ï¼Œå¦‚æœä¸æ˜¯è°ƒä¼˜éœ€è¦çš„è¯ï¼Œä¸€èˆ¬ä¸å»ºè®®å¯åŠ¨è¯¥å‚æ•°ï¼Œå› ä¸ºå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ä¼šæˆ–å¤šæˆ–å°‘å¸¦æ¥ä¸€å®šçš„æ€§èƒ½å½±å“ã€‚æ…¢æŸ¥è¯¢æ—¥å¿—æ”¯æŒå°†æ—¥å¿—è®°å½•å†™å…¥æ–‡ä»¶ã€‚ 2.1æŸ¥çœ‹åŠå¼€å¯â‘ æ—¥å¿—1SHOW VARIABLES LIKE &#x27;%slow_query_log%&#x27;; é»˜è®¤æƒ…å†µä¸‹slow_query_logçš„å€¼ä¸ºOFFï¼Œè¡¨ç¤ºæ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯ç¦ç”¨çš„ã€‚ 1set global slow_query_log=1; åªå¯¹çª—å£ç”Ÿæ•ˆï¼Œé‡å¯æœåŠ¡å¤±æ•ˆã€‚ â‘¡æ—¶é—´1SHOW VARIABLES LIKE &#x27;%long_query_time%&#x27;; 1SET GLOBAL long_query_time=0.1; å…¨å±€å˜é‡è®¾ç½®ï¼Œå¯¹æ‰€æœ‰å®¢æˆ·ç«¯æœ‰æ•ˆã€‚ä½†å¿…é¡»æ˜¯è®¾ç½®åè¿›è¡Œç™»å½•çš„å®¢æˆ·ç«¯ã€‚ 1SET SESSION long_query_time=0.1; #sessionå¯çœç•¥ å¯¹å½“å‰ä¼šè¯è¿æ¥ç«‹å³ç”Ÿæ•ˆï¼Œå¯¹å…¶ä»–å®¢æˆ·ç«¯æ— æ•ˆã€‚ å‡å¦‚è¿è¡Œæ—¶é—´æ­£å¥½ç­‰äºlong_query_timeçš„æƒ…å†µï¼Œå¹¶ä¸ä¼šè¢«è®°å½•ä¸‹æ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨mysqlæºç é‡Œæ˜¯åˆ¤æ–­å¤§äºlong_query_timeï¼Œè€Œéå¤§äºç­‰äºã€‚ â‘¢æ°¸ä¹…ç”Ÿæ•ˆä¿®æ”¹é…ç½®æ–‡ä»¶my.cnfï¼ˆå…¶å®ƒç³»ç»Ÿå˜é‡ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ [mysqld]ä¸‹å¢åŠ æˆ–ä¿®æ”¹å‚æ•° slow_query_log å’Œslow_query_log_fileåï¼Œç„¶åé‡å¯MySQLæœåŠ¡å™¨ã€‚ä¹Ÿå³å°†å¦‚ä¸‹ä¸¤è¡Œé…ç½®è¿›my.cnfæ–‡ä»¶ [1] 1234slow_query_log =1slow_query_log_file=/var/lib/mysql/yhd-slow.log long_query_time=3log_output=FILE 2.2Caseè®°å½•æ…¢SQLå¹¶åç»­åˆ†æ æŸ¥è¯¢å½“å‰ç³»ç»Ÿä¸­æœ‰å¤šå°‘æ¡æ…¢æŸ¥è¯¢è®°å½• 1SHOW GLOBAL STATUS LIKE &#x27;%Slow_queries%&#x27;; 3.æ—¥å¿—åˆ†æå·¥å…·-mysqldumpslowåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœè¦æ‰‹å·¥åˆ†ææ—¥å¿—ï¼ŒæŸ¥æ‰¾ã€åˆ†æSQLï¼Œæ˜¾ç„¶æ˜¯ä¸ªä½“åŠ›æ´»ï¼ŒMySQLæä¾›äº†æ—¥å¿—åˆ†æå·¥å…·mysqldumpslowã€‚ æŸ¥çœ‹mysqldumpslowçš„å¸®åŠ©ä¿¡æ¯ï¼ˆwindowsä¸‹éœ€è¦å®‰è£…perlç¯å¢ƒï¼‰ 1mysqldumpslow --help -a: ä¸å°†æ•°å­—æŠ½è±¡æˆNï¼Œå­—ç¬¦ä¸²æŠ½è±¡æˆS-s: æ˜¯è¡¨ç¤ºæŒ‰ç…§ä½•ç§æ–¹å¼æ’åºï¼›c: è®¿é—®æ¬¡æ•°l: é”å®šæ—¶é—´r: è¿”å›è®°å½•t: æŸ¥è¯¢æ—¶é—´al:å¹³å‡é”å®šæ—¶é—´ar:å¹³å‡è¿”å›è®°å½•æ•°at:å¹³å‡æŸ¥è¯¢æ—¶é—´-t: å³ä¸ºè¿”å›å‰é¢å¤šå°‘æ¡çš„æ•°æ®ï¼›-g: åè¾¹æ­é…ä¸€ä¸ªæ­£åˆ™åŒ¹é…æ¨¡å¼ï¼Œå¤§å°å†™ä¸æ•æ„Ÿçš„ï¼› 3.1å¸¸ç”¨SQL12345678å¾—åˆ°è¿”å›è®°å½•é›†æœ€å¤šçš„10ä¸ªSQLmysqldumpslow -s r -t 10 /var/lib/mysql/yhd-slow.logå¾—åˆ°è®¿é—®æ¬¡æ•°æœ€å¤šçš„10ä¸ªSQLmysqldumpslow -s c -t 10 /var/lib/mysql/yhd-slow.logå¾—åˆ°æŒ‰ç…§æ—¶é—´æ’åºçš„å‰10æ¡é‡Œé¢å«æœ‰å·¦è¿æ¥çš„æŸ¥è¯¢è¯­å¥mysqldumpslow -s t -t 10 -g &quot;left join&quot; /var/lib/mysql/yhd-slow.logå¦å¤–å»ºè®®åœ¨ä½¿ç”¨è¿™äº›å‘½ä»¤æ—¶ç»“åˆ | å’Œmore ä½¿ç”¨ ï¼Œå¦åˆ™æœ‰å¯èƒ½å‡ºç°çˆ†å±æƒ…å†µmysqldumpslow -s r -t 10 /var/lib/mysql/yhd-slow.log | more 4.SHOW PROCESSLISTä½œç”¨ï¼šæŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·æ­£åœ¨å¹²ä»€ä¹ˆã€‚ å¦‚æœå‡ºç°ä¸é¡ºçœ¼çš„ï¼škill [id] ä¸‰ï¼ŒEXPLAINè°ƒä¼˜å®æˆ˜1.å‡†å¤‡æ•°æ®å‘˜å·¥è¡¨æ’å…¥500wæ•°æ®ï¼Œéƒ¨é—¨è¡¨æ’å…¥10wæ•°æ®ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586CREATE TABLE `dept`( `id` INT(11) NOT NULL AUTO_INCREMENT, `deptName` VARCHAR(30) DEFAULT NULL, `address` VARCHAR(40) DEFAULT NULL, `ceo` INT NULL, PRIMARY KEY (`id`)) ENGINE = INNODB AUTO_INCREMENT = 1 DEFAULT CHARSET = utf8;CREATE TABLE `emp`( `id` INT(11) NOT NULL AUTO_INCREMENT, `empno` INT NOT NULL, `name` VARCHAR(20) DEFAULT NULL, `age` INT(3) DEFAULT NULL, `deptId` INT(11) DEFAULT NULL, PRIMARY KEY (`id`) #CONSTRAINT `fk_dept_id` FOREIGN KEY (`deptId`) REFERENCES `t_dept` (`id`)) ENGINE = INNODB AUTO_INCREMENT = 1 DEFAULT CHARSET = utf8;#ç”Ÿæˆéšæœºå­—ç¬¦ä¸²DELIMITER $$CREATE FUNCTION rand_string(n INT) RETURNS VARCHAR(255)BEGIN DECLARE chars_str VARCHAR(100) DEFAULT &#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;; DECLARE return_str VARCHAR(255) DEFAULT &#x27;&#x27;; DECLARE i INT DEFAULT 0; WHILE i &lt; n DO SET return_str = CONCAT(return_str, SUBSTRING(chars_str, FLOOR(1 + RAND() * 52), 1)); SET i = i + 1; END WHILE; RETURN return_str;END $$#ç”¨äºéšæœºäº§ç”Ÿå¤šå°‘åˆ°å¤šå°‘çš„ç¼–å·DELIMITER $$CREATE FUNCTION rand_num(from_num INT, to_num INT) RETURNS INT(11)BEGIN DECLARE i INT DEFAULT 0; SET i = FLOOR(from_num + RAND() * (to_num - from_num + 1)); RETURN i;END$$#åˆ›å»ºå¾€empè¡¨ä¸­æ’å…¥æ•°æ®çš„å­˜å‚¨è¿‡ç¨‹DELIMITER $$CREATE PROCEDURE insert_emp(START INT, max_num INT)BEGIN DECLARE i INT DEFAULT 0; SET autocommit = 0; #è®¾ç½®æ‰‹åŠ¨æäº¤äº‹åŠ¡ REPEAT #å¾ªç¯ SET i = i + 1; #èµ‹å€¼ INSERT INTO emp (empno, NAME, age, deptid) VALUES ((START + i), rand_string(6), rand_num(30, 50), rand_num(1, 10000)); UNTIL i = max_num END REPEAT; COMMIT; #æäº¤äº‹åŠ¡END$$#åˆ›å»ºå¾€deptè¡¨ä¸­æ’å…¥æ•°æ®çš„å­˜å‚¨è¿‡ç¨‹DELIMITER $$CREATE PROCEDURE `insert_dept`(max_num INT)BEGIN DECLARE i INT DEFAULT 0; SET autocommit = 0; REPEAT SET i = i + 1; INSERT INTO dept (deptname, address, ceo) VALUES (rand_string(8), rand_string(10), rand_num(1, 500000)); UNTIL i = max_num END REPEAT; COMMIT;END$$#æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ï¼Œå¾€deptè¡¨æ·»åŠ 10ä¸‡æ¡æ•°æ®CALL insert_dept(100000);#æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ï¼Œå¾€empè¡¨æ·»åŠ 500ä¸‡æ¡æ•°æ®CALL insert_emp(100000, 5000000); 2.æ‰¹é‡åˆ é™¤ç´¢å¼•å»ºç«‹å¥½çš„ç´¢å¼•åœ¨å“ªé‡Œï¼Ÿ 12SHOW INDEX FROM t_emp ; -- åªèƒ½æŸ¥çœ‹ç´¢å¼•ï¼Œä½†ä¸èƒ½åˆ é™¤ã€‚information_schema.STATISTICS -- å­˜å‚¨ç´¢å¼•çš„è¡¨ï¼ˆå…ƒæ•°æ®åº“ï¼Œç»Ÿè®¡è¡¨ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¡¨æ•°æ®è¿›è¡Œåˆ é™¤æ“ä½œã€‚ çŸ¥è¯†ç‚¹ åˆ é™¤æŸä¸€ä¸ªç´¢å¼• 1DROP INDEX idx_xxx ON emp æŸ¥å‡ºè¯¥è¡¨æœ‰å“ªäº›ç´¢å¼•ï¼Œç´¢å¼•åâ€“&gt;é›†åˆ 12345678SHOW INDEX FROM t_emp-- å…ƒæ•°æ®ï¼šmeta DATA æè¿°æ•°æ®çš„æ•°æ®SELECT index_nameFROM information_schema.STATISTICSWHERE table_name = &#x27;t_emp&#x27; AND table_schema = &#x27;mydb&#x27; AND index_name &lt;&gt; &#x27;PRIMARY&#x27; AND seq_in_index = 1 3.å•è¡¨ä½¿ç”¨ç´¢å¼•å»ºç«‹ç´¢å¼• 12CREATE INDEX idx_age_deptid_name ON emp(age,deptid,NAME);CREATE INDEX idx_name ON emp(NAME); 3.1 å…¨å€¼åŒ¹é…1234567891011121314151617181920# å•è¡¨æŸ¥è¯¢-å…¨å€¼åŒ¹é…EXPLAINSELECT SQL_NO_CACHE *FROM empWHERE emp.age = 30;EXPLAINSELECT SQL_NO_CACHE *FROM empWHERE emp.age = 30 and deptid = 4;EXPLAINSELECT SQL_NO_CACHE *FROM empWHERE emp.age = 30 and deptid = 4 AND emp.name = &#x27;abcd&#x27;; 3.2 æœ€å·¦å‰ç¼€æ³•åˆ™12345678# å•è¡¨æŸ¥è¯¢-å·¦å‰ç¼€æ³•åˆ™EXPLAIN SELECT * FROM emp WHERE age=1 AND deptid=1 AND NAME=&#x27;aaa&#x27;;EXPLAIN SELECT * FROM emp WHERE age=1 AND deptid=1;EXPLAIN SELECT * FROM emp WHERE age=1 AND NAME=&#x27;aaa&#x27; AND deptid=1;EXPLAIN SELECT * FROM emp WHERE deptid=1 AND NAME =&#x27;aaa&#x27;; è¿‡æ»¤æ¡ä»¶è¦ä½¿ç”¨ç´¢å¼•å¿…é¡»æŒ‰ç…§ç´¢å¼•å»ºç«‹æ—¶çš„é¡ºåºï¼Œä¾æ¬¡æ»¡è¶³ï¼Œä¸€æ—¦è·³è¿‡æŸä¸ªå­—æ®µï¼Œç´¢å¼•åé¢çš„å­—æ®µéƒ½æ— æ³•è¢«ä½¿ç”¨ã€‚ 3.3 ç´¢å¼•åˆ—ä¸Šè®¡ç®—/å‡½æ•°å¯¼è‡´ç´¢å¼•å¤±æ•ˆ1234# å•è¡¨æŸ¥è¯¢-æ“ä½œç´¢å¼•åˆ—å¯¼è‡´ç´¢å¼•å¤±æ•ˆEXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE emp.name LIKE &#x27;abc%&#x27;;EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE LEFT(emp.name,3) = &#x27;abc&#x27;; 3.4 èŒƒå›´æŸ¥è¯¢å¯¼è‡´çš„ç´¢å¼•å¤±æ•ˆ12345678EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE emp.name = &#x27;abc&#x27; AND emp.deptId &gt; 20 AND emp.age = 30 ; åº”ç”¨å¼€å‘ä¸­èŒƒå›´æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼š é‡‘é¢æŸ¥è¯¢ï¼Œæ—¥æœŸæŸ¥è¯¢å¾€å¾€éƒ½æ˜¯èŒƒå›´æŸ¥è¯¢ã€‚åº”å°†æŸ¥è¯¢æ¡ä»¶æ”¾ç½®whereè¯­å¥æœ€åã€‚ 3.5 ä¸ç­‰äº(!= æˆ–è€…&lt;&gt;)ç´¢å¼•å¤±æ•ˆ1EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE emp.name &lt;&gt; &#x27;abc&#x27; ; 3.6 is not nullæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œis nullå¯ä½¿ç”¨ç´¢å¼•1234EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE age IS NULL;#ç”¨åˆ°ç´¢å¼• EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE age IS NOT NULL;#æœªç”¨åˆ°ç´¢å¼• 3.7 likeä»¥%å¼€å¤´ç´¢å¼•å¤±æ•ˆ1EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE NAME LIKE &#x27;%aaa&#x27;; 3.8 ç±»å‹è½¬æ¢å¯¼è‡´ç´¢å¼•å¤±æ•ˆ1EXPLAIN SELECT SQL_NO_CACHE * FROM emp WHERE NAME=123; è®¾è®¡å®ä½“ç±»å±æ€§æ—¶ï¼Œä¸€å®šè¦ä¸æ•°æ®åº“å­—æ®µç±»å‹ç›¸å¯¹åº”ï¼Œå¦åˆ™ä¼šå‡ºç°ç±»å‹è½¬æ¢çš„æƒ…å†µï¼Œå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚ 4. å…³è”æŸ¥è¯¢ä¼˜åŒ–4.1 å·¦å¤–è¿æ¥1explain select * from emp left join dept on emp.deptId=dept.id; è¿™ç§æƒ…å†µä¸‹ï¼Œé©±åŠ¨è¡¨æ— æ³•é¿å…å…¨è¡¨æ‰«æï¼Œä½†æ˜¯å› ä¸ºè¢«é©±åŠ¨è¡¨çš„ä¸»é”®å­˜åœ¨ç´¢å¼•å¹¶ä¸”æ˜¯ä¸¤å¼ è¡¨å…³è”æŸ¥è¯¢çš„å…³è”æ¡ä»¶ï¼Œæ‰€ä»¥å¯ä»¥é¿å…è¢«é©±åŠ¨è¡¨çš„å…¨è¡¨æ‰«æã€‚ 4.2 å†…è¿æ¥(TODO)å†…è¿æ¥MySQLä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬é€‰æ‹©é©±åŠ¨è¡¨ã€‚ 123456explain select * from dept straight_join emp on emp.deptId=dept.id;## 1. dept å…¨è¡¨æ‰«æ 10w## 2. emp deptid refexplain select * from dept join emp on emp.deptId=dept.id;## 1. emp 500w## 2. dept id ref ä¿è¯è¢«é©±åŠ¨è¡¨çš„joinå­—æ®µè¢«ç´¢å¼• left join æ—¶ï¼Œé€‰æ‹©å°è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œå¤§è¡¨ä½œä¸ºè¢«é©±åŠ¨è¡¨ inner join æ—¶ï¼Œmysqlä¼šè‡ªåŠ¨å°†å°ç»“æœé›†çš„è¡¨é€‰ä¸ºé©±åŠ¨è¡¨ã€‚é€‰æ‹©ç›¸ä¿¡mysqlä¼˜åŒ–ç­–ç•¥ã€‚ å­æŸ¥è¯¢å°½é‡ä¸è¦æ”¾åœ¨è¢«é©±åŠ¨è¡¨ï¼Œè¡ç”Ÿè¡¨å»ºä¸äº†ç´¢å¼•ã€‚ èƒ½å¤Ÿç›´æ¥å¤šè¡¨å…³è”çš„å°½é‡ç›´æ¥å…³è”ï¼Œä¸ç”¨å­æŸ¥è¯¢ã€‚ ä¸¤å¼ è¡¨çš„è¿æ¥æŸ¥è¯¢ï¼Œæ¯”æ–¹è¯´ left join rightã€inner join ç­‰ï¼Œä»–ä»¬çš„è¿è¡¨æ–¹å¼æ˜¯ä»€ä¹ˆï¼Ÿ è¿è¡¨æŸ¥è¯¢ä¸€å…±ä¸‰ç§ç®—æ³•ï¼šnlj bnl bka ç®—æ³• ã€‚ right join åº•å±‚ï¼Œä¼šç»™ä½ è½¬åŒ–ä¸ºleft joinã€‚ 4.3 å­æŸ¥è¯¢ä¼˜åŒ–1234567891011121314151617181920212223#â‘ ä¸æ¨èexplain SELECT *FROM empWHERE emp.id NOT IN -- not in å¯¼è‡´æ— æ³•å¯¹inè¿›è¡Œä¼˜åŒ–ï¼Œç”¨ä¸äº†exists (SELECT dept.ceo FROM dept WHERE dept.ceo IS NOT NULL) ; -- is not null å¯¼è‡´ç´¢å¼•å¤±æ•ˆ#â‘¡æ¨èexplain SELECT emp.*FROM emp LEFT JOIN dept ON emp.id = dept.ceo -- å¦‚æœceoæ²¡æœ‰ç´¢å¼•ï¼Œä¸¤å¼ è¡¨éƒ½æ˜¯å…¨è¡¨æ‰«æï¼Œå¦‚æœceoæœ‰ç´¢å¼•ï¼Œè¢«é©±åŠ¨è¡¨å°±æ˜¯refçº§åˆ«WHERE dept.id IS NULL ;# å°è¯•åœ¨ceoåˆ›å»ºç´¢å¼•åï¼Œç¡®å®æ˜¯ create index idx_ceo on dept(ceo); å°½é‡ä¸è¦ä½¿ç”¨not in æˆ–è€… not existsï¼Œä¼šä½¿ç´¢å¼•å¤±æ•ˆã€‚ MySQLè‡ªåŠ¨åšå‡ºçš„å­æŸ¥è¯¢ä¼˜åŒ–ï¼Œç‰©åŒ–å­æŸ¥è¯¢ï¼Œè½¬ä¸ºåŠè¿æ¥ ç‰©åŒ–å­æŸ¥è¯¢ï¼šæŠŠå­æŸ¥è¯¢çš„ç»“æœæŸ¥å‡ºæ¥åï¼Œå»ºç«‹ä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œâ€œç‰©åŒ–â€-&gt;å˜æˆä¸€å¼ å†…å­˜ä¸´æ—¶è¡¨ åŠè¿æ¥ï¼šæŠŠå­æŸ¥è¯¢è½¬åŒ–ä¸ºç±»ä¼¼è¿æ¥æŸ¥è¯¢çš„æ–¹å¼ï¼Œä½†åˆä¸æ˜¯çœŸæ­£çš„è¿æ¥æŸ¥è¯¢ï¼Œæ‰€ä»¥å« åŠ è¿æ¥ä¼˜åŒ– 5.æ’åºåˆ†ç»„ä¼˜åŒ–5.1 æ— è¿‡æ»¤ï¼Œä¸ç´¢å¼•1234EXPLAIN SELECT SQL_NO_CACHE * FROM emp ORDER BY age,deptid; #æ²¡ç”¨ä¸Šç´¢å¼•ï¼ŒUsing filesort EXPLAIN SELECT SQL_NO_CACHE * FROM emp ORDER BY age,deptid LIMIT 10; #ä½¿ç”¨ä¸Šç´¢å¼• null å› ä¸ºorder byçš„å­—æ®µé¡ºåºå’Œç´¢å¼•çš„é¡ºåºä¸€æ ·ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šå…ˆå°è¯•å†…å­˜æ’åºï¼Œä½†æ˜¯å› ä¸ºä¸Šé¢çš„sqlæ²¡æœ‰limitï¼Œå¯¼è‡´å†…å­˜æ”¾ä¸ä¸‹ï¼Œä½¿ç”¨äº†æ–‡ä»¶æ’åºï¼ˆæ–‡ä»¶ç³»ç»Ÿçº§åˆ«ï¼Œç›¸å½“äºåœ¨ç£ç›˜åšæ’åºï¼‰ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¡sqlæ•ˆç‡æ›´ä½ã€‚ orderåé¢çš„å­—æ®µæƒ³è¦ä½¿ç”¨ç´¢å¼•ï¼Œå¿…é¡»è¦æœ‰è¿‡æ»¤æ¡ä»¶ï¼Œlimitä¹Ÿè¡Œã€‚ 5.2é¡ºåºé”™ï¼Œå¿…æ’åº1234567891011121314EXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY deptid;# Using index conditionEXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY deptid,NAME;# Using index conditionEXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY deptid,empno;# Using index condition; Using filesortEXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY NAME,deptid;# Using index condition; Using filesortEXPLAIN SELECT * FROM emp WHERE deptid=45 ORDER BY age;# Using where; Using filesort åœ¨SQLè¯­å¥ä¸­çš„é¡ºåºä¸€å®šè¦å’Œå®šä¹‰ç´¢å¼•ä¸­çš„å­—æ®µé¡ºåºå®Œå…¨ä¸€è‡´ã€‚ 5.3 æ–¹å‘åï¼Œå¿…æ’åº1234EXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY deptid DESC, NAME DESC ;#Using whereEXPLAIN SELECT * FROM emp WHERE age=45 ORDER BY deptid ASC, NAME DESC ;#Using index condition; Using filesort ORDER BYå­å¥ï¼Œå°½é‡ä½¿ç”¨Indexæ–¹å¼æ’åºï¼Œé¿å…ä½¿ç”¨FileSortæ–¹å¼æ’åº è¦ä¹ˆå…¨å‡åºã€è¦ä¹ˆå…¨é™åºã€‚æœ‰å‡æœ‰é™æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚ 5.4 ç´¢å¼•çš„é€‰æ‹© ä¸¤ä¸ªç´¢å¼•åŒæ—¶å­˜åœ¨ï¼Œmysqlè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„æ–¹æ¡ˆï¼Œä½†æ˜¯ï¼Œéšç€æ•°æ®é‡çš„å˜åŒ–ï¼Œé€‰æ‹©çš„ç´¢å¼•ä¹Ÿä¼šéšä¹‹å˜åŒ–çš„ã€‚ æ‰€æœ‰çš„æ’åºéƒ½æ˜¯åœ¨æ¡ä»¶è¿‡æ»¤ä¹‹åæ‰æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ï¼Œå¦‚æœæ¡ä»¶è¿‡æ»¤æ‰å¤§éƒ¨åˆ†æ•°æ®çš„è¯ï¼Œå‰©ä¸‹å‡ ç™¾å‡ åƒæ¡æ•°æ®è¿›è¡Œæ’åºå…¶å®å¹¶ä¸æ˜¯å¾ˆæ¶ˆè€—æ€§èƒ½ï¼Œå³ä½¿ç´¢å¼•ä¼˜åŒ–äº†æ’åºï¼Œä½†å®é™…æå‡æ€§èƒ½å¾ˆæœ‰é™ã€‚ å½“ã€èŒƒå›´æ¡ä»¶ã€‘å’Œã€group by æˆ–è€… order byã€‘çš„å­—æ®µå‡ºç°äºŒé€‰ä¸€æ—¶ï¼Œä¼˜å…ˆè§‚å¯Ÿæ¡ä»¶å­—æ®µçš„è¿‡æ»¤æ•°é‡ï¼Œå¦‚æœè¿‡æ»¤çš„æ•°æ®è¶³å¤Ÿå¤šï¼Œè€Œéœ€è¦æ’åºçš„æ•°æ®å¹¶ä¸å¤šæ—¶ï¼Œä¼˜å…ˆæŠŠç´¢å¼•æ”¾åœ¨èŒƒå›´ï¼ˆè¿‡æ»¤æ¡ä»¶ï¼‰å­—æ®µä¸Šã€‚åä¹‹ï¼Œäº¦ç„¶ã€‚ æ‰«æè¡Œæ•°çš„å¤šå°‘ï¼Œå°±æ˜¯explainé‡Œçš„rowsï¼Œå¯ä»¥è¯´æ˜ä¸€ä¸ªéœ€è¦æ‰«æçš„è¡Œæ•°å¤šï¼Œä¸€ä¸ªæ‰«æè¡Œæ•°å°‘ï¼Œæ‰«æè¡Œæ•°å¤šï¼Œä»£è¡¨æˆæœ¬é«˜ï¼Œæ‰«æè¡Œæ•°å°‘ä»£è¡¨æˆæœ¬å°‘ã€‚ä¼˜åŒ–å™¨æœ€ç»ˆæ˜¯å¯¹æ¯”æˆæœ¬å€¼çš„å¤§å°æ¥é€‰å–ç´¢å¼•çš„ã€‚å‡†ç¡®çš„è¯´ï¼Œæ˜¯MySQLåŸºäºæˆæœ¬ï¼Œä¼˜åŒ–å™¨æ˜¯åœ¨serverå±‚ã€‚ æœ‰æ—¶å€™ä¼˜åŒ–å™¨ä¼šé€‰æ‹©é”™ç´¢å¼•ä¸ºä»€ä¹ˆï¼Ÿ ä¸»è¦æ˜¯å‡ºåœ¨ä¼˜åŒ–å™¨é¢„ä¼°è¡Œæ•°ä¸Šï¼Œè¿™ä¸ªæ¶‰åŠåˆ°äº†ä¸€æ¡sqlçš„æ‰§è¡Œæµç¨‹ï¼Œè¯­æ³•åˆ†æï¼Œè¯æ³•åˆ†æä¹‹åï¼Œè¿›å…¥ä¼˜åŒ–é˜¶æ®µï¼Œç”±ä¼˜åŒ–å™¨è¿›è¡Œä¼˜åŒ–ï¼Œåœ¨ä¼˜åŒ–é˜¶æ®µï¼Œä¼šå°½å¯èƒ½çš„ç”Ÿæˆå…¨éƒ¨çš„æ‰§è¡Œè®¡åˆ’ï¼Œç„¶åå¯¹æ¯”ä¸€ä¸‹å“ªä¸€ä¸ªæˆæœ¬å€¼æœ€ä½ï¼Œå°±é€‰å®ƒï¼Œæ‰€ä»¥ä¼˜åŒ–å™¨æœ‰ä¸€ä¸ªé€‰æ‹©ç´¢å¼•ï¼Œé€‰æ‹©è¡¨çš„è¿æ¥é¡ºåºçš„è¿‡ç¨‹ï¼Œç´¢å¼•ä¸åŒï¼Œæˆæœ¬ä¸åŒï¼Œè¯»è¡¨é¡ºåºä¸åŒï¼Œæˆæœ¬ä¸åŒï¼Œç´¢å¼•çš„é€‰å–ï¼Œéœ€è¦å­˜å‚¨å¼•æ“æä¾›ç»Ÿè®¡ä¿¡æ¯ï¼Œinnodbä¸­ï¼Œç»Ÿè®¡ä¿¡æ¯æ˜¯éšæœºé‡‡æ ·ï¼Œéšæœºé€‰å–8ä¸ªç´¢å¼•é¡µï¼Œå–å¹³å‡å€¼ï¼Œå½“åšè¯¥ç´¢å¼•çš„å…¨éƒ¨æƒ…å†µï¼Œä¹Ÿå°±æ˜¯éƒ¨åˆ†ä»£è¡¨æ•´ä½“ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆå¯¼è‡´rowsé‚£é‡Œæ˜¯ä¸ªé¢„ä¼°å€¼ï¼Œè€Œä¸æ˜¯å‡†ç¡®çš„ã€‚æ‰€ä»¥æœ‰æ—¶å€™MySQLé€‰é”™äº†ç´¢å¼•ï¼Œæœ‰ä¸€å®šæ¦‚ç‡ï¼Œæ˜¯ç”±äºè¿™ä¸ªéšæœºé‡‡æ ·é€ æˆçš„ã€‚è€Œéšæœºé‡‡æ ·çš„ä¸å‡†ç¡®ï¼Œæ˜¯ç”±äºæ•°æ®ä¸æ–­æ·»åŠ å¯¼è‡´ç´¢å¼•é¡µçš„åˆ†è£‚ï¼Œå¯¼è‡´æœ‰äº›é¡µå†…æ•°æ®è¾ƒå°‘ã€‚ è§£å†³æ–¹æ¡ˆï¼š æ‰§è¡Œä¸€ä¸‹alter table +è¡¨å å°±å¯ä»¥ä½¿ç»Ÿè®¡ä¿¡æ¯ç¨å¾®å‡†ç¡®ç‚¹ï¼Œä»–ä¼šé‡æ–°æ„å»ºç´¢å¼•ï¼Œä½¿ç´¢å¼•é¡µä¿æŒç´§å‡‘ï¼Œè¿™ä¸ªå°±æ˜¯B+æ ‘çš„åˆ†è£‚ã€‚ è°ƒæ•´å‚æ•°ï¼ŒåŠ å¤§InnoDBé‡‡æ ·çš„é¡µæ•°ï¼Œé¡µæ•°è¶Šå¤§è¶Šç²¾ç¡®ï¼Œä½†æ€§èƒ½æ¶ˆè€—æ›´é«˜ã€‚ä¸€èˆ¬ä¸å»ºè®®è¿™ä¹ˆå¹²ã€‚ åœ¨ä¼˜åŒ–é˜¶æ®µï¼Œä¼šå¯¹è¡¨ä¸­æ‰€æœ‰ç´¢å¼•è¿›è¡Œå¯¹æ¯”ï¼Œä¼˜åŒ–å™¨åŸºäºæˆæœ¬çš„åŸå› ï¼Œé€‰æ‹©æˆæœ¬æœ€ä½çš„ç´¢å¼•ï¼Œæ‰€ä»¥ä¼šé”™è¿‡æœ€ä½³ç´¢å¼•ã€‚å¸¦æ¥çš„é—®é¢˜ä¾¿æ˜¯ï¼Œæ‰§è¡Œé€Ÿåº¦å¾ˆæ…¢ã€‚ è§£å†³æ–¹æ¡ˆï¼š é€šè¿‡explainæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œç»“åˆsqlæ¡ä»¶æŸ¥çœ‹å¯ä»¥åˆ©ç”¨å“ªäº›ç´¢å¼•ã€‚ ä½¿ç”¨ force index(indexName)å¼ºåˆ¶èµ°æŒ‡å®šç´¢å¼•ã€‚å¼Šç«¯å°±æ˜¯åæœŸè‹¥ç´¢å¼•åå‘ç”Ÿæ”¹å˜ï¼Œæˆ–ç´¢å¼•è¢«åˆ é™¤ï¼Œè¯¥sqlè¯­å¥éœ€è¦è°ƒæ•´ã€‚ 5.5 åŒè·¯æ’åº&amp;å•è·¯æ’åºå¦‚æœä¸åœ¨ç´¢å¼•åˆ—ä¸Šï¼Œfilesortæœ‰ä¸¤ç§ç®—æ³•ï¼š mysqlå°±è¦å¯åŠ¨åŒè·¯æ’åºå’Œå•è·¯æ’åºã€‚ åŒè·¯æ’åº MySQL 4.1ä¹‹å‰æ˜¯ä½¿ç”¨åŒè·¯æ’åºï¼Œå­—é¢æ„æ€å°±æ˜¯ä¸¤æ¬¡æ‰«æç£ç›˜ï¼Œæœ€ç»ˆå¾—åˆ°æ•°æ®ï¼Œ è¯»å–è¡ŒæŒ‡é’ˆå’Œorder byåˆ—ï¼Œå¯¹ä»–ä»¬è¿›è¡Œæ’åºï¼Œç„¶åæ‰«æå·²ç»æ’åºå¥½çš„åˆ—è¡¨ï¼ŒæŒ‰ç…§åˆ—è¡¨ä¸­çš„å€¼é‡æ–°ä»åˆ—è¡¨ä¸­è¯»å–å¯¹åº”çš„æ•°æ®è¾“å‡º ä»ç£ç›˜å–æ’åºå­—æ®µï¼Œåœ¨bufferè¿›è¡Œæ’åºï¼Œå†ä»ç£ç›˜å–å…¶ä»–å­—æ®µã€‚ å–ä¸€æ‰¹æ•°æ®ï¼Œè¦å¯¹ç£ç›˜è¿›è¡Œä¸¤æ¬¡æ‰«æï¼Œä¼—æ‰€å‘¨çŸ¥ï¼ŒI\\Oæ˜¯å¾ˆè€—æ—¶çš„ï¼Œæ‰€ä»¥åœ¨mysql4.1ä¹‹åï¼Œå‡ºç°äº†ç¬¬äºŒç§æ”¹è¿›çš„ç®—æ³•ï¼Œå°±æ˜¯å•è·¯æ’åºã€‚ å•è·¯æ’åº ä»ç£ç›˜è¯»å–æŸ¥è¯¢éœ€è¦çš„æ‰€æœ‰åˆ—ï¼ŒæŒ‰ç…§order byåˆ—åœ¨bufferå¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼Œç„¶åæ‰«ææ’åºåçš„åˆ—è¡¨è¿›è¡Œè¾“å‡ºï¼Œ å®ƒçš„æ•ˆç‡æ›´å¿«ä¸€äº›ï¼Œé¿å…äº†ç¬¬äºŒæ¬¡è¯»å–æ•°æ®ã€‚å¹¶ä¸”æŠŠéšæœºIOå˜æˆäº†é¡ºåºIOï¼Œä½†æ˜¯å®ƒä¼šä½¿ç”¨æ›´å¤šçš„ç©ºé—´ï¼Œ å› ä¸ºå®ƒæŠŠæ¯ä¸€è¡Œéƒ½ä¿å­˜åœ¨å†…å­˜ä¸­äº†ã€‚ ç»“è®º ç”±äºå•è·¯æ˜¯åå‡ºçš„ï¼Œæ€»ä½“è€Œè¨€å¥½è¿‡åŒè·¯ã€‚ ä½†æ˜¯ç”¨å•è·¯æœ‰é—®é¢˜ï¼š åœ¨sort_bufferä¸­ï¼Œå•è·¯æ¯”å¤šè·¯è¦å¤šå ç”¨å¾ˆå¤šç©ºé—´ï¼Œå› ä¸ºå•è·¯æ˜¯æŠŠæ‰€æœ‰å­—æ®µéƒ½å–å‡º, æ‰€ä»¥æœ‰å¯èƒ½å–å‡ºçš„æ•°æ®çš„æ€»å¤§å°è¶…å‡ºäº†sort_bufferçš„å®¹é‡ï¼Œå¯¼è‡´æ¯æ¬¡åªèƒ½å–sort_bufferå®¹é‡å¤§å°çš„æ•°æ®ï¼Œè¿›è¡Œæ’åºï¼ˆåˆ›å»ºtmpæ–‡ä»¶ï¼Œå¤šè·¯åˆå¹¶ï¼‰ï¼Œæ’å®Œå†å–sort_bufferå®¹é‡å¤§å°ï¼Œå†æ’â€¦â€¦ä»è€Œå¤šæ¬¡I/Oã€‚ å•è·¯æœ¬æ¥æƒ³çœä¸€æ¬¡I/Oæ“ä½œï¼Œåè€Œå¯¼è‡´äº†å¤§é‡çš„I/Oæ“ä½œï¼Œåè€Œå¾—ä¸å¿å¤±ã€‚ ä¼˜åŒ–ç­–ç•¥ å¢å¤§sort_buffer_sizeå‚æ•°çš„è®¾ç½® å¢å¤§max_length_for_sort_dataå‚æ•°çš„è®¾ç½® å‡å°‘select åé¢çš„æŸ¥è¯¢çš„å­—æ®µã€‚ æé«˜order byçš„é€Ÿåº¦ Order byæ—¶select * æ˜¯ä¸€ä¸ªå¤§å¿Œã€‚åªQueryéœ€è¦çš„å­—æ®µï¼Œ è¿™ç‚¹éå¸¸é‡è¦ã€‚ å½“Queryçš„å­—æ®µå¤§å°æ€»å’Œå°äºmax_length_for_sort_data è€Œä¸”æ’åºå­—æ®µä¸æ˜¯ TEXT|BLOB ç±»å‹æ—¶ï¼Œä¼šç”¨æ”¹è¿›åçš„ç®—æ³•â€”â€”å•è·¯æ’åºï¼Œ å¦åˆ™ç”¨è€ç®—æ³•â€”â€”å¤šè·¯æ’åºã€‚ ä¸¤ç§ç®—æ³•çš„æ•°æ®éƒ½æœ‰å¯èƒ½è¶…å‡ºsort_bufferçš„å®¹é‡ï¼Œè¶…å‡ºä¹‹åï¼Œä¼šåˆ›å»ºtmpæ–‡ä»¶è¿›è¡Œåˆå¹¶æ’åºï¼Œå¯¼è‡´å¤šæ¬¡I/Oï¼Œä½†æ˜¯ç”¨å•è·¯æ’åºç®—æ³•çš„é£é™©ä¼šæ›´å¤§ä¸€äº›ï¼Œæ‰€ä»¥è¦æé«˜sort_buffer_sizeã€‚ å°è¯•æé«˜ sort_buffer_size ä¸ç®¡ç”¨å“ªç§ç®—æ³•ï¼Œæé«˜è¿™ä¸ªå‚æ•°éƒ½ä¼šæé«˜æ•ˆç‡ï¼Œå½“ç„¶ï¼Œè¦æ ¹æ®ç³»ç»Ÿçš„èƒ½åŠ›å»æé«˜ï¼Œå› ä¸ºè¿™ä¸ªå‚æ•°æ˜¯é’ˆå¯¹æ¯ä¸ªè¿›ç¨‹ï¼ˆconnectionï¼‰çš„ 1M-8Mä¹‹é—´è°ƒæ•´ã€‚ MySQL5.7ï¼ŒInnoDBå­˜å‚¨å¼•æ“é»˜è®¤å€¼æ˜¯1048576å­—èŠ‚ï¼Œ1MBã€‚ 1SHOW VARIABLES LIKE &#x27;%sort_buffer_size%&#x27;; å°è¯•æé«˜ max_length_for_sort_data æé«˜è¿™ä¸ªå‚æ•°ï¼Œ ä¼šå¢åŠ ç”¨æ”¹è¿›ç®—æ³•çš„æ¦‚ç‡ã€‚ ä½†æ˜¯å¦‚æœè®¾çš„å¤ªé«˜ï¼Œæ•°æ®æ€»å®¹é‡è¶…å‡ºsort_buffer_sizeçš„æ¦‚ç‡å°±å¢å¤§ï¼Œæ˜æ˜¾ç—‡çŠ¶æ˜¯é«˜çš„ç£ç›˜I/Oæ´»åŠ¨å’Œä½çš„å¤„ç†å™¨ä½¿ç”¨ç‡ã€‚å¦‚æœéœ€è¦è¿”å›çš„åˆ—çš„æ€»é•¿åº¦å¤§äºmax_length_for_sort_dataï¼Œä½¿ç”¨åŒè·¯ç®—æ³•ï¼Œå¦åˆ™ä½¿ç”¨å•è·¯ç®—æ³•ã€‚1024-8192å­—èŠ‚ä¹‹é—´è°ƒæ•´ã€‚ 1SHOW VARIABLES LIKE &#x27;%max_length_for_sort_data%&#x27;; #é»˜è®¤1024å­—èŠ‚ 5.6 åˆ†ç»„ä¼˜åŒ–group by ä½¿ç”¨ç´¢å¼•çš„åŸåˆ™å‡ ä¹è·Ÿorder byä¸€è‡´ ï¼Œå”¯ä¸€åŒºåˆ«ï¼š group by å…ˆæ’åºå†åˆ†ç»„ï¼Œéµç…§ç´¢å¼•å»ºçš„æœ€ä½³å·¦å‰ç¼€æ³•åˆ™ å½“æ— æ³•ä½¿ç”¨ç´¢å¼•åˆ—ï¼Œå¢å¤§max_length_for_sort_dataå’Œsort_buffer_sizeå‚æ•°çš„è®¾ç½® whereé«˜äºhaving,èƒ½å†™åœ¨whereé™å®šçš„æ¡ä»¶å°±ä¸è¦å†™åœ¨havingä¸­äº† group byæ²¡æœ‰è¿‡æ»¤æ¡ä»¶ï¼Œä¹Ÿå¯ä»¥ç”¨ä¸Šç´¢å¼•ã€‚Order By å¿…é¡»æœ‰è¿‡æ»¤æ¡ä»¶æ‰èƒ½ä½¿ç”¨ä¸Šç´¢å¼•ã€‚ 6. è¦†ç›–ç´¢å¼•ç¦æ­¢ä½¿ç”¨select *ï¼Œç¦æ­¢æŸ¥è¯¢ä¸ä¸šåŠ¡æ— å…³å­—æ®µï¼Œå°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œé˜²æ­¢å›è¡¨ã€‚ è¦†ç›–ç´¢å¼•å‡å°‘äº† IO æ¬¡æ•°ï¼Œå‡å°‘äº†æ•°æ®çš„è®¿é—®é‡ï¼Œå¯ä»¥å¤§å¤§åœ°æå‡æŸ¥è¯¢æ•ˆç‡ã€‚ å››ï¼Œè¿½è¸ªä¼˜åŒ–å™¨å‰é¢çš„åŸç†ç¯‡è¯¦ç»†åˆ†æè¿‡ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚ äº”ï¼Œ åˆ†åº“åˆ†è¡¨ä»ç»´åº¦æ¥è¯´åˆ†æˆä¸¤ç§ï¼Œä¸€ç§æ˜¯å‚ç›´ï¼Œä¸€ç§æ˜¯æ°´å¹³ã€‚ å‚ç›´åˆ‡åˆ†ï¼šåŸºäºè¡¨æˆ–å­—æ®µåˆ’åˆ†ï¼Œè¡¨ç»“æ„ä¸åŒã€‚æˆ‘ä»¬æœ‰å•åº“çš„åˆ†è¡¨ï¼Œä¹Ÿæœ‰å¤šåº“çš„åˆ†åº“ã€‚ æ°´å¹³åˆ‡åˆ†ï¼šåŸºäºæ•°æ®åˆ’åˆ†ï¼Œè¡¨ç»“æ„ç›¸åŒï¼Œæ•°æ®ä¸åŒï¼Œä¹Ÿæœ‰åŒåº“çš„æ°´å¹³åˆ‡åˆ†å’Œå¤šåº“çš„åˆ‡åˆ†ã€‚ 1.å‚ç›´åˆ‡åˆ†å‚ç›´åˆ†è¡¨æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å•åº“çš„ï¼Œä¸€ç§æ˜¯å¤šåº“çš„ã€‚ 1.1 å•åº“å‚ç›´åˆ†è¡¨å•åº“åˆ†è¡¨ï¼Œæ¯”å¦‚ï¼šå•†æˆ·ä¿¡æ¯è¡¨ï¼Œæ‹†åˆ†æˆåŸºæœ¬ä¿¡æ¯è¡¨ï¼Œè”ç³»æ–¹å¼è¡¨ï¼Œç»“ç®—ä¿¡æ¯è¡¨ï¼Œé™„ä»¶è¡¨ç­‰ç­‰ã€‚ å¯ä»¥è€ƒè™‘æ ¹æ®å†·çƒ­ç‚¹å­—æ®µæ‹†åˆ†ï¼Œæ˜¯å¦ç»å¸¸å‘ç”Ÿä¿®æ”¹æ“ä½œæ‹†åˆ†ï¼Œæ ¹æ®å­—æ®µåŠŸèƒ½æ‹†åˆ†ã€‚ 1.2 å¤šåº“å‚ç›´åˆ†è¡¨å¤šåº“å‚ç›´åˆ†è¡¨å°±æ˜¯æŠŠåŸæ¥å­˜å‚¨åœ¨ä¸€ä¸ªåº“çš„ä¸åŒçš„è¡¨ï¼Œæ‹†åˆ†åˆ°ä¸åŒçš„æ•°æ®åº“ã€‚ æ¯”å¦‚ç”µå•†å¹³å°çš„æ¶ˆè´¹ç³»ç»Ÿï¼šä¸€å¼€å§‹ï¼Œå•†å“è¡¨ï¼Œå•†å“è¯¦æƒ…è¡¨ï¼Œè®¢å•è¡¨ï¼Œç”¨æˆ·è¡¨ï¼Œæ”¯ä»˜è®°å½•è¡¨ï¼Œåº“å­˜è¡¨ï¼Œé£æ§è¡¨éƒ½åœ¨ä¸€ä¸ªåº“é‡Œé¢ï¼Œéšç€æ•°æ®çš„å¢é•¿å’Œä¸šåŠ¡çš„æ‰©å¼ ï¼Œå¯ä»¥è€ƒè™‘å°†å•†å“å’Œå•†å“è¯¦æƒ…è¡¨å•ç‹¬æ”¾åˆ°ä¸€ä¸ªåº“ï¼Œè®¢å•è¡¨å•ç‹¬æ”¾åˆ°ä¸€ä¸ªåº“ï¼Œæ”¯ä»˜è®°å½•å•ç‹¬æ”¾åˆ°ä¸€ä¸ªåº“ï¼Œåº“å­˜è¡¨å•ç‹¬æ”¾åˆ°ä¸€ä¸ªåº“ï¼Œé£æ§è¡¨å•ç‹¬æ”¾åˆ°ä¸€ä¸ªåº“ã€‚ å½“æˆ‘ä»¬å¯¹åŸæ¥çš„ä¸€å¼ è¡¨åšäº†åˆ†åº“çš„å¤„ç†ï¼Œå¦‚æœæŸäº›ä¸šåŠ¡ç³»ç»Ÿçš„æ•°æ®è¿˜æ˜¯æœ‰ä¸€ä¸ªéå¸¸å¿«çš„å¢é•¿é€Ÿåº¦ï¼Œæ¯”å¦‚è¯´è®¢å•æ•°æ®åº“çš„è®¢å•è¡¨ï¼Œæ•°æ®é‡è¾¾åˆ°äº†å‡ ä¸ªäº¿ï¼Œè¿™ä¸ªæ—¶å€™ç¡¬ä»¶é™åˆ¶å¯¼è‡´çš„æ€§èƒ½é—®é¢˜è¿˜æ˜¯ä¼šå‡ºç°ï¼Œæ‰€ä»¥ä»è¿™ä¸ªè§’åº¦æ¥è¯´å‚ç›´åˆ‡åˆ†å¹¶æ²¡æœ‰ä»æ ¹æœ¬ä¸Šè§£å†³å•åº“å•è¡¨æ•°æ®é‡è¿‡å¤§çš„é—®é¢˜ã€‚åœ¨è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹æˆ‘ä»¬çš„æ•°æ®åšä¸€ä¸ªæ°´å¹³çš„åˆ‡åˆ†ã€‚ 2.æ°´å¹³æ‹†åˆ†å½“æˆ‘ä»¬çš„å®¢æˆ·è¡¨æ•°é‡å·²ç»åˆ°è¾¾æ•°åƒä¸‡ç”šè‡³ä¸Šäº¿çš„æ—¶å€™ï¼Œå•è¡¨çš„å­˜å‚¨å®¹é‡å’ŒæŸ¥è¯¢æ•ˆç‡éƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥å¯¹å•å¼ è¡¨çš„æ•°æ®è¿›è¡Œæ°´å¹³åˆ‡åˆ†ã€‚æ°´å¹³åˆ‡åˆ†çš„æ¯ä¸ªæ•°æ®åº“çš„è¡¨ç»“æ„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å­˜å‚¨çš„æ•°æ®ä¸ä¸€æ ·ï¼Œæ¯”å¦‚æ¯ä¸ªåº“å­˜å‚¨ 1000 ä¸‡çš„æ•°æ®ã€‚ æ°´å¹³åˆ‡åˆ†ä¹Ÿå¯ä»¥åˆ†æˆä¸¤ç§ï¼Œä¸€ç§æ˜¯å•åº“çš„ï¼Œä¸€ç§æ˜¯å¤šåº“çš„ã€‚ 2.1 å•åº“æ°´å¹³åˆ†è¡¨é“¶è¡Œçš„äº¤æ˜“æµæ°´è¡¨ï¼Œæ‰€æœ‰è¿›å‡ºçš„äº¤æ˜“éƒ½éœ€è¦ç™»è®°è¿™å¼ è¡¨ï¼Œå› ä¸ºç»å¤§éƒ¨åˆ†æ—¶å€™å®¢æˆ·éƒ½æ˜¯æŸ¥è¯¢å½“å¤©çš„äº¤æ˜“å’Œä¸€ä¸ªæœˆä»¥å†…çš„äº¤æ˜“æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬æ ¹æ®ä½¿ç”¨é¢‘ç‡æŠŠè¿™å¼ è¡¨æ‹†åˆ†æˆä¸‰å¼ è¡¨ï¼š å½“å¤©è¡¨ï¼šåªå­˜å‚¨å½“å¤©çš„æ•°æ®ã€‚ å½“æœˆè¡¨ï¼šåœ¨å¤œé—´è¿è¡Œä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå‰ä¸€å¤©çš„æ•°æ®ï¼Œå…¨éƒ¨è¿ç§»åˆ°å½“æœˆè¡¨ã€‚ç”¨çš„æ˜¯ insert into selectï¼Œç„¶å deleteã€‚ å†å²è¡¨ï¼šåŒæ ·æ˜¯é€šè¿‡å®šæ—¶ä»»åŠ¡ï¼ŒæŠŠç™»è®°æ—¶é—´è¶…è¿‡ 30 å¤©çš„æ•°æ®ï¼Œè¿ç§»åˆ° historyå†å²è¡¨ï¼ˆå†å²è¡¨çš„æ•°æ®éå¸¸å¤§ï¼Œæˆ‘ä»¬æŒ‰ç…§æœˆåº¦ï¼Œæ¯ä¸ªæœˆå»ºç«‹åˆ†åŒºï¼‰ã€‚ è·Ÿåˆ†åŒºä¸€æ ·ï¼Œè¿™ç§æ–¹å¼è™½ç„¶å¯ä»¥ä¸€å®šç¨‹åº¦è§£å†³å•è¡¨æŸ¥è¯¢æ€§èƒ½çš„é—®é¢˜ï¼Œä½†æ˜¯å¹¶ä¸èƒ½è§£å†³å•æœºå­˜å‚¨ç“¶é¢ˆçš„é—®é¢˜ã€‚ 2.2 å¤šåº“æ°´å¹³åˆ†è¡¨æ¯”å¦‚å®¢æˆ·è¡¨ï¼Œæˆ‘ä»¬æ‹†åˆ†åˆ°å¤šä¸ªåº“å­˜å‚¨ï¼Œè¡¨ç»“æ„æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚ ä¸€èˆ¬æˆ‘ä»¬è¯´çš„åˆ†åº“åˆ†è¡¨éƒ½æ˜¯è·¨åº“çš„åˆ†è¡¨ã€‚ 3. åˆ†åº“åˆ†è¡¨å¸¦æ¥çš„é—®é¢˜3.1 è·¨åº“å…³è”æŸ¥è¯¢æ¯”å¦‚æŸ¥è¯¢åˆåŒä¿¡æ¯çš„æ—¶å€™è¦å…³è”å®¢æˆ·æ•°æ®ï¼Œç”±äºæ˜¯åˆåŒæ•°æ®å’Œå®¢æˆ·æ•°æ®æ˜¯åœ¨ä¸åŒçš„æ•°æ®åº“ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‚¯å®šä¸èƒ½ç›´æ¥ä½¿ç”¨ join çš„è¿™ç§æ–¹å¼å»åšå…³è”æŸ¥è¯¢ã€‚ è§£å†³æ–¹æ¡ˆ â‘ å­—æ®µå†—ä½™æ¯”å¦‚æˆ‘ä»¬æŸ¥è¯¢åˆåŒåº“çš„åˆåŒè¡¨çš„æ—¶å€™éœ€è¦å…³è”å®¢æˆ·åº“çš„å®¢æˆ·è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠä¸€äº›ç»å¸¸å…³è”æŸ¥è¯¢çš„å®¢æˆ·å­—æ®µæ”¾åˆ°åˆåŒè¡¨ï¼Œé€šè¿‡è¿™ç§æ–¹å¼é¿å…è·¨åº“å…³è”æŸ¥è¯¢çš„é—®é¢˜ã€‚ â‘¡æ•°æ®åŒæ­¥æ¯”å¦‚å•†æˆ·ç³»ç»Ÿè¦æŸ¥è¯¢äº§å“ç³»ç»Ÿçš„äº§å“è¡¨ï¼Œæˆ‘ä»¬å¹²è„†åœ¨å•†æˆ·ç³»ç»Ÿåˆ›å»ºä¸€å¼ äº§å“è¡¨ï¼Œé€šè¿‡ ETL æˆ–è€…å…¶ä»–æ–¹å¼å®šæ—¶åŒæ­¥äº§å“æ•°æ®ã€‚ â‘¢å…¨å±€è¡¨ï¼ˆå¹¿æ’­è¡¨ï¼‰æ¯”å¦‚è¡Œåè¡Œå·ä¿¡æ¯è¢«å¾ˆå¤šä¸šåŠ¡ç³»ç»Ÿç”¨åˆ°ï¼Œå¦‚æœæˆ‘ä»¬æ”¾åœ¨æ ¸å¿ƒç³»ç»Ÿï¼Œæ¯ä¸ªç³»ç»Ÿéƒ½è¦å»å…³è”æŸ¥è¯¢ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨æ‰€æœ‰çš„æ•°æ®åº“éƒ½å­˜å‚¨ç›¸åŒçš„åŸºç¡€æ•°æ®ã€‚ â‘£ERè¡¨æˆ‘ä»¬æœ‰äº›è¡¨çš„æ•°æ®æ˜¯å­˜åœ¨é€»è¾‘çš„ä¸»å¤–é”®å…³ç³»çš„ï¼Œæ¯”å¦‚è®¢å•è¡¨ order_infoï¼Œå­˜çš„æ˜¯æ±‡æ€»çš„å•†å“æ•°ï¼Œå•†å“é‡‘é¢ï¼›è®¢å•æ˜ç»†è¡¨ order_detailï¼Œæ˜¯æ¯ä¸ªå•†å“çš„ä»·æ ¼ï¼Œä¸ªæ•°ç­‰ç­‰ã€‚æˆ–è€…å«åšä»å±å…³ç³»ï¼Œçˆ¶è¡¨å’Œå­è¡¨çš„å…³ç³»ã€‚ä»–ä»¬ä¹‹é—´ä¼šç»å¸¸æœ‰å…³è”æŸ¥è¯¢çš„æ“ä½œï¼Œå¦‚æœçˆ¶è¡¨çš„æ•°æ®å’Œå­è¡¨çš„æ•°æ®åˆ†åˆ«å­˜å‚¨åœ¨ä¸åŒçš„æ•°æ®åº“ï¼Œè·¨åº“å…³è”æŸ¥è¯¢ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚æ‰€ä»¥æˆ‘ä»¬èƒ½ä¸èƒ½æŠŠçˆ¶è¡¨çš„æ•°æ®å’Œä»å±äºçˆ¶è¡¨çš„æ•°æ®è½åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå‘¢ï¼Ÿ æ¯”å¦‚ order_id=1001 çš„æ•°æ®åœ¨ node1ï¼Œå®ƒæ‰€æœ‰çš„æ˜ç»†æ•°æ®ä¹Ÿæ”¾åˆ° node1ï¼›order_id=1002 çš„æ•°æ®åœ¨ node2ï¼Œå®ƒæ‰€æœ‰çš„æ˜ç»†æ•°æ®éƒ½æ”¾åˆ° node2ï¼Œè¿™æ ·åœ¨å…³è”æŸ¥è¯¢çš„æ—¶å€™ä¾ç„¶æ˜¯åœ¨ä¸€ä¸ªæ•°æ®åº“ã€‚ ä¸Šé¢çš„æ€è·¯éƒ½æ˜¯é€šè¿‡åˆç†çš„æ•°æ®åˆ†å¸ƒé¿å…è·¨åº“å…³è”æŸ¥è¯¢ï¼Œå®é™…ä¸Šåœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ä¸­ï¼Œä¹Ÿæ˜¯å°½é‡ä¸è¦ç”¨è·¨åº“å…³è”æŸ¥è¯¢ï¼Œå¦‚æœå‡ºç°äº†è¿™ç§æƒ…å†µï¼Œå°±è¦åˆ†æä¸€ä¸‹ä¸šåŠ¡æˆ–è€…æ•°æ®æ‹†åˆ†æ˜¯ä¸æ˜¯åˆç†ã€‚å¦‚æœè¿˜æ˜¯å‡ºç°äº†éœ€è¦è·¨åº“å…³è”çš„æƒ…å†µï¼Œé‚£æˆ‘ä»¬å°±åªèƒ½ç”¨æœ€åä¸€ç§åŠæ³•ã€‚ â‘¤ç³»ç»Ÿå±‚ç»„è£…åœ¨ä¸åŒçš„æ•°æ®åº“èŠ‚ç‚¹æŠŠç¬¦åˆæ¡ä»¶æ•°æ®çš„æ•°æ®æŸ¥è¯¢å‡ºæ¥ï¼Œç„¶åé‡æ–°ç»„è£…ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ 3.2 åˆ†å¸ƒå¼äº‹åŠ¡å…·ä½“åˆ†å¸ƒå¼äº‹åŠ¡ä¼šå•ç‹¬å†™ä¸€ç¯‡æ–‡ç«  3.3 æ’åºï¼Œç¿»é¡µï¼Œå‡½æ•°è®¡ç®—é—®é¢˜è·¨èŠ‚ç‚¹å¤šåº“è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œä¼šå‡ºç° limit åˆ†é¡µï¼Œorder by æ’åºçš„é—®é¢˜ã€‚æ¯”å¦‚æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ 1 å­˜çš„æ˜¯å¥‡æ•° id=1,3,5,7,9â€¦â€¦ï¼›èŠ‚ç‚¹ 2 å­˜çš„æ˜¯å¶æ•° id=2,4,6,8,10â€¦â€¦ æ‰§è¡Œ select * from user_info order by id limit 0,10 éœ€è¦åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šå„å–å‡º 10 æ¡ï¼Œç„¶ååˆå¹¶æ•°æ®ï¼Œé‡æ–°æ’åºã€‚ maxã€minã€sumã€count ä¹‹ç±»çš„å‡½æ•°åœ¨è¿›è¡Œè®¡ç®—çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦å…ˆåœ¨æ¯ä¸ªåˆ†ç‰‡ä¸Šæ‰§è¡Œç›¸åº”çš„å‡½æ•°ï¼Œç„¶åå°†å„ä¸ªåˆ†ç‰‡çš„ç»“æœé›†è¿›è¡Œæ±‡æ€»å’Œå†æ¬¡è®¡ç®—ï¼Œæœ€ç»ˆå°†ç»“æœè¿”å›ã€‚ 3.4 å…¨å±€ä¸»é”®é¿é‡MySQL çš„æ•°æ®åº“é‡Œé¢å­—æ®µæœ‰ä¸€ä¸ªè‡ªå¢çš„å±æ€§ï¼ŒOracle ä¹Ÿæœ‰ Sequence åºåˆ—ã€‚å¦‚æœæ˜¯ä¸€ä¸ªæ•°æ®åº“ï¼Œé‚£ä¹ˆå¯ä»¥ä¿è¯ ID æ˜¯ä¸é‡å¤çš„ï¼Œä½†æ˜¯æ°´å¹³åˆ†è¡¨ä»¥åï¼Œæ¯ä¸ªè¡¨éƒ½æŒ‰ç…§è‡ªå·±çš„è§„å¾‹è‡ªå¢ï¼Œè‚¯å®šä¼šå‡ºç° ID é‡å¤çš„é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±ä¸èƒ½ç”¨æœ¬åœ°è‡ªå¢çš„æ–¹å¼äº†ã€‚ è§£å†³æ–¹æ¡ˆ â‘ UUIDUUID æ ‡å‡†å½¢å¼åŒ…å« 32 ä¸ª 16 è¿›åˆ¶æ•°å­—ï¼Œåˆ†ä¸º 5 æ®µï¼Œå½¢å¼ä¸º 8-4-4-4-12 çš„ 36 ä¸ªå­—ç¬¦ï¼Œä¾‹å¦‚ï¼šc4e7956c-03e7-472c-8909-d733803e79a9ã€‚ UUID æ˜¯ä¸»é”®æ˜¯æœ€ç®€å•çš„æ–¹æ¡ˆï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ€§èƒ½é«˜ï¼Œæ²¡æœ‰ç½‘ç»œè€—æ—¶ã€‚ä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œç”±äº UUID éå¸¸é•¿ï¼Œä¼šå ç”¨å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼›å¦å¤–ï¼Œä½œä¸ºä¸»é”®å»ºç«‹ç´¢å¼•å’ŒåŸºäºç´¢å¼•è¿›è¡ŒæŸ¥è¯¢æ—¶éƒ½ä¼šå­˜åœ¨æ€§èƒ½é—®é¢˜ï¼Œåœ¨ InnoDB ä¸­ï¼ŒUUID çš„æ— åºæ€§ä¼šå¼•èµ·æ•°æ®ä½ç½®é¢‘ç¹å˜åŠ¨ï¼Œå¯¼è‡´åˆ†é¡µã€‚ â‘¡æ•°æ®åº“æŠŠåºå·ç»´æŠ¤åœ¨æ•°æ®åº“çš„ä¸€å¼ è¡¨ä¸­ã€‚è¿™å¼ è¡¨è®°å½•äº†å…¨å±€ä¸»é”®çš„ç±»å‹ã€ä½æ•°ã€èµ·å§‹å€¼ï¼Œå½“å‰å€¼ã€‚å½“å…¶ä»–åº”ç”¨éœ€è¦è·å¾—å…¨å±€ ID æ—¶ï¼Œå…ˆ for update é”è¡Œï¼Œå–åˆ°å€¼+1 åå¹¶ä¸”æ›´æ–°åè¿”å›ã€‚å¹¶å‘æ€§æ¯”è¾ƒå·®ã€‚ â‘¢redisåŸºäº Redis çš„ INT è‡ªå¢çš„ç‰¹æ€§ï¼Œä½¿ç”¨æ‰¹é‡çš„æ–¹å¼é™ä½æ•°æ®åº“çš„å†™å‹åŠ›ï¼Œæ¯æ¬¡è·å–ä¸€æ®µåŒºé—´çš„ ID å·æ®µï¼Œç”¨å®Œä¹‹åå†å»æ•°æ®åº“è·å–ï¼Œå¯ä»¥å¤§å¤§å‡è½»æ•°æ®åº“çš„å‹åŠ›ã€‚ â‘£é›ªèŠ±ç®—æ³•ä¼˜ç‚¹ï¼šæ¯«ç§’æ•°åœ¨é«˜ä½ï¼Œç”Ÿæˆçš„ ID æ•´ä½“ä¸ŠæŒ‰æ—¶é—´è¶‹åŠ¿é€’å¢ï¼›ä¸ä¾èµ–ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œç¨³å®šæ€§å’Œæ•ˆç‡è¾ƒé«˜ï¼Œç†è®ºä¸Š QPS çº¦ä¸º 409.6w/s(1000*2^12)ï¼Œå¹¶ä¸”æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå†…ä¸ä¼šäº§ç”Ÿ ID ç¢°æ’ï¼›å¯æ ¹æ®è‡ªèº«ä¸šåŠ¡çµæ´»åˆ†é… bit ä½ã€‚ ä¸è¶³å°±åœ¨äºï¼šå¼ºä¾èµ–æœºå™¨æ—¶é’Ÿï¼Œå¦‚æœæ—¶é’Ÿå›æ‹¨ï¼Œåˆ™å¯èƒ½å¯¼è‡´ç”Ÿæˆ ID é‡å¤ã€‚ 4. å¤šæ•°æ®æº/è¯»å†™æ•°æ®æºçš„è§£å†³æ–¹æ¡ˆåˆ†æä¸€ä¸‹ SQL æ‰§è¡Œç»è¿‡çš„æµç¨‹ï¼š DAOâ€”â€”Mapperï¼ˆORMï¼‰â€”â€”JDBCâ€”â€”ä»£ç†â€”â€”æ•°æ®åº“æœåŠ¡ 4.1 å®¢æˆ·ç«¯DAO å±‚åœ¨æˆ‘ä»¬è¿æ¥åˆ°æŸä¸€ä¸ªæ•°æ®æºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ ¹æ®é…ç½®çš„åˆ†ç‰‡è§„åˆ™ï¼Œåˆ¤æ–­éœ€è¦è¿æ¥åˆ°å“ªäº›èŠ‚ç‚¹ï¼Œå†å»ºç«‹è¿æ¥ã€‚ Spring ä¸­æä¾›äº†ä¸€ä¸ªæŠ½è±¡ç±» AbstractRoutingDataSourceï¼Œå¯ä»¥å®ç°æ•°æ®æºçš„åŠ¨æ€åˆ‡æ¢ã€‚ 123456789101ï¼‰aplication.properties å®šä¹‰å¤šä¸ªæ•°æ®æº2ï¼‰åˆ›å»º@TargetDataSource æ³¨è§£3ï¼‰åˆ›å»º DynamicDataSource ç»§æ‰¿ AbstractRoutingDataSource4ï¼‰å¤šæ•°æ®æºé…ç½®ç±» DynamicDataSourceConfig5ï¼‰åˆ›å»ºåˆ‡é¢ç±» DataSourceAspectï¼Œå¯¹æ·»åŠ äº†@TargetDataSource æ³¨è§£çš„ç±»è¿›è¡Œæ‹¦æˆªè®¾ç½®æ•°æ®æºã€‚6ï¼‰åœ¨ å¯ åŠ¨ ç±» ä¸Š è‡ª åŠ¨ è£… é… æ•° æ® æº é… ç½®@Import(&#123;DynamicDataSourceConfig.class&#125;)7ï¼‰åœ¨ å® ç° ç±» ä¸Š åŠ  ä¸Š æ³¨ è§£ ï¼Œ å¦‚ @TargetDataSource(name =DataSourceNames.SECOND)ï¼Œè°ƒç”¨ åœ¨ DAO å±‚å®ç°çš„ä¼˜åŠ¿ï¼šä¸éœ€è¦ä¾èµ– ORM æ¡†æ¶ï¼Œå³ä½¿æ›¿æ¢äº† ORM æ¡†æ¶ä¹Ÿä¸å—å½±å“ã€‚å®ç°ç®€å•ï¼ˆä¸éœ€è¦è§£æ SQL å’Œè·¯ç”±è§„åˆ™ï¼‰ï¼Œå¯ä»¥çµæ´»åœ°å®šåˆ¶ã€‚ ç¼ºç‚¹ï¼šä¸èƒ½å¤ç”¨ï¼Œä¸èƒ½è·¨è¯­è¨€ã€‚ 4.2 ORMæ¡†æ¶å±‚æ¯”å¦‚æˆ‘ä»¬ç”¨ MyBatis è¿æ¥æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæ•°æ®æºã€‚æˆ‘ä»¬å¯ä»¥åŸºäº MyBatis æ’ä»¶çš„æ‹¦æˆªæœºåˆ¶ï¼ˆæ‹¦æˆª query å’Œ update æ–¹æ³•ï¼‰ï¼Œå®ç°æ•°æ®æºçš„é€‰æ‹©ã€‚ 4.3 é©±åŠ¨å±‚ä¸ç®¡æ˜¯MyBatisè¿˜æ˜¯Hibernateï¼Œè¿˜æ˜¯Springçš„JdbcTemplateï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯å¯¹JDBCçš„å°è£…ï¼Œæ‰€ä»¥ç¬¬ä¸‰å±‚å°±æ˜¯é©±åŠ¨å±‚ã€‚æ¯”å¦‚ Sharding-JDBCï¼Œå°±æ˜¯å¯¹ JDBC çš„å¯¹è±¡è¿›è¡Œäº†å°è£…ã€‚JDBC çš„æ ¸å¿ƒå¯¹è±¡ï¼š DataSourceï¼šæ•°æ®æº Connectionï¼šæ•°æ®åº“è¿æ¥ Statementï¼šè¯­å¥å¯¹è±¡ ResultSetï¼šç»“æœé›† é‚£æˆ‘ä»¬åªè¦å¯¹è¿™å‡ ä¸ªå¯¹è±¡è¿›è¡Œå°è£…æˆ–è€…æ‹¦æˆªæˆ–è€…ä»£ç†ï¼Œå°±å¯ä»¥å®ç°åˆ†ç‰‡çš„æ“ä½œã€‚ 4.4 ä»£ç†å±‚å‰é¢ä¸‰ç§éƒ½æ˜¯åœ¨å®¢æˆ·ç«¯å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒçš„é¡¹ç›®éƒ½è¦åšåŒæ ·çš„æ”¹åŠ¨ï¼Œä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¹Ÿæœ‰ä¸åŒçš„å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½ä¸èƒ½æŠŠè¿™ç§é€‰æ‹©æ•°æ®æºå’Œå®ç°è·¯ç”±çš„é€»è¾‘æå–å‡ºæ¥ï¼Œåšæˆä¸€ä¸ªå…¬å…±çš„æœåŠ¡ç»™æ‰€æœ‰çš„å®¢æˆ·ç«¯ä½¿ç”¨å‘¢ï¼Ÿ è¿™ä¸ªå°±æ˜¯ç¬¬å››å±‚ï¼Œä»£ç†å±‚ã€‚æ¯”å¦‚ Mycat å’Œ Sharding-Proxyï¼Œéƒ½æ˜¯å±äºè¿™ä¸€å±‚ã€‚ 4.5 æ•°æ®åº“æœåŠ¡æŸäº›ç‰¹å®šçš„æ•°æ®åº“æˆ–è€…æ•°æ®åº“çš„ç‰¹å®šç‰ˆæœ¬å¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ å…­ï¼Œä¸»ä»å¤åˆ¶1. åŸºæœ¬åŸç† MySQLå¤åˆ¶è¿‡ç¨‹åˆ†æˆä¸‰æ­¥ï¼š masterå°†æ”¹å˜è®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinary logï¼‰ã€‚è¿™äº›è®°å½•è¿‡ç¨‹å«åšäºŒè¿›åˆ¶æ—¥å¿—äº‹ä»¶ï¼Œbinary log eventsï¼› slaveå°†masterçš„binary log eventsæ‹·è´åˆ°å®ƒçš„ä¸­ç»§æ—¥å¿—ï¼ˆrelay logï¼‰ï¼› slaveé‡åšä¸­ç»§æ—¥å¿—ä¸­çš„äº‹ä»¶ï¼Œå°†æ”¹å˜åº”ç”¨åˆ°è‡ªå·±çš„æ•°æ®åº“ä¸­ã€‚ MySQLå¤åˆ¶æ˜¯å¼‚æ­¥çš„ä¸”ä¸²è¡ŒåŒ–çš„ï¼Œslaveä¼šä»masterè¯»å–binlogæ¥è¿›è¡Œæ•°æ®åŒæ­¥ã€‚ 2.ä¸Redisä¸»ä»å¤åˆ¶çš„å·®åˆ« redisä¸»ä»å¤åˆ¶æ˜¯å°†ä¸»æœºçš„æ‰€æœ‰æ•°æ®éƒ½æ‹·è´ç»™ä»æœºï¼Œå¹¶ä¸”æ˜¯è¿‘ä¹å®æ—¶çš„ã€‚ mysqlä¸»ä»å¤åˆ¶ä¸ä¼šå°†å»ºç«‹è¿æ¥ä»¥å‰çš„æ•°æ®å‘é€ç»™ä»æœºï¼Œå¹¶ä¸”æ˜¯å¼‚æ­¥ï¼Œä¸”ä¸²è¡ŒåŒ–çš„ã€‚ 3.å¤åˆ¶çš„åŸºæœ¬åŸåˆ™æ¯ä¸ªslaveåªæœ‰ä¸€ä¸ªmaster æ¯ä¸ªslaveåªèƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æœåŠ¡å™¨ID æ¯ä¸ªmasterå¯ä»¥æœ‰å¤šä¸ªsalve 4.å¤åˆ¶çš„æœ€å¤§é—®é¢˜å»¶æ—¶ å…¨åŒæ­¥å¯ä»¥é¿å…ï¼Œä½†æ€§èƒ½ä¼šæå·®ï¼Œæ­£å¸¸æƒ…å†µä¸‹åŠåŒæ­¥ï¼Œä¸”å®¹å¿ä¸€éƒ¨åˆ†æ•°æ®ä¸ä¸€è‡´ã€‚å¦‚æœä¸å®¹å¿æ•°æ®ä¸ä¸€è‡´ï¼Œåªæœ‰å¼ºåˆ¶è¯»ä¸»ã€‚ 5.ä¸€ä¸»ä¸€ä»å¸¸è§é…ç½® MySQLç‰ˆæœ¬ä¸€è‡´ä¸”åå°ä»¥æœåŠ¡è¿è¡Œ ä¸»ä»é…ç½®éƒ½åœ¨ã€mysqldã€‘èŠ‚ç‚¹ä¸‹ï¼Œä¸”å…¨éƒ¨å°å†™ ä¸»æœºä¿®æ”¹my.iniæ–‡ä»¶ ä¸»æœåŠ¡å™¨å”¯ä¸€ID server-id=1 å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿— è®¾ç½®ä¸è¦å¤åˆ¶çš„æ•°æ®åº“ è®¾ç½®éœ€è¦å¤åˆ¶çš„æ•°æ®åº“ è®¾ç½®logbinæ ¼å¼ log-bin=è‡ªå·±çš„æœ¬åœ°è·¯å¾„/data/mysqlbin binlog-ignore-db=mysql binlog-do-db=éœ€è¦å¤åˆ¶çš„ä¸»æ•°æ®åº“åå­— binlog_fromat=STATEMENT(é»˜è®¤) ä¸ƒï¼Œç¡¬ä»¶å±‚é¢çš„é…ç½®1.é€‰æ‹©åˆé€‚çš„CPUæ•°æ®åº“åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œåœ¨çº¿äº‹åŠ¡å¤„ç†å’Œåœ¨çº¿åˆ†æå¤„ç†ã€‚ InnoDBå‚¨å­˜å¼•æ“ä¸€èˆ¬åº”ç”¨äºOLTPçš„æ•°æ®åº“åº”ç”¨ï¼Œè¿™ç§åº”ç”¨çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š ç”¨æˆ·æ“ä½œçš„å¹¶å‘é‡å¤§ äº‹åŠ¡å¤„ç†æ—¶é—´ä¸€èˆ¬æ¯”è¾ƒçŸ­ æŸ¥è¯¢çš„è¯­å¥è¾ƒä¸ºç®€å•ï¼Œä¸€èˆ¬éƒ½èµ°ç´¢å¼• å¤æ‚æŸ¥è¯¢æ¯”è¾ƒå°‘ åœ¨å½“å‰çš„MySQLæ•°æ®åº“ç‰ˆæœ¬ä¸­ï¼Œä¸€æ¡SQLè¯­å¥åªèƒ½åœ¨ä¸€ä¸ªCPUå·¥ä½œï¼Œå¹¶ä¸æ”¯æŒå¤šCPUã€‚è‹¥cpuæ”¯æŒå¤šæ ¸ï¼Œinnodbç‰ˆæœ¬åº”è¯¥é€‰æ‹©1.1æˆ–è€…æ›´é«˜ã€‚å¦å¤–å¦‚æœæ˜¯å¤šæ ¸cpuï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹å‚æ•°innodb_read_io_threadså’Œinnodb_write_io_threadsæ¥å¢å¤§IOçš„çº¿ç¨‹ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æ›´å……åˆ†çš„åˆ©ç”¨cpuçš„å¤šæ ¸æ€§èƒ½ã€‚ 2.å†…å­˜çš„é‡è¦æ€§å†…å­˜å¤§å°ç›´æ¥åæ˜ æ•°æ®åº“çš„æ€§èƒ½ã€‚Innodbå­˜å‚¨å¼•æ“æ—¢ç¼“å­˜æ•°æ®ï¼Œåˆç¼“å­˜ç´¢å¼•ï¼Œå¹¶ä¸”å°†å®ƒä»¬ç¼“å­˜äºä¸€ä¸ªå¾ˆå¤§çš„ç¼“å†²æ± ä¸­ï¼Œå³InnoDB Buffer Poolã€‚å› æ­¤ï¼Œå†…å­˜çš„å¤§å°ç›´æ¥å½±åƒæ•°æ®åº“çš„æ€§èƒ½ã€‚ 3.ç£ç›˜å¯¹æ•°æ®åº“æ€§èƒ½çš„å½±å“4.åˆç†è®¾ç½®RAIDç±»å‹5.æ“ä½œç³»ç»Ÿçš„é€‰æ‹©6.æ–‡ä»¶ç³»ç»Ÿçš„é€‰æ‹©","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[å]Explain&optimizer trace","slug":"MySQL/MySQL[å]Explain&optimizer trace","date":"2022-01-11T03:16:42.428Z","updated":"2022-01-11T03:24:05.355Z","comments":true,"path":"2022/01/11/MySQL/MySQL[å]Explain&optimizer trace/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E5%8D%81]Explain&optimizer%20trace/","excerpt":"","text":"ä¸€ï¼ŒExplainä¸€æ¡æŸ¥è¯¢è¯­å¥åœ¨ç»è¿‡MySQLæŸ¥è¯¢ä¼˜åŒ–å™¨çš„å„ç§åŸºäºæˆæœ¬å’Œè§„åˆ™çš„ä¼˜åŒ–ä¼šåç”Ÿæˆä¸€ä¸ªæ‰€è°“çš„æ‰§è¡Œè®¡åˆ’ï¼Œè¿™ä¸ªæ‰§è¡Œè®¡åˆ’å±•ç¤ºäº†æ¥ä¸‹æ¥å…·ä½“æ‰§è¡ŒæŸ¥è¯¢çš„æ–¹å¼ï¼Œæ¯”å¦‚å¤šè¡¨è¿æ¥çš„é¡ºåºæ˜¯ä»€ä¹ˆï¼Œå¯¹äºæ¯ä¸ªè¡¨é‡‡ç”¨ä»€ä¹ˆè®¿é—®æ–¹æ³•æ¥å…·ä½“æ‰§è¡ŒæŸ¥è¯¢ç­‰ç­‰ã€‚MySQLä¸ºæˆ‘ä»¬æä¾›äº†EXPLAINè¯­å¥æ¥å¸®åŠ©æˆ‘ä»¬æŸ¥çœ‹æŸä¸ªæŸ¥è¯¢è¯­å¥çš„å…·ä½“æ‰§è¡Œè®¡åˆ’ï¼Œå¦‚æœæˆ‘ä»¬æƒ³çœ‹çœ‹æŸä¸ªæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’çš„è¯ï¼Œå¯ä»¥åœ¨å…·ä½“çš„æŸ¥è¯¢è¯­å¥å‰è¾¹åŠ ä¸€ä¸ªEXPLAINï¼Œå°±åƒè¿™æ ·ï¼š å…¶å®é™¤äº†ä»¥SELECTå¼€å¤´çš„æŸ¥è¯¢è¯­å¥ï¼Œå…¶ä½™çš„DELETEã€INSERTã€REPLACEä»¥åŠUPDATEè¯­å¥å‰è¾¹éƒ½å¯ä»¥åŠ ä¸ŠEXPLAINè¿™ä¸ªè¯å„¿ï¼Œç”¨æ¥æŸ¥çœ‹è¿™äº›è¯­å¥çš„æ‰§è¡Œè®¡åˆ’ï¼Œä¸è¿‡æˆ‘ä»¬è¿™é‡Œå¯¹SELECTè¯­å¥æ›´æ„Ÿå…´è¶£ï¼Œæ‰€ä»¥åè¾¹åªä¼šä»¥SELECTè¯­å¥ä¸ºä¾‹æ¥æè¿°EXPLAINè¯­å¥çš„ç”¨æ³•ã€‚æˆ‘ä»¬å…ˆæŠŠEXPLAINè¯­å¥è¾“å‡ºçš„å„ä¸ªåˆ—çš„ä½œç”¨å…ˆå¤§è‡´ç½—åˆ—ä¸€ä¸‹ï¼š åˆ—å æè¿° id åœ¨ä¸€ä¸ªå¤§çš„æŸ¥è¯¢è¯­å¥ä¸­æ¯ä¸ªSELECTå…³é”®å­—éƒ½å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„id select_type SELECTå…³é”®å­—å¯¹åº”çš„é‚£ä¸ªæŸ¥è¯¢çš„ç±»å‹ table è¡¨å partitions åŒ¹é…çš„åˆ†åŒºä¿¡æ¯ type é’ˆå¯¹å•è¡¨çš„è®¿é—®æ–¹æ³• possible_keys å¯èƒ½ç”¨åˆ°çš„ç´¢å¼• key å®é™…ä¸Šä½¿ç”¨çš„ç´¢å¼• key_len å®é™…ä½¿ç”¨åˆ°çš„ç´¢å¼•é•¿åº¦ ref å½“ä½¿ç”¨ç´¢å¼•åˆ—ç­‰å€¼æŸ¥è¯¢æ—¶ï¼Œä¸ç´¢å¼•åˆ—è¿›è¡Œç­‰å€¼åŒ¹é…çš„å¯¹è±¡ä¿¡æ¯ rows é¢„ä¼°çš„éœ€è¦è¯»å–çš„è®°å½•æ¡æ•° filtered æŸä¸ªè¡¨ç»è¿‡æœç´¢æ¡ä»¶è¿‡æ»¤åå‰©ä½™è®°å½•æ¡æ•°çš„ç™¾åˆ†æ¯” Extra ä¸€äº›é¢å¤–çš„ä¿¡æ¯ æˆ‘ä»¬å‰é¢åˆ›å»ºè¿‡ä¸€å¼ single_tableè¡¨ï¼š 123456789101112131415CREATE TABLE single_table ( id INT NOT NULL AUTO_INCREMENT, key1 VARCHAR(100), key2 INT, key3 VARCHAR(100), key_part1 VARCHAR(100), key_part2 VARCHAR(100), key_part3 VARCHAR(100), common_field VARCHAR(100), PRIMARY KEY (id), KEY idx_key1 (key1), UNIQUE KEY idx_key2 (key2), KEY idx_key3 (key3), KEY idx_key_part(key_part1, key_part2, key_part3)) Engine=InnoDB CHARSET=utf8; 1.æ‰§è¡Œè®¡åˆ’è¾“å‡ºä¸­å„åˆ—è¯¦è§£tableä¸è®ºæˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥æœ‰å¤šå¤æ‚ï¼Œé‡Œè¾¹å„¿åŒ…å«äº†å¤šå°‘ä¸ªè¡¨ï¼Œåˆ°æœ€åä¹Ÿæ˜¯éœ€è¦å¯¹æ¯ä¸ªè¡¨è¿›è¡Œå•è¡¨è®¿é—®çš„ï¼Œæ‰€ä»¥MySQLè§„å®šEXPLAINè¯­å¥è¾“å‡ºçš„æ¯æ¡è®°å½•éƒ½å¯¹åº”ç€æŸä¸ªå•è¡¨çš„è®¿é—®æ–¹æ³•ï¼Œè¯¥æ¡è®°å½•çš„tableåˆ—ä»£è¡¨ç€è¯¥è¡¨çš„è¡¨åã€‚æ‰€ä»¥æˆ‘ä»¬çœ‹ä¸€æ¡æ¯”è¾ƒç®€å•çš„æŸ¥è¯¢è¯­å¥ï¼š è¿™ä¸ªæŸ¥è¯¢è¯­å¥åªæ¶‰åŠå¯¹s1è¡¨çš„å•è¡¨æŸ¥è¯¢ï¼Œæ‰€ä»¥EXPLAINè¾“å‡ºä¸­åªæœ‰ä¸€æ¡è®°å½•ï¼Œå…¶ä¸­çš„tableåˆ—çš„å€¼æ˜¯s1ï¼Œè¡¨æ˜è¿™æ¡è®°å½•æ˜¯ç”¨æ¥è¯´æ˜å¯¹s1è¡¨çš„å•è¡¨è®¿é—®æ–¹æ³•çš„ã€‚ ä¸‹è¾¹æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸€ä¸ªè¿æ¥æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ï¼š å¯ä»¥çœ‹åˆ°è¿™ä¸ªè¿æ¥æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ä¸­æœ‰ä¸¤æ¡è®°å½•ï¼Œè¿™ä¸¤æ¡è®°å½•çš„tableåˆ—åˆ†åˆ«æ˜¯s1å’Œs2ï¼Œè¿™ä¸¤æ¡è®°å½•ç”¨æ¥åˆ†åˆ«è¯´æ˜å¯¹s1è¡¨å’Œs2è¡¨çš„è®¿é—®æ–¹æ³•æ˜¯ä»€ä¹ˆã€‚ idæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬å†™çš„æŸ¥è¯¢è¯­å¥ä¸€èˆ¬éƒ½ä»¥SELECTå…³é”®å­—å¼€å¤´ï¼Œæ¯”è¾ƒç®€å•çš„æŸ¥è¯¢è¯­å¥é‡Œåªæœ‰ä¸€ä¸ªSELECTå…³é”®å­—ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢è¯­å¥ï¼š 1SELECT * FROM s1 WHERE key1 = &#x27;a&#x27;; ç¨å¾®å¤æ‚ä¸€ç‚¹çš„è¿æ¥æŸ¥è¯¢ä¸­ä¹Ÿåªæœ‰ä¸€ä¸ªSELECTå…³é”®å­—ï¼Œæ¯”å¦‚ï¼š 123SELECT * FROM s1 INNER JOIN s2 ON s1.key1 = s2.key1 WHERE s1.common_field = &#x27;a&#x27;; ä½†æ˜¯ä¸‹è¾¹ä¸¤ç§æƒ…å†µä¸‹åœ¨ä¸€æ¡æŸ¥è¯¢è¯­å¥ä¸­ä¼šå‡ºç°å¤šä¸ªSELECTå…³é”®å­—ï¼š æŸ¥è¯¢ä¸­åŒ…å«å­æŸ¥è¯¢çš„æƒ…å†µæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢è¯­å¥ä¸­å°±åŒ…å«2ä¸ªSELECTå…³é”®å­—ï¼š 12SELECT * FROM s1 WHERE key1 IN (SELECT key3 FROM s2); æŸ¥è¯¢ä¸­åŒ…å«UNIONè¯­å¥çš„æƒ…å†µæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢è¯­å¥ä¸­ä¹ŸåŒ…å«2ä¸ªSELECTå…³é”®å­—ï¼š 1SELECT * FROM s1 UNION SELECT * FROM s2; æŸ¥è¯¢è¯­å¥ä¸­æ¯å‡ºç°ä¸€ä¸ªSELECTå…³é”®å­—ï¼ŒMySQLå°±ä¼šä¸ºå®ƒåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„idå€¼ã€‚è¿™ä¸ªidå€¼å°±æ˜¯EXPLAINè¯­å¥çš„ç¬¬ä¸€ä¸ªåˆ—ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ä¸­åªæœ‰ä¸€ä¸ªSELECTå…³é”®å­—ï¼Œæ‰€ä»¥EXPLAINçš„ç»“æœä¸­ä¹Ÿå°±åªæœ‰ä¸€æ¡idåˆ—ä¸º1çš„è®°å½•ï¼š å¯¹äºè¿æ¥æŸ¥è¯¢æ¥è¯´ï¼Œä¸€ä¸ªSELECTå…³é”®å­—åè¾¹çš„FROMå­å¥ä¸­å¯ä»¥è·Ÿéšå¤šä¸ªè¡¨ï¼Œæ‰€ä»¥åœ¨è¿æ¥æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œæ¯ä¸ªè¡¨éƒ½ä¼šå¯¹åº”ä¸€æ¡è®°å½•ï¼Œä½†æ˜¯è¿™äº›è®°å½•çš„idå€¼éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ¯”å¦‚ï¼š å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°è¿æ¥æŸ¥è¯¢ä¸­å‚ä¸è¿æ¥çš„s1å’Œs2è¡¨åˆ†åˆ«å¯¹åº”ä¸€æ¡è®°å½•ï¼Œä½†æ˜¯è¿™ä¸¤æ¡è®°å½•å¯¹åº”çš„idå€¼éƒ½æ˜¯1ã€‚åœ¨è¿æ¥æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œæ¯ä¸ªè¡¨éƒ½ä¼šå¯¹åº”ä¸€æ¡è®°å½•ï¼Œè¿™äº›è®°å½•çš„idåˆ—çš„å€¼æ˜¯ç›¸åŒçš„ï¼Œå‡ºç°åœ¨å‰è¾¹çš„è¡¨è¡¨ç¤ºé©±åŠ¨è¡¨ï¼Œå‡ºç°åœ¨åè¾¹çš„è¡¨è¡¨ç¤ºè¢«é©±åŠ¨è¡¨ã€‚æ‰€ä»¥ä»ä¸Šè¾¹çš„EXPLAINè¾“å‡ºä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å‡†å¤‡è®©s1è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œè®©s2è¡¨ä½œä¸ºè¢«é©±åŠ¨è¡¨æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚ å¯¹äºåŒ…å«å­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥æ¥è¯´ï¼Œå°±å¯èƒ½æ¶‰åŠå¤šä¸ªSELECTå…³é”®å­—ï¼Œæ‰€ä»¥åœ¨åŒ…å«å­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œæ¯ä¸ªSELECTå…³é”®å­—éƒ½ä¼šå¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„idå€¼ï¼Œæ¯”å¦‚è¿™æ ·ï¼š ä»è¾“å‡ºç»“æœä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œs1è¡¨åœ¨å¤–å±‚æŸ¥è¯¢ä¸­ï¼Œå¤–å±‚æŸ¥è¯¢æœ‰ä¸€ä¸ªç‹¬ç«‹çš„SELECTå…³é”®å­—ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¡è®°å½•çš„idå€¼å°±æ˜¯1ï¼Œs2è¡¨åœ¨å­æŸ¥è¯¢ä¸­ï¼Œå­æŸ¥è¯¢æœ‰ä¸€ä¸ªç‹¬ç«‹çš„SELECTå…³é”®å­—ï¼Œæ‰€ä»¥ç¬¬äºŒæ¡è®°å½•çš„idå€¼å°±æ˜¯2ã€‚ æŸ¥è¯¢ä¼˜åŒ–å™¨å¯èƒ½å¯¹æ¶‰åŠå­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥è¿›è¡Œé‡å†™ï¼Œä»è€Œè½¬æ¢ä¸ºè¿æ¥æŸ¥è¯¢ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³çŸ¥é“æŸ¥è¯¢ä¼˜åŒ–å™¨å¯¹æŸä¸ªåŒ…å«å­æŸ¥è¯¢çš„è¯­å¥æ˜¯å¦è¿›è¡Œäº†é‡å†™ï¼Œç›´æ¥æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’å°±å¥½äº†ï¼Œæ¯”å¦‚è¯´ï¼š è™½ç„¶æˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥æ˜¯ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œä½†æ˜¯æ‰§è¡Œè®¡åˆ’ä¸­s1å’Œs2è¡¨å¯¹åº”çš„è®°å½•çš„idå€¼å…¨éƒ¨æ˜¯1ï¼Œè¿™å°±è¡¨æ˜äº†æŸ¥è¯¢ä¼˜åŒ–å™¨å°†å­æŸ¥è¯¢è½¬æ¢ä¸ºäº†è¿æ¥æŸ¥è¯¢ã€‚ å¯¹äºåŒ…å«UNIONå­å¥çš„æŸ¥è¯¢è¯­å¥æ¥è¯´ï¼Œæ¯ä¸ªSELECTå…³é”®å­—å¯¹åº”ä¸€ä¸ªidå€¼ä¹Ÿæ˜¯æ²¡é”™çš„ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰ç‚¹å„¿ç‰¹åˆ«ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š è¿™ä¸ªè¯­å¥çš„æ‰§è¡Œè®¡åˆ’çš„ç¬¬ä¸‰æ¡è®°å½•æ˜¯ä¸ªä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆidå€¼æ˜¯NULLï¼Œè€Œä¸”tableåä¹Ÿä¸å¤§å¯¹ï¼ŸUNIONå­å¥ä¼šæŠŠå¤šä¸ªæŸ¥è¯¢çš„ç»“æœé›†åˆå¹¶èµ·æ¥å¹¶å¯¹ç»“æœé›†ä¸­çš„è®°å½•è¿›è¡Œå»é‡ï¼Œæ€ä¹ˆå»é‡å‘¢ï¼ŸMySQLä½¿ç”¨çš„æ˜¯å†…éƒ¨çš„ä¸´æ—¶è¡¨ã€‚æ­£å¦‚ä¸Šè¾¹çš„æŸ¥è¯¢è®¡åˆ’ä¸­æ‰€ç¤ºï¼ŒUNIONå­å¥æ˜¯ä¸ºäº†æŠŠidä¸º1çš„æŸ¥è¯¢å’Œidä¸º2çš„æŸ¥è¯¢çš„ç»“æœé›†åˆå¹¶èµ·æ¥å¹¶å»é‡ï¼Œæ‰€ä»¥åœ¨å†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ªä¸´æ—¶è¡¨ï¼ˆå°±æ˜¯æ‰§è¡Œè®¡åˆ’ç¬¬ä¸‰æ¡è®°å½•çš„tableåˆ—çš„åç§°ï¼‰ï¼Œidä¸ºNULLè¡¨æ˜è¿™ä¸ªä¸´æ—¶è¡¨æ˜¯ä¸ºäº†åˆå¹¶ä¸¤ä¸ªæŸ¥è¯¢çš„ç»“æœé›†è€Œåˆ›å»ºçš„ã€‚ è·ŸUNIONå¯¹æ¯”èµ·æ¥ï¼ŒUNION ALLå°±ä¸éœ€è¦ä¸ºæœ€ç»ˆçš„ç»“æœé›†è¿›è¡Œå»é‡ï¼Œå®ƒåªæ˜¯å•çº¯çš„æŠŠå¤šä¸ªæŸ¥è¯¢çš„ç»“æœé›†ä¸­çš„è®°å½•åˆå¹¶æˆä¸€ä¸ªå¹¶è¿”å›ç»™ç”¨æˆ·ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸éœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨ã€‚æ‰€ä»¥åœ¨åŒ…å«UNION ALLå­å¥çš„æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œå°±æ²¡æœ‰é‚£ä¸ªidä¸ºNULLçš„è®°å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š select_typeé€šè¿‡ä¸Šè¾¹çš„å†…å®¹æˆ‘ä»¬çŸ¥é“ï¼Œä¸€æ¡å¤§çš„æŸ¥è¯¢è¯­å¥é‡Œè¾¹å¯ä»¥åŒ…å«è‹¥å¹²ä¸ªSELECTå…³é”®å­—ï¼Œæ¯ä¸ªSELECTå…³é”®å­—ä»£è¡¨ç€ä¸€ä¸ªå°çš„æŸ¥è¯¢è¯­å¥ï¼Œè€Œæ¯ä¸ªSELECTå…³é”®å­—çš„FROMå­å¥ä¸­éƒ½å¯ä»¥åŒ…å«è‹¥å¹²å¼ è¡¨ï¼ˆè¿™äº›è¡¨ç”¨æ¥åšè¿æ¥æŸ¥è¯¢ï¼‰ï¼Œæ¯ä¸€å¼ è¡¨éƒ½å¯¹åº”ç€æ‰§è¡Œè®¡åˆ’è¾“å‡ºä¸­çš„ä¸€æ¡è®°å½•ï¼Œå¯¹äºåœ¨åŒä¸€ä¸ªSELECTå…³é”®å­—ä¸­çš„è¡¨æ¥è¯´ï¼Œå®ƒä»¬çš„idå€¼æ˜¯ç›¸åŒçš„ã€‚ MySQLä¸ºæ¯ä¸€ä¸ªSELECTå…³é”®å­—ä»£è¡¨çš„å°æŸ¥è¯¢éƒ½å®šä¹‰äº†ä¸€ä¸ªç§°ä¹‹ä¸ºselect_typeçš„å±æ€§ï¼Œæ„æ€æ˜¯æˆ‘ä»¬åªè¦çŸ¥é“äº†æŸä¸ªå°æŸ¥è¯¢çš„select_typeå±æ€§ï¼Œå°±çŸ¥é“äº†è¿™ä¸ªå°æŸ¥è¯¢åœ¨æ•´ä¸ªå¤§æŸ¥è¯¢ä¸­æœ‰ä»€ä¹ˆä½œç”¨ã€‚ åç§° æè¿° SIMPLE Simple SELECT (not using UNION or subqueries) PRIMARY Outermost SELECT UNION Second or later SELECT statement in a UNION UNION RESULT Result of a UNION SUBQUERY First SELECT in subquery DEPENDENT SUBQUERY First SELECT in subquery, dependent on outer query DEPENDENT UNION Second or later SELECT statement in a UNION, dependent on outer query DERIVED Derived table MATERIALIZED Materialized subquery UNCACHEABLE SUBQUERY A subquery for which the result cannot be cached and must be re-evaluated for each row of the outer query UNCACHEABLE UNION The second or later select in a UNION that belongs to an uncacheable subquery (see UNCACHEABLE SUBQUERY) SIMPLEæŸ¥è¯¢è¯­å¥ä¸­ä¸åŒ…å«UNIONæˆ–è€…å­æŸ¥è¯¢çš„æŸ¥è¯¢éƒ½ç®—ä½œæ˜¯SIMPLEç±»å‹ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªå•è¡¨æŸ¥è¯¢çš„select_typeçš„å€¼å°±æ˜¯SIMPLEï¼šå½“ç„¶ï¼Œè¿æ¥æŸ¥è¯¢ä¹Ÿç®—æ˜¯SIMPLEç±»å‹ï¼Œæ¯”å¦‚ï¼š PRIMARYå¯¹äºåŒ…å«UNIONã€UNION ALLæˆ–è€…å­æŸ¥è¯¢çš„å¤§æŸ¥è¯¢æ¥è¯´ï¼Œå®ƒæ˜¯ç”±å‡ ä¸ªå°æŸ¥è¯¢ç»„æˆçš„ï¼Œå…¶ä¸­æœ€å·¦è¾¹çš„é‚£ä¸ªæŸ¥è¯¢çš„select_typeå€¼å°±æ˜¯PRIMARYï¼Œæ¯”æ–¹è¯´ï¼šä»ç»“æœä¸­å¯ä»¥çœ‹åˆ°ï¼Œæœ€å·¦è¾¹çš„å°æŸ¥è¯¢SELECT * FROM s1å¯¹åº”çš„æ˜¯æ‰§è¡Œè®¡åˆ’ä¸­çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œå®ƒçš„select_typeå€¼å°±æ˜¯PRIMARYã€‚ UNIONå¯¹äºåŒ…å«UNIONæˆ–è€…UNION ALLçš„å¤§æŸ¥è¯¢æ¥è¯´ï¼Œå®ƒæ˜¯ç”±å‡ ä¸ªå°æŸ¥è¯¢ç»„æˆçš„ï¼Œå…¶ä¸­é™¤äº†æœ€å·¦è¾¹çš„é‚£ä¸ªå°æŸ¥è¯¢ä»¥å¤–ï¼Œå…¶ä½™çš„å°æŸ¥è¯¢çš„select_typeå€¼å°±æ˜¯UNIONï¼Œå¯ä»¥å¯¹æ¯”ä¸Šä¸€ä¸ªä¾‹å­çš„æ•ˆæœï¼Œè¿™å°±ä¸å¤šä¸¾ä¾‹å­äº†ã€‚ UNION RESULTMySQLé€‰æ‹©ä½¿ç”¨ä¸´æ—¶è¡¨æ¥å®ŒæˆUNIONæŸ¥è¯¢çš„å»é‡å·¥ä½œï¼Œé’ˆå¯¹è¯¥ä¸´æ—¶è¡¨çš„æŸ¥è¯¢çš„select_typeå°±æ˜¯UNION RESULTï¼Œä¾‹å­ä¸Šè¾¹æœ‰ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚ SUBQUERYå¦‚æœåŒ…å«å­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥ä¸èƒ½å¤Ÿè½¬ä¸ºå¯¹åº”çš„semi-joinçš„å½¢å¼ï¼Œå¹¶ä¸”è¯¥å­æŸ¥è¯¢æ˜¯ä¸ç›¸å…³å­æŸ¥è¯¢ï¼Œå¹¶ä¸”æŸ¥è¯¢ä¼˜åŒ–å™¨å†³å®šé‡‡ç”¨å°†è¯¥å­æŸ¥è¯¢ç‰©åŒ–çš„æ–¹æ¡ˆæ¥æ‰§è¡Œè¯¥å­æŸ¥è¯¢æ—¶ï¼Œè¯¥å­æŸ¥è¯¢çš„ç¬¬ä¸€ä¸ªSELECTå…³é”®å­—ä»£è¡¨çš„é‚£ä¸ªæŸ¥è¯¢çš„select_typeå°±æ˜¯SUBQUERYï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼šå¯ä»¥çœ‹åˆ°ï¼Œå¤–å±‚æŸ¥è¯¢çš„select_typeå°±æ˜¯PRIMARYï¼Œå­æŸ¥è¯¢çš„select_typeå°±æ˜¯SUBQUERYã€‚ç”±äºselect_typeä¸ºSUBQUERYçš„å­æŸ¥è¯¢ä¼šè¢«ç‰©åŒ–ï¼Œæ‰€ä»¥åªéœ€è¦æ‰§è¡Œä¸€éã€‚ DEPENDENT SUBQUERYå¦‚æœåŒ…å«å­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥ä¸èƒ½å¤Ÿè½¬ä¸ºå¯¹åº”çš„semi-joinçš„å½¢å¼ï¼Œå¹¶ä¸”è¯¥å­æŸ¥è¯¢æ˜¯ç›¸å…³å­æŸ¥è¯¢ï¼Œåˆ™è¯¥å­æŸ¥è¯¢çš„ç¬¬ä¸€ä¸ªSELECTå…³é”®å­—ä»£è¡¨çš„é‚£ä¸ªæŸ¥è¯¢çš„select_typeå°±æ˜¯DEPENDENT SUBQUERYï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š select_typeä¸ºDEPENDENT SUBQUERYçš„æŸ¥è¯¢å¯èƒ½ä¼šè¢«æ‰§è¡Œå¤šæ¬¡ã€‚ DEPENDENT UNIONåœ¨åŒ…å«UNIONæˆ–è€…UNION ALLçš„å¤§æŸ¥è¯¢ä¸­ï¼Œå¦‚æœå„ä¸ªå°æŸ¥è¯¢éƒ½ä¾èµ–äºå¤–å±‚æŸ¥è¯¢çš„è¯ï¼Œé‚£é™¤äº†æœ€å·¦è¾¹çš„é‚£ä¸ªå°æŸ¥è¯¢ä¹‹å¤–ï¼Œå…¶ä½™çš„å°æŸ¥è¯¢çš„select_typeçš„å€¼å°±æ˜¯DEPENDENT UNIONã€‚è¯´çš„æœ‰äº›ç»•å“ˆï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼šè¿™ä¸ªæŸ¥è¯¢æ¯”è¾ƒå¤æ‚ï¼Œå¤§æŸ¥è¯¢é‡ŒåŒ…å«äº†ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œå­æŸ¥è¯¢é‡Œåˆæ˜¯ç”±UNIONè¿èµ·æ¥çš„ä¸¤ä¸ªå°æŸ¥è¯¢ã€‚ä»æ‰§è¡Œè®¡åˆ’ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼ŒSELECT key1 FROM s2 WHERE key1 = &#39;a&#39;è¿™ä¸ªå°æŸ¥è¯¢ç”±äºæ˜¯å­æŸ¥è¯¢ä¸­ç¬¬ä¸€ä¸ªæŸ¥è¯¢ï¼Œæ‰€ä»¥å®ƒçš„select_typeæ˜¯DEPENDENT SUBQUERYï¼Œè€ŒSELECT key1 FROM s1 WHERE key1 = &#39;b&#39;è¿™ä¸ªæŸ¥è¯¢çš„select_typeå°±æ˜¯DEPENDENT UNIONã€‚ DERIVEDå¯¹äºé‡‡ç”¨ç‰©åŒ–çš„æ–¹å¼æ‰§è¡Œçš„åŒ…å«æ´¾ç”Ÿè¡¨çš„æŸ¥è¯¢ï¼Œè¯¥æ´¾ç”Ÿè¡¨å¯¹åº”çš„å­æŸ¥è¯¢çš„select_typeå°±æ˜¯DERIVEDï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼šä»æ‰§è¡Œè®¡åˆ’ä¸­å¯ä»¥çœ‹å‡ºï¼Œidä¸º2çš„è®°å½•å°±ä»£è¡¨å­æŸ¥è¯¢çš„æ‰§è¡Œæ–¹å¼ï¼Œå®ƒçš„select_typeæ˜¯DERIVEDï¼Œè¯´æ˜è¯¥å­æŸ¥è¯¢æ˜¯ä»¥ç‰©åŒ–çš„æ–¹å¼æ‰§è¡Œçš„ã€‚idä¸º1çš„è®°å½•ä»£è¡¨å¤–å±‚æŸ¥è¯¢ï¼Œå®ƒçš„tableåˆ—æ˜¾ç¤ºçš„æ˜¯``ï¼Œè¡¨ç¤ºè¯¥æŸ¥è¯¢æ˜¯é’ˆå¯¹å°†æ´¾ç”Ÿè¡¨ç‰©åŒ–ä¹‹åçš„è¡¨è¿›è¡ŒæŸ¥è¯¢çš„ã€‚ å¦‚æœæ´¾ç”Ÿè¡¨å¯ä»¥é€šè¿‡å’Œå¤–å±‚æŸ¥è¯¢åˆå¹¶çš„æ–¹å¼æ‰§è¡Œçš„è¯ï¼Œæ‰§è¡Œè®¡åˆ’åˆæ˜¯å¦ä¸€ç•ªæ™¯è±¡ã€‚ MATERIALIZEDå½“æŸ¥è¯¢ä¼˜åŒ–å™¨åœ¨æ‰§è¡ŒåŒ…å«å­æŸ¥è¯¢çš„è¯­å¥æ—¶ï¼Œé€‰æ‹©å°†å­æŸ¥è¯¢ç‰©åŒ–ä¹‹åä¸å¤–å±‚æŸ¥è¯¢è¿›è¡Œè¿æ¥æŸ¥è¯¢æ—¶ï¼Œè¯¥å­æŸ¥è¯¢å¯¹åº”çš„select_typeå±æ€§å°±æ˜¯MATERIALIZEDï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼šæ‰§è¡Œè®¡åˆ’çš„ç¬¬ä¸‰æ¡è®°å½•çš„idå€¼ä¸º2ï¼Œè¯´æ˜è¯¥æ¡è®°å½•å¯¹åº”çš„æ˜¯ä¸€ä¸ªå•è¡¨æŸ¥è¯¢ï¼Œä»å®ƒçš„select_typeå€¼ä¸ºMATERIALIZEDå¯ä»¥çœ‹å‡ºï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨æ˜¯è¦æŠŠå­æŸ¥è¯¢å…ˆè½¬æ¢æˆç‰©åŒ–è¡¨ã€‚ç„¶åçœ‹æ‰§è¡Œè®¡åˆ’çš„å‰ä¸¤æ¡è®°å½•çš„idå€¼éƒ½ä¸º1ï¼Œè¯´æ˜è¿™ä¸¤æ¡è®°å½•å¯¹åº”çš„è¡¨è¿›è¡Œè¿æ¥æŸ¥è¯¢ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç¬¬äºŒæ¡è®°å½•çš„tableåˆ—çš„å€¼æ˜¯``ï¼Œè¯´æ˜è¯¥è¡¨å…¶å®å°±æ˜¯idä¸º2å¯¹åº”çš„å­æŸ¥è¯¢æ‰§è¡Œä¹‹åäº§ç”Ÿçš„ç‰©åŒ–è¡¨ï¼Œç„¶åå°†s1å’Œè¯¥ç‰©åŒ–è¡¨è¿›è¡Œè¿æ¥æŸ¥è¯¢ã€‚ UNCACHEABLE SUBQUERYä¸å¸¸ç”¨ UNCACHEABLE UNIONä¸å¸¸ç”¨ partitionsä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œè®¡åˆ’çš„partitionsåˆ—çš„å€¼éƒ½æ˜¯NULLã€‚ typeæ‰§è¡Œè®¡åˆ’çš„ä¸€æ¡è®°å½•å°±ä»£è¡¨ç€MySQLå¯¹æŸä¸ªè¡¨çš„æ‰§è¡ŒæŸ¥è¯¢æ—¶çš„è®¿é—®æ–¹æ³•ï¼Œå…¶ä¸­çš„typeåˆ—å°±è¡¨æ˜äº†è¿™ä¸ªè®¿é—®æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š å¯ä»¥çœ‹åˆ°typeåˆ—çš„å€¼æ˜¯refï¼Œè¡¨æ˜MySQLå³å°†ä½¿ç”¨refè®¿é—®æ–¹æ³•æ¥æ‰§è¡Œå¯¹s1è¡¨çš„æŸ¥è¯¢ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹‹å‰åªåˆ†æè¿‡å¯¹ä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“çš„è¡¨è¿›è¡Œå•è¡¨è®¿é—®çš„ä¸€äº›è®¿é—®æ–¹æ³•ï¼Œå®Œæ•´çš„è®¿é—®æ–¹æ³•å¦‚ä¸‹ï¼šsystemï¼Œconstï¼Œeq_refï¼Œrefï¼Œfulltextï¼Œref_or_nullï¼Œindex_mergeï¼Œunique_subqueryï¼Œindex_subqueryï¼Œrangeï¼Œindexï¼ŒALLã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†çœ‹ä¸€ä¸‹ï¼š systemå½“è¡¨ä¸­åªæœ‰ä¸€æ¡è®°å½•å¹¶ä¸”è¯¥è¡¨ä½¿ç”¨çš„å­˜å‚¨å¼•æ“çš„ç»Ÿè®¡æ•°æ®æ˜¯ç²¾ç¡®çš„ï¼Œæ¯”å¦‚MyISAMã€Memoryï¼Œé‚£ä¹ˆå¯¹è¯¥è¡¨çš„è®¿é—®æ–¹æ³•å°±æ˜¯systemã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æ–°å»ºä¸€ä¸ªMyISAMè¡¨ï¼Œå¹¶ä¸ºå…¶æ’å…¥ä¸€æ¡è®°å½•ï¼šç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹æŸ¥è¯¢è¿™ä¸ªè¡¨çš„æ‰§è¡Œè®¡åˆ’ï¼šå¯ä»¥çœ‹åˆ°typeåˆ—çš„å€¼å°±æ˜¯systemäº†ã€‚ 12345mysql&gt; CREATE TABLE t(i int) Engine=MyISAM;Query OK, 0 rows affected (0.05 sec)mysql&gt; INSERT INTO t VALUES(1);Query OK, 1 row affected (0.01 sec) æŠŠè¡¨æ”¹æˆä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“ï¼Œæ‰§è¡Œè®¡åˆ’çš„typeåˆ—æ˜¯ALLã€‚ constå½“æˆ‘ä»¬æ ¹æ®ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—ä¸å¸¸æ•°è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶ï¼Œå¯¹å•è¡¨çš„è®¿é—®æ–¹æ³•å°±æ˜¯constï¼Œæ¯”å¦‚ï¼š eq_refåœ¨è¿æ¥æŸ¥è¯¢æ—¶ï¼Œå¦‚æœè¢«é©±åŠ¨è¡¨æ˜¯é€šè¿‡ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—ç­‰å€¼åŒ¹é…çš„æ–¹å¼è¿›è¡Œè®¿é—®çš„ï¼ˆå¦‚æœè¯¥ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•æ˜¯è”åˆç´¢å¼•çš„è¯ï¼Œæ‰€æœ‰çš„ç´¢å¼•åˆ—éƒ½å¿…é¡»è¿›è¡Œç­‰å€¼æ¯”è¾ƒï¼‰ï¼Œåˆ™å¯¹è¯¥è¢«é©±åŠ¨è¡¨çš„è®¿é—®æ–¹æ³•å°±æ˜¯eq_refï¼Œæ¯”æ–¹è¯´ï¼šä»æ‰§è¡Œè®¡åˆ’çš„ç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼ŒMySQLæ‰“ç®—å°†s1ä½œä¸ºé©±åŠ¨è¡¨ï¼Œs2ä½œä¸ºè¢«é©±åŠ¨è¡¨ï¼Œé‡ç‚¹å…³æ³¨s2çš„è®¿é—®æ–¹æ³•æ˜¯eq_refï¼Œè¡¨æ˜åœ¨è®¿é—®s2è¡¨çš„æ—¶å€™å¯ä»¥é€šè¿‡ä¸»é”®çš„ç­‰å€¼åŒ¹é…æ¥è¿›è¡Œè®¿é—®ã€‚ refå½“é€šè¿‡æ™®é€šçš„äºŒçº§ç´¢å¼•åˆ—ä¸å¸¸é‡è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶æ¥æŸ¥è¯¢æŸä¸ªè¡¨ï¼Œé‚£ä¹ˆå¯¹è¯¥è¡¨çš„è®¿é—®æ–¹æ³•å°±å¯èƒ½æ˜¯refã€‚ fulltextå…¨æ–‡ç´¢å¼•,æ„ä¹‰ä¸å¤§ã€‚ ref_or_nullå½“å¯¹æ™®é€šäºŒçº§ç´¢å¼•è¿›è¡Œç­‰å€¼åŒ¹é…æŸ¥è¯¢ï¼Œè¯¥ç´¢å¼•åˆ—çš„å€¼ä¹Ÿå¯ä»¥æ˜¯NULLå€¼æ—¶ï¼Œé‚£ä¹ˆå¯¹è¯¥è¡¨çš„è®¿é—®æ–¹æ³•å°±å¯èƒ½æ˜¯ref_or_nullï¼Œæ¯”å¦‚è¯´ï¼š index_mergeåœ¨æŸäº›åœºæ™¯ä¸‹å¯ä»¥ä½¿ç”¨Intersectionã€Unionã€Sort-Unionè¿™ä¸‰ç§ç´¢å¼•åˆå¹¶çš„æ–¹å¼æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ‰§è¡Œè®¡åˆ’ä¸­æ˜¯æ€ä¹ˆä½“ç°MySQLä½¿ç”¨ç´¢å¼•åˆå¹¶çš„æ–¹å¼æ¥å¯¹æŸä¸ªè¡¨æ‰§è¡ŒæŸ¥è¯¢çš„ï¼šä»æ‰§è¡Œè®¡åˆ’çš„typeåˆ—çš„å€¼æ˜¯index_mergeå°±å¯ä»¥çœ‹å‡ºï¼ŒMySQLæ‰“ç®—ä½¿ç”¨ç´¢å¼•åˆå¹¶çš„æ–¹å¼æ¥æ‰§è¡Œå¯¹s1è¡¨çš„æŸ¥è¯¢ã€‚ unique_subqueryç±»ä¼¼äºä¸¤è¡¨è¿æ¥ä¸­è¢«é©±åŠ¨è¡¨çš„eq_refè®¿é—®æ–¹æ³•ï¼Œunique_subqueryæ˜¯é’ˆå¯¹åœ¨ä¸€äº›åŒ…å«INå­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥ä¸­ï¼Œå¦‚æœæŸ¥è¯¢ä¼˜åŒ–å™¨å†³å®šå°†INå­æŸ¥è¯¢è½¬æ¢ä¸ºEXISTSå­æŸ¥è¯¢ï¼Œè€Œä¸”å­æŸ¥è¯¢å¯ä»¥ä½¿ç”¨åˆ°ä¸»é”®è¿›è¡Œç­‰å€¼åŒ¹é…çš„è¯ï¼Œé‚£ä¹ˆè¯¥å­æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’çš„typeåˆ—çš„å€¼å°±æ˜¯unique_subqueryï¼Œæ¯”å¦‚ä¸‹è¾¹çš„è¿™ä¸ªæŸ¥è¯¢è¯­å¥ï¼šå¯ä»¥çœ‹åˆ°æ‰§è¡Œè®¡åˆ’çš„ç¬¬äºŒæ¡è®°å½•çš„typeå€¼å°±æ˜¯unique_subqueryï¼Œè¯´æ˜åœ¨æ‰§è¡Œå­æŸ¥è¯¢æ—¶ä¼šä½¿ç”¨åˆ°idåˆ—çš„ç´¢å¼•ã€‚ index_subqueryindex_subqueryä¸unique_subqueryç±»ä¼¼ï¼Œåªä¸è¿‡è®¿é—®å­æŸ¥è¯¢ä¸­çš„è¡¨æ—¶ä½¿ç”¨çš„æ˜¯æ™®é€šçš„ç´¢å¼•ï¼Œæ¯”å¦‚è¿™æ ·ï¼š rangeå¦‚æœä½¿ç”¨ç´¢å¼•è·å–æŸäº›èŒƒå›´åŒºé—´çš„è®°å½•ï¼Œé‚£ä¹ˆå°±å¯èƒ½ä½¿ç”¨åˆ°rangeè®¿é—®æ–¹æ³•ï¼Œæ¯”å¦‚ä¸‹è¾¹çš„è¿™ä¸ªæŸ¥è¯¢ï¼šæˆ–è€…ï¼š indexå½“æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç´¢å¼•è¦†ç›–ï¼Œä½†éœ€è¦æ‰«æå…¨éƒ¨çš„ç´¢å¼•è®°å½•æ—¶ï¼Œè¯¥è¡¨çš„è®¿é—®æ–¹æ³•å°±æ˜¯indexï¼Œæ¯”å¦‚è¿™æ ·ï¼šä¸Šè¿°æŸ¥è¯¢ä¸­çš„æœç´¢åˆ—è¡¨ä¸­åªæœ‰key_part2ä¸€ä¸ªåˆ—ï¼Œè€Œä¸”æœç´¢æ¡ä»¶ä¸­ä¹Ÿåªæœ‰key_part3ä¸€ä¸ªåˆ—ï¼Œè¿™ä¸¤ä¸ªåˆ—åˆæ°å¥½åŒ…å«åœ¨idx_key_partè¿™ä¸ªç´¢å¼•ä¸­ï¼Œå¯æ˜¯æœç´¢æ¡ä»¶key_part3ä¸èƒ½ç›´æ¥ä½¿ç”¨è¯¥ç´¢å¼•è¿›è¡Œrefæˆ–è€…rangeæ–¹å¼çš„è®¿é—®ï¼Œåªèƒ½æ‰«ææ•´ä¸ªidx_key_partç´¢å¼•çš„è®°å½•ï¼Œæ‰€ä»¥æŸ¥è¯¢è®¡åˆ’çš„typeåˆ—çš„å€¼å°±æ˜¯indexã€‚ å¯¹äºä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼ŒäºŒçº§ç´¢å¼•çš„è®°å½•åªåŒ…å«ç´¢å¼•åˆ—å’Œä¸»é”®åˆ—çš„å€¼ï¼Œè€Œèšç°‡ç´¢å¼•ä¸­åŒ…å«ç”¨æˆ·å®šä¹‰çš„å…¨éƒ¨åˆ—ä»¥åŠä¸€äº›éšè—åˆ—ï¼Œæ‰€ä»¥æ‰«æäºŒçº§ç´¢å¼•çš„ä»£ä»·æ¯”ç›´æ¥å…¨è¡¨æ‰«æï¼Œä¹Ÿå°±æ˜¯æ‰«æèšç°‡ç´¢å¼•çš„ä»£ä»·æ›´ä½ä¸€äº›ã€‚ ALLæœ€ç†Ÿæ‚‰çš„å…¨è¡¨æ‰«æç›´æ¥çœ‹ä¾‹å­ï¼š ä¸€èˆ¬æ¥è¯´ï¼Œè¿™äº›è®¿é—®æ–¹æ³•æŒ‰ç…§æˆ‘ä»¬ä»‹ç»å®ƒä»¬çš„é¡ºåºæ€§èƒ½ä¾æ¬¡å˜å·®ã€‚å…¶ä¸­é™¤äº†Allè¿™ä¸ªè®¿é—®æ–¹æ³•å¤–ï¼Œå…¶ä½™çš„è®¿é—®æ–¹æ³•éƒ½èƒ½ç”¨åˆ°ç´¢å¼•ï¼Œé™¤äº†index_mergeè®¿é—®æ–¹æ³•å¤–ï¼Œå…¶ä½™çš„è®¿é—®æ–¹æ³•éƒ½æœ€å¤šåªèƒ½ç”¨åˆ°ä¸€ä¸ªç´¢å¼•ã€‚ possible_keyså’Œkeyåœ¨EXPLAINè¯­å¥è¾“å‡ºçš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œpossible_keysåˆ—è¡¨ç¤ºåœ¨æŸä¸ªæŸ¥è¯¢è¯­å¥ä¸­ï¼Œå¯¹æŸä¸ªè¡¨æ‰§è¡Œå•è¡¨æŸ¥è¯¢æ—¶å¯èƒ½ç”¨åˆ°çš„ç´¢å¼•æœ‰å“ªäº›ï¼Œkeyåˆ—è¡¨ç¤ºå®é™…ç”¨åˆ°çš„ç´¢å¼•æœ‰å“ªäº›ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š ä¸Šè¿°æ‰§è¡Œè®¡åˆ’çš„possible_keysåˆ—çš„å€¼æ˜¯idx_key1,idx_key3ï¼Œè¡¨ç¤ºè¯¥æŸ¥è¯¢å¯èƒ½ä½¿ç”¨åˆ°idx_key1,idx_key3ä¸¤ä¸ªç´¢å¼•ï¼Œç„¶åkeyåˆ—çš„å€¼æ˜¯idx_key3ï¼Œè¡¨ç¤ºç»è¿‡æŸ¥è¯¢ä¼˜åŒ–å™¨è®¡ç®—ä½¿ç”¨ä¸åŒç´¢å¼•çš„æˆæœ¬åï¼Œæœ€åå†³å®šä½¿ç”¨idx_key3æ¥æ‰§è¡ŒæŸ¥è¯¢æ¯”è¾ƒåˆ’ç®—ã€‚ ä¸è¿‡æœ‰ä¸€ç‚¹æ¯”è¾ƒç‰¹åˆ«ï¼Œå°±æ˜¯åœ¨ä½¿ç”¨indexè®¿é—®æ–¹æ³•æ¥æŸ¥è¯¢æŸä¸ªè¡¨æ—¶ï¼Œpossible_keysåˆ—æ˜¯ç©ºçš„ï¼Œè€Œkeyåˆ—å±•ç¤ºçš„æ˜¯å®é™…ä½¿ç”¨åˆ°çš„ç´¢å¼•ï¼Œæ¯”å¦‚è¿™æ ·ï¼š å¦å¤–éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œpossible_keysåˆ—ä¸­çš„å€¼å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œå¯èƒ½ä½¿ç”¨çš„ç´¢å¼•è¶Šå¤šï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨è®¡ç®—æŸ¥è¯¢æˆæœ¬æ—¶å°±å¾—èŠ±è´¹æ›´é•¿æ—¶é—´ï¼Œæ‰€ä»¥å¦‚æœå¯ä»¥çš„è¯ï¼Œå°½é‡åˆ é™¤é‚£äº›ç”¨ä¸åˆ°çš„ç´¢å¼•ã€‚ key_lenkey_lenåˆ—è¡¨ç¤ºå½“ä¼˜åŒ–å™¨å†³å®šä½¿ç”¨æŸä¸ªç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œè¯¥ç´¢å¼•è®°å½•çš„æœ€å¤§é•¿åº¦ï¼Œå®ƒæ˜¯ç”±è¿™ä¸‰ä¸ªéƒ¨åˆ†æ„æˆçš„ï¼š å¯¹äºä½¿ç”¨å›ºå®šé•¿åº¦ç±»å‹çš„ç´¢å¼•åˆ—æ¥è¯´ï¼Œå®ƒå®é™…å ç”¨çš„å­˜å‚¨ç©ºé—´çš„æœ€å¤§é•¿åº¦å°±æ˜¯è¯¥å›ºå®šå€¼ï¼Œå¯¹äºæŒ‡å®šå­—ç¬¦é›†çš„å˜é•¿ç±»å‹çš„ç´¢å¼•åˆ—æ¥è¯´ï¼Œæ¯”å¦‚æŸä¸ªç´¢å¼•åˆ—çš„ç±»å‹æ˜¯VARCHAR(100)ï¼Œä½¿ç”¨çš„å­—ç¬¦é›†æ˜¯utf8ï¼Œé‚£ä¹ˆè¯¥åˆ—å®é™…å ç”¨çš„æœ€å¤§å­˜å‚¨ç©ºé—´å°±æ˜¯100 Ã— 3 = 300ä¸ªå­—èŠ‚ã€‚ å¦‚æœè¯¥ç´¢å¼•åˆ—å¯ä»¥å­˜å‚¨NULLå€¼ï¼Œåˆ™key_lenæ¯”ä¸å¯ä»¥å­˜å‚¨NULLå€¼æ—¶å¤š1ä¸ªå­—èŠ‚ã€‚ å¯¹äºå˜é•¿å­—æ®µæ¥è¯´ï¼Œéƒ½ä¼šæœ‰2ä¸ªå­—èŠ‚çš„ç©ºé—´æ¥å­˜å‚¨è¯¥å˜é•¿åˆ—çš„å®é™…é•¿åº¦ã€‚ æ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š ç”±äºidåˆ—çš„ç±»å‹æ˜¯INTï¼Œå¹¶ä¸”ä¸å¯ä»¥å­˜å‚¨NULLå€¼ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨è¯¥åˆ—çš„ç´¢å¼•æ—¶key_lenå¤§å°å°±æ˜¯4ã€‚å½“ç´¢å¼•åˆ—å¯ä»¥å­˜å‚¨NULLå€¼æ—¶ï¼Œæ¯”å¦‚ï¼š å¯ä»¥çœ‹åˆ°key_lenåˆ—å°±å˜æˆäº†5ï¼Œæ¯”ä½¿ç”¨idåˆ—çš„ç´¢å¼•æ—¶å¤šäº†1ã€‚ å¯¹äºå¯å˜é•¿åº¦çš„ç´¢å¼•åˆ—æ¥è¯´ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š ç”±äºkey1åˆ—çš„ç±»å‹æ˜¯VARCHAR(100)ï¼Œæ‰€ä»¥è¯¥åˆ—å®é™…æœ€å¤šå ç”¨çš„å­˜å‚¨ç©ºé—´å°±æ˜¯300å­—èŠ‚ï¼Œåˆå› ä¸ºè¯¥åˆ—å…è®¸å­˜å‚¨NULLå€¼ï¼Œæ‰€ä»¥key_lenéœ€è¦åŠ 1ï¼Œåˆå› ä¸ºè¯¥åˆ—æ˜¯å¯å˜é•¿åº¦åˆ—ï¼Œæ‰€ä»¥key_lenéœ€è¦åŠ 2ï¼Œæ‰€ä»¥æœ€åken_lençš„å€¼å°±æ˜¯303ã€‚ è¿™é‡Œéœ€è¦å¼ºè°ƒçš„ä¸€ç‚¹æ˜¯ï¼Œæ‰§è¡Œè®¡åˆ’çš„ç”Ÿæˆæ˜¯åœ¨MySQL serverå±‚ä¸­çš„åŠŸèƒ½ï¼Œå¹¶ä¸æ˜¯é’ˆå¯¹å…·ä½“æŸä¸ªå­˜å‚¨å¼•æ“çš„åŠŸèƒ½ï¼ŒMySQLåœ¨æ‰§è¡Œè®¡åˆ’ä¸­è¾“å‡ºkey_lenåˆ—ä¸»è¦æ˜¯ä¸ºäº†è®©æˆ‘ä»¬åŒºåˆ†æŸä¸ªä½¿ç”¨è”åˆç´¢å¼•çš„æŸ¥è¯¢å…·ä½“ç”¨äº†å‡ ä¸ªç´¢å¼•åˆ—ï¼Œè€Œä¸æ˜¯ä¸ºäº†å‡†ç¡®çš„è¯´æ˜é’ˆå¯¹æŸä¸ªå…·ä½“å­˜å‚¨å¼•æ“å­˜å‚¨å˜é•¿å­—æ®µçš„å®é™…é•¿åº¦å ç”¨çš„ç©ºé—´åˆ°åº•æ˜¯å ç”¨1ä¸ªå­—èŠ‚è¿˜æ˜¯2ä¸ªå­—èŠ‚ã€‚æ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªä½¿ç”¨åˆ°è”åˆç´¢å¼•idx_key_partçš„æŸ¥è¯¢ï¼š æˆ‘ä»¬å¯ä»¥ä»æ‰§è¡Œè®¡åˆ’çš„key_lenåˆ—ä¸­çœ‹åˆ°å€¼æ˜¯303ï¼Œè¿™æ„å‘³ç€MySQLåœ¨æ‰§è¡Œä¸Šè¿°æŸ¥è¯¢ä¸­åªèƒ½ç”¨åˆ°idx_key_partç´¢å¼•çš„ä¸€ä¸ªç´¢å¼•åˆ—ï¼Œè€Œä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š è¿™ä¸ªæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’çš„ken_lenåˆ—çš„å€¼æ˜¯606ï¼Œè¯´æ˜æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢çš„æ—¶å€™å¯ä»¥ç”¨åˆ°è”åˆç´¢å¼•idx_key_partçš„ä¸¤ä¸ªç´¢å¼•åˆ—ã€‚ refå½“ä½¿ç”¨ç´¢å¼•åˆ—ç­‰å€¼åŒ¹é…çš„æ¡ä»¶å»æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œä¹Ÿå°±æ˜¯åœ¨è®¿é—®æ–¹æ³•æ˜¯constã€eq_refã€refã€ref_or_nullã€unique_subqueryã€index_subqueryå…¶ä¸­ä¹‹ä¸€æ—¶ï¼Œrefåˆ—å±•ç¤ºçš„å°±æ˜¯ä¸ç´¢å¼•åˆ—ä½œç­‰å€¼åŒ¹é…çš„ä¸œä¸œæ˜¯ä¸ªå•¥ï¼Œæ¯”å¦‚åªæ˜¯ä¸€ä¸ªå¸¸æ•°æˆ–è€…æ˜¯æŸä¸ªåˆ—ã€‚ å¯ä»¥çœ‹åˆ°refåˆ—çš„å€¼æ˜¯constï¼Œè¡¨æ˜åœ¨ä½¿ç”¨idx_key1ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œä¸key1åˆ—ä½œç­‰å€¼åŒ¹é…çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼Œå½“ç„¶æœ‰æ—¶å€™æ›´å¤æ‚ä¸€ç‚¹ï¼š å¯ä»¥çœ‹åˆ°å¯¹è¢«é©±åŠ¨è¡¨s2çš„è®¿é—®æ–¹æ³•æ˜¯eq_refï¼Œè€Œå¯¹åº”çš„refåˆ—çš„å€¼æ˜¯yhd.s1.idï¼Œè¿™è¯´æ˜åœ¨å¯¹è¢«é©±åŠ¨è¡¨è¿›è¡Œè®¿é—®æ—¶ä¼šç”¨åˆ°PRIMARYç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯èšç°‡ç´¢å¼•ä¸ä¸€ä¸ªåˆ—è¿›è¡Œç­‰å€¼åŒ¹é…çš„æ¡ä»¶ï¼Œäºs2è¡¨çš„idä½œç­‰å€¼åŒ¹é…çš„å¯¹è±¡å°±æ˜¯yhd.s1.idåˆ—ï¼ˆæ³¨æ„è¿™é‡ŒæŠŠæ•°æ®åº“åä¹Ÿå†™å‡ºæ¥äº†ï¼‰ã€‚ æœ‰çš„æ—¶å€™ä¸ç´¢å¼•åˆ—è¿›è¡Œç­‰å€¼åŒ¹é…çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š æˆ‘ä»¬çœ‹æ‰§è¡Œè®¡åˆ’çš„ç¬¬äºŒæ¡è®°å½•ï¼Œå¯ä»¥çœ‹åˆ°å¯¹s2è¡¨é‡‡ç”¨refè®¿é—®æ–¹æ³•æ‰§è¡ŒæŸ¥è¯¢ï¼Œç„¶ååœ¨æŸ¥è¯¢è®¡åˆ’çš„refåˆ—é‡Œè¾“å‡ºçš„æ˜¯funcï¼Œè¯´æ˜ä¸s2è¡¨çš„key1åˆ—è¿›è¡Œç­‰å€¼åŒ¹é…çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚ rowså¦‚æœæŸ¥è¯¢ä¼˜åŒ–å™¨å†³å®šä½¿ç”¨å…¨è¡¨æ‰«æçš„æ–¹å¼å¯¹æŸä¸ªè¡¨æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œæ‰§è¡Œè®¡åˆ’çš„rowsåˆ—å°±ä»£è¡¨é¢„è®¡éœ€è¦æ‰«æçš„è¡Œæ•°ï¼Œå¦‚æœä½¿ç”¨ç´¢å¼•æ¥æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œæ‰§è¡Œè®¡åˆ’çš„rowsåˆ—å°±ä»£è¡¨é¢„è®¡æ‰«æçš„ç´¢å¼•è®°å½•è¡Œæ•°ã€‚æ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š æˆ‘ä»¬çœ‹åˆ°æ‰§è¡Œè®¡åˆ’çš„rowsåˆ—çš„å€¼æ˜¯1ï¼Œè¿™æ„å‘³ç€æŸ¥è¯¢ä¼˜åŒ–å™¨åœ¨ç»è¿‡åˆ†æä½¿ç”¨idx_key1è¿›è¡ŒæŸ¥è¯¢çš„æˆæœ¬ä¹‹åï¼Œè§‰å¾—æ»¡è¶³key1 &gt; &#39;z&#39;è¿™ä¸ªæ¡ä»¶çš„è®°å½•åªæœ‰1æ¡ã€‚ filteredä¹‹å‰åœ¨åˆ†æè¿æ¥æŸ¥è¯¢çš„æˆæœ¬æ—¶æå‡ºè¿‡ä¸€ä¸ªcondition filteringçš„æ¦‚å¿µï¼Œå°±æ˜¯MySQLåœ¨è®¡ç®—é©±åŠ¨è¡¨æ‰‡å‡ºæ—¶é‡‡ç”¨çš„ä¸€ä¸ªç­–ç•¥ï¼š å¦‚æœä½¿ç”¨çš„æ˜¯å…¨è¡¨æ‰«æçš„æ–¹å¼æ‰§è¡Œçš„å•è¡¨æŸ¥è¯¢ï¼Œé‚£ä¹ˆè®¡ç®—é©±åŠ¨è¡¨æ‰‡å‡ºæ—¶éœ€è¦ä¼°è®¡å‡ºæ»¡è¶³æœç´¢æ¡ä»¶çš„è®°å½•åˆ°åº•æœ‰å¤šå°‘æ¡ã€‚ å¦‚æœä½¿ç”¨çš„æ˜¯ç´¢å¼•æ‰§è¡Œçš„å•è¡¨æ‰«æï¼Œé‚£ä¹ˆè®¡ç®—é©±åŠ¨è¡¨æ‰‡å‡ºçš„æ—¶å€™éœ€è¦ä¼°è®¡å‡ºæ»¡è¶³é™¤ä½¿ç”¨åˆ°å¯¹åº”ç´¢å¼•çš„æœç´¢æ¡ä»¶å¤–çš„å…¶ä»–æœç´¢æ¡ä»¶çš„è®°å½•æœ‰å¤šå°‘æ¡ã€‚ æ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š ä»æ‰§è¡Œè®¡åˆ’çš„keyåˆ—ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¯¥æŸ¥è¯¢ä½¿ç”¨idx_key1ç´¢å¼•æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼Œä»rowsåˆ—å¯ä»¥çœ‹å‡ºæ»¡è¶³key1 &gt; &#39;z&#39;çš„è®°å½•æœ‰1æ¡ã€‚æ‰§è¡Œè®¡åˆ’çš„filteredåˆ—å°±ä»£è¡¨æŸ¥è¯¢ä¼˜åŒ–å™¨é¢„æµ‹åœ¨è¿™1æ¡è®°å½•ä¸­ï¼Œæœ‰å¤šå°‘æ¡è®°å½•æ»¡è¶³å…¶ä½™çš„æœç´¢æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯common_field = &#39;a&#39;è¿™ä¸ªæ¡ä»¶çš„ç™¾åˆ†æ¯”ã€‚æ­¤å¤„filteredåˆ—çš„å€¼æ˜¯10.00ï¼Œè¯´æ˜æŸ¥è¯¢ä¼˜åŒ–å™¨é¢„æµ‹åœ¨1æ¡è®°å½•ä¸­æœ‰10.00%çš„è®°å½•æ»¡è¶³common_field = &#39;a&#39;è¿™ä¸ªæ¡ä»¶ã€‚ å¯¹äºå•è¡¨æŸ¥è¯¢æ¥è¯´ï¼Œè¿™ä¸ªfilteredåˆ—çš„å€¼æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œæˆ‘ä»¬æ›´å…³æ³¨åœ¨è¿æ¥æŸ¥è¯¢ä¸­é©±åŠ¨è¡¨å¯¹åº”çš„æ‰§è¡Œè®¡åˆ’è®°å½•çš„filteredå€¼ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š ä»æ‰§è¡Œè®¡åˆ’ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨æ‰“ç®—æŠŠs1å½“ä½œé©±åŠ¨è¡¨ï¼Œs2å½“ä½œè¢«é©±åŠ¨è¡¨ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é©±åŠ¨è¡¨s1è¡¨çš„æ‰§è¡Œè®¡åˆ’çš„rowsåˆ—ä¸º997219ï¼Œ filteredåˆ—ä¸º10.00ï¼Œè¿™æ„å‘³ç€é©±åŠ¨è¡¨s1çš„æ‰‡å‡ºå€¼å°±æ˜¯997219 Ã— 10.00% = 99721.9ï¼Œè¿™è¯´æ˜è¿˜è¦å¯¹è¢«é©±åŠ¨è¡¨æ‰§è¡Œå¤§çº¦99721.9æ¬¡æŸ¥è¯¢ã€‚ Extraé¡¾åæ€ä¹‰ï¼ŒExtraåˆ—æ˜¯ç”¨æ¥è¯´æ˜ä¸€äº›é¢å¤–ä¿¡æ¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›é¢å¤–ä¿¡æ¯æ¥æ›´å‡†ç¡®çš„ç†è§£MySQLåˆ°åº•å°†å¦‚ä½•æ‰§è¡Œç»™å®šçš„æŸ¥è¯¢è¯­å¥ã€‚ No tables usedå½“æŸ¥è¯¢è¯­å¥çš„æ²¡æœ‰FROMå­å¥æ—¶å°†ä¼šæç¤ºè¯¥é¢å¤–ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š Impossible WHEREæŸ¥è¯¢è¯­å¥çš„WHEREå­å¥æ°¸è¿œä¸ºFALSEæ—¶å°†ä¼šæç¤ºè¯¥é¢å¤–ä¿¡æ¯ï¼Œæ¯”æ–¹è¯´ï¼š No matching min/max rowå½“æŸ¥è¯¢åˆ—è¡¨å¤„æœ‰MINæˆ–è€…MAXèšé›†å‡½æ•°ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç¬¦åˆWHEREå­å¥ä¸­çš„æœç´¢æ¡ä»¶çš„è®°å½•æ—¶ï¼Œå°†ä¼šæç¤ºè¯¥é¢å¤–ä¿¡æ¯ï¼Œæ¯”æ–¹è¯´ï¼š Using indexå½“æˆ‘ä»¬çš„æŸ¥è¯¢åˆ—è¡¨ä»¥åŠæœç´¢æ¡ä»¶ä¸­åªåŒ…å«å±äºæŸä¸ªç´¢å¼•çš„åˆ—ï¼Œä¹Ÿå°±æ˜¯åœ¨å¯ä»¥ä½¿ç”¨ç´¢å¼•è¦†ç›–çš„æƒ…å†µä¸‹ï¼Œåœ¨Extraåˆ—å°†ä¼šæç¤ºè¯¥é¢å¤–ä¿¡æ¯ã€‚æ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ä¸­åªéœ€è¦ç”¨åˆ°idx_key1è€Œä¸éœ€è¦å›è¡¨æ“ä½œï¼š Using index conditionæœ‰äº›æœç´¢æ¡ä»¶ä¸­è™½ç„¶å‡ºç°äº†ç´¢å¼•åˆ—ï¼Œä½†å´ä¸èƒ½ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼šå…¶ä¸­çš„key1 &gt; &#39;z&#39;å¯ä»¥ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œä½†æ˜¯key1 LIKE &#39;%a&#39;å´æ— æ³•ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œåœ¨ä»¥å‰ç‰ˆæœ¬çš„MySQLä¸­ï¼Œæ˜¯æŒ‰ç…§ä¸‹è¾¹æ­¥éª¤æ¥æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢çš„ï¼š 1SELECT * FROM s1 WHERE key1 &gt; &#x27;z&#x27; AND key1 LIKE &#x27;%a&#x27;; å…ˆæ ¹æ®key1 &gt; &#39;z&#39;è¿™ä¸ªæ¡ä»¶ï¼Œä»äºŒçº§ç´¢å¼•idx_key1ä¸­è·å–åˆ°å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•ã€‚ æ ¹æ®ä¸Šä¸€æ­¥éª¤å¾—åˆ°çš„äºŒçº§ç´¢å¼•è®°å½•ä¸­çš„ä¸»é”®å€¼è¿›è¡Œå›è¡¨ï¼Œæ‰¾åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•å†æ£€æµ‹è¯¥è®°å½•æ˜¯å¦ç¬¦åˆkey1 LIKE &#39;%a&#39;è¿™ä¸ªæ¡ä»¶ï¼Œå°†ç¬¦åˆæ¡ä»¶çš„è®°å½•åŠ å…¥åˆ°æœ€åçš„ç»“æœé›†ã€‚ ä½†æ˜¯è™½ç„¶key1 LIKE &#39;%a&#39;ä¸èƒ½ç»„æˆèŒƒå›´åŒºé—´å‚ä¸rangeè®¿é—®æ–¹æ³•çš„æ‰§è¡Œï¼Œä½†è¿™ä¸ªæ¡ä»¶æ¯•ç«Ÿåªæ¶‰åŠåˆ°äº†key1åˆ—ï¼Œæ‰€ä»¥MySQLæŠŠä¸Šè¾¹çš„æ­¥éª¤æ”¹è¿›äº†ä¸€ä¸‹ï¼š å…ˆæ ¹æ®key1 &gt; &#39;z&#39;è¿™ä¸ªæ¡ä»¶ï¼Œå®šä½åˆ°äºŒçº§ç´¢å¼•idx_key1ä¸­å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•ã€‚ å¯¹äºæŒ‡å®šçš„äºŒçº§ç´¢å¼•è®°å½•ï¼Œå…ˆä¸ç€æ€¥å›è¡¨ï¼Œè€Œæ˜¯å…ˆæ£€æµ‹ä¸€ä¸‹è¯¥è®°å½•æ˜¯å¦æ»¡è¶³key1 LIKE &#39;%a&#39;è¿™ä¸ªæ¡ä»¶ï¼Œå¦‚æœè¿™ä¸ªæ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™è¯¥äºŒçº§ç´¢å¼•è®°å½•å‹æ ¹å„¿å°±æ²¡å¿…è¦å›è¡¨ã€‚ å¯¹äºæ»¡è¶³key1 LIKE &#39;%a&#39;è¿™ä¸ªæ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•æ‰§è¡Œå›è¡¨æ“ä½œã€‚ æˆ‘ä»¬è¯´å›è¡¨æ“ä½œå…¶å®æ˜¯ä¸€ä¸ªéšæœºIOï¼Œæ¯”è¾ƒè€—æ—¶ï¼Œæ‰€ä»¥ä¸Šè¿°ä¿®æ”¹è™½ç„¶åªæ”¹è¿›äº†ä¸€ç‚¹ç‚¹ï¼Œä½†æ˜¯å¯ä»¥çœå»å¥½å¤šå›è¡¨æ“ä½œçš„æˆæœ¬ã€‚MySQLæŠŠä»–ä»¬çš„è¿™ä¸ªæ”¹è¿›ç§°ä¹‹ä¸ºç´¢å¼•æ¡ä»¶ä¸‹æ¨ï¼ˆè‹±æ–‡åï¼šIndex Condition Pushdownï¼‰ã€‚å¦‚æœåœ¨æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹ä¸­å°†è¦ä½¿ç”¨ç´¢å¼•æ¡ä»¶ä¸‹æ¨è¿™ä¸ªç‰¹æ€§ï¼Œåœ¨Extraåˆ—ä¸­å°†ä¼šæ˜¾ç¤ºUsing index conditionï¼Œæ¯”å¦‚è¿™æ ·ï¼š Using whereå½“æˆ‘ä»¬ä½¿ç”¨å…¨è¡¨æ‰«ææ¥æ‰§è¡Œå¯¹æŸä¸ªè¡¨çš„æŸ¥è¯¢ï¼Œå¹¶ä¸”è¯¥è¯­å¥çš„WHEREå­å¥ä¸­æœ‰é’ˆå¯¹è¯¥è¡¨çš„æœç´¢æ¡ä»¶æ—¶ï¼Œåœ¨Extraåˆ—ä¸­ä¼šæç¤ºä¸Šè¿°é¢å¤–ä¿¡æ¯ã€‚æ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼šå½“ä½¿ç”¨ç´¢å¼•è®¿é—®æ¥æ‰§è¡Œå¯¹æŸä¸ªè¡¨çš„æŸ¥è¯¢ï¼Œå¹¶ä¸”è¯¥è¯­å¥çš„WHEREå­å¥ä¸­æœ‰é™¤äº†è¯¥ç´¢å¼•åŒ…å«çš„åˆ—ä¹‹å¤–çš„å…¶ä»–æœç´¢æ¡ä»¶æ—¶ï¼Œåœ¨Extraåˆ—ä¸­ä¹Ÿä¼šæç¤ºä¸Šè¿°é¢å¤–ä¿¡æ¯ã€‚æ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢è™½ç„¶ä½¿ç”¨idx_key1ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢ï¼Œä½†æ˜¯æœç´¢æ¡ä»¶ä¸­é™¤äº†åŒ…å«key1çš„æœç´¢æ¡ä»¶key1 = &#39;a&#39;ï¼Œè¿˜æœ‰åŒ…å«common_fieldçš„æœç´¢æ¡ä»¶ï¼Œæ‰€ä»¥Extraåˆ—ä¼šæ˜¾ç¤ºUsing whereçš„æç¤ºï¼š Using join buffer (Block Nested Loop)åœ¨è¿æ¥æŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå½“è¢«é©±åŠ¨è¡¨ä¸èƒ½æœ‰æ•ˆçš„åˆ©ç”¨ç´¢å¼•åŠ å¿«è®¿é—®é€Ÿåº¦ï¼ŒMySQLä¸€èˆ¬ä¼šä¸ºå…¶åˆ†é…ä¸€å—åå«join bufferçš„å†…å­˜å—æ¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è®²çš„åŸºäºå—çš„åµŒå¥—å¾ªç¯ç®—æ³•ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢è¯­å¥ï¼šå¯ä»¥åœ¨å¯¹s2è¡¨çš„æ‰§è¡Œè®¡åˆ’çš„Extraåˆ—æ˜¾ç¤ºäº†ä¸¤ä¸ªæç¤ºï¼š Using join buffer (Block Nested Loop)ï¼šè¿™æ˜¯å› ä¸ºå¯¹è¡¨s2çš„è®¿é—®ä¸èƒ½æœ‰æ•ˆåˆ©ç”¨ç´¢å¼•ï¼Œåªå¥½é€€è€Œæ±‚å…¶æ¬¡ï¼Œä½¿ç”¨join bufferæ¥å‡å°‘å¯¹s2è¡¨çš„è®¿é—®æ¬¡æ•°ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚ Using whereï¼šå¯ä»¥çœ‹åˆ°æŸ¥è¯¢è¯­å¥ä¸­æœ‰ä¸€ä¸ªs1.common_field = s2.common_fieldæ¡ä»¶ï¼Œå› ä¸ºs1æ˜¯é©±åŠ¨è¡¨ï¼Œs2æ˜¯è¢«é©±åŠ¨è¡¨ï¼Œæ‰€ä»¥åœ¨è®¿é—®s2è¡¨æ—¶ï¼Œs1.common_fieldçš„å€¼å·²ç»ç¡®å®šä¸‹æ¥äº†ï¼Œæ‰€ä»¥å®é™…ä¸ŠæŸ¥è¯¢s2è¡¨çš„æ¡ä»¶å°±æ˜¯s2.common_field = ä¸€ä¸ªå¸¸æ•°ï¼Œæ‰€ä»¥æç¤ºäº†Using whereé¢å¤–ä¿¡æ¯ã€‚ Not existså½“æˆ‘ä»¬ä½¿ç”¨å·¦ï¼ˆå¤–ï¼‰è¿æ¥æ—¶ï¼Œå¦‚æœWHEREå­å¥ä¸­åŒ…å«è¦æ±‚è¢«é©±åŠ¨è¡¨çš„æŸä¸ªåˆ—ç­‰äºNULLå€¼çš„æœç´¢æ¡ä»¶ï¼Œè€Œä¸”é‚£ä¸ªåˆ—åˆæ˜¯ä¸å…è®¸å­˜å‚¨NULLå€¼çš„ï¼Œé‚£ä¹ˆåœ¨è¯¥è¡¨çš„æ‰§è¡Œè®¡åˆ’çš„Extraåˆ—å°±ä¼šæç¤ºNot existsé¢å¤–ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™æ ·ï¼šä¸Šè¿°æŸ¥è¯¢ä¸­s1è¡¨æ˜¯é©±åŠ¨è¡¨ï¼Œs2è¡¨æ˜¯è¢«é©±åŠ¨è¡¨ï¼Œs2.idåˆ—æ˜¯ä¸å…è®¸å­˜å‚¨NULLå€¼çš„ï¼Œè€ŒWHEREå­å¥ä¸­åˆåŒ…å«s2.id IS NULLçš„æœç´¢æ¡ä»¶ï¼Œè¿™æ„å‘³ç€å¿…å®šæ˜¯é©±åŠ¨è¡¨çš„è®°å½•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾ä¸åˆ°åŒ¹é…ONå­å¥æ¡ä»¶çš„è®°å½•æ‰ä¼šæŠŠè¯¥é©±åŠ¨è¡¨çš„è®°å½•åŠ å…¥åˆ°æœ€ç»ˆçš„ç»“æœé›†ï¼Œæ‰€ä»¥å¯¹äºæŸæ¡é©±åŠ¨è¡¨ä¸­çš„è®°å½•æ¥è¯´ï¼Œå¦‚æœèƒ½åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾åˆ°1æ¡ç¬¦åˆONå­å¥æ¡ä»¶çš„è®°å½•ï¼Œé‚£ä¹ˆè¯¥é©±åŠ¨è¡¨çš„è®°å½•å°±ä¸ä¼šè¢«åŠ å…¥åˆ°æœ€ç»ˆçš„ç»“æœé›†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ²¡æœ‰å¿…è¦åˆ°è¢«é©±åŠ¨è¡¨ä¸­æ‰¾åˆ°å…¨éƒ¨ç¬¦åˆONå­å¥æ¡ä»¶çš„è®°å½•ï¼Œè¿™æ ·å¯ä»¥ç¨å¾®èŠ‚çœä¸€ç‚¹æ€§èƒ½ã€‚ å³ï¼ˆå¤–ï¼‰è¿æ¥å¯ä»¥è¢«è½¬æ¢ä¸ºå·¦ï¼ˆå¤–ï¼‰è¿æ¥ï¼Œæ‰€ä»¥å°±ä¸æå³ï¼ˆå¤–ï¼‰è¿æ¥çš„æƒ…å†µäº†ã€‚ Using intersect(...)ã€Using union(...)å’ŒUsing sort_union(...)å¦‚æœæ‰§è¡Œè®¡åˆ’çš„Extraåˆ—å‡ºç°äº†Using intersect(...)æç¤ºï¼Œè¯´æ˜å‡†å¤‡ä½¿ç”¨Intersectç´¢å¼•åˆå¹¶çš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ‹¬å·ä¸­çš„...è¡¨ç¤ºéœ€è¦è¿›è¡Œç´¢å¼•åˆå¹¶çš„ç´¢å¼•åç§°ï¼›å¦‚æœå‡ºç°äº†Using union(...)æç¤ºï¼Œè¯´æ˜å‡†å¤‡ä½¿ç”¨Unionç´¢å¼•åˆå¹¶çš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ï¼›å‡ºç°äº†Using sort_union(...)æç¤ºï¼Œè¯´æ˜å‡†å¤‡ä½¿ç”¨Sort-Unionç´¢å¼•åˆå¹¶çš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ã€‚æ¯”å¦‚è¿™ä¸ªæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ï¼šå…¶ä¸­Extraåˆ—å°±æ˜¾ç¤ºäº†Using intersect(idx_key3,idx_key1)ï¼Œè¡¨æ˜MySQLå³å°†ä½¿ç”¨idx_key3å’Œidx_key1è¿™ä¸¤ä¸ªç´¢å¼•è¿›è¡ŒIntersectç´¢å¼•åˆå¹¶çš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ã€‚ Zero limitå½“æˆ‘ä»¬çš„LIMITå­å¥çš„å‚æ•°ä¸º0æ—¶ï¼Œè¡¨ç¤ºä¸æ‰“ç®—ä»è¡¨ä¸­è¯»å‡ºä»»ä½•è®°å½•ï¼Œå°†ä¼šæç¤ºè¯¥é¢å¤–ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™æ ·ï¼š Using filesortæœ‰ä¸€äº›æƒ…å†µä¸‹å¯¹ç»“æœé›†ä¸­çš„è®°å½•è¿›è¡Œæ’åºæ˜¯å¯ä»¥ä½¿ç”¨åˆ°ç´¢å¼•çš„ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼šè¿™ä¸ªæŸ¥è¯¢è¯­å¥å¯ä»¥åˆ©ç”¨idx_key1ç´¢å¼•ç›´æ¥å–å‡ºkey1åˆ—çš„10æ¡è®°å½•ï¼Œç„¶åå†è¿›è¡Œå›è¡¨æ“ä½œå°±å¥½äº†ã€‚ä½†æ˜¯å¾ˆå¤šæƒ…å†µä¸‹æ’åºæ“ä½œæ— æ³•ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œåªèƒ½åœ¨å†…å­˜ä¸­ï¼ˆè®°å½•è¾ƒå°‘çš„æ—¶å€™ï¼‰æˆ–è€…ç£ç›˜ä¸­ï¼ˆè®°å½•è¾ƒå¤šçš„æ—¶å€™ï¼‰è¿›è¡Œæ’åºï¼ŒMySQLæŠŠè¿™ç§åœ¨å†…å­˜ä¸­æˆ–è€…ç£ç›˜ä¸Šè¿›è¡Œæ’åºçš„æ–¹å¼ç»Ÿç§°ä¸ºæ–‡ä»¶æ’åºï¼ˆè‹±æ–‡åï¼šfilesortï¼‰ã€‚å¦‚æœæŸä¸ªæŸ¥è¯¢éœ€è¦ä½¿ç”¨æ–‡ä»¶æ’åºçš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ï¼Œå°±ä¼šåœ¨æ‰§è¡Œè®¡åˆ’çš„Extraåˆ—ä¸­æ˜¾ç¤ºUsing filesortæç¤ºï¼Œæ¯”å¦‚è¿™æ ·ï¼šéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæŸ¥è¯¢ä¸­éœ€è¦ä½¿ç”¨filesortçš„æ–¹å¼è¿›è¡Œæ’åºçš„è®°å½•éå¸¸å¤šï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹æ˜¯å¾ˆè€—è´¹æ€§èƒ½çš„ï¼Œæˆ‘ä»¬æœ€å¥½æƒ³åŠæ³•å°†ä½¿ç”¨æ–‡ä»¶æ’åºçš„æ‰§è¡Œæ–¹å¼æ”¹ä¸ºä½¿ç”¨ç´¢å¼•è¿›è¡Œæ’åºã€‚ Using temporaryåœ¨è®¸å¤šæŸ¥è¯¢çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒMySQLå¯èƒ½ä¼šå€ŸåŠ©ä¸´æ—¶è¡¨æ¥å®Œæˆä¸€äº›åŠŸèƒ½ï¼Œæ¯”å¦‚å»é‡ã€æ’åºä¹‹ç±»çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨æ‰§è¡Œè®¸å¤šåŒ…å«DISTINCTã€GROUP BYã€UNIONç­‰å­å¥çš„æŸ¥è¯¢è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸èƒ½æœ‰æ•ˆåˆ©ç”¨ç´¢å¼•æ¥å®ŒæˆæŸ¥è¯¢ï¼ŒMySQLå¾ˆæœ‰å¯èƒ½å¯»æ±‚é€šè¿‡å»ºç«‹å†…éƒ¨çš„ä¸´æ—¶è¡¨æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæŸ¥è¯¢ä¸­ä½¿ç”¨åˆ°äº†å†…éƒ¨çš„ä¸´æ—¶è¡¨ï¼Œåœ¨æ‰§è¡Œè®¡åˆ’çš„Extraåˆ—å°†ä¼šæ˜¾ç¤ºUsing temporaryæç¤ºï¼Œæ¯”æ–¹è¯´è¿™æ ·ï¼šå†æ¯”å¦‚ï¼šä¸çŸ¥é“å¤§å®¶æ³¨æ„åˆ°æ²¡æœ‰ï¼Œä¸Šè¿°æ‰§è¡Œè®¡åˆ’çš„Extraåˆ—ä¸ä»…ä»…åŒ…å«Using temporaryæç¤ºï¼Œè¿˜åŒ…å«Using filesortæç¤ºï¼Œå¯æ˜¯æˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥ä¸­æ˜æ˜æ²¡æœ‰å†™ORDER BYå­å¥å‘€ï¼Ÿè¿™æ˜¯å› ä¸ºMySQLä¼šåœ¨åŒ…å«GROUP BYå­å¥çš„æŸ¥è¯¢ä¸­é»˜è®¤æ·»åŠ ä¸ŠORDER BYå­å¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸Šè¿°æŸ¥è¯¢å…¶å®å’Œä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ç­‰ä»·ï¼š 1EXPLAIN SELECT common_field, COUNT(*) AS amount FROM s1 GROUP BY common_field ORDER BY common_field; å¦‚æœæˆ‘ä»¬å¹¶ä¸æƒ³ä¸ºåŒ…å«GROUP BYå­å¥çš„æŸ¥è¯¢è¿›è¡Œæ’åºï¼Œéœ€è¦æˆ‘ä»¬æ˜¾å¼çš„å†™ä¸ŠORDER BY NULLï¼Œå°±åƒè¿™æ ·ï¼šâ€‹ â€‹ è¿™å›æ‰§è¡Œè®¡åˆ’ä¸­å°±æ²¡æœ‰Using filesortçš„æç¤ºäº†ï¼Œä¹Ÿå°±æ„å‘³ç€æ‰§è¡ŒæŸ¥è¯¢æ—¶å¯ä»¥çœå»å¯¹è®°å½•è¿›è¡Œæ–‡ä»¶æ’åºçš„æˆæœ¬äº†ã€‚â€‹ å¦å¤–ï¼Œæ‰§è¡Œè®¡åˆ’ä¸­å‡ºç°Using temporaryå¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„å¾å…†ï¼Œå› ä¸ºå»ºç«‹ä¸ç»´æŠ¤ä¸´æ—¶è¡¨è¦ä»˜å‡ºå¾ˆå¤§æˆæœ¬çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€å¥½èƒ½ä½¿ç”¨ç´¢å¼•æ¥æ›¿ä»£æ‰ä½¿ç”¨ä¸´æ—¶è¡¨ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªåŒ…å«GROUP BYå­å¥çš„æŸ¥è¯¢å°±ä¸éœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨ï¼šâ€‹ â€‹ ä»Extraçš„Using indexçš„æç¤ºé‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¸Šè¿°æŸ¥è¯¢åªéœ€è¦æ‰«æidx_key1ç´¢å¼•å°±å¯ä»¥æå®šäº†ï¼Œä¸å†éœ€è¦ä¸´æ—¶è¡¨äº†ã€‚ Start temporary, End temporaryæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šä¼˜å…ˆå°è¯•å°†INå­æŸ¥è¯¢è½¬æ¢æˆsemi-joinï¼Œè€Œsemi-joinåˆæœ‰å¥½å¤šç§æ‰§è¡Œç­–ç•¥ï¼Œå½“æ‰§è¡Œç­–ç•¥ä¸ºDuplicateWeedoutæ—¶ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡å»ºç«‹ä¸´æ—¶è¡¨æ¥å®ç°ä¸ºå¤–å±‚æŸ¥è¯¢ä¸­çš„è®°å½•è¿›è¡Œå»é‡æ“ä½œæ—¶ï¼Œé©±åŠ¨è¡¨æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’çš„Extraåˆ—å°†æ˜¾ç¤ºStart temporaryæç¤ºï¼Œè¢«é©±åŠ¨è¡¨æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’çš„Extraåˆ—å°†æ˜¾ç¤ºEnd temporaryæç¤ºï¼Œå°±æ˜¯è¿™æ ·ï¼š LooseScanåœ¨å°†Inå­æŸ¥è¯¢è½¬ä¸ºsemi-joinæ—¶ï¼Œå¦‚æœé‡‡ç”¨çš„æ˜¯LooseScanæ‰§è¡Œç­–ç•¥ï¼Œåˆ™åœ¨é©±åŠ¨è¡¨æ‰§è¡Œè®¡åˆ’çš„Extraåˆ—å°±æ˜¯æ˜¾ç¤ºLooseScanæç¤ºï¼Œæ¯”å¦‚è¿™æ ·ï¼š FirstMatch(tbl_name)åœ¨å°†Inå­æŸ¥è¯¢è½¬ä¸ºsemi-joinæ—¶ï¼Œå¦‚æœé‡‡ç”¨çš„æ˜¯FirstMatchæ‰§è¡Œç­–ç•¥ï¼Œåˆ™åœ¨è¢«é©±åŠ¨è¡¨æ‰§è¡Œè®¡åˆ’çš„Extraåˆ—å°±æ˜¯æ˜¾ç¤ºFirstMatch(tbl_name)æç¤ºï¼Œæ¯”å¦‚è¿™æ ·ï¼š 2.Jsonæ ¼å¼çš„æ‰§è¡Œè®¡åˆ’æˆ‘ä»¬ä¸Šè¾¹ä»‹ç»çš„EXPLAINè¯­å¥è¾“å‡ºä¸­ç¼ºå°‘äº†ä¸€ä¸ªè¡¡é‡æ‰§è¡Œè®¡åˆ’å¥½åçš„é‡è¦å±æ€§ â€”â€” æˆæœ¬ã€‚ä¸è¿‡MySQLè´´å¿ƒçš„ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§æŸ¥çœ‹æŸä¸ªæ‰§è¡Œè®¡åˆ’èŠ±è´¹çš„æˆæœ¬çš„æ–¹å¼ï¼š åœ¨EXPLAINå•è¯å’ŒçœŸæ­£çš„æŸ¥è¯¢è¯­å¥ä¸­é—´åŠ ä¸ŠFORMAT=JSONã€‚ è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªjsonæ ¼å¼çš„æ‰§è¡Œè®¡åˆ’ï¼Œé‡Œè¾¹å„¿åŒ…å«è¯¥è®¡åˆ’èŠ±è´¹çš„æˆæœ¬ï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586mysql&gt; EXPLAIN FORMAT=JSON SELECT * FROM s1 INNER JOIN s2 ON s1.key1 = s2.key2 WHERE s1.common_field = &#x27;a&#x27;\\G*************************** 1. row ***************************EXPLAIN: &#123; &quot;query_block&quot;: &#123; &quot;select_id&quot;: 1, # æ•´ä¸ªæŸ¥è¯¢è¯­å¥åªæœ‰1ä¸ªSELECTå…³é”®å­—ï¼Œè¯¥å…³é”®å­—å¯¹åº”çš„idå·ä¸º1 &quot;cost_info&quot;: &#123; &quot;query_cost&quot;: &quot;3197.16&quot; # æ•´ä¸ªæŸ¥è¯¢çš„æ‰§è¡Œæˆæœ¬é¢„è®¡ä¸º3197.16 &#125;, &quot;nested_loop&quot;: [ # å‡ ä¸ªè¡¨ä¹‹é—´é‡‡ç”¨åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•æ‰§è¡Œ # ä»¥ä¸‹æ˜¯å‚ä¸åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•çš„å„ä¸ªè¡¨çš„ä¿¡æ¯ &#123; &quot;table&quot;: &#123; &quot;table_name&quot;: &quot;s1&quot;, # s1è¡¨æ˜¯é©±åŠ¨è¡¨ &quot;access_type&quot;: &quot;ALL&quot;, # è®¿é—®æ–¹æ³•ä¸ºALLï¼Œæ„å‘³ç€ä½¿ç”¨å…¨è¡¨æ‰«æè®¿é—® &quot;possible_keys&quot;: [ # å¯èƒ½ä½¿ç”¨çš„ç´¢å¼• &quot;idx_key1&quot; ], &quot;rows_examined_per_scan&quot;: 9688, # æŸ¥è¯¢ä¸€æ¬¡s1è¡¨å¤§è‡´éœ€è¦æ‰«æ9688æ¡è®°å½• &quot;rows_produced_per_join&quot;: 968, # é©±åŠ¨è¡¨s1çš„æ‰‡å‡ºæ˜¯968 &quot;filtered&quot;: &quot;10.00&quot;, # condition filteringä»£è¡¨çš„ç™¾åˆ†æ¯” &quot;cost_info&quot;: &#123; &quot;read_cost&quot;: &quot;1840.84&quot;, # ç¨åè§£é‡Š &quot;eval_cost&quot;: &quot;193.76&quot;, # ç¨åè§£é‡Š &quot;prefix_cost&quot;: &quot;2034.60&quot;, # å•æ¬¡æŸ¥è¯¢s1è¡¨æ€»å…±çš„æˆæœ¬ &quot;data_read_per_join&quot;: &quot;1M&quot; # è¯»å–çš„æ•°æ®é‡ &#125;, &quot;used_columns&quot;: [ # æ‰§è¡ŒæŸ¥è¯¢ä¸­æ¶‰åŠåˆ°çš„åˆ— &quot;id&quot;, &quot;key1&quot;, &quot;key2&quot;, &quot;key3&quot;, &quot;key_part1&quot;, &quot;key_part2&quot;, &quot;key_part3&quot;, &quot;common_field&quot; ], # å¯¹s1è¡¨è®¿é—®æ—¶é’ˆå¯¹å•è¡¨æŸ¥è¯¢çš„æ¡ä»¶ &quot;attached_condition&quot;: &quot;((`xiaohaizi`.`s1`.`common_field` = &#x27;a&#x27;) and (`xiaohaizi`.`s1`.`key1` is not null))&quot; &#125; &#125;, &#123; &quot;table&quot;: &#123; &quot;table_name&quot;: &quot;s2&quot;, # s2è¡¨æ˜¯è¢«é©±åŠ¨è¡¨ &quot;access_type&quot;: &quot;ref&quot;, # è®¿é—®æ–¹æ³•ä¸ºrefï¼Œæ„å‘³ç€ä½¿ç”¨ç´¢å¼•ç­‰å€¼åŒ¹é…çš„æ–¹å¼è®¿é—® &quot;possible_keys&quot;: [ # å¯èƒ½ä½¿ç”¨çš„ç´¢å¼• &quot;idx_key2&quot; ], &quot;key&quot;: &quot;idx_key2&quot;, # å®é™…ä½¿ç”¨çš„ç´¢å¼• &quot;used_key_parts&quot;: [ # ä½¿ç”¨åˆ°çš„ç´¢å¼•åˆ— &quot;key2&quot; ], &quot;key_length&quot;: &quot;5&quot;, # key_len &quot;ref&quot;: [ # ä¸key2åˆ—è¿›è¡Œç­‰å€¼åŒ¹é…çš„å¯¹è±¡ &quot;xiaohaizi.s1.key1&quot; ], &quot;rows_examined_per_scan&quot;: 1, # æŸ¥è¯¢ä¸€æ¬¡s2è¡¨å¤§è‡´éœ€è¦æ‰«æ1æ¡è®°å½• &quot;rows_produced_per_join&quot;: 968, # è¢«é©±åŠ¨è¡¨s2çš„æ‰‡å‡ºæ˜¯968ï¼ˆç”±äºåè¾¹æ²¡æœ‰å¤šä½™çš„è¡¨è¿›è¡Œè¿æ¥ï¼Œæ‰€ä»¥è¿™ä¸ªå€¼ä¹Ÿæ²¡å•¥ç”¨ï¼‰ &quot;filtered&quot;: &quot;100.00&quot;, # condition filteringä»£è¡¨çš„ç™¾åˆ†æ¯” # s2è¡¨ä½¿ç”¨ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢çš„æœç´¢æ¡ä»¶ &quot;index_condition&quot;: &quot;(`xiaohaizi`.`s1`.`key1` = `xiaohaizi`.`s2`.`key2`)&quot;, &quot;cost_info&quot;: &#123; &quot;read_cost&quot;: &quot;968.80&quot;, # ç¨åè§£é‡Š &quot;eval_cost&quot;: &quot;193.76&quot;, # ç¨åè§£é‡Š &quot;prefix_cost&quot;: &quot;3197.16&quot;, # å•æ¬¡æŸ¥è¯¢s1ã€å¤šæ¬¡æŸ¥è¯¢s2è¡¨æ€»å…±çš„æˆæœ¬ &quot;data_read_per_join&quot;: &quot;1M&quot; # è¯»å–çš„æ•°æ®é‡ &#125;, &quot;used_columns&quot;: [ # æ‰§è¡ŒæŸ¥è¯¢ä¸­æ¶‰åŠåˆ°çš„åˆ— &quot;id&quot;, &quot;key1&quot;, &quot;key2&quot;, &quot;key3&quot;, &quot;key_part1&quot;, &quot;key_part2&quot;, &quot;key_part3&quot;, &quot;common_field&quot; ] &#125; &#125; ] &#125;&#125;1 row in set, 2 warnings (0.00 sec) &quot;cost_info&quot;é‡Œè¾¹çš„æˆæœ¬æ˜¯æ€ä¹ˆè®¡ç®—å‡ºæ¥çš„ï¼Ÿå…ˆçœ‹s1è¡¨çš„&quot;cost_info&quot;éƒ¨åˆ†ï¼š 123456&quot;cost_info&quot;: &#123; &quot;read_cost&quot;: &quot;1840.84&quot;, &quot;eval_cost&quot;: &quot;193.76&quot;, &quot;prefix_cost&quot;: &quot;2034.60&quot;, &quot;data_read_per_join&quot;: &quot;1M&quot;&#125; read_costæ˜¯ç”±ä¸‹è¾¹è¿™ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼š IOæˆæœ¬ æ£€æµ‹rows Ã— (1 - filter)æ¡è®°å½•çš„CPUæˆæœ¬ rowså’Œfilteréƒ½æ˜¯æˆ‘ä»¬å‰è¾¹ä»‹ç»æ‰§è¡Œè®¡åˆ’çš„è¾“å‡ºåˆ—ï¼Œåœ¨JSONæ ¼å¼çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œrowsç›¸å½“äºrows_examined_per_scanï¼Œfilteredåç§°ä¸å˜ã€‚ eval_costæ˜¯è¿™æ ·è®¡ç®—çš„ï¼šæ£€æµ‹ rows Ã— filteræ¡è®°å½•çš„æˆæœ¬ã€‚ prefix_costå°±æ˜¯å•ç‹¬æŸ¥è¯¢s1è¡¨çš„æˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ï¼šread_cost + eval_cost data_read_per_joinè¡¨ç¤ºåœ¨æ­¤æ¬¡æŸ¥è¯¢ä¸­éœ€è¦è¯»å–çš„æ•°æ®é‡ï¼Œæˆ‘ä»¬å°±ä¸å¤šå” å¨è¿™ä¸ªäº†ã€‚ å…¶å®æ²¡å¿…è¦å…³æ³¨MySQLä¸ºå•¥ä½¿ç”¨è¿™ä¹ˆå¤æ€ªçš„æ–¹å¼è®¡ç®—å‡ºread_costå’Œeval_costï¼Œå…³æ³¨prefix_costæ˜¯æŸ¥è¯¢s1è¡¨çš„æˆæœ¬å°±å¥½äº†ã€‚ å¯¹äºs2è¡¨çš„&quot;cost_info&quot;éƒ¨åˆ†æ˜¯è¿™æ ·çš„ï¼š 123456&quot;cost_info&quot;: &#123; &quot;read_cost&quot;: &quot;968.80&quot;, &quot;eval_cost&quot;: &quot;193.76&quot;, &quot;prefix_cost&quot;: &quot;3197.16&quot;, &quot;data_read_per_join&quot;: &quot;1M&quot;&#125; ç”±äºs2è¡¨æ˜¯è¢«é©±åŠ¨è¡¨ï¼Œæ‰€ä»¥å¯èƒ½è¢«è¯»å–å¤šæ¬¡ï¼Œè¿™é‡Œçš„read_costå’Œeval_costæ˜¯è®¿é—®å¤šæ¬¡s2è¡¨åç´¯åŠ èµ·æ¥çš„å€¼ï¼Œä¸»è¦å…³æ³¨é‡Œè¾¹å„¿çš„prefix_costçš„å€¼ä»£è¡¨çš„æ˜¯æ•´ä¸ªè¿æ¥æŸ¥è¯¢é¢„è®¡çš„æˆæœ¬ï¼Œä¹Ÿå°±æ˜¯å•æ¬¡æŸ¥è¯¢s1è¡¨å’Œå¤šæ¬¡æŸ¥è¯¢s2è¡¨åçš„æˆæœ¬çš„å’Œï¼Œä¹Ÿå°±æ˜¯ï¼š 1968.80 + 193.76 + 2034.60 = 3197.16 3.Extented EXPLAINåœ¨æˆ‘ä»¬ä½¿ç”¨EXPLAINè¯­å¥æŸ¥çœ‹äº†æŸä¸ªæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’åï¼Œç´§æ¥ç€è¿˜å¯ä»¥ä½¿ç”¨SHOW WARNINGSè¯­å¥æŸ¥çœ‹ä¸è¿™ä¸ªæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’æœ‰å…³çš„ä¸€äº›æ‰©å±•ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™æ ·ï¼š å¯ä»¥çœ‹åˆ°SHOW WARNINGSå±•ç¤ºå‡ºæ¥çš„ä¿¡æ¯æœ‰ä¸‰ä¸ªå­—æ®µï¼Œåˆ†åˆ«æ˜¯Levelã€Codeã€Messageã€‚æˆ‘ä»¬æœ€å¸¸è§çš„å°±æ˜¯Codeä¸º1003çš„ä¿¡æ¯ï¼Œå½“Codeå€¼ä¸º1003æ—¶ï¼ŒMessageå­—æ®µå±•ç¤ºçš„ä¿¡æ¯ç±»ä¼¼äºæŸ¥è¯¢ä¼˜åŒ–å™¨å°†æˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥é‡å†™åçš„è¯­å¥ã€‚æ¯”å¦‚æˆ‘ä»¬ä¸Šè¾¹çš„æŸ¥è¯¢æœ¬æ¥æ˜¯ä¸€ä¸ªå·¦ï¼ˆå¤–ï¼‰è¿æ¥æŸ¥è¯¢ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªs2.common_field IS NOT NULLçš„æ¡ä»¶ï¼Œç€å°±ä¼šå¯¼è‡´æŸ¥è¯¢ä¼˜åŒ–å™¨æŠŠå·¦ï¼ˆå¤–ï¼‰è¿æ¥æŸ¥è¯¢ä¼˜åŒ–ä¸ºå†…è¿æ¥æŸ¥è¯¢ï¼Œä»SHOW WARNINGSçš„Messageå­—æ®µä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼ŒåŸæœ¬çš„LEFT JOINå·²ç»å˜æˆäº†JOINã€‚ æˆ‘ä»¬è¯´Messageå­—æ®µå±•ç¤ºçš„ä¿¡æ¯ç±»ä¼¼äºæŸ¥è¯¢ä¼˜åŒ–å™¨å°†æˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥é‡å†™åçš„è¯­å¥ï¼Œå¹¶ä¸æ˜¯ç­‰ä»·äºï¼Œä¹Ÿå°±æ˜¯è¯´Messageå­—æ®µå±•ç¤ºçš„ä¿¡æ¯å¹¶ä¸æ˜¯æ ‡å‡†çš„æŸ¥è¯¢è¯­å¥ï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹å¹¶ä¸èƒ½ç›´æ¥è¿è¡Œï¼Œå®ƒåªèƒ½ä½œä¸ºå¸®åŠ©æˆ‘ä»¬ç†è§£æŸ¥MySQLå°†å¦‚ä½•æ‰§è¡ŒæŸ¥è¯¢è¯­å¥çš„ä¸€ä¸ªå‚è€ƒä¾æ®è€Œå·²ã€‚ äºŒï¼Œoptimizer traceå¯¹äºMySQL 5.6ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬æ¥è¯´ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å°±åƒæ˜¯ä¸€ä¸ªé»‘ç›’å­ä¸€æ ·ï¼Œåªèƒ½é€šè¿‡EXPLAINè¯­å¥æŸ¥çœ‹åˆ°æœ€åä¼˜åŒ–å™¨å†³å®šä½¿ç”¨çš„æ‰§è¡Œè®¡åˆ’ï¼Œå´æ— æ³•çŸ¥é“å®ƒä¸ºä»€ä¹ˆåšè¿™ä¸ªå†³ç­–ã€‚ åœ¨MySQL 5.6ä»¥åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼ŒMySQLæå‡ºäº†ä¸€ä¸ªoptimizer traceçš„åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥è®©æˆ‘ä»¬æ–¹ä¾¿çš„æŸ¥çœ‹ä¼˜åŒ–å™¨ç”Ÿæˆæ‰§è¡Œè®¡åˆ’çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸ªåŠŸèƒ½çš„å¼€å¯ä¸å…³é—­ç”±ç³»ç»Ÿå˜é‡optimizer_traceå†³å®šï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼š 1234567mysql&gt; SHOW VARIABLES LIKE &#x27;optimizer_trace&#x27;;+-----------------+--------------------------+| Variable_name | Value |+-----------------+--------------------------+| optimizer_trace | enabled=off,one_line=off |+-----------------+--------------------------+1 row in set (0.02 sec) å¯ä»¥çœ‹åˆ°enabledå€¼ä¸ºoffï¼Œè¡¨æ˜è¿™ä¸ªåŠŸèƒ½é»˜è®¤æ˜¯å…³é—­çš„ã€‚ one_lineçš„å€¼æ˜¯æ§åˆ¶è¾“å‡ºæ ¼å¼çš„ï¼Œå¦‚æœä¸ºoné‚£ä¹ˆæ‰€æœ‰è¾“å‡ºéƒ½å°†åœ¨ä¸€è¡Œä¸­å±•ç¤ºï¼Œä¸é€‚åˆäººé˜…è¯»ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¿æŒå…¶é»˜è®¤å€¼ä¸ºoffå§ã€‚ å¦‚æœæƒ³æ‰“å¼€è¿™ä¸ªåŠŸèƒ½ï¼Œå¿…é¡»é¦–å…ˆæŠŠenabledçš„å€¼æ”¹ä¸ºonï¼Œå°±åƒè¿™æ ·ï¼š 12mysql&gt; SET optimizer_trace=&quot;enabled=on&quot;;Query OK, 0 rows affected (0.00 sec) ç„¶åæˆ‘ä»¬å°±å¯ä»¥è¾“å…¥æˆ‘ä»¬æƒ³è¦æŸ¥çœ‹ä¼˜åŒ–è¿‡ç¨‹çš„æŸ¥è¯¢è¯­å¥ï¼Œå½“è¯¥æŸ¥è¯¢è¯­å¥æ‰§è¡Œå®Œæˆåï¼Œå°±å¯ä»¥åˆ°information_schemaæ•°æ®åº“ä¸‹çš„OPTIMIZER_TRACEè¡¨ä¸­æŸ¥çœ‹å®Œæ•´çš„ä¼˜åŒ–è¿‡ç¨‹ã€‚è¿™ä¸ªOPTIMIZER_TRACEè¡¨æœ‰4ä¸ªåˆ—ï¼Œåˆ†åˆ«æ˜¯ï¼š QUERYï¼šè¡¨ç¤ºæˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥ã€‚ TRACEï¼šè¡¨ç¤ºä¼˜åŒ–è¿‡ç¨‹çš„JSONæ ¼å¼æ–‡æœ¬ã€‚ MISSING_BYTES_BEYOND_MAX_MEM_SIZEï¼šç”±äºä¼˜åŒ–è¿‡ç¨‹å¯èƒ½ä¼šè¾“å‡ºå¾ˆå¤šï¼Œå¦‚æœè¶…è¿‡æŸä¸ªé™åˆ¶æ—¶ï¼Œå¤šä½™çš„æ–‡æœ¬å°†ä¸ä¼šè¢«æ˜¾ç¤ºï¼Œè¿™ä¸ªå­—æ®µå±•ç¤ºäº†è¢«å¿½ç•¥çš„æ–‡æœ¬å­—èŠ‚æ•°ã€‚ INSUFFICIENT_PRIVILEGESï¼šè¡¨ç¤ºæ˜¯å¦æ²¡æœ‰æƒé™æŸ¥çœ‹ä¼˜åŒ–è¿‡ç¨‹ï¼Œé»˜è®¤å€¼æ˜¯0ï¼Œåªæœ‰æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹æ‰ä¼šæ˜¯1ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸å…³å¿ƒè¿™ä¸ªå­—æ®µçš„å€¼ã€‚ å®Œæ•´çš„ä½¿ç”¨optimizer traceåŠŸèƒ½çš„æ­¥éª¤æ€»ç»“å¦‚ä¸‹ï¼š 1234567891011121314# 1. æ‰“å¼€optimizer traceåŠŸèƒ½ (é»˜è®¤æƒ…å†µä¸‹å®ƒæ˜¯å…³é—­çš„):SET optimizer_trace=&quot;enabled=on&quot;;# 2. è¿™é‡Œè¾“å…¥æŸ¥è¯¢è¯­å¥SELECT ...; # 3. ä»OPTIMIZER_TRACEè¡¨ä¸­æŸ¥çœ‹ä¸Šä¸€ä¸ªæŸ¥è¯¢çš„ä¼˜åŒ–è¿‡ç¨‹SELECT * FROM information_schema.OPTIMIZER_TRACE;# 4. å¯èƒ½è¿˜è¦è§‚å¯Ÿå…¶ä»–è¯­å¥æ‰§è¡Œçš„ä¼˜åŒ–è¿‡ç¨‹ï¼Œé‡å¤ä¸Šè¾¹çš„ç¬¬2ã€3æ­¥...# 5. å½“åœæ­¢æŸ¥çœ‹è¯­å¥çš„ä¼˜åŒ–è¿‡ç¨‹æ—¶ï¼ŒæŠŠoptimizer traceåŠŸèƒ½å…³é—­SET optimizer_trace=&quot;enabled=off&quot;; ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªæœç´¢æ¡ä»¶æ¯”è¾ƒå¤šçš„æŸ¥è¯¢è¯­å¥ï¼Œå®ƒçš„æ‰§è¡Œè®¡åˆ’å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°è¯¥æŸ¥è¯¢å¯èƒ½ä½¿ç”¨åˆ°çš„ç´¢å¼•æœ‰3ä¸ªï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¼˜åŒ–å™¨æœ€ç»ˆé€‰æ‹©äº†idx_key2è€Œä¸é€‰æ‹©å…¶ä»–çš„ç´¢å¼•æˆ–è€…ç›´æ¥å…¨è¡¨æ‰«æå‘¢ï¼Ÿè¿™æ—¶å€™å°±å¯ä»¥é€šè¿‡otpimzer traceåŠŸèƒ½æ¥æŸ¥çœ‹ä¼˜åŒ–å™¨çš„å…·ä½“å·¥ä½œè¿‡ç¨‹ï¼š 123456789SET optimizer_trace=&quot;enabled=on&quot;;SELECT * FROM s1 WHERE key1 &gt; &#x27;z&#x27; AND key2 &lt; 1000000 AND key3 IN (&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;) AND common_field = &#x27;abc&#x27;; SELECT * FROM information_schema.OPTIMIZER_TRACE\\G ç›´æ¥çœ‹ä¸€ä¸‹é€šè¿‡æŸ¥è¯¢OPTIMIZER_TRACEè¡¨å¾—åˆ°çš„è¾“å‡ºï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281*************************** 1. row ***************************# åˆ†æçš„æŸ¥è¯¢è¯­å¥æ˜¯ä»€ä¹ˆQUERY: SELECT * FROM s1 WHERE key1 &gt; &#x27;z&#x27; AND key2 &lt; 1000000 AND key3 IN (&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;) AND common_field = &#x27;abc&#x27;# ä¼˜åŒ–çš„å…·ä½“è¿‡ç¨‹TRACE: &#123; &quot;steps&quot;: [ &#123; &quot;join_preparation&quot;: &#123; # prepareé˜¶æ®µ &quot;select#&quot;: 1, &quot;steps&quot;: [ &#123; &quot;IN_uses_bisection&quot;: true &#125;, &#123; &quot;expanded_query&quot;: &quot;/* select#1 */ select `s1`.`id` AS `id`,`s1`.`key1` AS `key1`,`s1`.`key2` AS `key2`,`s1`.`key3` AS `key3`,`s1`.`key_part1` AS `key_part1`,`s1`.`key_part2` AS `key_part2`,`s1`.`key_part3` AS `key_part3`,`s1`.`common_field` AS `common_field` from `s1` where ((`s1`.`key1` &gt; &#x27;z&#x27;) and (`s1`.`key2` &lt; 1000000) and (`s1`.`key3` in (&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;)) and (`s1`.`common_field` = &#x27;abc&#x27;))&quot; &#125; ] /* steps */ &#125; /* join_preparation */ &#125;, &#123; &quot;join_optimization&quot;: &#123; # optimizeé˜¶æ®µ &quot;select#&quot;: 1, &quot;steps&quot;: [ &#123; &quot;condition_processing&quot;: &#123; # å¤„ç†æœç´¢æ¡ä»¶ &quot;condition&quot;: &quot;WHERE&quot;, # åŸå§‹æœç´¢æ¡ä»¶ &quot;original_condition&quot;: &quot;((`s1`.`key1` &gt; &#x27;z&#x27;) and (`s1`.`key2` &lt; 1000000) and (`s1`.`key3` in (&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;)) and (`s1`.`common_field` = &#x27;abc&#x27;))&quot;, &quot;steps&quot;: [ &#123; # ç­‰å€¼ä¼ é€’è½¬æ¢ &quot;transformation&quot;: &quot;equality_propagation&quot;, &quot;resulting_condition&quot;: &quot;((`s1`.`key1` &gt; &#x27;z&#x27;) and (`s1`.`key2` &lt; 1000000) and (`s1`.`key3` in (&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;)) and (`s1`.`common_field` = &#x27;abc&#x27;))&quot; &#125;, &#123; # å¸¸é‡ä¼ é€’è½¬æ¢ &quot;transformation&quot;: &quot;constant_propagation&quot;, &quot;resulting_condition&quot;: &quot;((`s1`.`key1` &gt; &#x27;z&#x27;) and (`s1`.`key2` &lt; 1000000) and (`s1`.`key3` in (&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;)) and (`s1`.`common_field` = &#x27;abc&#x27;))&quot; &#125;, &#123; # å»é™¤æ²¡ç”¨çš„æ¡ä»¶ &quot;transformation&quot;: &quot;trivial_condition_removal&quot;, &quot;resulting_condition&quot;: &quot;((`s1`.`key1` &gt; &#x27;z&#x27;) and (`s1`.`key2` &lt; 1000000) and (`s1`.`key3` in (&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;)) and (`s1`.`common_field` = &#x27;abc&#x27;))&quot; &#125; ] /* steps */ &#125; /* condition_processing */ &#125;, &#123; # æ›¿æ¢è™šæ‹Ÿç”Ÿæˆåˆ— &quot;substitute_generated_columns&quot;: &#123; &#125; /* substitute_generated_columns */ &#125;, &#123; # è¡¨çš„ä¾èµ–ä¿¡æ¯ &quot;table_dependencies&quot;: [ &#123; &quot;table&quot;: &quot;`s1`&quot;, &quot;row_may_be_null&quot;: false, &quot;map_bit&quot;: 0, &quot;depends_on_map_bits&quot;: [ ] /* depends_on_map_bits */ &#125; ] /* table_dependencies */ &#125;, &#123; &quot;ref_optimizer_key_uses&quot;: [ ] /* ref_optimizer_key_uses */ &#125;, &#123; # é¢„ä¼°ä¸åŒå•è¡¨è®¿é—®æ–¹æ³•çš„è®¿é—®æˆæœ¬ &quot;rows_estimation&quot;: [ &#123; &quot;table&quot;: &quot;`s1`&quot;, &quot;range_analysis&quot;: &#123; &quot;table_scan&quot;: &#123; # å…¨è¡¨æ‰«æçš„è¡Œæ•°ä»¥åŠæˆæœ¬ &quot;rows&quot;: 9688, &quot;cost&quot;: 2036.7 &#125; /* table_scan */, # åˆ†æå¯èƒ½ä½¿ç”¨çš„ç´¢å¼• &quot;potential_range_indexes&quot;: [ &#123; &quot;index&quot;: &quot;PRIMARY&quot;, # ä¸»é”®ä¸å¯ç”¨ &quot;usable&quot;: false, &quot;cause&quot;: &quot;not_applicable&quot; &#125;, &#123; &quot;index&quot;: &quot;idx_key2&quot;, # idx_key2å¯èƒ½è¢«ä½¿ç”¨ &quot;usable&quot;: true, &quot;key_parts&quot;: [ &quot;key2&quot; ] /* key_parts */ &#125;, &#123; &quot;index&quot;: &quot;idx_key1&quot;, # idx_key1å¯èƒ½è¢«ä½¿ç”¨ &quot;usable&quot;: true, &quot;key_parts&quot;: [ &quot;key1&quot;, &quot;id&quot; ] /* key_parts */ &#125;, &#123; &quot;index&quot;: &quot;idx_key3&quot;, # idx_key3å¯èƒ½è¢«ä½¿ç”¨ &quot;usable&quot;: true, &quot;key_parts&quot;: [ &quot;key3&quot;, &quot;id&quot; ] /* key_parts */ &#125;, &#123; &quot;index&quot;: &quot;idx_key_part&quot;, # idx_keypartä¸å¯ç”¨ &quot;usable&quot;: false, &quot;cause&quot;: &quot;not_applicable&quot; &#125; ] /* potential_range_indexes */, &quot;setup_range_conditions&quot;: [ ] /* setup_range_conditions */, &quot;group_index_range&quot;: &#123; &quot;chosen&quot;: false, &quot;cause&quot;: &quot;not_group_by_or_distinct&quot; &#125; /* group_index_range */, # åˆ†æå„ç§å¯èƒ½ä½¿ç”¨çš„ç´¢å¼•çš„æˆæœ¬ &quot;analyzing_range_alternatives&quot;: &#123; &quot;range_scan_alternatives&quot;: [ &#123; # ä½¿ç”¨idx_key2çš„æˆæœ¬åˆ†æ &quot;index&quot;: &quot;idx_key2&quot;, # ä½¿ç”¨idx_key2çš„èŒƒå›´åŒºé—´ &quot;ranges&quot;: [ &quot;NULL &lt; key2 &lt; 1000000&quot; ] /* ranges */, &quot;index_dives_for_eq_ranges&quot;: true, # æ˜¯å¦ä½¿ç”¨index dive &quot;rowid_ordered&quot;: false, # ä½¿ç”¨è¯¥ç´¢å¼•è·å–çš„è®°å½•æ˜¯å¦æŒ‰ç…§ä¸»é”®æ’åº &quot;using_mrr&quot;: false, # æ˜¯å¦ä½¿ç”¨mrr &quot;index_only&quot;: false, # æ˜¯å¦æ˜¯ç´¢å¼•è¦†ç›–è®¿é—® &quot;rows&quot;: 12, # ä½¿ç”¨è¯¥ç´¢å¼•è·å–çš„è®°å½•æ¡æ•° &quot;cost&quot;: 15.41, # ä½¿ç”¨è¯¥ç´¢å¼•çš„æˆæœ¬ &quot;chosen&quot;: true # æ˜¯å¦é€‰æ‹©è¯¥ç´¢å¼• &#125;, &#123; # ä½¿ç”¨idx_key1çš„æˆæœ¬åˆ†æ &quot;index&quot;: &quot;idx_key1&quot;, # ä½¿ç”¨idx_key1çš„èŒƒå›´åŒºé—´ &quot;ranges&quot;: [ &quot;z &lt; key1&quot; ] /* ranges */, &quot;index_dives_for_eq_ranges&quot;: true, # åŒä¸Š &quot;rowid_ordered&quot;: false, # åŒä¸Š &quot;using_mrr&quot;: false, # åŒä¸Š &quot;index_only&quot;: false, # åŒä¸Š &quot;rows&quot;: 266, # åŒä¸Š &quot;cost&quot;: 320.21, # åŒä¸Š &quot;chosen&quot;: false, # åŒä¸Š &quot;cause&quot;: &quot;cost&quot; # å› ä¸ºæˆæœ¬å¤ªå¤§æ‰€ä»¥ä¸é€‰æ‹©è¯¥ç´¢å¼• &#125;, &#123; # ä½¿ç”¨idx_key3çš„æˆæœ¬åˆ†æ &quot;index&quot;: &quot;idx_key3&quot;, # ä½¿ç”¨idx_key3çš„èŒƒå›´åŒºé—´ &quot;ranges&quot;: [ &quot;a &lt;= key3 &lt;= a&quot;, &quot;b &lt;= key3 &lt;= b&quot;, &quot;c &lt;= key3 &lt;= c&quot; ] /* ranges */, &quot;index_dives_for_eq_ranges&quot;: true, # åŒä¸Š &quot;rowid_ordered&quot;: false, # åŒä¸Š &quot;using_mrr&quot;: false, # åŒä¸Š &quot;index_only&quot;: false, # åŒä¸Š &quot;rows&quot;: 21, # åŒä¸Š &quot;cost&quot;: 28.21, # åŒä¸Š &quot;chosen&quot;: false, # åŒä¸Š &quot;cause&quot;: &quot;cost&quot; # åŒä¸Š &#125; ] /* range_scan_alternatives */, # åˆ†æä½¿ç”¨ç´¢å¼•åˆå¹¶çš„æˆæœ¬ &quot;analyzing_roworder_intersect&quot;: &#123; &quot;usable&quot;: false, &quot;cause&quot;: &quot;too_few_roworder_scans&quot; &#125; /* analyzing_roworder_intersect */ &#125; /* analyzing_range_alternatives */, # å¯¹äºä¸Šè¿°å•è¡¨æŸ¥è¯¢s1æœ€ä¼˜çš„è®¿é—®æ–¹æ³• &quot;chosen_range_access_summary&quot;: &#123; &quot;range_access_plan&quot;: &#123; &quot;type&quot;: &quot;range_scan&quot;, &quot;index&quot;: &quot;idx_key2&quot;, &quot;rows&quot;: 12, &quot;ranges&quot;: [ &quot;NULL &lt; key2 &lt; 1000000&quot; ] /* ranges */ &#125; /* range_access_plan */, &quot;rows_for_plan&quot;: 12, &quot;cost_for_plan&quot;: 15.41, &quot;chosen&quot;: true &#125; /* chosen_range_access_summary */ &#125; /* range_analysis */ &#125; ] /* rows_estimation */ &#125;, &#123; # åˆ†æå„ç§å¯èƒ½çš„æ‰§è¡Œè®¡åˆ’ #ï¼ˆå¯¹å¤šè¡¨æŸ¥è¯¢è¿™å¯èƒ½æœ‰å¾ˆå¤šç§ä¸åŒçš„æ–¹æ¡ˆï¼Œå•è¡¨æŸ¥è¯¢çš„æ–¹æ¡ˆä¸Šè¾¹å·²ç»åˆ†æè¿‡äº†ï¼Œç›´æ¥é€‰å–idx_key2å°±å¥½ï¼‰ &quot;considered_execution_plans&quot;: [ &#123; &quot;plan_prefix&quot;: [ ] /* plan_prefix */, &quot;table&quot;: &quot;`s1`&quot;, &quot;best_access_path&quot;: &#123; &quot;considered_access_paths&quot;: [ &#123; &quot;rows_to_scan&quot;: 12, &quot;access_type&quot;: &quot;range&quot;, &quot;range_details&quot;: &#123; &quot;used_index&quot;: &quot;idx_key2&quot; &#125; /* range_details */, &quot;resulting_rows&quot;: 12, &quot;cost&quot;: 17.81, &quot;chosen&quot;: true &#125; ] /* considered_access_paths */ &#125; /* best_access_path */, &quot;condition_filtering_pct&quot;: 100, &quot;rows_for_plan&quot;: 12, &quot;cost_for_plan&quot;: 17.81, &quot;chosen&quot;: true &#125; ] /* considered_execution_plans */ &#125;, &#123; # å°è¯•ç»™æŸ¥è¯¢æ·»åŠ ä¸€äº›å…¶ä»–çš„æŸ¥è¯¢æ¡ä»¶ &quot;attaching_conditions_to_tables&quot;: &#123; &quot;original_condition&quot;: &quot;((`s1`.`key1` &gt; &#x27;z&#x27;) and (`s1`.`key2` &lt; 1000000) and (`s1`.`key3` in (&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;)) and (`s1`.`common_field` = &#x27;abc&#x27;))&quot;, &quot;attached_conditions_computation&quot;: [ ] /* attached_conditions_computation */, &quot;attached_conditions_summary&quot;: [ &#123; &quot;table&quot;: &quot;`s1`&quot;, &quot;attached&quot;: &quot;((`s1`.`key1` &gt; &#x27;z&#x27;) and (`s1`.`key2` &lt; 1000000) and (`s1`.`key3` in (&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;)) and (`s1`.`common_field` = &#x27;abc&#x27;))&quot; &#125; ] /* attached_conditions_summary */ &#125; /* attaching_conditions_to_tables */ &#125;, &#123; # å†ç¨ç¨çš„æ”¹è¿›ä¸€ä¸‹æ‰§è¡Œè®¡åˆ’ &quot;refine_plan&quot;: [ &#123; &quot;table&quot;: &quot;`s1`&quot;, &quot;pushed_index_condition&quot;: &quot;(`s1`.`key2` &lt; 1000000)&quot;, &quot;table_condition_attached&quot;: &quot;((`s1`.`key1` &gt; &#x27;z&#x27;) and (`s1`.`key3` in (&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;)) and (`s1`.`common_field` = &#x27;abc&#x27;))&quot; &#125; ] /* refine_plan */ &#125; ] /* steps */ &#125; /* join_optimization */ &#125;, &#123; &quot;join_execution&quot;: &#123; # executeé˜¶æ®µ &quot;select#&quot;: 1, &quot;steps&quot;: [ ] /* steps */ &#125; /* join_execution */ &#125; ] /* steps */&#125;# å› ä¼˜åŒ–è¿‡ç¨‹æ–‡æœ¬å¤ªå¤šè€Œä¸¢å¼ƒçš„æ–‡æœ¬å­—èŠ‚å¤§å°ï¼Œå€¼ä¸º0æ—¶è¡¨ç¤ºå¹¶æ²¡æœ‰ä¸¢å¼ƒMISSING_BYTES_BEYOND_MAX_MEM_SIZE: 0# æƒé™å­—æ®µINSUFFICIENT_PRIVILEGES: 01 row in set (0.00 sec) è¿™åªæ˜¯ä¼˜åŒ–å™¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€å°éƒ¨åˆ†ï¼ŒMySQLå¯èƒ½ä¼šåœ¨ä¹‹åçš„ç‰ˆæœ¬ä¸­æ·»åŠ æ›´å¤šçš„ä¼˜åŒ–è¿‡ç¨‹ä¿¡æ¯ã€‚ä¸è¿‡æ‚ä¹±ä¹‹ä¸­å…¶å®è¿˜æ˜¯è›®æœ‰è§„å¾‹çš„ï¼Œä¼˜åŒ–è¿‡ç¨‹å¤§è‡´åˆ†ä¸ºäº†ä¸‰ä¸ªé˜¶æ®µï¼š prepareé˜¶æ®µ optimizeé˜¶æ®µ executeé˜¶æ®µ æˆ‘ä»¬æ‰€è¯´çš„åŸºäºæˆæœ¬çš„ä¼˜åŒ–ä¸»è¦é›†ä¸­åœ¨optimizeé˜¶æ®µï¼Œå¯¹äºå•è¡¨æŸ¥è¯¢æ¥è¯´ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨optimizeé˜¶æ®µçš„&quot;rows_estimation&quot;è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹æ·±å…¥åˆ†æäº†å¯¹å•è¡¨æŸ¥è¯¢çš„å„ç§æ‰§è¡Œæ–¹æ¡ˆçš„æˆæœ¬ï¼›å¯¹äºå¤šè¡¨è¿æ¥æŸ¥è¯¢æ¥è¯´ï¼Œæˆ‘ä»¬æ›´å¤šéœ€è¦å…³æ³¨&quot;considered_execution_plans&quot;è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹é‡Œä¼šå†™æ˜å„ç§ä¸åŒçš„è¿æ¥æ–¹å¼æ‰€å¯¹åº”çš„æˆæœ¬ã€‚åæ­£ä¼˜åŒ–å™¨æœ€ç»ˆä¼šé€‰æ‹©æˆæœ¬æœ€ä½çš„é‚£ç§æ–¹æ¡ˆæ¥ä½œä¸ºæœ€ç»ˆçš„æ‰§è¡Œè®¡åˆ’ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨EXPLAINè¯­å¥æ‰€å±•ç°å‡ºçš„é‚£ç§æ–¹æ¡ˆã€‚ å¦‚æœå¯¹ä½¿ç”¨EXPLAINè¯­å¥å±•ç¤ºå‡ºçš„å¯¹æŸä¸ªæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’å¾ˆä¸ç†è§£ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨optimizer traceåŠŸèƒ½æ¥è¯¦ç»†äº†è§£æ¯ä¸€ç§æ‰§è¡Œæ–¹æ¡ˆå¯¹åº”çš„æˆæœ¬ã€‚","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[ä¹]åŸºäºè§„åˆ™çš„ä¼˜åŒ–&å­æŸ¥è¯¢ä¼˜åŒ–","slug":"MySQL/MySQL[ä¹]åŸºäºè§„åˆ™çš„ä¼˜åŒ–&å­æŸ¥è¯¢ä¼˜åŒ–","date":"2022-01-11T03:16:30.409Z","updated":"2022-01-11T03:23:03.085Z","comments":true,"path":"2022/01/11/MySQL/MySQL[ä¹]åŸºäºè§„åˆ™çš„ä¼˜åŒ–&å­æŸ¥è¯¢ä¼˜åŒ–/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E4%B9%9D]%E5%9F%BA%E4%BA%8E%E8%A7%84%E5%88%99%E7%9A%84%E4%BC%98%E5%8C%96&%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/","excerpt":"","text":"MySQLä¾æ®ä¸€äº›è§„åˆ™ï¼ŒæŠŠè¯­å¥è½¬æ¢æˆæŸç§å¯ä»¥æ¯”è¾ƒé«˜æ•ˆæ‰§è¡Œçš„å½¢å¼ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿå¯ä»¥è¢«ç§°ä½œæŸ¥è¯¢é‡å†™ã€‚ 1.æ¡ä»¶åŒ–ç®€æˆ‘ä»¬ç¼–å†™çš„æŸ¥è¯¢è¯­å¥çš„æœç´¢æ¡ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¿™äº›è¡¨è¾¾å¼å¯èƒ½æ¯”è¾ƒç¹æ‚ï¼Œæˆ–è€…ä¸èƒ½é«˜æ•ˆçš„æ‰§è¡Œï¼ŒMySQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šä¸ºæˆ‘ä»¬ç®€åŒ–è¿™äº›è¡¨è¾¾å¼ã€‚ 1.1ç§»é™¤ä¸å¿…è¦çš„æ‹¬å·æœ‰æ—¶å€™è¡¨è¾¾å¼é‡Œæœ‰è®¸å¤šæ— ç”¨çš„æ‹¬å·ï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1((a = 5 AND b = c) OR ((a &gt; c) AND (c &lt; 5))) ä¼˜åŒ–å™¨ä¼šæŠŠé‚£äº›ç”¨ä¸åˆ°çš„æ‹¬å·ç»™å¹²æ‰ï¼Œå°±æ˜¯è¿™æ ·ï¼š 1(a = 5 and b = c) OR (a &gt; c AND c &lt; 5) 1.2å¸¸é‡ä¼ é€’æœ‰æ—¶å€™æŸä¸ªè¡¨è¾¾å¼æ˜¯æŸä¸ªåˆ—å’ŒæŸä¸ªå¸¸é‡åšç­‰å€¼åŒ¹é…ï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1a = 5 å½“è¿™ä¸ªè¡¨è¾¾å¼å’Œå…¶ä»–æ¶‰åŠåˆ—açš„è¡¨è¾¾å¼ä½¿ç”¨ANDè¿æ¥èµ·æ¥æ—¶ï¼Œå¯ä»¥å°†å…¶ä»–è¡¨è¾¾å¼ä¸­çš„açš„å€¼æ›¿æ¢ä¸º5ï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1a = 5 AND b &gt; a å°±å¯ä»¥è¢«è½¬æ¢ä¸ºï¼š 1a = 5 AND b &gt; 5 ç”¨ORçš„è¡¨è¾¾å¼ä¸èƒ½è¿›è¡Œèƒ½é‡ä¼ é€’æ˜¯å› ä¸ºORä¸¤è¾¹çš„æ¡ä»¶æ˜¯å–å¹¶é›†çš„ï¼Œæˆ–è€…è¯´äº’ä¸ç›¸å…³ã€‚ 1.3 ç­‰å€¼ä¼ é€’æœ‰æ—¶å€™å¤šä¸ªåˆ—ä¹‹é—´å­˜åœ¨ç­‰å€¼åŒ¹é…çš„å…³ç³»ï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1a = b and b = c and c = 5 è¿™ä¸ªè¡¨è¾¾å¼å¯ä»¥è¢«ç®€åŒ–ä¸ºï¼š 1a = 5 and b = 5 and c = 5 1.4ç§»é™¤æ²¡ç”¨çš„æ¡ä»¶å¯¹äºä¸€äº›æ˜æ˜¾æ°¸è¿œä¸ºTRUEæˆ–è€…FALSEçš„è¡¨è¾¾å¼ï¼Œä¼˜åŒ–å™¨ä¼šç§»é™¤æ‰å®ƒä»¬ï¼Œæ¯”å¦‚è¿™ä¸ªè¡¨è¾¾å¼ï¼š 1(a &lt; 1 and b = b) OR (a = 6 OR 5 != 5) å¾ˆæ˜æ˜¾ï¼Œb = bè¿™ä¸ªè¡¨è¾¾å¼æ°¸è¿œä¸ºTRUEï¼Œ5 != 5è¿™ä¸ªè¡¨è¾¾å¼æ°¸è¿œä¸ºFALSEï¼Œæ‰€ä»¥ç®€åŒ–åçš„è¡¨è¾¾å¼å°±æ˜¯è¿™æ ·çš„ï¼š 1(a &lt; 1 and TRUE) OR (a = 6 OR FALSE) å¯ä»¥ç»§ç»­è¢«ç®€åŒ–ä¸º 1a &lt; 1 OR a = 6 1.5è¡¨è¾¾å¼è®¡ç®—åœ¨æŸ¥è¯¢å¼€å§‹æ‰§è¡Œä¹‹å‰ï¼Œå¦‚æœè¡¨è¾¾å¼ä¸­åªåŒ…å«å¸¸é‡çš„è¯ï¼Œå®ƒçš„å€¼ä¼šè¢«å…ˆè®¡ç®—å‡ºæ¥ï¼Œæ¯”å¦‚è¿™ä¸ªï¼š 1a = 5 + 1 å› ä¸º5 + 1è¿™ä¸ªè¡¨è¾¾å¼åªåŒ…å«å¸¸é‡ï¼Œæ‰€ä»¥å°±ä¼šè¢«åŒ–ç®€æˆï¼š 1a = 6 ä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæŸä¸ªåˆ—å¹¶ä¸æ˜¯ä»¥å•ç‹¬çš„å½¢å¼ä½œä¸ºè¡¨è¾¾å¼çš„æ“ä½œæ•°æ—¶ï¼Œæ¯”å¦‚å‡ºç°åœ¨å‡½æ•°ä¸­ï¼Œå‡ºç°åœ¨æŸä¸ªæ›´å¤æ‚è¡¨è¾¾å¼ä¸­ï¼Œå°±åƒè¿™æ ·ï¼š 1ABS(a) &gt; 5 æˆ–è€…ï¼š 1-a &lt; -8 ä¼˜åŒ–å™¨æ˜¯ä¸ä¼šå°è¯•å¯¹è¿™äº›è¡¨è¾¾å¼è¿›è¡ŒåŒ–ç®€çš„ã€‚æˆ‘ä»¬å‰è¾¹è¯´è¿‡åªæœ‰æœç´¢æ¡ä»¶ä¸­ç´¢å¼•åˆ—å’Œå¸¸æ•°ä½¿ç”¨æŸäº›è¿ç®—ç¬¦è¿æ¥èµ·æ¥æ‰å¯èƒ½ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œæ‰€ä»¥å¦‚æœå¯ä»¥çš„è¯ï¼Œæœ€å¥½è®©ç´¢å¼•åˆ—ä»¥å•ç‹¬çš„å½¢å¼å‡ºç°åœ¨è¡¨è¾¾å¼ä¸­ã€‚ 1.6HAVING&amp;WHEREå­å¥çš„åˆå¹¶å¦‚æœæŸ¥è¯¢è¯­å¥ä¸­æ²¡æœ‰å‡ºç°è¯¸å¦‚SUMã€MAXç­‰ç­‰çš„èšé›†å‡½æ•°ä»¥åŠGROUP BYå­å¥ï¼Œä¼˜åŒ–å™¨å°±æŠŠHAVINGå­å¥å’ŒWHEREå­å¥åˆå¹¶èµ·æ¥ã€‚ 1.7å¸¸é‡è¡¨æ£€æµ‹MySQLè§‰å¾—ä¸‹è¾¹è¿™ä¸¤ç§æŸ¥è¯¢è¿è¡Œçš„ç‰¹åˆ«å¿«ï¼š æŸ¥è¯¢çš„è¡¨ä¸­ä¸€æ¡è®°å½•æ²¡æœ‰ï¼Œæˆ–è€…åªæœ‰ä¸€æ¡è®°å½•ã€‚ ä½¿ç”¨ä¸»é”®ç­‰å€¼åŒ¹é…æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—ç­‰å€¼åŒ¹é…ä½œä¸ºæœç´¢æ¡ä»¶æ¥æŸ¥è¯¢æŸä¸ªè¡¨ã€‚ MySQLè§‰å¾—è¿™ä¸¤ç§æŸ¥è¯¢èŠ±è´¹çš„æ—¶é—´ç‰¹åˆ«å°‘ï¼Œå°‘åˆ°å¯ä»¥å¿½ç•¥ï¼Œæ‰€ä»¥ä¹ŸæŠŠé€šè¿‡è¿™ä¸¤ç§æ–¹å¼æŸ¥è¯¢çš„è¡¨ç§°ä¹‹ä¸ºå¸¸é‡è¡¨ï¼ˆè‹±æ–‡åï¼šconstant tablesï¼‰ã€‚ä¼˜åŒ–å™¨åœ¨åˆ†æä¸€ä¸ªæŸ¥è¯¢è¯­å¥æ—¶ï¼Œå…ˆé¦–å…ˆæ‰§è¡Œå¸¸é‡è¡¨æŸ¥è¯¢ï¼Œç„¶åæŠŠæŸ¥è¯¢ä¸­æ¶‰åŠåˆ°è¯¥è¡¨çš„æ¡ä»¶å…¨éƒ¨æ›¿æ¢æˆå¸¸æ•°ï¼Œæœ€åå†åˆ†æå…¶ä½™è¡¨çš„æŸ¥è¯¢æˆæœ¬ï¼Œæ¯”æ–¹è¯´è¿™ä¸ªæŸ¥è¯¢è¯­å¥ï¼š 123SELECT * FROM table1 INNER JOIN table2 ON table1.column1 = table2.column2 WHERE table1.primary_key = 1; å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªæŸ¥è¯¢å¯ä»¥ä½¿ç”¨ä¸»é”®å’Œå¸¸é‡å€¼çš„ç­‰å€¼åŒ¹é…æ¥æŸ¥è¯¢table1è¡¨ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸­table1è¡¨ç›¸å½“äºå¸¸é‡è¡¨ï¼Œåœ¨åˆ†æå¯¹table2è¡¨çš„æŸ¥è¯¢æˆæœ¬ä¹‹å‰ï¼Œå°±ä¼šæ‰§è¡Œå¯¹table1è¡¨çš„æŸ¥è¯¢ï¼Œå¹¶æŠŠæŸ¥è¯¢ä¸­æ¶‰åŠtable1è¡¨çš„æ¡ä»¶éƒ½æ›¿æ¢æ‰ï¼Œä¹Ÿå°±æ˜¯ä¸Šè¾¹çš„è¯­å¥ä¼šè¢«è½¬æ¢æˆè¿™æ ·ï¼š 12SELECT table1è¡¨è®°å½•çš„å„ä¸ªå­—æ®µçš„å¸¸é‡å€¼, table2.* FROM table1 INNER JOIN table2 ON table1è¡¨column1åˆ—çš„å¸¸é‡å€¼ = table2.column2; 2.å¤–è¿æ¥æ¶ˆé™¤å†…è¿æ¥çš„é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨çš„ä½ç½®å¯ä»¥ç›¸äº’è½¬æ¢ï¼Œè€Œå·¦ï¼ˆå¤–ï¼‰è¿æ¥å’Œå³ï¼ˆå¤–ï¼‰è¿æ¥çš„é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨æ˜¯å›ºå®šçš„ã€‚è¿™å°±å¯¼è‡´å†…è¿æ¥å¯èƒ½é€šè¿‡ä¼˜åŒ–è¡¨çš„è¿æ¥é¡ºåºæ¥é™ä½æ•´ä½“çš„æŸ¥è¯¢æˆæœ¬ï¼Œè€Œå¤–è¿æ¥å´æ— æ³•ä¼˜åŒ–è¡¨çš„è¿æ¥é¡ºåºã€‚æˆ‘åœ¨ä¹‹å‰çš„æ–‡ç« åˆ›å»ºäº†ä¸¤ä¸ªè¡¨ï¼š 123456789CREATE TABLE t1 ( m1 int, n1 char(1)) Engine=InnoDB, CHARSET=utf8;CREATE TABLE t2 ( m2 int, n2 char(1)) Engine=InnoDB, CHARSET=utf8; å†çœ‹ä¸€ä¸‹è¡¨çš„æ•°æ® 12345678910111213141516171819mysql&gt; SELECT * FROM t1;+------+------+| m1 | n1 |+------+------+| 1 | a || 2 | b || 3 | c |+------+------+3 rows in set (0.00 sec)mysql&gt; SELECT * FROM t2;+------+------+| m2 | n2 |+------+------+| 2 | b || 3 | c || 4 | d |+------+------+3 rows in set (0.00 sec) å¤–è¿æ¥å’Œå†…è¿æ¥çš„æœ¬è´¨åŒºåˆ«å°±æ˜¯ï¼šå¯¹äºå¤–è¿æ¥çš„é©±åŠ¨è¡¨çš„è®°å½•æ¥è¯´ï¼Œå¦‚æœæ— æ³•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾åˆ°åŒ¹é…ONå­å¥ä¸­çš„è¿‡æ»¤æ¡ä»¶çš„è®°å½•ï¼Œé‚£ä¹ˆè¯¥è®°å½•ä»ç„¶ä¼šè¢«åŠ å…¥åˆ°ç»“æœé›†ä¸­ï¼Œå¯¹åº”çš„è¢«é©±åŠ¨è¡¨è®°å½•çš„å„ä¸ªå­—æ®µä½¿ç”¨NULLå€¼å¡«å……ï¼›è€Œå†…è¿æ¥çš„é©±åŠ¨è¡¨çš„è®°å½•å¦‚æœæ— æ³•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾åˆ°åŒ¹é…ONå­å¥ä¸­çš„è¿‡æ»¤æ¡ä»¶çš„è®°å½•ï¼Œé‚£ä¹ˆè¯¥è®°å½•ä¼šè¢«èˆå¼ƒã€‚æŸ¥è¯¢æ•ˆæœå°±æ˜¯è¿™æ ·ï¼š 123456789101112131415161718mysql&gt; SELECT * FROM t1 INNER JOIN t2 ON t1.m1 = t2.m2;+------+------+------+------+| m1 | n1 | m2 | n2 |+------+------+------+------+| 2 | b | 2 | b || 3 | c | 3 | c |+------+------+------+------+2 rows in set (0.00 sec)mysql&gt; SELECT * FROM t1 LEFT JOIN t2 ON t1.m1 = t2.m2;+------+------+------+------+| m1 | n1 | m2 | n2 |+------+------+------+------+| 2 | b | 2 | b || 3 | c | 3 | c || 1 | a | NULL | NULL |+------+------+------+------+3 rows in set (0.00 sec) å¯¹äºä¸Šè¾¹ä¾‹å­ä¸­çš„ï¼ˆå·¦ï¼‰å¤–è¿æ¥æ¥è¯´ï¼Œç”±äºé©±åŠ¨è¡¨t1ä¸­m1=1, n1=&#39;a&#39;çš„è®°å½•æ— æ³•åœ¨è¢«é©±åŠ¨è¡¨t2ä¸­æ‰¾åˆ°ç¬¦åˆONå­å¥æ¡ä»¶t1.m1 = t2.m2çš„è®°å½•ï¼Œæ‰€ä»¥å°±ç›´æ¥æŠŠè¿™æ¡è®°å½•åŠ å…¥åˆ°ç»“æœé›†ï¼Œå¯¹åº”çš„t2è¡¨çš„m2å’Œn2åˆ—çš„å€¼éƒ½è®¾ç½®ä¸ºNULLã€‚ å³ï¼ˆå¤–ï¼‰è¿æ¥å’Œå·¦ï¼ˆå¤–ï¼‰è¿æ¥å…¶å®åªåœ¨é©±åŠ¨è¡¨çš„é€‰å–æ–¹å¼ä¸Šæ˜¯ä¸åŒçš„ï¼Œå…¶ä½™æ–¹é¢éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ä¼˜åŒ–å™¨ä¼šé¦–å…ˆæŠŠå³ï¼ˆå¤–ï¼‰è¿æ¥æŸ¥è¯¢è½¬æ¢æˆå·¦ï¼ˆå¤–ï¼‰è¿æ¥æŸ¥è¯¢ã€‚ å‡¡æ˜¯ä¸ç¬¦åˆWHEREå­å¥ä¸­æ¡ä»¶çš„è®°å½•éƒ½ä¸ä¼šå‚ä¸è¿æ¥ã€‚åªè¦æˆ‘ä»¬åœ¨æœç´¢æ¡ä»¶ä¸­æŒ‡å®šå…³äºè¢«é©±åŠ¨è¡¨ç›¸å…³åˆ—çš„å€¼ä¸ä¸ºNULLï¼Œé‚£ä¹ˆå¤–è¿æ¥ä¸­åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾ä¸åˆ°ç¬¦åˆONå­å¥æ¡ä»¶çš„é©±åŠ¨è¡¨è®°å½•ä¹Ÿå°±è¢«æ’é™¤å‡ºæœ€åçš„ç»“æœé›†äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šåœ¨è¿™ç§æƒ…å†µä¸‹ï¼šå¤–è¿æ¥å’Œå†…è¿æ¥ä¹Ÿå°±æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«äº†ï¼æ¯”æ–¹è¯´è¿™ä¸ªæŸ¥è¯¢ï¼š 12345678mysql&gt; SELECT * FROM t1 LEFT JOIN t2 ON t1.m1 = t2.m2 WHERE t2.n2 IS NOT NULL;+------+------+------+------+| m1 | n1 | m2 | n2 |+------+------+------+------+| 2 | b | 2 | b || 3 | c | 3 | c |+------+------+------+------+2 rows in set (0.01 sec) ç”±äºæŒ‡å®šäº†è¢«é©±åŠ¨è¡¨t2çš„n2åˆ—ä¸å…è®¸ä¸ºNULLï¼Œæ‰€ä»¥ä¸Šè¾¹çš„t1å’Œt2è¡¨çš„å·¦ï¼ˆå¤–ï¼‰è¿æ¥æŸ¥è¯¢å’Œå†…è¿æ¥æŸ¥è¯¢æ˜¯ä¸€æ ·ä¸€æ ·çš„ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ç”¨æ˜¾å¼çš„æŒ‡å®šè¢«é©±åŠ¨è¡¨çš„æŸä¸ªåˆ—IS NOT NULLï¼Œåªè¦éšå«çš„æœ‰è¿™ä¸ªæ„æ€å°±è¡Œäº†ï¼Œæ¯”æ–¹è¯´è¿™æ ·ï¼š 1234567mysql&gt; SELECT * FROM t1 LEFT JOIN t2 ON t1.m1 = t2.m2 WHERE t2.m2 = 2;+------+------+------+------+| m1 | n1 | m2 | n2 |+------+------+------+------+| 2 | b | 2 | b |+------+------+------+------+1 row in set (0.00 sec) åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨WHEREå­å¥ä¸­æŒ‡å®šäº†è¢«é©±åŠ¨è¡¨t2çš„m2åˆ—ç­‰äº2ï¼Œä¹Ÿå°±ç›¸å½“äºé—´æ¥çš„æŒ‡å®šäº†m2åˆ—ä¸ä¸ºNULLå€¼ï¼Œæ‰€ä»¥ä¸Šè¾¹çš„è¿™ä¸ªå·¦ï¼ˆå¤–ï¼‰è¿æ¥æŸ¥è¯¢å…¶å®å’Œä¸‹è¾¹è¿™ä¸ªå†…è¿æ¥æŸ¥è¯¢æ˜¯ç­‰ä»·çš„ï¼š 1234567mysql&gt; SELECT * FROM t1 INNER JOIN t2 ON t1.m1 = t2.m2 WHERE t2.m2 = 2;+------+------+------+------+| m1 | n1 | m2 | n2 |+------+------+------+------+| 2 | b | 2 | b |+------+------+------+------+1 row in set (0.00 sec) æˆ‘ä»¬æŠŠè¿™ç§åœ¨å¤–è¿æ¥æŸ¥è¯¢ä¸­ï¼ŒæŒ‡å®šçš„WHEREå­å¥ä¸­åŒ…å«è¢«é©±åŠ¨è¡¨ä¸­çš„åˆ—ä¸ä¸ºNULLå€¼çš„æ¡ä»¶ç§°ä¹‹ä¸ºç©ºå€¼æ‹’ç»ï¼ˆè‹±æ–‡åï¼šreject-NULLï¼‰ã€‚åœ¨è¢«é©±åŠ¨è¡¨çš„WHEREå­å¥ç¬¦åˆç©ºå€¼æ‹’ç»çš„æ¡ä»¶åï¼Œå¤–è¿æ¥å’Œå†…è¿æ¥å¯ä»¥ç›¸äº’è½¬æ¢ã€‚è¿™ç§è½¬æ¢å¸¦æ¥çš„å¥½å¤„å°±æ˜¯æŸ¥è¯¢ä¼˜åŒ–å™¨å¯ä»¥é€šè¿‡è¯„ä¼°è¡¨çš„ä¸åŒè¿æ¥é¡ºåºçš„æˆæœ¬ï¼Œé€‰å‡ºæˆæœ¬æœ€ä½çš„é‚£ç§è¿æ¥é¡ºåºæ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚ 3.å­æŸ¥è¯¢ä¼˜åŒ–3.1å­æŸ¥è¯¢è¯­æ³•3.1.1æŒ‰è¿”å›çš„ç»“æœé›†åŒºåˆ†å­æŸ¥è¯¢å› ä¸ºå­æŸ¥è¯¢æœ¬èº«ä¹Ÿç®—æ˜¯ä¸€ä¸ªæŸ¥è¯¢ï¼Œæ‰€ä»¥å¯ä»¥æŒ‰ç…§å®ƒä»¬è¿”å›çš„ä¸åŒç»“æœé›†ç±»å‹è€ŒæŠŠè¿™äº›å­æŸ¥è¯¢åˆ†ä¸ºä¸åŒçš„ç±»å‹ï¼š æ ‡é‡å­æŸ¥è¯¢é‚£äº›åªè¿”å›ä¸€ä¸ªå•ä¸€å€¼çš„å­æŸ¥è¯¢ç§°ä¹‹ä¸ºæ ‡é‡å­æŸ¥è¯¢ï¼Œæ¯”å¦‚è¿™æ ·ï¼šæˆ–è€…è¿™æ ·ï¼šè¿™ä¸¤ä¸ªæŸ¥è¯¢è¯­å¥ä¸­çš„å­æŸ¥è¯¢éƒ½è¿”å›ä¸€ä¸ªå•ä¸€çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ ‡é‡ã€‚è¿™äº›æ ‡é‡å­æŸ¥è¯¢å¯ä»¥ä½œä¸ºä¸€ä¸ªå•ä¸€å€¼æˆ–è€…è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†å‡ºç°åœ¨æŸ¥è¯¢è¯­å¥çš„å„ä¸ªåœ°æ–¹ã€‚ 1SELECT (SELECT m1 FROM t1 LIMIT 1); 1SELECT * FROM t1 WHERE m1 = (SELECT MIN(m2) FROM t2); è¡Œå­æŸ¥è¯¢é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è¿”å›ä¸€æ¡è®°å½•çš„å­æŸ¥è¯¢ï¼Œä¸è¿‡è¿™æ¡è®°å½•éœ€è¦åŒ…å«å¤šä¸ªåˆ—ï¼ˆåªåŒ…å«ä¸€ä¸ªåˆ—å°±æˆäº†æ ‡é‡å­æŸ¥è¯¢äº†ï¼‰ã€‚æ¯”å¦‚è¿™æ ·ï¼šå…¶ä¸­çš„(SELECT m2, n2 FROM t2 LIMIT 1)å°±æ˜¯ä¸€ä¸ªè¡Œå­æŸ¥è¯¢ï¼Œæ•´æ¡è¯­å¥çš„å«ä¹‰å°±æ˜¯è¦ä»t1è¡¨ä¸­æ‰¾ä¸€äº›è®°å½•ï¼Œè¿™äº›è®°å½•çš„m1å’Œn1åˆ—åˆ†åˆ«ç­‰äºå­æŸ¥è¯¢ç»“æœä¸­çš„m2å’Œn2åˆ—ã€‚ 1SELECT * FROM t1 WHERE (m1, n1) = (SELECT m2, n2 FROM t2 LIMIT 1); åˆ—å­æŸ¥è¯¢åˆ—å­æŸ¥è¯¢è‡ªç„¶å°±æ˜¯æŸ¥è¯¢å‡ºä¸€ä¸ªåˆ—çš„æ•°æ®å–½ï¼Œä¸è¿‡è¿™ä¸ªåˆ—çš„æ•°æ®éœ€è¦åŒ…å«å¤šæ¡è®°å½•ï¼ˆåªåŒ…å«ä¸€æ¡è®°å½•å°±æˆäº†æ ‡é‡å­æŸ¥è¯¢äº†ï¼‰ã€‚æ¯”å¦‚è¿™æ ·ï¼šå…¶ä¸­çš„(SELECT m2 FROM t2)å°±æ˜¯ä¸€ä¸ªåˆ—å­æŸ¥è¯¢ï¼Œè¡¨æ˜æŸ¥è¯¢å‡ºt2è¡¨çš„m2åˆ—çš„å€¼ä½œä¸ºå¤–å±‚æŸ¥è¯¢INè¯­å¥çš„å‚æ•°ã€‚ 1SELECT * FROM t1 WHERE m1 IN (SELECT m2 FROM t2); è¡¨å­æŸ¥è¯¢é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å­æŸ¥è¯¢çš„ç»“æœæ—¢åŒ…å«å¾ˆå¤šæ¡è®°å½•ï¼ŒåˆåŒ…å«å¾ˆå¤šä¸ªåˆ—ï¼Œæ¯”å¦‚è¿™æ ·ï¼šå…¶ä¸­çš„(SELECT m2, n2 FROM t2)å°±æ˜¯ä¸€ä¸ªè¡¨å­æŸ¥è¯¢ï¼Œè¿™é‡Œéœ€è¦å’Œè¡Œå­æŸ¥è¯¢å¯¹æ¯”ä¸€ä¸‹ï¼Œè¡Œå­æŸ¥è¯¢ä¸­æˆ‘ä»¬ç”¨äº†LIMIT 1æ¥ä¿è¯å­æŸ¥è¯¢çš„ç»“æœåªæœ‰ä¸€æ¡è®°å½•ï¼Œè¡¨å­æŸ¥è¯¢ä¸­ä¸éœ€è¦è¿™ä¸ªé™åˆ¶ã€‚ 1SELECT * FROM t1 WHERE (m1, n1) IN (SELECT m2, n2 FROM t2); 3.1.2æŒ‰ä¸å¤–å±‚æŸ¥è¯¢å…³ç³»æ¥åŒºåˆ†å­æŸ¥è¯¢ ä¸ç›¸å…³å­æŸ¥è¯¢å¦‚æœå­æŸ¥è¯¢å¯ä»¥å•ç‹¬è¿è¡Œå‡ºç»“æœï¼Œè€Œä¸ä¾èµ–äºå¤–å±‚æŸ¥è¯¢çš„å€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠè¿™ä¸ªå­æŸ¥è¯¢ç§°ä¹‹ä¸ºä¸ç›¸å…³å­æŸ¥è¯¢ã€‚æˆ‘ä»¬å‰è¾¹ä»‹ç»çš„é‚£äº›å­æŸ¥è¯¢å…¨éƒ¨éƒ½å¯ä»¥çœ‹ä½œä¸ç›¸å…³å­æŸ¥è¯¢ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸ä¸¾ä¾‹å­äº†å“ˆã€‚ ç›¸å…³å­æŸ¥è¯¢å¦‚æœå­æŸ¥è¯¢çš„æ‰§è¡Œéœ€è¦ä¾èµ–äºå¤–å±‚æŸ¥è¯¢çš„å€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠè¿™ä¸ªå­æŸ¥è¯¢ç§°ä¹‹ä¸ºç›¸å…³å­æŸ¥è¯¢ã€‚æ¯”å¦‚ï¼šä¾‹å­ä¸­çš„å­æŸ¥è¯¢æ˜¯(SELECT m2 FROM t2 WHERE n1 = n2)ï¼Œå¯æ˜¯è¿™ä¸ªæŸ¥è¯¢ä¸­æœ‰ä¸€ä¸ªæœç´¢æ¡ä»¶æ˜¯n1 = n2ï¼Œåˆ«å¿˜äº†n1æ˜¯è¡¨t1çš„åˆ—ï¼Œä¹Ÿå°±æ˜¯å¤–å±‚æŸ¥è¯¢çš„åˆ—ï¼Œä¹Ÿå°±æ˜¯è¯´å­æŸ¥è¯¢çš„æ‰§è¡Œéœ€è¦ä¾èµ–äºå¤–å±‚æŸ¥è¯¢çš„å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªå­æŸ¥è¯¢å°±æ˜¯ä¸€ä¸ªç›¸å…³å­æŸ¥è¯¢ã€‚ 1SELECT * FROM t1 WHERE m1 IN (SELECT m2 FROM t2 WHERE n1 = n2); 3.1.3 å­æŸ¥è¯¢è¯­æ³•æ³¨æ„äº‹é¡¹ å­æŸ¥è¯¢å¿…é¡»ç”¨å°æ‹¬å·æ‰©èµ·æ¥ã€‚ åœ¨SELECTå­å¥ä¸­çš„å­æŸ¥è¯¢å¿…é¡»æ˜¯æ ‡é‡å­æŸ¥è¯¢ã€‚ åœ¨æƒ³è¦å¾—åˆ°æ ‡é‡å­æŸ¥è¯¢æˆ–è€…è¡Œå­æŸ¥è¯¢ï¼Œä½†åˆä¸èƒ½ä¿è¯å­æŸ¥è¯¢çš„ç»“æœé›†åªæœ‰ä¸€æ¡è®°å½•æ—¶ï¼Œåº”è¯¥ä½¿ç”¨LIMIT 1è¯­å¥æ¥é™åˆ¶è®°å½•æ•°é‡ã€‚ å¯¹äº[NOT] IN/ANY/SOME/ALLå­æŸ¥è¯¢æ¥è¯´ï¼Œå­æŸ¥è¯¢ä¸­ä¸å…è®¸æœ‰LIMITè¯­å¥ã€‚æ¯”å¦‚è¿™æ ·æ˜¯éæ³•çš„ï¼šå› ä¸º[NOT] IN/ANY/SOME/ALLå­æŸ¥è¯¢ä¸æ”¯æŒLIMITè¯­å¥ï¼Œæ‰€ä»¥å­æŸ¥è¯¢ä¸­çš„è¿™äº›è¯­å¥ä¹Ÿå°±æ˜¯å¤šä½™çš„äº†ï¼š 1mysql&gt; SELECT * FROM t1 WHERE m1 IN (SELECT * FROM t2 LIMIT 2); ORDER BYå­å¥ï¼šå­æŸ¥è¯¢çš„ç»“æœå…¶å®å°±ç›¸å½“äºä¸€ä¸ªé›†åˆï¼Œé›†åˆé‡Œçš„å€¼æ’ä¸æ’åºä¸€ç‚¹å„¿éƒ½ä¸é‡è¦ã€‚ DISTINCTè¯­å¥ï¼šé›†åˆé‡Œçš„å€¼å»ä¸å»é‡ä¹Ÿæ²¡å•¥æ„ä¹‰ã€‚ æ²¡æœ‰èšé›†å‡½æ•°ä»¥åŠHAVINGå­å¥çš„GROUP BYå­å¥ã€‚ å¯¹äºè¿™äº›å†—ä½™çš„è¯­å¥ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨åœ¨ä¸€å¼€å§‹å°±æŠŠå®ƒä»¬ç»™å¹²æ‰äº†ã€‚ ä¸å…è®¸åœ¨ä¸€æ¡è¯­å¥ä¸­å¢åˆ æ”¹æŸä¸ªè¡¨çš„è®°å½•æ—¶åŒæ—¶è¿˜å¯¹è¯¥è¡¨è¿›è¡Œå­æŸ¥è¯¢ã€‚ 1mysql&gt; DELETE FROM t1 WHERE m1 &lt; (SELECT MAX(m1) FROM t1); 3.2 å­æŸ¥è¯¢çš„æ‰§è¡Œè¿˜æ˜¯å¤ç”¨å‰é¢çš„è¡¨ï¼š 123456789101112131415CREATE TABLE single_table ( id INT NOT NULL AUTO_INCREMENT, key1 VARCHAR(100), key2 INT, key3 VARCHAR(100), key_part1 VARCHAR(100), key_part2 VARCHAR(100), key_part3 VARCHAR(100), common_field VARCHAR(100), PRIMARY KEY (id), KEY idx_key1 (key1), UNIQUE KEY idx_key2 (key2), KEY idx_key3 (key3), KEY idx_key_part(key_part1, key_part2, key_part3)) Engine=InnoDB CHARSET=utf8; æˆ‘ä»¬å‡è®¾æœ‰ä¸¤ä¸ªè¡¨s1ã€s2ä¸è¿™ä¸ªsingle_tableè¡¨çš„æ„é€ æ˜¯ç›¸åŒçš„ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªè¡¨é‡Œè¾¹å„¿æœ‰10000æ¡è®°å½•ã€‚ 3.2.1 æ ‡é‡/è¡Œå­æŸ¥è¯¢çš„æ‰§è¡Œæ–¹å¼æˆ‘ä»¬ç»å¸¸åœ¨ä¸‹è¾¹ä¸¤ä¸ªåœºæ™¯ä¸­ä½¿ç”¨åˆ°æ ‡é‡å­æŸ¥è¯¢æˆ–è€…è¡Œå­æŸ¥è¯¢ï¼š SELECTå­å¥ä¸­ï¼Œæˆ‘ä»¬å‰è¾¹è¯´è¿‡çš„åœ¨æŸ¥è¯¢åˆ—è¡¨ä¸­çš„å­æŸ¥è¯¢å¿…é¡»æ˜¯æ ‡é‡å­æŸ¥è¯¢ã€‚ å­æŸ¥è¯¢ä½¿ç”¨=ã€&gt;ã€&lt;ã€&gt;=ã€&lt;=ã€&lt;&gt;ã€!=ã€&lt;=&gt;ç­‰æ“ä½œç¬¦å’ŒæŸä¸ªæ“ä½œæ•°ç»„æˆä¸€ä¸ªå¸ƒå°”è¡¨è¾¾å¼ï¼Œè¿™æ ·çš„å­æŸ¥è¯¢å¿…é¡»æ˜¯æ ‡é‡å­æŸ¥è¯¢æˆ–è€…è¡Œå­æŸ¥è¯¢ã€‚ å¯¹äºä¸Šè¿°ä¸¤ç§åœºæ™¯ä¸­çš„ä¸ç›¸å…³æ ‡é‡å­æŸ¥è¯¢æˆ–è€…è¡Œå­æŸ¥è¯¢æ¥è¯´ï¼Œå®ƒä»¬çš„æ‰§è¡Œæ–¹å¼æ˜¯ç®€å•çš„ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢è¯­å¥ï¼š 12SELECT * FROM s1 WHERE key1 = (SELECT common_field FROM s2 WHERE key3 = &#x27;a&#x27; LIMIT 1); å…ˆå•ç‹¬æ‰§è¡Œ(SELECT common_field FROM s2 WHERE key3 = &#39;a&#39; LIMIT 1)è¿™ä¸ªå­æŸ¥è¯¢ã€‚ ç„¶ååœ¨å°†ä¸Šä¸€æ­¥å­æŸ¥è¯¢å¾—åˆ°çš„ç»“æœå½“ä½œå¤–å±‚æŸ¥è¯¢çš„å‚æ•°å†æ‰§è¡Œå¤–å±‚æŸ¥è¯¢SELECT * FROM s1 WHERE key1 = ...ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºåŒ…å«ä¸ç›¸å…³çš„æ ‡é‡å­æŸ¥è¯¢æˆ–è€…è¡Œå­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥æ¥è¯´ï¼ŒMySQLä¼šåˆ†åˆ«ç‹¬ç«‹çš„æ‰§è¡Œå¤–å±‚æŸ¥è¯¢å’Œå­æŸ¥è¯¢ï¼Œå°±å½“ä½œä¸¤ä¸ªå•è¡¨æŸ¥è¯¢å°±å¥½äº†ã€‚ å¯¹äºç›¸å…³çš„æ ‡é‡å­æŸ¥è¯¢æˆ–è€…è¡Œå­æŸ¥è¯¢æ¥è¯´ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š 12SELECT * FROM s1 WHERE key1 = (SELECT common_field FROM s2 WHERE s1.key3 = s2.key3 LIMIT 1); 3.2.2 INå­æŸ¥è¯¢ä¼˜åŒ–â‘  ç‰©åŒ–è¡¨çš„æå‡º12SELECT * FROM s1 WHERE key1 IN (SELECT common_field FROM s2 WHERE key3 = &#x27;a&#x27;); å¯¹äºä¸ç›¸å…³çš„INå­æŸ¥è¯¢æ¥è¯´ï¼Œå¦‚æœå­æŸ¥è¯¢çš„ç»“æœé›†ä¸­çš„è®°å½•æ¡æ•°å¾ˆå°‘ï¼Œé‚£ä¹ˆæŠŠå­æŸ¥è¯¢å’Œå¤–å±‚æŸ¥è¯¢åˆ†åˆ«çœ‹æˆä¸¤ä¸ªå•ç‹¬çš„å•è¡¨æŸ¥è¯¢æ•ˆç‡è¿˜è¡Œï¼Œä½†æ˜¯å¦‚æœå•ç‹¬æ‰§è¡Œå­æŸ¥è¯¢åçš„ç»“æœé›†å¤ªå¤šçš„è¯ï¼Œå°±ä¼šå¯¼è‡´è¿™äº›é—®é¢˜ï¼š ç»“æœé›†å¤ªå¤šï¼Œå¯èƒ½å†…å­˜ä¸­éƒ½æ”¾ä¸ä¸‹ã€‚ å¯¹äºå¤–å±‚æŸ¥è¯¢æ¥è¯´ï¼Œå¦‚æœå­æŸ¥è¯¢çš„ç»“æœé›†å¤ªå¤šï¼Œé‚£å°±æ„å‘³ç€INå­å¥ä¸­çš„å‚æ•°ç‰¹åˆ«å¤šï¼Œè¿™å°±å¯¼è‡´ï¼š æ— æ³•æœ‰æ•ˆçš„ä½¿ç”¨ç´¢å¼•ï¼Œåªèƒ½å¯¹å¤–å±‚æŸ¥è¯¢è¿›è¡Œå…¨è¡¨æ‰«æã€‚ åœ¨å¯¹å¤–å±‚æŸ¥è¯¢æ‰§è¡Œå…¨è¡¨æ‰«ææ—¶ï¼Œç”±äºINå­å¥ä¸­çš„å‚æ•°å¤ªå¤šï¼Œè¿™ä¼šå¯¼è‡´æ£€æµ‹ä¸€æ¡è®°å½•æ˜¯å¦ç¬¦åˆå’ŒINå­å¥ä¸­çš„å‚æ•°åŒ¹é…èŠ±è´¹çš„æ—¶é—´å¤ªé•¿ã€‚ æ‰€ä»¥MySQLå¹¶ä¸ç›´æ¥å°†ä¸ç›¸å…³å­æŸ¥è¯¢çš„ç»“æœé›†å½“ä½œå¤–å±‚æŸ¥è¯¢çš„å‚æ•°ï¼Œè€Œæ˜¯å°†è¯¥ç»“æœé›†å†™å…¥ä¸€ä¸ªä¸´æ—¶è¡¨é‡Œã€‚ è¯¥ä¸´æ—¶è¡¨çš„åˆ—å°±æ˜¯å­æŸ¥è¯¢ç»“æœé›†ä¸­çš„åˆ—ã€‚ å†™å…¥ä¸´æ—¶è¡¨çš„è®°å½•ä¼šè¢«å»é‡ã€‚æˆ‘ä»¬è¯´INè¯­å¥æ˜¯åˆ¤æ–­æŸä¸ªæ“ä½œæ•°åœ¨ä¸åœ¨æŸä¸ªé›†åˆä¸­ï¼Œé›†åˆä¸­çš„å€¼é‡ä¸é‡å¤å¯¹æ•´ä¸ªINè¯­å¥çš„ç»“æœå¹¶æ²¡æœ‰å½±å“ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å°†ç»“æœé›†å†™å…¥ä¸´æ—¶è¡¨æ—¶å¯¹è®°å½•è¿›è¡Œå»é‡å¯ä»¥è®©ä¸´æ—¶è¡¨å˜å¾—æ›´å°ã€‚ ä¸´æ—¶è¡¨å¦‚ä½•å¯¹è®°å½•è¿›è¡Œå»é‡ï¼Ÿåªè¦ä¸ºè¡¨ä¸­è®°å½•çš„æ‰€æœ‰åˆ—å»ºç«‹ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•å°±å¥½äº†å˜›ï½ ä¸€èˆ¬æƒ…å†µä¸‹å­æŸ¥è¯¢ç»“æœé›†ä¸ä¼šå¤§çš„ç¦»è°±ï¼Œæ‰€ä»¥ä¼šä¸ºå®ƒå»ºç«‹åŸºäºå†…å­˜çš„ä½¿ç”¨Memoryå­˜å‚¨å¼•æ“çš„ä¸´æ—¶è¡¨ï¼Œè€Œä¸”ä¼šä¸ºè¯¥è¡¨å»ºç«‹å“ˆå¸Œç´¢å¼•ã€‚å¦‚æœå­æŸ¥è¯¢çš„ç»“æœé›†éå¸¸å¤§ï¼Œè¶…è¿‡äº†ç³»ç»Ÿå˜é‡tmp_table_sizeæˆ–è€…max_heap_table_sizeï¼Œä¸´æ—¶è¡¨ä¼šè½¬è€Œä½¿ç”¨åŸºäºç£ç›˜çš„å­˜å‚¨å¼•æ“æ¥ä¿å­˜ç»“æœé›†ä¸­çš„è®°å½•ï¼Œç´¢å¼•ç±»å‹ä¹Ÿå¯¹åº”è½¬å˜ä¸ºB+æ ‘ç´¢å¼•ã€‚ INè¯­å¥çš„æœ¬è´¨å°±æ˜¯åˆ¤æ–­æŸä¸ªæ“ä½œæ•°åœ¨ä¸åœ¨æŸä¸ªé›†åˆé‡Œï¼Œå¦‚æœé›†åˆä¸­çš„æ•°æ®å»ºç«‹äº†å“ˆå¸Œç´¢å¼•ï¼Œé‚£ä¹ˆè¿™ä¸ªåŒ¹é…çš„è¿‡ç¨‹å°±æ˜¯è¶…çº§å¿«çš„ã€‚ MySQLæŠŠè¿™ä¸ªå°†å­æŸ¥è¯¢ç»“æœé›†ä¸­çš„è®°å½•ä¿å­˜åˆ°ä¸´æ—¶è¡¨çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºç‰©åŒ–ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å°±æŠŠé‚£ä¸ªå­˜å‚¨å­æŸ¥è¯¢ç»“æœé›†çš„ä¸´æ—¶è¡¨ç§°ä¹‹ä¸ºç‰©åŒ–è¡¨ã€‚æ­£å› ä¸ºç‰©åŒ–è¡¨ä¸­çš„è®°å½•éƒ½å»ºç«‹äº†ç´¢å¼•ï¼ˆåŸºäºå†…å­˜çš„ç‰©åŒ–è¡¨æœ‰å“ˆå¸Œç´¢å¼•ï¼ŒåŸºäºç£ç›˜çš„æœ‰B+æ ‘ç´¢å¼•ï¼‰ï¼Œé€šè¿‡ç´¢å¼•æ‰§è¡ŒINè¯­å¥åˆ¤æ–­æŸä¸ªæ“ä½œæ•°åœ¨ä¸åœ¨å­æŸ¥è¯¢ç»“æœé›†ä¸­å˜å¾—éå¸¸å¿«ï¼Œä»è€Œæå‡äº†å­æŸ¥è¯¢è¯­å¥çš„æ€§èƒ½ã€‚ â‘¡ ç‰©åŒ–è¡¨è½¬è¿æ¥å†çœ‹ä¸€ä¸‹æœ€å¼€å§‹çš„é‚£ä¸ªæŸ¥è¯¢è¯­å¥ï¼š 12SELECT * FROM s1 WHERE key1 IN (SELECT common_field FROM s2 WHERE key3 = &#x27;a&#x27;); å½“æˆ‘ä»¬æŠŠå­æŸ¥è¯¢è¿›è¡Œç‰©åŒ–ä¹‹åï¼Œå‡è®¾å­æŸ¥è¯¢ç‰©åŒ–è¡¨çš„åç§°ä¸ºmaterialized_tableï¼Œè¯¥ç‰©åŒ–è¡¨å­˜å‚¨çš„å­æŸ¥è¯¢ç»“æœé›†çš„åˆ—ä¸ºm_valï¼Œé‚£ä¹ˆè¿™ä¸ªæŸ¥è¯¢å…¶å®å¯ä»¥ä»ä¸‹è¾¹ä¸¤ç§è§’åº¦æ¥çœ‹å¾…ï¼š ä»è¡¨s1çš„è§’åº¦æ¥çœ‹å¾…ï¼Œæ•´ä¸ªæŸ¥è¯¢çš„æ„æ€å…¶å®æ˜¯ï¼šå¯¹äºs1è¡¨ä¸­çš„æ¯æ¡è®°å½•æ¥è¯´ï¼Œå¦‚æœè¯¥è®°å½•çš„key1åˆ—çš„å€¼åœ¨å­æŸ¥è¯¢å¯¹åº”çš„ç‰©åŒ–è¡¨ä¸­ï¼Œåˆ™è¯¥è®°å½•ä¼šè¢«åŠ å…¥æœ€ç»ˆçš„ç»“æœé›†ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹å°±æ˜¯è¿™æ ·ï¼š ä»å­æŸ¥è¯¢ç‰©åŒ–è¡¨çš„è§’åº¦æ¥çœ‹å¾…ï¼Œæ•´ä¸ªæŸ¥è¯¢çš„æ„æ€å…¶å®æ˜¯ï¼šå¯¹äºå­æŸ¥è¯¢ç‰©åŒ–è¡¨çš„æ¯ä¸ªå€¼æ¥è¯´ï¼Œå¦‚æœèƒ½åœ¨s1è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„key1åˆ—çš„å€¼ä¸è¯¥å€¼ç›¸ç­‰çš„è®°å½•ï¼Œé‚£ä¹ˆå°±æŠŠè¿™äº›è®°å½•åŠ å…¥åˆ°æœ€ç»ˆçš„ç»“æœé›†ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹å°±æ˜¯è¿™æ ·ï¼š ä¹Ÿå°±æ˜¯è¯´å…¶å®ä¸Šè¾¹çš„æŸ¥è¯¢å°±ç›¸å½“äºè¡¨s1å’Œå­æŸ¥è¯¢ç‰©åŒ–è¡¨materialized_tableè¿›è¡Œå†…è¿æ¥ï¼š 1SELECT s1.* FROM s1 INNER JOIN materialized_table ON key1 = m_val; è½¬åŒ–æˆå†…è¿æ¥ä¹‹åå°±æœ‰æ„æ€äº†ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å¯ä»¥è¯„ä¼°ä¸åŒè¿æ¥é¡ºåºéœ€è¦çš„æˆæœ¬æ˜¯å¤šå°‘ï¼Œé€‰å–æˆæœ¬æœ€ä½çš„é‚£ç§æŸ¥è¯¢æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ã€‚æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸Šè¿°æŸ¥è¯¢ä¸­ä½¿ç”¨å¤–å±‚æŸ¥è¯¢çš„è¡¨s1å’Œç‰©åŒ–è¡¨materialized_tableè¿›è¡Œå†…è¿æ¥çš„æˆæœ¬éƒ½æ˜¯ç”±å“ªå‡ éƒ¨åˆ†ç»„æˆçš„ï¼š å¦‚æœä½¿ç”¨s1è¡¨ä½œä¸ºé©±åŠ¨è¡¨çš„è¯ï¼Œæ€»æŸ¥è¯¢æˆæœ¬ç”±ä¸‹è¾¹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š ç‰©åŒ–å­æŸ¥è¯¢æ—¶éœ€è¦çš„æˆæœ¬ æ‰«æs1è¡¨æ—¶çš„æˆæœ¬ s1è¡¨ä¸­çš„è®°å½•æ•°é‡ Ã— é€šè¿‡m_val = xxxå¯¹materialized_tableè¡¨è¿›è¡Œå•è¡¨è®¿é—®çš„æˆæœ¬ï¼ˆæˆ‘ä»¬å‰è¾¹è¯´è¿‡ç‰©åŒ–è¡¨ä¸­çš„è®°å½•æ˜¯ä¸é‡å¤çš„ï¼Œå¹¶ä¸”ä¸ºç‰©åŒ–è¡¨ä¸­çš„åˆ—å»ºç«‹äº†ç´¢å¼•ï¼Œæ‰€ä»¥è¿™ä¸ªæ­¥éª¤æ˜¾ç„¶æ˜¯éå¸¸å¿«çš„ï¼‰ã€‚ å¦‚æœä½¿ç”¨materialized_tableè¡¨ä½œä¸ºé©±åŠ¨è¡¨çš„è¯ï¼Œæ€»æŸ¥è¯¢æˆæœ¬ç”±ä¸‹è¾¹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š ç‰©åŒ–å­æŸ¥è¯¢æ—¶éœ€è¦çš„æˆæœ¬ æ‰«æç‰©åŒ–è¡¨æ—¶çš„æˆæœ¬ ç‰©åŒ–è¡¨ä¸­çš„è®°å½•æ•°é‡ Ã— é€šè¿‡key1 = xxxå¯¹s1è¡¨è¿›è¡Œå•è¡¨è®¿é—®çš„æˆæœ¬ï¼ˆéå¸¸åº†å¹¸key1åˆ—ä¸Šå»ºç«‹äº†ç´¢å¼•ï¼Œæ‰€ä»¥è¿™ä¸ªæ­¥éª¤æ˜¯éå¸¸å¿«çš„ï¼‰ã€‚ MySQLæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šé€šè¿‡è¿ç®—æ¥é€‰æ‹©ä¸Šè¿°æˆæœ¬æ›´ä½çš„æ–¹æ¡ˆæ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚ â‘¢ å°†å­æŸ¥è¯¢è½¬æ¢ä¸ºsemi-joinè™½ç„¶å°†å­æŸ¥è¯¢è¿›è¡Œç‰©åŒ–ä¹‹åå†æ‰§è¡ŒæŸ¥è¯¢éƒ½ä¼šæœ‰å»ºç«‹ä¸´æ—¶è¡¨çš„æˆæœ¬ï¼Œä½†æ˜¯ä¸ç®¡æ€ä¹ˆè¯´ï¼Œæˆ‘ä»¬è§è¯†åˆ°äº†å°†å­æŸ¥è¯¢è½¬æ¢ä¸ºè¿æ¥çš„å¼ºå¤§ä½œç”¨ï¼Œèƒ½ä¸èƒ½ä¸è¿›è¡Œç‰©åŒ–æ“ä½œç›´æ¥æŠŠå­æŸ¥è¯¢è½¬æ¢ä¸ºè¿æ¥å‘¢ï¼Ÿ 12SELECT * FROM s1 WHERE key1 IN (SELECT common_field FROM s2 WHERE key3 = &#x27;a&#x27;); æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªæŸ¥è¯¢ç†è§£æˆï¼šå¯¹äºs1è¡¨ä¸­çš„æŸæ¡è®°å½•ï¼Œå¦‚æœæˆ‘ä»¬èƒ½åœ¨s2è¡¨ï¼ˆå‡†ç¡®çš„è¯´æ˜¯æ‰§è¡Œå®ŒWHERE s2.key3 = &#39;a&#39;ä¹‹åçš„ç»“æœé›†ï¼‰ä¸­æ‰¾åˆ°ä¸€æ¡æˆ–å¤šæ¡è®°å½•ï¼Œè¿™äº›è®°å½•çš„common_fieldçš„å€¼ç­‰äºs1è¡¨è®°å½•çš„key1åˆ—çš„å€¼ï¼Œé‚£ä¹ˆè¯¥æ¡s1è¡¨çš„è®°å½•å°±ä¼šè¢«åŠ å…¥åˆ°æœ€ç»ˆçš„ç»“æœé›†ã€‚è¿™ä¸ªè¿‡ç¨‹å…¶å®å’ŒæŠŠs1å’Œs2ä¸¤ä¸ªè¡¨è¿æ¥èµ·æ¥çš„æ•ˆæœå¾ˆåƒï¼š 123SELECT s1.* FROM s1 INNER JOIN s2 ON s1.key1 = s2.common_field WHERE s2.key3 = &#x27;a&#x27;; åªä¸è¿‡æˆ‘ä»¬ä¸èƒ½ä¿è¯å¯¹äºs1è¡¨çš„æŸæ¡è®°å½•æ¥è¯´ï¼Œåœ¨s2è¡¨ï¼ˆå‡†ç¡®çš„è¯´æ˜¯æ‰§è¡Œå®ŒWHERE s2.key3 = &#39;a&#39;ä¹‹åçš„ç»“æœé›†ï¼‰ä¸­æœ‰å¤šå°‘æ¡è®°å½•æ»¡è¶³s1.key1 = s2.common_fieldè¿™ä¸ªæ¡ä»¶ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥åˆ†ä¸‰ç§æƒ…å†µè®¨è®ºï¼š æƒ…å†µä¸€ï¼šå¯¹äºs1è¡¨çš„æŸæ¡è®°å½•æ¥è¯´ï¼Œs2è¡¨ä¸­æ²¡æœ‰ä»»ä½•è®°å½•æ»¡è¶³s1.key1 = s2.common_fieldè¿™ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆè¯¥è®°å½•è‡ªç„¶ä¹Ÿä¸ä¼šåŠ å…¥åˆ°æœ€åçš„ç»“æœé›†ã€‚ æƒ…å†µäºŒï¼šå¯¹äºs1è¡¨çš„æŸæ¡è®°å½•æ¥è¯´ï¼Œs2è¡¨ä¸­æœ‰ä¸”åªæœ‰1æ¡è®°å½•æ»¡è¶³s1.key1 = s2.common_fieldè¿™ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆè¯¥è®°å½•ä¼šè¢«åŠ å…¥æœ€ç»ˆçš„ç»“æœé›†ã€‚ æƒ…å†µä¸‰ï¼šå¯¹äºs1è¡¨çš„æŸæ¡è®°å½•æ¥è¯´ï¼Œs2è¡¨ä¸­è‡³å°‘æœ‰2æ¡è®°å½•æ»¡è¶³s1.key1 = s2.common_fieldè¿™ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆè¯¥è®°å½•ä¼šè¢«å¤šæ¬¡åŠ å…¥æœ€ç»ˆçš„ç»“æœé›†ã€‚ å¯¹äºs1è¡¨çš„æŸæ¡è®°å½•æ¥è¯´ï¼Œç”±äºæˆ‘ä»¬åªå…³å¿ƒs2è¡¨ä¸­æ˜¯å¦å­˜åœ¨è®°å½•æ»¡è¶³s1.key1 = s2.common_fieldè¿™ä¸ªæ¡ä»¶ï¼Œè€Œä¸å…³å¿ƒå…·ä½“æœ‰å¤šå°‘æ¡è®°å½•ä¸ä¹‹åŒ¹é…ï¼Œåˆå› ä¸ºæœ‰æƒ…å†µä¸‰çš„å­˜åœ¨ï¼Œæˆ‘ä»¬ä¸Šè¾¹æ‰€è¯´çš„INå­æŸ¥è¯¢å’Œä¸¤è¡¨è¿æ¥ä¹‹é—´å¹¶ä¸å®Œå…¨ç­‰ä»·ã€‚ä½†æ˜¯å°†å­æŸ¥è¯¢è½¬æ¢ä¸ºè¿æ¥åˆçœŸçš„å¯ä»¥å……åˆ†å‘æŒ¥ä¼˜åŒ–å™¨çš„ä½œç”¨ï¼Œæ‰€ä»¥MySQLåœ¨è¿™é‡Œæå‡ºäº†ä¸€ä¸ªæ–°æ¦‚å¿µ â€” åŠè¿æ¥ã€‚å°†s1è¡¨å’Œs2è¡¨è¿›è¡ŒåŠè¿æ¥çš„æ„æ€å°±æ˜¯ï¼šå¯¹äºs1è¡¨çš„æŸæ¡è®°å½•æ¥è¯´ï¼Œæˆ‘ä»¬åªå…³å¿ƒåœ¨s2è¡¨ä¸­æ˜¯å¦å­˜åœ¨ä¸ä¹‹åŒ¹é…çš„è®°å½•ï¼Œè€Œä¸å…³å¿ƒå…·ä½“æœ‰å¤šå°‘æ¡è®°å½•ä¸ä¹‹åŒ¹é…ï¼Œæœ€ç»ˆçš„ç»“æœé›†ä¸­åªä¿ç•™s1è¡¨çš„è®°å½•ã€‚æˆ‘ä»¬å‡è®¾MySQLå†…éƒ¨æ˜¯è¿™ä¹ˆæ”¹å†™ä¸Šè¾¹çš„å­æŸ¥è¯¢çš„ï¼š 123SELECT s1.* FROM s1 SEMI JOIN s2 ON s1.key1 = s2.common_field WHERE key3 = &#x27;a&#x27;; semi-joinåªæ˜¯åœ¨MySQLå†…éƒ¨é‡‡ç”¨çš„ä¸€ç§æ‰§è¡Œå­æŸ¥è¯¢çš„æ–¹å¼ï¼ŒMySQLå¹¶æ²¡æœ‰æä¾›é¢å‘ç”¨æˆ·çš„semi-joinè¯­æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦ï¼Œä¹Ÿä¸èƒ½å°è¯•æŠŠä¸Šè¾¹è¿™ä¸ªè¯­å¥æ”¾åˆ°mysqlå®¢æˆ·ç«¯æ‰§è¡Œã€‚ æ€ä¹ˆå®ç°è¿™ç§æ‰€è°“çš„åŠè¿æ¥å‘¢ï¼Ÿ Table pullout ï¼ˆå­æŸ¥è¯¢ä¸­çš„è¡¨ä¸Šæ‹‰ï¼‰å½“å­æŸ¥è¯¢çš„æŸ¥è¯¢åˆ—è¡¨å¤„åªæœ‰ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•åˆ—æ—¶ï¼Œå¯ä»¥ç›´æ¥æŠŠå­æŸ¥è¯¢ä¸­çš„è¡¨ä¸Šæ‹‰åˆ°å¤–å±‚æŸ¥è¯¢çš„FROMå­å¥ä¸­ï¼Œå¹¶æŠŠå­æŸ¥è¯¢ä¸­çš„æœç´¢æ¡ä»¶åˆå¹¶åˆ°å¤–å±‚æŸ¥è¯¢çš„æœç´¢æ¡ä»¶ä¸­ï¼Œæ¯”å¦‚è¿™ä¸ªç”±äºkey2åˆ—æ˜¯s2è¡¨çš„å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠs2è¡¨ä¸Šæ‹‰åˆ°å¤–å±‚æŸ¥è¯¢çš„FROMå­å¥ä¸­ï¼Œå¹¶ä¸”æŠŠå­æŸ¥è¯¢ä¸­çš„æœç´¢æ¡ä»¶åˆå¹¶åˆ°å¤–å±‚æŸ¥è¯¢çš„æœç´¢æ¡ä»¶ä¸­ï¼Œä¸Šæ‹‰ä¹‹åçš„æŸ¥è¯¢å°±æ˜¯è¿™æ ·çš„ï¼šä¸ºä»€ä¹ˆå½“å­æŸ¥è¯¢çš„æŸ¥è¯¢åˆ—è¡¨å¤„åªæœ‰ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•åˆ—æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥å°†å­æŸ¥è¯¢è½¬æ¢ä¸ºè¿æ¥æŸ¥è¯¢å‘¢ï¼Ÿä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•åˆ—ä¸­çš„æ•°æ®æœ¬èº«å°±æ˜¯ä¸é‡å¤çš„ï¼Œæ‰€ä»¥å¯¹äºåŒä¸€æ¡s1è¡¨ä¸­çš„è®°å½•ï¼Œä¸å¯èƒ½æ‰¾åˆ°ä¸¤æ¡ä»¥ä¸Šçš„ç¬¦åˆs1.key2 = s2.key2çš„è®°å½•ã€‚ 12SELECT * FROM s1 WHERE key2 IN (SELECT key2 FROM s2 WHERE key3 = &#x27;a&#x27;); 123SELECT s1.* FROM s1 INNER JOIN s2 ON s1.key2 = s2.key2 WHERE s2.key3 = &#x27;a&#x27;; DuplicateWeedout execution strategy ï¼ˆé‡å¤å€¼æ¶ˆé™¤ï¼‰å¯¹äºè¿™ä¸ªæŸ¥è¯¢æ¥è¯´ï¼šè½¬æ¢ä¸ºåŠè¿æ¥æŸ¥è¯¢åï¼Œs1è¡¨ä¸­çš„æŸæ¡è®°å½•å¯èƒ½åœ¨s2è¡¨ä¸­æœ‰å¤šæ¡åŒ¹é…çš„è®°å½•ï¼Œæ‰€ä»¥è¯¥æ¡è®°å½•å¯èƒ½å¤šæ¬¡è¢«æ·»åŠ åˆ°æœ€åçš„ç»“æœé›†ä¸­ï¼Œä¸ºäº†æ¶ˆé™¤é‡å¤ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œæ¯”æ–¹è¯´è¿™ä¸ªä¸´æ—¶è¡¨é•¿è¿™æ ·ï¼šè¿™æ ·åœ¨æ‰§è¡Œè¿æ¥æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­ï¼Œæ¯å½“æŸæ¡s1è¡¨ä¸­çš„è®°å½•è¦åŠ å…¥ç»“æœé›†æ—¶ï¼Œå°±é¦–å…ˆæŠŠè¿™æ¡è®°å½•çš„idå€¼åŠ å…¥åˆ°è¿™ä¸ªä¸´æ—¶è¡¨é‡Œï¼Œå¦‚æœæ·»åŠ æˆåŠŸï¼Œè¯´æ˜ä¹‹å‰è¿™æ¡s1è¡¨ä¸­çš„è®°å½•å¹¶æ²¡æœ‰åŠ å…¥æœ€ç»ˆçš„ç»“æœé›†ï¼Œç°åœ¨æŠŠè¯¥è®°å½•æ·»åŠ åˆ°æœ€ç»ˆçš„ç»“æœé›†ï¼›å¦‚æœæ·»åŠ å¤±è´¥ï¼Œè¯´æ˜ä¹‹å‰è¿™æ¡s1è¡¨ä¸­çš„è®°å½•å·²ç»åŠ å…¥è¿‡æœ€ç»ˆçš„ç»“æœé›†ï¼Œè¿™é‡Œç›´æ¥æŠŠå®ƒä¸¢å¼ƒå°±å¥½äº†ï¼Œè¿™ç§ä½¿ç”¨ä¸´æ—¶è¡¨æ¶ˆé™¤semi-joinç»“æœé›†ä¸­çš„é‡å¤å€¼çš„æ–¹å¼ç§°ä¹‹ä¸ºDuplicateWeedoutã€‚ 12SELECT * FROM s1 WHERE key1 IN (SELECT common_field FROM s2 WHERE key3 = &#x27;a&#x27;); 123CREATE TABLE tmp ( id PRIMARY KEY); LooseScan execution strategy ï¼ˆæ¾æ•£æ‰«æï¼‰å¤§å®¶çœ‹è¿™ä¸ªæŸ¥è¯¢ï¼šåœ¨å­æŸ¥è¯¢ä¸­ï¼Œå¯¹äºs2è¡¨çš„è®¿é—®å¯ä»¥ä½¿ç”¨åˆ°key1åˆ—çš„ç´¢å¼•ï¼Œè€Œæ°å¥½å­æŸ¥è¯¢çš„æŸ¥è¯¢åˆ—è¡¨å¤„å°±æ˜¯key1åˆ—ï¼Œè¿™æ ·åœ¨å°†è¯¥æŸ¥è¯¢è½¬æ¢ä¸ºåŠè¿æ¥æŸ¥è¯¢åï¼Œå¦‚æœå°†s2ä½œä¸ºé©±åŠ¨è¡¨æ‰§è¡ŒæŸ¥è¯¢çš„è¯ï¼Œé‚£ä¹ˆæ‰§è¡Œè¿‡ç¨‹å°±æ˜¯è¿™æ ·ï¼šå¦‚å›¾æ‰€ç¤ºï¼Œåœ¨s2è¡¨çš„idx_key1ç´¢å¼•ä¸­ï¼Œå€¼ä¸º&#39;aa&#39;çš„äºŒçº§ç´¢å¼•è®°å½•ä¸€å…±æœ‰3æ¡ï¼Œé‚£ä¹ˆåªéœ€è¦å–ç¬¬ä¸€æ¡çš„å€¼åˆ°s1è¡¨ä¸­æŸ¥æ‰¾s1.key3 = &#39;aa&#39;çš„è®°å½•ï¼Œå¦‚æœèƒ½åœ¨s1è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„è®°å½•ï¼Œé‚£ä¹ˆå°±æŠŠå¯¹åº”çš„è®°å½•åŠ å…¥åˆ°ç»“æœé›†ã€‚ä¾æ­¤ç±»æ¨ï¼Œå…¶ä»–å€¼ç›¸åŒçš„äºŒçº§ç´¢å¼•è®°å½•ï¼Œä¹Ÿåªéœ€è¦å–ç¬¬ä¸€æ¡è®°å½•çš„å€¼åˆ°s1è¡¨ä¸­æ‰¾åŒ¹é…çš„è®°å½•ï¼Œè¿™ç§è™½ç„¶æ˜¯æ‰«æç´¢å¼•ï¼Œä½†åªå–å€¼ç›¸åŒçš„è®°å½•çš„ç¬¬ä¸€æ¡å»åšåŒ¹é…æ“ä½œçš„æ–¹å¼ç§°ä¹‹ä¸ºæ¾æ•£æ‰«æã€‚ 12SELECT * FROM s1 WHERE key3 IN (SELECT key1 FROM s2 WHERE key1 &gt; &#x27;a&#x27; AND key1 &lt; &#x27;b&#x27;); Semi-join Materialization execution strategyæˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„å…ˆæŠŠå¤–å±‚æŸ¥è¯¢çš„INå­å¥ä¸­çš„ä¸ç›¸å…³å­æŸ¥è¯¢è¿›è¡Œç‰©åŒ–ï¼Œç„¶åå†è¿›è¡Œå¤–å±‚æŸ¥è¯¢çš„è¡¨å’Œç‰©åŒ–è¡¨çš„è¿æ¥æœ¬è´¨ä¸Šä¹Ÿç®—æ˜¯ä¸€ç§semi-joinï¼Œåªä¸è¿‡ç”±äºç‰©åŒ–è¡¨ä¸­æ²¡æœ‰é‡å¤çš„è®°å½•ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°†å­æŸ¥è¯¢è½¬ä¸ºè¿æ¥æŸ¥è¯¢ã€‚ FirstMatch execution strategy ï¼ˆé¦–æ¬¡åŒ¹é…ï¼‰FirstMatchæ˜¯ä¸€ç§æœ€åŸå§‹çš„åŠè¿æ¥æ‰§è¡Œæ–¹å¼ï¼Œå…ˆå–ä¸€æ¡å¤–å±‚æŸ¥è¯¢çš„ä¸­çš„è®°å½•ï¼Œç„¶ååˆ°å­æŸ¥è¯¢çš„è¡¨ä¸­å¯»æ‰¾ç¬¦åˆåŒ¹é…æ¡ä»¶çš„è®°å½•ï¼Œå¦‚æœèƒ½æ‰¾åˆ°ä¸€æ¡ï¼Œåˆ™å°†è¯¥å¤–å±‚æŸ¥è¯¢çš„è®°å½•æ”¾å…¥æœ€ç»ˆçš„ç»“æœé›†å¹¶ä¸”åœæ­¢æŸ¥æ‰¾æ›´å¤šåŒ¹é…çš„è®°å½•ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™æŠŠè¯¥å¤–å±‚æŸ¥è¯¢çš„è®°å½•ä¸¢å¼ƒæ‰ï¼›ç„¶åå†å¼€å§‹å–ä¸‹ä¸€æ¡å¤–å±‚æŸ¥è¯¢ä¸­çš„è®°å½•ï¼Œé‡å¤ä¸Šè¾¹è¿™ä¸ªè¿‡ç¨‹ã€‚ å¯¹äºæŸäº›ä½¿ç”¨INè¯­å¥çš„ç›¸å…³å­æŸ¥è¯¢ï¼Œæ¯”æ–¹è¿™ä¸ªæŸ¥è¯¢ï¼š 12SELECT * FROM s1 WHERE key1 IN (SELECT common_field FROM s2 WHERE s1.key3 = s2.key3); å®ƒä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿çš„è½¬ä¸ºåŠè¿æ¥ï¼Œè½¬æ¢åçš„è¯­å¥ç±»ä¼¼è¿™æ ·ï¼š 12SELECT s1.* FROM s1 SEMI JOIN s2 ON s1.key1 = s2.common_field AND s1.key3 = s2.key3; ç„¶åå°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬ä¸Šè¾¹ä»‹ç»è¿‡çš„DuplicateWeedoutã€LooseScanã€FirstMatchç­‰åŠè¿æ¥æ‰§è¡Œç­–ç•¥æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼Œå½“ç„¶ï¼Œå¦‚æœå­æŸ¥è¯¢çš„æŸ¥è¯¢åˆ—è¡¨å¤„åªæœ‰ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—ï¼Œè¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨table pulloutçš„ç­–ç•¥æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼Œä½†æ˜¯ï¼Œç”±äºç›¸å…³å­æŸ¥è¯¢å¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æŸ¥è¯¢ï¼Œæ‰€ä»¥ä¸èƒ½è½¬æ¢ä¸ºç‰©åŒ–è¡¨æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚ â‘£ semi-joinçš„é€‚ç”¨æ¡ä»¶å½“ç„¶ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰åŒ…å«INå­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥éƒ½å¯ä»¥è½¬æ¢ä¸ºsemi-joinï¼Œåªæœ‰å½¢å¦‚è¿™æ ·çš„æŸ¥è¯¢æ‰å¯ä»¥è¢«è½¬æ¢ä¸ºsemi-joinï¼š 12SELECT ... FROM outer_tables WHERE expr IN (SELECT ... FROM inner_tables ...) AND ... æˆ–è€…è¿™æ ·çš„å½¢å¼ä¹Ÿå¯ä»¥ï¼š 12SELECT ... FROM outer_tables WHERE (oe1, oe2, ...) IN (SELECT ie1, ie2, ... FROM inner_tables ...) AND ... ç”¨æ–‡å­—æ€»ç»“ä¸€ä¸‹ï¼Œåªæœ‰ç¬¦åˆä¸‹è¾¹è¿™äº›æ¡ä»¶çš„å­æŸ¥è¯¢æ‰å¯ä»¥è¢«è½¬æ¢ä¸ºsemi-joinï¼š è¯¥å­æŸ¥è¯¢å¿…é¡»æ˜¯å’ŒINè¯­å¥ç»„æˆçš„å¸ƒå°”è¡¨è¾¾å¼ï¼Œå¹¶ä¸”åœ¨å¤–å±‚æŸ¥è¯¢çš„WHEREæˆ–è€…ONå­å¥ä¸­å‡ºç°ã€‚ å¤–å±‚æŸ¥è¯¢ä¹Ÿå¯ä»¥æœ‰å…¶ä»–çš„æœç´¢æ¡ä»¶ï¼Œåªä¸è¿‡å’ŒINå­æŸ¥è¯¢çš„æœç´¢æ¡ä»¶å¿…é¡»ä½¿ç”¨ANDè¿æ¥èµ·æ¥ã€‚ è¯¥å­æŸ¥è¯¢å¿…é¡»æ˜¯ä¸€ä¸ªå•ä¸€çš„æŸ¥è¯¢ï¼Œä¸èƒ½æ˜¯ç”±è‹¥å¹²æŸ¥è¯¢ç”±UNIONè¿æ¥èµ·æ¥çš„å½¢å¼ã€‚ è¯¥å­æŸ¥è¯¢ä¸èƒ½åŒ…å«GROUP BYæˆ–è€…HAVINGè¯­å¥æˆ–è€…èšé›†å‡½æ•°ã€‚ â€¦ è¿˜æœ‰ä¸€äº›æ¡ä»¶æ¯”è¾ƒå°‘è§â€¦. â‘¤ ä¸é€‚ç”¨äºsemi-joinçš„æƒ…å†µå¯¹äºä¸€äº›ä¸èƒ½å°†å­æŸ¥è¯¢è½¬ä½semi-joinçš„æƒ…å†µï¼Œå…¸å‹çš„æ¯”å¦‚ä¸‹è¾¹è¿™å‡ ç§ï¼š å¤–å±‚æŸ¥è¯¢çš„WHEREæ¡ä»¶ä¸­æœ‰å…¶ä»–æœç´¢æ¡ä»¶ä¸INå­æŸ¥è¯¢ç»„æˆçš„å¸ƒå°”è¡¨è¾¾å¼ä½¿ç”¨ORè¿æ¥èµ·æ¥ 123SELECT * FROM s1 WHERE key1 IN (SELECT common_field FROM s2 WHERE key3 = &#x27;a&#x27;) OR key2 &gt; 100; ä½¿ç”¨NOT INè€Œä¸æ˜¯INçš„æƒ…å†µ 12SELECT * FROM s1 WHERE key1 NOT IN (SELECT common_field FROM s2 WHERE key3 = &#x27;a&#x27;) åœ¨SELECTå­å¥ä¸­çš„INå­æŸ¥è¯¢çš„æƒ…å†µ 1SELECT key1 IN (SELECT common_field FROM s2 WHERE key3 = &#x27;a&#x27;) FROM s1 ; å­æŸ¥è¯¢ä¸­åŒ…å«GROUP BYã€HAVINGæˆ–è€…èšé›†å‡½æ•°çš„æƒ…å†µ 12SELECT * FROM s1 WHERE key2 IN (SELECT COUNT(*) FROM s2 GROUP BY key1); å­æŸ¥è¯¢ä¸­åŒ…å«UNIONçš„æƒ…å†µ 12345SELECT * FROM s1 WHERE key1 IN ( SELECT common_field FROM s2 WHERE key3 = &#x27;a&#x27; UNION SELECT common_field FROM s2 WHERE key3 = &#x27;b&#x27;); MySQLä»ç„¶ä¼šå°è¯•ä¼˜åŒ–ä¸èƒ½è½¬ä¸ºsemi-joinæŸ¥è¯¢çš„å­æŸ¥è¯¢ï¼Œé‚£å°±æ˜¯ï¼š å¯¹äºä¸ç›¸å…³å­æŸ¥è¯¢æ¥è¯´ï¼Œå¯ä»¥å°è¯•æŠŠå®ƒä»¬ç‰©åŒ–ä¹‹åå†å‚ä¸æŸ¥è¯¢æ¯”å¦‚æˆ‘ä»¬ä¸Šè¾¹æåˆ°çš„è¿™ä¸ªæŸ¥è¯¢ï¼šå…ˆå°†å­æŸ¥è¯¢ç‰©åŒ–ï¼Œç„¶åå†åˆ¤æ–­key1æ˜¯å¦åœ¨ç‰©åŒ–è¡¨çš„ç»“æœé›†ä¸­å¯ä»¥åŠ å¿«æŸ¥è¯¢æ‰§è¡Œçš„é€Ÿåº¦ã€‚ 12SELECT * FROM s1 WHERE key1 NOT IN (SELECT common_field FROM s2 WHERE key3 = &#x27;a&#x27;) è¿™é‡Œå°†å­æŸ¥è¯¢ç‰©åŒ–ä¹‹åä¸èƒ½è½¬ä¸ºå’Œå¤–å±‚æŸ¥è¯¢çš„è¡¨çš„è¿æ¥ï¼Œåªèƒ½æ˜¯å…ˆæ‰«æs1è¡¨ï¼Œç„¶åå¯¹s1è¡¨çš„æŸæ¡è®°å½•æ¥è¯´ï¼Œåˆ¤æ–­è¯¥è®°å½•çš„key1å€¼åœ¨ä¸åœ¨ç‰©åŒ–è¡¨ä¸­ã€‚ ä¸ç®¡å­æŸ¥è¯¢æ˜¯ç›¸å…³çš„è¿˜æ˜¯ä¸ç›¸å…³çš„ï¼Œéƒ½å¯ä»¥æŠŠINå­æŸ¥è¯¢å°è¯•è½¬ä¸ºEXISTSå­æŸ¥è¯¢å…¶å®å¯¹äºä»»æ„ä¸€ä¸ªINå­æŸ¥è¯¢æ¥è¯´ï¼Œéƒ½å¯ä»¥è¢«è½¬ä¸ºEXISTSå­æŸ¥è¯¢ï¼Œé€šç”¨çš„ä¾‹å­å¦‚ä¸‹ï¼šå¯ä»¥è¢«è½¬æ¢ä¸ºï¼šå½“ç„¶è¿™ä¸ªè¿‡ç¨‹ä¸­æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚åœ¨outer_expræˆ–è€…inner_exprå€¼ä¸ºNULLçš„æƒ…å†µä¸‹å°±æ¯”è¾ƒç‰¹æ®Šã€‚å› ä¸ºæœ‰NULLå€¼ä½œä¸ºæ“ä½œæ•°çš„è¡¨è¾¾å¼ç»“æœå¾€å¾€æ˜¯NULLï¼Œæ¯”æ–¹è¯´ï¼šè€ŒEXISTSå­æŸ¥è¯¢çš„ç»“æœè‚¯å®šæ˜¯TRUEæˆ–è€…FASLEï¼šä½†æ˜¯ï¼Œæˆ‘ä»¬å¤§éƒ¨åˆ†ä½¿ç”¨INå­æŸ¥è¯¢çš„åœºæ™¯æ˜¯æŠŠå®ƒæ”¾åœ¨WHEREæˆ–è€…ONå­å¥ä¸­ï¼Œè€ŒWHEREæˆ–è€…ONå­å¥æ˜¯ä¸åŒºåˆ†NULLå’ŒFALSEçš„ï¼Œæ¯”æ–¹è¯´ï¼šæ‰€ä»¥åªè¦æˆ‘ä»¬çš„INå­æŸ¥è¯¢æ˜¯æ”¾åœ¨WHEREæˆ–è€…ONå­å¥ä¸­çš„ï¼Œé‚£ä¹ˆIN -&gt; EXISTSçš„è½¬æ¢å°±æ˜¯æ²¡é—®é¢˜çš„ã€‚è¯´äº†è¿™ä¹ˆå¤šï¼Œä¸ºå•¥è¦è½¬æ¢å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºä¸è½¬æ¢çš„è¯å¯èƒ½ç”¨ä¸åˆ°ç´¢å¼•ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼šè¿™ä¸ªæŸ¥è¯¢ä¸­çš„å­æŸ¥è¯¢æ˜¯ä¸€ä¸ªç›¸å…³å­æŸ¥è¯¢ï¼Œè€Œä¸”å­æŸ¥è¯¢æ‰§è¡Œçš„æ—¶å€™ä¸èƒ½ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œä½†æ˜¯å°†å®ƒè½¬ä¸ºEXISTSå­æŸ¥è¯¢åå´å¯ä»¥ä½¿ç”¨åˆ°ç´¢å¼•ï¼šè½¬ä¸ºEXISTSå­æŸ¥è¯¢æ—¶ä¾¿å¯ä»¥ä½¿ç”¨åˆ°s2è¡¨çš„idx_key3ç´¢å¼•äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœINå­æŸ¥è¯¢ä¸æ»¡è¶³è½¬æ¢ä¸ºsemi-joinçš„æ¡ä»¶ï¼Œåˆä¸èƒ½è½¬æ¢ä¸ºç‰©åŒ–è¡¨æˆ–è€…è½¬æ¢ä¸ºç‰©åŒ–è¡¨çš„æˆæœ¬å¤ªå¤§ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«è½¬æ¢ä¸ºEXISTSæŸ¥è¯¢ã€‚ 1outer_expr IN (SELECT inner_expr FROM ... WHERE subquery_where) 1EXISTS (SELECT inner_expr FROM ... WHERE subquery_where AND outer_expr=inner_expr) 1234567891011121314151617181920212223mysql&gt; SELECT NULL IN (1, 2, 3);+-------------------+| NULL IN (1, 2, 3) |+-------------------+| NULL |+-------------------+1 row in set (0.00 sec)mysql&gt; SELECT 1 IN (1, 2, 3);+----------------+| 1 IN (1, 2, 3) |+----------------+| 1 |+----------------+1 row in set (0.00 sec)mysql&gt; SELECT NULL IN (NULL);+----------------+| NULL IN (NULL) |+----------------+| NULL |+----------------+1 row in set (0.00 sec) 1234567891011121314151617181920212223mysql&gt; SELECT EXISTS (SELECT 1 FROM s1 WHERE NULL = 1);+------------------------------------------+| EXISTS (SELECT 1 FROM s1 WHERE NULL = 1) |+------------------------------------------+| 0 |+------------------------------------------+1 row in set (0.01 sec)mysql&gt; SELECT EXISTS (SELECT 1 FROM s1 WHERE 1 = NULL);+------------------------------------------+| EXISTS (SELECT 1 FROM s1 WHERE 1 = NULL) |+------------------------------------------+| 0 |+------------------------------------------+1 row in set (0.00 sec)mysql&gt; SELECT EXISTS (SELECT 1 FROM s1 WHERE NULL = NULL);+---------------------------------------------+| EXISTS (SELECT 1 FROM s1 WHERE NULL = NULL) |+---------------------------------------------+| 0 |+---------------------------------------------+1 row in set (0.00 sec) 12345mysql&gt; SELECT 1 FROM s1 WHERE NULL;Empty set (0.00 sec)mysql&gt; SELECT 1 FROM s1 WHERE FALSE;Empty set (0.00 sec) 123SELECT * FROM s1 WHERE key1 IN (SELECT key3 FROM s2 where s1.common_field = s2.common_field) OR key2 &gt; 1000; 123SELECT * FROM s1 WHERE EXISTS (SELECT 1 FROM s2 where s1.common_field = s2.common_field AND s2.key3 = s1.key1) OR key2 &gt; 1000; åœ¨MySQL5.5ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬æ²¡æœ‰å¼•è¿›semi-joinå’Œç‰©åŒ–çš„æ–¹å¼ä¼˜åŒ–å­æŸ¥è¯¢æ—¶ï¼Œä¼˜åŒ–å™¨éƒ½ä¼šæŠŠINå­æŸ¥è¯¢è½¬æ¢ä¸ºEXISTSå­æŸ¥è¯¢ã€‚ â‘¥ é˜¶æ®µæ¢³ç† å¦‚æœINå­æŸ¥è¯¢ç¬¦åˆè½¬æ¢ä¸ºsemi-joinçš„æ¡ä»¶ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šä¼˜å…ˆæŠŠè¯¥å­æŸ¥è¯¢è½¬æ¢ä¸ºsemi-joinï¼Œç„¶åå†è€ƒè™‘ä¸‹è¾¹5ç§æ‰§è¡ŒåŠè¿æ¥çš„ç­–ç•¥ä¸­å“ªä¸ªæˆæœ¬æœ€ä½ï¼š Table pullout DuplicateWeedout LooseScan Materialization FirstMatch é€‰æ‹©æˆæœ¬æœ€ä½çš„é‚£ç§æ‰§è¡Œç­–ç•¥æ¥æ‰§è¡Œå­æŸ¥è¯¢ã€‚ å¦‚æœINå­æŸ¥è¯¢ä¸ç¬¦åˆè½¬æ¢ä¸ºsemi-joinçš„æ¡ä»¶ï¼Œé‚£ä¹ˆæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šä»ä¸‹è¾¹ä¸¤ç§ç­–ç•¥ä¸­æ‰¾å‡ºä¸€ç§æˆæœ¬æ›´ä½çš„æ–¹å¼æ‰§è¡Œå­æŸ¥è¯¢ï¼š å…ˆå°†å­æŸ¥è¯¢ç‰©åŒ–ä¹‹åå†æ‰§è¡ŒæŸ¥è¯¢ æ‰§è¡ŒIN to EXISTSè½¬æ¢ã€‚ 3.2.3 ANY/ALLå­æŸ¥è¯¢ä¼˜åŒ–å¦‚æœANY/ALLå­æŸ¥è¯¢æ˜¯ä¸ç›¸å…³å­æŸ¥è¯¢çš„è¯ï¼Œå®ƒä»¬åœ¨å¾ˆå¤šåœºåˆéƒ½èƒ½è½¬æ¢æˆæˆ‘ä»¬ç†Ÿæ‚‰çš„æ–¹å¼å»æ‰§è¡Œï¼Œæ¯”æ–¹è¯´ï¼š åŸå§‹è¡¨è¾¾å¼ è½¬æ¢ä¸º &lt; ANY (SELECT inner_expr â€¦) &lt; (SELECT MAX(inner_expr) â€¦) &gt; ANY (SELECT inner_expr â€¦) &gt; (SELECT MIN(inner_expr) â€¦) &lt; ALL (SELECT inner_expr â€¦) &lt; (SELECT MIN(inner_expr) â€¦) &gt; ALL (SELECT inner_expr â€¦) &gt; (SELECT MAX(inner_expr) â€¦) 3.2.4 [NOT] EXISTSå­æŸ¥è¯¢çš„æ‰§è¡Œå¦‚æœ[NOT] EXISTSå­æŸ¥è¯¢æ˜¯ä¸ç›¸å…³å­æŸ¥è¯¢ï¼Œå¯ä»¥å…ˆæ‰§è¡Œå­æŸ¥è¯¢ï¼Œå¾—å‡ºè¯¥[NOT] EXISTSå­æŸ¥è¯¢çš„ç»“æœæ˜¯TRUEè¿˜æ˜¯FALSEï¼Œå¹¶é‡å†™åŸå…ˆçš„æŸ¥è¯¢è¯­å¥ï¼Œæ¯”å¦‚å¯¹è¿™ä¸ªæŸ¥è¯¢æ¥è¯´ï¼š 123SELECT * FROM s1 WHERE EXISTS (SELECT 1 FROM s2 WHERE key1 = &#x27;a&#x27;) OR key2 &gt; 100; å› ä¸ºè¿™ä¸ªè¯­å¥é‡Œçš„å­æŸ¥è¯¢æ˜¯ä¸ç›¸å…³å­æŸ¥è¯¢ï¼Œæ‰€ä»¥ä¼˜åŒ–å™¨ä¼šé¦–å…ˆæ‰§è¡Œè¯¥å­æŸ¥è¯¢ï¼Œå‡è®¾è¯¥EXISTSå­æŸ¥è¯¢çš„ç»“æœä¸ºTRUEï¼Œé‚£ä¹ˆæ¥ç€ä¼˜åŒ–å™¨ä¼šé‡å†™æŸ¥è¯¢ä¸ºï¼š 12SELECT * FROM s1 WHERE TRUE OR key2 &gt; 100; è¿›ä¸€æ­¥ç®€åŒ–åå°±å˜æˆäº†ï¼š 12SELECT * FROM s1 WHERE TRUE; å¯¹äºç›¸å…³çš„[NOT] EXISTSå­æŸ¥è¯¢æ¥è¯´ï¼Œæ¯”å¦‚è¿™ä¸ªæŸ¥è¯¢ï¼š 12SELECT * FROM s1 WHERE EXISTS (SELECT 1 FROM s2 WHERE s1.common_field = s2.common_field); è¿™ä¸ªæŸ¥è¯¢åªèƒ½æŒ‰ç…§æ™®é€šçš„é‚£ç§æ‰§è¡Œç›¸å…³å­æŸ¥è¯¢çš„æ–¹å¼æ¥æ‰§è¡Œã€‚ä¸è¿‡å¦‚æœ[NOT] EXISTSå­æŸ¥è¯¢ä¸­å¦‚æœå¯ä»¥ä½¿ç”¨ç´¢å¼•çš„è¯ï¼Œé‚£æŸ¥è¯¢é€Ÿåº¦ä¹Ÿä¼šåŠ å¿«ä¸å°‘ï¼Œæ¯”å¦‚ï¼š 12SELECT * FROM s1 WHERE EXISTS (SELECT 1 FROM s2 WHERE s1.common_field = s2.key1); ä¸Šè¾¹è¿™ä¸ªEXISTSå­æŸ¥è¯¢ä¸­å¯ä»¥ä½¿ç”¨idx_key1æ¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚ 3.2.5 å¯¹äºæ´¾ç”Ÿè¡¨çš„ä¼˜åŒ–æˆ‘ä»¬å‰è¾¹è¯´è¿‡æŠŠå­æŸ¥è¯¢æ”¾åœ¨å¤–å±‚æŸ¥è¯¢çš„FROMå­å¥åï¼Œé‚£ä¹ˆè¿™ä¸ªå­æŸ¥è¯¢çš„ç»“æœç›¸å½“äºä¸€ä¸ªæ´¾ç”Ÿè¡¨ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š 123SELECT * FROM ( SELECT id AS d_id, key3 AS d_key3 FROM s2 WHERE key1 = &#x27;a&#x27; ) AS derived_s1 WHERE d_key3 = &#x27;a&#x27;; å­æŸ¥è¯¢( SELECT id AS d_id, key3 AS d_key3 FROM s2 WHERE key1 = &#39;a&#39;)çš„ç»“æœå°±ç›¸å½“äºä¸€ä¸ªæ´¾ç”Ÿè¡¨ï¼Œè¿™ä¸ªè¡¨çš„åç§°æ˜¯derived_s1ï¼Œè¯¥è¡¨æœ‰ä¸¤ä¸ªåˆ—ï¼Œåˆ†åˆ«æ˜¯d_idå’Œd_key3ã€‚ å¯¹äºå«æœ‰æ´¾ç”Ÿè¡¨çš„æŸ¥è¯¢ï¼ŒMySQLæä¾›äº†ä¸¤ç§æ‰§è¡Œç­–ç•¥ï¼š æŠŠæ´¾ç”Ÿè¡¨ç‰©åŒ–æˆ‘ä»¬å¯ä»¥å°†æ´¾ç”Ÿè¡¨çš„ç»“æœé›†å†™åˆ°ä¸€ä¸ªå†…éƒ¨çš„ä¸´æ—¶è¡¨ä¸­ï¼Œç„¶åå°±æŠŠè¿™ä¸ªç‰©åŒ–è¡¨å½“ä½œæ™®é€šè¡¨ä¸€æ ·å‚ä¸æŸ¥è¯¢ã€‚å½“ç„¶ï¼Œåœ¨å¯¹æ´¾ç”Ÿè¡¨è¿›è¡Œç‰©åŒ–æ—¶ï¼ŒMySQLä½¿ç”¨äº†ä¸€ç§ç§°ä¸ºå»¶è¿Ÿç‰©åŒ–çš„ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯åœ¨æŸ¥è¯¢ä¸­çœŸæ­£ä½¿ç”¨åˆ°æ´¾ç”Ÿè¡¨æ—¶æ‰ä¼šå»å°è¯•ç‰©åŒ–æ´¾ç”Ÿè¡¨ï¼Œè€Œä¸æ˜¯è¿˜æ²¡å¼€å§‹æ‰§è¡ŒæŸ¥è¯¢å°±æŠŠæ´¾ç”Ÿè¡¨ç‰©åŒ–æ‰ã€‚æ¯”æ–¹è¯´å¯¹äºä¸‹è¾¹è¿™ä¸ªå«æœ‰æ´¾ç”Ÿè¡¨çš„æŸ¥è¯¢æ¥è¯´ï¼šå¦‚æœé‡‡ç”¨ç‰©åŒ–æ´¾ç”Ÿè¡¨çš„æ–¹å¼æ¥æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢çš„è¯ï¼Œé‚£ä¹ˆæ‰§è¡Œæ—¶é¦–å…ˆä¼šåˆ°s2è¡¨ä¸­æ‰¾å‡ºæ»¡è¶³s2.key2 = 1çš„è®°å½•ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œè¯´æ˜å‚ä¸è¿æ¥çš„s2è¡¨è®°å½•å°±æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥æ•´ä¸ªæŸ¥è¯¢çš„ç»“æœé›†å°±æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰å¿…è¦å»ç‰©åŒ–æŸ¥è¯¢ä¸­çš„æ´¾ç”Ÿè¡¨äº†ã€‚ 12345SELECT * FROM ( SELECT * FROM s1 WHERE key1 = &#x27;a&#x27; ) AS derived_s1 INNER JOIN s2 ON derived_s1.key1 = s2.key1 WHERE s2.key2 = 1; å°†æ´¾ç”Ÿè¡¨å’Œå¤–å±‚çš„è¡¨åˆå¹¶ï¼Œä¹Ÿå°±æ˜¯å°†æŸ¥è¯¢é‡å†™ä¸ºæ²¡æœ‰æ´¾ç”Ÿè¡¨çš„å½¢å¼æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªåŒ…å«æ´¾ç”Ÿè¡¨çš„æŸ¥è¯¢ï¼šè¿™ä¸ªæŸ¥è¯¢æœ¬è´¨ä¸Šå°±æ˜¯æƒ³æŸ¥çœ‹s1è¡¨ä¸­æ»¡è¶³key1 = &#39;a&#39;æ¡ä»¶çš„çš„å…¨éƒ¨è®°å½•ï¼Œæ‰€ä»¥å’Œä¸‹è¾¹è¿™ä¸ªè¯­å¥æ˜¯ç­‰ä»·çš„ï¼šå¯¹äºä¸€äº›ç¨å¾®å¤æ‚çš„åŒ…å«æ´¾ç”Ÿè¡¨çš„è¯­å¥ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸Šè¾¹æåˆ°çš„é‚£ä¸ªï¼šæˆ‘ä»¬å¯ä»¥å°†æ´¾ç”Ÿè¡¨ä¸å¤–å±‚æŸ¥è¯¢çš„è¡¨åˆå¹¶ï¼Œç„¶åå°†æ´¾ç”Ÿè¡¨ä¸­çš„æœç´¢æ¡ä»¶æ”¾åˆ°å¤–å±‚æŸ¥è¯¢çš„æœç´¢æ¡ä»¶ä¸­ï¼Œå°±åƒè¿™æ ·ï¼šè¿™æ ·é€šè¿‡å°†å¤–å±‚æŸ¥è¯¢å’Œæ´¾ç”Ÿè¡¨åˆå¹¶çš„æ–¹å¼æˆåŠŸçš„æ¶ˆé™¤äº†æ´¾ç”Ÿè¡¨ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬æ²¡å¿…è¦å†ä»˜å‡ºåˆ›å»ºå’Œè®¿é—®ä¸´æ—¶è¡¨çš„æˆæœ¬äº†ã€‚å¯æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰å¸¦æœ‰æ´¾ç”Ÿè¡¨çš„æŸ¥è¯¢éƒ½èƒ½è¢«æˆåŠŸçš„å’Œå¤–å±‚æŸ¥è¯¢åˆå¹¶ï¼Œå½“æ´¾ç”Ÿè¡¨ä¸­æœ‰è¿™äº›è¯­å¥å°±ä¸å¯ä»¥å’Œå¤–å±‚æŸ¥è¯¢åˆå¹¶ï¼š 1SELECT * FROM (SELECT * FROM s1 WHERE key1 = &#x27;a&#x27;) AS derived_s1; 1SELECT * FROM s1 WHERE key1 = &#x27;a&#x27;; 12345SELECT * FROM ( SELECT * FROM s1 WHERE key1 = &#x27;a&#x27; ) AS derived_s1 INNER JOIN s2 ON derived_s1.key1 = s2.key1 WHERE s2.key2 = 1; 123SELECT * FROM s1 INNER JOIN s2 ON s1.key1 = s2.key1 WHERE s1.key1 = &#x27;a&#x27; AND s2.key2 = 1; èšé›†å‡½æ•°ï¼Œæ¯”å¦‚MAX()ã€MIN()ã€SUM()â€¦ DISTINCT GROUP BY HAVING LIMIT UNION æˆ–è€… UNION ALL æ´¾ç”Ÿè¡¨å¯¹åº”çš„å­æŸ¥è¯¢çš„SELECTå­å¥ä¸­å«æœ‰å¦ä¸€ä¸ªå­æŸ¥è¯¢ â€¦ è¿˜æœ‰äº›ä¸å¸¸ç”¨çš„æƒ…å†µâ€¦ æ‰€ä»¥MySQLåœ¨æ‰§è¡Œå¸¦æœ‰æ´¾ç”Ÿè¡¨çš„æ—¶å€™ï¼Œä¼˜å…ˆå°è¯•æŠŠæ´¾ç”Ÿè¡¨å’Œå¤–å±‚æŸ¥è¯¢åˆå¹¶æ‰ï¼Œå¦‚æœä¸è¡Œçš„è¯ï¼Œå†æŠŠæ´¾ç”Ÿè¡¨ç‰©åŒ–æ‰æ‰§è¡ŒæŸ¥è¯¢ã€‚ 4.æ€»ç»“MySQLä¼šå¯¹ç”¨æˆ·ç¼–å†™çš„SQLè¯­å¥è¿›è¡Œé‡å†™æ“ä½œï¼Œæ¯”å¦‚ï¼š ç§»é™¤ä¸å¿…è¦çš„æ‹¬å· å¸¸é‡ä¼ é€’ ç§»é™¤æ²¡ç”¨çš„æ¡ä»¶ è¡¨è¾¾å¼è®¡ç®— HAVING&amp;WHEREå­å¥çš„åˆå¹¶ å¸¸é‡è¡¨æ£€æµ‹ åœ¨è¢«é©±åŠ¨è¡¨çš„WHEREå­å¥ç¬¦åˆç©ºå€¼æ‹’ç»æ¡ä»¶çš„æ—¶å€™ï¼Œå¤–è¿æ¥&amp;å†…è¿æ¥å¯ä»¥ç›¸äº’è½¬æ¢ã€‚ å­æŸ¥è¯¢å¯ä»¥æŒ‰ç…§ä¸åŒç»´åº¦è¿›è¡Œä¸åŒåˆ†ç±»ï¼Œæ¯”å¦‚æŒ‰ç…§å­æŸ¥è¯¢è¿”å›çš„ç»“æœé›†åˆ†ç±»ï¼š æ ‡é‡å­æŸ¥è¯¢ è¡Œå­æŸ¥è¯¢ åˆ—å­æŸ¥è¯¢ è¡¨å­æŸ¥è¯¢ æŒ‰ç…§ä¸å¤–å±‚æŸ¥è¯¢çš„å…³ç³»æ¥åˆ†ç±»ï¼š ä¸ç›¸å…³å­æŸ¥è¯¢ ç›¸å…³å­æŸ¥è¯¢ MySQLå¯¹inæŸ¥è¯¢è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ã€‚å¦‚æœinå­æŸ¥è¯¢ç¬¦åˆè½¬æ¢ä¸ºåŠè¿æ¥çš„æ¡ä»¶ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šä¼˜å…ˆæŠŠè¯¥å­æŸ¥è¯¢è½¬æ¢ä¸ºåŠè¿æ¥ï¼Œç„¶åå†è€ƒè™‘ä¸‹é¢äº”ç§æ‰§è¡ŒåŠè¿æ¥æŸ¥è¯¢çš„ç­–ç•¥ä¸­å“ªä¸ªæˆæœ¬æœ€ä½ï¼Œæœ€åé€‰æ‹©æˆæœ¬æœ€ä½çš„æ‰§è¡Œç­–ç•¥æ¥æ‰§è¡Œå­æŸ¥è¯¢ã€‚ table pullout duplicate weedout looseScan Semj-join Materialization FirstMatch å¦‚æœINå­æŸ¥è¯¢ä¸ç¬¦åˆè½¬æ¢ä¸ºåŠè¿æ¥çš„æ¡ä»¶ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šä»ä¸‹é¢çš„ä¸¤ç§ç­–ç•¥é‡Œé¢æ‰¾å‡ºä¸€ç§æˆæœ¬æ›´ä½çš„æ–¹å¼å»æ‰§è¡Œå­æŸ¥è¯¢ï¼š å…ˆå°†å­æŸ¥è¯¢ç‰©åŒ–ï¼Œåœ¨æ‰§è¡Œå­æŸ¥è¯¢ æ‰§è¡Œinåˆ°existsçš„è½¬æ¢ MySQLåœ¨å¤„ç†å¸¦æœ‰æ´¾ç”Ÿè¡¨çš„è¯­å¥çš„æ—¶å€™ï¼Œä¼˜å…ˆå°è¯•æŠŠæ´¾ç”Ÿè¡¨å’Œå¤–å±‚æŸ¥è¯¢è¿›è¡Œåˆå¹¶ï¼›å¦‚æœä¸è¡Œï¼Œå†æŠŠæ´¾ç”Ÿè¡¨ç‰©åŒ–æ‰ï¼Œç„¶åæ‰§è¡ŒæŸ¥è¯¢ã€‚","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[å…«]InnoDBç»Ÿè®¡æ•°æ®æ”¶é›†åŸç†","slug":"MySQL/MySQL[å…«]InnoDBç»Ÿè®¡æ•°æ®æ”¶é›†åŸç†","date":"2022-01-11T03:16:18.849Z","updated":"2022-01-11T03:22:22.716Z","comments":true,"path":"2022/01/11/MySQL/MySQL[å…«]InnoDBç»Ÿè®¡æ•°æ®æ”¶é›†åŸç†/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E5%85%AB]InnoDB%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86%E5%8E%9F%E7%90%86/","excerpt":"","text":"æœ¬ç¯‡æˆ‘ä»¬æ¥åˆ†æä¸‹InnoDBå­˜å‚¨å¼•æ“çš„ç»Ÿè®¡æ•°æ®æ”¶é›†ç­–ç•¥ã€‚ 1.ç»Ÿè®¡æ•°æ®çš„å­˜å‚¨æ–¹å¼InnoDBæä¾›äº†ä¸¤ç§å­˜å‚¨ç»Ÿè®¡æ•°æ®çš„æ–¹å¼ï¼š æ°¸ä¹…æ€§çš„ç»Ÿè®¡æ•°æ®è¿™ç§ç»Ÿè®¡æ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å™¨é‡å¯ä¹‹åè¿™äº›ç»Ÿè®¡æ•°æ®è¿˜åœ¨ã€‚ éæ°¸ä¹…æ€§çš„ç»Ÿè®¡æ•°æ®è¿™ç§ç»Ÿè®¡æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå½“æœåŠ¡å™¨å…³é—­æ—¶è¿™äº›è¿™äº›ç»Ÿè®¡æ•°æ®å°±éƒ½è¢«æ¸…é™¤æ‰äº†ï¼Œç­‰åˆ°æœåŠ¡å™¨é‡å¯ä¹‹åï¼Œåœ¨æŸäº›é€‚å½“çš„åœºæ™¯ä¸‹æ‰ä¼šé‡æ–°æ”¶é›†è¿™äº›ç»Ÿè®¡æ•°æ®ã€‚ MySQLæä¾›äº†ç³»ç»Ÿå˜é‡innodb_stats_persistentæ¥æ§åˆ¶åˆ°åº•é‡‡ç”¨å“ªç§æ–¹å¼å»å­˜å‚¨ç»Ÿè®¡æ•°æ®ã€‚åœ¨MySQL 5.6.6ä¹‹å‰ï¼Œinnodb_stats_persistentçš„å€¼é»˜è®¤æ˜¯OFFï¼Œä¹Ÿå°±æ˜¯è¯´InnoDBçš„ç»Ÿè®¡æ•°æ®é»˜è®¤æ˜¯å­˜å‚¨åˆ°å†…å­˜çš„ï¼Œä¹‹åçš„ç‰ˆæœ¬ä¸­innodb_stats_persistentçš„å€¼é»˜è®¤æ˜¯ONï¼Œä¹Ÿå°±æ˜¯ç»Ÿè®¡æ•°æ®é»˜è®¤è¢«å­˜å‚¨åˆ°ç£ç›˜ä¸­ã€‚ ä¸è¿‡InnoDBé»˜è®¤æ˜¯ä»¥è¡¨ä¸ºå•ä½æ¥æ”¶é›†å’Œå­˜å‚¨ç»Ÿè®¡æ•°æ®çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥æŠŠæŸäº›è¡¨çš„ç»Ÿè®¡æ•°æ®ï¼ˆä»¥åŠè¯¥è¡¨çš„ç´¢å¼•ç»Ÿè®¡æ•°æ®ï¼‰å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼ŒæŠŠå¦ä¸€äº›è¡¨çš„ç»Ÿè®¡æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºå’Œä¿®æ”¹è¡¨çš„æ—¶å€™é€šè¿‡æŒ‡å®šSTATS_PERSISTENTå±æ€§æ¥æŒ‡æ˜è¯¥è¡¨çš„ç»Ÿè®¡æ•°æ®å­˜å‚¨æ–¹å¼ï¼š 123CREATE TABLE è¡¨å (...) Engine=InnoDB, STATS_PERSISTENT = (1|0);ALTER TABLE è¡¨å Engine=InnoDB, STATS_PERSISTENT = (1|0); å½“STATS_PERSISTENT=1æ—¶ï¼Œè¡¨æ˜æˆ‘ä»¬æƒ³æŠŠè¯¥è¡¨çš„ç»Ÿè®¡æ•°æ®æ°¸ä¹…çš„å­˜å‚¨åˆ°ç£ç›˜ä¸Šï¼Œå½“STATS_PERSISTENT=0æ—¶ï¼Œè¡¨æ˜æˆ‘ä»¬æƒ³æŠŠè¯¥è¡¨çš„ç»Ÿè®¡æ•°æ®ä¸´æ—¶çš„å­˜å‚¨åˆ°å†…å­˜ä¸­ã€‚å¦‚æœæˆ‘ä»¬åœ¨åˆ›å»ºè¡¨æ—¶æœªæŒ‡å®šSTATS_PERSISTENTå±æ€§ï¼Œé‚£é»˜è®¤é‡‡ç”¨ç³»ç»Ÿå˜é‡innodb_stats_persistentçš„å€¼ä½œä¸ºè¯¥å±æ€§çš„å€¼ã€‚ 2.æ°¸ä¹…æ€§ç»Ÿè®¡æ•°æ®å½“æˆ‘ä»¬é€‰æ‹©æŠŠæŸä¸ªè¡¨ä»¥åŠè¯¥è¡¨ç´¢å¼•çš„ç»Ÿè®¡æ•°æ®å­˜æ”¾åˆ°ç£ç›˜ä¸Šæ—¶ï¼Œå®é™…ä¸Šæ˜¯æŠŠè¿™äº›ç»Ÿè®¡æ•°æ®å­˜å‚¨åˆ°äº†ä¸¤ä¸ªè¡¨é‡Œï¼š 12345678mysql&gt; SHOW TABLES FROM mysql LIKE &#x27;innodb%&#x27;;+---------------------------+| Tables_in_mysql (innodb%) |+---------------------------+| innodb_index_stats || innodb_table_stats |+---------------------------+2 rows in set (0.01 sec) å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸¤ä¸ªè¡¨éƒ½ä½äºmysqlç³»ç»Ÿæ•°æ®åº“ä¸‹è¾¹ï¼Œå…¶ä¸­ï¼š innodb_table_statså­˜å‚¨äº†å…³äºè¡¨çš„ç»Ÿè®¡æ•°æ®ï¼Œæ¯ä¸€æ¡è®°å½•å¯¹åº”ç€ä¸€ä¸ªè¡¨çš„ç»Ÿè®¡æ•°æ®ã€‚ innodb_index_statså­˜å‚¨äº†å…³äºç´¢å¼•çš„ç»Ÿè®¡æ•°æ®ï¼Œæ¯ä¸€æ¡è®°å½•å¯¹åº”ç€ä¸€ä¸ªç´¢å¼•çš„ä¸€ä¸ªç»Ÿè®¡é¡¹çš„ç»Ÿè®¡æ•°æ®ã€‚ çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªè¡¨é‡Œè¾¹éƒ½æœ‰ä»€ä¹ˆä»¥åŠè¡¨é‡Œçš„æ•°æ®æ˜¯å¦‚ä½•ç”Ÿæˆçš„ã€‚ 2.1 innodb_table_statsç›´æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªinnodb_table_statsè¡¨ä¸­çš„å„ä¸ªåˆ—éƒ½æ˜¯å¹²å˜›çš„ï¼š å­—æ®µå æè¿° database_name æ•°æ®åº“å table_name è¡¨å last_update æœ¬æ¡è®°å½•æœ€åæ›´æ–°æ—¶é—´ n_rows è¡¨ä¸­è®°å½•çš„æ¡æ•° clustered_index_size è¡¨çš„èšç°‡ç´¢å¼•å ç”¨çš„é¡µé¢æ•°é‡ sum_of_other_index_sizes è¡¨çš„å…¶ä»–ç´¢å¼•å ç”¨çš„é¡µé¢æ•°é‡ æ³¨æ„è¿™ä¸ªè¡¨çš„ä¸»é”®æ˜¯(database_name,table_name)ï¼Œä¹Ÿå°±æ˜¯innodb_table_statsè¡¨çš„æ¯æ¡è®°å½•ä»£è¡¨ç€ä¸€ä¸ªè¡¨çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ 12345678910mysql&gt; SELECT * FROM mysql.innodb_table_stats;+---------------+---------------+---------------------+--------+----------------------+--------------------------+| database_name | table_name | last_update | n_rows | clustered_index_size | sum_of_other_index_sizes |+---------------+---------------+---------------------+--------+----------------------+--------------------------+| mysql | gtid_executed | 2021-12-14 00:00:08 | 0 | 1 | 0 || sys | sys_config | 2021-12-14 00:00:09 | 6 | 1 | 0 || yhd | person_info | 2021-12-19 00:27:39 | 0 | 1 | 1 || yhd | single_table | 2021-12-19 02:13:19 | 910545 | 3109 | 5836 |+---------------+---------------+---------------------+--------+----------------------+--------------------------+4 rows in set (0.00 sec) å¯ä»¥çœ‹åˆ°single_tableè¡¨çš„ç»Ÿè®¡ä¿¡æ¯å°±å¯¹åº”ç€mysql.innodb_table_statsçš„ç¬¬ä¸‰æ¡è®°å½•ã€‚å‡ ä¸ªé‡è¦ç»Ÿè®¡ä¿¡æ¯é¡¹çš„å€¼å¦‚ä¸‹ï¼š n_rowsçš„å€¼æ˜¯9693ï¼Œè¡¨æ˜single_tableè¡¨ä¸­å¤§çº¦æœ‰9693æ¡è®°å½•ï¼Œæ³¨æ„è¿™ä¸ªæ•°æ®æ˜¯ä¼°è®¡å€¼ã€‚ clustered_index_sizeçš„å€¼æ˜¯97ï¼Œè¡¨æ˜single_tableè¡¨çš„èšç°‡ç´¢å¼•å ç”¨97ä¸ªé¡µé¢ï¼Œè¿™ä¸ªå€¼æ˜¯ä¹Ÿæ˜¯ä¸€ä¸ªä¼°è®¡å€¼ã€‚ sum_of_other_index_sizesçš„å€¼æ˜¯175ï¼Œè¡¨æ˜single_tableè¡¨çš„å…¶ä»–ç´¢å¼•ä¸€å…±å ç”¨175ä¸ªé¡µé¢ï¼Œè¿™ä¸ªå€¼æ˜¯ä¹Ÿæ˜¯ä¸€ä¸ªä¼°è®¡å€¼ã€‚ 2.1.1 n_rowsç»Ÿè®¡é¡¹çš„æ”¶é›†ä¸ºå•¥n_rowsè¿™ä¸ªç»Ÿè®¡é¡¹çš„å€¼æ˜¯ä¼°è®¡å€¼å‘¢ï¼ŸInnoDB`ç»Ÿè®¡ä¸€ä¸ªè¡¨ä¸­æœ‰å¤šå°‘è¡Œè®°å½•çš„å¥—è·¯æ˜¯è¿™æ ·çš„ï¼š æŒ‰ç…§ä¸€å®šç®—æ³•ï¼ˆå¹¶ä¸æ˜¯çº¯ç²¹éšæœºçš„ï¼‰é€‰å–å‡ ä¸ªå¶å­èŠ‚ç‚¹é¡µé¢ï¼Œè®¡ç®—æ¯ä¸ªé¡µé¢ä¸­ä¸»é”®å€¼è®°å½•æ•°é‡ï¼Œç„¶åè®¡ç®—å¹³å‡ä¸€ä¸ªé¡µé¢ä¸­ä¸»é”®å€¼çš„è®°å½•æ•°é‡ä¹˜ä»¥å…¨éƒ¨å¶å­èŠ‚ç‚¹çš„æ•°é‡å°±ç®—æ˜¯è¯¥è¡¨çš„n_rowså€¼ã€‚ çœŸå®çš„è®¡ç®—è¿‡ç¨‹æ¯”è¿™ä¸ªç¨å¾®å¤æ‚ä¸€äº›ï¼Œä¸è¿‡å¤§è‡´ä¸Šå°±æ˜¯è¿™æ ·ã€‚ å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªn_rowså€¼ç²¾ç¡®ä¸å¦å–å†³äºç»Ÿè®¡æ—¶é‡‡æ ·çš„é¡µé¢æ•°é‡ï¼ŒMySQLä¸ºæˆ‘ä»¬å‡†å¤‡äº†ä¸€ä¸ªåä¸ºinnodb_stats_persistent_sample_pagesçš„ç³»ç»Ÿå˜é‡æ¥æ§åˆ¶ä½¿ç”¨æ°¸ä¹…æ€§çš„ç»Ÿè®¡æ•°æ®æ—¶ï¼Œè®¡ç®—ç»Ÿè®¡æ•°æ®æ—¶é‡‡æ ·çš„é¡µé¢æ•°é‡ã€‚è¯¥å€¼è®¾ç½®çš„è¶Šå¤§ï¼Œç»Ÿè®¡å‡ºçš„n_rowså€¼è¶Šç²¾ç¡®ï¼Œä½†æ˜¯ç»Ÿè®¡è€—æ—¶ä¹Ÿå°±æœ€ä¹…ï¼›è¯¥å€¼è®¾ç½®çš„è¶Šå°ï¼Œç»Ÿè®¡å‡ºçš„n_rowså€¼è¶Šä¸ç²¾ç¡®ï¼Œä½†æ˜¯ç»Ÿè®¡è€—æ—¶ç‰¹åˆ«å°‘ã€‚æ‰€ä»¥åœ¨å®é™…ä½¿ç”¨æ˜¯éœ€è¦æˆ‘ä»¬å»æƒè¡¡åˆ©å¼Šï¼Œè¯¥ç³»ç»Ÿå˜é‡çš„é»˜è®¤å€¼æ˜¯20ã€‚ æˆ‘ä»¬å‰è¾¹è¯´è¿‡ï¼Œä¸è¿‡InnoDBé»˜è®¤æ˜¯ä»¥è¡¨ä¸ºå•ä½æ¥æ”¶é›†å’Œå­˜å‚¨ç»Ÿè®¡æ•°æ®çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å•ç‹¬è®¾ç½®æŸä¸ªè¡¨çš„é‡‡æ ·é¡µé¢çš„æ•°é‡ï¼Œè®¾ç½®æ–¹å¼å°±æ˜¯åœ¨åˆ›å»ºæˆ–ä¿®æ”¹è¡¨çš„æ—¶å€™é€šè¿‡æŒ‡å®šSTATS_SAMPLE_PAGESå±æ€§æ¥æŒ‡æ˜è¯¥è¡¨çš„ç»Ÿè®¡æ•°æ®å­˜å‚¨æ–¹å¼ï¼š 123CREATE TABLE è¡¨å (...) Engine=InnoDB, STATS_SAMPLE_PAGES = å…·ä½“çš„é‡‡æ ·é¡µé¢æ•°é‡;ALTER TABLE è¡¨å Engine=InnoDB, STATS_SAMPLE_PAGES = å…·ä½“çš„é‡‡æ ·é¡µé¢æ•°é‡; å¦‚æœæˆ‘ä»¬åœ¨åˆ›å»ºè¡¨çš„è¯­å¥ä¸­å¹¶æ²¡æœ‰æŒ‡å®šSTATS_SAMPLE_PAGESå±æ€§çš„è¯ï¼Œå°†é»˜è®¤ä½¿ç”¨ç³»ç»Ÿå˜é‡innodb_stats_persistent_sample_pagesçš„å€¼ä½œä¸ºè¯¥å±æ€§çš„å€¼ã€‚ 2.1.2 clustered_index_sizeå’Œsum_of_other_index_sizesç»Ÿè®¡é¡¹çš„æ”¶é›†è¿™ä¸¤ä¸ªç»Ÿè®¡é¡¹çš„æ”¶é›†è¿‡ç¨‹å¦‚ä¸‹ï¼š ä»æ•°æ®å­—å…¸é‡Œæ‰¾åˆ°è¡¨çš„å„ä¸ªç´¢å¼•å¯¹åº”çš„æ ¹é¡µé¢ä½ç½®ã€‚ç³»ç»Ÿè¡¨SYS_INDEXESé‡Œå­˜å‚¨äº†å„ä¸ªç´¢å¼•å¯¹åº”çš„æ ¹é¡µé¢ä¿¡æ¯ã€‚ ä»æ ¹é¡µé¢çš„Page Headeré‡Œæ‰¾åˆ°å¶å­èŠ‚ç‚¹æ®µå’Œéå¶å­èŠ‚ç‚¹æ®µå¯¹åº”çš„Segment Headerã€‚åœ¨æ¯ä¸ªç´¢å¼•çš„æ ¹é¡µé¢çš„Page Headeréƒ¨åˆ†éƒ½æœ‰ä¸¤ä¸ªå­—æ®µï¼š PAGE_BTR_SEG_LEAFï¼šè¡¨ç¤ºB+æ ‘å¶å­æ®µçš„Segment Headerä¿¡æ¯ã€‚ PAGE_BTR_SEG_TOPï¼šè¡¨ç¤ºB+æ ‘éå¶å­æ®µçš„Segment Headerä¿¡æ¯ã€‚ ä»å¶å­èŠ‚ç‚¹æ®µå’Œéå¶å­èŠ‚ç‚¹æ®µçš„Segment Headerä¸­æ‰¾åˆ°è¿™ä¸¤ä¸ªæ®µå¯¹åº”çš„INODE Entryç»“æ„ã€‚è¿™ä¸ªæ˜¯Segment Headerç»“æ„ï¼š ä»å¯¹åº”çš„INODE Entryç»“æ„ä¸­å¯ä»¥æ‰¾åˆ°è¯¥æ®µå¯¹åº”æ‰€æœ‰é›¶æ•£çš„é¡µé¢åœ°å€ä»¥åŠFREEã€NOT_FULLã€FULLé“¾è¡¨çš„åŸºèŠ‚ç‚¹ã€‚è¿™ä¸ªæ˜¯INODE Entryç»“æ„ï¼š ç›´æ¥ç»Ÿè®¡é›¶æ•£çš„é¡µé¢æœ‰å¤šå°‘ä¸ªï¼Œç„¶åä»é‚£ä¸‰ä¸ªé“¾è¡¨çš„List Lengthå­—æ®µä¸­è¯»å‡ºè¯¥æ®µå ç”¨çš„åŒºçš„å¤§å°ï¼Œæ¯ä¸ªåŒºå ç”¨64ä¸ªé¡µï¼Œæ‰€ä»¥å°±å¯ä»¥ç»Ÿè®¡å‡ºæ•´ä¸ªæ®µå ç”¨çš„é¡µé¢ã€‚è¿™ä¸ªæ˜¯é“¾è¡¨åŸºèŠ‚ç‚¹çš„ç¤ºæ„å›¾ï¼š åˆ†åˆ«è®¡ç®—èšç°‡ç´¢å¼•çš„å¶å­ç»“ç‚¹æ®µå’Œéå¶å­èŠ‚ç‚¹æ®µå ç”¨çš„é¡µé¢æ•°ï¼Œå®ƒä»¬çš„å’Œå°±æ˜¯clustered_index_sizeçš„å€¼ï¼ŒæŒ‰ç…§åŒæ ·çš„å¥—è·¯æŠŠå…¶ä½™ç´¢å¼•å ç”¨çš„é¡µé¢æ•°éƒ½ç®—å‡ºæ¥ï¼ŒåŠ èµ·æ¥ä¹‹åå°±æ˜¯sum_of_other_index_sizesçš„å€¼ã€‚ æ³¨æ„ï¼Œæˆ‘ä»¬è¯´ä¸€ä¸ªæ®µçš„æ•°æ®åœ¨éå¸¸å¤šæ—¶ï¼ˆè¶…è¿‡32ä¸ªé¡µé¢ï¼‰ï¼Œä¼šä»¥åŒºä¸ºå•ä½æ¥ç”³è¯·ç©ºé—´ï¼Œè¿™é‡Œå¤´çš„é—®é¢˜æ˜¯ä»¥åŒºä¸ºå•ä½ç”³è¯·ç©ºé—´ä¸­æœ‰ä¸€äº›é¡µå¯èƒ½å¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨ç»Ÿè®¡clustered_index_sizeå’Œsum_of_other_index_sizesæ—¶éƒ½æŠŠå®ƒä»¬ç®—è¿›å»äº†ï¼Œæ‰€ä»¥è¯´èšç°‡ç´¢å¼•å’Œå…¶ä»–çš„ç´¢å¼•å ç”¨çš„é¡µé¢æ•°å¯èƒ½æ¯”è¿™ä¸¤ä¸ªå€¼è¦å°ä¸€äº›ã€‚ 2.2 innodb_index_statsç›´æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªinnodb_index_statsè¡¨ä¸­çš„å„ä¸ªåˆ—ï¼š å­—æ®µå æè¿° database_name æ•°æ®åº“å table_name è¡¨å index_name ç´¢å¼•å last_update æœ¬æ¡è®°å½•æœ€åæ›´æ–°æ—¶é—´ stat_name ç»Ÿè®¡é¡¹çš„åç§° stat_value å¯¹åº”çš„ç»Ÿè®¡é¡¹çš„å€¼ sample_size ä¸ºç”Ÿæˆç»Ÿè®¡æ•°æ®è€Œé‡‡æ ·çš„é¡µé¢æ•°é‡ stat_description å¯¹åº”çš„ç»Ÿè®¡é¡¹çš„æè¿° æ³¨æ„è¿™ä¸ªè¡¨çš„ä¸»é”®æ˜¯(database_name,table_name,index_name,stat_name)ï¼Œå…¶ä¸­çš„stat_nameæ˜¯æŒ‡ç»Ÿè®¡é¡¹çš„åç§°ï¼Œä¹Ÿå°±æ˜¯è¯´innodb_index_statsè¡¨çš„æ¯æ¡è®°å½•ä»£è¡¨ç€ä¸€ä¸ªç´¢å¼•çš„ä¸€ä¸ªç»Ÿè®¡é¡¹ã€‚æˆ‘ä»¬ç›´æ¥çœ‹ä¸€ä¸‹å…³äºsingle_tableè¡¨çš„ç´¢å¼•ç»Ÿè®¡æ•°æ®éƒ½æœ‰äº›ä»€ä¹ˆï¼š 1234567891011121314151617181920212223242526mysql&gt; SELECT * FROM mysql.innodb_index_stats WHERE table_name = &#x27;single_table&#x27;;+---------------+--------------+--------------+---------------------+--------------+------------+-------------+-----------------------------------+| database_name | table_name | index_name | last_update | stat_name | stat_value | sample_size | stat_description |+---------------+--------------+--------------+---------------------+--------------+------------+-------------+-----------------------------------+| yhd | single_table | PRIMARY | 2021-12-19 02:13:19 | n_diff_pfx01 | 910518 | 20 | id || yhd | single_table | PRIMARY | 2021-12-19 02:13:19 | n_leaf_pages | 3097 | NULL | Number of leaf pages in the index || yhd | single_table | PRIMARY | 2021-12-19 02:13:19 | size | 3109 | NULL | Number of pages in the index || yhd | single_table | idx_key1 | 2021-12-19 02:13:19 | n_diff_pfx01 | 8 | 10 | key1 || yhd | single_table | idx_key1 | 2021-12-19 02:13:19 | n_diff_pfx02 | 882192 | 20 | key1,id || yhd | single_table | idx_key1 | 2021-12-19 02:13:19 | n_leaf_pages | 828 | NULL | Number of leaf pages in the index || yhd | single_table | idx_key1 | 2021-12-19 02:13:19 | size | 993 | NULL | Number of pages in the index || yhd | single_table | idx_key3 | 2021-12-19 02:13:19 | n_diff_pfx01 | 8 | 10 | key3 || yhd | single_table | idx_key3 | 2021-12-19 02:13:19 | n_diff_pfx02 | 910072 | 20 | key3,id || yhd | single_table | idx_key3 | 2021-12-19 02:13:19 | n_leaf_pages | 827 | NULL | Number of leaf pages in the index || yhd | single_table | idx_key3 | 2021-12-19 02:13:19 | size | 993 | NULL | Number of pages in the index || yhd | single_table | idx_key_part | 2021-12-19 02:13:19 | n_diff_pfx01 | 8 | 10 | key_part1 || yhd | single_table | idx_key_part | 2021-12-19 02:13:19 | n_diff_pfx02 | 82 | 20 | key_part1,key_part2 || yhd | single_table | idx_key_part | 2021-12-19 02:13:19 | n_diff_pfx03 | 730 | 20 | key_part1,key_part2,key_part3 || yhd | single_table | idx_key_part | 2021-12-19 02:13:19 | n_diff_pfx04 | 1028534 | 20 | key_part1,key_part2,key_part3,id || yhd | single_table | idx_key_part | 2021-12-19 02:13:19 | n_leaf_pages | 2556 | NULL | Number of leaf pages in the index || yhd | single_table | idx_key_part | 2021-12-19 02:13:19 | size | 2985 | NULL | Number of pages in the index || yhd | single_table | uk_key2 | 2021-12-19 02:13:19 | n_diff_pfx01 | 913104 | 20 | key2 || yhd | single_table | uk_key2 | 2021-12-19 02:13:19 | n_leaf_pages | 816 | NULL | Number of leaf pages in the index || yhd | single_table | uk_key2 | 2021-12-19 02:13:19 | size | 865 | NULL | Number of pages in the index |+---------------+--------------+--------------+---------------------+--------------+------------+-------------+-----------------------------------+20 rows in set (0.01 sec) è¿™ä¸ªç»“æœæœ‰ç‚¹å„¿å¤šï¼Œæ­£ç¡®æŸ¥çœ‹è¿™ä¸ªç»“æœçš„æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š å…ˆæŸ¥çœ‹index_nameåˆ—ï¼Œè¿™ä¸ªåˆ—è¯´æ˜è¯¥è®°å½•æ˜¯å“ªä¸ªç´¢å¼•çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä»ç»“æœä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼ŒPRIMARYç´¢å¼•ï¼ˆä¹Ÿå°±æ˜¯ä¸»é”®ï¼‰å äº†3æ¡è®°å½•ï¼Œidx_key_partç´¢å¼•å äº†6æ¡è®°å½•ã€‚ é’ˆå¯¹index_nameåˆ—ç›¸åŒçš„è®°å½•ï¼Œstat_nameè¡¨ç¤ºé’ˆå¯¹è¯¥ç´¢å¼•çš„ç»Ÿè®¡é¡¹åç§°ï¼Œstat_valueå±•ç¤ºçš„æ˜¯è¯¥ç´¢å¼•åœ¨è¯¥ç»Ÿè®¡é¡¹ä¸Šçš„å€¼ï¼Œstat_descriptionæŒ‡çš„æ˜¯æ¥æè¿°è¯¥ç»Ÿè®¡é¡¹çš„å«ä¹‰çš„ã€‚æˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹ä¸€ä¸ªç´¢å¼•éƒ½æœ‰å“ªäº›ç»Ÿè®¡é¡¹ï¼š n_leaf_pagesï¼šè¡¨ç¤ºè¯¥ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å ç”¨å¤šå°‘é¡µé¢ã€‚ sizeï¼šè¡¨ç¤ºè¯¥ç´¢å¼•å…±å ç”¨å¤šå°‘é¡µé¢ã€‚ n_diff_pfx**NN**ï¼šè¡¨ç¤ºå¯¹åº”çš„ç´¢å¼•åˆ—ä¸é‡å¤çš„å€¼æœ‰å¤šå°‘ã€‚å…¶å®NNå¯ä»¥è¢«æ›¿æ¢ä¸º01ã€02ã€03â€¦ è¿™æ ·çš„æ•°å­—ã€‚æ¯”å¦‚å¯¹äºidx_key_partæ¥è¯´ï¼š 1. n_diff_pfx01è¡¨ç¤ºçš„æ˜¯ç»Ÿè®¡key_part1è¿™å•å•ä¸€ä¸ªåˆ—ä¸é‡å¤çš„å€¼æœ‰å¤šå°‘ã€‚ 1. n_diff_pfx02è¡¨ç¤ºçš„æ˜¯ç»Ÿè®¡key_part1ã€key_part2è¿™ä¸¤ä¸ªåˆ—ç»„åˆèµ·æ¥ä¸é‡å¤çš„å€¼æœ‰å¤šå°‘ã€‚ 1. n_diff_pfx03è¡¨ç¤ºçš„æ˜¯ç»Ÿè®¡key_part1ã€key_part2ã€key_part3è¿™ä¸‰ä¸ªåˆ—ç»„åˆèµ·æ¥ä¸é‡å¤çš„å€¼æœ‰å¤šå°‘ã€‚ 1. n_diff_pfx04è¡¨ç¤ºçš„æ˜¯ç»Ÿè®¡key_part1ã€key_part2ã€key_part3ã€idè¿™å››ä¸ªåˆ—ç»„åˆèµ·æ¥ä¸é‡å¤çš„å€¼æœ‰å¤šå°‘ã€‚ æ³¨æ„ï¼šå¯¹äºæ™®é€šçš„äºŒçº§ç´¢å¼•ï¼Œå¹¶ä¸èƒ½ä¿è¯å®ƒçš„ç´¢å¼•åˆ—å€¼æ˜¯å”¯ä¸€çš„ï¼Œæ¯”å¦‚å¯¹äºidx_key1æ¥è¯´ï¼Œkey1åˆ—å°±å¯èƒ½æœ‰å¾ˆå¤šå€¼é‡å¤çš„è®°å½•ã€‚æ­¤æ—¶åªæœ‰åœ¨ç´¢å¼•åˆ—ä¸ŠåŠ ä¸Šä¸»é”®å€¼æ‰å¯ä»¥åŒºåˆ†ä¸¤æ¡ç´¢å¼•åˆ—å€¼éƒ½ä¸€æ ·çš„äºŒçº§ç´¢å¼•è®°å½•ã€‚å¯¹äºä¸»é”®å’Œå”¯ä¸€äºŒçº§ç´¢å¼•åˆ™æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œå®ƒä»¬æœ¬èº«å°±å¯ä»¥ä¿è¯ç´¢å¼•åˆ—å€¼çš„ä¸é‡å¤ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦å†ç»Ÿè®¡ä¸€éåœ¨ç´¢å¼•åˆ—ååŠ ä¸Šä¸»é”®å€¼çš„ä¸é‡å¤å€¼æœ‰å¤šå°‘ã€‚æ¯”å¦‚ä¸Šè¾¹çš„idx_key1æœ‰n_diff_pfx01ã€n_diff_pfx02ä¸¤ä¸ªç»Ÿè®¡é¡¹ï¼Œè€Œidx_key2å´åªæœ‰n_diff_pfx01ä¸€ä¸ªç»Ÿè®¡é¡¹ã€‚ åœ¨è®¡ç®—æŸäº›ç´¢å¼•åˆ—ä¸­åŒ…å«å¤šå°‘ä¸é‡å¤å€¼æ—¶ï¼Œéœ€è¦å¯¹ä¸€äº›å¶å­èŠ‚ç‚¹é¡µé¢è¿›è¡Œé‡‡æ ·ï¼Œsample_sizeåˆ—å°±è¡¨æ˜äº†é‡‡æ ·çš„é¡µé¢æ•°é‡æ˜¯å¤šå°‘ã€‚ æ³¨æ„ï¼šå¯¹äºæœ‰å¤šä¸ªåˆ—çš„è”åˆç´¢å¼•æ¥è¯´ï¼Œé‡‡æ ·çš„é¡µé¢æ•°é‡æ˜¯ï¼šinnodb_stats_persistent_sample_pages Ã— ç´¢å¼•åˆ—çš„ä¸ªæ•°ã€‚å½“éœ€è¦é‡‡æ ·çš„é¡µé¢æ•°é‡å¤§äºè¯¥ç´¢å¼•çš„å¶å­èŠ‚ç‚¹æ•°é‡çš„è¯ï¼Œå°±ç›´æ¥é‡‡ç”¨å…¨è¡¨æ‰«ææ¥ç»Ÿè®¡ç´¢å¼•åˆ—çš„ä¸é‡å¤å€¼æ•°é‡äº†ã€‚æ‰€ä»¥åœ¨æŸ¥è¯¢ç»“æœä¸­çœ‹åˆ°ä¸åŒç´¢å¼•å¯¹åº”çš„sizeåˆ—çš„å€¼å¯èƒ½æ˜¯ä¸åŒçš„ã€‚ 2.3å®šæœŸæ›´æ–°ç»Ÿè®¡æ•°æ®éšç€æˆ‘ä»¬ä¸æ–­çš„å¯¹è¡¨è¿›è¡Œå¢åˆ æ”¹æ“ä½œï¼Œè¡¨ä¸­çš„æ•°æ®ä¹Ÿä¸€ç›´åœ¨å˜åŒ–ï¼Œinnodb_table_statså’Œinnodb_index_statsè¡¨é‡Œçš„ç»Ÿè®¡æ•°æ®æ˜¯è¦å˜çš„ï¼Œä¸å˜çš„è¯MySQLæŸ¥è¯¢ä¼˜åŒ–å™¨è®¡ç®—çš„æˆæœ¬å°±ä¼šæœ‰é—®é¢˜ã€‚MySQLæä¾›äº†å¦‚ä¸‹ä¸¤ç§æ›´æ–°ç»Ÿè®¡æ•°æ®çš„æ–¹å¼ï¼š å¼€å¯innodb_stats_auto_recalcã€‚ç³»ç»Ÿå˜é‡innodb_stats_auto_recalcå†³å®šç€æœåŠ¡å™¨æ˜¯å¦è‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼Œå®ƒçš„é»˜è®¤å€¼æ˜¯ONï¼Œä¹Ÿå°±æ˜¯è¯¥åŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„ã€‚æ¯ä¸ªè¡¨éƒ½ç»´æŠ¤äº†ä¸€ä¸ªå˜é‡ï¼Œè¯¥å˜é‡è®°å½•ç€å¯¹è¯¥è¡¨è¿›è¡Œå¢åˆ æ”¹çš„è®°å½•æ¡æ•°ï¼Œå¦‚æœå‘ç”Ÿå˜åŠ¨çš„è®°å½•æ•°é‡è¶…è¿‡äº†è¡¨å¤§å°çš„10%ï¼Œå¹¶ä¸”è‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®çš„åŠŸèƒ½æ˜¯æ‰“å¼€çš„ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šé‡æ–°è¿›è¡Œä¸€æ¬¡ç»Ÿè®¡æ•°æ®çš„è®¡ç®—ï¼Œå¹¶ä¸”æ›´æ–°innodb_table_statså’Œinnodb_index_statsè¡¨ã€‚ä¸è¿‡è‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®çš„è¿‡ç¨‹æ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼Œä¹Ÿå°±æ˜¯å³ä½¿è¡¨ä¸­å˜åŠ¨çš„è®°å½•æ•°è¶…è¿‡äº†10%ï¼Œè‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®ä¹Ÿä¸ä¼šç«‹å³å‘ç”Ÿï¼Œå¯èƒ½ä¼šå»¶è¿Ÿå‡ ç§’æ‰ä¼šè¿›è¡Œè®¡ç®—ã€‚InnoDBé»˜è®¤æ˜¯ä»¥è¡¨ä¸ºå•ä½æ¥æ”¶é›†å’Œå­˜å‚¨ç»Ÿè®¡æ•°æ®çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å•ç‹¬ä¸ºæŸä¸ªè¡¨è®¾ç½®æ˜¯å¦è‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°çš„å±æ€§ï¼Œè®¾ç½®æ–¹å¼å°±æ˜¯åœ¨åˆ›å»ºæˆ–ä¿®æ”¹è¡¨çš„æ—¶å€™é€šè¿‡æŒ‡å®šSTATS_AUTO_RECALCå±æ€§æ¥æŒ‡æ˜è¯¥è¡¨çš„ç»Ÿè®¡æ•°æ®å­˜å‚¨æ–¹å¼ï¼šå½“STATS_AUTO_RECALC=1æ—¶ï¼Œè¡¨æ˜æˆ‘ä»¬æƒ³è®©è¯¥è¡¨è‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼Œå½“STATS_AUTO_RECALC=0æ—¶ï¼Œè¡¨æ˜ä¸æƒ³è®©è¯¥è¡¨è‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬åœ¨åˆ›å»ºè¡¨æ—¶æœªæŒ‡å®šSTATS_AUTO_RECALCå±æ€§ï¼Œé‚£é»˜è®¤é‡‡ç”¨ç³»ç»Ÿå˜é‡innodb_stats_auto_recalcçš„å€¼ä½œä¸ºè¯¥å±æ€§çš„å€¼ã€‚ 123CREATE TABLE è¡¨å (...) Engine=InnoDB, STATS_AUTO_RECALC = (1|0);ALTER TABLE è¡¨å Engine=InnoDB, STATS_AUTO_RECALC = (1|0); æ‰‹åŠ¨è°ƒç”¨ANALYZE TABLEè¯­å¥æ¥æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¦‚æœinnodb_stats_auto_recalcç³»ç»Ÿå˜é‡çš„å€¼ä¸ºOFFçš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨è°ƒç”¨ANALYZE TABLEè¯­å¥æ¥é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥è¿™æ ·æ›´æ–°å…³äºsingle_tableè¡¨çš„ç»Ÿè®¡æ•°æ®ï¼šéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒANALYZE TABLEè¯­å¥ä¼šç«‹å³é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªè¿‡ç¨‹æ˜¯åŒæ­¥çš„ï¼Œåœ¨è¡¨ä¸­ç´¢å¼•å¤šæˆ–è€…é‡‡æ ·é¡µé¢ç‰¹åˆ«å¤šæ—¶è¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šç‰¹åˆ«æ…¢ï¼Œè¯·ä¸è¦æ²¡äº‹å„¿å°±è¿è¡Œä¸€ä¸‹ANALYZE TABLEè¯­å¥ï¼Œæœ€å¥½åœ¨ä¸šåŠ¡ä¸æ˜¯å¾ˆç¹å¿™çš„æ—¶å€™å†è¿è¡Œã€‚ 1234567mysql&gt; ANALYZE TABLE single_table;+------------------------+---------+----------+----------+| Table | Op | Msg_type | Msg_text |+------------------------+---------+----------+----------+| yhd.single_table | analyze | status | OK |+------------------------+---------+----------+----------+1 row in set (0.08 sec) 2.4æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡æ•°æ®å…¶å®innodb_table_statså’Œinnodb_index_statsè¡¨å°±ç›¸å½“äºä¸€ä¸ªæ™®é€šçš„è¡¨ä¸€æ ·ï¼Œæˆ‘ä»¬èƒ½å¯¹å®ƒä»¬åšå¢åˆ æ”¹æŸ¥æ“ä½œã€‚è¿™ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ›´æ–°æŸä¸ªè¡¨æˆ–è€…ç´¢å¼•çš„ç»Ÿè®¡æ•°æ®ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬æƒ³æŠŠsingle_tableè¡¨å…³äºè¡Œæ•°çš„ç»Ÿè®¡æ•°æ®æ›´æ”¹ä¸€ä¸‹å¯ä»¥è¿™ä¹ˆåšï¼š æ­¥éª¤ä¸€ï¼šæ›´æ–°innodb_table_statsè¡¨ã€‚ 123UPDATE innodb_table_stats SET n_rows = 1 WHERE table_name = &#x27;single_table&#x27;; æ­¥éª¤äºŒï¼šè®©MySQLæŸ¥è¯¢ä¼˜åŒ–å™¨é‡æ–°åŠ è½½æˆ‘ä»¬æ›´æ”¹è¿‡çš„æ•°æ®ã€‚æ›´æ–°å®Œinnodb_table_statsåªæ˜¯å•çº¯çš„ä¿®æ”¹äº†ä¸€ä¸ªè¡¨çš„æ•°æ®ï¼Œéœ€è¦è®©MySQLæŸ¥è¯¢ä¼˜åŒ–å™¨é‡æ–°åŠ è½½æˆ‘ä»¬æ›´æ”¹è¿‡çš„æ•°æ®ï¼Œè¿è¡Œä¸‹è¾¹çš„å‘½ä»¤å°±å¯ä»¥äº†ï¼š 1FLUSH TABLE single_table; ä¹‹åæˆ‘ä»¬ä½¿ç”¨SHOW TABLE STATUSè¯­å¥æŸ¥çœ‹è¡¨çš„ç»Ÿè®¡æ•°æ®æ—¶å°±çœ‹åˆ°Rowsè¡Œå˜ä¸ºäº†1ã€‚ 3.éæ°¸ä¹…æ€§ç»Ÿè®¡æ•°æ®å½“æˆ‘ä»¬æŠŠç³»ç»Ÿå˜é‡innodb_stats_persistentçš„å€¼è®¾ç½®ä¸ºOFFæ—¶ï¼Œä¹‹ååˆ›å»ºçš„è¡¨çš„ç»Ÿè®¡æ•°æ®é»˜è®¤å°±éƒ½æ˜¯éæ°¸ä¹…æ€§çš„äº†ï¼Œæˆ–è€…æˆ‘ä»¬ç›´æ¥åœ¨åˆ›å»ºè¡¨æˆ–ä¿®æ”¹è¡¨æ—¶è®¾ç½®STATS_PERSISTENTå±æ€§çš„å€¼ä¸º0ï¼Œé‚£ä¹ˆè¯¥è¡¨çš„ç»Ÿè®¡æ•°æ®å°±æ˜¯éæ°¸ä¹…æ€§çš„äº†ã€‚ ä¸æ°¸ä¹…æ€§çš„ç»Ÿè®¡æ•°æ®ä¸åŒï¼Œéæ°¸ä¹…æ€§çš„ç»Ÿè®¡æ•°æ®é‡‡æ ·çš„é¡µé¢æ•°é‡æ˜¯ç”±innodb_stats_transient_sample_pagesæ§åˆ¶çš„ï¼Œè¿™ä¸ªç³»ç»Ÿå˜é‡çš„é»˜è®¤å€¼æ˜¯8ã€‚ å¦å¤–ï¼Œç”±äºéæ°¸ä¹…æ€§çš„ç»Ÿè®¡æ•°æ®ç»å¸¸æ›´æ–°ï¼Œæ‰€ä»¥å¯¼è‡´MySQLæŸ¥è¯¢ä¼˜åŒ–å™¨è®¡ç®—æŸ¥è¯¢æˆæœ¬çš„æ—¶å€™ä¾èµ–çš„æ˜¯ç»å¸¸å˜åŒ–çš„ç»Ÿè®¡æ•°æ®ï¼Œä¹Ÿå°±ä¼šç”Ÿæˆç»å¸¸å˜åŒ–çš„æ‰§è¡Œè®¡åˆ’ã€‚ 4.innodb_stats_methodç´¢å¼•åˆ—ä¸é‡å¤çš„å€¼çš„æ•°é‡è¿™ä¸ªç»Ÿè®¡æ•°æ®å¯¹äºMySQLæŸ¥è¯¢ä¼˜åŒ–å™¨ååˆ†é‡è¦ï¼Œå› ä¸ºé€šè¿‡å®ƒå¯ä»¥è®¡ç®—å‡ºåœ¨ç´¢å¼•åˆ—ä¸­å¹³å‡ä¸€ä¸ªå€¼é‡å¤å¤šå°‘è¡Œï¼Œå®ƒçš„åº”ç”¨åœºæ™¯ä¸»è¦æœ‰ä¸¤ä¸ªï¼š å•è¡¨æŸ¥è¯¢ä¸­å•ç‚¹åŒºé—´å¤ªå¤šï¼Œæ¯”æ–¹è¯´è¿™æ ·ï¼šå½“INé‡Œçš„å‚æ•°æ•°é‡è¿‡å¤šæ—¶ï¼Œé‡‡ç”¨index diveçš„æ–¹å¼ç›´æ¥è®¿é—®B+æ ‘ç´¢å¼•å»ç»Ÿè®¡æ¯ä¸ªå•ç‚¹åŒºé—´å¯¹åº”çš„è®°å½•çš„æ•°é‡å°±å¤ªè€—è´¹æ€§èƒ½äº†ï¼Œæ‰€ä»¥ç›´æ¥ä¾èµ–ç»Ÿè®¡æ•°æ®ä¸­çš„å¹³å‡ä¸€ä¸ªå€¼é‡å¤å¤šå°‘è¡Œæ¥è®¡ç®—å•ç‚¹åŒºé—´å¯¹åº”çš„è®°å½•æ•°é‡ã€‚ 1SELECT * FROM tbl_name WHERE key IN (&#x27;xx1&#x27;, &#x27;xx2&#x27;, ..., &#x27;xxn&#x27;); è¿æ¥æŸ¥è¯¢æ—¶ï¼Œå¦‚æœæœ‰æ¶‰åŠä¸¤ä¸ªè¡¨çš„ç­‰å€¼åŒ¹é…è¿æ¥æ¡ä»¶ï¼Œè¯¥è¿æ¥æ¡ä»¶å¯¹åº”çš„è¢«é©±åŠ¨è¡¨ä¸­çš„åˆ—åˆæ‹¥æœ‰ç´¢å¼•æ—¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨refè®¿é—®æ–¹æ³•æ¥å¯¹è¢«é©±åŠ¨è¡¨è¿›è¡ŒæŸ¥è¯¢ï¼Œæ¯”æ–¹è¯´è¿™æ ·ï¼šåœ¨çœŸæ­£æ‰§è¡Œå¯¹t2è¡¨çš„æŸ¥è¯¢å‰ï¼Œt1.comumnçš„å€¼æ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸èƒ½é€šè¿‡index diveçš„æ–¹å¼ç›´æ¥è®¿é—®B+æ ‘ç´¢å¼•å»ç»Ÿè®¡æ¯ä¸ªå•ç‚¹åŒºé—´å¯¹åº”çš„è®°å½•çš„æ•°é‡ï¼Œæ‰€ä»¥ä¹Ÿåªèƒ½ä¾èµ–ç»Ÿè®¡æ•°æ®ä¸­çš„å¹³å‡ä¸€ä¸ªå€¼é‡å¤å¤šå°‘è¡Œæ¥è®¡ç®—å•ç‚¹åŒºé—´å¯¹åº”çš„è®°å½•æ•°é‡ã€‚ 1SELECT * FROM t1 JOIN t2 ON t1.column = t2.key WHERE ...; åœ¨ç»Ÿè®¡ç´¢å¼•åˆ—ä¸é‡å¤çš„å€¼çš„æ•°é‡æ—¶ï¼Œæœ‰ä¸€ä¸ªæ¯”è¾ƒçƒ¦çš„é—®é¢˜å°±æ˜¯ç´¢å¼•åˆ—ä¸­å‡ºç°NULLå€¼æ€ä¹ˆåŠï¼Œæ¯”æ–¹è¯´æŸä¸ªç´¢å¼•åˆ—çš„å†…å®¹æ˜¯è¿™æ ·ï¼š 12345678+------+| col |+------+| 1 || 2 || NULL || NULL |+------+ æ­¤æ—¶è®¡ç®—è¿™ä¸ªcolåˆ—ä¸­ä¸é‡å¤çš„å€¼çš„æ•°é‡å°±æœ‰ä¸‹è¾¹çš„åˆ†æ­§ï¼š æœ‰çš„äººè®¤ä¸ºNULLå€¼ä»£è¡¨ä¸€ä¸ªæœªç¡®å®šçš„å€¼ï¼Œæ‰€ä»¥MySQLè®¤ä¸ºä»»ä½•å’ŒNULLå€¼åšæ¯”è¾ƒçš„è¡¨è¾¾å¼çš„å€¼éƒ½ä¸ºNULLï¼Œå°±æ˜¯è¿™æ ·ï¼šæ‰€ä»¥æ¯ä¸€ä¸ªNULLå€¼éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç»Ÿè®¡ç´¢å¼•åˆ—ä¸é‡å¤çš„å€¼çš„æ•°é‡æ—¶ï¼Œåº”è¯¥æŠŠNULLå€¼å½“ä½œä¸€ä¸ªç‹¬ç«‹çš„å€¼ï¼Œæ‰€ä»¥colåˆ—çš„ä¸é‡å¤çš„å€¼çš„æ•°é‡å°±æ˜¯ï¼š4ï¼ˆåˆ†åˆ«æ˜¯1ã€2ã€NULLã€NULLè¿™å››ä¸ªå€¼ï¼‰ã€‚ 12345678910111213141516171819202122232425262728293031mysql&gt; SELECT 1 = NULL;+----------+| 1 = NULL |+----------+| NULL |+----------+1 row in set (0.00 sec)mysql&gt; SELECT 1 != NULL;+-----------+| 1 != NULL |+-----------+| NULL |+-----------+1 row in set (0.00 sec)mysql&gt; SELECT NULL = NULL;+-------------+| NULL = NULL |+-------------+| NULL |+-------------+1 row in set (0.00 sec)mysql&gt; SELECT NULL != NULL;+--------------+| NULL != NULL |+--------------+| NULL |+--------------+1 row in set (0.00 sec) æœ‰çš„äººè®¤ä¸ºå…¶å®NULLå€¼åœ¨ä¸šåŠ¡ä¸Šå°±æ˜¯ä»£è¡¨æ²¡æœ‰ï¼Œæ‰€æœ‰çš„NULLå€¼ä»£è¡¨çš„æ„ä¹‰æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥colåˆ—ä¸é‡å¤çš„å€¼çš„æ•°é‡å°±æ˜¯ï¼š3ï¼ˆåˆ†åˆ«æ˜¯1ã€2ã€NULLè¿™ä¸‰ä¸ªå€¼ï¼‰ã€‚ æœ‰çš„äººè®¤ä¸ºè¿™NULLå®Œå…¨æ²¡æœ‰æ„ä¹‰å˜›ï¼Œæ‰€ä»¥åœ¨ç»Ÿè®¡ç´¢å¼•åˆ—ä¸é‡å¤çš„å€¼çš„æ•°é‡æ—¶å‹æ ¹å„¿ä¸èƒ½æŠŠå®ƒä»¬ç®—è¿›æ¥ï¼Œæ‰€ä»¥colåˆ—ä¸é‡å¤çš„å€¼çš„æ•°é‡å°±æ˜¯ï¼š2ï¼ˆåˆ†åˆ«æ˜¯1ã€2è¿™ä¸¤ä¸ªå€¼ï¼‰ã€‚ MySQLæä¾›äº†ä¸€ä¸ªåä¸ºinnodb_stats_methodçš„ç³»ç»Ÿå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ¥è®¾ç½®ï¼Œè¿™ä¸ªç³»ç»Ÿå˜é‡æœ‰ä¸‰ä¸ªå€™é€‰å€¼ï¼š nulls_equalï¼šè®¤ä¸ºæ‰€æœ‰NULLå€¼éƒ½æ˜¯ç›¸ç­‰çš„ã€‚è¿™ä¸ªå€¼ä¹Ÿæ˜¯innodb_stats_methodçš„é»˜è®¤å€¼ã€‚å¦‚æœæŸä¸ªç´¢å¼•åˆ—ä¸­NULLå€¼ç‰¹åˆ«å¤šçš„è¯ï¼Œè¿™ç§ç»Ÿè®¡æ–¹å¼ä¼šè®©ä¼˜åŒ–å™¨è®¤ä¸ºæŸä¸ªåˆ—ä¸­å¹³å‡ä¸€ä¸ªå€¼é‡å¤æ¬¡æ•°ç‰¹åˆ«å¤šï¼Œæ‰€ä»¥å€¾å‘äºä¸ä½¿ç”¨ç´¢å¼•è¿›è¡Œè®¿é—®ã€‚ nulls_unequalï¼šè®¤ä¸ºæ‰€æœ‰NULLå€¼éƒ½æ˜¯ä¸ç›¸ç­‰çš„ã€‚å¦‚æœæŸä¸ªç´¢å¼•åˆ—ä¸­NULLå€¼ç‰¹åˆ«å¤šçš„è¯ï¼Œè¿™ç§ç»Ÿè®¡æ–¹å¼ä¼šè®©ä¼˜åŒ–å™¨è®¤ä¸ºæŸä¸ªåˆ—ä¸­å¹³å‡ä¸€ä¸ªå€¼é‡å¤æ¬¡æ•°ç‰¹åˆ«å°‘ï¼Œæ‰€ä»¥å€¾å‘äºä½¿ç”¨ç´¢å¼•è¿›è¡Œè®¿é—®ã€‚ nulls_ignoredï¼šç›´æ¥æŠŠNULLå€¼å¿½ç•¥æ‰ã€‚ 5.æ€»ç»“ InnoDBä»¥è¡¨ä¸ºå•ä½æ¥æ”¶é›†ç»Ÿè®¡æ•°æ®ï¼Œè¿™äº›ç»Ÿè®¡æ•°æ®å¯ä»¥æ˜¯åŸºäºç£ç›˜çš„æ°¸ä¹…æ€§ç»Ÿè®¡æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ˜¯åŸºäºå†…å­˜çš„éæ°¸ä¹…æ€§ç»Ÿè®¡æ•°æ®ã€‚ innodb_stats_persistentæ§åˆ¶ç€ä½¿ç”¨æ°¸ä¹…æ€§ç»Ÿè®¡æ•°æ®è¿˜æ˜¯éæ°¸ä¹…æ€§ç»Ÿè®¡æ•°æ®ï¼›innodb_stats_persistent_sample_pagesæ§åˆ¶ç€æ°¸ä¹…æ€§ç»Ÿè®¡æ•°æ®çš„é‡‡æ ·é¡µé¢æ•°é‡ï¼›innodb_stats_transient_sample_pagesæ§åˆ¶ç€éæ°¸ä¹…æ€§ç»Ÿè®¡æ•°æ®çš„é‡‡æ ·é¡µé¢æ•°é‡ï¼›innodb_stats_auto_recalcæ§åˆ¶ç€æ˜¯å¦è‡ªåŠ¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®ã€‚ æˆ‘ä»¬å¯ä»¥é’ˆå¯¹æŸä¸ªå…·ä½“çš„è¡¨ï¼Œåœ¨åˆ›å»ºå’Œä¿®æ”¹è¡¨æ—¶é€šè¿‡æŒ‡å®šSTATS_PERSISTENTã€STATS_AUTO_RECALCã€STATS_SAMPLE_PAGESçš„å€¼æ¥æ§åˆ¶ç›¸å…³ç»Ÿè®¡æ•°æ®å±æ€§ã€‚ innodb_stats_methodå†³å®šç€åœ¨ç»Ÿè®¡æŸä¸ªç´¢å¼•åˆ—ä¸é‡å¤å€¼çš„æ•°é‡æ—¶å¦‚ä½•å¯¹å¾…NULLå€¼ã€‚","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[ä¸ƒ]åŸºäºæˆæœ¬çš„ä¼˜åŒ–","slug":"MySQL/MySQL[ä¸ƒ]åŸºäºæˆæœ¬çš„ä¼˜åŒ–","date":"2022-01-11T03:16:05.985Z","updated":"2022-01-11T03:21:45.620Z","comments":true,"path":"2022/01/11/MySQL/MySQL[ä¸ƒ]åŸºäºæˆæœ¬çš„ä¼˜åŒ–/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E4%B8%83]%E5%9F%BA%E4%BA%8E%E6%88%90%E6%9C%AC%E7%9A%84%E4%BC%98%E5%8C%96/","excerpt":"","text":"1.ä»€ä¹ˆæ˜¯æˆæœ¬ï¼Ÿåœ¨MySQLä¸­ä¸€æ¡æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæˆæœ¬æ˜¯ç”±ä¸‹è¾¹è¿™ä¸¤ä¸ªæ–¹é¢ç»„æˆçš„ï¼š I/Oæˆæœ¬æˆ‘ä»¬çš„è¡¨ç»å¸¸ä½¿ç”¨çš„MyISAMã€InnoDBå­˜å‚¨å¼•æ“éƒ½æ˜¯å°†æ•°æ®å’Œç´¢å¼•éƒ½å­˜å‚¨åˆ°ç£ç›˜ä¸Šçš„ï¼Œå½“æˆ‘ä»¬æƒ³æŸ¥è¯¢è¡¨ä¸­çš„è®°å½•æ—¶ï¼Œéœ€è¦å…ˆæŠŠæ•°æ®æˆ–è€…ç´¢å¼•åŠ è½½åˆ°å†…å­˜ä¸­ç„¶åå†æ“ä½œã€‚è¿™ä¸ªä»ç£ç›˜åˆ°å†…å­˜è¿™ä¸ªåŠ è½½çš„è¿‡ç¨‹æŸè€—çš„æ—¶é—´ç§°ä¹‹ä¸ºI/Oæˆæœ¬ã€‚ CPUæˆæœ¬è¯»å–ä»¥åŠæ£€æµ‹è®°å½•æ˜¯å¦æ»¡è¶³å¯¹åº”çš„æœç´¢æ¡ä»¶ã€å¯¹ç»“æœé›†è¿›è¡Œæ’åºç­‰è¿™äº›æ“ä½œæŸè€—çš„æ—¶é—´ç§°ä¹‹ä¸ºCPUæˆæœ¬ã€‚ å¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´ï¼Œé¡µæ˜¯ç£ç›˜å’Œå†…å­˜ä¹‹é—´äº¤äº’çš„åŸºæœ¬å•ä½ï¼ŒMySQLè§„å®šè¯»å–ä¸€ä¸ªé¡µé¢èŠ±è´¹çš„æˆæœ¬é»˜è®¤æ˜¯1.0ï¼Œè¯»å–ä»¥åŠæ£€æµ‹ä¸€æ¡è®°å½•æ˜¯å¦ç¬¦åˆæœç´¢æ¡ä»¶çš„æˆæœ¬é»˜è®¤æ˜¯0.2ã€‚1.0ã€0.2è¿™äº›æ•°å­—ç§°ä¹‹ä¸ºæˆæœ¬å¸¸æ•°ã€‚ ä¸ç®¡è¯»å–è®°å½•æ—¶éœ€ä¸éœ€è¦æ£€æµ‹æ˜¯å¦æ»¡è¶³æœç´¢æ¡ä»¶ï¼Œå…¶æˆæœ¬éƒ½ç®—æ˜¯0.2ã€‚ 2.å•è¡¨æŸ¥è¯¢çš„æˆæœ¬2.1 å‡†å¤‡å·¥ä½œæŠŠä¹‹å‰ç”¨åˆ°çš„single_tableè¡¨æ¬æ¥ã€‚ 123456789101112131415CREATE TABLE single_table ( id INT NOT NULL AUTO_INCREMENT, key1 VARCHAR(100), key2 INT, key3 VARCHAR(100), key_part1 VARCHAR(100), key_part2 VARCHAR(100), key_part3 VARCHAR(100), common_field VARCHAR(100), PRIMARY KEY (id), KEY idx_key1 (key1), UNIQUE KEY idx_key2 (key2), KEY idx_key3 (key3), KEY idx_key_part(key_part1, key_part2, key_part3)) Engine=InnoDB CHARSET=utf8; 2.2 åŸºäºæˆæœ¬çš„ä¼˜åŒ–æ­¥éª¤åœ¨ä¸€æ¡å•è¡¨æŸ¥è¯¢è¯­å¥çœŸæ­£æ‰§è¡Œä¹‹å‰ï¼ŒMySQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šæ‰¾å‡ºæ‰§è¡Œè¯¥è¯­å¥æ‰€æœ‰å¯èƒ½ä½¿ç”¨çš„æ–¹æ¡ˆï¼Œå¯¹æ¯”ä¹‹åæ‰¾å‡ºæˆæœ¬æœ€ä½çš„æ–¹æ¡ˆï¼Œè¿™ä¸ªæˆæœ¬æœ€ä½çš„æ–¹æ¡ˆå°±æ˜¯æ‰€è°“çš„æ‰§è¡Œè®¡åˆ’ï¼Œä¹‹åæ‰ä¼šè°ƒç”¨å­˜å‚¨å¼•æ“æä¾›çš„æ¥å£çœŸæ­£çš„æ‰§è¡ŒæŸ¥è¯¢ï¼Œè¿™ä¸ªè¿‡ç¨‹æ€»ç»“ä¸€ä¸‹å°±æ˜¯è¿™æ ·ï¼š æ ¹æ®æœç´¢æ¡ä»¶ï¼Œæ‰¾å‡ºæ‰€æœ‰å¯èƒ½ä½¿ç”¨çš„ç´¢å¼• è®¡ç®—å…¨è¡¨æ‰«æçš„ä»£ä»· è®¡ç®—ä½¿ç”¨ä¸åŒç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢çš„ä»£ä»· å¯¹æ¯”å„ç§æ‰§è¡Œæ–¹æ¡ˆçš„ä»£ä»·ï¼Œæ‰¾å‡ºæˆæœ¬æœ€ä½çš„é‚£ä¸€ä¸ª ä¸‹è¾¹æˆ‘ä»¬å°±ä»¥ä¸€ä¸ªå®ä¾‹æ¥åˆ†æä¸€ä¸‹è¿™äº›æ­¥éª¤ï¼Œå•è¡¨æŸ¥è¯¢è¯­å¥å¦‚ä¸‹ï¼š 123456SELECT * FROM single_table WHERE key1 IN (&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;) AND key2 &gt; 10 AND key2 &lt; 1000 AND key3 &gt; key2 AND key_part1 LIKE &#x27;%hello%&#x27; AND common_field = &#x27;123&#x27;; 2.2.1 æ ¹æ®æœç´¢æ¡ä»¶ï¼Œæ‰¾å‡ºæ‰€æœ‰å¯èƒ½ä½¿ç”¨çš„ç´¢å¼•å¯¹äºB+æ ‘ç´¢å¼•æ¥è¯´ï¼Œåªè¦ç´¢å¼•åˆ—å’Œå¸¸æ•°ä½¿ç”¨=ã€&lt;=&gt;ã€INã€NOT INã€IS NULLã€IS NOT NULLã€&gt;ã€&lt;ã€&gt;=ã€&lt;=ã€BETWEENã€!=ï¼ˆä¸ç­‰äºä¹Ÿå¯ä»¥å†™æˆ&lt;&gt;ï¼‰æˆ–è€…LIKEæ“ä½œç¬¦è¿æ¥èµ·æ¥ï¼Œå°±å¯ä»¥äº§ç”Ÿä¸€ä¸ªæ‰€è°“çš„èŒƒå›´åŒºé—´ï¼ˆLIKEåŒ¹é…å­—ç¬¦ä¸²å‰ç¼€ä¹Ÿè¡Œï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›æœç´¢æ¡ä»¶éƒ½å¯èƒ½ä½¿ç”¨åˆ°ç´¢å¼•ï¼ŒMySQLæŠŠä¸€ä¸ªæŸ¥è¯¢ä¸­å¯èƒ½ä½¿ç”¨åˆ°çš„ç´¢å¼•ç§°ä¹‹ä¸ºpossible keysã€‚ æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸Šè¾¹æŸ¥è¯¢ä¸­æ¶‰åŠåˆ°çš„å‡ ä¸ªæœç´¢æ¡ä»¶ï¼š key1 IN (&#39;a&#39;, &#39;b&#39;, &#39;c&#39;)ï¼Œè¿™ä¸ªæœç´¢æ¡ä»¶å¯ä»¥ä½¿ç”¨äºŒçº§ç´¢å¼•idx_key1ã€‚ key2 &gt; 10 AND key2 &lt; 1000ï¼Œè¿™ä¸ªæœç´¢æ¡ä»¶å¯ä»¥ä½¿ç”¨äºŒçº§ç´¢å¼•idx_key2ã€‚ key3 &gt; key2ï¼Œè¿™ä¸ªæœç´¢æ¡ä»¶çš„ç´¢å¼•åˆ—ç”±äºæ²¡æœ‰å’Œå¸¸æ•°æ¯”è¾ƒï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ä½¿ç”¨åˆ°ç´¢å¼•ã€‚ key_part1 LIKE &#39;%hello%&#39;ï¼Œkey_part1é€šè¿‡LIKEæ“ä½œç¬¦å’Œä»¥é€šé…ç¬¦å¼€å¤´çš„å­—ç¬¦ä¸²åšæ¯”è¾ƒï¼Œä¸å¯ä»¥é€‚ç”¨ç´¢å¼•ã€‚ common_field = &#39;123&#39;ï¼Œç”±äºè¯¥åˆ—ä¸Šå‹æ ¹å„¿æ²¡æœ‰ç´¢å¼•ï¼Œæ‰€ä»¥ä¸ä¼šç”¨åˆ°ç´¢å¼•ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œä¸Šè¾¹çš„æŸ¥è¯¢è¯­å¥å¯èƒ½ç”¨åˆ°çš„ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯possible keysåªæœ‰idx_key1å’Œidx_key2ã€‚ 2.2.2 è®¡ç®—å…¨è¡¨æ‰«æçš„ä»£ä»·å¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´ï¼Œå…¨è¡¨æ‰«æçš„æ„æ€å°±æ˜¯æŠŠèšç°‡ç´¢å¼•ä¸­çš„è®°å½•éƒ½ä¾æ¬¡å’Œç»™å®šçš„æœç´¢æ¡ä»¶åšä¸€ä¸‹æ¯”è¾ƒï¼ŒæŠŠç¬¦åˆæœç´¢æ¡ä»¶çš„è®°å½•åŠ å…¥åˆ°ç»“æœé›†ï¼Œæ‰€ä»¥éœ€è¦å°†èšç°‡ç´¢å¼•å¯¹åº”çš„é¡µé¢åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†æ£€æµ‹è®°å½•æ˜¯å¦ç¬¦åˆæœç´¢æ¡ä»¶ã€‚ç”±äºæŸ¥è¯¢æˆæœ¬=I/Oæˆæœ¬+CPUæˆæœ¬ï¼Œæ‰€ä»¥è®¡ç®—å…¨è¡¨æ‰«æçš„ä»£ä»·éœ€è¦ä¸¤ä¸ªä¿¡æ¯ï¼š èšç°‡ç´¢å¼•å ç”¨çš„é¡µé¢æ•° è¯¥è¡¨ä¸­çš„è®°å½•æ•° è¿™ä¸¤ä¸ªä¿¡æ¯ä»å“ªæ¥å‘¢ï¼ŸMySQLä¸ºæ¯ä¸ªè¡¨ç»´æŠ¤äº†ä¸€ç³»åˆ—çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå…³äºè¿™äº›ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦‚ä½•æ”¶é›†èµ·æ¥çš„åé¢å†è°ˆï¼Œç°åœ¨çœ‹çœ‹æ€ä¹ˆæŸ¥çœ‹è¿™äº›ç»Ÿè®¡ä¿¡æ¯ã€‚MySQLç»™æˆ‘ä»¬æä¾›äº†SHOW TABLE STATUSè¯­å¥æ¥æŸ¥çœ‹è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚æœè¦çœ‹æŒ‡å®šçš„æŸä¸ªè¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œåœ¨è¯¥è¯­å¥ååŠ å¯¹åº”çš„LIKEè¯­å¥å°±å¥½äº†ï¼Œæ¯”æ–¹è¯´æˆ‘ä»¬è¦æŸ¥çœ‹single_tableè¿™ä¸ªè¡¨çš„ç»Ÿè®¡ä¿¡æ¯å¯ä»¥è¿™ä¹ˆå†™ï¼š 1SHOW TABLE STATUS LIKE &#x27;single_table&#x27; è™½ç„¶å‡ºç°äº†å¾ˆå¤šç»Ÿè®¡é€‰é¡¹ï¼Œä½†æˆ‘ä»¬ç›®å‰åªå…³å¿ƒä¸¤ä¸ªï¼š Rowsæœ¬é€‰é¡¹è¡¨ç¤ºè¡¨ä¸­çš„è®°å½•æ¡æ•°ã€‚å¯¹äºä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼Œè¯¥å€¼æ˜¯å‡†ç¡®çš„ï¼Œå¯¹äºä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼Œè¯¥å€¼æ˜¯ä¸€ä¸ªä¼°è®¡å€¼ã€‚ä»æŸ¥è¯¢ç»“æœæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œç”±äºæˆ‘ä»¬çš„single_tableè¡¨æ˜¯ä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“çš„ï¼Œæ‰€ä»¥è™½ç„¶å®é™…ä¸Šè¡¨ä¸­æœ‰10000æ¡è®°å½•ï¼Œä½†æ˜¯SHOW TABLE STATUSæ˜¾ç¤ºçš„Rowså€¼åªæœ‰9693æ¡è®°å½•ã€‚ Data_lengthæœ¬é€‰é¡¹è¡¨ç¤ºè¡¨å ç”¨çš„å­˜å‚¨ç©ºé—´å­—èŠ‚æ•°ã€‚ä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼Œè¯¥å€¼å°±æ˜¯æ•°æ®æ–‡ä»¶çš„å¤§å°ï¼Œå¯¹äºä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼Œè¯¥å€¼å°±ç›¸å½“äºèšç°‡ç´¢å¼•å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥è¿™æ ·è®¡ç®—è¯¥å€¼çš„å¤§å°ï¼šæˆ‘ä»¬çš„single_tableä½¿ç”¨é»˜è®¤16KBçš„é¡µé¢å¤§å°ï¼Œè€Œä¸Šè¾¹æŸ¥è¯¢ç»“æœæ˜¾ç¤ºData_lengthçš„å€¼æ˜¯1589248ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åå‘æ¥æ¨å¯¼å‡ºèšç°‡ç´¢å¼•çš„é¡µé¢æ•°é‡ï¼š 1Data_length = èšç°‡ç´¢å¼•çš„é¡µé¢æ•°é‡ x æ¯ä¸ªé¡µé¢çš„å¤§å° 1èšç°‡ç´¢å¼•çš„é¡µé¢æ•°é‡ = 1589248 Ã· 16 Ã· 1024 = 97 æˆ‘ä»¬ç°åœ¨å·²ç»å¾—åˆ°äº†èšç°‡ç´¢å¼•å ç”¨çš„é¡µé¢æ•°é‡ä»¥åŠè¯¥è¡¨è®°å½•æ•°çš„ä¼°è®¡å€¼ï¼Œæ‰€ä»¥å°±å¯ä»¥è®¡ç®—å…¨è¡¨æ‰«ææˆæœ¬äº†ï¼Œä½†æ˜¯MySQLåœ¨çœŸå®è®¡ç®—æˆæœ¬æ—¶ä¼šè¿›è¡Œä¸€äº›å¾®è°ƒï¼Œè¿™äº›å¾®è°ƒçš„å€¼æ˜¯ç›´æ¥ç¡¬ç¼–ç åˆ°ä»£ç é‡Œçš„ï¼Œè¿™äº›å¾®è°ƒçš„å€¼ååˆ†çš„å°ï¼Œå¹¶ä¸å½±å“æˆ‘ä»¬åˆ†æã€‚ç°åœ¨å¯ä»¥çœ‹ä¸€ä¸‹å…¨è¡¨æ‰«ææˆæœ¬çš„è®¡ç®—è¿‡ç¨‹ï¼š I/Oæˆæœ¬97æŒ‡çš„æ˜¯èšç°‡ç´¢å¼•å ç”¨çš„é¡µé¢æ•°ï¼Œ1.0æŒ‡çš„æ˜¯åŠ è½½ä¸€ä¸ªé¡µé¢çš„æˆæœ¬å¸¸æ•°ï¼Œåè¾¹çš„1.1æ˜¯ä¸€ä¸ªå¾®è°ƒå€¼ï¼Œæˆ‘ä»¬ä¸ç”¨åœ¨æ„ã€‚ 197 x 1.0 + 1.1 = 98.1 CPUæˆæœ¬ï¼š9693æŒ‡çš„æ˜¯ç»Ÿè®¡æ•°æ®ä¸­è¡¨çš„è®°å½•æ•°ï¼Œå¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´æ˜¯ä¸€ä¸ªä¼°è®¡å€¼ï¼Œ0.2æŒ‡çš„æ˜¯è®¿é—®ä¸€æ¡è®°å½•æ‰€éœ€çš„æˆæœ¬å¸¸æ•°ï¼Œåè¾¹çš„1.0æ˜¯ä¸€ä¸ªå¾®è°ƒå€¼ï¼Œæˆ‘ä»¬ä¸ç”¨åœ¨æ„ã€‚ 19693 x 0.2 + 1.0 = 1939.6 æ€»æˆæœ¬ï¼š 198.1 + 1939.6 = 2037.7 ç»¼ä¸Šæ‰€è¿°ï¼Œå¯¹äºsingle_tableçš„å…¨è¡¨æ‰«ææ‰€éœ€çš„æ€»æˆæœ¬å°±æ˜¯2037.7ã€‚ è¡¨ä¸­çš„è®°å½•å…¶å®éƒ½å­˜å‚¨åœ¨èšç°‡ç´¢å¼•å¯¹åº”B+æ ‘çš„å¶å­èŠ‚ç‚¹ä¸­ï¼Œæ‰€ä»¥åªè¦æˆ‘ä»¬é€šè¿‡æ ¹èŠ‚ç‚¹è·å¾—äº†æœ€å·¦è¾¹çš„å¶å­èŠ‚ç‚¹ï¼Œå°±å¯ä»¥æ²¿ç€å¶å­èŠ‚ç‚¹ç»„æˆçš„åŒå‘é“¾è¡¨æŠŠæ‰€æœ‰è®°å½•éƒ½æŸ¥çœ‹ä¸€éã€‚ä¹Ÿå°±æ˜¯è¯´å…¨è¡¨æ‰«æè¿™ä¸ªè¿‡ç¨‹å…¶å®æœ‰çš„B+æ ‘å†…èŠ‚ç‚¹æ˜¯ä¸éœ€è¦è®¿é—®çš„ï¼Œä½†æ˜¯MySQLåœ¨è®¡ç®—å…¨è¡¨æ‰«ææˆæœ¬æ—¶ç›´æ¥ä½¿ç”¨èšç°‡ç´¢å¼•å ç”¨çš„é¡µé¢æ•°ä½œä¸ºè®¡ç®—I/Oæˆæœ¬çš„ä¾æ®ï¼Œæ˜¯ä¸åŒºåˆ†å†…èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„ã€‚ 2.2.3 è®¡ç®—ä½¿ç”¨ä¸åŒç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢çš„ä»£ä»·ä»ç¬¬1æ­¥åˆ†ææˆ‘ä»¬å¾—åˆ°ï¼Œä¸Šè¿°æŸ¥è¯¢å¯èƒ½ä½¿ç”¨åˆ°idx_key1å’Œidx_key2è¿™ä¸¤ä¸ªç´¢å¼•ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«åˆ†æå•ç‹¬ä½¿ç”¨è¿™äº›ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢çš„æˆæœ¬ï¼Œæœ€åè¿˜è¦åˆ†ææ˜¯å¦å¯èƒ½ä½¿ç”¨åˆ°ç´¢å¼•åˆå¹¶ã€‚è¿™é‡Œéœ€è¦æä¸€ç‚¹çš„æ˜¯ï¼ŒMySQLæŸ¥è¯¢ä¼˜åŒ–å™¨å…ˆåˆ†æä½¿ç”¨å”¯ä¸€äºŒçº§ç´¢å¼•çš„æˆæœ¬ï¼Œå†åˆ†æä½¿ç”¨æ™®é€šç´¢å¼•çš„æˆæœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå…ˆåˆ†æidx_key2çš„æˆæœ¬ï¼Œç„¶åå†çœ‹ä½¿ç”¨idx_key1çš„æˆæœ¬ã€‚ â‘ ä½¿ç”¨idx_key2æ‰§è¡ŒæŸ¥è¯¢çš„æˆæœ¬åˆ†æidx_key2å¯¹åº”çš„æœç´¢æ¡ä»¶æ˜¯ï¼škey2 &gt; 10 AND key2 &lt; 1000ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹åº”çš„èŒƒå›´åŒºé—´å°±æ˜¯ï¼š(10, 1000)ï¼Œä½¿ç”¨idx_key2æœç´¢çš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·å­ï¼š å¯¹äºä½¿ç”¨äºŒçº§ç´¢å¼• + å›è¡¨æ–¹å¼çš„æŸ¥è¯¢ï¼ŒMySQLè®¡ç®—è¿™ç§æŸ¥è¯¢çš„æˆæœ¬ä¾èµ–ä¸¤ä¸ªæ–¹é¢çš„æ•°æ®ï¼š èŒƒå›´åŒºé—´æ•°é‡ä¸è®ºæŸä¸ªèŒƒå›´åŒºé—´çš„äºŒçº§ç´¢å¼•åˆ°åº•å ç”¨äº†å¤šå°‘é¡µé¢ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ç²—æš´çš„è®¤ä¸ºè¯»å–ç´¢å¼•çš„ä¸€ä¸ªèŒƒå›´åŒºé—´çš„I/Oæˆæœ¬å’Œè¯»å–ä¸€ä¸ªé¡µé¢æ˜¯ç›¸åŒçš„ã€‚æœ¬ä¾‹ä¸­ä½¿ç”¨idx_key2çš„èŒƒå›´åŒºé—´åªæœ‰ä¸€ä¸ªï¼š(10, 1000)ï¼Œæ‰€ä»¥ç›¸å½“äºè®¿é—®è¿™ä¸ªèŒƒå›´åŒºé—´çš„äºŒçº§ç´¢å¼•ä»˜å‡ºçš„I/Oæˆæœ¬å°±æ˜¯ï¼š 11 x 1.0 = 1.0 éœ€è¦å›è¡¨çš„è®°å½•æ•°ä¼˜åŒ–å™¨éœ€è¦è®¡ç®—äºŒçº§ç´¢å¼•çš„æŸä¸ªèŒƒå›´åŒºé—´åˆ°åº•åŒ…å«å¤šå°‘æ¡è®°å½•ï¼Œå¯¹äºæœ¬ä¾‹æ¥è¯´å°±æ˜¯è¦è®¡ç®—idx_key2åœ¨(10, 1000)è¿™ä¸ªèŒƒå›´åŒºé—´ä¸­åŒ…å«å¤šå°‘äºŒçº§ç´¢å¼•è®°å½•ï¼Œè®¡ç®—è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š æ­¥éª¤1ï¼šå…ˆæ ¹æ®key2 &gt; 10è¿™ä¸ªæ¡ä»¶è®¿é—®ä¸€ä¸‹idx_key2å¯¹åº”çš„B+æ ‘ç´¢å¼•ï¼Œæ‰¾åˆ°æ»¡è¶³key2 &gt; 10è¿™ä¸ªæ¡ä»¶çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œæˆ‘ä»¬æŠŠè¿™æ¡è®°å½•ç§°ä¹‹ä¸ºåŒºé—´æœ€å·¦è®°å½•ã€‚åœ¨B+æ•°æ ‘ä¸­å®šä½ä¸€æ¡è®°å½•çš„è¿‡ç¨‹æ˜¯è´¼å¿«çš„ï¼Œæ˜¯å¸¸æ•°çº§åˆ«çš„ï¼Œæ‰€ä»¥è¿™ä¸ªè¿‡ç¨‹çš„æ€§èƒ½æ¶ˆè€—æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ã€‚ æ­¥éª¤2ï¼šç„¶åå†æ ¹æ®key2 &lt; 1000è¿™ä¸ªæ¡ä»¶ç»§ç»­ä»idx_key2å¯¹åº”çš„B+æ ‘ç´¢å¼•ä¸­æ‰¾å‡ºæœ€åä¸€æ¡æ»¡è¶³è¿™ä¸ªæ¡ä»¶çš„è®°å½•ï¼Œæˆ‘ä»¬æŠŠè¿™æ¡è®°å½•ç§°ä¹‹ä¸ºåŒºé—´æœ€å³è®°å½•ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„æ€§èƒ½æ¶ˆè€—ä¹Ÿå¯ä»¥å¿½ç•¥ä¸è®¡çš„ã€‚ æ­¥éª¤3ï¼šå¦‚æœåŒºé—´æœ€å·¦è®°å½•å’ŒåŒºé—´æœ€å³è®°å½•ç›¸éš”ä¸å¤ªè¿œï¼ˆåœ¨MySQL 5.7.21è¿™ä¸ªç‰ˆæœ¬é‡Œï¼Œåªè¦ç›¸éš”ä¸å¤§äº10ä¸ªé¡µé¢å³å¯ï¼‰ï¼Œé‚£å°±å¯ä»¥ç²¾ç¡®ç»Ÿè®¡å‡ºæ»¡è¶³key2 &gt; 10 AND key2 &lt; 1000æ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•æ¡æ•°ã€‚å¦åˆ™åªæ²¿ç€åŒºé—´æœ€å·¦è®°å½•å‘å³è¯»10ä¸ªé¡µé¢ï¼Œè®¡ç®—å¹³å‡æ¯ä¸ªé¡µé¢ä¸­åŒ…å«å¤šå°‘è®°å½•ï¼Œç„¶åç”¨è¿™ä¸ªå¹³å‡å€¼ä¹˜ä»¥åŒºé—´æœ€å·¦è®°å½•å’ŒåŒºé—´æœ€å³è®°å½•ä¹‹é—´çš„é¡µé¢æ•°é‡å°±å¯ä»¥äº†ã€‚é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œæ€ä¹ˆä¼°è®¡åŒºé—´æœ€å·¦è®°å½•å’ŒåŒºé—´æœ€å³è®°å½•ä¹‹é—´æœ‰å¤šå°‘ä¸ªé¡µé¢å‘¢ï¼Ÿè§£å†³è¿™ä¸ªé—®é¢˜è¿˜å¾—å›åˆ°B+æ ‘ç´¢å¼•çš„ç»“æ„ä¸­æ¥ï¼š å¦‚å›¾ï¼Œæˆ‘ä»¬å‡è®¾åŒºé—´æœ€å·¦è®°å½•åœ¨é¡µbä¸­ï¼ŒåŒºé—´æœ€å³è®°å½•åœ¨é¡µcä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬æƒ³è®¡ç®—åŒºé—´æœ€å·¦è®°å½•å’ŒåŒºé—´æœ€å³è®°å½•ä¹‹é—´çš„é¡µé¢æ•°é‡å°±ç›¸å½“äºè®¡ç®—é¡µbå’Œé¡µcä¹‹é—´æœ‰å¤šå°‘é¡µé¢ï¼Œè€Œæ¯ä¸€æ¡ç›®å½•é¡¹è®°å½•éƒ½å¯¹åº”ä¸€ä¸ªæ•°æ®é¡µï¼Œæ‰€ä»¥è®¡ç®—é¡µbå’Œé¡µcä¹‹é—´æœ‰å¤šå°‘é¡µé¢å°±ç›¸å½“äºè®¡ç®—å®ƒä»¬çˆ¶èŠ‚ç‚¹ï¼ˆä¹Ÿå°±æ˜¯é¡µaï¼‰ä¸­å¯¹åº”çš„ç›®å½•é¡¹è®°å½•ä¹‹é—´éš”ç€å‡ æ¡è®°å½•ã€‚åœ¨ä¸€ä¸ªé¡µé¢ä¸­ç»Ÿè®¡ä¸¤æ¡è®°å½•ä¹‹é—´æœ‰å‡ æ¡è®°å½•çš„æˆæœ¬å°±è´¼å°äº†ã€‚å¦‚æœé¡µbå’Œé¡µcä¹‹é—´çš„é¡µé¢å®åœ¨å¤ªå¤šï¼Œä»¥è‡³äºé¡µbå’Œé¡µcå¯¹åº”çš„ç›®å½•é¡¹è®°å½•éƒ½ä¸åœ¨ä¸€ä¸ªé¡µé¢ä¸­ï¼Œç»§ç»­é€’å½’ï¼Œä¹Ÿå°±æ˜¯å†ç»Ÿè®¡é¡µbå’Œé¡µcå¯¹åº”çš„ç›®å½•é¡¹è®°å½•æ‰€åœ¨é¡µä¹‹é—´æœ‰å¤šå°‘ä¸ªé¡µé¢ã€‚è¿‡ä¸€ä¸ªB+æ ‘æœ‰4å±‚é«˜å·²ç»å¾ˆäº†ä¸å¾—äº†ï¼Œæ‰€ä»¥è¿™ä¸ªç»Ÿè®¡è¿‡ç¨‹ä¹Ÿä¸æ˜¯å¾ˆè€—è´¹æ€§èƒ½ã€‚çŸ¥é“äº†å¦‚ä½•ç»Ÿè®¡äºŒçº§ç´¢å¼•æŸä¸ªèŒƒå›´åŒºé—´çš„è®°å½•æ•°ä¹‹åï¼Œå°±éœ€è¦å›åˆ°ç°å®é—®é¢˜ä¸­æ¥ï¼Œæ ¹æ®ä¸Šè¿°ç®—æ³•æµ‹å¾—idx_key2åœ¨åŒºé—´(10, 1000)ä¹‹é—´å¤§çº¦æœ‰95æ¡è®°å½•ã€‚è¯»å–è¿™95æ¡äºŒçº§ç´¢å¼•è®°å½•éœ€è¦ä»˜å‡ºçš„CPUæˆæœ¬å°±æ˜¯ï¼š 195 x 0.2 + 0.01 = 19.01 å…¶ä¸­95æ˜¯éœ€è¦è¯»å–çš„äºŒçº§ç´¢å¼•è®°å½•æ¡æ•°ï¼Œ0.2æ˜¯è¯»å–ä¸€æ¡è®°å½•æˆæœ¬å¸¸æ•°ï¼Œ0.01æ˜¯å¾®è°ƒã€‚åœ¨é€šè¿‡äºŒçº§ç´¢å¼•è·å–åˆ°è®°å½•ä¹‹åï¼Œè¿˜éœ€è¦å¹²ä¸¤ä»¶äº‹å„¿ï¼š æ ¹æ®è¿™äº›è®°å½•é‡Œçš„ä¸»é”®å€¼åˆ°èšç°‡ç´¢å¼•ä¸­åšå›è¡¨æ“ä½œMySQLè®¤ä¸ºæ¯æ¬¡å›è¡¨æ“ä½œéƒ½ç›¸å½“äºè®¿é—®ä¸€ä¸ªé¡µé¢ï¼Œä¹Ÿå°±æ˜¯è¯´äºŒçº§ç´¢å¼•èŒƒå›´åŒºé—´æœ‰å¤šå°‘è®°å½•ï¼Œå°±éœ€è¦è¿›è¡Œå¤šå°‘æ¬¡å›è¡¨æ“ä½œï¼Œä¹Ÿå°±æ˜¯éœ€è¦è¿›è¡Œå¤šå°‘æ¬¡é¡µé¢I/Oã€‚æˆ‘ä»¬ä¸Šè¾¹ç»Ÿè®¡äº†ä½¿ç”¨idx_key2äºŒçº§ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œé¢„è®¡æœ‰95æ¡äºŒçº§ç´¢å¼•è®°å½•éœ€è¦è¿›è¡Œå›è¡¨æ“ä½œï¼Œæ‰€ä»¥å›è¡¨æ“ä½œå¸¦æ¥çš„I/Oæˆæœ¬å°±æ˜¯ï¼šå…¶ä¸­95æ˜¯é¢„è®¡çš„äºŒçº§ç´¢å¼•è®°å½•æ•°ï¼Œ1.0æ˜¯ä¸€ä¸ªé¡µé¢çš„I/Oæˆæœ¬å¸¸æ•°ã€‚ 195 x 1.0 = 95.0 å›è¡¨æ“ä½œåå¾—åˆ°çš„å®Œæ•´ç”¨æˆ·è®°å½•ï¼Œç„¶åå†æ£€æµ‹å…¶ä»–æœç´¢æ¡ä»¶æ˜¯å¦æˆç«‹å›è¡¨æ“ä½œçš„æœ¬è´¨å°±æ˜¯é€šè¿‡äºŒçº§ç´¢å¼•è®°å½•çš„ä¸»é”®å€¼åˆ°èšç°‡ç´¢å¼•ä¸­æ‰¾åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œç„¶åå†æ£€æµ‹é™¤key2 &gt; 10 AND key2 &lt; 1000è¿™ä¸ªæœç´¢æ¡ä»¶ä»¥å¤–çš„æœç´¢æ¡ä»¶æ˜¯å¦æˆç«‹ã€‚å› ä¸ºæˆ‘ä»¬é€šè¿‡èŒƒå›´åŒºé—´è·å–åˆ°äºŒçº§ç´¢å¼•è®°å½•å…±95æ¡ï¼Œä¹Ÿå°±å¯¹åº”ç€èšç°‡ç´¢å¼•ä¸­95æ¡å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œè¯»å–å¹¶æ£€æµ‹è¿™äº›å®Œæ•´çš„ç”¨æˆ·è®°å½•æ˜¯å¦ç¬¦åˆå…¶ä½™çš„æœç´¢æ¡ä»¶çš„CPUæˆæœ¬å¦‚ä¸‹ï¼šMySQLåªè®¡ç®—è¿™ä¸ªæŸ¥æ‰¾è¿‡ç¨‹æ‰€éœ€çš„I/Oæˆæœ¬ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€æ­¥éª¤ä¸­å¾—åˆ°çš„95.0ï¼Œåœ¨å†…å­˜ä¸­çš„å®šä½å®Œæ•´ç”¨æˆ·è®°å½•çš„è¿‡ç¨‹çš„æˆæœ¬æ˜¯å¿½ç•¥ä¸è®¡çš„ã€‚åœ¨å®šä½åˆ°è¿™äº›å®Œæ•´çš„ç”¨æˆ·è®°å½•åï¼Œéœ€è¦æ£€æµ‹é™¤key2 &gt; 10 AND key2 &lt; 1000è¿™ä¸ªæœç´¢æ¡ä»¶ä»¥å¤–çš„æœç´¢æ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œè¿™ä¸ªæ¯”è¾ƒè¿‡ç¨‹èŠ±è´¹çš„CPUæˆæœ¬å°±æ˜¯ï¼šå…¶ä¸­95æ˜¯å¾…æ£€æµ‹è®°å½•çš„æ¡æ•°ï¼Œ0.2æ˜¯æ£€æµ‹ä¸€æ¡è®°å½•æ˜¯å¦ç¬¦åˆç»™å®šçš„æœç´¢æ¡ä»¶çš„æˆæœ¬å¸¸æ•°ã€‚ 195 x 0.2 = 19.0 æ‰€ä»¥æœ¬ä¾‹ä¸­ä½¿ç”¨idx_key2æ‰§è¡ŒæŸ¥è¯¢çš„æˆæœ¬å°±å¦‚ä¸‹æ‰€ç¤ºï¼š I/Oæˆæœ¬ï¼š 11.0 + 95 x 1.0 = 96.0 (èŒƒå›´åŒºé—´çš„æ•°é‡ + é¢„ä¼°çš„äºŒçº§ç´¢å¼•è®°å½•æ¡æ•°) CPUæˆæœ¬ï¼š 195 x 0.2 + 0.01 + 95 x 0.2 = 38.01 ï¼ˆè¯»å–äºŒçº§ç´¢å¼•è®°å½•çš„æˆæœ¬ + è¯»å–å¹¶æ£€æµ‹å›è¡¨åèšç°‡ç´¢å¼•è®°å½•çš„æˆæœ¬ï¼‰ ç»¼ä¸Šæ‰€è¿°ï¼Œä½¿ç”¨idx_key2æ‰§è¡ŒæŸ¥è¯¢çš„æ€»æˆæœ¬å°±æ˜¯ï¼š 196.0 + 38.01 = 134.01 â‘¡ä½¿ç”¨idx_key1æ‰§è¡ŒæŸ¥è¯¢çš„æˆæœ¬åˆ†æidx_key1å¯¹åº”çš„æœç´¢æ¡ä»¶æ˜¯ï¼škey1 IN (&#39;a&#39;, &#39;b&#39;, &#39;c&#39;)ï¼Œä¹Ÿå°±æ˜¯è¯´ç›¸å½“äº3ä¸ªå•ç‚¹åŒºé—´ï¼š [&#39;a&#39;, &#39;a&#39;] [&#39;b&#39;, &#39;b&#39;] [&#39;c&#39;, &#39;c&#39;] ä½¿ç”¨idx_key1æœç´¢çš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·å­ï¼š ä¸ä½¿ç”¨idx_key2çš„æƒ…å†µç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦è®¡ç®—ä½¿ç”¨idx_key1æ—¶éœ€è¦è®¿é—®çš„èŒƒå›´åŒºé—´æ•°é‡ä»¥åŠéœ€è¦å›è¡¨çš„è®°å½•æ•°ï¼š èŒƒå›´åŒºé—´æ•°é‡ä½¿ç”¨idx_key1æ‰§è¡ŒæŸ¥è¯¢æ—¶å¾ˆæ˜¾ç„¶æœ‰3ä¸ªå•ç‚¹åŒºé—´ï¼Œæ‰€ä»¥è®¿é—®è¿™3ä¸ªèŒƒå›´åŒºé—´çš„äºŒçº§ç´¢å¼•ä»˜å‡ºçš„I/Oæˆæœ¬å°±æ˜¯ï¼š 13 x 1.0 = 3.0 éœ€è¦å›è¡¨çš„è®°å½•æ•°ç”±äºä½¿ç”¨idx_key1æ—¶æœ‰3ä¸ªå•ç‚¹åŒºé—´ï¼Œæ‰€ä»¥æ¯ä¸ªå•ç‚¹åŒºé—´éƒ½éœ€è¦æŸ¥æ‰¾ä¸€éå¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•æ•°ï¼š æŸ¥æ‰¾å•ç‚¹åŒºé—´[&#39;a&#39;, &#39;a&#39;]å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•æ•°è®¡ç®—å•ç‚¹åŒºé—´å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•æ•°å’Œè®¡ç®—è¿ç»­èŒƒå›´åŒºé—´å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•æ•°æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯å…ˆè®¡ç®—åŒºé—´æœ€å·¦è®°å½•å’ŒåŒºé—´æœ€å³è®°å½•ï¼Œç„¶åå†è®¡ç®—å®ƒä»¬ä¹‹é—´çš„è®°å½•æ•°ï¼Œæœ€åè®¡ç®—å¾—åˆ°å•ç‚¹åŒºé—´[&#39;a&#39;, &#39;a&#39;]å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•æ•°æ˜¯ï¼š35ã€‚ æŸ¥æ‰¾å•ç‚¹åŒºé—´[&#39;b&#39;, &#39;b&#39;]å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•æ•°ä¸ä¸ŠåŒç†ï¼Œè®¡ç®—å¾—åˆ°æœ¬å•ç‚¹åŒºé—´å¯¹åº”çš„è®°å½•æ•°æ˜¯ï¼š44ã€‚ æŸ¥æ‰¾å•ç‚¹åŒºé—´[&#39;c&#39;, &#39;c&#39;]å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•æ•°ä¸ä¸ŠåŒç†ï¼Œè®¡ç®—å¾—åˆ°æœ¬å•ç‚¹åŒºé—´å¯¹åº”çš„è®°å½•æ•°æ˜¯ï¼š39ã€‚ æ‰€ä»¥ï¼Œè¿™ä¸‰ä¸ªå•ç‚¹åŒºé—´æ€»å…±éœ€è¦å›è¡¨çš„è®°å½•æ•°å°±æ˜¯ï¼š 135 + 44 + 39 = 118 è¯»å–è¿™äº›äºŒçº§ç´¢å¼•è®°å½•çš„CPUæˆæœ¬å°±æ˜¯ï¼š 1118 x 0.2 + 0.01 = 23.61 å¾—åˆ°æ€»å…±éœ€è¦å›è¡¨çš„è®°å½•æ•°ä¹‹åï¼Œå°±è¦è€ƒè™‘ï¼š æ ¹æ®è¿™äº›è®°å½•é‡Œçš„ä¸»é”®å€¼åˆ°èšç°‡ç´¢å¼•ä¸­åšå›è¡¨æ“ä½œæ‰€éœ€çš„I/Oæˆæœ¬å°±æ˜¯ï¼š 1118 x 1.0 = 118.0 å›è¡¨æ“ä½œåå¾—åˆ°çš„å®Œæ•´ç”¨æˆ·è®°å½•ï¼Œç„¶åå†æ¯”è¾ƒå…¶ä»–æœç´¢æ¡ä»¶æ˜¯å¦æˆç«‹æ­¤æ­¥éª¤å¯¹åº”çš„CPUæˆæœ¬å°±æ˜¯ï¼š 1118 x 0.2 = 23.6 æ‰€ä»¥æœ¬ä¾‹ä¸­ä½¿ç”¨idx_key1æ‰§è¡ŒæŸ¥è¯¢çš„æˆæœ¬å°±å¦‚ä¸‹æ‰€ç¤ºï¼š I/Oæˆæœ¬ï¼š 13.0 + 118 x 1.0 = 121.0 (èŒƒå›´åŒºé—´çš„æ•°é‡ + é¢„ä¼°çš„äºŒçº§ç´¢å¼•è®°å½•æ¡æ•°) CPUæˆæœ¬ï¼š 1118 x 0.2 + 0.01 + 118 x 0.2 = 47.21 ï¼ˆè¯»å–äºŒçº§ç´¢å¼•è®°å½•çš„æˆæœ¬ + è¯»å–å¹¶æ£€æµ‹å›è¡¨åèšç°‡ç´¢å¼•è®°å½•çš„æˆæœ¬ï¼‰ ç»¼ä¸Šæ‰€è¿°ï¼Œä½¿ç”¨idx_key1æ‰§è¡ŒæŸ¥è¯¢çš„æ€»æˆæœ¬å°±æ˜¯ï¼š 1121.0 + 47.21 = 168.21 â‘¢æ˜¯å¦æœ‰å¯èƒ½ä½¿ç”¨ç´¢å¼•åˆå¹¶ï¼ˆIndex Mergeï¼‰æœ¬ä¾‹ä¸­æœ‰å…³key1å’Œkey2çš„æœç´¢æ¡ä»¶æ˜¯ä½¿ç”¨ANDè¿æ¥èµ·æ¥çš„ï¼Œè€Œå¯¹äºidx_key1å’Œidx_key2éƒ½æ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œä¹Ÿå°±æ˜¯è¯´æŸ¥æ‰¾åˆ°çš„äºŒçº§ç´¢å¼•è®°å½•å¹¶ä¸æ˜¯æŒ‰ç…§ä¸»é”®å€¼è¿›è¡Œæ’åºçš„ï¼Œå¹¶ä¸æ»¡è¶³ä½¿ç”¨Intersectionç´¢å¼•åˆå¹¶çš„æ¡ä»¶ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šä½¿ç”¨ç´¢å¼•åˆå¹¶ã€‚ 2.2.4 å¯¹æ¯”å„ç§æ‰§è¡Œæ–¹æ¡ˆçš„ä»£ä»·ï¼Œæ‰¾å‡ºæˆæœ¬æœ€ä½çš„é‚£ä¸€ä¸ªä¸‹è¾¹æŠŠæ‰§è¡Œæœ¬ä¾‹ä¸­çš„æŸ¥è¯¢çš„å„ç§å¯æ‰§è¡Œæ–¹æ¡ˆä»¥åŠå®ƒä»¬å¯¹åº”çš„æˆæœ¬åˆ—å‡ºæ¥ï¼š å…¨è¡¨æ‰«æçš„æˆæœ¬ï¼š2037.7 ä½¿ç”¨idx_key2çš„æˆæœ¬ï¼š134.01 ä½¿ç”¨idx_key1çš„æˆæœ¬ï¼š168.21 å¾ˆæ˜¾ç„¶ï¼Œä½¿ç”¨idx_key2çš„æˆæœ¬æœ€ä½ï¼Œæ‰€ä»¥é€‰æ‹©idx_key2æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚ 2.3 åŸºäºç´¢å¼•ç»Ÿè®¡æ•°æ®çš„æˆæœ¬è®¡ç®—æœ‰æ—¶å€™ä½¿ç”¨ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢æ—¶ä¼šæœ‰è®¸å¤šå•ç‚¹åŒºé—´ï¼Œæ¯”å¦‚ä½¿ç”¨INè¯­å¥å°±å¾ˆå®¹æ˜“äº§ç”Ÿéå¸¸å¤šçš„å•ç‚¹åŒºé—´ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼ˆä¸‹è¾¹æŸ¥è¯¢è¯­å¥ä¸­çš„...è¡¨ç¤ºè¿˜æœ‰å¾ˆå¤šå‚æ•°ï¼‰ï¼š 1SELECT * FROM single_table WHERE key1 IN (&#x27;aa1&#x27;, &#x27;aa2&#x27;, &#x27;aa3&#x27;, ... , &#x27;zzz&#x27;); å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªæŸ¥è¯¢å¯èƒ½ä½¿ç”¨åˆ°çš„ç´¢å¼•å°±æ˜¯idx_key1ï¼Œç”±äºè¿™ä¸ªç´¢å¼•å¹¶ä¸æ˜¯å”¯ä¸€äºŒçº§ç´¢å¼•ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ç¡®å®šä¸€ä¸ªå•ç‚¹åŒºé—´å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•çš„æ¡æ•°æœ‰å¤šå°‘ï¼Œéœ€è¦æˆ‘ä»¬å»è®¡ç®—ã€‚è®¡ç®—æ–¹å¼å°±æ˜¯å…ˆè·å–ç´¢å¼•å¯¹åº”çš„B+æ ‘çš„åŒºé—´æœ€å·¦è®°å½•å’ŒåŒºé—´æœ€å³è®°å½•ï¼Œç„¶åå†è®¡ç®—è¿™ä¸¤æ¡è®°å½•ä¹‹é—´æœ‰å¤šå°‘è®°å½•ï¼ˆè®°å½•æ¡æ•°å°‘çš„æ—¶å€™å¯ä»¥åšåˆ°ç²¾ç¡®è®¡ç®—ï¼Œå¤šçš„æ—¶å€™åªèƒ½ä¼°ç®—ï¼‰ã€‚MySQLæŠŠè¿™ç§é€šè¿‡ç›´æ¥è®¿é—®ç´¢å¼•å¯¹åº”çš„B+æ ‘æ¥è®¡ç®—æŸä¸ªèŒƒå›´åŒºé—´å¯¹åº”çš„ç´¢å¼•è®°å½•æ¡æ•°çš„æ–¹å¼ç§°ä¹‹ä¸ºindex diveã€‚ index diveå°±æ˜¯ç›´æ¥åˆ©ç”¨ç´¢å¼•å¯¹åº”çš„B+æ ‘æ¥è®¡ç®—æŸä¸ªèŒƒå›´åŒºé—´å¯¹åº”çš„è®°å½•æ¡æ•°ã€‚ æœ‰å‡ ä¸ªå•ç‚¹åŒºé—´çš„è¯ï¼Œä½¿ç”¨index diveçš„æ–¹å¼å»è®¡ç®—è¿™äº›å•ç‚¹åŒºé—´å¯¹åº”çš„è®°å½•æ•°ä¹Ÿä¸æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Œå¯æ˜¯å¦‚æœå¾ˆå¤šçš„è¯ï¼Œè¿™å°±æ„å‘³ç€MySQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¸ºäº†è®¡ç®—è¿™äº›å•ç‚¹åŒºé—´å¯¹åº”çš„ç´¢å¼•è®°å½•æ¡æ•°ï¼Œè¦è¿›è¡Œ20000æ¬¡index diveæ“ä½œï¼Œè¿™æ€§èƒ½æŸè€—å¯å°±å¤§äº†ï¼Œæä¸å¥½è®¡ç®—è¿™äº›å•ç‚¹åŒºé—´å¯¹åº”çš„ç´¢å¼•è®°å½•æ¡æ•°çš„æˆæœ¬æ¯”ç›´æ¥å…¨è¡¨æ‰«æçš„æˆæœ¬éƒ½å¤§äº†ã€‚MySQLæä¾›äº†ä¸€ä¸ªç³»ç»Ÿå˜é‡eq_range_index_dive_limitï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨MySQL 5.7.21ä¸­è¿™ä¸ªç³»ç»Ÿå˜é‡çš„é»˜è®¤å€¼ï¼š 1234567mysql&gt; SHOW VARIABLES LIKE &#x27;%dive%&#x27;;+---------------------------+-------+| Variable_name | Value |+---------------------------+-------+| eq_range_index_dive_limit | 200 |+---------------------------+-------+1 row in set (0.08 sec) ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬çš„INè¯­å¥ä¸­çš„å‚æ•°ä¸ªæ•°å°äº200ä¸ªçš„è¯ï¼Œå°†ä½¿ç”¨index diveçš„æ–¹å¼è®¡ç®—å„ä¸ªå•ç‚¹åŒºé—´å¯¹åº”çš„è®°å½•æ¡æ•°ï¼Œå¦‚æœå¤§äºæˆ–ç­‰äº200ä¸ªçš„è¯ï¼Œå¯å°±ä¸èƒ½ä½¿ç”¨index diveäº†ï¼Œè¦ä½¿ç”¨æ‰€è°“çš„ç´¢å¼•ç»Ÿè®¡æ•°æ®æ¥è¿›è¡Œä¼°ç®—ã€‚ åƒä¼šä¸ºæ¯ä¸ªè¡¨ç»´æŠ¤ä¸€ä»½ç»Ÿè®¡æ•°æ®ä¸€æ ·ï¼ŒMySQLä¹Ÿä¼šä¸ºè¡¨ä¸­çš„æ¯ä¸€ä¸ªç´¢å¼•ç»´æŠ¤ä¸€ä»½ç»Ÿè®¡æ•°æ®ï¼ŒæŸ¥çœ‹æŸä¸ªè¡¨ä¸­ç´¢å¼•çš„ç»Ÿè®¡æ•°æ®å¯ä»¥ä½¿ç”¨SHOW INDEX FROM è¡¨åçš„è¯­æ³•ï¼Œæ¯”å¦‚æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹single_tableçš„å„ä¸ªç´¢å¼•çš„ç»Ÿè®¡æ•°æ®å¯ä»¥è¿™ä¹ˆå†™ï¼š 12345678910111213mysql&gt; SHOW INDEX FROM single_table;+--------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |+--------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+| single_table | 0 | PRIMARY | 1 | id | A | 9693 | NULL | NULL | | BTREE | | || single_table | 0 | idx_key2 | 1 | key2 | A | 9693 | NULL | NULL | YES | BTREE | | || single_table | 1 | idx_key1 | 1 | key1 | A | 968 | NULL | NULL | YES | BTREE | | || single_table | 1 | idx_key3 | 1 | key3 | A | 799 | NULL | NULL | YES | BTREE | | || single_table | 1 | idx_key_part | 1 | key_part1 | A | 9673 | NULL | NULL | YES | BTREE | | || single_table | 1 | idx_key_part | 2 | key_part2 | A | 9999 | NULL | NULL | YES | BTREE | | || single_table | 1 | idx_key_part | 3 | key_part3 | A | 10000 | NULL | NULL | YES | BTREE | | |+--------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+7 rows in set (0.01 sec) å±æ€§å æè¿° Table ç´¢å¼•æ‰€å±è¡¨çš„åç§°ã€‚ Non_unique ç´¢å¼•åˆ—çš„å€¼æ˜¯å¦æ˜¯å”¯ä¸€çš„ï¼Œèšç°‡ç´¢å¼•å’Œå”¯ä¸€äºŒçº§ç´¢å¼•çš„è¯¥åˆ—å€¼ä¸º0 ï¼Œæ™®é€šäºŒçº§ç´¢å¼•è¯¥åˆ—å€¼ä¸º1 ã€‚ Key_name ç´¢å¼•çš„åç§°ã€‚ Seq_in_index ç´¢å¼•åˆ—åœ¨ç´¢å¼•ä¸­çš„ä½ç½®ï¼Œä»1å¼€å§‹è®¡æ•°ã€‚æ¯”å¦‚å¯¹äºè”åˆç´¢å¼•idx_key_part ï¼Œæ¥è¯´ï¼Œkey_part1 ã€key_part2 å’Œkey_part3 å¯¹åº”çš„ä½ç½®åˆ†åˆ«æ˜¯1ã€2ã€3ã€‚ Column_name ç´¢å¼•åˆ—çš„åç§°ã€‚ Collation ç´¢å¼•åˆ—ä¸­çš„å€¼æ˜¯æŒ‰ç…§ä½•ç§æ’åºæ–¹å¼å­˜æ”¾çš„ï¼Œå€¼ä¸ºA æ—¶ä»£è¡¨å‡åºå­˜æ”¾ï¼Œä¸ºNULL æ—¶ä»£è¡¨é™åºå­˜æ”¾ã€‚ Cardinality ç´¢å¼•åˆ—ä¸­ä¸é‡å¤å€¼çš„æ•°é‡ã€‚åè¾¹æˆ‘ä»¬ä¼šé‡ç‚¹çœ‹è¿™ä¸ªå±æ€§çš„ã€‚ Sub_part å¯¹äºå­˜å‚¨å­—ç¬¦ä¸²æˆ–è€…å­—èŠ‚ä¸²çš„åˆ—æ¥è¯´ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬åªæƒ³å¯¹è¿™äº›ä¸²çš„å‰n ä¸ªå­—ç¬¦æˆ–å­—èŠ‚å»ºç«‹ç´¢å¼•ï¼Œè¿™ä¸ªå±æ€§è¡¨ç¤ºçš„å°±æ˜¯é‚£ä¸ªn å€¼ã€‚å¦‚æœå¯¹å®Œæ•´çš„åˆ—å»ºç«‹ç´¢å¼•çš„è¯ï¼Œè¯¥å±æ€§çš„å€¼å°±æ˜¯NULL ã€‚ Packed ç´¢å¼•åˆ—å¦‚ä½•è¢«å‹ç¼©ï¼ŒNULL å€¼è¡¨ç¤ºæœªè¢«å‹ç¼©ã€‚è¿™ä¸ªå±æ€§æˆ‘ä»¬æš‚æ—¶ä¸äº†è§£ï¼Œå¯ä»¥å…ˆå¿½ç•¥æ‰ã€‚ Null è¯¥ç´¢å¼•åˆ—æ˜¯å¦å…è®¸å­˜å‚¨NULL å€¼ã€‚ Index_type ä½¿ç”¨ç´¢å¼•çš„ç±»å‹ï¼Œæˆ‘ä»¬æœ€å¸¸è§çš„å°±æ˜¯BTREE ï¼Œå…¶å®ä¹Ÿå°±æ˜¯B+ æ ‘ç´¢å¼•ã€‚ Comment ç´¢å¼•åˆ—æ³¨é‡Šä¿¡æ¯ã€‚ Index_comment ç´¢å¼•æ³¨é‡Šä¿¡æ¯ã€‚ ä¸Šè¿°å±æ€§å…¶å®æˆ‘ä»¬ç°åœ¨æœ€åœ¨æ„çš„æ˜¯Cardinalityå±æ€§ï¼ŒCardinalityç›´è¯‘è¿‡æ¥å°±æ˜¯åŸºæ•°çš„æ„æ€ï¼Œè¡¨ç¤ºç´¢å¼•åˆ—ä¸­ä¸é‡å¤å€¼çš„ä¸ªæ•°ã€‚æ¯”å¦‚å¯¹äºä¸€ä¸ªä¸€ä¸‡è¡Œè®°å½•çš„è¡¨æ¥è¯´ï¼ŒæŸä¸ªç´¢å¼•åˆ—çš„Cardinalityå±æ€§æ˜¯10000ï¼Œé‚£æ„å‘³ç€è¯¥åˆ—ä¸­æ²¡æœ‰é‡å¤çš„å€¼ï¼Œå¦‚æœCardinalityå±æ€§æ˜¯1çš„è¯ï¼Œå°±æ„å‘³ç€è¯¥åˆ—çš„å€¼å…¨éƒ¨æ˜¯é‡å¤çš„ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´ï¼Œä½¿ç”¨SHOW INDEXè¯­å¥å±•ç¤ºå‡ºæ¥çš„æŸä¸ªç´¢å¼•åˆ—çš„Cardinalityå±æ€§æ˜¯ä¸€ä¸ªä¼°è®¡å€¼ï¼Œå¹¶ä¸æ˜¯ç²¾ç¡®çš„ã€‚ å‰è¾¹è¯´é“ï¼Œå½“INè¯­å¥ä¸­çš„å‚æ•°ä¸ªæ•°å¤§äºæˆ–ç­‰äºç³»ç»Ÿå˜é‡eq_range_index_dive_limitçš„å€¼çš„è¯ï¼Œå°±ä¸ä¼šä½¿ç”¨index diveçš„æ–¹å¼è®¡ç®—å„ä¸ªå•ç‚¹åŒºé—´å¯¹åº”çš„ç´¢å¼•è®°å½•æ¡æ•°ï¼Œè€Œæ˜¯ä½¿ç”¨ç´¢å¼•ç»Ÿè®¡æ•°æ®ï¼Œè¿™é‡Œæ‰€æŒ‡çš„ç´¢å¼•ç»Ÿè®¡æ•°æ®æŒ‡çš„æ˜¯è¿™ä¸¤ä¸ªå€¼ï¼š ä½¿ç”¨SHOW TABLE STATUSå±•ç¤ºå‡ºçš„Rowså€¼ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè¡¨ä¸­æœ‰å¤šå°‘æ¡è®°å½•ã€‚ ä½¿ç”¨SHOW INDEXè¯­å¥å±•ç¤ºå‡ºçš„Cardinalityå±æ€§ã€‚ç»“åˆä¸Šä¸€ä¸ªRowsç»Ÿè®¡æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹ç´¢å¼•åˆ—ï¼Œè®¡ç®—å‡ºå¹³å‡ä¸€ä¸ªå€¼é‡å¤å¤šå°‘æ¬¡ã€‚ 1ä¸€ä¸ªå€¼çš„é‡å¤æ¬¡æ•° â‰ˆ Rows Ã· Cardinality ä»¥single_tableè¡¨çš„idx_key1ç´¢å¼•ä¸ºä¾‹ï¼Œå®ƒçš„Rowså€¼æ˜¯9693ï¼Œå®ƒå¯¹åº”ç´¢å¼•åˆ—key1çš„Cardinalityå€¼æ˜¯968ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¡ç®—key1åˆ—å¹³å‡å•ä¸ªå€¼çš„é‡å¤æ¬¡æ•°å°±æ˜¯ï¼š 19693 Ã· 968 â‰ˆ 10ï¼ˆæ¡ï¼‰ æ­¤æ—¶å†çœ‹ä¸Šè¾¹é‚£æ¡æŸ¥è¯¢è¯­å¥ï¼š 1SELECT * FROM single_table WHERE key1 IN (&#x27;aa1&#x27;, &#x27;aa2&#x27;, &#x27;aa3&#x27;, ... , &#x27;zzz&#x27;); å‡è®¾INè¯­å¥ä¸­æœ‰20000ä¸ªå‚æ•°çš„è¯ï¼Œå°±ç›´æ¥ä½¿ç”¨ç»Ÿè®¡æ•°æ®æ¥ä¼°ç®—è¿™äº›å‚æ•°éœ€è¦å•ç‚¹åŒºé—´å¯¹åº”çš„è®°å½•æ¡æ•°äº†ï¼Œæ¯ä¸ªå‚æ•°å¤§çº¦å¯¹åº”10æ¡è®°å½•ï¼Œæ‰€ä»¥æ€»å…±éœ€è¦å›è¡¨çš„è®°å½•æ•°å°±æ˜¯ï¼š 120000 x 10 = 200000 ä½¿ç”¨ç»Ÿè®¡æ•°æ®æ¥è®¡ç®—å•ç‚¹åŒºé—´å¯¹åº”çš„ç´¢å¼•è®°å½•æ¡æ•°å¯æ¯”index diveçš„æ–¹å¼ç®€å•å¤šäº†ï¼Œä½†æ˜¯ä¸ç²¾ç¡®ï¼ã€‚ä½¿ç”¨ç»Ÿè®¡æ•°æ®ç®—å‡ºæ¥çš„æŸ¥è¯¢æˆæœ¬ä¸å®é™…æ‰€éœ€çš„æˆæœ¬å¯èƒ½ç›¸å·®éå¸¸å¤§ã€‚ åœ¨MySQL 5.7.3ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œeq_range_index_dive_limitçš„é»˜è®¤å€¼ä¸º10ï¼Œä¹‹åçš„ç‰ˆæœ¬é»˜è®¤å€¼ä¸º200ã€‚æ‰€ä»¥å¦‚æœé‡‡ç”¨çš„æ˜¯5.7.3ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬çš„è¯ï¼Œå¾ˆå®¹æ˜“é‡‡ç”¨ç´¢å¼•ç»Ÿè®¡æ•°æ®è€Œä¸æ˜¯index diveçš„æ–¹å¼æ¥è®¡ç®—æŸ¥è¯¢æˆæœ¬ã€‚å½“æŸ¥è¯¢ä¸­ä½¿ç”¨åˆ°äº†INæŸ¥è¯¢ï¼Œä½†æ˜¯å´å®é™…æ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼Œå°±åº”è¯¥è€ƒè™‘ä¸€ä¸‹æ˜¯ä¸æ˜¯ç”±äº eq_range_index_dive_limit å€¼å¤ªå°å¯¼è‡´çš„ã€‚ 3. è¿æ¥æŸ¥è¯¢çš„æˆæœ¬æˆ‘ä»¬ç›´æ¥æ„é€ ä¸€ä¸ªå’Œsingle_tableè¡¨ä¸€æ¨¡ä¸€æ ·çš„single_table2è¡¨ã€‚ä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œæˆ‘ä»¬æŠŠsingle_tableè¡¨ç§°ä¸ºs1è¡¨ï¼ŒæŠŠsingle_table2è¡¨ç§°ä¸ºs2è¡¨ã€‚ 3.1 æ¡ä»¶è¿‡æ»¤æˆ‘ä»¬å‰è¾¹è¯´è¿‡ï¼ŒMySQLä¸­è¿æ¥æŸ¥è¯¢é‡‡ç”¨çš„æ˜¯åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•ï¼Œé©±åŠ¨è¡¨ä¼šè¢«è®¿é—®ä¸€æ¬¡ï¼Œè¢«é©±åŠ¨è¡¨å¯èƒ½ä¼šè¢«è®¿é—®å¤šæ¬¡ï¼Œæ‰€ä»¥å¯¹äºä¸¤è¡¨è¿æ¥æŸ¥è¯¢æ¥è¯´ï¼Œå®ƒçš„æŸ¥è¯¢æˆæœ¬ç”±ä¸‹è¾¹ä¸¤ä¸ªéƒ¨åˆ†æ„æˆï¼š å•æ¬¡æŸ¥è¯¢é©±åŠ¨è¡¨çš„æˆæœ¬ å¤šæ¬¡æŸ¥è¯¢è¢«é©±åŠ¨è¡¨çš„æˆæœ¬ï¼ˆå…·ä½“æŸ¥è¯¢å¤šå°‘æ¬¡å–å†³äºå¯¹é©±åŠ¨è¡¨æŸ¥è¯¢çš„ç»“æœé›†ä¸­æœ‰å¤šå°‘æ¡è®°å½•ï¼‰ æˆ‘ä»¬æŠŠå¯¹é©±åŠ¨è¡¨è¿›è¡ŒæŸ¥è¯¢åå¾—åˆ°çš„è®°å½•æ¡æ•°ç§°ä¹‹ä¸ºé©±åŠ¨è¡¨çš„æ‰‡å‡ºï¼ˆè‹±æ–‡åï¼šfanoutï¼‰ã€‚å¾ˆæ˜¾ç„¶é©±åŠ¨è¡¨çš„æ‰‡å‡ºå€¼è¶Šå°ï¼Œå¯¹è¢«é©±åŠ¨è¡¨çš„æŸ¥è¯¢æ¬¡æ•°ä¹Ÿå°±è¶Šå°‘ï¼Œè¿æ¥æŸ¥è¯¢çš„æ€»æˆæœ¬ä¹Ÿå°±è¶Šä½ã€‚å½“æŸ¥è¯¢ä¼˜åŒ–å™¨æƒ³è®¡ç®—æ•´ä¸ªè¿æ¥æŸ¥è¯¢æ‰€ä½¿ç”¨çš„æˆæœ¬æ—¶ï¼Œå°±éœ€è¦è®¡ç®—å‡ºé©±åŠ¨è¡¨çš„æ‰‡å‡ºå€¼ï¼Œæœ‰çš„æ—¶å€™æ‰‡å‡ºå€¼çš„è®¡ç®—æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸¤ä¸ªæŸ¥è¯¢ï¼š æŸ¥è¯¢ä¸€ï¼šå‡è®¾ä½¿ç”¨s1è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œå¾ˆæ˜¾ç„¶å¯¹é©±åŠ¨è¡¨çš„å•è¡¨æŸ¥è¯¢åªèƒ½ä½¿ç”¨å…¨è¡¨æ‰«æçš„æ–¹å¼æ‰§è¡Œï¼Œé©±åŠ¨è¡¨çš„æ‰‡å‡ºå€¼ä¹Ÿå¾ˆæ˜ç¡®ï¼Œé‚£å°±æ˜¯é©±åŠ¨è¡¨ä¸­æœ‰å¤šå°‘è®°å½•ï¼Œæ‰‡å‡ºå€¼å°±æ˜¯å¤šå°‘ã€‚æˆ‘ä»¬å‰è¾¹è¯´è¿‡ï¼Œç»Ÿè®¡æ•°æ®ä¸­s1è¡¨çš„è®°å½•è¡Œæ•°æ˜¯9693ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼˜åŒ–å™¨å°±ç›´æ¥ä¼šæŠŠ9693å½“ä½œåœ¨s1è¡¨çš„æ‰‡å‡ºå€¼ã€‚ 1SELECT * FROM single_table AS s1 INNER JOIN single_table2 AS s2; æŸ¥è¯¢äºŒï¼šä»ç„¶å‡è®¾s1è¡¨æ˜¯é©±åŠ¨è¡¨çš„è¯ï¼Œå¾ˆæ˜¾ç„¶å¯¹é©±åŠ¨è¡¨çš„å•è¡¨æŸ¥è¯¢å¯ä»¥ä½¿ç”¨idx_key2ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢ã€‚æ­¤æ—¶idx_key2çš„èŒƒå›´åŒºé—´(10, 1000)ä¸­æœ‰å¤šå°‘æ¡è®°å½•ï¼Œé‚£ä¹ˆæ‰‡å‡ºå€¼å°±æ˜¯å¤šå°‘ã€‚æˆ‘ä»¬å‰è¾¹è®¡ç®—è¿‡ï¼Œæ»¡è¶³idx_key2çš„èŒƒå›´åŒºé—´(10, 1000)çš„è®°å½•æ•°æ˜¯95æ¡ï¼Œä¹Ÿå°±æ˜¯è¯´æœ¬æŸ¥è¯¢ä¸­ä¼˜åŒ–å™¨ä¼šæŠŠ95å½“ä½œé©±åŠ¨è¡¨s1çš„æ‰‡å‡ºå€¼ã€‚ 12SELECT * FROM single_table AS s1 INNER JOIN single_table2 AS s2 WHERE s1.key2 &gt;10 AND s1.key2 &lt; 1000; æœ‰çš„æ—¶å€™æ‰‡å‡ºå€¼çš„è®¡ç®—å°±å˜å¾—å¾ˆæ£˜æ‰‹ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹å‡ ä¸ªæŸ¥è¯¢ï¼š æŸ¥è¯¢ä¸‰ï¼šæœ¬æŸ¥è¯¢å’ŒæŸ¥è¯¢ä¸€ç±»ä¼¼ï¼Œåªä¸è¿‡å¯¹äºé©±åŠ¨è¡¨s1å¤šäº†ä¸€ä¸ªcommon_field &gt; &#39;xyz&#39;çš„æœç´¢æ¡ä»¶ã€‚æŸ¥è¯¢ä¼˜åŒ–å™¨åˆä¸ä¼šçœŸæ­£çš„å»æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ‰€ä»¥å®ƒåªèƒ½çŒœè¿™9693è®°å½•é‡Œæœ‰å¤šå°‘æ¡è®°å½•æ»¡è¶³common_field &gt; &#39;xyz&#39;æ¡ä»¶ã€‚ 12SELECT * FROM single_table AS s1 INNER JOIN single_table2 AS s2 WHERE s1.common_field &gt; &#x27;xyz&#x27;; æŸ¥è¯¢å››ï¼šæœ¬æŸ¥è¯¢å’ŒæŸ¥è¯¢äºŒç±»ä¼¼ï¼Œåªä¸è¿‡å¯¹äºé©±åŠ¨è¡¨s1ä¹Ÿå¤šäº†ä¸€ä¸ªcommon_field &gt; &#39;xyz&#39;çš„æœç´¢æ¡ä»¶ã€‚ä¸è¿‡å› ä¸ºæœ¬æŸ¥è¯¢å¯ä»¥ä½¿ç”¨idx_key2ç´¢å¼•ï¼Œæ‰€ä»¥åªéœ€è¦ä»ç¬¦åˆäºŒçº§ç´¢å¼•èŒƒå›´åŒºé—´çš„è®°å½•ä¸­çŒœæœ‰å¤šå°‘æ¡è®°å½•ç¬¦åˆcommon_field &gt; &#39;xyz&#39;æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯åªéœ€è¦çŒœåœ¨95æ¡è®°å½•ä¸­æœ‰å¤šå°‘ç¬¦åˆcommon_field &gt; &#39;xyz&#39;æ¡ä»¶ã€‚ 123SELECT * FROM single_table AS s1 INNER JOIN single_table2 AS s2 WHERE s1.key2 &gt; 10 AND s1.key2 &lt; 1000 AND s1.common_field &gt; &#x27;xyz&#x27;; æŸ¥è¯¢äº”ï¼šæœ¬æŸ¥è¯¢å’ŒæŸ¥è¯¢äºŒç±»ä¼¼ï¼Œä¸è¿‡åœ¨é©±åŠ¨è¡¨s1é€‰å–idx_key2ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢åï¼Œä¼˜åŒ–å™¨éœ€è¦ä»ç¬¦åˆäºŒçº§ç´¢å¼•èŒƒå›´åŒºé—´çš„è®°å½•ä¸­çŒœæœ‰å¤šå°‘æ¡è®°å½•ç¬¦åˆä¸‹è¾¹ä¸¤ä¸ªæ¡ä»¶ï¼š 1234SELECT * FROM single_table AS s1 INNER JOIN single_table2 AS s2 WHERE s1.key2 &gt; 10 AND s1.key2 &lt; 1000 AND s1.key1 IN (&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;) AND s1.common_field &gt; &#x27;xyz&#x27;; key1 IN (&#39;a&#39;, &#39;b&#39;, &#39;c&#39;) common_field &gt; &#39;xyz&#39; ä¹Ÿå°±æ˜¯ä¼˜åŒ–å™¨éœ€è¦çŒœåœ¨95æ¡è®°å½•ä¸­æœ‰å¤šå°‘ç¬¦åˆä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶çš„ã€‚ è¯´äº†è¿™ä¹ˆå¤šï¼Œå…¶å®å°±æ˜¯æƒ³è¡¨è¾¾åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹è®¡ç®—é©±åŠ¨è¡¨æ‰‡å‡ºå€¼æ—¶éœ€è¦é çŒœï¼š å¦‚æœä½¿ç”¨çš„æ˜¯å…¨è¡¨æ‰«æçš„æ–¹å¼æ‰§è¡Œçš„å•è¡¨æŸ¥è¯¢ï¼Œé‚£ä¹ˆè®¡ç®—é©±åŠ¨è¡¨æ‰‡å‡ºæ—¶éœ€è¦çŒœæ»¡è¶³æœç´¢æ¡ä»¶çš„è®°å½•åˆ°åº•æœ‰å¤šå°‘æ¡ã€‚ å¦‚æœä½¿ç”¨çš„æ˜¯ç´¢å¼•æ‰§è¡Œçš„å•è¡¨æ‰«æï¼Œé‚£ä¹ˆè®¡ç®—é©±åŠ¨è¡¨æ‰‡å‡ºçš„æ—¶å€™éœ€è¦çŒœæ»¡è¶³é™¤ä½¿ç”¨åˆ°å¯¹åº”ç´¢å¼•çš„æœç´¢æ¡ä»¶å¤–çš„å…¶ä»–æœç´¢æ¡ä»¶çš„è®°å½•æœ‰å¤šå°‘æ¡ã€‚ MySQLæŠŠè¿™ä¸ªçŒœçš„è¿‡ç¨‹ç§°ä¹‹ä¸ºcondition filteringã€‚å½“ç„¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šä½¿ç”¨åˆ°ç´¢å¼•ï¼Œä¹Ÿå¯èƒ½ä½¿ç”¨åˆ°ç»Ÿè®¡æ•°æ®ï¼Œä¹Ÿå¯èƒ½å°±æ˜¯MySQLå•çº¯çš„ççŒœã€‚ åœ¨MySQL 5.7ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨åœ¨è®¡ç®—é©±åŠ¨è¡¨æ‰‡å‡ºæ—¶ï¼Œå¦‚æœæ˜¯ä½¿ç”¨å…¨è¡¨æ‰«æçš„è¯ï¼Œå°±ç›´æ¥ä½¿ç”¨è¡¨ä¸­è®°å½•çš„æ•°é‡ä½œä¸ºæ‰‡å‡ºå€¼ï¼Œå¦‚æœä½¿ç”¨ç´¢å¼•çš„è¯ï¼Œå°±ç›´æ¥ä½¿ç”¨æ»¡è¶³èŒƒå›´æ¡ä»¶çš„ç´¢å¼•è®°å½•æ¡æ•°ä½œä¸ºæ‰‡å‡ºå€¼ã€‚åœ¨MySQL 5.7ä¸­ï¼ŒMySQLå¼•å…¥äº†è¿™ä¸ªcondition filteringçš„åŠŸèƒ½ï¼Œå°±æ˜¯è¿˜è¦çŒœä¸€çŒœå‰©ä½™çš„é‚£äº›æœç´¢æ¡ä»¶èƒ½æŠŠé©±åŠ¨è¡¨ä¸­çš„è®°å½•å†è¿‡æ»¤å¤šå°‘æ¡ï¼Œå…¶å®æœ¬è´¨ä¸Šå°±æ˜¯ä¸ºäº†è®©æˆæœ¬ä¼°ç®—æ›´ç²¾ç¡®ã€‚ MySQLç§°ä¹‹ä¸ºå¯å‘å¼è§„åˆ™ï¼ˆheuristicï¼‰ã€‚ 3.2 ä¸¤è¡¨è¿æ¥æˆæœ¬åˆ†æè¿æ¥æŸ¥è¯¢çš„æˆæœ¬è®¡ç®—å…¬å¼æ˜¯è¿™æ ·çš„ï¼š 1è¿æ¥æŸ¥è¯¢æ€»æˆæœ¬ = å•æ¬¡è®¿é—®é©±åŠ¨è¡¨çš„æˆæœ¬ + é©±åŠ¨è¡¨æ‰‡å‡ºæ•° x å•æ¬¡è®¿é—®è¢«é©±åŠ¨è¡¨çš„æˆæœ¬ å¯¹äºå·¦ï¼ˆå¤–ï¼‰è¿æ¥å’Œå³ï¼ˆå¤–ï¼‰è¿æ¥æŸ¥è¯¢æ¥è¯´ï¼Œå®ƒä»¬çš„é©±åŠ¨è¡¨æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æƒ³è¦å¾—åˆ°æœ€ä¼˜çš„æŸ¥è¯¢æ–¹æ¡ˆåªéœ€è¦ï¼š åˆ†åˆ«ä¸ºé©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨é€‰æ‹©æˆæœ¬æœ€ä½çš„è®¿é—®æ–¹æ³•ã€‚ å¯æ˜¯å¯¹äºå†…è¿æ¥æ¥è¯´ï¼Œé©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨çš„ä½ç½®æ˜¯å¯ä»¥äº’æ¢çš„ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘ä¸¤ä¸ªæ–¹é¢çš„é—®é¢˜ï¼š ä¸åŒçš„è¡¨ä½œä¸ºé©±åŠ¨è¡¨æœ€ç»ˆçš„æŸ¥è¯¢æˆæœ¬å¯èƒ½æ˜¯ä¸åŒçš„ï¼Œä¹Ÿå°±æ˜¯éœ€è¦è€ƒè™‘æœ€ä¼˜çš„è¡¨è¿æ¥é¡ºåºã€‚ ç„¶ååˆ†åˆ«ä¸ºé©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨é€‰æ‹©æˆæœ¬æœ€ä½çš„è®¿é—®æ–¹æ³•ã€‚ å¾ˆæ˜¾ç„¶ï¼Œè®¡ç®—å†…è¿æ¥æŸ¥è¯¢æˆæœ¬çš„æ–¹å¼æ›´éº»çƒ¦ä¸€äº›ï¼Œä¸‹è¾¹æˆ‘ä»¬å°±ä»¥å†…è¿æ¥ä¸ºä¾‹æ¥çœ‹çœ‹å¦‚ä½•è®¡ç®—å‡ºæœ€ä¼˜çš„è¿æ¥æŸ¥è¯¢æ–¹æ¡ˆã€‚ å·¦ï¼ˆå¤–ï¼‰è¿æ¥å’Œå³ï¼ˆå¤–ï¼‰è¿æ¥æŸ¥è¯¢åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹å¯ä»¥è¢«ä¼˜åŒ–ä¸ºå†…è¿æ¥æŸ¥è¯¢ã€‚ æ¯”å¦‚å¯¹äºä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢æ¥è¯´ï¼š 1234SELECT * FROM single_table AS s1 INNER JOIN single_table2 AS s2 ON s1.key1 = s2.common_field WHERE s1.key2 &gt; 10 AND s1.key2 &lt; 1000 AND s2.key2 &gt; 1000 AND s2.key2 &lt; 2000; å¯ä»¥é€‰æ‹©çš„è¿æ¥é¡ºåºæœ‰ä¸¤ç§ï¼š s1è¿æ¥s2ï¼Œä¹Ÿå°±æ˜¯s1ä½œä¸ºé©±åŠ¨è¡¨ï¼Œs2ä½œä¸ºè¢«é©±åŠ¨è¡¨ã€‚ s2è¿æ¥s1ï¼Œä¹Ÿå°±æ˜¯s2ä½œä¸ºé©±åŠ¨è¡¨ï¼Œs1ä½œä¸ºè¢«é©±åŠ¨è¡¨ã€‚ æŸ¥è¯¢ä¼˜åŒ–å™¨éœ€è¦åˆ†åˆ«è€ƒè™‘è¿™ä¸¤ç§æƒ…å†µä¸‹çš„æœ€ä¼˜æŸ¥è¯¢æˆæœ¬ï¼Œç„¶åé€‰å–é‚£ä¸ªæˆæœ¬æ›´ä½çš„è¿æ¥é¡ºåºä»¥åŠè¯¥è¿æ¥é¡ºåºä¸‹å„ä¸ªè¡¨çš„æœ€ä¼˜è®¿é—®æ–¹æ³•ä½œä¸ºæœ€ç»ˆçš„æŸ¥è¯¢è®¡åˆ’ã€‚æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸€ä¸‹ï¼ˆå®šæ€§çš„åˆ†æä¸€ä¸‹ï¼Œä¸åƒåˆ†æå•è¡¨æŸ¥è¯¢é‚£æ ·å®šé‡çš„åˆ†æäº†ï¼‰ï¼š ä½¿ç”¨s1ä½œä¸ºé©±åŠ¨è¡¨çš„æƒ…å†µ åˆ†æå¯¹äºé©±åŠ¨è¡¨çš„æˆæœ¬æœ€ä½çš„æ‰§è¡Œæ–¹æ¡ˆé¦–å…ˆçœ‹ä¸€ä¸‹æ¶‰åŠs1è¡¨å•è¡¨çš„æœç´¢æ¡ä»¶æœ‰å“ªäº›ï¼š s1.key2 &gt; 10 AND s1.key2 &lt; 1000 æ‰€ä»¥è¿™ä¸ªæŸ¥è¯¢å¯èƒ½ä½¿ç”¨åˆ°idx_key2ç´¢å¼•ï¼Œä»å…¨è¡¨æ‰«æå’Œä½¿ç”¨idx_key2è¿™ä¸¤ä¸ªæ–¹æ¡ˆä¸­é€‰å‡ºæˆæœ¬æœ€ä½çš„é‚£ä¸ªï¼Œå¾ˆæ˜¾ç„¶ä½¿ç”¨idx_key2æ‰§è¡ŒæŸ¥è¯¢çš„æˆæœ¬æ›´ä½äº›ã€‚ ç„¶ååˆ†æå¯¹äºè¢«é©±åŠ¨è¡¨çš„æˆæœ¬æœ€ä½çš„æ‰§è¡Œæ–¹æ¡ˆæ­¤æ—¶æ¶‰åŠè¢«é©±åŠ¨è¡¨s2çš„æœç´¢æ¡ä»¶å°±æ˜¯ï¼š s2.common_field = å¸¸æ•°ï¼ˆè¿™æ˜¯å› ä¸ºå¯¹é©±åŠ¨è¡¨s1ç»“æœé›†ä¸­çš„æ¯ä¸€æ¡è®°å½•ï¼Œéƒ½éœ€è¦è¿›è¡Œä¸€æ¬¡è¢«é©±åŠ¨è¡¨s2çš„è®¿é—®ï¼Œæ­¤æ—¶é‚£äº›æ¶‰åŠä¸¤è¡¨çš„æ¡ä»¶ç°åœ¨ç›¸å½“äºåªæ¶‰åŠè¢«é©±åŠ¨è¡¨s2äº†ã€‚ï¼‰ s2.key2 &gt; 1000 AND s2.key2 &lt; 2000 å¾ˆæ˜¾ç„¶ï¼Œç¬¬ä¸€ä¸ªæ¡ä»¶ç”±äºcommon_fieldæ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼Œæ­¤æ—¶è®¿é—®s2è¡¨æ—¶å¯ç”¨çš„æ–¹æ¡ˆä¹Ÿæ˜¯å…¨è¡¨æ‰«æå’Œä½¿ç”¨idx_key2ä¸¤ç§ï¼Œå‡è®¾ä½¿ç”¨idx_key2çš„æˆæœ¬æ›´å°ã€‚æ‰€ä»¥æ­¤æ—¶ä½¿ç”¨s1ä½œä¸ºé©±åŠ¨è¡¨æ—¶çš„æ€»æˆæœ¬å°±æ˜¯ï¼ˆæš‚æ—¶ä¸è€ƒè™‘ä½¿ç”¨join bufferå¯¹æˆæœ¬çš„å½±å“ï¼‰ï¼š 1ä½¿ç”¨idx_key2è®¿é—®s1çš„æˆæœ¬ + s1çš„æ‰‡å‡º Ã— ä½¿ç”¨idx_key2è®¿é—®s2çš„æˆæœ¬ ä½¿ç”¨s2ä½œä¸ºé©±åŠ¨è¡¨çš„æƒ…å†µ åˆ†æå¯¹äºé©±åŠ¨è¡¨çš„æˆæœ¬æœ€ä½çš„æ‰§è¡Œæ–¹æ¡ˆé¦–å…ˆçœ‹ä¸€ä¸‹æ¶‰åŠs2è¡¨å•è¡¨çš„æœç´¢æ¡ä»¶æœ‰å“ªäº›ï¼š s2.key2 &gt; 1000 AND s2.key2 &lt; 2000 æ‰€ä»¥è¿™ä¸ªæŸ¥è¯¢å¯èƒ½ä½¿ç”¨åˆ°idx_key2ç´¢å¼•ï¼Œä»å…¨è¡¨æ‰«æå’Œä½¿ç”¨idx_key2è¿™ä¸¤ä¸ªæ–¹æ¡ˆä¸­é€‰å‡ºæˆæœ¬æœ€ä½çš„é‚£ä¸ªï¼Œå‡è®¾ä½¿ç”¨idx_key2æ‰§è¡ŒæŸ¥è¯¢çš„æˆæœ¬æ›´ä½äº›ã€‚ ç„¶ååˆ†æå¯¹äºè¢«é©±åŠ¨è¡¨çš„æˆæœ¬æœ€ä½çš„æ‰§è¡Œæ–¹æ¡ˆæ­¤æ—¶æ¶‰åŠè¢«é©±åŠ¨è¡¨s1çš„æœç´¢æ¡ä»¶å°±æ˜¯ï¼š s1.key1 = å¸¸æ•° s1.key2 &gt; 10 AND s1.key2 &lt; 2000 è¿™æ—¶å°±å¾ˆæœ‰è¶£äº†ï¼Œä½¿ç”¨idx_key1å¯ä»¥è¿›è¡Œrefæ–¹å¼çš„è®¿é—®ï¼Œä½¿ç”¨idx_key2å¯ä»¥ä½¿ç”¨rangeæ–¹å¼çš„è®¿é—®ã€‚è¿™æ—¶ä¼˜åŒ–å™¨éœ€è¦ä»å…¨è¡¨æ‰«æã€ä½¿ç”¨idx_key1ã€ä½¿ç”¨idx_key2è¿™å‡ ä¸ªæ–¹æ¡ˆé‡Œé€‰å‡ºä¸€ä¸ªæˆæœ¬æœ€ä½çš„æ–¹æ¡ˆã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå› ä¸ºidx_key2çš„èŒƒå›´åŒºé—´æ˜¯ç¡®å®šçš„ï¼š(10, 1000)ï¼Œæ€ä¹ˆè®¡ç®—ä½¿ç”¨idx_key2çš„æˆæœ¬æˆ‘ä»¬ä¸Šè¾¹å·²ç»è¯´è¿‡äº†ï¼Œå¯æ˜¯åœ¨æ²¡æœ‰çœŸæ­£æ‰§è¡ŒæŸ¥è¯¢å‰ï¼Œs1.key1 = å¸¸æ•°ä¸­çš„å¸¸æ•°å€¼æˆ‘ä»¬å¹¶ä¸çŸ¥é“ï¼Œæ€ä¹ˆè¡¡é‡ä½¿ç”¨idx_key1æ‰§è¡ŒæŸ¥è¯¢çš„æˆæœ¬å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œç›´æ¥ä½¿ç”¨ç´¢å¼•ç»Ÿè®¡æ•°æ®å°±å¥½äº†ï¼ˆå°±æ˜¯ç´¢å¼•åˆ—å¹³å‡ä¸€ä¸ªå€¼é‡å¤å¤šå°‘æ¬¡ï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œrefçš„è®¿é—®æ–¹å¼è¦æ¯”rangeæˆæœ¬æ›´ä½ï¼Œè¿™é‡Œå‡è®¾ä½¿ç”¨idx_key1è¿›è¡Œå¯¹s1çš„è®¿é—®ã€‚æ‰€ä»¥æ­¤æ—¶ä½¿ç”¨s2ä½œä¸ºé©±åŠ¨è¡¨æ—¶çš„æ€»æˆæœ¬å°±æ˜¯ï¼š 1ä½¿ç”¨idx_key2è®¿é—®s2çš„æˆæœ¬ + s2çš„æ‰‡å‡º Ã— ä½¿ç”¨idx_key1è®¿é—®s1çš„æˆæœ¬ æœ€åä¼˜åŒ–å™¨ä¼šæ¯”è¾ƒè¿™ä¸¤ç§æ–¹å¼çš„æœ€ä¼˜è®¿é—®æˆæœ¬ï¼Œé€‰å–é‚£ä¸ªæˆæœ¬æ›´ä½çš„è¿æ¥é¡ºåºå»çœŸæ­£çš„æ‰§è¡ŒæŸ¥è¯¢ã€‚ä»ä¸Šè¾¹çš„è®¡ç®—è¿‡ç¨‹ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿æ¥æŸ¥è¯¢æˆæœ¬å å¤§å¤´çš„å…¶å®æ˜¯é©±åŠ¨è¡¨æ‰‡å‡ºæ•° x å•æ¬¡è®¿é—®è¢«é©±åŠ¨è¡¨çš„æˆæœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ä¼˜åŒ–é‡ç‚¹å…¶å®æ˜¯ä¸‹è¾¹è¿™ä¸¤ä¸ªéƒ¨åˆ†ï¼š å°½é‡å‡å°‘é©±åŠ¨è¡¨çš„æ‰‡å‡º å¯¹è¢«é©±åŠ¨è¡¨çš„è®¿é—®æˆæœ¬å°½é‡ä½è¿™ä¸€ç‚¹å¯¹äºæˆ‘ä»¬å®é™…ä¹¦å†™è¿æ¥æŸ¥è¯¢è¯­å¥æ—¶ååˆ†æœ‰ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å°½é‡åœ¨è¢«é©±åŠ¨è¡¨çš„è¿æ¥åˆ—ä¸Šå»ºç«‹ç´¢å¼•ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨refè®¿é—®æ–¹æ³•æ¥é™ä½è®¿é—®è¢«é©±åŠ¨è¡¨çš„æˆæœ¬äº†ã€‚å¦‚æœå¯ä»¥ï¼Œè¢«é©±åŠ¨è¡¨çš„è¿æ¥åˆ—æœ€å¥½æ˜¯è¯¥è¡¨çš„ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠè®¿é—®è¢«é©±åŠ¨è¡¨çš„æˆæœ¬é™åˆ°æ›´ä½äº†ã€‚ 3.3 å¤šè¡¨è¿æ¥çš„æˆæœ¬åˆ†æé¦–å…ˆè¦è€ƒè™‘ä¸€ä¸‹å¤šè¡¨è¿æ¥æ—¶å¯èƒ½äº§ç”Ÿå‡ºå¤šå°‘ç§è¿æ¥é¡ºåºï¼š å¯¹äºä¸¤è¡¨è¿æ¥ï¼Œæ¯”å¦‚è¡¨Aå’Œè¡¨Bè¿æ¥åªæœ‰ ABã€BAè¿™ä¸¤ç§è¿æ¥é¡ºåºã€‚å…¶å®ç›¸å½“äº2 Ã— 1 = 2ç§è¿æ¥é¡ºåºã€‚ å¯¹äºä¸‰è¡¨è¿æ¥ï¼Œæ¯”å¦‚è¡¨Aã€è¡¨Bã€è¡¨Cè¿›è¡Œè¿æ¥æœ‰ABCã€ACBã€BACã€BCAã€CABã€CBAè¿™ä¹ˆ6ç§è¿æ¥é¡ºåºã€‚å…¶å®ç›¸å½“äº3 Ã— 2 Ã— 1 = 6ç§è¿æ¥é¡ºåºã€‚ å¯¹äºå››è¡¨è¿æ¥çš„è¯ï¼Œåˆ™ä¼šæœ‰4 Ã— 3 Ã— 2 Ã— 1 = 24ç§è¿æ¥é¡ºåºã€‚ å¯¹äºnè¡¨è¿æ¥çš„è¯ï¼Œåˆ™æœ‰ n Ã— (n-1) Ã— (n-2) Ã— Â·Â·Â· Ã— 1ç§è¿æ¥é¡ºåºï¼Œå°±æ˜¯nçš„é˜¶ä¹˜ç§è¿æ¥é¡ºåºï¼Œä¹Ÿå°±æ˜¯n!ã€‚ æœ‰nä¸ªè¡¨è¿›è¡Œè¿æ¥ï¼ŒMySQLæŸ¥è¯¢ä¼˜åŒ–å™¨è¦æ¯ä¸€ç§è¿æ¥é¡ºåºçš„æˆæœ¬éƒ½è®¡ç®—ä¸€éï¼Œä¸è¿‡MySQLæƒ³äº†å¾ˆå¤šåŠæ³•å‡å°‘è®¡ç®—éå¸¸å¤šç§è¿æ¥é¡ºåºçš„æˆæœ¬çš„æ–¹æ³•ï¼š æå‰ç»“æŸæŸç§é¡ºåºçš„æˆæœ¬è¯„ä¼°MySQLåœ¨è®¡ç®—å„ç§é“¾æ¥é¡ºåºçš„æˆæœ¬ä¹‹å‰ï¼Œä¼šç»´æŠ¤ä¸€ä¸ªå…¨å±€çš„å˜é‡ï¼Œè¿™ä¸ªå˜é‡è¡¨ç¤ºå½“å‰æœ€å°çš„è¿æ¥æŸ¥è¯¢æˆæœ¬ã€‚å¦‚æœåœ¨åˆ†ææŸä¸ªè¿æ¥é¡ºåºçš„æˆæœ¬æ—¶ï¼Œè¯¥æˆæœ¬å·²ç»è¶…è¿‡å½“å‰æœ€å°çš„è¿æ¥æŸ¥è¯¢æˆæœ¬ï¼Œé‚£å°±ä¸å¯¹è¯¥è¿æ¥é¡ºåºç»§ç»­å¾€ä¸‹åˆ†æäº†ã€‚æ¯”æ–¹è¯´Aã€Bã€Cä¸‰ä¸ªè¡¨è¿›è¡Œè¿æ¥ï¼Œå·²ç»å¾—åˆ°è¿æ¥é¡ºåºABCæ˜¯å½“å‰çš„æœ€å°è¿æ¥æˆæœ¬ï¼Œæ¯”æ–¹è¯´10.0ï¼Œåœ¨è®¡ç®—è¿æ¥é¡ºåºBCAæ—¶ï¼Œå‘ç°Bå’ŒCçš„è¿æ¥æˆæœ¬å°±å·²ç»å¤§äº10.0æ—¶ï¼Œå°±ä¸å†ç»§ç»­å¾€ååˆ†æBCAè¿™ä¸ªè¿æ¥é¡ºåºçš„æˆæœ¬äº†ã€‚ ç³»ç»Ÿå˜é‡optimizer_search_depthä¸ºäº†é˜²æ­¢æ— ç©·æ— å°½çš„åˆ†æå„ç§è¿æ¥é¡ºåºçš„æˆæœ¬ï¼ŒMySQLæå‡ºäº†optimizer_search_depthç³»ç»Ÿå˜é‡ï¼Œå¦‚æœè¿æ¥è¡¨çš„ä¸ªæ•°å°äºè¯¥å€¼ï¼Œé‚£ä¹ˆå°±ç»§ç»­ç©·ä¸¾åˆ†ææ¯ä¸€ç§è¿æ¥é¡ºåºçš„æˆæœ¬ï¼Œå¦åˆ™åªå¯¹ä¸optimizer_search_depthå€¼ç›¸åŒæ•°é‡çš„è¡¨è¿›è¡Œç©·ä¸¾åˆ†æã€‚å¾ˆæ˜¾ç„¶ï¼Œè¯¥å€¼è¶Šå¤§ï¼Œæˆæœ¬åˆ†æçš„è¶Šç²¾ç¡®ï¼Œè¶Šå®¹æ˜“å¾—åˆ°å¥½çš„æ‰§è¡Œè®¡åˆ’ï¼Œä½†æ˜¯æ¶ˆè€—çš„æ—¶é—´ä¹Ÿå°±è¶Šé•¿ï¼Œå¦åˆ™å¾—åˆ°ä¸æ˜¯å¾ˆå¥½çš„æ‰§è¡Œè®¡åˆ’ï¼Œä½†å¯ä»¥çœæ‰å¾ˆå¤šåˆ†æè¿æ¥æˆæœ¬çš„æ—¶é—´ã€‚ æ ¹æ®æŸäº›è§„åˆ™å‹æ ¹å„¿å°±ä¸è€ƒè™‘æŸäº›è¿æ¥é¡ºåºå³ä½¿æ˜¯æœ‰ä¸Šè¾¹ä¸¤æ¡è§„åˆ™çš„é™åˆ¶ï¼Œä½†æ˜¯åˆ†æå¤šä¸ªè¡¨ä¸åŒè¿æ¥é¡ºåºæˆæœ¬èŠ±è´¹çš„æ—¶é—´è¿˜æ˜¯ä¼šå¾ˆé•¿ï¼Œæ‰€ä»¥MySQLå¹²è„†æå‡ºäº†ä¸€äº›æ‰€è°“çš„å¯å‘å¼è§„åˆ™ï¼ˆå°±æ˜¯æ ¹æ®ä»¥å¾€ç»éªŒæŒ‡å®šçš„ä¸€äº›è§„åˆ™ï¼‰ï¼Œå‡¡æ˜¯ä¸æ»¡è¶³è¿™äº›è§„åˆ™çš„è¿æ¥é¡ºåºå‹æ ¹å„¿å°±ä¸åˆ†æï¼Œè¿™æ ·å¯ä»¥æå¤§çš„å‡å°‘éœ€è¦åˆ†æçš„è¿æ¥é¡ºåºçš„æ•°é‡ï¼Œä½†æ˜¯ä¹Ÿå¯èƒ½é€ æˆé”™å¤±æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚ä»–ä»¬æä¾›äº†ä¸€ä¸ªç³»ç»Ÿå˜é‡optimizer_prune_levelæ¥æ§åˆ¶åˆ°åº•æ˜¯ä¸æ˜¯ç”¨è¿™äº›å¯å‘å¼è§„åˆ™ã€‚ 4. è°ƒèŠ‚æˆæœ¬å¸¸æ•°æˆ‘ä»¬å‰è¾¹å·²ç»ä»‹ç»äº†ä¸¤ä¸ªæˆæœ¬å¸¸æ•°ï¼š è¯»å–ä¸€ä¸ªé¡µé¢èŠ±è´¹çš„æˆæœ¬é»˜è®¤æ˜¯1.0 æ£€æµ‹ä¸€æ¡è®°å½•æ˜¯å¦ç¬¦åˆæœç´¢æ¡ä»¶çš„æˆæœ¬é»˜è®¤æ˜¯0.2 å…¶å®é™¤äº†è¿™ä¸¤ä¸ªæˆæœ¬å¸¸æ•°ï¼ŒMySQLè¿˜æ”¯æŒå¥½å¤šï¼Œå®ƒä»¬è¢«å­˜å‚¨åˆ°äº†mysqlæ•°æ®åº“ï¼ˆè¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿæ•°æ®åº“ï¼‰çš„ä¸¤ä¸ªè¡¨ä¸­ï¼š 12345678mysql&gt; SHOW TABLES FROM mysql LIKE &#x27;%cost%&#x27;;+--------------------------+| Tables_in_mysql (%cost%) |+--------------------------+| engine_cost || server_cost |+--------------------------+2 rows in set (0.00 sec) ä¸€æ¡è¯­å¥çš„æ‰§è¡Œå…¶å®æ˜¯åˆ†ä¸ºä¸¤å±‚çš„ï¼š serverå±‚ å­˜å‚¨å¼•æ“å±‚ åœ¨serverå±‚è¿›è¡Œè¿æ¥ç®¡ç†ã€æŸ¥è¯¢ç¼“å­˜ã€è¯­æ³•è§£æã€æŸ¥è¯¢ä¼˜åŒ–ç­‰æ“ä½œï¼Œåœ¨å­˜å‚¨å¼•æ“å±‚æ‰§è¡Œå…·ä½“çš„æ•°æ®å­˜å–æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€æ¡è¯­å¥åœ¨serverå±‚ä¸­æ‰§è¡Œçš„æˆæœ¬æ˜¯å’Œå®ƒæ“ä½œçš„è¡¨ä½¿ç”¨çš„å­˜å‚¨å¼•æ“æ˜¯æ²¡å…³ç³»çš„ï¼Œæ‰€ä»¥å…³äºè¿™äº›æ“ä½œå¯¹åº”çš„æˆæœ¬å¸¸æ•°å°±å­˜å‚¨åœ¨äº†server_costè¡¨ä¸­ï¼Œè€Œä¾èµ–äºå­˜å‚¨å¼•æ“çš„ä¸€äº›æ“ä½œå¯¹åº”çš„æˆæœ¬å¸¸æ•°å°±å­˜å‚¨åœ¨äº†engine_costè¡¨ä¸­ã€‚ 4.1mysql.server_costè¡¨server_costè¡¨ä¸­åœ¨serverå±‚è¿›è¡Œçš„ä¸€äº›æ“ä½œå¯¹åº”çš„æˆæœ¬å¸¸æ•°ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š 123456789101112mysql&gt; SELECT * FROM mysql.server_cost;+------------------------------+------------+---------------------+---------+| cost_name | cost_value | last_update | comment |+------------------------------+------------+---------------------+---------+| disk_temptable_create_cost | NULL | 2018-01-20 12:03:21 | NULL || disk_temptable_row_cost | NULL | 2018-01-20 12:03:21 | NULL || key_compare_cost | NULL | 2018-01-20 12:03:21 | NULL || memory_temptable_create_cost | NULL | 2018-01-20 12:03:21 | NULL || memory_temptable_row_cost | NULL | 2018-01-20 12:03:21 | NULL || row_evaluate_cost | NULL | 2018-01-20 12:03:21 | NULL |+------------------------------+------------+---------------------+---------+6 rows in set (0.05 sec) æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹server_costå„ä¸ªåˆ—éƒ½åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼š cost_nameè¡¨ç¤ºæˆæœ¬å¸¸æ•°çš„åç§°ã€‚ cost_valueè¡¨ç¤ºæˆæœ¬å¸¸æ•°å¯¹åº”çš„å€¼ã€‚å¦‚æœè¯¥åˆ—çš„å€¼ä¸ºNULLçš„è¯ï¼Œæ„å‘³ç€å¯¹åº”çš„æˆæœ¬å¸¸æ•°ä¼šé‡‡ç”¨é»˜è®¤å€¼ã€‚ last_updateè¡¨ç¤ºæœ€åæ›´æ–°è®°å½•çš„æ—¶é—´ã€‚ commentæ³¨é‡Šã€‚ ä»server_costä¸­çš„å†…å®¹å¯ä»¥çœ‹å‡ºæ¥ï¼Œç›®å‰åœ¨serverå±‚çš„ä¸€äº›æ“ä½œå¯¹åº”çš„æˆæœ¬å¸¸æ•°æœ‰ä»¥ä¸‹å‡ ç§ï¼š æˆæœ¬å¸¸æ•°åç§° é»˜è®¤å€¼ æè¿° disk_temptable_create_cost 40.0 åˆ›å»ºåŸºäºç£ç›˜çš„ä¸´æ—¶è¡¨çš„æˆæœ¬ï¼Œå¦‚æœå¢å¤§è¿™ä¸ªå€¼çš„è¯ä¼šè®©ä¼˜åŒ–å™¨å°½é‡å°‘çš„åˆ›å»ºåŸºäºç£ç›˜çš„ä¸´æ—¶è¡¨ã€‚ disk_temptable_row_cost 1.0 å‘åŸºäºç£ç›˜çš„ä¸´æ—¶è¡¨å†™å…¥æˆ–è¯»å–ä¸€æ¡è®°å½•çš„æˆæœ¬ï¼Œå¦‚æœå¢å¤§è¿™ä¸ªå€¼çš„è¯ä¼šè®©ä¼˜åŒ–å™¨å°½é‡å°‘çš„åˆ›å»ºåŸºäºç£ç›˜çš„ä¸´æ—¶è¡¨ã€‚ key_compare_cost 0.1 ä¸¤æ¡è®°å½•åšæ¯”è¾ƒæ“ä½œçš„æˆæœ¬ï¼Œå¤šç”¨åœ¨æ’åºæ“ä½œä¸Šï¼Œå¦‚æœå¢å¤§è¿™ä¸ªå€¼çš„è¯ä¼šæå‡filesort çš„æˆæœ¬ï¼Œè®©ä¼˜åŒ–å™¨å¯èƒ½æ›´å€¾å‘äºä½¿ç”¨ç´¢å¼•å®Œæˆæ’åºè€Œä¸æ˜¯filesort ã€‚ memory_temptable_create_cost 2.0 åˆ›å»ºåŸºäºå†…å­˜çš„ä¸´æ—¶è¡¨çš„æˆæœ¬ï¼Œå¦‚æœå¢å¤§è¿™ä¸ªå€¼çš„è¯ä¼šè®©ä¼˜åŒ–å™¨å°½é‡å°‘çš„åˆ›å»ºåŸºäºå†…å­˜çš„ä¸´æ—¶è¡¨ã€‚ memory_temptable_row_cost 0.2 å‘åŸºäºå†…å­˜çš„ä¸´æ—¶è¡¨å†™å…¥æˆ–è¯»å–ä¸€æ¡è®°å½•çš„æˆæœ¬ï¼Œå¦‚æœå¢å¤§è¿™ä¸ªå€¼çš„è¯ä¼šè®©ä¼˜åŒ–å™¨å°½é‡å°‘çš„åˆ›å»ºåŸºäºå†…å­˜çš„ä¸´æ—¶è¡¨ã€‚ row_evaluate_cost 0.2 è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬ä¹‹å‰ä¸€ç›´ä½¿ç”¨çš„æ£€æµ‹ä¸€æ¡è®°å½•æ˜¯å¦ç¬¦åˆæœç´¢æ¡ä»¶çš„æˆæœ¬ï¼Œå¢å¤§è¿™ä¸ªå€¼å¯èƒ½è®©ä¼˜åŒ–å™¨æ›´å€¾å‘äºä½¿ç”¨ç´¢å¼•è€Œä¸æ˜¯ç›´æ¥å…¨è¡¨æ‰«æã€‚ MySQLåœ¨æ‰§è¡Œè¯¸å¦‚DISTINCTæŸ¥è¯¢ã€åˆ†ç»„æŸ¥è¯¢ã€UnionæŸ¥è¯¢ä»¥åŠæŸäº›ç‰¹æ®Šæ¡ä»¶ä¸‹çš„æ’åºæŸ¥è¯¢éƒ½å¯èƒ½åœ¨å†…éƒ¨å…ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œä½¿ç”¨è¿™ä¸ªä¸´æ—¶è¡¨æ¥è¾…åŠ©å®ŒæˆæŸ¥è¯¢ï¼ˆæ¯”å¦‚å¯¹äºDISTINCTæŸ¥è¯¢å¯ä»¥å»ºä¸€ä¸ªå¸¦æœ‰UNIQUEç´¢å¼•çš„ä¸´æ—¶è¡¨ï¼Œç›´æ¥æŠŠéœ€è¦å»é‡çš„è®°å½•æ’å…¥åˆ°è¿™ä¸ªä¸´æ—¶è¡¨ä¸­ï¼Œæ’å…¥å®Œæˆä¹‹åçš„è®°å½•å°±æ˜¯ç»“æœé›†äº†ï¼‰ã€‚åœ¨æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹å¯èƒ½åˆ›å»ºåŸºäºç£ç›˜çš„ä¸´æ—¶è¡¨ï¼Œä¹Ÿå°±æ˜¯ä¸ºè¯¥ä¸´æ—¶è¡¨ä½¿ç”¨MyISAMã€InnoDBç­‰å­˜å‚¨å¼•æ“ï¼Œåœ¨æ•°æ®é‡ä¸å¤§æ—¶å¯èƒ½åˆ›å»ºåŸºäºå†…å­˜çš„ä¸´æ—¶è¡¨ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨Memoryå­˜å‚¨å¼•æ“ã€‚åˆ›å»ºä¸´æ—¶è¡¨å’Œå¯¹è¿™ä¸ªä¸´æ—¶è¡¨è¿›è¡Œå†™å…¥å’Œè¯»å–çš„æ“ä½œä»£ä»·è¿˜æ˜¯å¾ˆé«˜çš„ã€‚ è¿™äº›æˆæœ¬å¸¸æ•°åœ¨server_costä¸­çš„åˆå§‹å€¼éƒ½æ˜¯NULLï¼Œæ„å‘³ç€ä¼˜åŒ–å™¨ä¼šä½¿ç”¨å®ƒä»¬çš„é»˜è®¤å€¼æ¥è®¡ç®—æŸä¸ªæ“ä½œçš„æˆæœ¬ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä¿®æ”¹æŸä¸ªæˆæœ¬å¸¸æ•°çš„å€¼çš„è¯ï¼Œéœ€è¦åšä¸¤ä¸ªæ­¥éª¤ï¼š å¯¹æˆ‘ä»¬æ„Ÿå…´è¶£çš„æˆæœ¬å¸¸æ•°åšæ›´æ–°æ“ä½œæ¯”æ–¹è¯´æˆ‘ä»¬æƒ³æŠŠæ£€æµ‹ä¸€æ¡è®°å½•æ˜¯å¦ç¬¦åˆæœç´¢æ¡ä»¶çš„æˆæœ¬å¢å¤§åˆ°0.4ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿™æ ·å†™æ›´æ–°è¯­å¥ï¼š 123UPDATE mysql.server_cost SET cost_value = 0.4 WHERE cost_name = &#x27;row_evaluate_cost&#x27;; è®©ç³»ç»Ÿé‡æ–°åŠ è½½è¿™ä¸ªè¡¨çš„å€¼ã€‚ä½¿ç”¨ä¸‹è¾¹è¯­å¥å³å¯ï¼š 1FLUSH OPTIMIZER_COSTS; å½“ç„¶ï¼Œåœ¨ä½ ä¿®æ”¹å®ŒæŸä¸ªæˆæœ¬å¸¸æ•°åæƒ³æŠŠå®ƒä»¬å†æ”¹å›é»˜è®¤å€¼çš„è¯ï¼Œå¯ä»¥ç›´æ¥æŠŠcost_valueçš„å€¼è®¾ç½®ä¸ºNULLï¼Œå†ä½¿ç”¨FLUSH OPTIMIZER_COSTSè¯­å¥è®©ç³»ç»Ÿé‡æ–°åŠ è½½å®ƒå°±å¥½äº†ã€‚ 4.2mysql.engine_costè¡¨engine_costè¡¨è¡¨ä¸­åœ¨å­˜å‚¨å¼•æ“å±‚è¿›è¡Œçš„ä¸€äº›æ“ä½œå¯¹åº”çš„æˆæœ¬å¸¸æ•°ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š 12345678mysql&gt; SELECT * FROM mysql.engine_cost;+-------------+-------------+------------------------+------------+---------------------+---------+| engine_name | device_type | cost_name | cost_value | last_update | comment |+-------------+-------------+------------------------+------------+---------------------+---------+| default | 0 | io_block_read_cost | NULL | 2018-01-20 12:03:21 | NULL || default | 0 | memory_block_read_cost | NULL | 2018-01-20 12:03:21 | NULL |+-------------+-------------+------------------------+------------+---------------------+---------+2 rows in set (0.05 sec) ä¸server_costç›¸æ¯”ï¼Œengine_costå¤šäº†ä¸¤ä¸ªåˆ—ï¼š engine_nameåˆ—æŒ‡æˆæœ¬å¸¸æ•°é€‚ç”¨çš„å­˜å‚¨å¼•æ“åç§°ã€‚å¦‚æœè¯¥å€¼ä¸ºdefaultï¼Œæ„å‘³ç€å¯¹åº”çš„æˆæœ¬å¸¸æ•°é€‚ç”¨äºæ‰€æœ‰çš„å­˜å‚¨å¼•æ“ã€‚ device_typeåˆ—æŒ‡å­˜å‚¨å¼•æ“ä½¿ç”¨çš„è®¾å¤‡ç±»å‹ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†åŒºåˆ†å¸¸è§„çš„æœºæ¢°ç¡¬ç›˜å’Œå›ºæ€ç¡¬ç›˜ï¼Œä¸è¿‡åœ¨MySQL 5.7.21è¿™ä¸ªç‰ˆæœ¬ä¸­å¹¶æ²¡æœ‰å¯¹æœºæ¢°ç¡¬ç›˜çš„æˆæœ¬å’Œå›ºæ€ç¡¬ç›˜çš„æˆæœ¬ä½œåŒºåˆ†ï¼Œæ‰€ä»¥è¯¥å€¼é»˜è®¤æ˜¯0ã€‚ æˆ‘ä»¬ä»engine_costè¡¨ä¸­çš„å†…å®¹å¯ä»¥çœ‹å‡ºæ¥ï¼Œç›®å‰æ”¯æŒçš„å­˜å‚¨å¼•æ“æˆæœ¬å¸¸æ•°åªæœ‰ä¸¤ä¸ªï¼š æˆæœ¬å¸¸æ•°åç§° é»˜è®¤å€¼ æè¿° io_block_read_cost 1.0 ä»ç£ç›˜ä¸Šè¯»å–ä¸€ä¸ªå—å¯¹åº”çš„æˆæœ¬ã€‚è¯·æ³¨æ„æˆ‘ä½¿ç”¨çš„æ˜¯å— ï¼Œè€Œä¸æ˜¯é¡µ è¿™ä¸ªè¯å„¿ã€‚å¯¹äºInnoDB å­˜å‚¨å¼•æ“æ¥è¯´ï¼Œä¸€ä¸ªé¡µ å°±æ˜¯ä¸€ä¸ªå—ï¼Œä¸è¿‡å¯¹äºMyISAM å­˜å‚¨å¼•æ“æ¥è¯´ï¼Œé»˜è®¤æ˜¯ä»¥4096 å­—èŠ‚ä½œä¸ºä¸€ä¸ªå—çš„ã€‚å¢å¤§è¿™ä¸ªå€¼ä¼šåŠ é‡I/O æˆæœ¬ï¼Œå¯èƒ½è®©ä¼˜åŒ–å™¨æ›´å€¾å‘äºé€‰æ‹©ä½¿ç”¨ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢è€Œä¸æ˜¯æ‰§è¡Œå…¨è¡¨æ‰«æã€‚ memory_block_read_cost 1.0 ä¸ä¸Šä¸€ä¸ªå‚æ•°ç±»ä¼¼ï¼Œåªä¸è¿‡è¡¡é‡çš„æ˜¯ä»å†…å­˜ä¸­è¯»å–ä¸€ä¸ªå—å¯¹åº”çš„æˆæœ¬ã€‚ æ€ä¹ˆä»å†…å­˜ä¸­å’Œä»ç£ç›˜ä¸Šè¯»å–ä¸€ä¸ªå—çš„é»˜è®¤æˆæœ¬æ˜¯ä¸€æ ·çš„ï¼Ÿè¿™ä¸»è¦æ˜¯å› ä¸ºåœ¨MySQLç›®å‰çš„å®ç°ä¸­ï¼Œå¹¶ä¸èƒ½å‡†ç¡®é¢„æµ‹æŸä¸ªæŸ¥è¯¢éœ€è¦è®¿é—®çš„å—ä¸­æœ‰å“ªäº›å—å·²ç»åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæœ‰å“ªäº›å—è¿˜åœç•™åœ¨ç£ç›˜ä¸Šï¼Œæ‰€ä»¥MySQLè®¤ä¸ºä¸ç®¡è¿™ä¸ªå—æœ‰æ²¡æœ‰åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä½¿ç”¨çš„æˆæœ¬éƒ½æ˜¯1.0ï¼Œä¸è¿‡éšç€MySQLçš„å‘å±•ï¼Œç­‰åˆ°å¯ä»¥å‡†ç¡®é¢„æµ‹å“ªäº›å—åœ¨ç£ç›˜ä¸Šï¼Œé‚£äº›å—åœ¨å†…å­˜ä¸­çš„é‚£ä¸€å¤©ï¼Œè¿™ä¸¤ä¸ªæˆæœ¬å¸¸æ•°çš„é»˜è®¤å€¼å¯èƒ½ä¼šæ”¹ã€‚ ä¸æ›´æ–°server_costè¡¨ä¸­çš„è®°å½•ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ›´æ–°engine_costè¡¨ä¸­çš„è®°å½•æ¥æ›´æ”¹å…³äºå­˜å‚¨å¼•æ“çš„æˆæœ¬å¸¸æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¸ºengine_costè¡¨æ’å…¥æ–°è®°å½•çš„æ–¹å¼æ¥æ·»åŠ åªé’ˆå¯¹æŸç§å­˜å‚¨å¼•æ“çš„æˆæœ¬å¸¸æ•°ï¼š æ’å…¥é’ˆå¯¹æŸä¸ªå­˜å‚¨å¼•æ“çš„æˆæœ¬å¸¸æ•°æ¯”å¦‚æˆ‘ä»¬æƒ³å¢å¤§InnoDBå­˜å‚¨å¼•æ“é¡µé¢I/Oçš„æˆæœ¬ï¼Œä¹¦å†™æ­£å¸¸çš„æ’å…¥è¯­å¥å³å¯ï¼š 123INSERT INTO mysql.engine_cost VALUES (&#x27;InnoDB&#x27;, 0, &#x27;io_block_read_cost&#x27;, 2.0, CURRENT_TIMESTAMP, &#x27;increase Innodb I/O cost&#x27;); è®©ç³»ç»Ÿé‡æ–°åŠ è½½è¿™ä¸ªè¡¨çš„å€¼ã€‚ä½¿ç”¨ä¸‹è¾¹è¯­å¥å³å¯ï¼š 1FLUSH OPTIMIZER_COSTS; 5. æ€»ç»“åœ¨MySQLä¸­ï¼Œä¸€ä¸ªæŸ¥è¯¢çš„æ‰§è¡Œæˆæœ¬æ˜¯ç”±IOæˆæœ¬å’ŒCPUæˆæœ¬ç»„æˆçš„ã€‚å¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´ï¼Œè¯»å–ä¸€ä¸ªé¡µé¢çš„é»˜è®¤IOæˆæœ¬æ˜¯1.0ï¼Œè¯»å–ä»¥åŠæ£€æµ‹ä¸€æ¡è®°å½•æ˜¯å¦ç¬¦åˆæœç´¢æ¡ä»¶çš„æˆæœ¬é»˜è®¤æ˜¯0.2ã€‚ åœ¨å•è¡¨æŸ¥è¯¢ä¸­ï¼Œä¼˜åŒ–å™¨ç”Ÿæˆæ‰§è¡Œè®¡åˆ’çš„æ­¥éª¤å¦‚ä¸‹ï¼š æ ¹æ®æœç´¢æ¡ä»¶ï¼Œæ‰¾å‡ºæ‰€æœ‰å¯èƒ½ä½¿ç”¨çš„ç´¢å¼• è®¡ç®—å…¨è¡¨æ‰«æçš„ä»£ä»· è®¡ç®—ä½¿ç”¨ä¸åŒç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢çš„ä»£ä»· å¯¹æ¯”å„ç§æ‰§è¡Œæ–¹æ¡ˆçš„ä»£ä»·ï¼Œæ‰¾å‡ºæˆæœ¬æœ€ä½çš„é‚£ä¸ªæ–¹æ¡ˆ åœ¨ä¼˜åŒ–å™¨ç”Ÿæˆæ‰§è¡Œè®¡åˆ’è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä¾èµ–ä¸€äº›æ•°æ®ã€‚è¿™äº›æ•°æ®å¯èƒ½æ˜¯ä½¿ç”¨ä¸‹é¢ä¸¤ç§æ–¹å¼å¾—åˆ°çš„ï¼š index diveï¼šé€šè¿‡ç›´æ¥è®¿é—®ç´¢å¼•å¯¹åº”çš„B+æ ‘æ¥è·å–æ•°æ® ç´¢å¼•ç»Ÿè®¡æ•°æ®ï¼šç›´æ¥ä¾èµ–å¯¹è¡¨æˆ–è€…ç´¢å¼•çš„ç»Ÿè®¡æ•°æ® ä¸ºäº†æ›´å‡†ç¡®çš„è®¡ç®—è¿æ¥æŸ¥è¯¢çš„æˆæœ¬ï¼ŒMySQLæå‡ºäº†æ¡ä»¶è¿‡æ»¤çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯é‡‡ç”¨äº†æŸäº›è§„åˆ™æ¥é¢„æµ‹é©±åŠ¨è¡¨çš„æ‰‡å‡ºå€¼ã€‚ å¯¹äºå†…è¿æ¥æ¥è¯´ï¼Œä¸ºäº†ç”Ÿæˆæˆæœ¬æœ€ä½çš„æ‰§è¡Œè®¡åˆ’ï¼Œéœ€è¦è€ƒè™‘ä¸¤æ–¹é¢çš„äº‹æƒ…ï¼š é€‰æ‹©æœ€ä¼˜çš„è¡¨è¿æ¥é¡ºåº ä¸ºé©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨é€‰æ‹©æˆæœ¬æœ€ä½çš„è®¿é—®æ–¹æ³• æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰‹åŠ¨ä¿®æ”¹MySQLæ•°æ®åº“ä¸‹engine_cost &amp; server_costè¡¨ä¸­çš„æŸäº›æˆæœ¬å¸¸æ•°ï¼Œæ›´ç²¾ç¡®çš„æ§åˆ¶åœ¨ç”Ÿæˆæ‰§è¡Œè®¡åˆ’æ—¶çš„æˆæœ¬è®¡ç®—è¿‡ç¨‹ã€‚","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[å…­]å•è¡¨æŸ¥è¯¢&è¿æ¥æŸ¥è¯¢åŸç†","slug":"MySQL/MySQL[å…­]å•è¡¨æŸ¥è¯¢&è¿æ¥æŸ¥è¯¢åŸç†","date":"2022-01-11T03:15:54.543Z","updated":"2022-01-11T03:21:05.026Z","comments":true,"path":"2022/01/11/MySQL/MySQL[å…­]å•è¡¨æŸ¥è¯¢&è¿æ¥æŸ¥è¯¢åŸç†/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E5%85%AD]%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2&%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2%E5%8E%9F%E7%90%86/","excerpt":"","text":"ä¸€ï¼Œå•è¡¨æŸ¥è¯¢ä¸ä¼šèµ°ä¹‹å‰ä¸è¦è·‘ï¼Œåœ¨å­¦SQLä¼˜åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ†æä¸‹SQLæ˜¯æ€ä¹ˆæ‰§è¡Œçš„ã€‚ å‰é¢è¯´è¿‡ï¼ŒMySQL Serveræœ‰ä¸€ä¸ªç§°ä¸ºæŸ¥è¯¢ä¼˜åŒ–å™¨çš„æ¨¡å—ï¼Œä¸€æ¡æŸ¥è¯¢è¯­å¥è¿›è¡Œè¯­æ³•è§£æä¹‹åå°±ä¼šè¢«äº¤ç»™æŸ¥è¯¢ä¼˜åŒ–å™¨æ¥è¿›è¡Œä¼˜åŒ–ï¼Œä¼˜åŒ–çš„ç»“æœå°±æ˜¯ç”Ÿæˆä¸€ä¸ªæ‰€è°“çš„æ‰§è¡Œè®¡åˆ’ï¼Œè¿™ä¸ªæ‰§è¡Œè®¡åˆ’è¡¨æ˜äº†åº”è¯¥ä½¿ç”¨å“ªäº›ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ï¼Œè¡¨ä¹‹é—´çš„è¿æ¥é¡ºåºæ˜¯å•¥æ ·çš„ï¼Œæœ€åä¼šæŒ‰ç…§æ‰§è¡Œè®¡åˆ’ä¸­çš„æ­¥éª¤è°ƒç”¨å­˜å‚¨å¼•æ“æä¾›çš„æ–¹æ³•æ¥çœŸæ­£çš„æ‰§è¡ŒæŸ¥è¯¢ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚ å¦‚æœè§‰å¾—æˆ‘è¿™ç¯‡åšå®¢è®²çš„çœ‹ä¸æ‡‚ï¼Œå›å¤´çœ‹çœ‹æˆ‘å‰é¢çš„å‡ ç¯‡ï¼ŒMySQLæ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„ä¸œè¥¿ï¼Œå°½é‡ä¸è¦è·³ç€å­¦ï¼Œè¦é™ä¸‹å¿ƒç³»ç»Ÿçš„æ¥å­¦ä¹ ï¼Œä¹‹å‰æˆ‘éƒ½æ˜¯å››å¤„çœ‹å¸–å­çœ‹åšå®¢ï¼Œä¸€ç›´è§‰å¾—è‡ªå·±MySQLè¿·è¿·ç³Šç³Šï¼Œç”šè‡³æˆäº†ç—›ç‚¹ï¼Œæ‰€ä»¥å†³å¿ƒå†™ä¸ªMySQLä¸“æ ï¼Œç³»ç»Ÿçš„å­¦ä¹ ä¸‹ã€‚ æˆ‘ä»¬å‰é¢åˆ›å»ºè¿‡ä¸€å¼ è¡¨ï¼Œç°åœ¨æ‹¿æ¥å¤ç”¨ä¸‹ã€‚ 123456789101112131415CREATE TABLE single_table ( id INT NOT NULL AUTO_INCREMENT, key1 VARCHAR(100), key2 INT, key3 VARCHAR(100), key_part1 VARCHAR(100), key_part2 VARCHAR(100), key_part3 VARCHAR(100), common_field VARCHAR(100), PRIMARY KEY (id), KEY idx_key1 (key1), UNIQUE KEY idx_key2 (key2), KEY idx_key3 (key3), KEY idx_key_part(key_part1, key_part2, key_part3)) Engine=InnoDB CHARSET=utf8; æˆ‘ä»¬ä¸ºè¿™ä¸ªsingle_tableè¡¨å»ºç«‹äº†1ä¸ªèšç°‡ç´¢å¼•å’Œ4ä¸ªäºŒçº§ç´¢å¼•ï¼Œåˆ†åˆ«æ˜¯ï¼š ä¸ºidåˆ—å»ºç«‹çš„èšç°‡ç´¢å¼•ã€‚ ä¸ºkey1åˆ—å»ºç«‹çš„idx_key1äºŒçº§ç´¢å¼•ã€‚ ä¸ºkey2åˆ—å»ºç«‹çš„idx_key2äºŒçº§ç´¢å¼•ï¼Œè€Œä¸”è¯¥ç´¢å¼•æ˜¯å”¯ä¸€äºŒçº§ç´¢å¼•ã€‚ ä¸ºkey3åˆ—å»ºç«‹çš„idx_key3äºŒçº§ç´¢å¼•ã€‚ ä¸ºkey_part1ã€key_part2ã€key_part3åˆ—å»ºç«‹çš„idx_key_partäºŒçº§ç´¢å¼•ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªè”åˆç´¢å¼•ã€‚ è¿™å¼ è¡¨æˆ‘æ’å…¥äº†ä¸€ç™¾ä¸‡æ•°æ®ï¼Œç”¨æ¥åšå®éªŒã€‚ 1.è®¿é—®æ–¹æ³•å¯¹äºå•ä¸ªè¡¨çš„æŸ¥è¯¢æ¥è¯´ï¼ŒMySQLæŠŠæŸ¥è¯¢çš„æ‰§è¡Œæ–¹å¼å¤§è‡´åˆ†ä¸ºä¸‹è¾¹ä¸¤ç§ï¼š ä½¿ç”¨å…¨è¡¨æ‰«æè¿›è¡ŒæŸ¥è¯¢è¿™ç§æ‰§è¡Œæ–¹å¼å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æŠŠè¡¨çš„æ¯ä¸€è¡Œè®°å½•éƒ½æ‰«ä¸€éå˜›ï¼ŒæŠŠç¬¦åˆæœç´¢æ¡ä»¶çš„è®°å½•åŠ å…¥åˆ°ç»“æœé›†å°±å®Œäº†ã€‚ä¸ç®¡æ˜¯å•¥æŸ¥è¯¢éƒ½å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼æ‰§è¡Œï¼Œå½“ç„¶ï¼Œè¿™ç§ä¹Ÿæ˜¯æœ€ç¬¨çš„æ‰§è¡Œæ–¹å¼ã€‚ ä½¿ç”¨ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢å› ä¸ºç›´æ¥ä½¿ç”¨å…¨è¡¨æ‰«æçš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢è¦éå†å¥½å¤šè®°å½•ï¼Œæ‰€ä»¥ä»£ä»·å¯èƒ½å¤ªå¤§äº†ã€‚å¦‚æœæŸ¥è¯¢è¯­å¥ä¸­çš„æœç´¢æ¡ä»¶å¯ä»¥ä½¿ç”¨åˆ°æŸä¸ªç´¢å¼•ï¼Œé‚£ç›´æ¥ä½¿ç”¨ç´¢å¼•æ¥æ‰§è¡ŒæŸ¥è¯¢å¯èƒ½ä¼šåŠ å¿«æŸ¥è¯¢æ‰§è¡Œçš„æ—¶é—´ã€‚ä½¿ç”¨ç´¢å¼•æ¥æ‰§è¡ŒæŸ¥è¯¢çš„æ–¹å¼äº”èŠ±å…«é—¨ï¼Œåˆå¯ä»¥ç»†åˆ†ä¸ºè®¸å¤šç§ç±»ï¼š é’ˆå¯¹ä¸»é”®æˆ–å”¯ä¸€äºŒçº§ç´¢å¼•çš„ç­‰å€¼æŸ¥è¯¢ é’ˆå¯¹æ™®é€šäºŒçº§ç´¢å¼•çš„ç­‰å€¼æŸ¥è¯¢ é’ˆå¯¹ç´¢å¼•åˆ—çš„èŒƒå›´æŸ¥è¯¢ ç›´æ¥æ‰«ææ•´ä¸ªç´¢å¼• MySQLæŠŠMySQLæ‰§è¡ŒæŸ¥è¯¢è¯­å¥çš„æ–¹å¼ç§°ä¹‹ä¸ºè®¿é—®æ–¹æ³•æˆ–è€…è®¿é—®ç±»å‹ã€‚åŒä¸€ä¸ªæŸ¥è¯¢è¯­å¥å¯èƒ½å¯ä»¥ä½¿ç”¨å¤šç§ä¸åŒçš„è®¿é—®æ–¹æ³•æ¥æ‰§è¡Œï¼Œè™½ç„¶æœ€åçš„æŸ¥è¯¢ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ—¶é—´å¯èƒ½ç›¸å·®å¾ˆå¤šã€‚ 2.const1SELECT * FROM single_table WHERE id = 1438; MySQLä¼šç›´æ¥åˆ©ç”¨ä¸»é”®å€¼åœ¨èšç°‡ç´¢å¼•ä¸­å®šä½å¯¹åº”çš„ç”¨æˆ·è®°å½•ã€‚ **B+**æ ‘å¶å­èŠ‚ç‚¹ä¸­çš„è®°å½•æ˜¯æŒ‰ç…§ç´¢å¼•åˆ—æ’åºçš„ï¼Œå¯¹äºçš„èšç°‡ç´¢å¼•æ¥è¯´ï¼Œå®ƒå¯¹åº”çš„**B+**æ ‘å¶å­èŠ‚ç‚¹ä¸­çš„è®°å½•å°±æ˜¯æŒ‰ç…§**id**åˆ—æ’åºçš„ã€‚æ‰€ä»¥è¿™æ ·æ ¹æ®ä¸»é”®å€¼å®šä½ä¸€æ¡è®°å½•çš„é€Ÿåº¦è´¼å¿«ã€‚ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬æ ¹æ®å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—æ¥å®šä½ä¸€æ¡è®°å½•çš„é€Ÿåº¦ä¹Ÿæ˜¯è´¼å¿«çš„ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š 1SELECT * FROM single_table WHERE key2 = 3841; è¿™ä¸ªæŸ¥è¯¢çš„æ‰§è¡Œè¿‡ç¨‹çš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š è¿™ä¸ªæŸ¥è¯¢çš„æ‰§è¡Œåˆ†ä¸¤æ­¥ï¼š å…ˆä»idx_key2å¯¹åº”çš„B+æ ‘ç´¢å¼•ä¸­æ ¹æ®key2åˆ—ä¸å¸¸æ•°çš„ç­‰å€¼æ¯”è¾ƒæ¡ä»¶å®šä½åˆ°ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½• å†æ ¹æ®è¯¥è®°å½•çš„idå€¼åˆ°èšç°‡ç´¢å¼•ä¸­è·å–åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½• MySQLè®¤ä¸ºé€šè¿‡ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—ä¸å¸¸æ•°çš„ç­‰å€¼æ¯”è¾ƒæ¥å®šä½ä¸€æ¡è®°å½•éå¸¸å¿«ï¼Œæ‰€ä»¥ä»–ä»¬æŠŠè¿™ç§é€šè¿‡ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—æ¥å®šä½ä¸€æ¡è®°å½•çš„è®¿é—®æ–¹æ³•å®šä¹‰ä¸ºï¼šconstï¼Œæ„æ€æ˜¯å¸¸æ•°çº§åˆ«çš„ï¼Œä»£ä»·æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ã€‚ä¸è¿‡è¿™ç§constè®¿é—®æ–¹æ³•åªèƒ½åœ¨ä¸»é”®åˆ—æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—å’Œä¸€ä¸ªå¸¸æ•°è¿›è¡Œç­‰å€¼æ¯”è¾ƒæ—¶æ‰æœ‰æ•ˆï¼Œå¦‚æœä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•æ˜¯ç”±å¤šä¸ªåˆ—æ„æˆçš„è¯ï¼Œç´¢å¼•ä¸­çš„æ¯ä¸€ä¸ªåˆ—éƒ½éœ€è¦ä¸å¸¸æ•°è¿›è¡Œç­‰å€¼æ¯”è¾ƒï¼Œè¿™ä¸ªconstè®¿é—®æ–¹æ³•æ‰æœ‰æ•ˆï¼ˆè¿™æ˜¯å› ä¸ºåªæœ‰è¯¥ç´¢å¼•ä¸­å…¨éƒ¨åˆ—éƒ½é‡‡ç”¨ç­‰å€¼æ¯”è¾ƒæ‰å¯ä»¥å®šä½å”¯ä¸€çš„ä¸€æ¡è®°å½•ï¼‰ã€‚ å¯¹äºå”¯ä¸€äºŒçº§ç´¢å¼•æ¥è¯´ï¼ŒæŸ¥è¯¢è¯¥åˆ—ä¸ºNULLå€¼çš„æƒ…å†µæ¯”è¾ƒç‰¹æ®Šï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1SELECT * FROM single_table WHERE key2 IS NULL; å› ä¸ºå”¯ä¸€äºŒçº§ç´¢å¼•åˆ—å¹¶ä¸é™åˆ¶ NULL å€¼çš„æ•°é‡ï¼Œæ‰€ä»¥ä¸Šè¿°è¯­å¥å¯èƒ½è®¿é—®åˆ°å¤šæ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯è¯´ ä¸Šè¾¹è¿™ä¸ªè¯­å¥ä¸å¯ä»¥ä½¿ç”¨constè®¿é—®æ–¹æ³•æ¥æ‰§è¡Œã€‚ 3.refæœ‰æ—¶å€™æˆ‘ä»¬å¯¹æŸä¸ªæ™®é€šçš„äºŒçº§ç´¢å¼•åˆ—ä¸å¸¸æ•°è¿›è¡Œç­‰å€¼æ¯”è¾ƒï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1SELECT * FROM single_table WHERE key1 = &#x27;abc&#x27;; å¯¹äºè¿™ä¸ªæŸ¥è¯¢ï¼Œæˆ‘ä»¬å½“ç„¶å¯ä»¥é€‰æ‹©å…¨è¡¨æ‰«ææ¥é€ä¸€å¯¹æ¯”æœç´¢æ¡ä»¶æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å…ˆä½¿ç”¨äºŒçº§ç´¢å¼•æ‰¾åˆ°å¯¹åº”è®°å½•çš„idå€¼ï¼Œç„¶åå†å›è¡¨åˆ°èšç°‡ç´¢å¼•ä¸­æŸ¥æ‰¾å®Œæ•´çš„ç”¨æˆ·è®°å½•ã€‚ç”±äºæ™®é€šäºŒçº§ç´¢å¼•å¹¶ä¸é™åˆ¶ç´¢å¼•åˆ—å€¼çš„å”¯ä¸€æ€§ï¼Œæ‰€ä»¥å¯èƒ½æ‰¾åˆ°å¤šæ¡å¯¹åº”çš„è®°å½•ï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨äºŒçº§ç´¢å¼•æ¥æ‰§è¡ŒæŸ¥è¯¢çš„ä»£ä»·å–å†³äºç­‰å€¼åŒ¹é…åˆ°çš„äºŒçº§ç´¢å¼•è®°å½•æ¡æ•°ã€‚å¦‚æœåŒ¹é…çš„è®°å½•è¾ƒå°‘ï¼Œåˆ™å›è¡¨çš„ä»£ä»·è¿˜æ˜¯æ¯”è¾ƒä½çš„ï¼Œæ‰€ä»¥MySQLå¯èƒ½é€‰æ‹©ä½¿ç”¨ç´¢å¼•è€Œä¸æ˜¯å…¨è¡¨æ‰«æçš„æ–¹å¼æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚MySQLæŠŠè¿™ç§æœç´¢æ¡ä»¶ä¸ºäºŒçº§ç´¢å¼•åˆ—ä¸å¸¸æ•°ç­‰å€¼æ¯”è¾ƒï¼Œé‡‡ç”¨äºŒçº§ç´¢å¼•æ¥æ‰§è¡ŒæŸ¥è¯¢çš„è®¿é—®æ–¹æ³•ç§°ä¸ºï¼šrefã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹é‡‡ç”¨refè®¿é—®æ–¹æ³•æ‰§è¡ŒæŸ¥è¯¢çš„å›¾ç¤ºï¼š å¯¹äºæ™®é€šçš„äºŒçº§ç´¢å¼•æ¥è¯´ï¼Œé€šè¿‡ç´¢å¼•åˆ—è¿›è¡Œç­‰å€¼æ¯”è¾ƒåå¯èƒ½åŒ¹é…åˆ°å¤šæ¡è¿ç»­çš„è®°å½•ï¼Œè€Œä¸æ˜¯åƒä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•é‚£æ ·æœ€å¤šåªèƒ½åŒ¹é…1æ¡è®°å½•ï¼Œæ‰€ä»¥è¿™ç§refè®¿é—®æ–¹æ³•æ¯”constå·®äº†é‚£ä¹ˆä¸€ç‚¹ï¼Œä½†æ˜¯åœ¨äºŒçº§ç´¢å¼•ç­‰å€¼æ¯”è¾ƒæ—¶åŒ¹é…çš„è®°å½•æ•°è¾ƒå°‘æ—¶çš„æ•ˆç‡è¿˜æ˜¯å¾ˆé«˜çš„ï¼ˆå¦‚æœåŒ¹é…çš„äºŒçº§ç´¢å¼•è®°å½•å¤ªå¤šé‚£ä¹ˆå›è¡¨çš„æˆæœ¬å°±å¤ªå¤§äº†ï¼‰ã€‚ æœ‰ä¸¤ç§ç‰¹æ®Šæƒ…å†µï¼š äºŒçº§ç´¢å¼•åˆ—å€¼ä¸ºNULLçš„æƒ…å†µä¸è®ºæ˜¯æ™®é€šçš„äºŒçº§ç´¢å¼•ï¼Œè¿˜æ˜¯å”¯ä¸€äºŒçº§ç´¢å¼•ï¼Œå®ƒä»¬çš„ç´¢å¼•åˆ—å¯¹åŒ…å«NULLå€¼çš„æ•°é‡å¹¶ä¸é™åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨key IS NULLè¿™ç§å½¢å¼çš„æœç´¢æ¡ä»¶æœ€å¤šåªèƒ½ä½¿ç”¨refçš„è®¿é—®æ–¹æ³•ï¼Œè€Œä¸æ˜¯constçš„è®¿é—®æ–¹æ³•ã€‚ å¯¹äºæŸä¸ªåŒ…å«å¤šä¸ªç´¢å¼•åˆ—çš„äºŒçº§ç´¢å¼•æ¥è¯´ï¼Œåªè¦æ˜¯æœ€å·¦è¾¹çš„è¿ç»­ç´¢å¼•åˆ—æ˜¯ä¸å¸¸æ•°çš„ç­‰å€¼æ¯”è¾ƒå°±å¯èƒ½é‡‡ç”¨refçš„è®¿é—®æ–¹æ³•ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™å‡ ä¸ªæŸ¥è¯¢ï¼š 12345SELECT * FROM single_table WHERE key_part1 = &#x27;god like&#x27;;SELECT * FROM single_table WHERE key_part1 = &#x27;god like&#x27; AND key_part2 = &#x27;legendary&#x27;;SELECT * FROM single_table WHERE key_part1 = &#x27;god like&#x27; AND key_part2 = &#x27;legendary&#x27; AND key_part3 = &#x27;penta kill&#x27;; ä½†æ˜¯å¦‚æœæœ€å·¦è¾¹çš„è¿ç»­ç´¢å¼•åˆ—å¹¶ä¸å…¨éƒ¨æ˜¯ç­‰å€¼æ¯”è¾ƒçš„è¯ï¼Œå®ƒçš„è®¿é—®æ–¹æ³•å°±ä¸èƒ½ç§°ä¸ºrefäº†ï¼Œæ¯”æ–¹è¯´è¿™æ ·ï¼š 1SELECT * FROM single_table WHERE key_part1 = &#x27;god like&#x27; AND key_part2 &gt; &#x27;legendary&#x27;; 4.ref_or_nullæœ‰æ—¶å€™æˆ‘ä»¬ä¸ä»…æƒ³æ‰¾å‡ºæŸä¸ªäºŒçº§ç´¢å¼•åˆ—çš„å€¼ç­‰äºæŸä¸ªå¸¸æ•°çš„è®°å½•ï¼Œè¿˜æƒ³æŠŠè¯¥åˆ—çš„å€¼ä¸ºNULLçš„è®°å½•ä¹Ÿæ‰¾å‡ºæ¥ï¼Œå°±åƒä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š 1SELECT * FROM single_table WHERE key1 = &#x27;abc&#x27; OR key1 IS NULL; å½“ä½¿ç”¨äºŒçº§ç´¢å¼•è€Œä¸æ˜¯å…¨è¡¨æ‰«æçš„æ–¹å¼æ‰§è¡Œè¯¥æŸ¥è¯¢æ—¶ï¼Œè¿™ç§ç±»å‹çš„æŸ¥è¯¢ä½¿ç”¨çš„è®¿é—®æ–¹æ³•å°±ç§°ä¸ºref_or_nullï¼Œè¿™ä¸ªref_or_nullè®¿é—®æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š ä¸Šè¾¹çš„æŸ¥è¯¢ç›¸å½“äºå…ˆåˆ†åˆ«ä»idx_key1ç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­æ‰¾å‡ºkey1 IS NULLå’Œkey1 = &#39;abc&#39;çš„ä¸¤ä¸ªè¿ç»­çš„è®°å½•èŒƒå›´ï¼Œç„¶åæ ¹æ®è¿™äº›äºŒçº§ç´¢å¼•è®°å½•ä¸­çš„idå€¼å†å›è¡¨æŸ¥æ‰¾å®Œæ•´çš„ç”¨æˆ·è®°å½•ã€‚ 5.range1SELECT * FROM single_table WHERE key2 IN (1438, 6328) OR (key2 &gt;= 38 AND key2 &lt;= 79); å¦‚æœé‡‡ç”¨äºŒçº§ç´¢å¼• + å›è¡¨çš„æ–¹å¼æ¥æ‰§è¡Œçš„è¯ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„æœç´¢æ¡ä»¶å°±ä¸åªæ˜¯è¦æ±‚ç´¢å¼•åˆ—ä¸å¸¸æ•°çš„ç­‰å€¼åŒ¹é…äº†ï¼Œè€Œæ˜¯ç´¢å¼•åˆ—éœ€è¦åŒ¹é…æŸä¸ªæˆ–æŸäº›èŒƒå›´çš„å€¼ï¼Œåœ¨æœ¬æŸ¥è¯¢ä¸­key2åˆ—çš„å€¼åªè¦åŒ¹é…ä¸‹åˆ—3ä¸ªèŒƒå›´ä¸­çš„ä»»ä½•ä¸€ä¸ªå°±ç®—æ˜¯åŒ¹é…æˆåŠŸäº†ï¼š key2çš„å€¼æ˜¯1438 key2çš„å€¼æ˜¯6328 key2çš„å€¼åœ¨38å’Œ79ä¹‹é—´ã€‚ MySQLæŠŠè¿™ç§åˆ©ç”¨ç´¢å¼•è¿›è¡ŒèŒƒå›´åŒ¹é…çš„è®¿é—®æ–¹æ³•ç§°ä¹‹ä¸ºï¼šrangeã€‚ æ­¤å¤„æ‰€è¯´çš„ä½¿ç”¨ç´¢å¼•è¿›è¡ŒèŒƒå›´åŒ¹é…ä¸­çš„ ç´¢å¼• å¯ä»¥æ˜¯èšç°‡ç´¢å¼•ï¼Œä¹Ÿå¯ä»¥æ˜¯äºŒçº§ç´¢å¼•ã€‚ æˆ‘ä»¬å¯ä»¥æŠŠé‚£ç§ç´¢å¼•åˆ—ç­‰å€¼åŒ¹é…çš„æƒ…å†µç§°ä¹‹ä¸ºå•ç‚¹åŒºé—´ï¼Œä¸Šè¾¹æ‰€è¯´çš„èŒƒå›´1å’ŒèŒƒå›´2éƒ½å¯ä»¥è¢«ç§°ä¸ºå•ç‚¹åŒºé—´ï¼ŒåƒèŒƒå›´3è¿™ç§çš„æˆ‘ä»¬å¯ä»¥ç§°ä¸ºè¿ç»­èŒƒå›´åŒºé—´ã€‚ 6.index1SELECT key_part1, key_part2, key_part3 FROM single_table WHERE key_part2 = &#x27;abc&#x27;; ç”±äºkey_part2å¹¶ä¸æ˜¯è”åˆç´¢å¼•idx_key_partæœ€å·¦ç´¢å¼•åˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ä½¿ç”¨refæˆ–è€…rangeè®¿é—®æ–¹æ³•æ¥æ‰§è¡Œè¿™ä¸ªè¯­å¥ã€‚ä½†æ˜¯è¿™ä¸ªæŸ¥è¯¢ç¬¦åˆä¸‹è¾¹è¿™ä¸¤ä¸ªæ¡ä»¶ï¼š å®ƒçš„æŸ¥è¯¢åˆ—è¡¨åªæœ‰3ä¸ªåˆ—ï¼škey_part1, key_part2, key_part3ï¼Œè€Œç´¢å¼•idx_key_partåˆåŒ…å«è¿™ä¸‰ä¸ªåˆ—ã€‚ æœç´¢æ¡ä»¶ä¸­åªæœ‰key_part2åˆ—ã€‚è¿™ä¸ªåˆ—ä¹ŸåŒ…å«åœ¨ç´¢å¼•idx_key_partä¸­ã€‚ ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡éå†idx_key_partç´¢å¼•çš„å¶å­èŠ‚ç‚¹çš„è®°å½•æ¥æ¯”è¾ƒkey_part2 = &#39;abc&#39;è¿™ä¸ªæ¡ä»¶æ˜¯å¦æˆç«‹ï¼ŒæŠŠåŒ¹é…æˆåŠŸçš„äºŒçº§ç´¢å¼•è®°å½•çš„key_part1, key_part2, key_part3åˆ—çš„å€¼ç›´æ¥åŠ åˆ°ç»“æœé›†ä¸­å°±è¡Œäº†ã€‚ç”±äºäºŒçº§ç´¢å¼•è®°å½•æ¯”èšç°‡ç´¢è®°å½•å°çš„å¤šï¼ˆèšç°‡ç´¢å¼•è®°å½•è¦å­˜å‚¨æ‰€æœ‰ç”¨æˆ·å®šä¹‰çš„åˆ—ä»¥åŠæ‰€è°“çš„éšè—åˆ—ï¼Œè€ŒäºŒçº§ç´¢å¼•è®°å½•åªéœ€è¦å­˜æ”¾ç´¢å¼•åˆ—å’Œä¸»é”®ï¼‰ï¼Œè€Œä¸”è¿™ä¸ªè¿‡ç¨‹ä¹Ÿä¸ç”¨è¿›è¡Œå›è¡¨æ“ä½œï¼Œæ‰€ä»¥ç›´æ¥éå†äºŒçº§ç´¢å¼•æ¯”ç›´æ¥éå†èšç°‡ç´¢å¼•çš„æˆæœ¬è¦å°å¾ˆå¤šï¼ŒMySQLå°±æŠŠè¿™ç§é‡‡ç”¨éå†äºŒçº§ç´¢å¼•è®°å½•çš„æ‰§è¡Œæ–¹å¼ç§°ä¹‹ä¸ºï¼šindexã€‚ 7.allå…¨è¡¨æ‰«æ 8.æ³¨æ„8.1 äºŒçº§ç´¢å¼• + å›è¡¨ä¸€èˆ¬æƒ…å†µä¸‹åªèƒ½åˆ©ç”¨å•ä¸ªäºŒçº§ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹çš„è¿™ä¸ªæŸ¥è¯¢ï¼š 1SELECT * FROM single_table WHERE key1 = &#x27;abc&#x27; AND key2 &gt; 1000; æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šè¯†åˆ«åˆ°è¿™ä¸ªæŸ¥è¯¢ä¸­çš„ä¸¤ä¸ªæœç´¢æ¡ä»¶ï¼š key1 = &#39;abc&#39; key2 &gt; 1000 ä¼˜åŒ–å™¨ä¸€èˆ¬ä¼šæ ¹æ®single_tableè¡¨çš„ç»Ÿè®¡æ•°æ®æ¥åˆ¤æ–­åˆ°åº•ä½¿ç”¨å“ªä¸ªæ¡ä»¶åˆ°å¯¹åº”çš„äºŒçº§ç´¢å¼•ä¸­æŸ¥è¯¢æ‰«æçš„è¡Œæ•°ä¼šæ›´å°‘ï¼Œé€‰æ‹©é‚£ä¸ªæ‰«æè¡Œæ•°è¾ƒå°‘çš„æ¡ä»¶åˆ°å¯¹åº”çš„äºŒçº§ç´¢å¼•ä¸­æŸ¥è¯¢ã€‚ç„¶åå°†ä»è¯¥äºŒçº§ç´¢å¼•ä¸­æŸ¥è¯¢åˆ°çš„ç»“æœç»è¿‡å›è¡¨å¾—åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•åå†æ ¹æ®å…¶ä½™çš„WHEREæ¡ä»¶è¿‡æ»¤è®°å½•ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç­‰å€¼æŸ¥æ‰¾æ¯”èŒƒå›´æŸ¥æ‰¾éœ€è¦æ‰«æçš„è¡Œæ•°æ›´å°‘ï¼ˆä¹Ÿå°±æ˜¯refçš„è®¿é—®æ–¹æ³•ä¸€èˆ¬æ¯”rangeå¥½ï¼Œä½†è¿™ä¹Ÿä¸æ€»æ˜¯ä¸€å®šçš„ï¼Œä¹Ÿå¯èƒ½é‡‡ç”¨refè®¿é—®æ–¹æ³•çš„é‚£ä¸ªç´¢å¼•åˆ—çš„å€¼ä¸ºç‰¹å®šå€¼çš„è¡Œæ•°ç‰¹åˆ«å¤šï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œå‡è®¾ä¼˜åŒ–å™¨å†³å®šä½¿ç”¨idx_key1ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ï¼Œé‚£ä¹ˆæ•´ä¸ªæŸ¥è¯¢è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š ä½¿ç”¨äºŒçº§ç´¢å¼•å®šä½è®°å½•çš„é˜¶æ®µï¼Œä¹Ÿå°±æ˜¯æ ¹æ®æ¡ä»¶key1 = &#39;abc&#39;ä»idx_key1ç´¢å¼•ä»£è¡¨çš„B+æ ‘ä¸­æ‰¾åˆ°å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•ã€‚ å›è¡¨é˜¶æ®µï¼Œä¹Ÿå°±æ˜¯æ ¹æ®ä¸Šä¸€æ­¥éª¤ä¸­æ‰¾åˆ°çš„è®°å½•çš„ä¸»é”®å€¼è¿›è¡Œå›è¡¨æ“ä½œï¼Œä¹Ÿå°±æ˜¯åˆ°èšç°‡ç´¢å¼•ä¸­æ‰¾åˆ°å¯¹åº”çš„å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œå†æ ¹æ®æ¡ä»¶key2 &gt; 1000åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•ç»§ç»­è¿‡æ»¤ã€‚å°†æœ€ç»ˆç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„è®°å½•è¿”å›ç»™ç”¨æˆ·ã€‚ æ³¨æ„ï¼Œå› ä¸ºäºŒçº§ç´¢å¼•çš„èŠ‚ç‚¹ä¸­çš„è®°å½•åªåŒ…å«ç´¢å¼•åˆ—å’Œä¸»é”®ï¼Œæ‰€ä»¥åœ¨æ­¥éª¤1ä¸­ä½¿ç”¨idx_key1ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢æ—¶åªä¼šç”¨åˆ°ä¸key1åˆ—æœ‰å…³çš„æœç´¢æ¡ä»¶ï¼Œå…¶ä½™æ¡ä»¶ï¼Œæ¯”å¦‚key2 &gt; 1000è¿™ä¸ªæ¡ä»¶åœ¨æ­¥éª¤1ä¸­æ˜¯ç”¨ä¸åˆ°çš„ï¼Œåªæœ‰åœ¨æ­¥éª¤2å®Œæˆå›è¡¨æ“ä½œåæ‰èƒ½ç»§ç»­é’ˆå¯¹å®Œæ•´çš„ç”¨æˆ·è®°å½•ä¸­ç»§ç»­è¿‡æ»¤ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢åªä¼šç”¨åˆ°å•ä¸ªäºŒçº§ç´¢å¼•ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰ç‰¹æ®Šæƒ…å†µçš„ã€‚ ä»ä¸Šæ–‡å¯ä»¥çœ‹å‡ºï¼Œæ¯æ¬¡ä»äºŒçº§ç´¢å¼•ä¸­è¯»å–åˆ°ä¸€æ¡è®°å½•åï¼Œå°±ä¼šæ ¹æ®è¯¥è®°å½•çš„ä¸»é”®å€¼æ‰§è¡Œå›è¡¨æ“ä½œã€‚è€Œåœ¨æŸä¸ªæ‰«æåŒºé—´ä¸­çš„äºŒçº§ç´¢å¼•è®°å½•çš„ä¸»é”®å€¼æ˜¯æ— åºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›äºŒçº§ç´¢å¼•è®°å½•å¯¹åº”çš„èšç°‡ç´¢å¼•è®°å½•æ‰€åœ¨çš„é¡µé¢çš„é¡µå·æ˜¯æ— åºçš„ã€‚æ¯æ¬¡æ‰§è¡Œå›è¡¨æ“ä½œæ—¶éƒ½ç›¸å½“äºè¦éšæœºè¯»å–ä¸€ä¸ªèšç°‡ç´¢å¼•é¡µé¢ï¼Œè€Œè¿™äº›éšæœºI/Oå¸¦æ¥çš„æ€§èƒ½å¼€é”€æ¯”è¾ƒå¤§ã€‚äºæ˜¯MySQLæå‡ºäº†ä¸€ä¸ªåä¸ºDisk-S weep Multi-Range Read(MRRï¼Œå¤šèŒƒå›´è¯»å–)çš„ä¼˜åŒ–æªæ–½ï¼Œå³å…ˆè¯»å–ä¸€éƒ¨åˆ†äºŒçº§ç´¢å¼•è®°å½•ï¼Œå°†å®ƒä»¬çš„ä¸»é”®å€¼æ’å¥½åºä¹‹åå†ç»Ÿä¸€æ‰§è¡Œå›è¡¨æ“ä½œã€‚ç›¸å¯¹äºæ¯è¯»å–ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½• å°±ç«‹å³æ‰§è¡Œå›è¡¨æ“ä½œï¼Œè¿™æ ·ä¼šèŠ‚çœä¸€äº›I/0å¼€é”€ã€‚å½“ç„¶ä½¿ç”¨è¿™ä¸ªMRRä¼˜åŒ–æªæ–½çš„æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œæˆ‘ä»¬ä¹‹å‰çš„è®¨è®ºä¸­æ²¡æœ‰æ¶‰åŠMRR ä¹‹åçš„è®¨è®ºä¸­ä¹Ÿå°†å¿½ç•¥è¿™é¡¹ä¼˜åŒ–æªæ–½ï¼Œç›´æ¥è®¤ä¸ºæ¯è¯»å–ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•å°±ç«‹å³æ‰§è¡Œå›è¡¨æ“ä½œã€‚ 8.2 rangeè®¿é—®æ–¹æ³•ä½¿ç”¨çš„èŒƒå›´åŒºé—´å…¶å®å¯¹äºB+æ ‘ç´¢å¼•æ¥è¯´ï¼Œåªè¦ç´¢å¼•åˆ—å’Œå¸¸æ•°ä½¿ç”¨=ã€&lt;=&gt;ã€INã€NOT INã€IS NULLã€IS NOT NULLã€&gt;ã€&lt;ã€&gt;=ã€&lt;=ã€BETWEENã€!=ï¼ˆä¸ç­‰äºä¹Ÿå¯ä»¥å†™æˆ&lt;&gt;ï¼‰æˆ–è€…LIKEæ“ä½œç¬¦è¿æ¥èµ·æ¥ï¼Œå°±å¯ä»¥äº§ç”Ÿä¸€ä¸ªæ‰€è°“çš„åŒºé—´ã€‚ LIKEæ“ä½œç¬¦æ¯”è¾ƒç‰¹æ®Šï¼Œåªæœ‰åœ¨åŒ¹é…å®Œæ•´å­—ç¬¦ä¸²æˆ–è€…åŒ¹é…å­—ç¬¦ä¸²å‰ç¼€æ—¶æ‰å¯ä»¥åˆ©ç”¨ç´¢å¼•ã€‚ INæ“ä½œç¬¦çš„æ•ˆæœå’Œè‹¥å¹²ä¸ªç­‰å€¼åŒ¹é…æ“ä½œç¬¦=ä¹‹é—´ç”¨ORè¿æ¥èµ·æ¥æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šäº§ç”Ÿå¤šä¸ªå•ç‚¹åŒºé—´ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸¤ä¸ªè¯­å¥çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼š 123SELECT * FROM single_table WHERE key2 IN (1438, 6328); SELECT * FROM single_table WHERE key2 = 1438 OR key2 = 6328; åœ¨æ—¥å¸¸çš„å·¥ä½œä¸­ï¼Œä¸€ä¸ªæŸ¥è¯¢çš„WHEREå­å¥å¯èƒ½æœ‰å¾ˆå¤šä¸ªå°çš„æœç´¢æ¡ä»¶ï¼Œè¿™äº›æœç´¢æ¡ä»¶éœ€è¦ä½¿ç”¨ANDæˆ–è€…ORæ“ä½œç¬¦è¿æ¥èµ·æ¥ã€‚å½“æˆ‘ä»¬æƒ³ä½¿ç”¨rangeè®¿é—®æ–¹æ³•æ¥æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢è¯­å¥æ—¶ï¼Œé‡ç‚¹å°±æ˜¯æ‰¾å‡ºè¯¥æŸ¥è¯¢å¯ç”¨çš„ç´¢å¼•ä»¥åŠè¿™äº›ç´¢å¼•å¯¹åº”çš„èŒƒå›´åŒºé—´ã€‚ 9.ç´¢å¼•åˆå¹¶MySQLåœ¨ä¸€èˆ¬æƒ…å†µä¸‹æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢æ—¶æœ€å¤šåªä¼šç”¨åˆ°å•ä¸ªäºŒçº§ç´¢å¼•ï¼Œä½†æ˜¯è¿˜æœ‰ç‰¹æ®Šæƒ…å†µï¼Œåœ¨è¿™äº›ç‰¹æ®Šæƒ…å†µä¸‹ä¹Ÿå¯èƒ½åœ¨ä¸€ä¸ªæŸ¥è¯¢ä¸­ä½¿ç”¨åˆ°å¤šä¸ªäºŒçº§ç´¢å¼•ï¼ŒMySQLæŠŠè¿™ç§ä½¿ç”¨åˆ°å¤šä¸ªç´¢å¼•æ¥å®Œæˆä¸€æ¬¡æŸ¥è¯¢çš„æ‰§è¡Œæ–¹æ³•ç§°ä¹‹ä¸ºï¼šindex mergeï¼Œå…·ä½“çš„ç´¢å¼•åˆå¹¶ç®—æ³•æœ‰ä¸‹è¾¹ä¸‰ç§ã€‚ 9.1 Intersectionåˆå¹¶Intersectionç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯äº¤é›†ã€‚è¿™é‡Œæ˜¯è¯´æŸä¸ªæŸ¥è¯¢å¯ä»¥ä½¿ç”¨å¤šä¸ªäºŒçº§ç´¢å¼•ï¼Œå°†ä»å¤šä¸ªäºŒçº§ç´¢å¼•ä¸­æŸ¥è¯¢åˆ°çš„ç»“æœå–äº¤é›†ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š 1SELECT * FROM single_table WHERE key1 = &#x27;a&#x27; AND key3 = &#x27;b&#x27;; å‡è®¾è¿™ä¸ªæŸ¥è¯¢ä½¿ç”¨Intersectionåˆå¹¶çš„æ–¹å¼æ‰§è¡Œçš„è¯ï¼Œé‚£è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯è¿™æ ·çš„ï¼š ä»idx_key1äºŒçº§ç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­å–å‡ºkey1 = &#39;a&#39;çš„ç›¸å…³è®°å½•ã€‚ ä»idx_key3äºŒçº§ç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­å–å‡ºkey3 = &#39;b&#39;çš„ç›¸å…³è®°å½•ã€‚ äºŒçº§ç´¢å¼•çš„è®°å½•éƒ½æ˜¯ç”±ç´¢å¼•åˆ— + ä¸»é”®æ„æˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºè¿™ä¸¤ä¸ªç»“æœé›†ä¸­idå€¼çš„äº¤é›†ã€‚ æŒ‰ç…§ä¸Šä¸€æ­¥ç”Ÿæˆçš„idå€¼åˆ—è¡¨è¿›è¡Œå›è¡¨æ“ä½œï¼Œä¹Ÿå°±æ˜¯ä»èšç°‡ç´¢å¼•ä¸­æŠŠæŒ‡å®šidå€¼çš„å®Œæ•´ç”¨æˆ·è®°å½•å–å‡ºæ¥ï¼Œè¿”å›ç»™ç”¨æˆ·ã€‚ ä¸ºå•¥ä¸ç›´æ¥ä½¿ç”¨idx_key1æˆ–è€…idx_key3åªæ ¹æ®æŸä¸ªæœç´¢æ¡ä»¶å»è¯»å–ä¸€ä¸ªäºŒçº§ç´¢å¼•ï¼Œç„¶åå›è¡¨åå†è¿‡æ»¤å¦å¤–ä¸€ä¸ªæœç´¢æ¡ä»¶å‘¢ï¼Ÿè¿™é‡Œè¦åˆ†æä¸€ä¸‹ä¸¤ç§æŸ¥è¯¢æ‰§è¡Œæ–¹å¼ä¹‹é—´éœ€è¦çš„æˆæœ¬ä»£ä»·ã€‚ åªè¯»å–ä¸€ä¸ªäºŒçº§ç´¢å¼•çš„æˆæœ¬ï¼š æŒ‰ç…§æŸä¸ªæœç´¢æ¡ä»¶è¯»å–ä¸€ä¸ªäºŒçº§ç´¢å¼• æ ¹æ®ä»è¯¥äºŒçº§ç´¢å¼•å¾—åˆ°çš„ä¸»é”®å€¼è¿›è¡Œå›è¡¨æ“ä½œï¼Œç„¶åå†è¿‡æ»¤å…¶ä»–çš„æœç´¢æ¡ä»¶ è¯»å–å¤šä¸ªäºŒçº§ç´¢å¼•ä¹‹åå–äº¤é›†æˆæœ¬ï¼š æŒ‰ç…§ä¸åŒçš„æœç´¢æ¡ä»¶åˆ†åˆ«è¯»å–ä¸åŒçš„äºŒçº§ç´¢å¼• å°†ä»å¤šä¸ªäºŒçº§ç´¢å¼•å¾—åˆ°çš„ä¸»é”®å€¼å–äº¤é›†ï¼Œç„¶åè¿›è¡Œå›è¡¨æ“ä½œ è™½ç„¶è¯»å–å¤šä¸ªäºŒçº§ç´¢å¼•æ¯”è¯»å–ä¸€ä¸ªäºŒçº§ç´¢å¼•æ¶ˆè€—æ€§èƒ½ï¼Œä½†æ˜¯è¯»å–äºŒçº§ç´¢å¼•çš„æ“ä½œæ˜¯é¡ºåºI/Oï¼Œè€Œå›è¡¨æ“ä½œæ˜¯éšæœºI/Oï¼Œæ‰€ä»¥å¦‚æœåªè¯»å–ä¸€ä¸ªäºŒçº§ç´¢å¼•æ—¶éœ€è¦å›è¡¨çš„è®°å½•æ•°ç‰¹åˆ«å¤šï¼Œè€Œè¯»å–å¤šä¸ªäºŒçº§ç´¢å¼•ä¹‹åå–äº¤é›†çš„è®°å½•æ•°éå¸¸å°‘ï¼Œå½“èŠ‚çœçš„å› ä¸ºå›è¡¨è€Œé€ æˆçš„æ€§èƒ½æŸè€—æ¯”è®¿é—®å¤šä¸ªäºŒçº§ç´¢å¼•å¸¦æ¥çš„æ€§èƒ½æŸè€—æ›´é«˜æ—¶ï¼Œè¯»å–å¤šä¸ªäºŒçº§ç´¢å¼•åå–äº¤é›†æ¯”åªè¯»å–ä¸€ä¸ªäºŒçº§ç´¢å¼•çš„æˆæœ¬æ›´ä½ã€‚ MySQLåœ¨æŸäº›ç‰¹å®šçš„æƒ…å†µä¸‹æ‰å¯èƒ½ä¼šä½¿ç”¨åˆ°Intersectionç´¢å¼•åˆå¹¶ï¼š æƒ…å†µä¸€ï¼šäºŒçº§ç´¢å¼•åˆ—æ˜¯ç­‰å€¼åŒ¹é…çš„æƒ…å†µï¼Œå¯¹äºè”åˆç´¢å¼•æ¥è¯´ï¼Œåœ¨è”åˆç´¢å¼•ä¸­çš„æ¯ä¸ªåˆ—éƒ½å¿…é¡»ç­‰å€¼åŒ¹é…ï¼Œä¸èƒ½å‡ºç°åªåŒ¹é…éƒ¨åˆ†åˆ—çš„æƒ…å†µã€‚æ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢å¯èƒ½ç”¨åˆ°idx_key1å’Œidx_key_partè¿™ä¸¤ä¸ªäºŒçº§ç´¢å¼•è¿›è¡ŒIntersectionç´¢å¼•åˆå¹¶çš„æ“ä½œï¼š 1SELECT * FROM single_table WHERE key1 = &#x27;a&#x27; AND key_part1 = &#x27;a&#x27; AND key_part2 = &#x27;b&#x27; AND key_part3 = &#x27;c&#x27;; è€Œä¸‹è¾¹è¿™ä¸¤ä¸ªæŸ¥è¯¢å°±ä¸èƒ½è¿›è¡ŒIntersectionç´¢å¼•åˆå¹¶ï¼š 123SELECT * FROM single_table WHERE key1 &gt; &#x27;a&#x27; AND key_part1 = &#x27;a&#x27; AND key_part2 = &#x27;b&#x27; AND key_part3 = &#x27;c&#x27;;SELECT * FROM single_table WHERE key1 = &#x27;a&#x27; AND key_part1 = &#x27;a&#x27;; ç¬¬ä¸€ä¸ªæŸ¥è¯¢æ˜¯å› ä¸ºå¯¹key1è¿›è¡Œäº†èŒƒå›´åŒ¹é…ï¼Œç¬¬äºŒä¸ªæŸ¥è¯¢æ˜¯å› ä¸ºè”åˆç´¢å¼•idx_key_partä¸­çš„key_part2å’Œkey_part3åˆ—å¹¶æ²¡æœ‰å‡ºç°åœ¨æœç´¢æ¡ä»¶ä¸­ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªæŸ¥è¯¢ä¸èƒ½è¿›è¡ŒIntersectionç´¢å¼•åˆå¹¶ã€‚ æƒ…å†µäºŒï¼šä¸»é”®åˆ—å¯ä»¥æ˜¯èŒƒå›´åŒ¹é…æ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢å¯èƒ½ç”¨åˆ°ä¸»é”®å’Œidx_key1è¿›è¡ŒIntersectionç´¢å¼•åˆå¹¶çš„æ“ä½œï¼š 1SELECT * FROM single_table WHERE id &gt; 100 AND key1 = &#x27;a&#x27;; å¯¹äºInnoDBçš„äºŒçº§ç´¢å¼•æ¥è¯´ï¼Œè®°å½•å…ˆæ˜¯æŒ‰ç…§ç´¢å¼•åˆ—è¿›è¡Œæ’åºï¼Œå¦‚æœè¯¥äºŒçº§ç´¢å¼•æ˜¯ä¸€ä¸ªè”åˆç´¢å¼•ï¼Œé‚£ä¹ˆä¼šæŒ‰ç…§è”åˆç´¢å¼•ä¸­çš„å„ä¸ªåˆ—ä¾æ¬¡æ’åºã€‚è€ŒäºŒçº§ç´¢å¼•çš„ç”¨æˆ·è®°å½•æ˜¯ç”±ç´¢å¼•åˆ— + ä¸»é”®æ„æˆçš„ï¼ŒäºŒçº§ç´¢å¼•åˆ—çš„å€¼ç›¸åŒçš„è®°å½•å¯èƒ½ä¼šæœ‰å¥½å¤šæ¡ï¼Œè¿™äº›ç´¢å¼•åˆ—çš„å€¼ç›¸åŒçš„è®°å½•åˆæ˜¯æŒ‰ç…§ä¸»é”®çš„å€¼è¿›è¡Œæ’åºçš„ã€‚æ‰€ä»¥åœ¨äºŒçº§ç´¢å¼•åˆ—éƒ½æ˜¯ç­‰å€¼åŒ¹é…çš„æƒ…å†µä¸‹æ‰å¯èƒ½ä½¿ç”¨Intersectionç´¢å¼•åˆå¹¶ï¼Œæ˜¯å› ä¸ºåªæœ‰åœ¨è¿™ç§æƒ…å†µä¸‹æ ¹æ®äºŒçº§ç´¢å¼•æŸ¥è¯¢å‡ºçš„ç»“æœé›†æ˜¯æŒ‰ç…§ä¸»é”®å€¼æ’åºçš„ã€‚ æ ¹æ®äºŒçº§ç´¢å¼•æŸ¥è¯¢å‡ºçš„ç»“æœé›†æ˜¯æŒ‰ç…§ä¸»é”®å€¼æ’åºçš„å¯¹ä½¿ç”¨**Intersection**ç´¢å¼•åˆå¹¶çš„å¥½å¤„ï¼ŸIntersectionç´¢å¼•åˆå¹¶ä¼šæŠŠä»å¤šä¸ªäºŒçº§ç´¢å¼•ä¸­æŸ¥è¯¢å‡ºçš„ä¸»é”®å€¼æ±‚äº¤é›†ï¼Œå¦‚æœä»å„ä¸ªäºŒçº§ç´¢å¼•ä¸­æŸ¥è¯¢çš„åˆ°çš„ç»“æœé›†æœ¬èº«å°±æ˜¯å·²ç»æŒ‰ç…§ä¸»é”®æ’å¥½åºçš„ï¼Œé‚£ä¹ˆæ±‚äº¤é›†çš„è¿‡ç¨‹å°±å¾ˆç®€å•ã€‚å‡è®¾æŸä¸ªæŸ¥è¯¢ä½¿ç”¨Intersectionç´¢å¼•åˆå¹¶çš„æ–¹å¼ä»idx_key1å’Œidx_key2è¿™ä¸¤ä¸ªäºŒçº§ç´¢å¼•ä¸­è·å–åˆ°çš„ä¸»é”®å€¼åˆ†åˆ«æ˜¯ï¼š ä»idx_key1ä¸­è·å–åˆ°å·²ç»æ’å¥½åºçš„ä¸»é”®å€¼ï¼š1ã€3ã€5 ä»idx_key2ä¸­è·å–åˆ°å·²ç»æ’å¥½åºçš„ä¸»é”®å€¼ï¼š2ã€3ã€4 é‚£ä¹ˆæ±‚äº¤é›†çš„è¿‡ç¨‹å°±æ˜¯è¿™æ ·ï¼šé€ä¸ªå–å‡ºè¿™ä¸¤ä¸ªç»“æœé›†ä¸­æœ€å°çš„ä¸»é”®å€¼ï¼Œå¦‚æœä¸¤ä¸ªå€¼ç›¸ç­‰ï¼Œåˆ™åŠ å…¥æœ€åçš„äº¤é›†ç»“æœä¸­ï¼Œå¦åˆ™ä¸¢å¼ƒå½“å‰è¾ƒå°çš„ä¸»é”®å€¼ï¼Œå†å–è¯¥ä¸¢å¼ƒçš„ä¸»é”®å€¼æ‰€åœ¨ç»“æœé›†çš„åä¸€ä¸ªä¸»é”®å€¼æ¥æ¯”è¾ƒï¼Œç›´åˆ°æŸä¸ªç»“æœé›†ä¸­çš„ä¸»é”®å€¼ç”¨å®Œäº†ï¼š å…ˆå–å‡ºè¿™ä¸¤ä¸ªç»“æœé›†ä¸­è¾ƒå°çš„ä¸»é”®å€¼åšæ¯”è¾ƒï¼Œå› ä¸º1 &lt; 2ï¼Œæ‰€ä»¥æŠŠidx_key1çš„ç»“æœé›†çš„ä¸»é”®å€¼1ä¸¢å¼ƒï¼Œå–å‡ºåè¾¹çš„3æ¥æ¯”è¾ƒã€‚ å› ä¸º3 &gt; 2ï¼Œæ‰€ä»¥æŠŠidx_key2çš„ç»“æœé›†çš„ä¸»é”®å€¼2ä¸¢å¼ƒï¼Œå–å‡ºåè¾¹çš„3æ¥æ¯”è¾ƒã€‚ å› ä¸º3 = 3ï¼Œæ‰€ä»¥æŠŠ3åŠ å…¥åˆ°æœ€åçš„äº¤é›†ç»“æœä¸­ï¼Œç»§ç»­ä¸¤ä¸ªç»“æœé›†åè¾¹çš„ä¸»é”®å€¼æ¥æ¯”è¾ƒã€‚ åè¾¹çš„ä¸»é”®å€¼ä¹Ÿä¸ç›¸ç­‰ï¼Œæ‰€ä»¥æœ€åçš„äº¤é›†ç»“æœä¸­åªåŒ…å«ä¸»é”®å€¼3ã€‚ è¿™ä¸ªè¿‡ç¨‹å…¶å®å¾ˆå¿«ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯O(n)ï¼Œä½†æ˜¯å¦‚æœä»å„ä¸ªäºŒçº§ç´¢å¼•ä¸­æŸ¥è¯¢å‡ºçš„ç»“æœé›†å¹¶ä¸æ˜¯æŒ‰ç…§ä¸»é”®æ’åºçš„è¯ï¼Œé‚£å°±è¦å…ˆæŠŠç»“æœé›†ä¸­çš„ä¸»é”®å€¼æ’åºå®Œå†æ¥åšä¸Šè¾¹çš„é‚£ä¸ªè¿‡ç¨‹ï¼Œå°±æ¯”è¾ƒè€—æ—¶äº†ã€‚ æŒ‰ç…§æœ‰åºçš„ä¸»é”®å€¼å»å›è¡¨å–è®°å½•æœ‰ä¸ªä¸“æœ‰åè¯å„¿ï¼Œå«ï¼šRowid Ordered Retrievalï¼Œç®€ç§°RORã€‚ å¦å¤–ï¼Œä¸ä»…æ˜¯å¤šä¸ªäºŒçº§ç´¢å¼•ä¹‹é—´å¯ä»¥é‡‡ç”¨Intersectionç´¢å¼•åˆå¹¶ï¼Œç´¢å¼•åˆå¹¶ä¹Ÿå¯ä»¥æœ‰èšç°‡ç´¢å¼•å‚åŠ ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šè¾¹å†™çš„æƒ…å†µäºŒï¼šåœ¨æœç´¢æ¡ä»¶ä¸­æœ‰ä¸»é”®çš„èŒƒå›´åŒ¹é…çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨Intersectionç´¢å¼•åˆå¹¶ç´¢å¼•åˆå¹¶ã€‚ 1SELECT * FROM single_table WHERE key1 = &#x27;a&#x27; AND id &gt; 100; å‡è®¾è¿™ä¸ªæŸ¥è¯¢å¯ä»¥é‡‡ç”¨Intersectionç´¢å¼•åˆå¹¶ï¼Œæˆ‘ä»¬ç†æ‰€å½“ç„¶çš„ä»¥ä¸ºè¿™ä¸ªæŸ¥è¯¢ä¼šåˆ†åˆ«æŒ‰ç…§id &gt; 100è¿™ä¸ªæ¡ä»¶ä»èšç°‡ç´¢å¼•ä¸­è·å–ä¸€äº›è®°å½•ï¼Œåœ¨é€šè¿‡key1 = &#39;a&#39;è¿™ä¸ªæ¡ä»¶ä»idx_key1äºŒçº§ç´¢å¼•ä¸­è·å–ä¸€äº›è®°å½•ï¼Œç„¶åå†æ±‚äº¤é›†ï¼Œå…¶å®è¿™æ ·å°±æŠŠé—®é¢˜å¤æ‚åŒ–äº†ï¼Œæ²¡å¿…è¦ä»èšç°‡ç´¢å¼•ä¸­è·å–ä¸€æ¬¡è®°å½•ã€‚äºŒçº§ç´¢å¼•çš„è®°å½•ä¸­éƒ½å¸¦æœ‰ä¸»é”®å€¼çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ä»idx_key1ä¸­è·å–åˆ°çš„ä¸»é”®å€¼ä¸Šç›´æ¥è¿ç”¨æ¡ä»¶id &gt; 100è¿‡æ»¤å°±è¡Œäº†ã€‚æ‰€ä»¥æ¶‰åŠä¸»é”®çš„æœç´¢æ¡ä»¶åªä¸è¿‡æ˜¯ä¸ºäº†ä»åˆ«çš„äºŒçº§ç´¢å¼•å¾—åˆ°çš„ç»“æœé›†ä¸­è¿‡æ»¤è®°å½•ç½¢äº†ï¼Œæ˜¯ä¸æ˜¯ç­‰å€¼åŒ¹é…ä¸é‡è¦ã€‚ å½“ç„¶ï¼Œä¸Šè¾¹è¯´çš„æƒ…å†µä¸€å’Œæƒ…å†µäºŒåªæ˜¯å‘ç”ŸIntersectionç´¢å¼•åˆå¹¶çš„å¿…è¦æ¡ä»¶ï¼Œä¸æ˜¯å……åˆ†æ¡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´å³ä½¿æƒ…å†µä¸€ã€æƒ…å†µäºŒæˆç«‹ï¼Œä¹Ÿä¸ä¸€å®šå‘ç”ŸIntersectionç´¢å¼•åˆå¹¶ï¼Œè¿™å¾—çœ‹ä¼˜åŒ–å™¨çš„å¿ƒæƒ…ã€‚ä¼˜åŒ–å™¨åªæœ‰åœ¨å•ç‹¬æ ¹æ®æœç´¢æ¡ä»¶ä»æŸä¸ªäºŒçº§ç´¢å¼•ä¸­è·å–çš„è®°å½•æ•°å¤ªå¤šï¼Œå¯¼è‡´å›è¡¨å¼€é”€å¤ªå¤§ï¼Œè€Œé€šè¿‡Intersectionç´¢å¼•åˆå¹¶åéœ€è¦å›è¡¨çš„è®°å½•æ•°å¤§å¤§å‡å°‘æ—¶æ‰ä¼šä½¿ç”¨Intersectionç´¢å¼•åˆå¹¶ã€‚ 9.2 Unionåˆå¹¶æœ‰æ—¶å€™ORå…³ç³»çš„ä¸åŒæœç´¢æ¡ä»¶ä¼šä½¿ç”¨åˆ°ä¸åŒçš„ç´¢å¼•ã€‚ 1SELECT * FROM single_table WHERE key1 = &#x27;a&#x27; OR key3 = &#x27;b&#x27; Intersectionæ˜¯äº¤é›†çš„æ„æ€ï¼Œè¿™é€‚ç”¨äºä½¿ç”¨ä¸åŒç´¢å¼•çš„æœç´¢æ¡ä»¶ä¹‹é—´ä½¿ç”¨ANDè¿æ¥èµ·æ¥çš„æƒ…å†µï¼›Unionæ˜¯å¹¶é›†çš„æ„æ€ï¼Œé€‚ç”¨äºä½¿ç”¨ä¸åŒç´¢å¼•çš„æœç´¢æ¡ä»¶ä¹‹é—´ä½¿ç”¨ORè¿æ¥èµ·æ¥çš„æƒ…å†µã€‚ä¸Intersectionç´¢å¼•åˆå¹¶ç±»ä¼¼ï¼ŒMySQLåœ¨æŸäº›ç‰¹å®šçš„æƒ…å†µä¸‹æ‰å¯èƒ½ä¼šä½¿ç”¨åˆ°Unionç´¢å¼•åˆå¹¶ï¼š æƒ…å†µä¸€ï¼šäºŒçº§ç´¢å¼•åˆ—æ˜¯ç­‰å€¼åŒ¹é…çš„æƒ…å†µï¼Œå¯¹äºè”åˆç´¢å¼•æ¥è¯´ï¼Œåœ¨è”åˆç´¢å¼•ä¸­çš„æ¯ä¸ªåˆ—éƒ½å¿…é¡»ç­‰å€¼åŒ¹é…ï¼Œä¸èƒ½å‡ºç°åªå‡ºç°åŒ¹é…éƒ¨åˆ†åˆ—çš„æƒ…å†µã€‚æ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢å¯èƒ½ç”¨åˆ°idx_key1å’Œidx_key_partè¿™ä¸¤ä¸ªäºŒçº§ç´¢å¼•è¿›è¡ŒUnionç´¢å¼•åˆå¹¶çš„æ“ä½œï¼š 1SELECT * FROM single_table WHERE key1 = &#x27;a&#x27; OR ( key_part1 = &#x27;a&#x27; AND key_part2 = &#x27;b&#x27; AND key_part3 = &#x27;c&#x27;); è€Œä¸‹è¾¹è¿™ä¸¤ä¸ªæŸ¥è¯¢å°±ä¸èƒ½è¿›è¡ŒUnionç´¢å¼•åˆå¹¶ï¼š 123SELECT * FROM single_table WHERE key1 &gt; &#x27;a&#x27; OR (key_part1 = &#x27;a&#x27; AND key_part2 = &#x27;b&#x27; AND key_part3 = &#x27;c&#x27;);SELECT * FROM single_table WHERE key1 = &#x27;a&#x27; OR key_part1 = &#x27;a&#x27;; ç¬¬ä¸€ä¸ªæŸ¥è¯¢æ˜¯å› ä¸ºå¯¹key1è¿›è¡Œäº†èŒƒå›´åŒ¹é…ï¼Œç¬¬äºŒä¸ªæŸ¥è¯¢æ˜¯å› ä¸ºè”åˆç´¢å¼•idx_key_partä¸­çš„key_part2å’Œkey_part3åˆ—å¹¶æ²¡æœ‰å‡ºç°åœ¨æœç´¢æ¡ä»¶ä¸­ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªæŸ¥è¯¢ä¸èƒ½è¿›è¡ŒUnionç´¢å¼•åˆå¹¶ã€‚ æƒ…å†µäºŒï¼šä¸»é”®åˆ—å¯ä»¥æ˜¯èŒƒå›´åŒ¹é… æƒ…å†µä¸‰ï¼šä½¿ç”¨Intersectionç´¢å¼•åˆå¹¶çš„æœç´¢æ¡ä»¶ è¿™ç§æƒ…å†µå…¶å®å°±æ˜¯æœç´¢æ¡ä»¶çš„æŸäº›éƒ¨åˆ†ä½¿ç”¨Intersectionç´¢å¼•åˆå¹¶çš„æ–¹å¼å¾—åˆ°çš„ä¸»é”®é›†åˆå’Œå…¶ä»–æ–¹å¼å¾—åˆ°çš„ä¸»é”®é›†åˆå–äº¤é›†ï¼Œæ¯”æ–¹è¯´è¿™ä¸ªæŸ¥è¯¢ï¼š 1SELECT * FROM single_table WHERE key_part1 = &#x27;a&#x27; AND key_part2 = &#x27;b&#x27; AND key_part3 = &#x27;c&#x27; OR (key1 = &#x27;a&#x27; AND key3 = &#x27;b&#x27;); ä¼˜åŒ–å™¨å¯èƒ½é‡‡ç”¨è¿™æ ·çš„æ–¹å¼æ¥æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢ï¼š å…ˆæŒ‰ç…§æœç´¢æ¡ä»¶key1 = &#39;a&#39; AND key3 = &#39;b&#39;ä»ç´¢å¼•idx_key1å’Œidx_key3ä¸­ä½¿ç”¨Intersectionç´¢å¼•åˆå¹¶çš„æ–¹å¼å¾—åˆ°ä¸€ä¸ªä¸»é”®é›†åˆã€‚ å†æŒ‰ç…§æœç´¢æ¡ä»¶key_part1 = &#39;a&#39; AND key_part2 = &#39;b&#39; AND key_part3 = &#39;c&#39;ä»è”åˆç´¢å¼•idx_key_partä¸­å¾—åˆ°å¦ä¸€ä¸ªä¸»é”®é›†åˆã€‚ é‡‡ç”¨Unionç´¢å¼•åˆå¹¶çš„æ–¹å¼æŠŠä¸Šè¿°ä¸¤ä¸ªä¸»é”®é›†åˆå–å¹¶é›†ï¼Œç„¶åè¿›è¡Œå›è¡¨æ“ä½œï¼Œå°†ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚ å½“ç„¶ï¼ŒæŸ¥è¯¢æ¡ä»¶ç¬¦åˆäº†è¿™äº›æƒ…å†µä¹Ÿä¸ä¸€å®šå°±ä¼šé‡‡ç”¨Unionç´¢å¼•åˆå¹¶ï¼Œä¹Ÿå¾—çœ‹ä¼˜åŒ–å™¨çš„å¿ƒæƒ…ã€‚ä¼˜åŒ–å™¨åªæœ‰åœ¨å•ç‹¬æ ¹æ®æœç´¢æ¡ä»¶ä»æŸä¸ªäºŒçº§ç´¢å¼•ä¸­è·å–çš„è®°å½•æ•°æ¯”è¾ƒå°‘ï¼Œé€šè¿‡Unionç´¢å¼•åˆå¹¶åè¿›è¡Œè®¿é—®çš„ä»£ä»·æ¯”å…¨è¡¨æ‰«ææ›´å°æ—¶æ‰ä¼šä½¿ç”¨Unionç´¢å¼•åˆå¹¶ã€‚ 9.3 Sort-Unionåˆå¹¶Unionç´¢å¼•åˆå¹¶çš„ä½¿ç”¨æ¡ä»¶å¤ªè‹›åˆ»ï¼Œå¿…é¡»ä¿è¯å„ä¸ªäºŒçº§ç´¢å¼•åˆ—åœ¨è¿›è¡Œç­‰å€¼åŒ¹é…çš„æ¡ä»¶ä¸‹æ‰å¯èƒ½è¢«ç”¨åˆ°ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢å°±æ— æ³•ä½¿ç”¨åˆ°Unionç´¢å¼•åˆå¹¶ï¼š 1SELECT * FROM single_table WHERE key1 &lt; &#x27;a&#x27; OR key3 &gt; &#x27;z&#x27; è¿™æ˜¯å› ä¸ºæ ¹æ®key1 &lt; &#39;a&#39;ä»idx_key1ç´¢å¼•ä¸­è·å–çš„äºŒçº§ç´¢å¼•è®°å½•çš„ä¸»é”®å€¼ä¸æ˜¯æ’å¥½åºçš„ï¼Œæ ¹æ®key3 &gt; &#39;z&#39;ä»idx_key3ç´¢å¼•ä¸­è·å–çš„äºŒçº§ç´¢å¼•è®°å½•çš„ä¸»é”®å€¼ä¹Ÿä¸æ˜¯æ’å¥½åºçš„ï¼Œä½†æ˜¯key1 &lt; &#39;a&#39;å’Œkey3 &gt; &#39;z&#39;è¿™ä¸¤ä¸ªæ¡ä»¶åˆç‰¹åˆ«è®©æˆ‘ä»¬åŠ¨å¿ƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·ï¼š å…ˆæ ¹æ®key1 &lt; &#39;a&#39;æ¡ä»¶ä»idx_key1äºŒçº§ç´¢å¼•ä¸­è·å–è®°å½•ï¼Œå¹¶æŒ‰ç…§è®°å½•çš„ä¸»é”®å€¼è¿›è¡Œæ’åº å†æ ¹æ®key3 &gt; &#39;z&#39;æ¡ä»¶ä»idx_key3äºŒçº§ç´¢å¼•ä¸­è·å–è®°å½•ï¼Œå¹¶æŒ‰ç…§è®°å½•çš„ä¸»é”®å€¼è¿›è¡Œæ’åº å› ä¸ºä¸Šè¿°çš„ä¸¤ä¸ªäºŒçº§ç´¢å¼•ä¸»é”®å€¼éƒ½æ˜¯æ’å¥½åºçš„ï¼Œå‰©ä¸‹çš„æ“ä½œå’ŒUnionç´¢å¼•åˆå¹¶æ–¹å¼å°±ä¸€æ ·äº†ã€‚ æˆ‘ä»¬æŠŠä¸Šè¿°è¿™ç§å…ˆæŒ‰ç…§äºŒçº§ç´¢å¼•è®°å½•çš„ä¸»é”®å€¼è¿›è¡Œæ’åºï¼Œä¹‹åæŒ‰ç…§Unionç´¢å¼•åˆå¹¶æ–¹å¼æ‰§è¡Œçš„æ–¹å¼ç§°ä¹‹ä¸ºSort-Unionç´¢å¼•åˆå¹¶ï¼Œå¾ˆæ˜¾ç„¶ï¼Œè¿™ç§Sort-Unionç´¢å¼•åˆå¹¶æ¯”å•çº¯çš„Unionç´¢å¼•åˆå¹¶å¤šäº†ä¸€æ­¥å¯¹äºŒçº§ç´¢å¼•è®°å½•çš„ä¸»é”®å€¼æ’åºçš„è¿‡ç¨‹ã€‚ ä¸ºå•¥æœ‰Sort-Unionç´¢å¼•åˆå¹¶ï¼Œå°±æ²¡æœ‰Sort-Intersectionç´¢å¼•åˆå¹¶ä¹ˆï¼Ÿæ˜¯çš„ï¼Œçš„ç¡®æ²¡æœ‰Sort-Intersectionç´¢å¼•åˆå¹¶è¿™ä¹ˆä¸€è¯´ï¼Œ Sort-Unionçš„é€‚ç”¨åœºæ™¯æ˜¯å•ç‹¬æ ¹æ®æœç´¢æ¡ä»¶ä»æŸä¸ªäºŒçº§ç´¢å¼•ä¸­è·å–çš„è®°å½•æ•°æ¯”è¾ƒå°‘ï¼Œè¿™æ ·å³ä½¿å¯¹è¿™äº›äºŒçº§ç´¢å¼•è®°å½•æŒ‰ç…§ä¸»é”®å€¼è¿›è¡Œæ’åºçš„æˆæœ¬ä¹Ÿä¸ä¼šå¤ªé«˜ è€ŒIntersectionç´¢å¼•åˆå¹¶çš„é€‚ç”¨åœºæ™¯æ˜¯å•ç‹¬æ ¹æ®æœç´¢æ¡ä»¶ä»æŸä¸ªäºŒçº§ç´¢å¼•ä¸­è·å–çš„è®°å½•æ•°å¤ªå¤šï¼Œå¯¼è‡´å›è¡¨å¼€é”€å¤ªå¤§ï¼Œåˆå¹¶åå¯ä»¥æ˜æ˜¾é™ä½å›è¡¨å¼€é”€ï¼Œä½†æ˜¯å¦‚æœåŠ å…¥Sort-Intersectionåï¼Œå°±éœ€è¦ä¸ºå¤§é‡çš„äºŒçº§ç´¢å¼•è®°å½•æŒ‰ç…§ä¸»é”®å€¼è¿›è¡Œæ’åºï¼Œè¿™ä¸ªæˆæœ¬å¯èƒ½æ¯”å›è¡¨æŸ¥è¯¢éƒ½é«˜äº†ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰å¼•å…¥Sort-Intersectionã€‚ 9.4 ç´¢å¼•åˆå¹¶æ³¨æ„äº‹é¡¹è”åˆç´¢å¼•æ›¿ä»£Intersectionç´¢å¼•åˆå¹¶1SELECT * FROM single_table WHERE key1 = &#x27;a&#x27; AND key3 = &#x27;b&#x27;; è¿™ä¸ªæŸ¥è¯¢ä¹‹æ‰€ä»¥å¯èƒ½ä½¿ç”¨Intersectionç´¢å¼•åˆå¹¶çš„æ–¹å¼æ‰§è¡Œï¼Œè¿˜ä¸æ˜¯å› ä¸ºidx_key1å’Œidx_key3æ˜¯ä¸¤ä¸ªå•ç‹¬çš„B+æ ‘ç´¢å¼•ï¼Œè¦æ˜¯æŠŠè¿™ä¸¤ä¸ªåˆ—æä¸€ä¸ªè”åˆç´¢å¼•ï¼Œé‚£ç›´æ¥ä½¿ç”¨è¿™ä¸ªè”åˆç´¢å¼•å°±å¯ä»¥äº†ï¼š 1ALTER TABLE single_table drop index idx_key1, idx_key3, add index idx_key1_key3(key1, key3); è¿™æ ·æˆ‘ä»¬æŠŠæ²¡ç”¨çš„idx_key1ã€idx_key3éƒ½å¹²æ‰ï¼Œå†æ·»åŠ ä¸€ä¸ªè”åˆç´¢å¼•idx_key1_key3ï¼Œä½¿ç”¨è¿™ä¸ªè”åˆç´¢å¼•è¿›è¡ŒæŸ¥è¯¢æ•ˆæœæ›´å¥½ï¼Œæ—¢ä¸ç”¨å¤šè¯»ä¸€æ£µB+æ ‘ï¼Œä¹Ÿä¸ç”¨åˆå¹¶ç»“æœã€‚ ä¸è¿‡å¦‚æœæœ‰å•ç‹¬å¯¹key3åˆ—è¿›è¡ŒæŸ¥è¯¢çš„ä¸šåŠ¡åœºæ™¯ï¼Œè¿™æ ·å­ä¸å¾—ä¸å†æŠŠkey3åˆ—çš„å•ç‹¬ç´¢å¼•ç»™åŠ ä¸Šã€‚å…·ä½“è¿˜å¾—ä»¥ä¸šåŠ¡ä¸ºå‡†ã€‚ äºŒï¼Œè¿æ¥æŸ¥è¯¢åŸç†1. è¿æ¥ç®€ä»‹1.1 è¿æ¥çš„æœ¬è´¨æˆ‘ä»¬å…ˆå»ºç«‹ä¸¤ä¸ªç®€å•çš„è¡¨å¹¶ç»™å®ƒä»¬å¡«å……ä¸€ç‚¹æ•°æ®ï¼š 1234567CREATE TABLE t1 (m1 int, n1 char(1));CREATE TABLE t2 (m2 int, n2 char(1));INSERT INTO t1 VALUES(1, &#x27;a&#x27;), (2, &#x27;b&#x27;), (3, &#x27;c&#x27;);INSERT INTO t2 VALUES(2, &#x27;b&#x27;), (3, &#x27;c&#x27;), (4, &#x27;d&#x27;); æˆ‘ä»¬æˆåŠŸå»ºç«‹äº†t1ã€t2ä¸¤ä¸ªè¡¨ï¼Œè¿™ä¸¤ä¸ªè¡¨éƒ½æœ‰ä¸¤ä¸ªåˆ—ï¼Œä¸€ä¸ªæ˜¯INTç±»å‹çš„ï¼Œä¸€ä¸ªæ˜¯CHAR(1)ç±»å‹çš„ã€‚ 12345678910111213141516171819mysql&gt; SELECT * FROM t1;+------+------+| m1 | n1 |+------+------+| 1 | a || 2 | b || 3 | c |+------+------+3 rows in set (0.00 sec)mysql&gt; SELECT * FROM t2;+------+------+| m2 | n2 |+------+------+| 2 | b || 3 | c || 4 | d |+------+------+3 rows in set (0.00 sec) è¿æ¥çš„æœ¬è´¨å°±æ˜¯æŠŠå„ä¸ªè¿æ¥è¡¨ä¸­çš„è®°å½•éƒ½å–å‡ºæ¥ä¾æ¬¡åŒ¹é…çš„ç»„åˆåŠ å…¥ç»“æœé›†å¹¶è¿”å›ç»™ç”¨æˆ·ã€‚æ‰€ä»¥æˆ‘ä»¬æŠŠt1å’Œt2ä¸¤ä¸ªè¡¨è¿æ¥èµ·æ¥çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™ä¸ªè¿‡ç¨‹çœ‹èµ·æ¥å°±æ˜¯æŠŠt1è¡¨çš„è®°å½•å’Œt2çš„è®°å½•è¿èµ·æ¥ç»„æˆæ–°çš„æ›´å¤§çš„è®°å½•ï¼Œæ‰€ä»¥è¿™ä¸ªæŸ¥è¯¢è¿‡ç¨‹ç§°ä¹‹ä¸ºè¿æ¥æŸ¥è¯¢ã€‚è¿æ¥æŸ¥è¯¢çš„ç»“æœé›†ä¸­åŒ…å«ä¸€ä¸ªè¡¨ä¸­çš„æ¯ä¸€æ¡è®°å½•ä¸å¦ä¸€ä¸ªè¡¨ä¸­çš„æ¯ä¸€æ¡è®°å½•ç›¸äº’åŒ¹é…çš„ç»„åˆï¼Œåƒè¿™æ ·çš„ç»“æœé›†å°±å¯ä»¥ç§°ä¹‹ä¸ºç¬›å¡å°”ç§¯ã€‚å› ä¸ºè¡¨t1ä¸­æœ‰3æ¡è®°å½•ï¼Œè¡¨t2ä¸­ä¹Ÿæœ‰3æ¡è®°å½•ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªè¡¨è¿æ¥ä¹‹åçš„ç¬›å¡å°”ç§¯å°±æœ‰3Ã—3=9è¡Œè®°å½•ã€‚åœ¨MySQLä¸­ï¼Œè¿æ¥æŸ¥è¯¢çš„è¯­æ³•å¾ˆç®€å•ï¼Œåªè¦åœ¨FROMè¯­å¥åè¾¹è·Ÿå¤šä¸ªè¡¨åå°±å¥½äº†ï¼Œæ¯”å¦‚æˆ‘ä»¬æŠŠt1è¡¨å’Œt2è¡¨è¿æ¥èµ·æ¥çš„æŸ¥è¯¢è¯­å¥å¯ä»¥å†™æˆè¿™æ ·ï¼š 1SELECT * FROM t1, t2; 1.2 è¿æ¥è¿‡ç¨‹ç®€ä»‹åœ¨è¿æ¥æŸ¥è¯¢ä¸­çš„è¿‡æ»¤æ¡ä»¶å¯ä»¥åˆ†æˆä¸¤ç§ï¼š æ¶‰åŠå•è¡¨çš„æ¡ä»¶è¿™ç§åªæ¶‰åŠå•è¡¨çš„è¿‡æ»¤æ¡ä»¶æˆ‘ä»¬ä¹‹å‰éƒ½æåˆ°è¿‡ä¸€ä¸‡éäº†ï¼Œæˆ‘ä»¬ä¹‹å‰ä¹Ÿä¸€ç›´ç§°ä¸ºæœç´¢æ¡ä»¶ï¼Œæ¯”å¦‚t1.m1 &gt; 1æ˜¯åªé’ˆå¯¹t1è¡¨çš„è¿‡æ»¤æ¡ä»¶ï¼Œt2.n2 &lt; &#39;d&#39;æ˜¯åªé’ˆå¯¹t2è¡¨çš„è¿‡æ»¤æ¡ä»¶ã€‚ æ¶‰åŠä¸¤è¡¨çš„æ¡ä»¶è¿™ç§è¿‡æ»¤æ¡ä»¶æˆ‘ä»¬ä¹‹å‰æ²¡è§è¿‡ï¼Œæ¯”å¦‚t1.m1 = t2.m2ã€t1.n1 &gt; t2.n2ç­‰ï¼Œè¿™äº›æ¡ä»¶ä¸­æ¶‰åŠåˆ°äº†ä¸¤ä¸ªè¡¨ã€‚ æˆ‘ä»¬çœ‹ä¸€ä¸‹æºå¸¦è¿‡æ»¤æ¡ä»¶çš„è¿æ¥æŸ¥è¯¢çš„å¤§è‡´æ‰§è¡Œè¿‡ç¨‹ï¼š 1SELECT * FROM t1, t2 WHERE t1.m1 &gt; 1 AND t1.m1 = t2.m2 AND t2.n2 &lt; &#x27;d&#x27;; åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸­æˆ‘ä»¬æŒ‡æ˜äº†è¿™ä¸‰ä¸ªè¿‡æ»¤æ¡ä»¶ï¼š t1.m1 &gt; 1 t1.m1 = t2.m2 t2.n2 &lt; &#39;d&#39; è¿™ä¸ªè¿æ¥æŸ¥è¯¢çš„å¤§è‡´æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š é¦–å…ˆç¡®å®šç¬¬ä¸€ä¸ªéœ€è¦æŸ¥è¯¢çš„è¡¨ï¼Œè¿™ä¸ªè¡¨ç§°ä¹‹ä¸ºé©±åŠ¨è¡¨ã€‚æ­¤å¤„å‡è®¾ä½¿ç”¨t1ä½œä¸ºé©±åŠ¨è¡¨ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆ°t1è¡¨ä¸­æ‰¾æ»¡è¶³t1.m1 &gt; 1çš„è®°å½•ï¼Œå› ä¸ºè¡¨ä¸­çš„æ•°æ®å¤ªå°‘ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡åœ¨è¡¨ä¸Šå»ºç«‹äºŒçº§ç´¢å¼•ï¼Œæ‰€ä»¥æ­¤å¤„æŸ¥è¯¢t1è¡¨çš„è®¿é—®æ–¹æ³•å°±è®¾å®šä¸ºallå§ï¼Œä¹Ÿå°±æ˜¯é‡‡ç”¨å…¨è¡¨æ‰«æçš„æ–¹å¼æ‰§è¡Œå•è¡¨æŸ¥è¯¢ï¼Œæ‰€ä»¥æŸ¥è¯¢è¿‡ç¨‹å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œt1è¡¨ä¸­ç¬¦åˆt1.m1 &gt; 1çš„è®°å½•æœ‰ä¸¤æ¡ã€‚ é’ˆå¯¹ä¸Šä¸€æ­¥éª¤ä¸­ä»é©±åŠ¨è¡¨äº§ç”Ÿçš„ç»“æœé›†ä¸­çš„æ¯ä¸€æ¡è®°å½•ï¼Œåˆ†åˆ«éœ€è¦åˆ°t2è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„è®°å½•ï¼Œæ‰€è°“åŒ¹é…çš„è®°å½•ï¼ŒæŒ‡çš„æ˜¯ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„è®°å½•ã€‚å› ä¸ºæ˜¯æ ¹æ®t1è¡¨ä¸­çš„è®°å½•å»æ‰¾t2è¡¨ä¸­çš„è®°å½•ï¼Œæ‰€ä»¥t2è¡¨ä¹Ÿå¯ä»¥è¢«ç§°ä¹‹ä¸ºè¢«é©±åŠ¨è¡¨ã€‚ä¸Šä¸€æ­¥éª¤ä»é©±åŠ¨è¡¨ä¸­å¾—åˆ°äº†2æ¡è®°å½•ï¼Œæ‰€ä»¥éœ€è¦æŸ¥è¯¢2æ¬¡t2è¡¨ã€‚æ­¤æ—¶æ¶‰åŠä¸¤ä¸ªè¡¨çš„åˆ—çš„è¿‡æ»¤æ¡ä»¶t1.m1 = t2.m2å°±æ´¾ä¸Šç”¨åœºäº†ï¼š å½“t1.m1 = 2æ—¶ï¼Œè¿‡æ»¤æ¡ä»¶t1.m1 = t2.m2å°±ç›¸å½“äºt2.m2 = 2ï¼Œæ‰€ä»¥æ­¤æ—¶t2è¡¨ç›¸å½“äºæœ‰äº†t2.m2 = 2ã€t2.n2 &lt; &#39;d&#39;è¿™ä¸¤ä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œç„¶ååˆ°t2è¡¨ä¸­æ‰§è¡Œå•è¡¨æŸ¥è¯¢ã€‚ å½“t1.m1 = 3æ—¶ï¼Œè¿‡æ»¤æ¡ä»¶t1.m1 = t2.m2å°±ç›¸å½“äºt2.m2 = 3ï¼Œæ‰€ä»¥æ­¤æ—¶t2è¡¨ç›¸å½“äºæœ‰äº†t2.m2 = 3ã€t2.n2 &lt; &#39;d&#39;è¿™ä¸¤ä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œç„¶ååˆ°t2è¡¨ä¸­æ‰§è¡Œå•è¡¨æŸ¥è¯¢ã€‚ æ‰€ä»¥æ•´ä¸ªè¿æ¥æŸ¥è¯¢çš„æ‰§è¡Œè¿‡ç¨‹å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä¹Ÿå°±æ˜¯è¯´æ•´ä¸ªè¿æ¥æŸ¥è¯¢æœ€åçš„ç»“æœåªæœ‰ä¸¤æ¡ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„è®°å½•ï¼š 123456+------+------+------+------+| m1 | n1 | m2 | n2 |+------+------+------+------+| 2 | b | 2 | b || 3 | c | 3 | c |+------+------+------+------+ è¿™ä¸ªä¸¤è¡¨è¿æ¥æŸ¥è¯¢å…±éœ€è¦æŸ¥è¯¢1æ¬¡t1è¡¨ï¼Œ2æ¬¡t2è¡¨ã€‚å½“ç„¶è¿™æ˜¯åœ¨ç‰¹å®šçš„è¿‡æ»¤æ¡ä»¶ä¸‹çš„ç»“æœï¼Œå¦‚æœæˆ‘ä»¬æŠŠt1.m1 &gt; 1è¿™ä¸ªæ¡ä»¶å»æ‰ï¼Œé‚£ä¹ˆä»t1è¡¨ä¸­æŸ¥å‡ºçš„è®°å½•å°±æœ‰3æ¡ï¼Œå°±éœ€è¦æŸ¥è¯¢3æ¬¡t2è¡¨äº†ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨ä¸¤è¡¨è¿æ¥æŸ¥è¯¢ä¸­ï¼Œé©±åŠ¨è¡¨åªéœ€è¦è®¿é—®ä¸€æ¬¡ï¼Œè¢«é©±åŠ¨è¡¨å¯èƒ½è¢«è®¿é—®å¤šæ¬¡ã€‚ 1.3 å†…è¿æ¥å’Œå¤–è¿æ¥æˆ‘ä»¬å…ˆåˆ›å»ºä¸¤ä¸ªæœ‰ç°å®æ„ä¹‰çš„è¡¨ã€‚ 12345678910111213CREATE TABLE student ( number INT NOT NULL AUTO_INCREMENT COMMENT &#x27;å­¦å·&#x27;, name VARCHAR(5) COMMENT &#x27;å§“å&#x27;, major VARCHAR(30) COMMENT &#x27;ä¸“ä¸š&#x27;, PRIMARY KEY (number)) Engine=InnoDB CHARSET=utf8 COMMENT &#x27;å­¦ç”Ÿä¿¡æ¯è¡¨&#x27;;CREATE TABLE score ( number INT COMMENT &#x27;å­¦å·&#x27;, subject VARCHAR(30) COMMENT &#x27;ç§‘ç›®&#x27;, score TINYINT COMMENT &#x27;æˆç»©&#x27;, PRIMARY KEY (number, subject)) Engine=InnoDB CHARSET=utf8 COMMENT &#x27;å­¦ç”Ÿæˆç»©è¡¨&#x27;; æˆ‘ä»¬æ–°å»ºäº†ä¸€ä¸ªå­¦ç”Ÿä¿¡æ¯è¡¨ï¼Œä¸€ä¸ªå­¦ç”Ÿæˆç»©è¡¨ï¼Œç„¶åæˆ‘ä»¬å‘ä¸Šè¿°ä¸¤ä¸ªè¡¨ä¸­æ’å…¥ä¸€äº›æ•°æ®ï¼š 1234567891011121314151617181920mysql&gt; SELECT * FROM student;+----------+-----------+--------------------------+| number | name | major |+----------+-----------+--------------------------+| 20180101 | æœå­è…¾ | è½¯ä»¶å­¦é™¢ || 20180102 | èŒƒç»Ÿ | è®¡ç®—æœºç§‘å­¦ä¸å·¥ç¨‹ || 20180103 | å²çé¦™ | è®¡ç®—æœºç§‘å­¦ä¸å·¥ç¨‹ |+----------+-----------+--------------------------+3 rows in set (0.00 sec)mysql&gt; SELECT * FROM score;+----------+-----------------------------+-------+| number | subject | score |+----------+-----------------------------+-------+| 20180101 | æ¯çŒªçš„äº§åæŠ¤ç† | 78 || 20180101 | è®ºè¨è¾¾å§†çš„æˆ˜äº‰å‡†å¤‡ | 88 || 20180102 | è®ºè¨è¾¾å§†çš„æˆ˜äº‰å‡†å¤‡ | 98 || 20180102 | æ¯çŒªçš„äº§åæŠ¤ç† | 100 |+----------+-----------------------------+-------+4 rows in set (0.00 sec) ç°åœ¨æˆ‘ä»¬æƒ³æŠŠæ¯ä¸ªå­¦ç”Ÿçš„è€ƒè¯•æˆç»©éƒ½æŸ¥è¯¢å‡ºæ¥å°±éœ€è¦è¿›è¡Œä¸¤è¡¨è¿æ¥äº†ï¼ˆå› ä¸ºscoreä¸­æ²¡æœ‰å§“åä¿¡æ¯ï¼Œæ‰€ä»¥ä¸èƒ½å•çº¯åªæŸ¥è¯¢scoreè¡¨ï¼‰ã€‚è¿æ¥è¿‡ç¨‹å°±æ˜¯ä»studentè¡¨ä¸­å–å‡ºè®°å½•ï¼Œåœ¨scoreè¡¨ä¸­æŸ¥æ‰¾numberç›¸åŒçš„æˆç»©è®°å½•ï¼Œæ‰€ä»¥è¿‡æ»¤æ¡ä»¶å°±æ˜¯student.number = socre.numberï¼Œæ•´ä¸ªæŸ¥è¯¢è¯­å¥å°±æ˜¯è¿™æ ·ï¼š 1SELECT * FROM student, score WHERE student.number = score.number; ä»ä¸Šè¿°æŸ¥è¯¢ç»“æœä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå„ä¸ªåŒå­¦å¯¹åº”çš„å„ç§‘æˆç»©å°±éƒ½è¢«æŸ¥å‡ºæ¥äº†ï¼Œå¯æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œå²çé¦™åŒå­¦ï¼Œä¹Ÿå°±æ˜¯å­¦å·ä¸º20180103çš„åŒå­¦å› ä¸ºæŸäº›åŸå› æ²¡æœ‰å‚åŠ è€ƒè¯•ï¼Œæ‰€ä»¥åœ¨scoreè¡¨ä¸­æ²¡æœ‰å¯¹åº”çš„æˆç»©è®°å½•ã€‚é‚£å¦‚æœè€å¸ˆæƒ³æŸ¥çœ‹æ‰€æœ‰åŒå­¦çš„è€ƒè¯•æˆç»©ï¼Œå³ä½¿æ˜¯ç¼ºè€ƒçš„åŒå­¦ä¹Ÿåº”è¯¥å±•ç¤ºå‡ºæ¥ï¼Œä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬ä»‹ç»çš„è¿æ¥æŸ¥è¯¢æ˜¯æ— æ³•å®Œæˆè¿™æ ·çš„éœ€æ±‚çš„ã€‚ è¿™ä¸ªéœ€æ±‚çš„æœ¬è´¨æ˜¯ï¼šé©±åŠ¨è¡¨ä¸­çš„è®°å½•å³ä½¿åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ²¡æœ‰åŒ¹é…çš„è®°å½•ï¼Œä¹Ÿä»ç„¶éœ€è¦åŠ å…¥åˆ°ç»“æœé›†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±æœ‰äº†å†…è¿æ¥å’Œå¤–è¿æ¥çš„æ¦‚å¿µã€‚ å¯¹äºå†…è¿æ¥çš„ä¸¤ä¸ªè¡¨ï¼Œé©±åŠ¨è¡¨ä¸­çš„è®°å½•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾ä¸åˆ°åŒ¹é…çš„è®°å½•ï¼Œè¯¥è®°å½•ä¸ä¼šåŠ å…¥åˆ°æœ€åçš„ç»“æœé›†ï¼Œæˆ‘ä»¬ä¸Šè¾¹æåˆ°çš„è¿æ¥éƒ½æ˜¯æ‰€è°“çš„å†…è¿æ¥ã€‚ å¯¹äºå¤–è¿æ¥çš„ä¸¤ä¸ªè¡¨ï¼Œé©±åŠ¨è¡¨ä¸­çš„è®°å½•å³ä½¿åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ²¡æœ‰åŒ¹é…çš„è®°å½•ï¼Œä¹Ÿä»ç„¶éœ€è¦åŠ å…¥åˆ°ç»“æœé›†ã€‚åœ¨MySQLä¸­ï¼Œæ ¹æ®é€‰å–é©±åŠ¨è¡¨çš„ä¸åŒï¼Œå¤–è¿æ¥ä»ç„¶å¯ä»¥ç»†åˆ†ä¸º2ç§ï¼š å·¦å¤–è¿æ¥ï¼šé€‰å–å·¦ä¾§çš„è¡¨ä¸ºé©±åŠ¨è¡¨ã€‚ å³å¤–è¿æ¥ï¼šé€‰å–å³ä¾§çš„è¡¨ä¸ºé©±åŠ¨è¡¨ã€‚ å¯¹äºå¤–è¿æ¥æ¥è¯´ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿå¹¶ä¸æƒ³æŠŠé©±åŠ¨è¡¨çš„å…¨éƒ¨è®°å½•éƒ½åŠ å…¥åˆ°æœ€åçš„ç»“æœé›†ã€‚æŠŠè¿‡æ»¤æ¡ä»¶åˆ†ä¸ºä¸¤ç§å°±å¯ä»¥äº†ï¼Œæ‰€ä»¥æ”¾åœ¨ä¸åŒåœ°æ–¹çš„è¿‡æ»¤æ¡ä»¶æ˜¯æœ‰ä¸åŒè¯­ä¹‰çš„ï¼š WHEREå­å¥ä¸­çš„è¿‡æ»¤æ¡ä»¶WHEREå­å¥ä¸­çš„è¿‡æ»¤æ¡ä»¶å°±æ˜¯æˆ‘ä»¬å¹³æ—¶è§çš„é‚£ç§ï¼Œä¸è®ºæ˜¯å†…è¿æ¥è¿˜æ˜¯å¤–è¿æ¥ï¼Œå‡¡æ˜¯ä¸ç¬¦åˆWHEREå­å¥ä¸­çš„è¿‡æ»¤æ¡ä»¶çš„è®°å½•éƒ½ä¸ä¼šè¢«åŠ å…¥æœ€åçš„ç»“æœé›†ã€‚ ONå­å¥ä¸­çš„è¿‡æ»¤æ¡ä»¶å¯¹äºå¤–è¿æ¥çš„é©±åŠ¨è¡¨çš„è®°å½•æ¥è¯´ï¼Œå¦‚æœæ— æ³•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾åˆ°åŒ¹é…ONå­å¥ä¸­çš„è¿‡æ»¤æ¡ä»¶çš„è®°å½•ï¼Œé‚£ä¹ˆè¯¥è®°å½•ä»ç„¶ä¼šè¢«åŠ å…¥åˆ°ç»“æœé›†ä¸­ï¼Œå¯¹åº”çš„è¢«é©±åŠ¨è¡¨è®°å½•çš„å„ä¸ªå­—æ®µä½¿ç”¨NULLå€¼å¡«å……ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªONå­å¥æ˜¯ä¸“é—¨ä¸ºå¤–è¿æ¥é©±åŠ¨è¡¨ä¸­çš„è®°å½•åœ¨è¢«é©±åŠ¨è¡¨æ‰¾ä¸åˆ°åŒ¹é…è®°å½•æ—¶åº”ä¸åº”è¯¥æŠŠè¯¥è®°å½•åŠ å…¥ç»“æœé›†è¿™ä¸ªåœºæ™¯ä¸‹æå‡ºçš„ï¼Œæ‰€ä»¥å¦‚æœæŠŠONå­å¥æ”¾åˆ°å†…è¿æ¥ä¸­ï¼ŒMySQLä¼šæŠŠå®ƒå’ŒWHEREå­å¥ä¸€æ ·å¯¹å¾…ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šå†…è¿æ¥ä¸­çš„WHEREå­å¥å’ŒONå­å¥æ˜¯ç­‰ä»·çš„ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æŠŠåªæ¶‰åŠå•è¡¨çš„è¿‡æ»¤æ¡ä»¶æ”¾åˆ°WHEREå­å¥ä¸­ï¼ŒæŠŠæ¶‰åŠä¸¤è¡¨çš„è¿‡æ»¤æ¡ä»¶éƒ½æ”¾åˆ°ONå­å¥ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä¸€èˆ¬æŠŠæ”¾åˆ°ONå­å¥ä¸­çš„è¿‡æ»¤æ¡ä»¶ä¹Ÿç§°ä¹‹ä¸ºè¿æ¥æ¡ä»¶ã€‚ 1.3.1 å·¦ï¼ˆå¤–ï¼‰è¿æ¥çš„è¯­æ³•æ¯”å¦‚æˆ‘ä»¬è¦æŠŠt1è¡¨å’Œt2è¡¨è¿›è¡Œå·¦å¤–è¿æ¥æŸ¥è¯¢å¯ä»¥è¿™ä¹ˆå†™ï¼š 1SELECT * FROM t1 LEFT [OUTER] JOIN t2 ON è¿æ¥æ¡ä»¶ [WHERE æ™®é€šè¿‡æ»¤æ¡ä»¶]; å…¶ä¸­ä¸­æ‹¬å·é‡Œçš„OUTERå•è¯æ˜¯å¯ä»¥çœç•¥çš„ã€‚å¯¹äºLEFT JOINç±»å‹çš„è¿æ¥æ¥è¯´ï¼Œæˆ‘ä»¬æŠŠæ”¾åœ¨å·¦è¾¹çš„è¡¨ç§°ä¹‹ä¸ºå¤–è¡¨æˆ–è€…é©±åŠ¨è¡¨ï¼Œå³è¾¹çš„è¡¨ç§°ä¹‹ä¸ºå†…è¡¨æˆ–è€…è¢«é©±åŠ¨è¡¨ã€‚æ‰€ä»¥ä¸Šè¿°ä¾‹å­ä¸­t1å°±æ˜¯å¤–è¡¨æˆ–è€…é©±åŠ¨è¡¨ï¼Œt2å°±æ˜¯å†…è¡¨æˆ–è€…è¢«é©±åŠ¨è¡¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºå·¦ï¼ˆå¤–ï¼‰è¿æ¥å’Œå³ï¼ˆå¤–ï¼‰è¿æ¥æ¥è¯´ï¼Œå¿…é¡»ä½¿ç”¨ONå­å¥æ¥æŒ‡å‡ºè¿æ¥æ¡ä»¶ã€‚ å›åˆ°æˆ‘ä»¬ä¸Šè¾¹é‚£ä¸ªç°å®é—®é¢˜ä¸­æ¥ï¼Œçœ‹çœ‹æ€æ ·å†™æŸ¥è¯¢è¯­å¥æ‰èƒ½æŠŠæ‰€æœ‰çš„å­¦ç”Ÿçš„æˆç»©ä¿¡æ¯éƒ½æŸ¥è¯¢å‡ºæ¥ï¼Œå³ä½¿æ˜¯ç¼ºè€ƒçš„è€ƒç”Ÿä¹Ÿåº”è¯¥è¢«æ”¾åˆ°ç»“æœé›†ä¸­ï¼š 1SELECT s1.number, s1.name, s2.subject, s2.score FROM student AS s1 LEFT JOIN score AS s2 ON s1.number = s2.number; ä»ç»“æœé›†ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œè™½ç„¶å²çé¦™å¹¶æ²¡æœ‰å¯¹åº”çš„æˆç»©è®°å½•ï¼Œä½†æ˜¯ç”±äºé‡‡ç”¨çš„æ˜¯è¿æ¥ç±»å‹ä¸ºå·¦ï¼ˆå¤–ï¼‰è¿æ¥ï¼Œæ‰€ä»¥ä»ç„¶æŠŠå¥¹æ”¾åˆ°äº†ç»“æœé›†ä¸­ï¼Œåªä¸è¿‡åœ¨å¯¹åº”çš„æˆç»©è®°å½•çš„å„åˆ—ä½¿ç”¨NULLå€¼å¡«å……è€Œå·²ã€‚ 1.3.2 å³ï¼ˆå¤–ï¼‰è¿æ¥çš„è¯­æ³•å³ï¼ˆå¤–ï¼‰è¿æ¥å’Œå·¦ï¼ˆå¤–ï¼‰è¿æ¥çš„åŸç†æ˜¯ä¸€æ ·ä¸€æ ·çš„ï¼Œè¯­æ³•ä¹Ÿåªæ˜¯æŠŠLEFTæ¢æˆRIGHTè€Œå·²ï¼š 1SELECT * FROM t1 RIGHT [OUTER] JOIN t2 ON è¿æ¥æ¡ä»¶ [WHERE æ™®é€šè¿‡æ»¤æ¡ä»¶]; åªä¸è¿‡é©±åŠ¨è¡¨æ˜¯å³è¾¹çš„è¡¨ï¼Œè¢«é©±åŠ¨è¡¨æ˜¯å·¦è¾¹çš„è¡¨ã€‚ 1.3.3 å†…è¿æ¥çš„è¯­æ³•å†…è¿æ¥å’Œå¤–è¿æ¥çš„æ ¹æœ¬åŒºåˆ«å°±æ˜¯åœ¨é©±åŠ¨è¡¨ä¸­çš„è®°å½•ä¸ç¬¦åˆONå­å¥ä¸­çš„è¿æ¥æ¡ä»¶æ—¶ä¸ä¼šæŠŠè¯¥è®°å½•åŠ å…¥åˆ°æœ€åçš„ç»“æœé›†ã€‚ ä¸€ç§æœ€ç®€å•çš„å†…è¿æ¥è¯­æ³•ï¼Œå°±æ˜¯ç›´æ¥æŠŠéœ€è¦è¿æ¥çš„å¤šä¸ªè¡¨éƒ½æ”¾åˆ°FROMå­å¥åè¾¹ã€‚å…¶å®é’ˆå¯¹å†…è¿æ¥ï¼ŒMySQLæä¾›äº†å¥½å¤šä¸åŒçš„è¯­æ³•ï¼Œæˆ‘ä»¬ä»¥t1å’Œt2è¡¨ä¸ºä¾‹ï¼š 1SELECT * FROM t1 [INNER | CROSS] JOIN t2 [ON è¿æ¥æ¡ä»¶] [WHERE æ™®é€šè¿‡æ»¤æ¡ä»¶]; ä¹Ÿå°±æ˜¯è¯´åœ¨MySQLä¸­ï¼Œä¸‹è¾¹è¿™å‡ ç§å†…è¿æ¥çš„å†™æ³•éƒ½æ˜¯ç­‰ä»·çš„ï¼š SELECT * FROM t1 JOIN t2; SELECT * FROM t1 INNER JOIN t2; SELECT * FROM t1 CROSS JOIN t2; ä¸Šè¾¹çš„è¿™äº›å†™æ³•å’Œç›´æ¥æŠŠéœ€è¦è¿æ¥çš„è¡¨åæ”¾åˆ°FROMè¯­å¥ä¹‹åï¼Œç”¨é€—å·,åˆ†éš”å¼€çš„å†™æ³•æ˜¯ç­‰ä»·çš„ï¼š 1SELECT * FROM t1, t2; åœ¨å†…è¿æ¥ä¸­ONå­å¥å’ŒWHEREå­å¥æ˜¯ç­‰ä»·çš„ï¼Œæ‰€ä»¥å†…è¿æ¥ä¸­ä¸è¦æ±‚å¼ºåˆ¶å†™æ˜ONå­å¥ã€‚ å‰è¾¹è¯´è¿‡ï¼Œè¿æ¥çš„æœ¬è´¨å°±æ˜¯æŠŠå„ä¸ªè¿æ¥è¡¨ä¸­çš„è®°å½•éƒ½å–å‡ºæ¥ä¾æ¬¡åŒ¹é…çš„ç»„åˆåŠ å…¥ç»“æœé›†å¹¶è¿”å›ç»™ç”¨æˆ·ã€‚ä¸è®ºå“ªä¸ªè¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œä¸¤è¡¨è¿æ¥äº§ç”Ÿçš„ç¬›å¡å°”ç§¯è‚¯å®šæ˜¯ä¸€æ ·çš„ã€‚è€Œå¯¹äºå†…è¿æ¥æ¥è¯´ï¼Œç”±äºå‡¡æ˜¯ä¸ç¬¦åˆONå­å¥æˆ–WHEREå­å¥ä¸­çš„æ¡ä»¶çš„è®°å½•éƒ½ä¼šè¢«è¿‡æ»¤æ‰ï¼Œå…¶å®ä¹Ÿå°±ç›¸å½“äºä»ä¸¤è¡¨è¿æ¥çš„ç¬›å¡å°”ç§¯ä¸­æŠŠä¸ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„è®°å½•ç»™è¸¢å‡ºå»ï¼Œæ‰€ä»¥å¯¹äºå†…è¿æ¥æ¥è¯´ï¼Œé©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨æ˜¯å¯ä»¥äº’æ¢çš„ï¼Œå¹¶ä¸ä¼šå½±å“æœ€åçš„æŸ¥è¯¢ç»“æœã€‚ä½†æ˜¯å¯¹äºå¤–è¿æ¥æ¥è¯´ï¼Œç”±äºé©±åŠ¨è¡¨ä¸­çš„è®°å½•å³ä½¿åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾ä¸åˆ°ç¬¦åˆONå­å¥æ¡ä»¶çš„è®°å½•æ—¶ä¹Ÿè¦å°†å…¶åŠ å…¥åˆ°ç»“æœé›†ï¼Œæ‰€ä»¥æ­¤æ—¶é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨çš„å…³ç³»å°±å¾ˆé‡è¦äº†ï¼Œä¹Ÿå°±æ˜¯è¯´å·¦å¤–è¿æ¥å’Œå³å¤–è¿æ¥çš„é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨ä¸èƒ½è½»æ˜“äº’æ¢ã€‚ 2.è¿æ¥çš„åŸç†æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹MySQLé‡‡ç”¨äº†ä»€ä¹ˆæ ·çš„ç®—æ³•æ¥è¿›è¡Œè¡¨ä¸è¡¨ä¹‹é—´çš„è¿æ¥ã€‚ 2.1 åµŒå¥—å¾ªç¯è¿æ¥å¯¹äºä¸¤è¡¨è¿æ¥æ¥è¯´ï¼Œé©±åŠ¨è¡¨åªä¼šè¢«è®¿é—®ä¸€éï¼Œä½†è¢«é©±åŠ¨è¡¨å´è¦è¢«è®¿é—®åˆ°å¥½å¤šéï¼Œå…·ä½“è®¿é—®å‡ éå–å†³äºå¯¹é©±åŠ¨è¡¨æ‰§è¡Œå•è¡¨æŸ¥è¯¢åçš„ç»“æœé›†ä¸­çš„è®°å½•æ¡æ•°ã€‚å¯¹äºå†…è¿æ¥æ¥è¯´ï¼Œé€‰å–å“ªä¸ªè¡¨ä¸ºé©±åŠ¨è¡¨éƒ½æ²¡å…³ç³»ï¼Œè€Œå¤–è¿æ¥çš„é©±åŠ¨è¡¨æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å·¦ï¼ˆå¤–ï¼‰è¿æ¥çš„é©±åŠ¨è¡¨å°±æ˜¯å·¦è¾¹çš„é‚£ä¸ªè¡¨ï¼Œå³ï¼ˆå¤–ï¼‰è¿æ¥çš„é©±åŠ¨è¡¨å°±æ˜¯å³è¾¹çš„é‚£ä¸ªè¡¨ã€‚ å†æ¥çœ‹ä¸€ä¸‹t1è¡¨å’Œt2è¡¨æ‰§è¡Œå†…è¿æ¥æŸ¥è¯¢çš„å¤§è‡´è¿‡ç¨‹ï¼š æ­¥éª¤1ï¼šé€‰å–é©±åŠ¨è¡¨ï¼Œä½¿ç”¨ä¸é©±åŠ¨è¡¨ç›¸å…³çš„è¿‡æ»¤æ¡ä»¶ï¼Œé€‰å–ä»£ä»·æœ€ä½çš„å•è¡¨è®¿é—®æ–¹æ³•æ¥æ‰§è¡Œå¯¹é©±åŠ¨è¡¨çš„å•è¡¨æŸ¥è¯¢ã€‚ æ­¥éª¤2ï¼šå¯¹ä¸Šä¸€æ­¥éª¤ä¸­æŸ¥è¯¢é©±åŠ¨è¡¨å¾—åˆ°çš„ç»“æœé›†ä¸­æ¯ä¸€æ¡è®°å½•ï¼Œéƒ½åˆ†åˆ«åˆ°è¢«é©±åŠ¨è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„è®°å½•ã€‚ é€šç”¨çš„ä¸¤è¡¨è¿æ¥è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¦‚æœæœ‰3ä¸ªè¡¨è¿›è¡Œè¿æ¥çš„è¯ï¼Œé‚£ä¹ˆæ­¥éª¤2ä¸­å¾—åˆ°çš„ç»“æœé›†å°±åƒæ˜¯æ–°çš„é©±åŠ¨è¡¨ï¼Œç„¶åç¬¬ä¸‰ä¸ªè¡¨å°±æˆä¸ºäº†è¢«é©±åŠ¨è¡¨ï¼Œé‡å¤ä¸Šè¾¹è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯æ­¥éª¤2ä¸­å¾—åˆ°çš„ç»“æœé›†ä¸­çš„æ¯ä¸€æ¡è®°å½•éƒ½éœ€è¦åˆ°t3è¡¨ä¸­æ‰¾ä¸€æ‰¾æœ‰æ²¡æœ‰åŒ¹é…çš„è®°å½•ï¼Œç”¨ä¼ªä»£ç è¡¨ç¤ºä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯è¿™æ ·ï¼š 123456789for each row in t1 &#123; #æ­¤å¤„è¡¨ç¤ºéå†æ»¡è¶³å¯¹t1å•è¡¨æŸ¥è¯¢ç»“æœé›†ä¸­çš„æ¯ä¸€æ¡è®°å½• for each row in t2 &#123; #æ­¤å¤„è¡¨ç¤ºå¯¹äºæŸæ¡t1è¡¨çš„è®°å½•æ¥è¯´ï¼Œéå†æ»¡è¶³å¯¹t2å•è¡¨æŸ¥è¯¢ç»“æœé›†ä¸­çš„æ¯ä¸€æ¡è®°å½• for each row in t3 &#123; #æ­¤å¤„è¡¨ç¤ºå¯¹äºæŸæ¡t1å’Œt2è¡¨çš„è®°å½•ç»„åˆæ¥è¯´ï¼Œå¯¹t3è¡¨è¿›è¡Œå•è¡¨æŸ¥è¯¢ if row satisfies join conditions, send to client &#125; &#125;&#125; è¿™ä¸ªè¿‡ç¨‹å°±åƒæ˜¯ä¸€ä¸ªåµŒå¥—çš„å¾ªç¯ï¼Œæ‰€ä»¥è¿™ç§é©±åŠ¨è¡¨åªè®¿é—®ä¸€æ¬¡ï¼Œä½†è¢«é©±åŠ¨è¡¨å´å¯èƒ½è¢«å¤šæ¬¡è®¿é—®ï¼Œè®¿é—®æ¬¡æ•°å–å†³äºå¯¹é©±åŠ¨è¡¨æ‰§è¡Œå•è¡¨æŸ¥è¯¢åçš„ç»“æœé›†ä¸­çš„è®°å½•æ¡æ•°çš„è¿æ¥æ‰§è¡Œæ–¹å¼ç§°ä¹‹ä¸ºåµŒå¥—å¾ªç¯è¿æ¥ï¼ˆNested-Loop Joinï¼‰ï¼Œè¿™æ˜¯æœ€ç®€å•ï¼Œä¹Ÿæ˜¯æœ€ç¬¨æ‹™çš„ä¸€ç§è¿æ¥æŸ¥è¯¢ç®—æ³•ã€‚ 2.2 ä½¿ç”¨ç´¢å¼•åŠ å¿«è¿æ¥é€Ÿåº¦åœ¨åµŒå¥—å¾ªç¯è¿æ¥çš„æ­¥éª¤2ä¸­å¯èƒ½éœ€è¦è®¿é—®å¤šæ¬¡è¢«é©±åŠ¨è¡¨ï¼Œå¦‚æœè®¿é—®è¢«é©±åŠ¨è¡¨çš„æ–¹å¼éƒ½æ˜¯å…¨è¡¨æ‰«æçš„è¯ï¼Œè¦æŸ¥å¾ˆå¤šæ¬¡ã€‚ä½†æ˜¯æŸ¥è¯¢t2è¡¨å…¶å®å°±ç›¸å½“äºä¸€æ¬¡å•è¡¨æ‰«æï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç´¢å¼•æ¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚å›åˆ°æœ€å¼€å§‹çš„t1è¡¨å’Œt2è¡¨è¿›è¡Œå†…è¿æ¥çš„ä¾‹å­ï¼š 1SELECT * FROM t1, t2 WHERE t1.m1 &gt; 1 AND t1.m1 = t2.m2 AND t2.n2 &lt; &#x27;d&#x27;; æŸ¥è¯¢é©±åŠ¨è¡¨t1åçš„ç»“æœé›†ä¸­æœ‰ä¸¤æ¡è®°å½•ï¼ŒåµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•éœ€è¦å¯¹è¢«é©±åŠ¨è¡¨æŸ¥è¯¢2æ¬¡ï¼š å½“t1.m1 = 2æ—¶ï¼Œå»æŸ¥è¯¢ä¸€ét2è¡¨ï¼Œå¯¹t2è¡¨çš„æŸ¥è¯¢è¯­å¥ç›¸å½“äºï¼š 1SELECT * FROM t2 WHERE t2.m2 = 2 AND t2.n2 &lt; &#x27;d&#x27;; å½“t1.m1 = 3æ—¶ï¼Œå†å»æŸ¥è¯¢ä¸€ét2è¡¨ï¼Œæ­¤æ—¶å¯¹t2è¡¨çš„æŸ¥è¯¢è¯­å¥ç›¸å½“äºï¼š 1SELECT * FROM t2 WHERE t2.m2 = 3 AND t2.n2 &lt; &#x27;d&#x27;; å¯ä»¥çœ‹åˆ°ï¼ŒåŸæ¥çš„t1.m1 = t2.m2è¿™ä¸ªæ¶‰åŠä¸¤ä¸ªè¡¨çš„è¿‡æ»¤æ¡ä»¶åœ¨é’ˆå¯¹t2è¡¨åšæŸ¥è¯¢æ—¶å…³äºt1è¡¨çš„æ¡ä»¶å°±å·²ç»ç¡®å®šäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å•å•ä¼˜åŒ–å¯¹t2è¡¨çš„æŸ¥è¯¢äº†ï¼Œä¸Šè¿°ä¸¤ä¸ªå¯¹t2è¡¨çš„æŸ¥è¯¢è¯­å¥ä¸­åˆ©ç”¨åˆ°çš„åˆ—æ˜¯m2å’Œn2åˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š åœ¨m2åˆ—ä¸Šå»ºç«‹ç´¢å¼•ï¼Œå› ä¸ºå¯¹m2åˆ—çš„æ¡ä»¶æ˜¯ç­‰å€¼æŸ¥æ‰¾ï¼Œæ¯”å¦‚t2.m2 = 2ã€t2.m2 = 3ç­‰ï¼Œæ‰€ä»¥å¯èƒ½ä½¿ç”¨åˆ°refçš„è®¿é—®æ–¹æ³•ï¼Œå‡è®¾ä½¿ç”¨refçš„è®¿é—®æ–¹æ³•å»æ‰§è¡Œå¯¹t2è¡¨çš„æŸ¥è¯¢çš„è¯ï¼Œéœ€è¦å›è¡¨ä¹‹åå†åˆ¤æ–­t2.n2 &lt; dè¿™ä¸ªæ¡ä»¶æ˜¯å¦æˆç«‹ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„æƒ…å†µï¼Œå°±æ˜¯å‡è®¾m2åˆ—æ˜¯t2è¡¨çš„ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—ï¼Œé‚£ä¹ˆä½¿ç”¨t2.m2 = å¸¸æ•°å€¼è¿™æ ·çš„æ¡ä»¶ä»t2è¡¨ä¸­æŸ¥æ‰¾è®°å½•çš„è¿‡ç¨‹çš„ä»£ä»·å°±æ˜¯å¸¸æ•°çº§åˆ«çš„ã€‚æˆ‘ä»¬çŸ¥é“åœ¨å•è¡¨ä¸­ä½¿ç”¨ä¸»é”®å€¼æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—çš„å€¼è¿›è¡Œç­‰å€¼æŸ¥æ‰¾çš„æ–¹å¼ç§°ä¹‹ä¸ºconstï¼Œè€ŒMySQLæŠŠåœ¨è¿æ¥æŸ¥è¯¢ä¸­å¯¹è¢«é©±åŠ¨è¡¨ä½¿ç”¨ä¸»é”®å€¼æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—çš„å€¼è¿›è¡Œç­‰å€¼æŸ¥æ‰¾çš„æŸ¥è¯¢æ‰§è¡Œæ–¹å¼ç§°ä¹‹ä¸ºï¼šeq_refã€‚ åœ¨n2åˆ—ä¸Šå»ºç«‹ç´¢å¼•ï¼Œæ¶‰åŠåˆ°çš„æ¡ä»¶æ˜¯t2.n2 &lt; &#39;d&#39;ï¼Œå¯èƒ½ç”¨åˆ°rangeçš„è®¿é—®æ–¹æ³•ï¼Œå‡è®¾ä½¿ç”¨rangeçš„è®¿é—®æ–¹æ³•å¯¹t2è¡¨çš„æŸ¥è¯¢çš„è¯ï¼Œéœ€è¦å›è¡¨ä¹‹åå†åˆ¤æ–­åœ¨m2åˆ—ä¸Šçš„æ¡ä»¶æ˜¯å¦æˆç«‹ã€‚ å‡è®¾m2å’Œn2åˆ—ä¸Šéƒ½å­˜åœ¨ç´¢å¼•çš„è¯ï¼Œé‚£ä¹ˆå°±éœ€è¦ä»è¿™ä¸¤ä¸ªé‡Œè¾¹å„¿æŒ‘ä¸€ä¸ªä»£ä»·æ›´ä½çš„å»æ‰§è¡Œå¯¹t2è¡¨çš„æŸ¥è¯¢ã€‚å½“ç„¶ï¼Œå»ºç«‹äº†ç´¢å¼•ä¸ä¸€å®šä½¿ç”¨ç´¢å¼•ï¼Œåªæœ‰åœ¨äºŒçº§ç´¢å¼• + å›è¡¨çš„ä»£ä»·æ¯”å…¨è¡¨æ‰«æçš„ä»£ä»·æ›´ä½æ—¶æ‰ä¼šä½¿ç”¨ç´¢å¼•ã€‚ å¦å¤–ï¼Œæœ‰æ—¶å€™è¿æ¥æŸ¥è¯¢çš„æŸ¥è¯¢åˆ—è¡¨å’Œè¿‡æ»¤æ¡ä»¶ä¸­å¯èƒ½åªæ¶‰åŠè¢«é©±åŠ¨è¡¨çš„éƒ¨åˆ†åˆ—ï¼Œè€Œè¿™äº›åˆ—éƒ½æ˜¯æŸä¸ªç´¢å¼•çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ç§æƒ…å†µä¸‹å³ä½¿ä¸èƒ½ä½¿ç”¨eq_refã€refã€ref_or_nullæˆ–è€…rangeè¿™äº›è®¿é—®æ–¹æ³•æ‰§è¡Œå¯¹è¢«é©±åŠ¨è¡¨çš„æŸ¥è¯¢çš„è¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç´¢å¼•æ‰«æï¼Œä¹Ÿå°±æ˜¯indexçš„è®¿é—®æ–¹æ³•æ¥æŸ¥è¯¢è¢«é©±åŠ¨è¡¨ã€‚æ‰€ä»¥æˆ‘ä»¬å»ºè®®åœ¨çœŸå®å·¥ä½œä¸­æœ€å¥½ä¸è¦ä½¿ç”¨*ä½œä¸ºæŸ¥è¯¢åˆ—è¡¨ï¼Œæœ€å¥½æŠŠçœŸå®ç”¨åˆ°çš„åˆ—ä½œä¸ºæŸ¥è¯¢åˆ—è¡¨ã€‚ 2.3 åŸºäºå—çš„åµŒå¥—å¾ªç¯è¿æ¥æ‰«æä¸€ä¸ªè¡¨çš„è¿‡ç¨‹å…¶å®æ˜¯å…ˆæŠŠè¿™ä¸ªè¡¨ä»ç£ç›˜ä¸ŠåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åä»å†…å­˜ä¸­æ¯”è¾ƒåŒ¹é…æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚ç°å®ç”Ÿæ´»ä¸­çš„è¡¨å¯ä¸åƒt1ã€t2è¿™ç§åªæœ‰3æ¡è®°å½•ï¼Œæˆåƒä¸Šä¸‡æ¡è®°å½•éƒ½æ˜¯å°‘çš„ï¼Œå‡ ç™¾ä¸‡ã€å‡ åƒä¸‡ç”šè‡³å‡ äº¿æ¡è®°å½•çš„è¡¨åˆ°å¤„éƒ½æ˜¯ã€‚å†…å­˜é‡Œå¯èƒ½å¹¶ä¸èƒ½å®Œå…¨å­˜æ”¾çš„ä¸‹è¡¨ä¸­æ‰€æœ‰çš„è®°å½•ï¼Œæ‰€ä»¥åœ¨æ‰«æè¡¨å‰è¾¹è®°å½•çš„æ—¶å€™åè¾¹çš„è®°å½•å¯èƒ½è¿˜åœ¨ç£ç›˜ä¸Šï¼Œç­‰æ‰«æåˆ°åè¾¹è®°å½•çš„æ—¶å€™å¯èƒ½å†…å­˜ä¸è¶³ï¼Œæ‰€ä»¥éœ€è¦æŠŠå‰è¾¹çš„è®°å½•ä»å†…å­˜ä¸­é‡Šæ”¾æ‰ã€‚æˆ‘ä»¬å‰è¾¹åˆè¯´è¿‡ï¼Œé‡‡ç”¨åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•çš„ä¸¤è¡¨è¿æ¥è¿‡ç¨‹ä¸­ï¼Œè¢«é©±åŠ¨è¡¨å¯æ˜¯è¦è¢«è®¿é—®å¥½å¤šæ¬¡çš„ï¼Œå¦‚æœè¿™ä¸ªè¢«é©±åŠ¨è¡¨ä¸­çš„æ•°æ®ç‰¹åˆ«å¤šè€Œä¸”ä¸èƒ½ä½¿ç”¨ç´¢å¼•è¿›è¡Œè®¿é—®ï¼Œé‚£å°±ç›¸å½“äºè¦ä»ç£ç›˜ä¸Šè¯»å¥½å‡ æ¬¡è¿™ä¸ªè¡¨ï¼Œè¿™ä¸ªI/Oä»£ä»·å°±éå¸¸å¤§äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—æƒ³åŠæ³•ï¼šå°½é‡å‡å°‘è®¿é—®è¢«é©±åŠ¨è¡¨çš„æ¬¡æ•°ã€‚ å½“è¢«é©±åŠ¨è¡¨ä¸­çš„æ•°æ®éå¸¸å¤šæ—¶ï¼Œæ¯æ¬¡è®¿é—®è¢«é©±åŠ¨è¡¨ï¼Œè¢«é©±åŠ¨è¡¨çš„è®°å½•ä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œåœ¨å†…å­˜ä¸­çš„æ¯ä¸€æ¡è®°å½•åªä¼šå’Œé©±åŠ¨è¡¨ç»“æœé›†çš„ä¸€æ¡è®°å½•åšåŒ¹é…ï¼Œä¹‹åå°±ä¼šè¢«ä»å†…å­˜ä¸­æ¸…é™¤æ‰ã€‚ç„¶åå†ä»é©±åŠ¨è¡¨ç»“æœé›†ä¸­æ‹¿å‡ºå¦ä¸€æ¡è®°å½•ï¼Œå†ä¸€æ¬¡æŠŠè¢«é©±åŠ¨è¡¨çš„è®°å½•åŠ è½½åˆ°å†…å­˜ä¸­ä¸€éï¼Œå‘¨è€Œå¤å§‹ï¼Œé©±åŠ¨è¡¨ç»“æœé›†ä¸­æœ‰å¤šå°‘æ¡è®°å½•ï¼Œå°±å¾—æŠŠè¢«é©±åŠ¨è¡¨ä»ç£ç›˜ä¸ŠåŠ è½½åˆ°å†…å­˜ä¸­å¤šå°‘æ¬¡ã€‚ å¦‚æœåœ¨æŠŠè¢«é©±åŠ¨è¡¨çš„è®°å½•åŠ è½½åˆ°å†…å­˜çš„æ—¶å€™ï¼Œä¸€æ¬¡æ€§å’Œå¤šæ¡é©±åŠ¨è¡¨ä¸­çš„è®°å½•åšåŒ¹é…ï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¤§å‡å°‘é‡å¤ä»ç£ç›˜ä¸ŠåŠ è½½è¢«é©±åŠ¨è¡¨çš„ä»£ä»·ã€‚ MySQLæå‡ºäº†ä¸€ä¸ªjoin bufferçš„æ¦‚å¿µï¼Œjoin bufferå°±æ˜¯æ‰§è¡Œè¿æ¥æŸ¥è¯¢å‰ç”³è¯·çš„ä¸€å—å›ºå®šå¤§å°çš„å†…å­˜ï¼Œå…ˆæŠŠè‹¥å¹²æ¡é©±åŠ¨è¡¨ç»“æœé›†ä¸­çš„è®°å½•è£…åœ¨è¿™ä¸ªjoin bufferä¸­ï¼Œç„¶åå¼€å§‹æ‰«æè¢«é©±åŠ¨è¡¨ï¼Œæ¯ä¸€æ¡è¢«é©±åŠ¨è¡¨çš„è®°å½•ä¸€æ¬¡æ€§å’Œjoin bufferä¸­çš„å¤šæ¡é©±åŠ¨è¡¨è®°å½•åšåŒ¹é…ï¼Œå› ä¸ºåŒ¹é…çš„è¿‡ç¨‹éƒ½æ˜¯åœ¨å†…å­˜ä¸­å®Œæˆçš„ï¼Œæ‰€ä»¥è¿™æ ·å¯ä»¥æ˜¾è‘—å‡å°‘è¢«é©±åŠ¨è¡¨çš„I/Oä»£ä»·ã€‚ä½¿ç”¨join bufferçš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æœ€å¥½çš„æƒ…å†µæ˜¯join bufferè¶³å¤Ÿå¤§ï¼Œèƒ½å®¹çº³é©±åŠ¨è¡¨ç»“æœé›†ä¸­çš„æ‰€æœ‰è®°å½•ï¼Œè¿™æ ·åªéœ€è¦è®¿é—®ä¸€æ¬¡è¢«é©±åŠ¨è¡¨å°±å¯ä»¥å®Œæˆè¿æ¥æ“ä½œäº†ã€‚MySQLæŠŠè¿™ç§åŠ å…¥äº†join bufferçš„åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•ç§°ä¹‹ä¸ºåŸºäºå—çš„åµŒå¥—è¿æ¥ï¼ˆBlock Nested-Loop Joinï¼‰ç®—æ³•ã€‚ è¿™ä¸ªjoin bufferçš„å¤§å°æ˜¯å¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°æˆ–è€…ç³»ç»Ÿå˜é‡join_buffer_sizeè¿›è¡Œé…ç½®ï¼Œé»˜è®¤å¤§å°ä¸º262144å­—èŠ‚ï¼ˆä¹Ÿå°±æ˜¯256KBï¼‰ï¼Œæœ€å°å¯ä»¥è®¾ç½®ä¸º128å­—èŠ‚ã€‚å½“ç„¶ï¼Œå¯¹äºä¼˜åŒ–è¢«é©±åŠ¨è¡¨çš„æŸ¥è¯¢æ¥è¯´ï¼Œæœ€å¥½æ˜¯ä¸ºè¢«é©±åŠ¨è¡¨åŠ ä¸Šæ•ˆç‡é«˜çš„ç´¢å¼•ï¼Œå¦‚æœå®åœ¨ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œå¹¶ä¸”è‡ªå·±çš„æœºå™¨çš„å†…å­˜ä¹Ÿæ¯”è¾ƒå¤§å¯ä»¥å°è¯•è°ƒå¤§join_buffer_sizeçš„å€¼æ¥å¯¹è¿æ¥æŸ¥è¯¢è¿›è¡Œä¼˜åŒ–ã€‚ å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé©±åŠ¨è¡¨çš„è®°å½•å¹¶ä¸æ˜¯æ‰€æœ‰åˆ—éƒ½ä¼šè¢«æ”¾åˆ°join bufferä¸­ï¼Œåªæœ‰æŸ¥è¯¢åˆ—è¡¨ä¸­çš„åˆ—å’Œè¿‡æ»¤æ¡ä»¶ä¸­çš„åˆ—æ‰ä¼šè¢«æ”¾åˆ°join bufferä¸­ï¼Œæ‰€ä»¥å†æ¬¡æé†’æˆ‘ä»¬ï¼Œæœ€å¥½ä¸è¦æŠŠ*ä½œä¸ºæŸ¥è¯¢åˆ—è¡¨ï¼Œåªéœ€è¦æŠŠæˆ‘ä»¬å…³å¿ƒçš„åˆ—æ”¾åˆ°æŸ¥è¯¢åˆ—è¡¨å°±å¥½äº†ï¼Œè¿™æ ·è¿˜å¯ä»¥åœ¨join bufferä¸­æ”¾ç½®æ›´å¤šçš„è®°å½•ã€‚","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[äº”]InnoDbè¡¨ç©ºé—´","slug":"MySQL/MySQL[äº”]InnoDbè¡¨ç©ºé—´","date":"2022-01-11T03:15:42.796Z","updated":"2022-01-11T03:20:19.117Z","comments":true,"path":"2022/01/11/MySQL/MySQL[äº”]InnoDbè¡¨ç©ºé—´/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E4%BA%94]InnoDb%E8%A1%A8%E7%A9%BA%E9%97%B4/","excerpt":"","text":"åœ¨å‰é¢çš„ä¸¤ç¯‡æ–‡ç« å·²ç»å¯¹InnoDBç´¢å¼•çš„ç»“æ„ï¼Œé¡µå­˜å‚¨ç»“æ„ï¼Œè¡Œæ ¼å¼åšäº†ååˆ†ç»†è‡´çš„åˆ†æï¼Œä¹Ÿè¯¦ç»†é˜è¿°äº†ä¸ºä»€ä¹ˆä½ çš„SQLä¼šæ…¢ï¼Œç´¢å¼•å‘½ä¸­çš„åŸç†ï¼Œæ¥ä¸‹æ¥æˆ‘è¦ç»§ç»­æ·±å…¥å­¦ä¹ MySQLã€‚åœ¨æ­¤ä¹‹å‰è¿˜è¦å…ˆæ¥è¡¥å……ä¸€ä¸‹MySQLçš„ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚ ä¸€ï¼ŒMySQLçš„æ•°æ®ç›®å½•1. æ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿçš„å…³ç³»InnoDB,MyISAMè¿™æ ·çš„å­˜å‚¨å¼•æ“éƒ½æ˜¯æŠŠè¡¨å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œè€Œæ“ä½œç³»ç»Ÿæ˜¯ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæ¥ç®¡ç†ç£ç›˜çš„ã€‚ã€åƒInnoDB,MyISAMè¿™æ ·çš„å­˜å‚¨å¼•æ“éƒ½æ˜¯æŠŠæ•°æ®å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ã€‚ã€‘å½“æˆ‘ä»¬æƒ³è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œè¿™äº›å­˜å‚¨å¼•æ“ä¼šä»æ–‡ä»¶ç³»ç»Ÿä¸­æŠŠæ•°æ®è¯»å‡ºæ¥è¿”å›ç»™æˆ‘ä»¬ï¼Œå½“æˆ‘ä»¬æƒ³å†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œè¿™äº›å­˜å‚¨å¼•æ“åˆä¼šæŠŠæ•°æ®å†™å›åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚ æœ¬å°èŠ‚ä¸»è¦å°±æ˜¯åˆ†æä¸‹InnoDB,MyISAMä¸¤ä¸ªå­˜å‚¨å¼•æ“çš„æ•°æ®æ˜¯å¦‚ä½•åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å­˜å‚¨çš„ã€‚ æˆ‘çš„MySQLç‰ˆæœ¬æ˜¯5.7.28ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„æ“ä½œå’Œåˆ†æéƒ½æ˜¯åŸºäºè¿™ä¸ªå°ç‰ˆæœ¬çš„ã€‚å…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰ç»†å¾®çš„å·®å¼‚ã€‚ 2.MySQLæ•°æ®ç›®å½•MySQLæœåŠ¡å™¨ç¨‹åºåœ¨å¯åŠ¨æ—¶ï¼Œä¼šåˆ°æ–‡ä»¶ç³»ç»Ÿçš„æŸä¸ªç›®å½•ä¸‹åŠ è½½ä¸€äº›æ•°æ®ï¼Œä¹‹åå†è¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ•°æ®ä¹Ÿä¼šå­˜å‚¨åˆ°è¿™ä¸ªç›®å½•ä¸‹çš„æŸäº›æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªç›®å½•å°±æ˜¯æ•°æ®ç›®å½•ã€‚ 2.1 æ•°æ®ç›®å½•å’Œå®‰è£…ç›®å½•çš„åŒºåˆ«MySQLçš„å®‰è£…ç›®å½•æ˜¯åœ¨å®‰è£…MySQLçš„æ—¶å€™æŒ‡å®šçš„å®‰è£…ä½ç½®ï¼Œä¸‹é¢æœ‰ä¸ªå¾ˆé‡è¦çš„binç›®å½•ï¼Œé‡Œé¢å­˜å‚¨ç€æ§åˆ¶å®¢æˆ·ç«¯ç¨‹åºä¸æœåŠ¡å™¨ç¨‹åºçš„å‘½ä»¤ã€‚ MySQLçš„æ•°æ®ç›®å½•æ˜¯ç”¨æ¥å­˜å‚¨MySQLåœ¨è¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ•°æ®ã€‚ 2.2 MySQLçš„æ•°æ®ç›®å½•åœ¨å“ªé‡Œæ•°æ®ç›®å½•å¯¹åº”ç€ä¸€ä¸ªç³»ç»Ÿå˜é‡datadirï¼Œåœ¨ä½¿ç”¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ä»¥åï¼ŒæŸ¥çœ‹è¿™ä¸ªç³»ç»Ÿå˜é‡çš„å€¼å°±çŸ¥é“äº†ï¼š 1show variables like &#x27;datadir&#x27;; ç»“æœå¦‚ä¸‹ï¼š 1234567mysql&gt; show variables like &#x27;datadir&#x27;;+---------------+--------------------+| Variable_name | Value |+---------------+--------------------+| datadir | C:\\yhd\\mysql\\Data\\ |+---------------+--------------------+1 row in set, 1 warning (0.00 sec) 3.æ•°æ®ç›®å½•çš„ç»“æ„3.1 æ•°æ®åº“åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è¡¨ç¤ºæ¯ä¸ªæ•°æ®åº“éƒ½å¯¹åº”ç€æ•°æ®ç›®å½•ä¸‹çš„ä¸€ä¸ªå­ç›®å½•ï¼Œæˆ–è€…è¯´å¯¹åº”ç€ä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“çš„æ—¶å€™ï¼ŒMySQLä¼šå¸®åŠ©æˆ‘ä»¬åšä¸¤ä»¶äº‹ï¼š åœ¨æ•°æ®ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä¸æ•°æ®åº“åŒåçš„æ–‡ä»¶ç›®å½• åœ¨è¯¥å­ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªdb.optæ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¸­åŒ…å«äº†æ•°æ®åº“çš„ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚è¯¥æ•°æ®åº“çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ã€‚ ä¸‹é¢æ¥çœ‹ä¸€ä¸‹æˆ‘çš„MySQLä¸­çš„æ•°æ®åº“ï¼š 1234567891011mysql&gt; show databases;+--------------------+| Database |+--------------------+| information_schema || mysql || performance_schema || sys || yhd |+--------------------+5 rows in set (0.00 sec) å†ä»æ•°æ®ç›®å½•é‡Œçœ‹ä¸€ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233C:\\yhd\\mysql\\Data&gt;dir é©±åŠ¨å™¨ C ä¸­çš„å·æ²¡æœ‰æ ‡ç­¾ã€‚ å·çš„åºåˆ—å·æ˜¯ CA5F-90F5 C:\\yhd\\mysql\\Data çš„ç›®å½•2021/12/19 00:27 &lt;DIR&gt; .2021/12/19 00:27 &lt;DIR&gt; ..2021/12/14 00:00 56 auto.cnf2021/12/14 00:00 1,703 ca-key.pem2021/12/14 00:00 1,131 ca.pem2021/12/14 00:00 1,131 client-cert.pem2021/12/14 00:00 1,707 client-key.pem2021/12/14 00:12 696 DESKTOP-NJIMTJP-slow.log2021/12/18 01:15 25,345 DESKTOP-NJIMTJP.err2021/12/18 01:15 5 DESKTOP-NJIMTJP.pid2021/12/19 02:18 79,691,776 ibdata12021/12/18 01:15 12,582,912 ibtmp12021/12/18 01:15 356 ib_buffer_pool2021/12/19 02:18 50,331,648 ib_logfile02021/12/19 02:18 50,331,648 ib_logfile12021/12/14 00:00 &lt;DIR&gt; mysql2021/12/14 00:00 &lt;DIR&gt; performance_schema2021/12/14 00:00 1,707 private_key.pem2021/12/14 00:00 461 public_key.pem2021/12/14 00:00 1,131 server-cert.pem2021/12/14 00:00 1,707 server-key.pem2021/12/14 00:00 &lt;DIR&gt; sys2021/12/19 00:56 &lt;DIR&gt; yhd 17 ä¸ªæ–‡ä»¶ 192,975,120 å­—èŠ‚ 6 ä¸ªç›®å½• 189,156,126,720 å¯ç”¨å­—èŠ‚C:\\yhd\\mysql\\Data&gt; ä»”ç»†çœ‹ä¼šå‘ç°ï¼Œé™¤äº†information_schemaè¿™ä¸ªæ•°æ®åº“ä»¥å¤–ï¼Œå…¶ä»–çš„æ•°æ®åº“éƒ½å¯¹åº”ä¸€ä¸ªæ–‡ä»¶ç›®å½•ï¼Œè¿™ä¸ªæ•°æ®åº“æœ‰ç‚¹ç‰¹æ®Šï¼Œåé¢åœ¨å…·ä½“åˆ†æã€‚ 3.2 è¡¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è¡¨ç¤ºæˆ‘ä»¬çš„æ•°æ®å…¶å®æ˜¯ä»¥è®°å½•çš„å½¢å¼æ’å…¥åˆ°è¡¨ä¸­çš„ã€‚æ¯ä¸ªè¡¨çš„ä¿¡æ¯å…¶å®å¯ä»¥åˆ†ä¸ºä¸¤ç§ã€‚ è¡¨ç»“æ„ä¿¡æ¯ è¡¨æ•°æ®ä¿¡æ¯ ä¸ºäº†ä¿å­˜è¡¨ç»“æ„ä¿¡æ¯ï¼ŒInnoDB,MyISAMè¿™ä¸¤ç§å­˜å‚¨å¼•æ“éƒ½ä¼šåœ¨æ•°æ®ç›®å½•ä¸‹å¯¹åº”çš„æ•°æ®åº“å­ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºæè¿°è¡¨ç»“æ„çš„æ–‡ä»¶ï¼Œæ–‡ä»¶åæ˜¯è¡¨å.frmã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯äºŒè¿›åˆ¶æ ¼å¼çš„ï¼Œç›´æ¥æ‰“å¼€ä¼šä¹±ç ã€‚ æˆ‘ä»¬çŸ¥é“ä¸åŒçš„å­˜å‚¨å¼•æ“å¯¹äºè¡¨ä¸­çš„æ•°æ®å­˜å‚¨æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸€ä¸‹InnoDB,MyISAMæ˜¯å¦‚ä½•å­˜å‚¨è¡¨ä¸­çš„æ•°æ®çš„ã€‚ InnoDbæ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„æˆ‘ä»¬å†æ¥å›é¡¾ä¸‹ä¸Šä¸€ç¯‡çš„çŸ¥è¯†ï¼š innoDBå…¶å®æ˜¯ä½¿ç”¨é¡µæ¥ä½œä¸ºåŸºæœ¬å•ä½ç®¡ç†å­˜å‚¨ç©ºé—´çš„ï¼Œé»˜è®¤å¤§å°16KBã€‚ å¯¹äºInnoDBå­˜å‚¨å¼•æ“æ¥è¯´ï¼Œæ¯ä¸ªç´¢å¼•éƒ½å¯¹åº”ä¸€é¢—B+æ ‘ï¼Œè¯¥B+æ ‘çš„æ¯ä¸ªç»“ç‚¹éƒ½æ˜¯ä¸€ä¸ªæ•°æ®é¡µã€‚æ•°æ®é¡µä¹‹é—´æ²¡æœ‰å¿…è¦æ˜¯ç‰©ç†è¿ç»­çš„ï¼Œå› ä¸ºæ•°æ®é¡µä¹‹é—´æœ‰åŒå‘é“¾è¡¨æ¥ç»´æŠ¤è¿™äº›é¡µçš„é¡ºåºã€‚ InnoDBçš„èšç°‡ç´¢å¼•çš„å¶å­ç»“ç‚¹å­˜å‚¨äº†å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ç´¢å¼•å³æ•°æ®ï¼Œæ•°æ®å³ç´¢å¼•ã€‚ ä¸ºäº†æ›´å¥½çš„ç®¡ç†è¿™äº›é¡µï¼ŒInnoDBæå‡ºäº†è¡¨ç©ºé—´æˆ–è€…æ–‡ä»¶ç©ºé—´çš„æ¦‚å¿µã€‚è¿™ä¸ªè¡¨ç©ºé—´æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œä»–å¯ä»¥å¯¹åº”æ–‡ä»¶ç³»ç»Ÿä¸Šä¸€ä¸ªæˆ–è€…å¤šä¸ªçœŸå®æ–‡ä»¶ï¼ˆä¸åŒè¡¨ç©ºé—´å¯¹åº”çš„æ–‡ä»¶æ•°é‡å¯èƒ½ä¸åŒï¼‰ã€‚æ¯ä¸€ä¸ªè¡¨ç©ºé—´å¯ä»¥è¢«åˆ’åˆ†ä¸ºå¾ˆå¤šä¸ªé¡µï¼Œè¡¨æ•°æ®è¢«å­˜æ”¾åœ¨æŸä¸ªè¡¨ç©ºé—´ä¸‹çš„æŸäº›é¡µä¸­ã€‚InnoDBå°†è¡¨ç©ºé—´åˆ’åˆ†å‡ ç§ä¸åŒçš„ç±»å‹ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªåˆ†æä¸€ä¸‹å­ã€‚ ç³»ç»Ÿè¡¨ç©ºé—´ è¿™ä¸ªç³»ç»Ÿè¡¨ç©ºé—´å¯ä»¥å¯¹åº”æ–‡ä»¶ç³»ç»Ÿä¸Šä¸€ä¸ªæˆ–è€…å¤šä¸ªå®é™…çš„æ–‡ä»¶ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBä¼šåœ¨æ•°æ®ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸ºibdata1ï¼Œå¤§å°ä¸º12MBçš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯å¯¹åº”çš„ç³»ç»Ÿè¡¨ç©ºé—´åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„è¡¨ç¤ºã€‚æ€ä¹ˆæ‰12MBï¼Ÿè¿™æ˜¯å› ä¸ºè¿™ä¸ªæ–‡ä»¶æ˜¯è‡ªæ‰©å±•æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å½“ä¸å¤Ÿç”¨çš„æ—¶å€™ä¼šè‡ªå·±å¢åŠ æ–‡ä»¶å¤§å°ã€‚ å½“ç„¶ï¼Œå¦‚æœæƒ³è®©ç³»ç»Ÿè¡¨ç©ºé—´å¯¹åº”æ–‡ä»¶ç³»ç»Ÿä¸Šçš„å¤šä¸ªå®é™…æ–‡ä»¶ï¼Œæˆ–è€…ä»…ä»…è§‰å¾—åŸæ¥çš„ibdata1è¿™ä¸ªæ–‡ä»¶åéš¾å¬ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨MySQLæœåŠ¡å¯åŠ¨çš„æ—¶å€™ï¼Œé…ç½®å¯¹åº”çš„æ–‡ä»¶è·¯å¾„ä»¥åŠä»–ä»¬çš„å¤§å°ã€‚æ¯”å¦‚åƒä¸‹é¢è¿™æ ·ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š 12[server]innodb_data_file_path=data1:512M;data2:512M:autoextend è¿™æ ·ï¼Œåœ¨MySQLå¯åŠ¨ä¹‹åä¼šåˆ›å»ºdata1å’Œdata2è¿™ä¸¤ä¸ªå„è‡ª512MBå¤§å°çš„æ–‡ä»¶ä½œä¸ºç³»ç»Ÿè¡¨ç©ºé—´ã€‚å…¶ä¸­çš„autoextendè¡¨æ˜ï¼Œå¦‚æœè¿™ä¸¤ä¸ªæ–‡ä»¶ä¸å¤Ÿç”¨ï¼Œåˆ™ä¼šè‡ªåŠ¨æ‰©å±•data2æ–‡ä»¶çš„å¤§å°ã€‚ æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠç³»ç»Ÿè¡¨ç©ºé—´å¯¹åº”çš„æ–‡ä»¶è·¯å¾„ä¸é…ç½®åˆ°æ•°æ®ç›®å½•ä¸‹ï¼Œç”šè‡³å¯ä»¥é…ç½®åˆ°å•ç‹¬çš„ç£ç›˜åˆ†åŒºä¸Šï¼Œæ¶‰åŠåˆ°çš„å¯åŠ¨å‚æ•°å°±æ˜¯innodb_data_file_pathå’Œinnodb_data_home_dirã€‚ éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨ä¸€ä¸ªMySQLæœåŠ¡å™¨ä¸­ï¼Œç³»ç»Ÿè¡¨ç©ºé—´åªæœ‰ä¸€ä»½ã€‚ä»MySQL5.5.7åˆ°MySQL5.6.6ä¹‹é—´çš„å„ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¡¨ä¸­çš„æ•°æ®éƒ½ä¼šè¢«é»˜è®¤å­˜å‚¨åˆ°è¿™ä¸ª **ç³»ç»Ÿè¡¨ç©ºé—´**ã€‚ ç‹¬ç«‹è¡¨ç©ºé—´ åœ¨MySQL5.6.6ä»¥åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼ŒInnoDBä¸åœ¨é»˜è®¤æŠŠå„ä¸ªè¡¨çš„æ•°æ®å­˜å‚¨åˆ°ç³»ç»Ÿè¡¨ç©ºé—´ï¼Œè€Œæ˜¯ä¸ºæ¯ä¸€ä¸ªè¡¨å»ºç«‹ä¸€ä¸ªç‹¬ç«‹çš„è¡¨ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ›å»ºå¤šå°‘å¼ è¡¨å°±ä¼šå¯¹åº”å¤šå°‘ä¸ªè¡¨ç©ºé—´ã€‚åœ¨ä½¿ç”¨ç‹¬ç«‹è¡¨ç©ºé—´æ¥å­˜å‚¨è¡¨æ•°æ®çš„æ—¶å€™ï¼Œä¼šåœ¨è¯¥è¡¨æ‰€å±çš„æ•°æ®åº“å¯¹åº”çš„å­ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºè¯¥ç‹¬ç«‹è¡¨ç©ºé—´çš„æ–‡ä»¶ï¼Œå…¶æ–‡ä»¶åå’Œè¡¨åç›¸åŒï¼Œåªä¸è¿‡æ·»åŠ äº†ä¸€ä¸ª.ibdæ‰©å±•åã€‚æ‰€ä»¥å®Œæ•´çš„æ–‡ä»¶åç§°ï¼šè¡¨å.ibdã€‚ å‡å¦‚æˆ‘ä»¬ä½¿ç”¨ç‹¬ç«‹è¡¨ç©ºé—´æ¥å­˜å‚¨yhdæ•°æ®åº“ä¸‹çš„person_infoè¡¨ï¼Œé‚£ä¹ˆåœ¨è¯¥æ•°æ®åº“æ‰€å¯¹åº”çš„yhdæ–‡ä»¶ç›®å½•ä¸‹ä¼šä¸ºperson_infoè¡¨åˆ›å»ºä¸‹é¢ä¸¤ä¸ªæ–‡ä»¶ï¼šperson_info.frm,person_info.ibdã€‚ å…¶ä¸­ibdæ–‡ä»¶ç”¨æ¥å­˜å‚¨è¡¨ä¸­çš„æ•°æ®ã€‚å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±æŒ‡å®šæ˜¯ä½¿ç”¨ç³»ç»Ÿè¡¨ç©ºé—´è¿˜æ˜¯ç‹¬ç«‹è¡¨ç©ºé—´æ¥å­˜å‚¨æ•°æ®ã€‚ å…¶ä»–ç±»å‹è¡¨ç©ºé—´ é™¤äº†ä¸Šè¿°ä¸¤ç§è¡¨ç©ºé—´ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›ä¸åŒç±»å‹çš„è¡¨ç©ºé—´ï¼Œæ¯”å¦‚é€šç”¨è¡¨ç©ºé—´ï¼Œundoè¡¨ç©ºé—´ï¼Œä¸´æ—¶è¡¨ç©ºé—´ã€‚ MyISAMæ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„ç´¢å¼•å’Œæ•°æ®åœ¨InnoDBæ˜¯ä¸€å›äº‹ï¼Œä½†æ˜¯MyISAMä¸­çš„ç´¢å¼•ç›¸å½“äºå…¨éƒ¨éƒ½æ˜¯äºŒçº§ç´¢å¼•ï¼Œè¯¥å­˜å‚¨å¼•æ“çš„æ•°æ®å’Œç´¢å¼•æ˜¯åˆ†å¼€å­˜æ”¾çš„ã€‚æ‰€ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ä¹Ÿæ˜¯ä½¿ç”¨ä¸åŒçš„æ–‡ä»¶æ¥å­˜å‚¨æ•°æ®æ–‡ä»¶å’Œç´¢å¼•æ–‡ä»¶ï¼Œè€Œä¸”ä¸InnoDBä¸åŒçš„æ˜¯ï¼ŒMyISAMå¹¶æ²¡æœ‰ä»€ä¹ˆè¡¨ç©ºé—´ä¸€è¯´ï¼Œè¡¨çš„æ•°æ®å’Œç´¢å¼•éƒ½å­˜æ”¾åˆ°å¯¹åº”çš„æ•°æ®åº“å­ç›®å½•ä¸‹ã€‚ å‡è®¾æˆ‘ä»¬person_infoè¡¨ä½¿ç”¨çš„æ˜¯MyISAMå­˜å‚¨å¼•æ“ï¼Œé‚£ä¹ˆåœ¨å®ƒæ‰€åœ¨æ•°æ®åº“å¯¹åº”çš„yhdæ–‡ä»¶ç›®å½•ä¸‹ä¼šä¸ºperson_infoåˆ›å»ºä¸‰ä¸ªæ–‡ä»¶ï¼šperson_info.frm,person_info.MYD,person_info.MYIã€‚ å…¶ä¸­person_info.MYDè¡¨ç¤ºè¡¨çš„æ•°æ®æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æ’å…¥çš„ç”¨æˆ·è®°å½•ï¼Œperson_info.MYIè¡¨ç¤ºè¡¨çš„ç´¢å¼•æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¸ºè¯¥è¡¨åˆ›å»ºçš„ç´¢å¼•éƒ½ä¼šæ”¾åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚ 3.3 å…¶ä»–çš„æ–‡ä»¶é™¤äº†æˆ‘ä»¬ä¸Šè¾¹è¯´çš„è¿™äº›ç”¨æˆ·è‡ªå·±å­˜å‚¨çš„æ•°æ®ä»¥å¤–ï¼Œæ•°æ®ç›®å½•ä¸‹è¿˜åŒ…æ‹¬ä¸ºäº†æ›´å¥½è¿è¡Œç¨‹åºçš„ä¸€äº›é¢å¤–æ–‡ä»¶ï¼Œä¸»è¦åŒ…æ‹¬è¿™å‡ ç§ç±»å‹çš„æ–‡ä»¶ï¼š æœåŠ¡å™¨è¿›ç¨‹æ–‡ä»¶ã€‚æˆ‘ä»¬çŸ¥é“æ¯è¿è¡Œä¸€ä¸ªMySQLæœåŠ¡å™¨ç¨‹åºï¼Œéƒ½æ„å‘³ç€å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ã€‚MySQLæœåŠ¡å™¨ä¼šæŠŠè‡ªå·±çš„è¿›ç¨‹IDå†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ æœåŠ¡å™¨æ—¥å¿—æ–‡ä»¶ã€‚åœ¨æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿå„ç§å„æ ·çš„æ—¥å¿—ï¼Œæ¯”å¦‚å¸¸è§„çš„æŸ¥è¯¢æ—¥å¿—ã€é”™è¯¯æ—¥å¿—ã€äºŒè¿›åˆ¶æ—¥å¿—ã€redoæ—¥å¿—ç­‰å„ç§æ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—å„æœ‰å„çš„ç”¨é€”ï¼Œç°åœ¨å…ˆäº†è§£ä¸€ä¸‹å°±å¯ä»¥äº†ã€‚ é»˜è®¤/è‡ªåŠ¨ç”Ÿæˆçš„SSLå’ŒRSAè¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶ã€‚ä¸»è¦æ˜¯ä¸ºäº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å®‰å…¨é€šä¿¡è€Œåˆ›å»ºçš„ä¸€äº›æ–‡ä»¶ 4.æ–‡ä»¶ç³»ç»Ÿå¯¹æ•°æ®åº“çš„å½±å“å› ä¸ºMySQLçš„æ•°æ®éƒ½æ˜¯å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ï¼Œå°±ä¸å¾—ä¸å—åˆ°æ–‡ä»¶ç³»ç»Ÿçš„ä¸€äº›åˆ¶çº¦ï¼Œè¿™åœ¨æ•°æ®åº“å’Œè¡¨çš„å‘½åã€è¡¨çš„å¤§å°å’Œæ€§èƒ½æ–¹é¢ä½“ç°çš„æ¯”è¾ƒæ˜æ˜¾ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™äº›æ–¹é¢ï¼š æ•°æ®åº“åç§°å’Œè¡¨åç§°ä¸å¾—è¶…è¿‡æ–‡ä»¶ç³»ç»Ÿæ‰€å…è®¸çš„æœ€å¤§é•¿åº¦ã€‚æ¯ä¸ªæ•°æ®åº“éƒ½å¯¹åº”æ•°æ®ç›®å½•çš„ä¸€ä¸ªå­ç›®å½•ï¼Œæ•°æ®åº“åç§°å°±æ˜¯è¿™ä¸ªå­ç›®å½•çš„åç§°ï¼›æ¯ä¸ªè¡¨éƒ½ä¼šåœ¨æ•°æ®åº“å­ç›®å½•ä¸‹äº§ç”Ÿä¸€ä¸ªå’Œè¡¨ååŒåçš„.frmæ–‡ä»¶ï¼Œå¦‚æœæ˜¯InnoDBçš„ç‹¬ç«‹è¡¨ç©ºé—´æˆ–è€…ä½¿ç”¨MyISAMå¼•æ“è¿˜ä¼šæœ‰åˆ«çš„æ–‡ä»¶çš„åç§°ä¸è¡¨åä¸€è‡´ã€‚è¿™äº›ç›®å½•æˆ–æ–‡ä»¶åçš„é•¿åº¦éƒ½å—é™äºæ–‡ä»¶ç³»ç»Ÿæ‰€å…è®¸çš„é•¿åº¦ï½ ç‰¹æ®Šå­—ç¬¦çš„é—®é¢˜ä¸ºäº†é¿å…å› ä¸ºæ•°æ®åº“åå’Œè¡¨åå‡ºç°æŸäº›ç‰¹æ®Šå­—ç¬¦è€Œé€ æˆæ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒçš„æƒ…å†µï¼ŒMySQLä¼šæŠŠæ•°æ®åº“åå’Œè¡¨åä¸­æ‰€æœ‰é™¤æ•°å­—å’Œæ‹‰ä¸å­—æ¯ä»¥å¤–çš„æ‰€æœ‰å­—ç¬¦åœ¨æ–‡ä»¶åé‡Œéƒ½æ˜ å°„æˆ @+ç¼–ç å€¼çš„å½¢å¼ä½œä¸ºæ–‡ä»¶åã€‚æ¯”æ–¹è¯´æˆ‘ä»¬åˆ›å»ºçš„è¡¨çš„åç§°ä¸º&#39;test?&#39;ï¼Œç”±äº?ä¸å±äºæ•°å­—æˆ–è€…æ‹‰ä¸å­—æ¯ï¼Œæ‰€ä»¥ä¼šè¢«æ˜ å°„æˆç¼–ç å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªè¡¨å¯¹åº”çš„.frmæ–‡ä»¶çš„åç§°å°±å˜æˆäº†test@003f.frmã€‚ æ–‡ä»¶é•¿åº¦å—æ–‡ä»¶ç³»ç»Ÿæœ€å¤§é•¿åº¦é™åˆ¶å¯¹äºInnoDBçš„ç‹¬ç«‹è¡¨ç©ºé—´æ¥è¯´ï¼Œæ¯ä¸ªè¡¨çš„æ•°æ®éƒ½ä¼šè¢«å­˜å‚¨åˆ°ä¸€ä¸ªä¸è¡¨ååŒåçš„.ibdæ–‡ä»¶ä¸­ï¼›å¯¹äºMyISAMå­˜å‚¨å¼•æ“æ¥è¯´ï¼Œæ•°æ®å’Œç´¢å¼•ä¼šåˆ†åˆ«å­˜æ”¾åˆ°ä¸è¡¨åŒåçš„.MYDå’Œ.MYIæ–‡ä»¶ä¸­ã€‚è¿™äº›æ–‡ä»¶ä¼šéšç€è¡¨ä¸­è®°å½•çš„å¢åŠ è€Œå¢å¤§ï¼Œå®ƒä»¬çš„å¤§å°å—é™äºæ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„æœ€å¤§æ–‡ä»¶å¤§å°ã€‚ 5.MySQLç³»ç»Ÿæ•°æ®åº“ç®€ä»‹æˆ‘ä»¬å‰è¾¹æåˆ°äº†MySQLçš„å‡ ä¸ªç³»ç»Ÿæ•°æ®åº“ï¼Œè¿™å‡ ä¸ªæ•°æ®åº“åŒ…å«äº†MySQLæœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­æ‰€éœ€çš„ä¸€äº›ä¿¡æ¯ä»¥åŠä¸€äº›è¿è¡ŒçŠ¶æ€ä¿¡æ¯ï¼Œæˆ‘ä»¬ç°åœ¨ç¨å¾®äº†è§£ä¸€ä¸‹ã€‚ mysqlè¿™ä¸ªæ•°æ®åº“è´¼æ ¸å¿ƒï¼Œå®ƒå­˜å‚¨äº†MySQLçš„ç”¨æˆ·è´¦æˆ·å’Œæƒé™ä¿¡æ¯ï¼Œä¸€äº›å­˜å‚¨è¿‡ç¨‹ã€äº‹ä»¶çš„å®šä¹‰ä¿¡æ¯ï¼Œä¸€äº›è¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ—¥å¿—ä¿¡æ¯ï¼Œä¸€äº›å¸®åŠ©ä¿¡æ¯ä»¥åŠæ—¶åŒºä¿¡æ¯ç­‰ã€‚ information_schemaè¿™ä¸ªæ•°æ®åº“ä¿å­˜ç€MySQLæœåŠ¡å™¨ç»´æŠ¤çš„æ‰€æœ‰å…¶ä»–æ•°æ®åº“çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æœ‰å“ªäº›è¡¨ã€å“ªäº›è§†å›¾ã€å“ªäº›è§¦å‘å™¨ã€å“ªäº›åˆ—ã€å“ªäº›ç´¢å¼•ç­‰ç­‰ã€‚è¿™äº›ä¿¡æ¯å¹¶ä¸æ˜¯çœŸå®çš„ç”¨æˆ·æ•°æ®ï¼Œè€Œæ˜¯ä¸€äº›æè¿°æ€§ä¿¡æ¯ï¼Œæœ‰æ—¶å€™ä¹Ÿç§°ä¹‹ä¸ºå…ƒæ•°æ®ã€‚ performance_schemaè¿™ä¸ªæ•°æ®åº“é‡Œä¸»è¦ä¿å­˜MySQLæœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œç®—æ˜¯å¯¹MySQLæœåŠ¡å™¨çš„ä¸€ä¸ªæ€§èƒ½ç›‘æ§ã€‚åŒ…æ‹¬ç»Ÿè®¡æœ€è¿‘æ‰§è¡Œäº†å“ªäº›è¯­å¥ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹çš„æ¯ä¸ªé˜¶æ®µéƒ½èŠ±è´¹äº†å¤šé•¿æ—¶é—´ï¼Œå†…å­˜çš„ä½¿ç”¨æƒ…å†µç­‰ç­‰ä¿¡æ¯ã€‚ sysè¿™ä¸ªæ•°æ®åº“ä¸»è¦æ˜¯é€šè¿‡è§†å›¾çš„å½¢å¼æŠŠinformation_schemaå’Œperformance_schemaç»“åˆèµ·æ¥ï¼Œè®©ç¨‹åºå‘˜å¯ä»¥æ›´æ–¹ä¾¿çš„äº†è§£MySQLæœåŠ¡å™¨çš„ä¸€äº›æ€§èƒ½ä¿¡æ¯ã€‚ äºŒï¼Œå›é¡¾å‰é¢æ•°æ®é¡µï¼ˆä¹Ÿå°±æ˜¯Indexç±»å‹çš„é¡µï¼‰ç”±7éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªéƒ¨åˆ†æ˜¯æ‰€æœ‰ç±»å‹çš„é¡µé¢éƒ½é€šç”¨çš„ã€‚ æ‰€æœ‰ç±»å‹çš„é¡µéƒ½ä¼šåŒ…å«ä¸‹é¢ä¸¤ä¸ªéƒ¨åˆ†ã€‚ File Headerï¼šè®°å½•é¡µé¢çš„ä¸€äº›é€šç”¨ä¿¡æ¯ File Trailer: æ ¡éªŒé¡µæ˜¯å¦å®Œæ•´ï¼Œä¿è¯é¡µé¢åœ¨ä»å†…å­˜åˆ·æ–°åˆ°ç£ç›˜åå†…å®¹æ˜¯ç›¸åŒçš„ åç§° å ç”¨ç©ºé—´å¤§å°ï¼ˆå­—èŠ‚ï¼‰ æè¿° FIL_PAGE_SPACE_OR_CHKSUM 4 é¡µçš„æ ¡éªŒå’Œï¼ˆchecksumå€¼ï¼‰ FIL_PAGE_OFFSET 4 é¡µå· FIL_PAGE_PREV 4 ä¸Šä¸€ä¸ªé¡µçš„é¡µå· FIL_PAGE_NEXT 4 ä¸‹ä¸€ä¸ªé¡µçš„é¡µå· FIL_PAGE_LSN 8 é¡µé¢è¢«æœ€åä¿®æ”¹æ—¶å¯¹åº”çš„æ—¥å¿—åºåˆ—ä½ç½® FIL_PAGE_TYPE 2 è¯¥é¡µçš„ç±»å‹ FIL_PAGE_FILE_FLUSH_LSN 8 ä»…ä»…åœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„ä¸€ä¸ªé¡µä¸­å®šä¹‰ï¼Œä»£è¡¨æ–‡ä»¶è‡³å°‘è¢«åˆ·æ–°åˆ°äº†å¯¹åº”çš„LSNå€¼ FIL_PAGE_ARCH_LOG_NO_OR_SPACE_ID 4 é¡µå±äºå“ªä¸ªè¡¨ç©ºé—´ è¡¨ç©ºé—´ä¸­çš„æ¯ä¸€ä¸ªé¡µéƒ½å¯¹åº”ç€ä¸€ä¸ªé¡µå·ï¼Œä¹Ÿå°±æ˜¯FIL_PAGE_OFFSETï¼Œè¿™ä¸ªé¡µå·ç”±4ä¸ªå­—èŠ‚ç»„æˆï¼Œä¹Ÿå°±æ˜¯32ä¸ªæ¯”ç‰¹ä½ï¼Œæ‰€ä»¥ä¸€ä¸ªè¡¨ç©ºé—´æœ€å¤šå¯ä»¥æ‹¥æœ‰2Â³Â²ä¸ªé¡µï¼Œå¦‚æœæŒ‰ç…§é¡µçš„é»˜è®¤å¤§å°16KBæ¥ç®—ï¼Œä¸€ä¸ªè¡¨ç©ºé—´æœ€å¤šæ”¯æŒ64TBçš„æ•°æ®ã€‚è¡¨ç©ºé—´çš„ç¬¬ä¸€ä¸ªé¡µçš„é¡µå·ä¸º0ï¼Œä¹‹åçš„é¡µå·åˆ†åˆ«æ˜¯1ï¼Œ2ï¼Œ3â€¦ä¾æ­¤ç±»æ¨ æŸäº›ç±»å‹çš„é¡µå¯ä»¥ç»„æˆé“¾è¡¨ï¼Œé“¾è¡¨ä¸­çš„é¡µå¯ä»¥ä¸æŒ‰ç…§ç‰©ç†é¡ºåºå­˜å‚¨ï¼Œè€Œæ˜¯æ ¹æ®FIL_PAGE_PREVå’ŒFIL_PAGE_NEXTæ¥å­˜å‚¨ä¸Šä¸€ä¸ªé¡µå’Œä¸‹ä¸€ä¸ªé¡µçš„é¡µå·ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªå­—æ®µä¸»è¦æ˜¯ä¸ºäº†INDEXç±»å‹çš„é¡µï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰ä¸€ç›´è¯´çš„æ•°æ®é¡µå»ºç«‹B+æ ‘åï¼Œä¸ºæ¯å±‚èŠ‚ç‚¹å»ºç«‹åŒå‘é“¾è¡¨ç”¨çš„ï¼Œä¸€èˆ¬ç±»å‹çš„é¡µæ˜¯ä¸ä½¿ç”¨è¿™ä¸¤ä¸ªå­—æ®µçš„ã€‚ æ¯ä¸ªé¡µçš„ç±»å‹ç”±FIL_PAGE_TYPEè¡¨ç¤ºï¼Œæ¯”å¦‚åƒæ•°æ®é¡µçš„è¯¥å­—æ®µçš„å€¼å°±æ˜¯0x45BFï¼Œä¸åŒç±»å‹çš„é¡µåœ¨è¯¥å­—æ®µä¸Šçš„å€¼æ˜¯ä¸åŒçš„ã€‚ InnoDBæ”¯æŒè®¸å¤šç§ç±»å‹çš„è¡¨ç©ºé—´ï¼Œæˆ‘ä»¬æš‚æ—¶é‡ç‚¹å…³æ³¨ç³»ç»Ÿè¡¨ç©ºé—´å’Œç‹¬ç«‹è¡¨ç©ºé—´çš„ç»“æ„ã€‚ä»–ä»¬ç»“æ„æ¯”è¾ƒç›¸ä¼¼ï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿè¡¨ç©ºé—´ä¸­é¢å¤–åŒ…å«äº†ä¸€äº›å…³äºæ•´ä¸ªç³»ç»Ÿçš„ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆåˆ†æç‹¬ç«‹è¡¨ç©ºé—´ï¼Œå†è¯´ç³»ç»Ÿè¡¨ç©ºé—´ã€‚ ä¸‰ï¼Œç‹¬ç«‹è¡¨ç©ºé—´1.åŒºçš„æ¦‚å¿µä¸ºäº†æ›´å¥½çš„ç®¡ç†è¡¨ä¸­çš„é¡µï¼ŒInnoDBæå‡ºäº†åŒºçš„æ¦‚å¿µã€‚å¯¹äº16KBçš„é¡µæ¥è¯´ï¼Œè¿ç»­çš„64ä¸ªé¡µå°±æ˜¯ä¸€ä¸ªåŒºã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªåŒºé»˜è®¤å ç”¨1Mç©ºé—´ã€‚ä¸è®ºæ˜¯ç³»ç»Ÿè¡¨ç©ºé—´è¿˜æ˜¯ç‹¬ç«‹è¡¨ç©ºé—´ï¼Œéƒ½å¯ä»¥çœ‹æˆæ˜¯ç”±è‹¥å¹²åŒºç»„æˆçš„ï¼Œæ¯256ä¸ªåŒºåˆ’åˆ†ä¸ºä¸€ä¸ªç»„ã€‚ ä¸ºä»€ä¹ˆè¦æœ‰åŒºçš„æ¦‚å¿µï¼Ÿ ä»ç†è®ºä¸Šæ¥è®²ï¼Œä¸å¼•å…¥åŒºçš„æ¦‚å¿µåªä½¿ç”¨é¡µçš„æ¦‚å¿µå¯¹å­˜å‚¨å¼•æ“çš„è¿è¡Œå¹¶æ²¡æœ‰ä»»ä½•å½±å“ï¼Œä½†æ˜¯æˆ‘ä»¬æ¥åˆ†æä¸‹ï¼š æˆ‘ä»¬æ¯å‘è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯å‘è¯¥è¡¨çš„èšç°‡ç´¢å¼•ä»¥åŠæ‰€æœ‰äºŒçº§ç´¢å¼•ä»£è¡¨çš„B+æ ‘çš„èŠ‚ç‚¹ä¸­æ’å…¥æ•°æ®ã€‚è€ŒB+æ ‘çš„æ¯ä¸€å±‚ä¸­çš„é¡µéƒ½ä¼šå½¢æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¦‚æœæ˜¯ä»¥é¡µä¸ºå•ä½æ¥åˆ†é…å­˜å‚¨ç©ºé—´çš„è¯ï¼ŒåŒå‘é“¾è¡¨ç›¸é‚»çš„ä¸¤ä¸ªé¡µä¹‹é—´çš„ç‰©ç†ä½ç½®å¯èƒ½ç¦»å¾—éå¸¸è¿œã€‚ B+æ ‘çš„èŒƒå›´æŸ¥è¯¢åªéœ€è¦å®šä½åˆ°æœ€å·¦è¾¹çš„è®°å½•å’Œæœ€å³è¾¹çš„è®°å½•ï¼Œç„¶åæ²¿ç€åŒå‘é“¾è¡¨ä¸€ç›´æ‰«æå°±å¯ä»¥äº†ï¼Œè€Œå¦‚æœé“¾è¡¨ä¸­ç›¸é‚»çš„ä¸¤ä¸ªé¡µç‰©ç†ä½ç½®ç¦»å¾—éå¸¸è¿œï¼Œå°±æ˜¯æ‰€è°“çš„éšæœºI/Oã€‚ç£ç›˜çš„é€Ÿåº¦å’Œå†…å­˜çš„é€Ÿåº¦å·®äº†å¥½å‡ ä¸ªæ•°é‡çº§ï¼ŒéšæœºI/Oæ˜¯éå¸¸æ…¢çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°½é‡è®©é“¾è¡¨ä¸­ç›¸é‚»çš„é¡µçš„ç‰©ç†ä½ç½®ä¹Ÿç›¸é‚»ï¼Œè¿™æ ·è¿›è¡ŒèŒƒå›´æŸ¥è¯¢çš„æ—¶å€™æ‰å¯ä»¥ä½¿ç”¨æ‰€è°“çš„é¡ºåºI/Oã€‚ æ‰€ä»¥æ‰å¼•å…¥äº†åŒºï¼ˆextentï¼‰çš„æ¦‚å¿µï¼Œä¸€ä¸ªåŒºå°±æ˜¯åœ¨ç‰©ç†ä½ç½®ä¸Šè¿ç»­çš„64ä¸ªé¡µã€‚åœ¨è¡¨ä¸­æ•°æ®é‡å¤§çš„æ—¶å€™ï¼Œä¸ºæŸä¸ªç´¢å¼•åˆ†é…ç©ºé—´çš„æ—¶å€™å°±ä¸å†æŒ‰ç…§é¡µä¸ºå•ä½åˆ†é…äº†ï¼Œè€Œæ˜¯æŒ‰ç…§åŒºä¸ºå•ä½åˆ†é…ï¼Œç”šè‡³åœ¨è¡¨ä¸­çš„æ•°æ®ååˆ†éå¸¸ç‰¹åˆ«å¤šçš„æ—¶å€™ï¼Œå¯ä»¥ä¸€æ¬¡æ€§åˆ†é…å¤šä¸ªè¿ç»­çš„åŒºã€‚è™½ç„¶å¯èƒ½é€ æˆä¸€ç‚¹ç‚¹ç©ºé—´çš„æµªè´¹ï¼ˆæ•°æ®ä¸è¶³å¡«å……æ»¡æ•´ä¸ªåŒºï¼‰ï¼Œä½†æ˜¯ä»æ€§èƒ½è§’åº¦çœ‹ï¼Œå¯ä»¥æ¶ˆé™¤å¾ˆå¤šçš„éšæœºI/Oã€‚ 2.æ®µçš„æ¦‚å¿µèŒƒå›´æŸ¥è¯¢ï¼Œå…¶å®æ˜¯å¯¹B+æ ‘å¶å­èŠ‚ç‚¹ä¸­çš„è®°å½•è¿›è¡Œé¡ºåºæ‰«æï¼Œè€Œå¦‚æœä¸åŒºåˆ†å¶å­èŠ‚ç‚¹å’Œéå¶å­èŠ‚ç‚¹ï¼Œç»Ÿç»ŸæŠŠèŠ‚ç‚¹ä»£è¡¨çš„é¡µé¢æ”¾åˆ°ç”³è¯·åˆ°çš„åŒºä¸­çš„è¯ï¼Œè¿›è¡ŒèŒƒå›´æ‰«æçš„æ•ˆæœå°±å¤§æ‰“æŠ˜æ‰£äº†ã€‚InnoDBå¯¹B+æ ‘çš„å¶å­èŠ‚ç‚¹å’Œéå¶å­èŠ‚ç‚¹è¿›è¡Œäº†åŒºåˆ«å¯¹å¾…ï¼šå¶å­èŠ‚ç‚¹æœ‰è‡ªå·±ç‹¬æœ‰çš„åŒºï¼Œéå¶å­èŠ‚ç‚¹ä¹Ÿæœ‰è‡ªå·±ç‹¬æœ‰çš„åŒºã€‚å­˜æ”¾å¶å­èŠ‚ç‚¹çš„åŒºçš„é›†åˆå°±ç®—æ˜¯ä¸€ä¸ªæ®µï¼ˆsegmentï¼‰ï¼Œå­˜æ”¾éå¶å­èŠ‚ç‚¹çš„åŒºçš„é›†åˆä¹Ÿç®—æ˜¯ä¸€ä¸ªæ®µã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªç´¢å¼•ä¼šç”Ÿæˆ2ä¸ªæ®µï¼Œä¸€ä¸ªå¶å­èŠ‚ç‚¹æ®µï¼Œä¸€ä¸ªéå¶å­èŠ‚ç‚¹æ®µã€‚ é»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“çš„è¡¨åªæœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•ï¼Œä¸€ä¸ªç´¢å¼•ä¼šç”Ÿæˆ2ä¸ªæ®µï¼Œè€Œæ®µæ˜¯ä»¥åŒºä¸ºå•ä½ç”³è¯·å­˜å‚¨ç©ºé—´çš„ï¼Œä¸€ä¸ªåŒºé»˜è®¤å ç”¨1Må­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥é»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªåªå­˜äº†å‡ æ¡è®°å½•çš„å°è¡¨ä¹Ÿéœ€è¦2Mçš„å­˜å‚¨ç©ºé—´ä¹ˆï¼Ÿä»¥åæ¯æ¬¡æ·»åŠ ä¸€ä¸ªç´¢å¼•éƒ½è¦å¤šç”³è¯·2Mçš„å­˜å‚¨ç©ºé—´ä¹ˆï¼Ÿ ä¸ºäº†è€ƒè™‘ä»¥å®Œæ•´çš„åŒºä¸ºå•ä½åˆ†é…ç»™æŸä¸ªæ®µå¯¹äºæ•°æ®é‡è¾ƒå°çš„è¡¨å¤ªæµªè´¹å­˜å‚¨ç©ºé—´çš„è¿™ç§æƒ…å†µï¼ŒInnoDBæå‡ºäº†ç¢ç‰‡åŒºçš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ªç¢ç‰‡åŒºä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„é¡µéƒ½æ˜¯ä¸ºäº†å­˜å‚¨åŒä¸€ä¸ªæ®µçš„æ•°æ®è€Œå­˜åœ¨çš„ï¼Œè€Œæ˜¯ç¢ç‰‡åŒºä¸­çš„é¡µå¯ä»¥ç”¨äºä¸åŒçš„ç›®çš„ï¼Œæ¯”å¦‚æœ‰äº›é¡µç”¨äºæ®µAï¼Œæœ‰äº›é¡µç”¨äºæ®µBï¼Œæœ‰äº›é¡µç”šè‡³å“ªä¸ªæ®µéƒ½ä¸å±äºã€‚ç¢ç‰‡åŒºç›´å±äºè¡¨ç©ºé—´ï¼Œå¹¶ä¸å±äºä»»ä½•ä¸€ä¸ªæ®µã€‚æ‰€ä»¥æ­¤åä¸ºæŸä¸ªæ®µåˆ†é…å­˜å‚¨ç©ºé—´çš„ç­–ç•¥æ˜¯è¿™æ ·çš„ï¼š åœ¨åˆšå¼€å§‹å‘è¡¨ä¸­æ’å…¥æ•°æ®çš„æ—¶å€™ï¼Œæ®µæ˜¯ä»æŸä¸ªç¢ç‰‡åŒºä»¥å•ä¸ªé¡µé¢ä¸ºå•ä½æ¥åˆ†é…å­˜å‚¨ç©ºé—´çš„ å½“æŸä¸ªæ®µå·²ç»å ç”¨äº†32ä¸ªç¢ç‰‡åŒºé¡µé¢ä¹‹åï¼Œå°±ä¼šä»¥å®Œæ•´çš„åŒºä¸ºå•ä½æ¥åˆ†é…å­˜å‚¨ç©ºé—´ æ‰€ä»¥ç°åœ¨æ®µä¸èƒ½ä»…å®šä¹‰ä¸ºæ˜¯æŸäº›åŒºçš„é›†åˆï¼Œæ›´ç²¾ç¡®çš„åº”è¯¥æ˜¯æŸäº›é›¶æ•£çš„é¡µé¢ä»¥åŠä¸€äº›å®Œæ•´çš„åŒºçš„é›†åˆã€‚é™¤äº†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹æ®µå’Œéå¶å­èŠ‚ç‚¹æ®µä¹‹å¤–ï¼ŒInnoDBä¸­è¿˜æœ‰ä¸ºå­˜å‚¨ä¸€äº›ç‰¹æ®Šçš„æ•°æ®è€Œå®šä¹‰çš„æ®µï¼Œæ¯”å¦‚å›æ»šæ®µï¼Œå½“ç„¶æˆ‘ä»¬ç°åœ¨å¹¶ä¸å…³å¿ƒåˆ«çš„ç±»å‹çš„æ®µï¼Œç°åœ¨åªéœ€è¦çŸ¥é“æ®µæ˜¯ä¸€äº›é›¶æ•£çš„é¡µé¢ä»¥åŠä¸€äº›å®Œæ•´çš„åŒºçš„é›†åˆå°±å¥½äº†ã€‚ æœ‰çš„æ—¶å€™å¤„äºä¸åŒçš„é˜¶æ®µï¼Œå¯¹äºæŸä¸ªæ¦‚å¿µçš„å®šä¹‰æˆ–è€…ç†è§£æ˜¯ä¸åŒçš„ï¼Œéšç€çŸ¥è¯†æ°´å¹³çš„æå‡åç»­å†æ¥é€æ¸å®Œå–„ï¼Œå°±åƒå°å­¦çš„æ—¶å€™è€å¸ˆä¼šå‘Šè¯‰ä½ æœ€å°çš„æ•°æ˜¯0ï¼Œä¸­å­¦åˆå‘Šè¯‰ä½ æœ€å°çš„æ•°æ˜¯è´Ÿæ— ç©·ä¸€æ ·ã€‚ 3.åŒºçš„åˆ†ç±»æ¯ä¸ªåŒºéƒ½å¯¹åº”ä¸€ä¸ªXDES Entryç»“æ„ï¼Œè¿™ä¸ªç»“æ„ä¸­å­˜å‚¨äº†ä¸€äº›ä¸è¿™ä¸ªåŒºæœ‰å…³çš„å±æ€§ã€‚è¿™äº›åŒºå¯ä»¥è¢«åˆ†ä¸ºä¸‹é¢å››ç§ç±»å‹ã€‚ ç©ºé—²çš„åŒºï¼šç°åœ¨è¿˜æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªåŒºä¸­çš„ä»»ä½•é¡µé¢ï¼Œè¿™äº›åŒºä¼šè¢«åŠ å…¥åˆ°FREEé“¾è¡¨ã€‚ æœ‰å‰©ä½™ç©ºé—´çš„ç¢ç‰‡åŒºï¼šè¡¨ç¤ºç¢ç‰‡åŒºä¸­è¿˜æœ‰å¯ç”¨çš„é¡µé¢ï¼Œè¿™äº›åŒºä¼šè¢«åŠ å…¥åˆ°FREE_FRAGé“¾è¡¨ã€‚ æ²¡æœ‰å‰©ä½™ç©ºé—´çš„ç¢ç‰‡åŒºï¼šè¡¨ç¤ºç¢ç‰‡åŒºä¸­çš„æ‰€æœ‰é¡µé¢éƒ½è¢«ä½¿ç”¨ï¼Œæ²¡æœ‰ç©ºé—²é¡µé¢ï¼›è¿™äº›åŒºä¼šè¢«åŠ å…¥åˆ°FULL_FRAGé“¾è¡¨ã€‚ é™„å±äºæŸä¸ªæ®µçš„åŒºã€‚æ¯ä¸€ä¸ªç´¢å¼•éƒ½å¯ä»¥åˆ†ä¸ºå¶å­èŠ‚ç‚¹æ®µå’Œéå¶å­èŠ‚ç‚¹æ®µï¼Œé™¤æ­¤ä¹‹å¤–InnoDBè¿˜ä¼šå¦å¤–å®šä¹‰ä¸€äº›ç‰¹æ®Šä½œç”¨çš„æ®µï¼Œåœ¨è¿™äº›æ®µä¸­çš„æ•°æ®é‡å¾ˆå¤§æ—¶å°†ä½¿ç”¨åŒºæ¥ä½œä¸ºåŸºæœ¬çš„åˆ†é…å•ä½ï¼›æ¯ä¸ªæ®µæ‰€å±çš„åŒºåˆä¼šè¢«ç»„ç»‡æˆä¸‹é¢å‡ ç§é“¾è¡¨ã€‚ FREEé“¾è¡¨ï¼šåœ¨åŒä¸€ä¸ªæ®µä¸­ï¼Œæ‰€æœ‰é¡µé¢éƒ½æ˜¯ç©ºé—²é¡µé¢çš„åŒºå¯¹åº”çš„XDES Entryç»“æ„ä¼šè¢«åŠ å…¥åˆ°è¿™ä¸ªé“¾è¡¨ã€‚ NOT_FULLé“¾è¡¨ï¼šåœ¨åŒä¸€ä¸ªæ®µä¸­ï¼Œä»æœ‰ç©ºé—²é¡µé¢çš„åŒºå¯¹åº”çš„XDES Entryç»“æ„ä¼šè¢«åŠ å…¥åˆ°è¿™ä¸ªé“¾è¡¨ã€‚ FULLé“¾è¡¨ï¼šåœ¨åŒä¸€ä¸ªæ®µä¸­ï¼Œå·²ç»æ²¡æœ‰ç©ºé—²é¡µé¢çš„åŒºå¯¹åº”çš„XDES Entryç»“æ„ä¼šè¢«åŠ å…¥åˆ°è¿™ä¸ªé“¾è¡¨ã€‚ è¿™å››ç§ç±»å‹çš„åŒºä¹Ÿè¢«å«åšåŒºçš„å››ç§çŠ¶æ€ã€‚ çŠ¶æ€å å«ä¹‰ FREE ç©ºé—²çš„åŒº FREE_FRAG æœ‰å‰©ä½™ç©ºé—´çš„ç¢ç‰‡åŒº FULL_FRAG æ²¡æœ‰å‰©ä½™ç©ºé—´çš„ç¢ç‰‡åŒº FSEG é™„å±äºæŸä¸ªæ®µçš„åŒº å¤„äº**FREE**ã€**FREE_FRAG**ä»¥åŠ**FULL_FRAG**è¿™ä¸‰ç§çŠ¶æ€çš„åŒºéƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œç®—æ˜¯ç›´å±äºè¡¨ç©ºé—´ï¼›è€Œå¤„äº**FSEG**çŠ¶æ€çš„åŒºæ˜¯é™„å±äºæŸä¸ªæ®µçš„ã€‚ æ¯ä¸ªæ®µéƒ½ä¼šå¯¹åº”ä¸€ä¸ªINODE Entryç»“æ„ï¼Œè¯¥ç»“æ„ä¸­å­˜å‚¨äº†ä¸€äº›ä¸è¿™ä¸ªæ®µæœ‰å…³çš„å±æ€§ã€‚ è¡¨ç©ºé—´ä¸­ç¬¬ä¸€ä¸ªé¡µé¢çš„ç±»å‹ä¸ºFSP_HDRï¼Œå®ƒå­˜å‚¨äº†è¡¨ç©ºé—´çš„ä¸€äº›æ•´ä½“å±æ€§ä»¥åŠç¬¬ä¸€ä¸ªç»„å†…256ä¸ªåŒºå¯¹åº”çš„XDES Entryç»“æ„ã€‚ é™¤äº†è¡¨ç©ºé—´çš„ç¬¬ä¸€ä¸ªç»„ä»¥å¤–ï¼Œå…¶ä½™ç»„çš„ç¬¬ä¸€ä¸ªé¡µé¢çš„ç±»å‹ä¸ºXDESï¼Œè¿™ç§é¡µé¢çš„ç»“æ„å’ŒFSP_HDRç±»å‹çš„é¡µé¢å¯¹æ¯”ï¼Œé™¤äº†å°‘äº†File Space headerï¼ˆè®°å½•è¡¨ç©ºé—´æ•´ä½“å±æ€§çš„éƒ¨åˆ†ï¼‰éƒ¨åˆ†ä¹‹å¤–ï¼Œå…¶ä½™éƒ¨åˆ†æ˜¯ä¸€æ ·çš„ã€‚ æ¯ä¸ªç»„çš„ç¬¬äºŒä¸ªé¡µé¢ç±»å‹ä¸ºIBUF_BITMAPï¼Œå­˜å‚¨äº†ä¸€äº›å…³äºChange Bufferçš„ä¿¡æ¯ã€‚ è¡¨ç©ºé—´ä¸­ç¬¬ä¸€ä¸ªç»„çš„ç¬¬ä¸‰ä¸ªé¡µé¢çš„ç±»å‹æ˜¯INODEï¼Œä»–æ˜¯ä¸ºäº†å­˜å‚¨INODE Entryç»“æ„è€Œè®¾è®¡çš„ï¼Œè¿™ç§ç±»å‹çš„é¡µé¢ä¼šç»„ç»‡æˆä¸‹é¢ä¸¤ä¸ªé“¾è¡¨ã€‚ SEG_INODES_FULLé“¾è¡¨ï¼šåœ¨è¯¥é“¾è¡¨ä¸­ï¼ŒINODEç±»å‹çš„é¡µé¢ä¸­å·²ç»æ²¡æœ‰ç©ºé—²ç©ºé—´æ¥å­˜å‚¨é¢å¤–çš„INODE Entryç»“æ„ã€‚ SEG_INODES_FREEé“¾è¡¨ï¼šåœ¨è¯¥é“¾è¡¨ä¸­ï¼ŒINODEç±»å‹çš„é¡µé¢ä¸­è¿˜æœ‰ç©ºé—²ç©ºé—´æ¥å­˜å‚¨é¢å¤–çš„INODE Entryç»“æ„ã€‚ 4. Segment Headerä¸€ä¸ªç´¢å¼•ä¼šäº§ç”Ÿä¸¤ä¸ªæ®µï¼Œåˆ†åˆ«æ˜¯å¶å­èŠ‚ç‚¹æ®µå’Œéå¶å­èŠ‚ç‚¹æ®µï¼Œè€Œæ¯ä¸ªæ®µéƒ½ä¼šå¯¹åº”ä¸€ä¸ªINODE Entryç»“æ„ï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆçŸ¥é“æŸä¸ªæ®µå¯¹åº”å“ªä¸ª**INODE Entry**ç»“æ„å‘¢ï¼Ÿæ‰€ä»¥å¾—æ‰¾ä¸ªåœ°æ–¹è®°ä¸‹æ¥è¿™ä¸ªå¯¹åº”å…³ç³»ã€‚INDEXç±»å‹çš„é¡µæ—¶æœ‰ä¸€ä¸ªPage Headeréƒ¨åˆ†ï¼Œå…¶ä¸­çš„PAGE_BTR_SEG_LEAFå’ŒPAGE_BTR_SEG_TOPéƒ½å ç”¨10ä¸ªå­—èŠ‚ï¼Œå®ƒä»¬å…¶å®å¯¹åº”ä¸€ä¸ªå«Segment Headerçš„ç»“æ„ï¼Œè¯¥ç»“æ„å›¾ç¤ºå¦‚ä¸‹ï¼š å„ä¸ªéƒ¨åˆ†çš„å…·ä½“é‡Šä¹‰å¦‚ä¸‹ï¼š åç§° å ç”¨å­—èŠ‚æ•° æè¿° Space ID of the INODE Entry 4 INODE Entryç»“æ„æ‰€åœ¨çš„è¡¨ç©ºé—´ID Page Number of the INODE Entry 4 INODE Entryç»“æ„æ‰€åœ¨çš„é¡µé¢é¡µå· Byte Offset of the INODE Ent 2 INODE Entryç»“æ„åœ¨è¯¥é¡µé¢ä¸­çš„åç§»é‡ PAGE_BTR_SEG_LEAFè®°å½•ç€å¶å­èŠ‚ç‚¹æ®µå¯¹åº”çš„INODE Entryç»“æ„çš„åœ°å€æ˜¯å“ªä¸ªè¡¨ç©ºé—´çš„å“ªä¸ªé¡µé¢çš„å“ªä¸ªåç§»é‡ï¼ŒPAGE_BTR_SEG_TOPè®°å½•ç€éå¶å­èŠ‚ç‚¹æ®µå¯¹åº”çš„INODE Entryç»“æ„çš„åœ°å€æ˜¯å“ªä¸ªè¡¨ç©ºé—´çš„å“ªä¸ªé¡µé¢çš„å“ªä¸ªåç§»é‡ã€‚è¿™æ ·å­ç´¢å¼•å’Œå…¶å¯¹åº”çš„æ®µçš„å…³ç³»å°±å»ºç«‹èµ·æ¥äº†ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå› ä¸ºä¸€ä¸ªç´¢å¼•åªå¯¹åº”ä¸¤ä¸ªæ®µï¼Œæ‰€ä»¥åªéœ€è¦åœ¨ç´¢å¼•çš„æ ¹é¡µé¢ä¸­è®°å½•è¿™ä¸¤ä¸ªç»“æ„å³å¯ã€‚ å…¶å®Segment Headerçš„ä½œç”¨å°±æ˜¯è®°å½•å“ªä¸ªæ®µå¯¹åº”å“ªä¸ªINODE Entryç»“æ„çš„ã€‚ 5. çœŸå®è¡¨ç©ºé—´å¯¹åº”çš„æ–‡ä»¶å¤§å°ä¸€ä¸ªæ–°å»ºçš„è¡¨å¯¹åº”çš„.ibdæ–‡ä»¶åªå ç”¨äº†96KBï¼Œæ‰6ä¸ªé¡µçš„å¤§å°ã€‚åˆšå¼€å§‹çš„æ—¶å€™ï¼Œè¡¨ç©ºé—´å ç”¨ç©ºé—´è‡ªç„¶å¾ˆå°ï¼Œå› ä¸ºè¡¨é‡Œé¢æ²¡æœ‰æ•°æ®ã€‚ä¸è¿‡ï¼Œibdæ–‡ä»¶æ˜¯è‡ªæ‰©å±•æ–‡ä»¶ï¼Œéšç€æ•°æ®çš„å¢å¤šæ–‡ä»¶ä¹Ÿåœ¨é€æ¸å¢å¤§ã€‚ å››ï¼Œç³»ç»Ÿè¡¨ç©ºé—´ç³»ç»Ÿè¡¨ç©ºé—´çš„ç»“æ„å’Œç‹¬ç«‹è¡¨ç©ºé—´åŸºæœ¬ç±»ä¼¼ï¼Œåªä¸è¿‡ç”±äºæ•´ä¸ªMySQLè¿›ç¨‹åªæœ‰ä¸€ä¸ªç³»ç»Ÿè¡¨ç©ºé—´ï¼Œåœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ä¼šé¢å¤–è®°å½•ä¸€äº›æœ‰å…³æ•´ä¸ªç³»ç»Ÿä¿¡æ¯çš„é¡µé¢ï¼Œæ‰€ä»¥ä¼šæ¯”ç‹¬ç«‹è¡¨ç©ºé—´å¤šå‡ºä¸€äº›è®°å½•è¿™äº›ä¿¡æ¯çš„é¡µé¢ã€‚å› ä¸ºè¿™ä¸ªç³»ç»Ÿè¡¨ç©ºé—´ç›¸å½“äºæ˜¯è¡¨ç©ºé—´ä¹‹é¦–ï¼Œæ‰€ä»¥å®ƒçš„è¡¨ç©ºé—´ IDï¼ˆSpace IDï¼‰æ˜¯0ã€‚ 1.ç³»ç»Ÿè¡¨ç©ºé—´çš„æ•´ä½“ç»“æ„ç³»ç»Ÿè¡¨ç©ºé—´ä¸ç‹¬ç«‹è¡¨ç©ºé—´çš„ä¸€ä¸ªéå¸¸æ˜æ˜¾çš„ä¸åŒä¹‹å¤„å°±æ˜¯åœ¨è¡¨ç©ºé—´å¼€å¤´æœ‰è®¸å¤šè®°å½•æ•´ä¸ªç³»ç»Ÿå±æ€§çš„é¡µé¢ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿè¡¨ç©ºé—´å’Œç‹¬ç«‹è¡¨ç©ºé—´çš„å‰ä¸‰ä¸ªé¡µé¢ï¼ˆé¡µå·åˆ†åˆ«ä¸º0ã€1ã€2ï¼Œç±»å‹åˆ†åˆ«æ˜¯FSP_HDRã€IBUF_BITMAPã€INODEï¼‰çš„ç±»å‹æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯é¡µå·ä¸º3ï½7çš„é¡µé¢æ˜¯ç³»ç»Ÿè¡¨ç©ºé—´ç‰¹æœ‰çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™äº›å¤šå‡ºæ¥çš„é¡µé¢éƒ½æ˜¯å¹²å•¥ä½¿çš„ï¼š é¡µå· é¡µé¢ç±»å‹ è‹±æ–‡æè¿° æè¿° 3 SYS Insert Buffer Header å­˜å‚¨Insert Bufferçš„å¤´éƒ¨ä¿¡æ¯ 4 INDEX Insert Buffer Root å­˜å‚¨Insert Bufferçš„æ ¹é¡µé¢ 5 TRX_SYS Transaction System äº‹åŠ¡ç³»ç»Ÿçš„ç›¸å…³ä¿¡æ¯ 6 SYS First Rollback Segment ç¬¬ä¸€ä¸ªå›æ»šæ®µçš„é¡µé¢ 7 SYS Data Dictionary Header æ•°æ®å­—å…¸å¤´éƒ¨ä¿¡æ¯ é™¤äº†è¿™å‡ ä¸ªè®°å½•ç³»ç»Ÿå±æ€§çš„é¡µé¢ä¹‹å¤–ï¼Œç³»ç»Ÿè¡¨ç©ºé—´çš„extent 1å’Œextent 2è¿™ä¸¤ä¸ªåŒºï¼Œä¹Ÿå°±æ˜¯é¡µå·ä»64~`191è¿™128ä¸ªé¡µé¢è¢«ç§°ä¸ºDoublewrite buffer`ï¼Œä¹Ÿå°±æ˜¯åŒå†™ç¼“å†²åŒºã€‚ä¸è¿‡ä¸Šè¿°çš„å¤§éƒ¨åˆ†çŸ¥è¯†éƒ½æ¶‰åŠåˆ°äº†äº‹åŠ¡å’Œå¤šç‰ˆæœ¬æ§åˆ¶çš„é—®é¢˜ï¼Œç°åœ¨æˆ‘ä»¬åªåˆ†ææœ‰å…³InnoDBæ•°æ®å­—å…¸çš„çŸ¥è¯†ï¼Œå…¶ä½™çš„æ¦‚å¿µåœ¨åè¾¹å†çœ‹ã€‚ 1.1 InnoDBæ•°æ®å­—å…¸æ¯å½“æˆ‘ä»¬å‘ä¸€ä¸ªè¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼ŒMySQLå…ˆè¦æ ¡éªŒä¸€ä¸‹æ’å…¥è¯­å¥å¯¹åº”çš„è¡¨å­˜ä¸å­˜åœ¨ï¼Œæ’å…¥çš„åˆ—å’Œè¡¨ä¸­çš„åˆ—æ˜¯å¦ç¬¦åˆï¼Œå¦‚æœè¯­æ³•æ²¡æœ‰é—®é¢˜çš„è¯ï¼Œè¿˜éœ€è¦çŸ¥é“è¯¥è¡¨çš„èšç°‡ç´¢å¼•å’Œæ‰€æœ‰äºŒçº§ç´¢å¼•å¯¹åº”çš„æ ¹é¡µé¢æ˜¯å“ªä¸ªè¡¨ç©ºé—´çš„å“ªä¸ªé¡µé¢ï¼Œç„¶åæŠŠè®°å½•æ’å…¥å¯¹åº”ç´¢å¼•çš„B+æ ‘ä¸­ã€‚æ‰€ä»¥è¯´ï¼ŒMySQLé™¤äº†ä¿å­˜ç€æˆ‘ä»¬æ’å…¥çš„ç”¨æˆ·æ•°æ®ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä¿å­˜è®¸å¤šé¢å¤–çš„ä¿¡æ¯ï¼Œæ¯”æ–¹è¯´ï¼š æŸä¸ªè¡¨å±äºå“ªä¸ªè¡¨ç©ºé—´ï¼Œè¡¨é‡Œè¾¹æœ‰å¤šå°‘åˆ— è¡¨å¯¹åº”çš„æ¯ä¸€ä¸ªåˆ—çš„ç±»å‹æ˜¯ä»€ä¹ˆ è¯¥è¡¨æœ‰å¤šå°‘ç´¢å¼•ï¼Œæ¯ä¸ªç´¢å¼•å¯¹åº”å“ªå‡ ä¸ªå­—æ®µï¼Œè¯¥ç´¢å¼•å¯¹åº”çš„æ ¹é¡µé¢åœ¨å“ªä¸ªè¡¨ç©ºé—´çš„å“ªä¸ªé¡µé¢ è¯¥è¡¨æœ‰å“ªäº›å¤–é”®ï¼Œå¤–é”®å¯¹åº”å“ªä¸ªè¡¨çš„å“ªäº›åˆ— æŸä¸ªè¡¨ç©ºé—´å¯¹åº”æ–‡ä»¶ç³»ç»Ÿä¸Šæ–‡ä»¶è·¯å¾„æ˜¯ä»€ä¹ˆ ä¸Šè¿°è¿™äº›æ•°æ®å¹¶ä¸æ˜¯æˆ‘ä»¬ä½¿ç”¨INSERTè¯­å¥æ’å…¥çš„ç”¨æˆ·æ•°æ®ï¼Œå®é™…ä¸Šæ˜¯ä¸ºäº†æ›´å¥½çš„ç®¡ç†æˆ‘ä»¬è¿™äº›ç”¨æˆ·æ•°æ®è€Œä¸å¾—å·²å¼•å…¥çš„ä¸€äº›é¢å¤–æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¹Ÿç§°ä¸ºå…ƒæ•°æ®ã€‚InnoDBå­˜å‚¨å¼•æ“ç‰¹æ„å®šä¹‰äº†ä¸€äº›åˆ—çš„å†…éƒ¨ç³»ç»Ÿè¡¨ï¼ˆinternal system tableï¼‰æ¥è®°å½•è¿™äº›è¿™äº›å…ƒæ•°æ®ï¼š è¡¨å æè¿° SYS_TABLES æ•´ä¸ªInnoDBå­˜å‚¨å¼•æ“ä¸­æ‰€æœ‰çš„è¡¨çš„ä¿¡æ¯ SYS_COLUMNS æ•´ä¸ªInnoDBå­˜å‚¨å¼•æ“ä¸­æ‰€æœ‰çš„åˆ—çš„ä¿¡æ¯ SYS_INDEXES æ•´ä¸ªInnoDBå­˜å‚¨å¼•æ“ä¸­æ‰€æœ‰çš„ç´¢å¼•çš„ä¿¡æ¯ SYS_FIELDS æ•´ä¸ªInnoDBå­˜å‚¨å¼•æ“ä¸­æ‰€æœ‰çš„ç´¢å¼•å¯¹åº”çš„åˆ—çš„ä¿¡æ¯ SYS_FOREIGN æ•´ä¸ªInnoDBå­˜å‚¨å¼•æ“ä¸­æ‰€æœ‰çš„å¤–é”®çš„ä¿¡æ¯ SYS_FOREIGN_COLS æ•´ä¸ªInnoDBå­˜å‚¨å¼•æ“ä¸­æ‰€æœ‰çš„å¤–é”®å¯¹åº”åˆ—çš„ä¿¡æ¯ SYS_TABLESPACES æ•´ä¸ªInnoDBå­˜å‚¨å¼•æ“ä¸­æ‰€æœ‰çš„è¡¨ç©ºé—´ä¿¡æ¯ SYS_DATAFILES æ•´ä¸ªInnoDBå­˜å‚¨å¼•æ“ä¸­æ‰€æœ‰çš„è¡¨ç©ºé—´å¯¹åº”æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶è·¯å¾„ä¿¡æ¯ SYS_VIRTUAL æ•´ä¸ªInnoDBå­˜å‚¨å¼•æ“ä¸­æ‰€æœ‰çš„è™šæ‹Ÿç”Ÿæˆåˆ—çš„ä¿¡æ¯ è¿™äº›ç³»ç»Ÿè¡¨ä¹Ÿè¢«ç§°ä¸ºæ•°æ®å­—å…¸ï¼Œå®ƒä»¬éƒ½æ˜¯ä»¥B+æ ‘çš„å½¢å¼ä¿å­˜åœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„æŸäº›é¡µé¢ä¸­ï¼Œå…¶ä¸­SYS_TABLESã€SYS_COLUMNSã€SYS_INDEXESã€SYS_FIELDSè¿™å››ä¸ªè¡¨å°¤å…¶é‡è¦ï¼Œç§°ä¹‹ä¸ºåŸºæœ¬ç³»ç»Ÿè¡¨ï¼ˆbasic system tablesï¼‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹è¿™4ä¸ªè¡¨çš„ç»“æ„ï¼š 1.2 SYS_TABLESè¡¨ åˆ—å æè¿° name è¡¨çš„åç§° id InnoDBå­˜å‚¨å¼•æ“æ¯ä¸€å¼ è¡¨éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ID n_cols è¯¥è¡¨æ‹¥æœ‰çš„åˆ—çš„ä¸ªæ•° type è¡¨çš„ç±»å‹ï¼Œè®°å½•äº†ä¸€äº›æ–‡ä»¶æ ¼å¼ï¼Œè¡Œæ ¼å¼ï¼Œå‹ç¼©ç­‰ä¿¡æ¯ Mix_id å·²ç»è¿‡æ—¶ï¼Œå¿½ç•¥ Mix_len è¡¨çš„ä¸€äº›é¢å¤–å±æ€§ Cluster_id æœªä½¿ç”¨ï¼Œå¿½ç•¥ Space è¯¥è¡¨æ‰€å±ç©ºé—´çš„ID è¿™ä¸ªSYS_TABLESè¡¨æœ‰ä¸¤ä¸ªç´¢å¼•ï¼š ä»¥NAMEåˆ—ä¸ºä¸»é”®çš„èšç°‡ç´¢å¼• ä»¥IDåˆ—å»ºç«‹çš„äºŒçº§ç´¢å¼• 1.3 SYS_COLUMNSè¡¨ åˆ—å æè¿° TABLE_ID è¯¥åˆ—æ‰€å±è¡¨å¯¹åº”çš„ID POS è¯¥åˆ—åœ¨è¡¨ä¸­æ˜¯ç¬¬å‡ åˆ— NAME è¯¥åˆ—çš„åç§° MTYPE main data typeï¼Œä¸»æ•°æ®ç±»å‹ï¼Œå°±æ˜¯é‚£å †INTã€CHARã€VARCHARã€FLOATã€DOUBLEç­‰ PRTYPE precise typeï¼Œç²¾ç¡®æ•°æ®ç±»å‹ï¼Œå°±æ˜¯ä¿®é¥°ä¸»æ•°æ®ç±»å‹çš„é‚£å †ä¸œä¸œï¼Œæ¯”å¦‚æ˜¯å¦å…è®¸NULLå€¼ï¼Œæ˜¯å¦å…è®¸è´Ÿæ•°å•¥çš„ LEN è¯¥åˆ—æœ€å¤šå ç”¨å­˜å‚¨ç©ºé—´çš„å­—èŠ‚æ•° PREC è¯¥åˆ—çš„ç²¾åº¦ï¼Œä¸è¿‡è¿™åˆ—è²Œä¼¼éƒ½æ²¡æœ‰ä½¿ç”¨ï¼Œé»˜è®¤å€¼éƒ½æ˜¯0 è¿™ä¸ªSYS_COLUMNSè¡¨åªæœ‰ä¸€ä¸ªèšé›†ç´¢å¼•ï¼š ä»¥(TABLE_ID, POS)åˆ—ä¸ºä¸»é”®çš„èšç°‡ç´¢å¼• 1.4 SYS_INDEXESè¡¨ åˆ—å æè¿° TABLE_ID è¯¥ç´¢å¼•æ‰€å±è¡¨å¯¹åº”çš„ID ID InnoDBå­˜å‚¨å¼•æ“ä¸­æ¯ä¸ªç´¢å¼•éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ID NAME è¯¥ç´¢å¼•çš„åç§° N_FIELDS è¯¥ç´¢å¼•åŒ…å«åˆ—çš„ä¸ªæ•° TYPE è¯¥ç´¢å¼•çš„ç±»å‹ï¼Œæ¯”å¦‚èšç°‡ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ã€æ›´æ”¹ç¼“å†²åŒºçš„ç´¢å¼•ã€å…¨æ–‡ç´¢å¼•ã€æ™®é€šçš„äºŒçº§ç´¢å¼•ç­‰ç­‰å„ç§ç±»å‹ SPACE è¯¥ç´¢å¼•æ ¹é¡µé¢æ‰€åœ¨çš„è¡¨ç©ºé—´ID PAGE_NO è¯¥ç´¢å¼•æ ¹é¡µé¢æ‰€åœ¨çš„é¡µé¢å· MERGE_THRESHOLD å¦‚æœé¡µé¢ä¸­çš„è®°å½•è¢«åˆ é™¤åˆ°æŸä¸ªæ¯”ä¾‹ï¼Œå°±æŠŠè¯¥é¡µé¢å’Œç›¸é‚»é¡µé¢åˆå¹¶ï¼Œè¿™ä¸ªå€¼å°±æ˜¯è¿™ä¸ªæ¯”ä¾‹ è¿™ä¸ªSYS_INDEXESè¡¨åªæœ‰ä¸€ä¸ªèšé›†ç´¢å¼•ï¼š ä»¥(TABLE_ID, ID)åˆ—ä¸ºä¸»é”®çš„èšç°‡ç´¢å¼• 1.5 SYS_FIELDSè¡¨ åˆ—å æè¿° INDEX_ID è¯¥ç´¢å¼•åˆ—æ‰€å±çš„ç´¢å¼•çš„ID POS è¯¥ç´¢å¼•åˆ—åœ¨æŸä¸ªç´¢å¼•ä¸­æ˜¯ç¬¬å‡ åˆ— COL_NAME è¯¥ç´¢å¼•åˆ—çš„åç§° è¿™ä¸ªSYS_FIELDSè¡¨åªæœ‰ä¸€ä¸ªèšé›†ç´¢å¼•ï¼š ä»¥(INDEX_ID, POS)åˆ—ä¸ºä¸»é”®çš„èšç°‡ç´¢å¼• 1.6 Data Dictionary Headeré¡µé¢åªè¦æœ‰äº†ä¸Šè¿°4ä¸ªåŸºæœ¬ç³»ç»Ÿè¡¨ï¼Œä¹Ÿå°±æ„å‘³ç€å¯ä»¥è·å–å…¶ä»–ç³»ç»Ÿè¡¨ä»¥åŠç”¨æˆ·å®šä¹‰çš„è¡¨çš„æ‰€æœ‰å…ƒæ•°æ®ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æƒ³çœ‹çœ‹SYS_TABLESPACESè¿™ä¸ªç³»ç»Ÿè¡¨é‡Œå­˜å‚¨äº†å“ªäº›è¡¨ç©ºé—´ä»¥åŠè¡¨ç©ºé—´å¯¹åº”çš„å±æ€§ï¼Œé‚£å°±å¯ä»¥ï¼š åˆ°SYS_TABLESè¡¨ä¸­æ ¹æ®è¡¨åå®šä½åˆ°å…·ä½“çš„è®°å½•ï¼Œå°±å¯ä»¥è·å–åˆ°SYS_TABLESPACESè¡¨çš„TABLE_ID ä½¿ç”¨è¿™ä¸ªTABLE_IDåˆ°SYS_COLUMNSè¡¨ä¸­å°±å¯ä»¥è·å–åˆ°å±äºè¯¥è¡¨çš„æ‰€æœ‰åˆ—çš„ä¿¡æ¯ã€‚ ä½¿ç”¨è¿™ä¸ªTABLE_IDè¿˜å¯ä»¥åˆ°SYS_INDEXESè¡¨ä¸­è·å–æ‰€æœ‰çš„ç´¢å¼•çš„ä¿¡æ¯ï¼Œç´¢å¼•çš„ä¿¡æ¯ä¸­åŒ…æ‹¬å¯¹åº”çš„INDEX_IDï¼Œè¿˜è®°å½•ç€è¯¥ç´¢å¼•å¯¹åº”çš„B+æ•°æ ¹é¡µé¢æ˜¯å“ªä¸ªè¡¨ç©ºé—´çš„å“ªä¸ªé¡µé¢ã€‚ ä½¿ç”¨INDEX_IDå°±å¯ä»¥åˆ°SYS_FIELDSè¡¨ä¸­è·å–æ‰€æœ‰ç´¢å¼•åˆ—çš„ä¿¡æ¯ã€‚ è¿™4ä¸ªè¡¨çš„å…ƒæ•°æ®å»å“ªé‡Œè·å–å‘¢ï¼Ÿè¿™4ä¸ªè¡¨çš„å…ƒæ•°æ®ï¼Œå°±æ˜¯å®ƒä»¬æœ‰å“ªäº›åˆ—ã€å“ªäº›ç´¢å¼•ç­‰ä¿¡æ¯æ˜¯ç¡¬ç¼–ç åˆ°ä»£ç ä¸­çš„ï¼ŒInnoDBç”¨ä¸€ä¸ªå›ºå®šçš„é¡µé¢æ¥è®°å½•è¿™4ä¸ªè¡¨çš„èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•å¯¹åº”çš„B+æ ‘ä½ç½®ï¼Œè¿™ä¸ªé¡µé¢å°±æ˜¯é¡µå·ä¸º7çš„é¡µé¢ï¼Œç±»å‹ä¸ºSYSï¼Œè®°å½•äº†Data Dictionary Headerï¼Œä¹Ÿå°±æ˜¯æ•°æ®å­—å…¸çš„å¤´éƒ¨ä¿¡æ¯ã€‚é™¤äº†è¿™4ä¸ªè¡¨çš„5ä¸ªç´¢å¼•çš„æ ¹é¡µé¢ä¿¡æ¯å¤–ï¼Œè¿™ä¸ªé¡µå·ä¸º7çš„é¡µé¢è¿˜è®°å½•äº†æ•´ä¸ªInnoDBå­˜å‚¨å¼•æ“çš„ä¸€äº›å…¨å±€å±æ€§ã€‚ è¿™ä¸ªé¡µé¢ç”±ä¸‹è¾¹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š åç§° ä¸­æ–‡å å ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰ ç®€å•æè¿° File Header æ–‡ä»¶å¤´éƒ¨ 38 é¡µçš„ä¸€äº›é€šç”¨ä¿¡æ¯ Data Dictionary Header æ•°æ®å­—å…¸å¤´éƒ¨ä¿¡æ¯ 56 è®°å½•ä¸€äº›åŸºæœ¬ç³»ç»Ÿè¡¨çš„æ ¹é¡µé¢ä½ç½®ä»¥åŠInnoDBå­˜å‚¨å¼•æ“çš„ä¸€äº›å…¨å±€ä¿¡æ¯ Segment Header æ®µå¤´éƒ¨ä¿¡æ¯ 10 è®°å½•æœ¬é¡µé¢æ‰€åœ¨æ®µå¯¹åº”çš„INODE Entryä½ç½®ä¿¡æ¯ Empty Space å°šæœªä½¿ç”¨ç©ºé—´ 16272 ç”¨äºé¡µç»“æ„çš„å¡«å……ï¼Œæ²¡å•¥å®é™…æ„ä¹‰ File Trailer æ–‡ä»¶å°¾éƒ¨ 8 æ ¡éªŒé¡µæ˜¯å¦å®Œæ•´ è¿™ä¸ªé¡µé¢é‡Œæœ‰Segment Headeréƒ¨åˆ†ï¼Œæ„å‘³ç€InnoDBæŠŠè¿™äº›æœ‰å…³æ•°æ®å­—å…¸çš„ä¿¡æ¯å½“æˆä¸€ä¸ªæ®µæ¥åˆ†é…å­˜å‚¨ç©ºé—´ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæ•°æ®å­—å…¸æ®µã€‚ç”±äºç›®å‰æˆ‘ä»¬éœ€è¦è®°å½•çš„æ•°æ®å­—å…¸ä¿¡æ¯éå¸¸å°‘ï¼ˆå¯ä»¥çœ‹åˆ°Data Dictionary Headeréƒ¨åˆ†ä»…å ç”¨äº†56å­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥è¯¥æ®µåªæœ‰ä¸€ä¸ªç¢ç‰‡é¡µï¼Œä¹Ÿå°±æ˜¯é¡µå·ä¸º7çš„è¿™ä¸ªé¡µã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹Data Dictionary Headeréƒ¨åˆ†çš„å„ä¸ªå­—æ®µï¼š Max Row IDï¼šå¦‚æœæˆ‘ä»¬ä¸æ˜¾å¼çš„ä¸ºè¡¨å®šä¹‰ä¸»é”®ï¼Œè€Œä¸”è¡¨ä¸­ä¹Ÿæ²¡æœ‰UNIQUEç´¢å¼•ï¼Œé‚£ä¹ˆInnoDBå­˜å‚¨å¼•æ“ä¼šé»˜è®¤ä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªåä¸ºrow_idçš„åˆ—ä½œä¸ºä¸»é”®ã€‚å› ä¸ºå®ƒæ˜¯ä¸»é”®ï¼Œæ‰€ä»¥æ¯æ¡è®°å½•çš„row_idåˆ—çš„å€¼ä¸èƒ½é‡å¤ã€‚åŸåˆ™ä¸Šåªè¦ä¸€ä¸ªè¡¨ä¸­çš„row_idåˆ—ä¸é‡å¤å°±å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯è¯´è¡¨aå’Œè¡¨bæ‹¥æœ‰ä¸€æ ·çš„row_idåˆ—ä¹Ÿæ²¡å•¥å…³ç³»ï¼Œä¸è¿‡InnoDBåªæä¾›äº†è¿™ä¸ªMax Row IDå­—æ®µï¼Œä¸è®ºå“ªä¸ªæ‹¥æœ‰row_idåˆ—çš„è¡¨æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œè¯¥è®°å½•çš„row_idåˆ—çš„å€¼å°±æ˜¯Max Row IDå¯¹åº”çš„å€¼ï¼Œç„¶åå†æŠŠMax Row IDå¯¹åº”çš„å€¼åŠ 1ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªMax Row IDæ˜¯å…¨å±€å…±äº«çš„ã€‚ Max Table IDï¼šInnoDBå­˜å‚¨å¼•æ“ä¸­çš„æ‰€æœ‰çš„è¡¨éƒ½å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„IDï¼Œæ¯æ¬¡æ–°å»ºä¸€ä¸ªè¡¨æ—¶ï¼Œå°±ä¼šæŠŠæœ¬å­—æ®µçš„å€¼ä½œä¸ºè¯¥è¡¨çš„IDï¼Œç„¶åè‡ªå¢æœ¬å­—æ®µçš„å€¼ã€‚ Max Index IDï¼šInnoDBå­˜å‚¨å¼•æ“ä¸­çš„æ‰€æœ‰çš„ç´¢å¼•éƒ½å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„IDï¼Œæ¯æ¬¡æ–°å»ºä¸€ä¸ªç´¢å¼•æ—¶ï¼Œå°±ä¼šæŠŠæœ¬å­—æ®µçš„å€¼ä½œä¸ºè¯¥ç´¢å¼•çš„IDï¼Œç„¶åè‡ªå¢æœ¬å­—æ®µçš„å€¼ã€‚ Max Space IDï¼šInnoDBå­˜å‚¨å¼•æ“ä¸­çš„æ‰€æœ‰çš„è¡¨ç©ºé—´éƒ½å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„IDï¼Œæ¯æ¬¡æ–°å»ºä¸€ä¸ªè¡¨ç©ºé—´æ—¶ï¼Œå°±ä¼šæŠŠæœ¬å­—æ®µçš„å€¼ä½œä¸ºè¯¥è¡¨ç©ºé—´çš„IDï¼Œç„¶åè‡ªå¢æœ¬å­—æ®µçš„å€¼ã€‚ Mix ID Low(Unused)ï¼šè¿™ä¸ªå­—æ®µæ²¡å•¥ç”¨ï¼Œè·³è¿‡ã€‚ Root of SYS_TABLES clust indexï¼šæœ¬å­—æ®µä»£è¡¨SYS_TABLESè¡¨èšç°‡ç´¢å¼•çš„æ ¹é¡µé¢çš„é¡µå·ã€‚ Root of SYS_TABLE_IDS sec indexï¼šæœ¬å­—æ®µä»£è¡¨SYS_TABLESè¡¨ä¸ºIDåˆ—å»ºç«‹çš„äºŒçº§ç´¢å¼•çš„æ ¹é¡µé¢çš„é¡µå·ã€‚ Root of SYS_COLUMNS clust indexï¼šæœ¬å­—æ®µä»£è¡¨SYS_COLUMNSè¡¨èšç°‡ç´¢å¼•çš„æ ¹é¡µé¢çš„é¡µå·ã€‚ Root of SYS_INDEXES clust indexæœ¬å­—æ®µä»£è¡¨SYS_INDEXESè¡¨èšç°‡ç´¢å¼•çš„æ ¹é¡µé¢çš„é¡µå·ã€‚ Root of SYS_FIELDS clust indexï¼šæœ¬å­—æ®µä»£è¡¨SYS_FIELDSè¡¨èšç°‡ç´¢å¼•çš„æ ¹é¡µé¢çš„é¡µå·ã€‚ Unusedï¼šè¿™4ä¸ªå­—èŠ‚æ²¡ç”¨ï¼Œè·³è¿‡ã€‚ ä»¥ä¸Šå°±æ˜¯é¡µå·ä¸º7çš„é¡µé¢çš„å…¨éƒ¨å†…å®¹ã€‚ 1.7 information_schemaç³»ç»Ÿæ•°æ®åº“ç”¨æˆ·æ˜¯ä¸èƒ½ç›´æ¥è®¿é—®InnoDBçš„è¿™äº›å†…éƒ¨ç³»ç»Ÿè¡¨çš„ï¼Œé™¤éä½ ç›´æ¥å»è§£æç³»ç»Ÿè¡¨ç©ºé—´å¯¹åº”æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶ã€‚ä¸è¿‡InnoDBè€ƒè™‘åˆ°æŸ¥çœ‹è¿™äº›è¡¨çš„å†…å®¹å¯èƒ½æœ‰åŠ©äºå¤§å®¶åˆ†æé—®é¢˜ï¼Œæ‰€ä»¥åœ¨ç³»ç»Ÿæ•°æ®åº“information_schemaä¸­æä¾›äº†ä¸€äº›ä»¥innodb_syså¼€å¤´çš„è¡¨ï¼š 12345678910111213141516171819mysql&gt; USE information_schema;Database changedmysql&gt; SHOW TABLES LIKE &#x27;innodb_sys%&#x27;;+--------------------------------------------+| Tables_in_information_schema (innodb_sys%) |+--------------------------------------------+| INNODB_SYS_DATAFILES || INNODB_SYS_VIRTUAL || INNODB_SYS_INDEXES || INNODB_SYS_TABLES || INNODB_SYS_FIELDS || INNODB_SYS_TABLESPACES || INNODB_SYS_FOREIGN_COLS || INNODB_SYS_COLUMNS || INNODB_SYS_FOREIGN || INNODB_SYS_TABLESTATS |+--------------------------------------------+10 rows in set (0.00 sec) åœ¨information_schemaæ•°æ®åº“ä¸­çš„è¿™äº›ä»¥INNODB_SYSå¼€å¤´çš„è¡¨å¹¶ä¸æ˜¯çœŸæ­£çš„å†…éƒ¨ç³»ç»Ÿè¡¨ï¼Œè€Œæ˜¯åœ¨å­˜å‚¨å¼•æ“å¯åŠ¨æ—¶è¯»å–è¿™äº›ä»¥SYSå¼€å¤´çš„ç³»ç»Ÿè¡¨ï¼Œç„¶åå¡«å……åˆ°è¿™äº›ä»¥INNODB_SYSå¼€å¤´çš„è¡¨ä¸­ã€‚ä»¥INNODB_SYSå¼€å¤´çš„è¡¨å’Œä»¥SYSå¼€å¤´çš„è¡¨ä¸­çš„å­—æ®µå¹¶ä¸å®Œå…¨ä¸€æ ·ã€‚â€‹ è¡¥å……ä¸€å¼ è¡¨ç©ºé—´å®Œæ•´ç»“æ„å›¾","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[å››]ç´¢å¼•å‘½ä¸­åŸç†","slug":"MySQL/MySQL[å››]ç´¢å¼•å‘½ä¸­åŸç†","date":"2022-01-11T03:15:31.769Z","updated":"2022-01-11T03:19:35.568Z","comments":true,"path":"2022/01/11/MySQL/MySQL[å››]ç´¢å¼•å‘½ä¸­åŸç†/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E5%9B%9B]%E7%B4%A2%E5%BC%95%E5%91%BD%E4%B8%AD%E5%8E%9F%E7%90%86/","excerpt":"","text":"ä¸Šä¸€ç¯‡åˆ†æäº†InnoDBå­˜å‚¨å¼•æ“çš„B+æ ‘ç´¢å¼•ï¼Œç°åœ¨æ¥è¿›è¡Œä¸€ä¸ªç®€å•çš„å›é¡¾ã€‚ æ¯ä¸ªç´¢å¼•éƒ½å¯¹åº”ä¸€é¢—B+æ ‘ï¼ŒB+æ ‘åˆ†ä¸ºå¥½å¤šå±‚ï¼Œæœ€ä¸‹è¾¹ä¸€å±‚æ˜¯å¶å­ç»“ç‚¹ï¼Œå…¶ä½™çš„æ˜¯å†…ç»“ç‚¹ã€‚æ‰€æœ‰çš„ç”¨æˆ·è®°å½•éƒ½å­˜å‚¨åœ¨B+æ ‘çš„å¶å­ç»“ç‚¹ï¼Œæ‰€æœ‰ç›®å½•é¡¹è®°å½•éƒ½å­˜å‚¨åœ¨å†…èŠ‚ç‚¹ã€‚ InnoDBå­˜å‚¨å¼•æ“ä¼šè‡ªåŠ¨ä¸ºä¸»é”®å»ºç«‹èšç°‡ç´¢å¼•ï¼Œèšç°‡ç´¢å¼•çš„å¶å­ç»“ç‚¹åŒ…å«å®Œæ•´çš„ç”¨æˆ·è®°å½•ã€‚ æˆ‘ä»¬å¯ä»¥ä¸ºæŒ‡å®šçš„åˆ—å»ºç«‹äºŒçº§ç´¢å¼•ï¼ŒäºŒçº§ç´¢å¼•çš„å¶å­ç»“ç‚¹åŒ…å«çš„ç”¨æˆ·è®°å½•ç”±ç´¢å¼•åˆ—+ä¸»é”®ç»„æˆï¼Œæ‰€ä»¥å¦‚æœé¡¹é€šè¿‡äºŒçº§ç´¢å¼•æ¥æŸ¥æ‰¾å®Œæ•´çš„ç”¨æˆ·è®°å½•çš„è¯ï¼Œéœ€è¦é€šè¿‡å›è¡¨æ“ä½œï¼Œä¹Ÿå°±æ˜¯åœ¨é€šè¿‡äºŒçº§ç´¢å¼•æ‰¾åˆ°ä¸»é”®å€¼ä¹‹åå†åˆ°èšç°‡ç´¢å¼•ä¸­æŸ¥æ‰¾å®Œæ•´çš„ç”¨æˆ·è®°å½•ã€‚ B+æ ‘ä¸­æ¯å±‚ç»“ç‚¹éƒ½æ˜¯æŒ‰ç…§ç´¢å¼•åˆ—å€¼ä»å¤§åˆ°å°çš„é¡ºåºæ’åºè€Œç»„æˆäº†åŒå‘é“¾è¡¨ï¼Œè€Œä¸”æ¯ä¸ªé¡µå†…çš„è®°å½•(ä¸è®ºæ˜¯ç”¨æˆ·è®°å½•è¿˜æ˜¯ç›®å½•é¡¹è®°å½•)éƒ½æ˜¯æŒ‰ç…§ç´¢å¼•åˆ—çš„å€¼ä»å°åˆ°å¤§çš„é¡ºåºè€Œå½¢æˆäº†ä¸€ä¸ªå•é“¾è¡¨ã€‚å¦‚æœæ˜¯è”åˆç´¢å¼•çš„è¯ï¼Œåˆ™é¡µé¢å’Œè®°å½•å…ˆæŒ‰ç…§è”åˆç´¢å¼•å‰è¾¹çš„åˆ—æ’åºï¼Œå¦‚æœè¯¥åˆ—å€¼ç›¸åŒï¼Œåœ¨æŒ‰ç…§è”åˆç´¢å¼•åè¾¹çš„åˆ—æ’åºã€‚ é€šè¿‡ç´¢å¼•æŸ¥æ‰¾è®°å½•æ˜¯ä»B+æ ‘çš„æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œä¸€å±‚ä¸€å±‚ä¹¡ä¸‹æœç´¢ã€‚ç”±äºæ¯ä¸ªé¡µé¢éƒ½æŒ‰ç…§ç´¢å¼•åˆ—çš„å€¼å»ºç«‹äº†é¡µç›®å½•ï¼Œæ‰€ä»¥åœ¨è¿™äº›é¡µé¢ä¸­æŸ¥æ‰¾éå¸¸å¿«ã€‚ ä¸€ï¼Œåšä¸€äº›å‰ç½®çš„å‡†å¤‡ä¸ºäº†è¿™ç¯‡æ–‡ç« çš„æ¼”ç¤ºï¼Œéœ€è¦å…ˆå»ºç«‹ä¸€å¼ ç®€å•çš„è¡¨ï¼Œç”¨æ¥æ¼”ç¤ºç´¢å¼•æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°çš„ä¸€äº›æƒ…å†µã€‚ 123456789101112131415161718192021create table single_table( # ä¸»é”®ç´¢å¼• id int primary key auto_increment, key1 varchar(100), key2 int, key3 varchar(100), key_part1 varchar(100), key_part2 varchar(100), key_part3 varchar(100), common_field varchar(100), # ç´¢å¼•åˆ—key1 key idx_key1 (key1), # å”¯ä¸€ç´¢å¼•ï¼šç´¢å¼•åˆ—key2 unique key uk_key2 (key2), # ç´¢å¼•åˆ—key3 key idx_key3 (key3), # è”åˆç´¢å¼•ï¼šç´¢å¼•åˆ—ï¼škey_part1, key_part2, key_part3 key idx_key_part (key_part1, key_part2, key_part3)) engine = innodb charset = utf8; å†å¾€è¡¨ä¸­æ’å…¥100wæ¡æ•°æ®ï¼Œå…·ä½“çš„æ’å…¥è¿‡ç¨‹ä¸åœ¨æ¼”ç¤ºã€‚ äºŒï¼Œç´¢å¼•çš„ä»£ä»·å‡¡äº‹éƒ½æ˜¯æœ‰åˆ©æœ‰å¼Šçš„ï¼Œç´¢å¼•å¯ä»¥åŠ å¿«æŸ¥è¯¢çš„é€Ÿåº¦ï¼Œä½†æ˜¯åŒæ ·çš„ï¼Œä»–ä¹Ÿæœ‰ç›¸åº”çš„ç¼ºç‚¹ã€‚ ç©ºé—´ä¸Š ä¸€ä¸ªç´¢å¼•å¯¹åº”ä¸€ä¸ªB+æ ‘ï¼Œæ¯ä¸€ä¸ªB+æ ‘çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªæ•°æ®é¡µã€‚ä¸€ä¸ªæ•°æ®é¡µå¤§å°é»˜è®¤æ˜¯16kbï¼Œæ‰€ä»¥ä¸€å¼ è¡¨çš„ç´¢å¼•è¶Šå¤šï¼Œå ç”¨çš„ç©ºé—´å…¶å®è¶Šå¤§ï¼Œç‰¹åˆ«æ˜¯åœ¨æ•°æ®é‡å¤§çš„æ—¶å€™ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬å»ºç«‹ç´¢å¼•ï¼Œé»˜è®¤æ¯å¼ è¡¨ä¸è¦è¶…è¿‡5ä¸ªã€‚ æ—¶é—´ä¸Š åœ¨å¯¹è¡¨è¿›è¡Œå¢åˆ æ”¹æ“ä½œçš„æ—¶å€™ï¼Œè¦å¯¹æ‰€æœ‰ç´¢å¼•å¯¹åº”çš„B+æ ‘è¿›è¡Œä¿®æ”¹ã€‚è€Œä¸”ä¸Šä¸€ç¯‡åˆ†æè¿‡ï¼ŒB+æ ‘çš„æ¯ä¸€å±‚èŠ‚ç‚¹éƒ½æŒ‰ç…§ç´¢å¼•åˆ—çš„å€¼ä»å°åˆ°å¤§çš„é¡ºåºæ’åºç»„æˆäº†åŒå‘é“¾è¡¨ã€‚é¡µä¸­çš„è®°å½•éƒ½æŒ‰ç…§ç´¢å¼•åˆ—çš„å€¼ä»å°åˆ°å¤§çš„é¡ºåºå½¢æˆäº†ä¸€ä¸ªå•å‘é“¾è¡¨ã€‚è€Œå¢åˆ æ”¹æ“ä½œå¯èƒ½ä¼šå¯¹ç»“ç‚¹å’Œè®°å½•çš„æ’åºé€ æˆç ´åï¼Œæ‰€ä»¥å­˜å‚¨å¼•æ“éœ€è¦é¢å¤–çš„æ—¶é—´è¿›è¡Œé¡µé¢åˆ†è£‚ï¼Œé¡µå›æ”¶ç­‰æ“ä½œï¼Œå¥½ç»´æŠ¤ç»“ç‚¹å’Œè®°å½•çš„æ’åºã€‚ç´¢å¼•è¶Šå¤šï¼Œç»´æŠ¤çš„æ—¶é—´æˆæœ¬è¶Šé«˜ã€‚ è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¹‹å‰ï¼Œä¼šå…ˆç”Ÿæˆæ‰§è¡Œè®¡åˆ’ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä¸€æ¡è¯­å¥å†ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ä¸­åªä¼šä½¿ç”¨ä¸€ä¸ªäºŒçº§ç´¢å¼•(æœ‰ç‰¹æ®Šçš„ï¼Œåé¢ä¼šåˆ†æ)ï¼Œåœ¨ç”Ÿæˆæ‰§è¡Œè®¡åˆ’çš„æ—¶å€™éœ€è¦è®¡ç®—ä½¿ç”¨ä¸åŒç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢æ—¶æ‰€éœ€æˆæœ¬ï¼Œæœ€åé€‰å–æˆæœ¬æœ€ä½çš„ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢ã€‚å¦‚æœç´¢å¼•å¤ªå¤šï¼Œåˆ†ææˆæœ¬å°±ä¼šå¾ˆé«˜ï¼Œè€—æ—¶ä¸¥é‡ï¼Œä»è€Œå½±å“æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæ€§èƒ½ã€‚ ä¸ºäº†åˆç†çš„å»ºç«‹ç´¢å¼•ï¼Œä¸€æ–¹é¢åŠ å¿«æˆ‘ä»¬çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œä¸€æ–¹é¢åˆä¸ä¼šè¿‡åˆ†çš„å ç”¨æˆ‘ä»¬çš„æ—¶é—´å’Œç©ºé—´ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ç´¢å¼•åœ¨æŸ¥è¯¢æ‰§è¡ŒæœŸé—´åˆ°åº•æ˜¯å¦‚ä½•å‘æŒ¥ä½œç”¨çš„ã€‚ ä¸‰ï¼Œä½¿ç”¨B+æ ‘ç´¢å¼•1.æ‰«æåŒºé—´å’Œè¾¹ç•Œæ¡ä»¶å…ˆè¯´ä»€ä¹ˆæ˜¯å…¨è¡¨æ‰«æï¼Ÿå°±æ˜¯ä»å¤´åˆ°å°¾ä¾æ¬¡éå†æ‰€æœ‰ç»“ç‚¹ï¼Œå†ä¾æ¬¡éå†ç»“ç‚¹ä¸­çš„æ‰€æœ‰è®°å½•ã€‚å…¨è¡¨æ‰«æè™½ç„¶æ•ˆç‡å¾ˆä½ï¼Œä½†æ˜¯å´æ˜¯ä¸€ç§ä¸‡èƒ½çš„è§£å†³æ–¹æ¡ˆï¼Œæ‰€æœ‰æŸ¥è¯¢éƒ½å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ¡ˆå…œåº•ã€‚ æˆ‘ä»¬å¯ä»¥åˆ©ç”¨B+æ ‘æŸ¥æ‰¾ç´¢å¼•åˆ—å€¼ç­‰äºæŸä¸ªå€¼çš„è®°å½•ï¼Œè¿™æ ·å¯ä»¥æ˜æ˜¾å‡å°‘éœ€è¦æ‰«æçš„è®°å½•æ•°é‡ã€‚ç”±äºB+æ ‘å¶å­èŠ‚ç‚¹ä¸­çš„è®°å½•æ˜¯æŒ‰ç…§ç´¢å¼•åˆ—å€¼ä»å°åˆ°å¤§çš„é¡ºåºæ’åºçš„ï¼Œæ‰€ä»¥åªæ‰«ææŸä¸ªåŒºé—´æˆ–æŸäº›åŒºé—´ä¸­çš„è®°å½•ä¹Ÿæ˜¯å¾ˆå¿«çš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªæŸ¥è¯¢è¯­å¥ï¼š 1explain select * from single_table where id&gt;=2 and id&lt;=100; è¿™ä¸ªæ—¶å€™å…¶å®æ˜¯èµ°äº†ä¸»é”®ç´¢å¼•ï¼Œè¿™ä¸ªè¯­å¥å…¶å®æ˜¯æƒ³æŸ¥æ‰¾idå€¼åœ¨åŒºé—´ã€2ï¼Œ100ã€‘å†…çš„æ‰€æœ‰èšç°‡ç´¢å¼•è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸»é”®ç´¢å¼•å…ˆå®šä½åˆ°id=2çš„è®°å½•ï¼Œç„¶åé¡ºç€è¿™æ¡è®°å½•çš„å•å‘é“¾è¡¨å¾€åæ‰¾å°±è¡Œäº†ã€‚ ä¸å…¨è¡¨æ‰«æçš„100wæ•°æ®ç›¸æ¯”ï¼Œæ‰«æè¿™ä¸ªåŒºé—´çš„æˆæœ¬ç®€ç›´å¤ªå°äº†ï¼Œæ‰€ä»¥æå‡äº†æŸ¥è¯¢æ•ˆç‡ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ªæ¡ˆä¾‹ä¸­å¾…æ‰«æçš„idå€¼æ‰€åœ¨åŒºé—´ç§°ä¸ºæ‰«æåŒºé—´ï¼ŒæŠŠå½¢æˆè¿™ä¸ªæ‰«æåŒºé—´çš„æœç´¢æ¡ä»¶ç§°ä¸ºå½¢æˆè¿™ä¸ªæ‰«æåŒºé—´çš„è¾¹ç•Œæ¡ä»¶ã€‚ å…¶å®å¯¹äºå…¨è¡¨æ‰«ææ¥è®²ï¼Œå°±æ˜¯åœ¨ã€-âˆï¼Œ+âˆã€‘çš„åŒºé—´è¿›è¡Œæ‰«æè€Œå·²ã€‚ å†æ¥çœ‹ä¸€æ¡æŸ¥è¯¢è¯­å¥ï¼š 12345explainselect *from single_tablewhere key2 in (1438, 6328) or (key2 &gt;= 38 and key2 &lt;= 79); è¿™ä¸ªæŸ¥è¯¢çš„æœç´¢æ¡ä»¶æ¶‰åŠåˆ°key2åˆ—ï¼Œæˆ‘ä»¬æ­£å¥½åœ¨key2åˆ—ä¸Šå»ºç«‹äº†å”¯ä¸€ç´¢å¼•ã€‚å¦‚æœä½¿ç”¨å”¯ä¸€ç´¢å¼•æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢ï¼Œå®é™…ä¸Šç›¸å½“äºä»ä¸‰ä¸ªåŒºé—´è·å–äºŒçº§ç´¢å¼•çš„è®°å½•ã€‚ ã€1438ï¼Œ1438ã€‘ ã€6328ï¼Œ6328ã€‘ ã€38ï¼Œ79ã€‘ ç±»ä¼¼å‰é¢ä¸¤ä¸ªåŒºé—´è¿™ç§ï¼Œåªæœ‰ä¸€ä¸ªå€¼çš„åŒºé—´ï¼Œæˆ‘ä»¬ç§°ä¸ºå•ç‚¹æ‰«æåŒºé—´ï¼ŒæŠŠç±»ä¼¼ç¬¬ä¸‰ä¸ªåŒºé—´è¿™æ ·å­˜åœ¨å¤šä¸ªå€¼çš„å«åšèŒƒå›´æ‰«æåŒºé—´ï¼Œå¦å¤–ï¼Œç”±äºæˆ‘ä»¬çš„æŸ¥è¯¢åˆ—æ˜¯*ï¼Œå¯¼è‡´ä»ä¸Šè¿°çš„åŒºé—´æ¯æ¬¡è·å–åˆ°ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•ï¼Œå°±éœ€è¦æ ¹æ®äºŒçº§ç´¢å¼•è®°å½•çš„idåˆ—çš„å€¼å–å›è¡¨ä¸€æ¬¡ã€‚ å½“ç„¶ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ¡ä»¶éƒ½å¯ä»¥ç§°ä¸ºè¾¹ç•Œæ¡ä»¶ï¼Œæ¯”å¦‚ä¸‹é¢çš„æŸ¥è¯¢è¯­å¥ï¼š 123456explainselect *from single_tablewhere key1 &gt; &#x27;aaa&#x27; and key3 &lt; &#x27;zzz&#x27; and common_field = &#x27;aaa&#x27;; å¦‚æœä½¿ç”¨idx_key1æ‰§è¡ŒæŸ¥è¯¢ï¼Œé‚£ä¹ˆç›¸åº”çš„æ‰«æåŒºé—´å°±å˜æˆäº†ã€â€™aaaâ€™,+âˆã€‘ï¼Œåé¢çš„æ¡ä»¶å°±æ˜¯æ™®é€šæœç´¢æ¡ä»¶ï¼Œè¿™äº›æ™®é€šçš„æœç´¢æ¡ä»¶éœ€è¦åœ¨è·å–åˆ°idx_key1çš„äºŒçº§ç´¢å¼•è®°å½•åï¼Œåœ¨æ‰§è¡Œå›è¡¨æ“ä½œï¼Œåœ¨è·å–åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•åæ‰èƒ½å»åˆ¤æ–­ä»–ä»¬æ˜¯å¦æˆç«‹ã€‚ å¦‚æœä½¿ç”¨idx_key3æ‰§è¡ŒæŸ¥è¯¢ï¼Œé‚£ä¹ˆæ‰«æåŒºé—´å°±æ˜¯ã€-âˆ,â€™zzzâ€™ã€‘,å…¶ä½™çš„æ¡ä»¶å°±æ˜¯æ™®é€šæœç´¢æ¡ä»¶ï¼Œè¿™äº›æ™®é€šçš„æœç´¢æ¡ä»¶éœ€è¦åœ¨è·å–åˆ°idx_key3çš„äºŒçº§ç´¢å¼•è®°å½•åï¼Œåœ¨æ‰§è¡Œå›è¡¨æ“ä½œï¼Œåœ¨è·å–åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•åæ‰èƒ½å»åˆ¤æ–­ä»–ä»¬æ˜¯å¦æˆç«‹ã€‚ åœ¨ä½¿ç”¨æŸä¸ªç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œå…³é”®çš„é—®é¢˜å°±æ˜¯é€šè¿‡æœç´¢æ¡ä»¶æ‰¾å‡ºåˆé€‚çš„åŒºé—´ï¼Œç„¶åå†å»å¯¹åº”çš„B+æ ‘ä¸­æ‰«æç´¢å¼•åˆ—å€¼åœ¨è¿™äº›æ‰«æåŒºé—´çš„è®°å½•ï¼Œå¯¹äºæ¯ä¸€ä¸ªåŒºé—´æ¥è¯´ï¼Œåªéœ€è¦å®šä½åˆ°ç¬¬ä¸€æ¡ï¼Œå°±å¯ä»¥æ²¿ç€å•é“¾è¡¨ä¸€ç›´å¾€åæ‰«ç¬¦åˆæ¡ä»¶çš„è®°å½•ã€‚ å…¶å®å¯¹äºB+æ ‘ç´¢å¼•æ¥è¯´ï¼š = &lt;=&gt; in not in is null is not null &gt; &lt; &gt;= &lt;= between != like éƒ½ä¼šè¿›è¡ŒåŒºé—´æ‰«æï¼Œåªä¸è¿‡åŒºé—´æ‰«æå¤§å°ä¸åŒå¯¼è‡´æ•ˆç‡ä¸åŒã€‚ ä¸è¿‡ä¹Ÿæœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„ç‚¹ï¼š inå’Œå¤šä¸ª = ç”¨orè¿æ¥èµ·æ¥çš„æ•ˆæœå…¶å®æ˜¯ä¸€æ ·çš„ï¼Œéƒ½ä¼šäº§ç”Ÿå¤šä¸ªå•ç‚¹æ‰«æåŒºé—´ ä¸ç­‰äº äº§ç”Ÿçš„åŒºé—´æ¯”è¾ƒæ“è›‹ï¼š 1select * from single_table where key1 != &#x27;aaa&#x27; è¿™ä¸ªæ—¶å€™idx_key1 æ‰§è¡ŒæŸ¥è¯¢çš„æ—¶å€™å¯¹åº”çš„æ‰«æåŒºé—´å°±æ˜¯ã€-âˆ,â€™aaaâ€™ã€‘å’Œã€â€™aaaâ€™,+âˆã€‘ã€‚ likeæ“ä½œæ¯”è¾ƒç‰¹æ®Šï¼Œåªæœ‰åœ¨åŒ¹é…å®Œæ•´çš„å­—ç¬¦ä¸²æˆ–è€…åŒ¹é…å­—ç¬¦ä¸²å‰ç¼€çš„æ—¶å€™æ‰ä¼šäº§ç”Ÿåˆé€‚çš„æ‰«æåŒºé—´ æ¯”è¾ƒå­—ç¬¦ä¸²çš„å¤§å°å…¶å®å°±æ˜¯é€ä¸ªæ¯”è¾ƒæ¯ä¸ªå­—ç¬¦çš„å¤§å°ã€‚å­—ç¬¦ä¸²çš„æ¯”è¾ƒè¿‡ç¨‹å¦‚ä¸‹ï¼š å…ˆæ¯”è¾ƒå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å°çš„å­—ç¬¦å°±æ¯”è¾ƒå° å¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦ä¸€æ ·çš„è¯å°±æŒ‰ç…§ä¸Šé¢çš„è§„åˆ™æ¯”è¾ƒç¬¬äºŒä¸ªï¼Œä»¥æ­¤ç±»æ¨ã€‚ å¯¹äºæŸä¸ªç´¢å¼•åˆ—æ¥è¯´ï¼Œå­—ç¬¦ä¸²å‰ç¼€ç›¸åŒçš„è®°å½•åœ¨ç”±è®°å½•ç»„æˆçš„å•å‘é“¾è¡¨ä¸­è‚¯å®šæ˜¯ç›¸é‚»çš„ã€‚æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªæœç´¢æ¡ä»¶æ˜¯key1 like &#39;a%&#39;ï¼Œå¯¹äºäºŒçº§ç´¢å¼•idx_key1æ¥è¯´ï¼Œæ‰€æœ‰å­—ç¬¦ä¸²å‰ç¼€ä¸ºaçš„äºŒçº§ç´¢å¼•è®°å½•è‚¯å®šæ˜¯ç›¸é‚»çš„ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬åªè¦å®šä½åˆ°key1å€¼å¾—å­—ç¬¦ä¸²å‰ç¼€ä¸ºaçš„ç¬¬ä¸€æ¡è®°å½•ï¼Œå°±å¯ä»¥ä¾æ¬¡å¾€åæ‰«æï¼Œç›´åˆ°æŸæ¡äºŒçº§ç´¢å¼•è®°å½•çš„å­—ç¬¦ä¸²ä¸æ˜¯aä¸ºæ­¢ã€‚ å¾ˆæ˜¾ç„¶ï¼Œkey1 like &#39;a%&#39;å½¢æˆçš„æ‰«æåŒºé—´ç›¸å½“äºã€â€™aâ€™,â€™bâ€™ã€‘ã€‚ åœ¨æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢è¯­å¥çš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦æ‰¾å‡ºæ‰€æœ‰å¯ç”¨çš„ç´¢å¼•ä»¥åŠä½¿ç”¨ä»–ä»¬æ—¶å¯¹åº”çš„æ‰«æåŒºé—´ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸‹æ€ä¹ˆä»åŒ…å«è‹¥å¹²ä¸ªandæˆ–è€…orçš„å¤æ‚æœç´¢æ¡ä»¶ä¸­æå–å‡ºæ­£ç¡®çš„æ‰«æåŒºé—´ã€‚ 1.1 æ‰€æœ‰æœç´¢æ¡ä»¶éƒ½å¯ä»¥ç”Ÿæˆåˆé€‚çš„æ‰«æåŒºé—´çš„æƒ…å†µåœ¨ä½¿ç”¨æŸä¸ªç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œæœ‰æ—¶æ¯ä¸ªå°çš„æœç´¢æ¡ä»¶éƒ½å¯ä»¥ç”Ÿæˆä¸€ä¸ªåˆé€‚çš„æ‰«æåŒºé—´æ¥å‡å°‘éœ€è¦æ‰«æçš„è®°å½•æ•°é‡ã€‚ 12345explainselect *from single_tablewhere key2 &gt; 100 and key2 &gt; 200; åœ¨ä½¿ç”¨å”¯ä¸€ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œè¿™ä¸¤ä¸ªæ¡ä»¶éƒ½å¯ä»¥å½¢æˆä¸€ä¸ªæ‰«æåŒºé—´ã€100ï¼Œ+âˆã€‘ï¼Œã€200ï¼Œ+âˆã€‘ã€‚å› ä¸ºè¿™ä¸¤ä¸ªæ¡ä»¶æ˜¯ç”¨andè¿æ¥çš„ï¼Œæ‰€ä»¥æœ€ç»ˆå°±æ˜¯ä¸¤ä¸ªåŒºé—´å–äº¤é›†ã€200ï¼Œ+âˆã€‘ã€‚ æˆ‘ä»¬æŠŠsqlæ”¹ä¸€æ”¹ï¼š 12345explainselect *from single_tablewhere key2 &gt; 100 or key2 &gt; 200; è¿™ä¸ªæ—¶å€™å› ä¸ºæ˜¯ä½¿ç”¨orè¿›è¡Œä¸¤ä¸ªæ¡ä»¶çš„è¿æ¥ï¼Œæ‰€ä»¥ä¸¤ä¸ªæ¡ä»¶çš„åŒºé—´åº”è¯¥å–å¹¶é›†ï¼šã€100ï¼Œ+âˆã€‘ã€‚ 1.2 æœ‰çš„æœç´¢æ¡ä»¶ä¸èƒ½ç”Ÿæˆåˆé€‚çš„æ‰«æåŒºé—´çš„æƒ…å†µåœ¨ä½¿ç”¨æŸä¸ªç´¢å¼•è¿›è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œæœ‰äº›å°çš„æœç´¢æ¡ä»¶å¹¶ä¸èƒ½ç”Ÿæˆåˆé€‚çš„æ‰«æåŒºé—´æ¥å‡å°‘éœ€è¦æ‰«æçš„è¡Œæ•°ã€‚ 12345explainselect *from single_tablewhere key2 &gt; 100 and common_field =&#x27;abc&#x27;; åœ¨ä½¿ç”¨å”¯ä¸€ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªæ¡ä»¶ä¼šå®šä½å‡ºåŒºé—´ã€100ï¼Œ+âˆã€‘ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªæ¡ä»¶æ˜¯ä¸€ä¸ªæ™®é€šæ¡ä»¶ï¼Œç›¸å½“äºã€-âˆï¼Œ+âˆã€‘ï¼Œå› ä¸ºä¸¤ä¸ªæ¡ä»¶ä½¿ç”¨andè¿æ¥çš„ï¼Œæ‰€ä»¥æœ€ç»ˆå–äº¤é›†ä¹‹åçš„åŒºé—´å°±æ˜¯ã€100ï¼Œ+âˆã€‘ã€‚ å…¶å®åœ¨ä½¿ç”¨å”¯ä¸€ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œåœ¨å¯»æ‰¾å¯¹åº”çš„æ‰«æåŒºé—´çš„è¿‡ç¨‹ä¸­ï¼Œæœç´¢æ¡ä»¶common_field =&#39;abc&#39;æ²¡æœ‰èµ·åˆ°ä»»ä½•ä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠè¿™ä¸ªæ¡ä»¶è¿›è¡Œä¸€ä¸ªç­‰ä»·æ›¿æ¢ã€TRUEã€‘(trueå¯¹åº”çš„æ‰«æåŒºé—´ä¹Ÿæ˜¯ã€-âˆï¼Œ+âˆã€‘)ã€‚ 12345explainselect *from single_tablewhere key2 &gt; 100 and true; åœ¨è¿›è¡ŒåŒ–ç®€ä¹‹åå°±å˜æˆï¼š 1234explainselect *from single_tablewhere key2 &gt; 100 ä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„æŸ¥è¯¢è¯­å¥åœ¨ä½¿ç”¨å”¯ä¸€ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢çš„æ—¶å€™å¯¹åº”çš„æ‰«æåŒºé—´å°±æ˜¯ã€100ï¼Œ+âˆã€‘ã€‚ å†æ¥çœ‹ä¸€ä¸‹ä½¿ç”¨ORçš„æƒ…å†µï¼š 12345explainselect *from single_tablewhere key2 &gt; 100 or common_field =&#x27;abc&#x27;; åŒæ ·è¿›è¡ŒåŒ–ç®€ 12345explainselect *from single_tablewhere key2 &gt; 100 or true; ç»§ç»­åŒ–ç®€ 1234explainselect *from single_tablewhere true å¯è§å¦‚æœæ­¤æ—¶å¼ºåˆ¶ä½¿ç”¨å”¯ä¸€ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ï¼Œå¯¹åº”çš„æ‰«æåŒºé—´å°±æ˜¯ã€-âˆï¼Œ+âˆã€‘ï¼Œå†åŠ ä¸Šè¿™æ˜¯äºŒçº§ç´¢å¼•ï¼Œæ¯æ¬¡åŒ¹é…åˆ°ä¸€æ¡éƒ½è¦è¿›è¡Œå›è¡¨ï¼Œæ‰€ä»¥è¿™ä¸ªæŸ¥è¯¢çš„ä»£ä»·ç”šè‡³æ¯”å…¨è¡¨æ‰«æè¿˜å¤§ï¼Œè¿™ä¸ªæ—¶å€™å†ä½¿ç”¨å”¯ä¸€ç´¢å¼•å°±æ²¡æ„ä¹‰äº†ã€‚ 1.3ä»å¤æ‚çš„æœç´¢æ¡ä»¶ä¸­æ‰¾å‡ºæ‰«æåŒºé—´æ¥ä¸€ä¸ªå¤æ‚ç‚¹çš„æ¡ä»¶ï¼š 12345select *from single_tablewhere (key1 &gt; &#x27;aaa&#x27; and key2 &gt; 748) or (key1 &lt; &#x27;eee&#x27; and key1 &gt; &#x27;ccc&#x27;) or (key1 like &#x27;%f&#x27; and key1 &gt; &#x27;aaa&#x27; and (key2 &lt; 8000 or common_field = &#x27;aaa&#x27;)); è¿™æ— è¯­çš„SQLæ€ä¹ˆæï¼Ÿ å…ˆçœ‹whereå­å¥é‡Œé¢éƒ½æ¶‰åŠåˆ°äº†å“ªäº›åˆ—ï¼Œä»¥åŠæˆ‘ä»¬ä¸ºå“ªäº›åˆ—å»ºç«‹äº†ç´¢å¼• å¯¹äºå¯ä»¥ç”¨åˆ°çš„ç´¢å¼•ï¼Œæˆ‘ä»¬æ¥åˆ†æç´¢å¼•çš„æ‰«æåŒºé—´ 1.3.1 ä½¿ç”¨idx_key1æŸ¥è¯¢å…ˆæŠŠä¸èƒ½å½¢æˆåˆé€‚æ‰«æåŒºé—´çš„æœç´¢æ¡ä»¶å¹²æ‰ï¼Œæ€ä¹ˆå¹²æ‰ï¼Ÿç›´æ¥æŠŠä»–ä»¬æ›¿æ¢æˆTRUEã€‚ æ›¿æ¢ä¹‹åçš„æ•ˆæœï¼š 12345select *from single_tablewhere (key1 &gt; &#x27;aaa&#x27; and TRUE) or (key1 &lt; &#x27;eee&#x27; and key1 &gt; &#x27;ccc&#x27;) or (TRUE and key1 &gt; &#x27;aaa&#x27; and (TRUE or TRUE)); åŒ–ç®€ä¹‹åçš„ç»“æœï¼š 1234select *from single_tablewhere (key1 &gt; &#x27;aaa&#x27; ) -- ã€aaa,+âˆã€‘ or (key1 &lt; &#x27;eee&#x27; and key1 &gt; &#x27;ccc&#x27;) -- ã€&#x27;ccc&#x27;,&#x27;eee&#x27;ã€‘ å› ä¸ºè¿™ä¸¤ä¸ªæ¡ä»¶ä¹‹é—´æ˜¯ç”¨ORè¿æ¥èµ·æ¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å–å¹¶é›†ï¼Œæœ€ç»ˆï¼šã€aaa,+âˆã€‘ã€‚ ä¹Ÿå°±æ˜¯éœ€è¦æŠŠæ‰€æœ‰key1åœ¨è¿™ä¸ªåŒºé—´å†…çš„æ‰€æœ‰äºŒçº§ç´¢å¼•è®°å½•éƒ½å–å‡ºæ¥ï¼Œé’ˆå¯¹è·å–åˆ°çš„æ¯ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•è¿›è¡Œä¸€æ¬¡å›è¡¨ï¼Œåœ¨å¾—åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•ä¹‹ååœ¨ä½¿ç”¨å…¶ä»–çš„æœç´¢æ¡ä»¶è¿›è¡Œè¿‡æ»¤ã€‚ 1.3.2 ä½¿ç”¨å”¯ä¸€äºŒçº§ç´¢å¼•æŸ¥è¯¢æˆ‘ä»¬è¿˜æ˜¯è¿›è¡ŒåŒ–ç®€ 12345select *from single_tablewhere (TRUE and key2 = 748) or (TRUE and TRUE) or (TRUE and TRUE and (key2 &lt; 8000 or common_field = &#x27;aaa&#x27;)); å†ç»§ç»­åŒ–ç®€ 1234select *from single_tablewhere key2 = 748 or TRUE å› ä¸ºä¸¤ä¸ªæ¡ä»¶ä½¿ç”¨ORè¿æ¥çš„ï¼Œæ‰€ä»¥æœ€ç»ˆçš„ç»“æœå°±æ˜¯ã€-âˆï¼Œ+âˆã€‘ã€‚ ä¹Ÿå°±æ˜¯éœ€è¦æŠŠæ‰€æœ‰key2æ‰€æœ‰äºŒçº§ç´¢å¼•è®°å½•éƒ½å–å‡ºæ¥ï¼Œé’ˆå¯¹è·å–åˆ°çš„æ¯ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•è¿›è¡Œä¸€æ¬¡å›è¡¨ï¼Œåœ¨å¾—åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•ä¹‹ååœ¨ä½¿ç”¨å…¶ä»–çš„æœç´¢æ¡ä»¶è¿›è¡Œè¿‡æ»¤ï¼Œæ¯”å…¨è¡¨æ‰«æè¿˜è€—æ—¶ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ˜¯ä¸ä¼šèµ°å”¯ä¸€äºŒçº§ç´¢å¼•çš„ã€‚ åœ¨ä½¿ç”¨idx_key1æ‰§è¡Œä¸Šè¿°æŸ¥è¯¢çš„æ—¶å€™ï¼Œæœç´¢æ¡ä»¶ key1 like &#39;%f&#39; æ¯”è¾ƒç‰¹æ®Šã€‚è™½ç„¶ä»–ä¸èƒ½ä½œä¸ºå½¢æˆæ‰«æåŒºé—´çš„è¾¹ç•Œæ¡ä»¶ï¼Œä½†æ˜¯idx_key1çš„äºŒçº§ç´¢å¼•è®°å½•æ˜¯åŒ…å«key1åˆ—çš„ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆåˆ¤æ–­è·å–åˆ°çš„äºŒçº§ç´¢å¼•è®°å½•æ˜¯å¦ç¬¦åˆè¿™ä¸ªæ¡ä»¶ã€‚å¦‚æœç¬¦åˆåœ¨æ‰§è¡Œå›è¡¨æ“ä½œï¼Œå¦‚æœä¸ç¬¦åˆå°±ä¸ç”¨å›è¡¨äº†ã€‚è¿™æ ·å°±å¯ä»¥è¾ƒå°‘å› ä¸ºå›è¡¨å¸¦æ¥çš„æ€§èƒ½æŸè€—ï¼Œè¿™å°±æ˜¯ç´¢å¼•ä¸‹æ¨ã€‚ 1.4ä½¿ç”¨è”åˆç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢æ—¶å¯¹åº”çš„æ‰«æåŒºé—´è”åˆç´¢å¼•çš„ç´¢å¼•åˆ—åŒ…å«å¤šä¸ªåˆ—ï¼ŒB+æ ‘ä¸­çš„æ¯ä¸€å±‚é¡µé¢ä»¥åŠæ¯ä¸€ä¸ªé¡µä¸­çš„è®°å½•é‡‡ç”¨çš„æ’åºè§„åˆ™æ¯”è¾ƒå¤æ‚ã€‚ä»¥ä¸Šé¢çš„è¡¨ä¸ºä¾‹ï¼Œidx_key_part (key_part1, key_part2, key_part3) é‡‡ç”¨çš„æ’åºè§„åˆ™å¦‚ä¸‹ï¼š å…ˆæŒ‰ç…§key_part1è¿›è¡Œæ’åº key_part1ç›¸åŒæŒ‰ç…§key_part2è¿›è¡Œæ’åºï¼Œä»¥æ­¤ç±»æ¨ 1.4.1å…¨å€¼åŒ¹é…åŸç†å¯¹äºä¸‹é¢è¿™æ¡æŸ¥è¯¢è¯­å¥æ¥è®²ï¼š 123select *from single_tablewhere key_part1 =&#x27;a&#x27;; å› ä¸ºäºŒçº§ç´¢å¼•è®°å½•å…ˆæŒ‰ç…§key_part1è¿›è¡Œå€¼æ’åºçš„ï¼Œæ‰€ä»¥ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰è®°å½•è‚¯å®šæ˜¯ç›¸é‚»çš„ã€‚æˆ‘ä»¬å¯ä»¥å…ˆå®šä½åˆ°ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œæ²¿ç€é“¾è¡¨é¡ºåºå¾€ä¸‹æ‰«æçŸ¥é“ä¸ç¬¦åˆæ¡ä»¶ä¸ºæ­¢ï¼ˆå½“ç„¶ï¼Œå¯¹äºè·å–åˆ°çš„æ¯ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•éƒ½éœ€è¦è¿›è¡Œå›è¡¨ï¼‰ã€‚æ­¤æ—¶çš„æ‰«æåŒºé—´ã€â€™aâ€™,â€™aâ€™ã€‘ã€‚ åœ¨çœ‹ä¸€æ¡æŸ¥è¯¢è¯­å¥ï¼š 1234select *from single_tablewhere key_part1 = &#x27;a&#x27; and key_part2 = &#x27;b&#x27;; æŒ‰ç…§è”åˆç´¢å¼•çš„æ’åºè§„åˆ™ï¼Œæœ€ç»ˆçš„æ‰«æåŒºé—´å…¶å®å°±æ˜¯ã€(â€˜aâ€™,â€™bâ€™),(â€˜aâ€™,â€™bâ€™)ã€‘ã€‚ åœ¨çœ‹ä¸€æ¡SQLï¼š 123select *from single_tablewhere key_part1 &lt;&#x27;a&#x27;; å› ä¸ºäºŒçº§ç´¢å¼•è®°å½•å…ˆæŒ‰ç…§key_part1è¿›è¡Œå€¼æ’åºçš„ï¼Œæ‰€ä»¥ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰è®°å½•è‚¯å®šæ˜¯ç›¸é‚»çš„ã€‚æˆ‘ä»¬å¯ä»¥å…ˆå®šä½åˆ°ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œç„¶åé¡ºç€å•å‘é“¾è¡¨ç»§ç»­å¾€åæ‰«æï¼Œç›´åˆ°é‡åˆ°ä¸ç¬¦åˆè§„åˆ™çš„è®°å½•å°±åœæ­¢ã€‚ã€-âˆ,â€™aâ€™ã€‘ 1.4.2æœ€ä½³å·¦å‰ç¼€åŒ¹é…åŸç†åœ¨çœ‹ä¸€æ¡SQLï¼š 123select *from single_tablewhere key_part2 = &#x27;a&#x27;; ç”±äºäºŒçº§ç´¢å¼•è®°å½•ä¸æ˜¯ç›´æ¥æŒ‰ç…§key_part2åˆ—çš„å€¼è¿›è¡Œæ’åºçš„ï¼Œæ‰€ä»¥ç¬¦åˆæ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•å¯èƒ½å¹¶ä¸ç›¸é‚»ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½é€šè¿‡æœç´¢æ¡ä»¶æ¥å‡å°‘éœ€è¦æ‰«æçš„è¡Œæ•°ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯ä¸ä¼šä½¿ç”¨è¿™ä¸ªç´¢å¼•çš„ã€‚ åœ¨çœ‹ä¸€æ¡SQLï¼š 1234select *from single_tablewhere key_part1 = &#x27;a&#x27; and key_part3 = &#x27;c&#x27;; è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®æ˜¯å¯ä»¥æŒ‰ç…§key_part1è¿›è¡Œè¿‡æ»¤çš„ï¼Œä½†æ˜¯å› ä¸ºæ¥ä¸‹æ¥æ˜¯æŒ‰ç…§key_part2è¿›è¡Œæ’åºçš„ï¼Œæ‰€ä»¥æ»¡è¶³æœç´¢æ¡ä»¶ key_part3 = &#39;c&#39;çš„äºŒçº§ç´¢å¼•å€¼è®°å½•å¯èƒ½å¹¶ä¸ç›¸é‚»ï¼Œè¿™ä¸ªæ—¶å€™æ‰«æåŒºé—´å…¶å®å°±æ˜¯ã€â€™aâ€™,â€™aâ€™ã€‘ã€‚å› ä¸ºç¬¬äºŒä¸ªæ¡ä»¶èµ°ä¸äº†ç´¢å¼•ã€‚ é’ˆå¯¹è·å–åˆ°çš„æ¯ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ç´¢å¼•æ¡ä»¶ä¸‹æ¨çš„ç‰¹æ€§ï¼Œåˆ™å¿…é¡»å…ˆå›è¡¨è·å–å®Œæ•´çš„è®°å½•åœ¨æ¥åˆ¤æ–­ key_part3 = &#39;c&#39;æ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œå¦‚æœå¼€å¯äº†ç´¢å¼•ä¸‹æ¨ç‰¹æ€§ï¼Œå¯ä»¥åˆ¤æ–­å®Œ key_part3 = &#39;c&#39;æ˜¯å¦æˆç«‹ååœ¨è¿›è¡Œå›è¡¨æ“ä½œï¼Œç´¢å¼•ä¸‹æ¨æ˜¯åœ¨MySQL5.6å¼•å…¥çš„ï¼Œé»˜è®¤å¼€å¯ã€‚ åœ¨çœ‹ä¸€æ¡SQLï¼š 1234select *from single_tablewhere key_part1 &lt; &#x27;a&#x27; and key_part2 = &#x27;c&#x27;; å› ä¸ºäºŒçº§ç´¢å¼•è®°å½•å…ˆæŒ‰ç…§key_part1è¿›è¡Œå€¼æ’åºçš„ï¼Œæ‰€ä»¥ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰è®°å½•è‚¯å®šæ˜¯ç›¸é‚»çš„ã€‚ä½†æ˜¯å¯¹äºkey_part1 &lt; &#39;a&#39;æ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•æ¥è¯´ï¼Œå¹¶ä¸æ˜¯ç›´æ¥æŒ‰ç…§key_part2è¿›è¡Œæ’åºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸èƒ½æ ¹æ®key_part2 = &#39;c&#39;æ¥è¿›ä¸€æ­¥å‡å°‘æ‰«æçš„è¡Œæ•°ã€‚é‚£ä¹ˆï¼Œå¦‚æœä½¿ç”¨å½“å‰ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢ï¼Œå¯ä»¥å®šä½åˆ°ç¬¦åˆkey_part1 &lt; &#39;a&#39;çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œç„¶åæ²¿ç€å•é“¾è¡¨å¾€åæ‰«æï¼Œä¸€ç›´åˆ°ä¸ç¬¦åˆkey_part1 &lt; &#39;a&#39;ä¸ºæ­¢ã€‚ æ‰€ä»¥åœ¨ä½¿ç”¨å½“å‰ç´¢å¼•æ‰§è¡ŒSQLçš„æ—¶å€™ï¼Œå¯¹åº”çš„æ‰«æåŒºé—´å…¶å®å°±æ˜¯ã€-âˆ,â€™aâ€™ã€‘ã€‚ åœ¨çœ‹ä¸€æ¡SQLï¼š 1234select *from single_tablewhere key_part1 &lt;= &#x27;a&#x27; and key_part2 = &#x27;c&#x27;; è¿™æ¡SQLå’Œä¸Šä¸€æ¡SQLå¾ˆåƒï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ä»å°äºå˜æˆäº†å°äºç­‰äºã€‚å¾ˆæ˜¾ç„¶ç¬¦åˆkey_part1 &lt;= &#39;a&#39;çš„ç´¢å¼•å€¼è®°å½•æ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯å¯¹äºç¬¦åˆkey_part1 &lt;= &#39;a&#39;æ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•æ¥è¯´ï¼Œå¹¶ä¸æ˜¯ç›´æ¥æŒ‰ç…§key_part2åˆ—æ’åºçš„ã€‚ä½†æ˜¯ï¼Œå¯¹äºç¬¦åˆkey_part1 = &#39;a&#39;çš„äºŒçº§ç´¢å¼•è®°å½•æ¥è¯´ï¼Œæ˜¯æŒ‰ç…§key_part2çš„å€¼è¿›è¡Œæ’åºçš„ã€‚é‚£ä¹ˆå†ç¡®å®šéœ€è¦æ‰«æçš„äºŒçº§ç´¢å¼•è®°å½•çš„èŒƒå›´æ—¶ï¼Œå½“äºŒçº§ç´¢å¼•è®°å½•çš„key_part1 = &#39;a&#39;æ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡key_part2 = &#39;c&#39;æ¥å‡å°‘æ‰«æè¡Œæ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ‰«æåˆ°ä¸ç¬¦åˆkey_part1 &lt;= &#39;a&#39; and key_part2 = &#39;c&#39;çš„ç¬¬ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç»“æŸæ‰«æï¼Œè€Œä¸éœ€è¦å°†æ‰€æœ‰çš„key_part1 = &#39;a&#39;çš„è®°å½•å…¨éƒ¨æ‰«æå®Œã€‚ 2. ç´¢å¼•ç”¨äºæ’åºæˆ‘ä»¬åœ¨å†™æŸ¥è¯¢è¯­å¥çš„æ—¶å€™ç»å¸¸éœ€è¦å¯¹æŸ¥è¯¢å‡ºæ¥çš„è®°å½•é€šè¿‡ORDER BYå­å¥æŒ‰ç…§æŸç§è§„åˆ™è¿›è¡Œæ’åºã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªèƒ½æŠŠè®°å½•éƒ½åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå†ç”¨ä¸€äº›æ’åºç®—æ³•ï¼Œæ¯”å¦‚å¿«é€Ÿæ’åºã€å½’å¹¶æ’åºç­‰ç­‰åœ¨å†…å­˜ä¸­å¯¹è¿™äº›è®°å½•è¿›è¡Œæ’åºï¼Œæœ‰çš„æ—¶å€™å¯èƒ½æŸ¥è¯¢çš„ç»“æœé›†å¤ªå¤§ä»¥è‡³äºä¸èƒ½åœ¨å†…å­˜ä¸­è¿›è¡Œæ’åºçš„è¯ï¼Œè¿˜å¯èƒ½æš‚æ—¶å€ŸåŠ©ç£ç›˜çš„ç©ºé—´æ¥å­˜æ”¾ä¸­é—´ç»“æœï¼Œæ’åºæ“ä½œå®Œæˆåå†æŠŠæ’å¥½åºçš„ç»“æœé›†è¿”å›åˆ°å®¢æˆ·ç«¯ã€‚åœ¨MySQLä¸­ï¼ŒæŠŠè¿™ç§åœ¨å†…å­˜ä¸­æˆ–è€…ç£ç›˜ä¸Šè¿›è¡Œæ’åºçš„æ–¹å¼ç»Ÿç§°ä¸ºæ–‡ä»¶æ’åºï¼ˆè‹±æ–‡åï¼šfilesortï¼‰ï¼Œè·Ÿæ–‡ä»¶è¿™ä¸ªè¯å„¿ä¸€æ²¾è¾¹å„¿ï¼Œå°±æ˜¾å¾—è¿™äº›æ’åºæ“ä½œéå¸¸æ…¢äº†ï¼ˆç£ç›˜å’Œå†…å­˜çš„é€Ÿåº¦æ¯”èµ·æ¥ï¼Œå°±åƒæ˜¯é£æœºå’Œèœ—ç‰›çš„å¯¹æ¯”ï¼‰ã€‚ä½†æ˜¯å¦‚æœORDER BYå­å¥é‡Œä½¿ç”¨åˆ°äº†æˆ‘ä»¬çš„ç´¢å¼•åˆ—ï¼Œå°±æœ‰å¯èƒ½çœå»åœ¨å†…å­˜æˆ–æ–‡ä»¶ä¸­æ’åºçš„æ­¥éª¤ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªç®€å•çš„æŸ¥è¯¢è¯­å¥ï¼š 1SELECT * FROM single_table ORDER BY key_part1, key_part2, key_part3 LIMIT 10; è¿™ä¸ªæŸ¥è¯¢çš„ç»“æœé›†éœ€è¦å…ˆæŒ‰ç…§key_part1å€¼æ’åºï¼Œå¦‚æœè®°å½•çš„key_part1å€¼ç›¸åŒï¼Œåˆ™éœ€è¦æŒ‰ç…§key_part2æ¥æ’åºï¼Œå¦‚æœkey_part2çš„å€¼ç›¸åŒï¼Œåˆ™éœ€è¦æŒ‰ç…§key_part3æ’åºã€‚å› ä¸ºè¿™ä¸ªB+æ ‘ç´¢å¼•æœ¬èº«å°±æ˜¯æŒ‰ç…§ä¸Šè¿°è§„åˆ™æ’å¥½åºçš„ï¼Œæ‰€ä»¥ç›´æ¥ä»ç´¢å¼•ä¸­æå–æ•°æ®ï¼Œç„¶åè¿›è¡Œå›è¡¨æ“ä½œå–å‡ºè¯¥ç´¢å¼•ä¸­ä¸åŒ…å«çš„åˆ—å°±å¥½äº†ã€‚ 2.1ä½¿ç”¨è”åˆç´¢å¼•è¿›è¡Œæ’åºæ³¨æ„äº‹é¡¹å¯¹äºè”åˆç´¢å¼•æœ‰ä¸ªé—®é¢˜éœ€è¦æ³¨æ„ï¼ŒORDER BYçš„å­å¥åè¾¹çš„åˆ—çš„é¡ºåºä¹Ÿå¿…é¡»æŒ‰ç…§ç´¢å¼•åˆ—çš„é¡ºåºç»™å‡ºï¼Œå¦‚æœç»™å‡ºORDER BY key_part1, key_part3, key_part2çš„é¡ºåºï¼Œé‚£ä¹Ÿæ˜¯ç”¨ä¸äº†B+æ ‘ç´¢å¼•ï¼Œè¿™ç§é¢ å€’é¡ºåºå°±ä¸èƒ½ä½¿ç”¨ç´¢å¼•çš„åŸå› æˆ‘ä»¬ä¸Šè¾¹è¯¦ç»†è¯´è¿‡äº†ï¼Œè¿™å°±ä¸èµ˜è¿°äº†ã€‚ åŒç†ï¼ŒORDER BY key_part1ã€ORDER BY key_part1, key_part2è¿™ç§åŒ¹é…ç´¢å¼•å·¦è¾¹çš„åˆ—çš„å½¢å¼å¯ä»¥ä½¿ç”¨éƒ¨åˆ†çš„B+æ ‘ç´¢å¼•ã€‚å½“è”åˆç´¢å¼•å·¦è¾¹åˆ—çš„å€¼ä¸ºå¸¸é‡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åè¾¹çš„åˆ—è¿›è¡Œæ’åºï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1SELECT * FROM single_table WHERE key_part1 = &#x27;A&#x27; ORDER BY key_part2, key_part3 LIMIT 10; è¿™ä¸ªæŸ¥è¯¢èƒ½ä½¿ç”¨è”åˆç´¢å¼•è¿›è¡Œæ’åºæ˜¯å› ä¸ºkey_part1åˆ—çš„å€¼ç›¸åŒçš„è®°å½•æ˜¯æŒ‰ç…§key_part2, key_part3æ’åºçš„ã€‚ 2.2ä¸å¯ä»¥ä½¿ç”¨ç´¢å¼•è¿›è¡Œæ’åºçš„å‡ ç§æƒ…å†µ2.2.1ASCã€DESCæ··ç”¨å¯¹äºä½¿ç”¨è”åˆç´¢å¼•è¿›è¡Œæ’åºçš„åœºæ™¯ï¼Œæˆ‘ä»¬è¦æ±‚å„ä¸ªæ’åºåˆ—çš„æ’åºé¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿå°±æ˜¯è¦ä¹ˆå„ä¸ªåˆ—éƒ½æ˜¯ASCè§„åˆ™æ’åºï¼Œè¦ä¹ˆéƒ½æ˜¯DESCè§„åˆ™æ’åºã€‚ ORDER BYå­å¥åçš„åˆ—å¦‚æœä¸åŠ ASCæˆ–è€…DESCé»˜è®¤æ˜¯æŒ‰ç…§ASCæ’åºè§„åˆ™æ’åºçš„ï¼Œä¹Ÿå°±æ˜¯å‡åºæ’åºçš„ã€‚ ä¸ºå•¥ä¼šæœ‰è¿™ç§è§„å®šå‘¢ï¼Ÿè¿™ä¸ªè¿˜å¾—å›å¤´æƒ³æƒ³è¿™ä¸ªidx_key_partè”åˆç´¢å¼•ä¸­è®°å½•çš„ç»“æ„ï¼š å…ˆæŒ‰ç…§è®°å½•çš„key_part1åˆ—çš„å€¼è¿›è¡Œå‡åºæ’åˆ—ã€‚ å¦‚æœè®°å½•çš„key_part1åˆ—çš„å€¼ç›¸åŒï¼Œå†æŒ‰ç…§key_part2åˆ—çš„å€¼è¿›è¡Œå‡åºæ’åˆ—ã€‚ å¦‚æœè®°å½•çš„key_part2åˆ—çš„å€¼ç›¸åŒï¼Œå†æŒ‰ç…§key_part3åˆ—çš„å€¼è¿›è¡Œå‡åºæ’åˆ—ã€‚ å¦‚æœæŸ¥è¯¢ä¸­çš„å„ä¸ªæ’åºåˆ—çš„æ’åºé¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸¤ç§æƒ…å†µï¼š ORDER BY key_part1, key_part2 LIMIT 10è¿™ç§æƒ…å†µç›´æ¥ä»ç´¢å¼•çš„æœ€å·¦è¾¹å¼€å§‹å¾€å³è¯»10è¡Œè®°å½•å°±å¯ä»¥äº†ã€‚ ORDER BY key_part1 DESC, key_part2 DESC LIMIT 10ï¼Œè¿™ç§æƒ…å†µç›´æ¥ä»ç´¢å¼•çš„æœ€å³è¾¹å¼€å§‹å¾€å·¦è¯»10è¡Œè®°å½•å°±å¯ä»¥äº†ã€‚ ä½†æ˜¯å¦‚æœæˆ‘ä»¬æŸ¥è¯¢çš„éœ€æ±‚æ˜¯å…ˆæŒ‰ç…§key_part1åˆ—è¿›è¡Œå‡åºæ’åˆ—ï¼Œå†æŒ‰ç…§key_part2åˆ—è¿›è¡Œé™åºæ’åˆ—çš„è¯ï¼Œæ¯”å¦‚è¯´è¿™æ ·çš„æŸ¥è¯¢è¯­å¥ï¼š 1SELECT * FROM single_table ORDER BY key_part1, key_part2 DESC LIMIT 10; è¿™æ ·å¦‚æœä½¿ç”¨ç´¢å¼•æ’åºçš„è¯è¿‡ç¨‹å°±æ˜¯è¿™æ ·çš„ï¼š å…ˆä»ç´¢å¼•çš„æœ€å·¦è¾¹ç¡®å®škey_part1åˆ—æœ€å°çš„å€¼ï¼Œç„¶åæ‰¾åˆ°key_part1åˆ—ç­‰äºè¯¥å€¼çš„æ‰€æœ‰è®°å½•ï¼Œç„¶åä»nameåˆ—ç­‰äºè¯¥å€¼çš„æœ€å³è¾¹çš„é‚£æ¡è®°å½•å¼€å§‹å¾€å·¦æ‰¾10æ¡è®°å½•ã€‚ å¦‚æœkey_part1åˆ—ç­‰äºæœ€å°çš„å€¼çš„è®°å½•ä¸è¶³10æ¡ï¼Œå†ç»§ç»­å¾€å³æ‰¾key_part1å€¼ç¬¬äºŒå°çš„è®°å½•ï¼Œé‡å¤ä¸Šè¾¹é‚£ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°æ‰¾åˆ°10æ¡è®°å½•ä¸ºæ­¢ã€‚ è¿™æ ·ä¸èƒ½é«˜æ•ˆä½¿ç”¨ç´¢å¼•ï¼Œè€Œè¦é‡‡å–æ›´å¤æ‚çš„ç®—æ³•å»ä»ç´¢å¼•ä¸­å–æ•°æ®ï¼Œæ‰€ä»¥å°±è§„å®šä½¿ç”¨è”åˆç´¢å¼•çš„å„ä¸ªæ’åºåˆ—çš„æ’åºé¡ºåºå¿…é¡»æ˜¯ä¸€è‡´çš„ã€‚ 2.2.2æ’åºåˆ—åŒ…å«éåŒä¸€ä¸ªç´¢å¼•çš„åˆ—æœ‰æ—¶å€™ç”¨æ¥æ’åºçš„å¤šä¸ªåˆ—ä¸æ˜¯ä¸€ä¸ªç´¢å¼•é‡Œçš„ï¼Œè¿™ç§æƒ…å†µä¹Ÿä¸èƒ½ä½¿ç”¨ç´¢å¼•è¿›è¡Œæ’åºï¼Œæ¯”æ–¹è¯´ï¼š 1SELECT * FROM single_table ORDER BY key_part1, common_field LIMIT 10; key_part1å’Œcommon_fieldå¹¶ä¸å±äºä¸€ä¸ªè”åˆç´¢å¼•ä¸­çš„åˆ—ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨ç´¢å¼•è¿›è¡Œæ’åºã€‚ 2.2.3æ’åºåˆ—ä½¿ç”¨äº†å¤æ‚çš„è¡¨è¾¾å¼è¦æƒ³ä½¿ç”¨ç´¢å¼•è¿›è¡Œæ’åºæ“ä½œï¼Œå¿…é¡»ä¿è¯ç´¢å¼•åˆ—æ˜¯ä»¥å•ç‹¬åˆ—çš„å½¢å¼å‡ºç°ï¼Œè€Œä¸æ˜¯ä¿®é¥°è¿‡çš„å½¢å¼ï¼Œæ¯”æ–¹è¯´è¿™æ ·ï¼š 1SELECT * FROM single_table ORDER BY UPPER(key_part1) LIMIT 10; ä½¿ç”¨äº†UPPERå‡½æ•°ä¿®é¥°è¿‡çš„åˆ—å°±ä¸æ˜¯å•ç‹¬çš„åˆ—äº†ï¼Œè¿™æ ·å°±æ— æ³•ä½¿ç”¨ç´¢å¼•è¿›è¡Œæ’åºäº†ã€‚ 3. ç´¢å¼•ç”¨äºåˆ†ç»„æœ‰æ—¶å€™æˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ç»Ÿè®¡è¡¨ä¸­çš„ä¸€äº›ä¿¡æ¯ï¼Œä¼šæŠŠè¡¨ä¸­çš„è®°å½•æŒ‰ç…§æŸäº›åˆ—è¿›è¡Œåˆ†ç»„ã€‚æ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªåˆ†ç»„æŸ¥è¯¢ï¼š 1SELECT key_part1, key_part2, key_part3, COUNT(*) FROM single_table GROUP BY key_part1, key_part2, key_part3 è¿™ä¸ªæŸ¥è¯¢è¯­å¥ç›¸å½“äºåšäº†3æ¬¡åˆ†ç»„æ“ä½œï¼š å…ˆæŠŠè®°å½•æŒ‰ç…§key_part1å€¼è¿›è¡Œåˆ†ç»„ï¼Œæ‰€æœ‰key_part1å€¼ç›¸åŒçš„è®°å½•åˆ’åˆ†ä¸ºä¸€ç»„ã€‚ å°†æ¯ä¸ªkey_part1å€¼ç›¸åŒçš„åˆ†ç»„é‡Œçš„è®°å½•å†æŒ‰ç…§key_part2çš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå°†key_part3å€¼ç›¸åŒçš„è®°å½•æ”¾åˆ°ä¸€ä¸ªå°åˆ†ç»„é‡Œï¼Œæ‰€ä»¥çœ‹èµ·æ¥å°±åƒåœ¨ä¸€ä¸ªå¤§åˆ†ç»„é‡ŒåˆåŒ–åˆ†äº†å¥½å¤šå°åˆ†ç»„ã€‚ å†å°†ä¸Šä¸€æ­¥ä¸­äº§ç”Ÿçš„å°åˆ†ç»„æŒ‰ç…§key_part3çš„å€¼åˆ†æˆæ›´å°çš„åˆ†ç»„ï¼Œæ‰€ä»¥æ•´ä½“ä¸Šçœ‹èµ·æ¥å°±åƒæ˜¯å…ˆæŠŠè®°å½•åˆ†æˆä¸€ä¸ªå¤§åˆ†ç»„ï¼Œç„¶åæŠŠå¤§åˆ†ç»„åˆ†æˆè‹¥å¹²ä¸ªå°åˆ†ç»„ï¼Œç„¶åæŠŠè‹¥å¹²ä¸ªå°åˆ†ç»„å†ç»†åˆ†æˆæ›´å¤šçš„å°å°åˆ†ç»„ã€‚ ç„¶åé’ˆå¯¹é‚£äº›å°å°åˆ†ç»„è¿›è¡Œç»Ÿè®¡ï¼Œæ¯”å¦‚åœ¨æˆ‘ä»¬è¿™ä¸ªæŸ¥è¯¢è¯­å¥ä¸­å°±æ˜¯ç»Ÿè®¡æ¯ä¸ªå°å°åˆ†ç»„åŒ…å«çš„è®°å½•æ¡æ•°ã€‚å¦‚æœæ²¡æœ‰ç´¢å¼•çš„è¯ï¼Œè¿™ä¸ªåˆ†ç»„è¿‡ç¨‹å…¨éƒ¨éœ€è¦åœ¨å†…å­˜é‡Œå®ç°ï¼Œè€Œå¦‚æœæœ‰äº†ç´¢å¼•çš„è¯ï¼Œæ°å·§è¿™ä¸ªåˆ†ç»„é¡ºåºåˆå’Œæˆ‘ä»¬çš„B+æ ‘ä¸­çš„ç´¢å¼•åˆ—çš„é¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œè€Œæˆ‘ä»¬çš„B+æ ‘ç´¢å¼•åˆæ˜¯æŒ‰ç…§ç´¢å¼•åˆ—æ’å¥½åºçš„ï¼Œè¿™ä¸æ­£å¥½ä¹ˆï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨B+æ ‘ç´¢å¼•è¿›è¡Œåˆ†ç»„ã€‚ å’Œä½¿ç”¨B+æ ‘ç´¢å¼•è¿›è¡Œæ’åºæ˜¯ä¸€ä¸ªé“ç†ï¼Œåˆ†ç»„åˆ—çš„é¡ºåºä¹Ÿéœ€è¦å’Œç´¢å¼•åˆ—çš„é¡ºåºä¸€è‡´ï¼Œä¹Ÿå¯ä»¥åªä½¿ç”¨ç´¢å¼•åˆ—ä¸­å·¦è¾¹çš„åˆ—è¿›è¡Œåˆ†ç»„ã€‚ å››ï¼Œå›è¡¨çš„ä»£ä»·çœ‹ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š 1SELECT * FROM single_table WHERE key_part1 &gt; &#x27;aaa&#x27; AND key_part1 &lt; &#x27;zzz&#x27;; åœ¨ä½¿ç”¨idx_key_partç´¢å¼•è¿›è¡ŒæŸ¥è¯¢æ—¶å¤§è‡´å¯ä»¥åˆ†ä¸ºè¿™ä¸¤ä¸ªæ­¥éª¤ï¼š ä»ç´¢å¼•idx_key_partå¯¹åº”çš„B+æ ‘ä¸­å–å‡ºkey_part1å€¼åœ¨aaaï½zzzä¹‹é—´çš„ç”¨æˆ·è®°å½•ã€‚ ç”±äºç´¢å¼•idx_key_partå¯¹åº”çš„B+æ ‘ç”¨æˆ·è®°å½•ä¸­åªåŒ…å«key_part1ã€key_part2ã€key_part3ã€idè¿™4ä¸ªå­—æ®µï¼Œè€ŒæŸ¥è¯¢åˆ—è¡¨æ˜¯*ï¼Œæ„å‘³ç€è¦æŸ¥è¯¢è¡¨ä¸­æ‰€æœ‰å­—æ®µï¼Œä¹Ÿå°±æ˜¯è¿˜è¦åŒ…æ‹¬å…¶ä»–å­—æ®µã€‚è¿™æ—¶éœ€è¦æŠŠä»ä¸Šä¸€æ­¥ä¸­è·å–åˆ°çš„æ¯ä¸€æ¡è®°å½•çš„idå­—æ®µéƒ½åˆ°èšç°‡ç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­æ‰¾åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„å›è¡¨ï¼Œç„¶åæŠŠå®Œæ•´çš„ç”¨æˆ·è®°å½•è¿”å›ç»™æŸ¥è¯¢ç”¨æˆ·ã€‚ ç”±äºç´¢å¼•idx_key_partå¯¹åº”çš„B+æ ‘ä¸­çš„è®°å½•é¦–å…ˆä¼šæŒ‰ç…§key_part1åˆ—çš„å€¼è¿›è¡Œæ’åºï¼Œæ‰€ä»¥å€¼åœ¨aaaï½zzzä¹‹é—´çš„è®°å½•åœ¨ç£ç›˜ä¸­çš„å­˜å‚¨æ˜¯ç›¸è¿çš„ï¼Œé›†ä¸­åˆ†å¸ƒåœ¨ä¸€ä¸ªæˆ–å‡ ä¸ªæ•°æ®é¡µä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«çš„æŠŠè¿™äº›è¿ç€çš„è®°å½•ä»ç£ç›˜ä¸­è¯»å‡ºæ¥ï¼Œè¿™ç§è¯»å–æ–¹å¼æˆ‘ä»¬ä¹Ÿå¯ä»¥ç§°ä¸ºé¡ºåºI/Oã€‚æ ¹æ®ç¬¬1æ­¥ä¸­è·å–åˆ°çš„è®°å½•çš„idå­—æ®µçš„å€¼å¯èƒ½å¹¶ä¸ç›¸è¿ï¼Œè€Œåœ¨èšç°‡ç´¢å¼•ä¸­è®°å½•æ˜¯æ ¹æ®idï¼ˆä¹Ÿå°±æ˜¯ä¸»é”®ï¼‰çš„é¡ºåºæ’åˆ—çš„ï¼Œæ‰€ä»¥æ ¹æ®è¿™äº›å¹¶ä¸è¿ç»­çš„idå€¼åˆ°èšç°‡ç´¢å¼•ä¸­è®¿é—®å®Œæ•´çš„ç”¨æˆ·è®°å½•å¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„æ•°æ®é¡µä¸­ï¼Œè¿™æ ·è¯»å–å®Œæ•´çš„ç”¨æˆ·è®°å½•å¯èƒ½è¦è®¿é—®æ›´å¤šçš„æ•°æ®é¡µï¼Œè¿™ç§è¯»å–æ–¹å¼æˆ‘ä»¬ä¹Ÿå¯ä»¥ç§°ä¸ºéšæœºI/Oã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé¡ºåºI/Oæ¯”éšæœºI/Oçš„æ€§èƒ½é«˜å¾ˆå¤šï¼Œæ‰€ä»¥æ­¥éª¤1çš„æ‰§è¡Œå¯èƒ½å¾ˆå¿«ï¼Œè€Œæ­¥éª¤2å°±æ…¢ä¸€äº›ã€‚æ‰€ä»¥è¿™ä¸ªä½¿ç”¨ç´¢å¼•idx_key_partçš„æŸ¥è¯¢æœ‰è¿™ä¹ˆä¸¤ä¸ªç‰¹ç‚¹ï¼š ä¼šä½¿ç”¨åˆ°ä¸¤ä¸ªB+æ ‘ç´¢å¼•ï¼Œä¸€ä¸ªäºŒçº§ç´¢å¼•ï¼Œä¸€ä¸ªèšç°‡ç´¢å¼•ã€‚ è®¿é—®äºŒçº§ç´¢å¼•ä½¿ç”¨é¡ºåºI/Oï¼Œè®¿é—®èšç°‡ç´¢å¼•ä½¿ç”¨éšæœºI/Oã€‚ éœ€è¦å›è¡¨çš„è®°å½•è¶Šå¤šï¼Œä½¿ç”¨äºŒçº§ç´¢å¼•çš„æ€§èƒ½å°±è¶Šä½ï¼Œç”šè‡³è®©æŸäº›æŸ¥è¯¢å®æ„¿ä½¿ç”¨å…¨è¡¨æ‰«æä¹Ÿä¸ä½¿ç”¨äºŒçº§ç´¢å¼•ã€‚æ¯”æ–¹è¯´key_part1å€¼åœ¨aaaï½zzzä¹‹é—´çš„ç”¨æˆ·è®°å½•æ•°é‡å å…¨éƒ¨è®°å½•æ•°é‡90%ä»¥ä¸Šï¼Œé‚£ä¹ˆå¦‚æœä½¿ç”¨idx_key_partç´¢å¼•çš„è¯ï¼Œæœ‰90%å¤šçš„idå€¼éœ€è¦å›è¡¨ï¼Œè¿˜ä¸å¦‚ç›´æ¥å»æ‰«æèšç°‡ç´¢å¼•ï¼ˆä¹Ÿå°±æ˜¯å…¨è¡¨æ‰«æï¼‰ã€‚ é‚£ä»€ä¹ˆæ—¶å€™é‡‡ç”¨å…¨è¡¨æ‰«æçš„æ–¹å¼ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨é‡‡ç”¨äºŒçº§ç´¢å¼• + å›è¡¨çš„æ–¹å¼å»æ‰§è¡ŒæŸ¥è¯¢å‘¢ï¼Ÿè¿™ä¸ªå°±æ˜¯æŸ¥è¯¢ä¼˜åŒ–å™¨åšçš„å·¥ä½œï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šäº‹å…ˆå¯¹è¡¨ä¸­çš„è®°å½•è®¡ç®—ä¸€äº›ç»Ÿè®¡æ•°æ®ï¼Œç„¶åå†åˆ©ç”¨è¿™äº›ç»Ÿè®¡æ•°æ®æ ¹æ®æŸ¥è¯¢çš„æ¡ä»¶æ¥è®¡ç®—ä¸€ä¸‹éœ€è¦å›è¡¨çš„è®°å½•æ•°ï¼Œéœ€è¦å›è¡¨çš„è®°å½•æ•°è¶Šå¤šï¼Œå°±è¶Šå€¾å‘äºä½¿ç”¨å…¨è¡¨æ‰«æï¼Œåä¹‹å€¾å‘äºä½¿ç”¨äºŒçº§ç´¢å¼• + å›è¡¨çš„æ–¹å¼ã€‚å½“ç„¶ä¼˜åŒ–å™¨åšçš„åˆ†æå·¥ä½œä¸ä»…ä»…æ˜¯è¿™ä¹ˆç®€å•ï¼Œä½†æ˜¯å¤§è‡´ä¸Šæ˜¯è¿™ä¸ªè¿‡ç¨‹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé™åˆ¶æŸ¥è¯¢è·å–è¾ƒå°‘çš„è®°å½•æ•°ä¼šè®©ä¼˜åŒ–å™¨æ›´å€¾å‘äºé€‰æ‹©ä½¿ç”¨äºŒçº§ç´¢å¼• + å›è¡¨çš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢ï¼Œå› ä¸ºå›è¡¨çš„è®°å½•è¶Šå°‘ï¼Œæ€§èƒ½æå‡å°±è¶Šé«˜ï¼Œæ¯”æ–¹è¯´ä¸Šè¾¹çš„æŸ¥è¯¢å¯ä»¥æ”¹å†™æˆè¿™æ ·ï¼š 1SELECT * FROM single_table WHERE key_part1 &gt; &#x27;aaa&#x27; AND key_part1 &lt; &#x27;zzz&#x27; LIMIT 10; æ·»åŠ äº†LIMIT 10çš„æŸ¥è¯¢æ›´å®¹æ˜“è®©ä¼˜åŒ–å™¨é‡‡ç”¨äºŒçº§ç´¢å¼• + å›è¡¨çš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢ã€‚ å¯¹äºæœ‰æ’åºéœ€æ±‚çš„æŸ¥è¯¢ï¼Œä¸Šè¾¹è®¨è®ºçš„é‡‡ç”¨å…¨è¡¨æ‰«æè¿˜æ˜¯äºŒçº§ç´¢å¼• + å›è¡¨çš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢çš„æ¡ä»¶ä¹Ÿæ˜¯æˆç«‹çš„ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š 1SELECT * FROM single_table ORDER BY key_part1, key_part2, key_part3; ç”±äºæŸ¥è¯¢åˆ—è¡¨æ˜¯*ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨äºŒçº§ç´¢å¼•è¿›è¡Œæ’åºçš„è¯ï¼Œéœ€è¦æŠŠæ’åºå®Œçš„äºŒçº§ç´¢å¼•è®°å½•å…¨éƒ¨è¿›è¡Œå›è¡¨æ“ä½œï¼Œè¿™æ ·æ“ä½œçš„æˆæœ¬è¿˜ä¸å¦‚ç›´æ¥éå†èšç°‡ç´¢å¼•ç„¶åå†è¿›è¡Œæ–‡ä»¶æ’åºï¼ˆfilesortï¼‰ä½ï¼Œæ‰€ä»¥ä¼˜åŒ–å™¨ä¼šå€¾å‘äºä½¿ç”¨å…¨è¡¨æ‰«æçš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæˆ‘ä»¬åŠ äº†LIMITå­å¥ï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1SELECT * FROM single_table ORDER BY key_part1, key_part2, key_part3 LIMIT 10; è¿™æ ·éœ€è¦å›è¡¨çš„è®°å½•ç‰¹åˆ«å°‘ï¼Œä¼˜åŒ–å™¨å°±ä¼šå€¾å‘äºä½¿ç”¨äºŒçº§ç´¢å¼• + å›è¡¨çš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ã€‚ äº”ï¼Œæ›´å¥½çš„åˆ›å»ºå’Œä½¿ç”¨ç´¢å¼•1. åªä¸ºäº†ç”¨äºæœç´¢ï¼Œæ’åº&amp;åˆ†ç»„çš„åˆ—åˆ›å»ºç´¢å¼•ä¹Ÿå°±æ˜¯è¯´ï¼Œåªä¸ºå‡ºç°åœ¨WHEREå­å¥ä¸­çš„åˆ—ã€è¿æ¥å­å¥ä¸­çš„è¿æ¥åˆ—ï¼Œæˆ–è€…å‡ºç°åœ¨ORDER BYæˆ–GROUP BYå­å¥ä¸­çš„åˆ—åˆ›å»ºç´¢å¼•ã€‚è€Œå‡ºç°åœ¨æŸ¥è¯¢åˆ—è¡¨ä¸­çš„åˆ—å°±æ²¡å¿…è¦å»ºç«‹ç´¢å¼•äº†ï¼š 1SELECT key_part1, key_part2 FROM single_table WHERE key_part3 = &#x27;Ashburn&#x27;; åƒæŸ¥è¯¢åˆ—è¡¨ä¸­çš„key_part1ã€key_part2è¿™ä¸¤ä¸ªåˆ—å°±ä¸éœ€è¦å»ºç«‹ç´¢å¼•ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºå‡ºç°åœ¨WHEREå­å¥ä¸­çš„key_part3åˆ—åˆ›å»ºç´¢å¼•å°±å¯ä»¥äº†ã€‚ 2. è€ƒè™‘åˆ—çš„åŸºæ•°åˆ—çš„åŸºæ•°æŒ‡çš„æ˜¯æŸä¸€åˆ—ä¸­ä¸é‡å¤æ•°æ®çš„ä¸ªæ•°ï¼Œæ¯”æ–¹è¯´æŸä¸ªåˆ—åŒ…å«å€¼2, 5, 8, 2, 5, 8, 2, 5, 8ï¼Œè™½ç„¶æœ‰9æ¡è®°å½•ï¼Œä½†è¯¥åˆ—çš„åŸºæ•°å´æ˜¯3ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è®°å½•è¡Œæ•°ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œåˆ—çš„åŸºæ•°è¶Šå¤§ï¼Œè¯¥åˆ—ä¸­çš„å€¼è¶Šåˆ†æ•£ï¼Œåˆ—çš„åŸºæ•°è¶Šå°ï¼Œè¯¥åˆ—ä¸­çš„å€¼è¶Šé›†ä¸­ã€‚è¿™ä¸ªåˆ—çš„åŸºæ•°æŒ‡æ ‡éå¸¸é‡è¦ï¼Œç›´æ¥å½±å“æˆ‘ä»¬æ˜¯å¦èƒ½æœ‰æ•ˆçš„åˆ©ç”¨ç´¢å¼•ã€‚å‡è®¾æŸä¸ªåˆ—çš„åŸºæ•°ä¸º1ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰è®°å½•åœ¨è¯¥åˆ—ä¸­çš„å€¼éƒ½ä¸€æ ·ï¼Œé‚£ä¸ºè¯¥åˆ—å»ºç«‹ç´¢å¼•æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œå› ä¸ºæ‰€æœ‰å€¼éƒ½ä¸€æ ·å°±æ— æ³•æ’åºï¼Œæ— æ³•è¿›è¡Œå¿«é€ŸæŸ¥æ‰¾äº†ï½ è€Œä¸”å¦‚æœæŸä¸ªå»ºç«‹äº†äºŒçº§ç´¢å¼•çš„åˆ—çš„é‡å¤å€¼ç‰¹åˆ«å¤šï¼Œé‚£ä¹ˆä½¿ç”¨è¿™ä¸ªäºŒçº§ç´¢å¼•æŸ¥å‡ºçš„è®°å½•è¿˜å¯èƒ½è¦åšå›è¡¨æ“ä½œï¼Œè¿™æ ·æ€§èƒ½æŸè€—å°±æ›´å¤§äº†ã€‚æ‰€ä»¥ç»“è®ºå°±æ˜¯ï¼šæœ€å¥½ä¸ºé‚£äº›åˆ—çš„åŸºæ•°å¤§çš„åˆ—å»ºç«‹ç´¢å¼•ï¼Œä¸ºåŸºæ•°å¤ªå°åˆ—çš„å»ºç«‹ç´¢å¼•æ•ˆæœå¯èƒ½ä¸å¥½ã€‚ 3. ç´¢å¼•åˆ—çš„ç±»å‹å°½é‡å°æˆ‘ä»¬åœ¨å®šä¹‰è¡¨ç»“æ„çš„æ—¶å€™è¦æ˜¾å¼çš„æŒ‡å®šåˆ—çš„ç±»å‹ï¼Œä»¥æ•´æ•°ç±»å‹ä¸ºä¾‹ï¼Œæœ‰TINYINTã€MEDIUMINTã€INTã€BIGINTè¿™ä¹ˆå‡ ç§ï¼Œå®ƒä»¬å ç”¨çš„å­˜å‚¨ç©ºé—´ä¾æ¬¡é€’å¢ï¼Œæˆ‘ä»¬è¿™é‡Œæ‰€è¯´çš„ç±»å‹å¤§å°æŒ‡çš„å°±æ˜¯è¯¥ç±»å‹è¡¨ç¤ºçš„æ•°æ®èŒƒå›´çš„å¤§å°ã€‚èƒ½è¡¨ç¤ºçš„æ•´æ•°èŒƒå›´å½“ç„¶ä¹Ÿæ˜¯ä¾æ¬¡é€’å¢ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å¯¹æŸä¸ªæ•´æ•°åˆ—å»ºç«‹ç´¢å¼•çš„è¯ï¼Œåœ¨è¡¨ç¤ºçš„æ•´æ•°èŒƒå›´å…è®¸çš„æƒ…å†µä¸‹ï¼Œå°½é‡è®©ç´¢å¼•åˆ—ä½¿ç”¨è¾ƒå°çš„ç±»å‹ï¼Œæ¯”å¦‚æˆ‘ä»¬èƒ½ä½¿ç”¨INTå°±ä¸è¦ä½¿ç”¨BIGINTï¼Œèƒ½ä½¿ç”¨MEDIUMINTå°±ä¸è¦ä½¿ç”¨INTï½ è¿™æ˜¯å› ä¸ºï¼š æ•°æ®ç±»å‹è¶Šå°ï¼Œåœ¨æŸ¥è¯¢æ—¶è¿›è¡Œçš„æ¯”è¾ƒæ“ä½œè¶Šå¿«ï¼ˆè¿™æ˜¯CPUå±‚æ¬¡çš„ä¸œè¥¿ï¼‰ æ•°æ®ç±»å‹è¶Šå°ï¼Œç´¢å¼•å ç”¨çš„å­˜å‚¨ç©ºé—´å°±è¶Šå°‘ï¼Œåœ¨ä¸€ä¸ªæ•°æ®é¡µå†…å°±å¯ä»¥æ”¾ä¸‹æ›´å¤šçš„è®°å½•ï¼Œä»è€Œå‡å°‘ç£ç›˜I/Oå¸¦æ¥çš„æ€§èƒ½æŸè€—ï¼Œä¹Ÿå°±æ„å‘³ç€å¯ä»¥æŠŠæ›´å¤šçš„æ•°æ®é¡µç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œä»è€ŒåŠ å¿«è¯»å†™æ•ˆç‡ã€‚ è¿™ä¸ªå»ºè®®å¯¹äºè¡¨çš„ä¸»é”®æ¥è¯´æ›´åŠ é€‚ç”¨ï¼Œå› ä¸ºä¸ä»…æ˜¯èšç°‡ç´¢å¼•ä¸­ä¼šå­˜å‚¨ä¸»é”®å€¼ï¼Œå…¶ä»–æ‰€æœ‰çš„äºŒçº§ç´¢å¼•çš„èŠ‚ç‚¹å¤„éƒ½ä¼šå­˜å‚¨ä¸€ä»½è®°å½•çš„ä¸»é”®å€¼ï¼Œå¦‚æœä¸»é”®é€‚ç”¨æ›´å°çš„æ•°æ®ç±»å‹ï¼Œä¹Ÿå°±æ„å‘³ç€èŠ‚çœæ›´å¤šçš„å­˜å‚¨ç©ºé—´å’Œæ›´é«˜æ•ˆçš„I/Oã€‚ 4. ä¸ºåˆ—å‰ç¼€å»ºç«‹ç´¢å¼•ä¸€ä¸ªå­—ç¬¦ä¸²å…¶å®æ˜¯ç”±è‹¥å¹²ä¸ªå­—ç¬¦ç»„æˆï¼Œå¦‚æœæˆ‘ä»¬åœ¨MySQLä¸­ä½¿ç”¨utf8å­—ç¬¦é›†å»å­˜å‚¨å­—ç¬¦ä¸²çš„è¯ï¼Œç¼–ç ä¸€ä¸ªå­—ç¬¦éœ€è¦å ç”¨1~3ä¸ªå­—èŠ‚ã€‚å‡è®¾æˆ‘ä»¬çš„å­—ç¬¦ä¸²å¾ˆé•¿ï¼Œé‚£å­˜å‚¨ä¸€ä¸ªå­—ç¬¦ä¸²å°±éœ€è¦å ç”¨å¾ˆå¤§çš„å­˜å‚¨ç©ºé—´ã€‚åœ¨æˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªå­—ç¬¦ä¸²åˆ—å»ºç«‹ç´¢å¼•æ—¶ï¼Œé‚£å°±æ„å‘³ç€åœ¨å¯¹åº”çš„B+æ ‘ä¸­æœ‰è¿™ä¹ˆä¸¤ä¸ªé—®é¢˜ï¼š B+æ ‘ç´¢å¼•ä¸­çš„è®°å½•éœ€è¦æŠŠè¯¥åˆ—çš„å®Œæ•´å­—ç¬¦ä¸²å­˜å‚¨èµ·æ¥ï¼Œè€Œä¸”å­—ç¬¦ä¸²è¶Šé•¿ï¼Œåœ¨ç´¢å¼•ä¸­å ç”¨çš„å­˜å‚¨ç©ºé—´è¶Šå¤§ã€‚ å¦‚æœB+æ ‘ç´¢å¼•ä¸­ç´¢å¼•åˆ—å­˜å‚¨çš„å­—ç¬¦ä¸²å¾ˆé•¿ï¼Œé‚£åœ¨åšå­—ç¬¦ä¸²æ¯”è¾ƒæ—¶ä¼šå ç”¨æ›´å¤šçš„æ—¶é—´ã€‚ ç´¢å¼•åˆ—çš„å­—ç¬¦ä¸²å‰ç¼€å…¶å®ä¹Ÿæ˜¯æ’å¥½åºçš„ï¼Œæ‰€ä»¥ç´¢å¼•çš„è®¾è®¡è€…æå‡ºäº†ä¸ªæ–¹æ¡ˆ â€” åªå¯¹å­—ç¬¦ä¸²çš„å‰å‡ ä¸ªå­—ç¬¦è¿›è¡Œç´¢å¼•ä¹Ÿå°±æ˜¯è¯´åœ¨äºŒçº§ç´¢å¼•çš„è®°å½•ä¸­åªä¿ç•™å­—ç¬¦ä¸²å‰å‡ ä¸ªå­—ç¬¦ã€‚è¿™æ ·åœ¨æŸ¥æ‰¾è®°å½•æ—¶è™½ç„¶ä¸èƒ½ç²¾ç¡®çš„å®šä½åˆ°è®°å½•çš„ä½ç½®ï¼Œä½†æ˜¯èƒ½å®šä½åˆ°ç›¸åº”å‰ç¼€æ‰€åœ¨çš„ä½ç½®ï¼Œç„¶åæ ¹æ®å‰ç¼€ç›¸åŒçš„è®°å½•çš„ä¸»é”®å€¼å›è¡¨æŸ¥è¯¢å®Œæ•´çš„å­—ç¬¦ä¸²å€¼ï¼Œå†å¯¹æ¯”å°±å¥½äº†ã€‚è¿™æ ·åªåœ¨B+æ ‘ä¸­å­˜å‚¨å­—ç¬¦ä¸²çš„å‰å‡ ä¸ªå­—ç¬¦çš„ç¼–ç ï¼Œæ—¢èŠ‚çº¦ç©ºé—´ï¼Œåˆå‡å°‘äº†å­—ç¬¦ä¸²çš„æ¯”è¾ƒæ—¶é—´ï¼Œè¿˜å¤§æ¦‚èƒ½è§£å†³æ’åºçš„é—®é¢˜ã€‚ 5. è¦†ç›–ç´¢å¼•ä¸ºäº†å½»åº•å‘Šåˆ«å›è¡¨æ“ä½œå¸¦æ¥çš„æ€§èƒ½æŸè€—ï¼Œå»ºè®®ï¼šæœ€å¥½åœ¨æŸ¥è¯¢åˆ—è¡¨é‡ŒåªåŒ…å«ç´¢å¼•åˆ—ï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1SELECT key_part1, key_part2 FROM single_table WHERE key_part3 = &#x27;Ashburn&#x27;; å› ä¸ºæˆ‘ä»¬åªæŸ¥è¯¢key_part1, key_part2, è¿™2ä¸ªç´¢å¼•åˆ—çš„å€¼ï¼Œæ‰€ä»¥åœ¨é€šè¿‡idx_key_partç´¢å¼•å¾—åˆ°ç»“æœåå°±ä¸å¿…åˆ°èšç°‡ç´¢å¼•ä¸­å†æŸ¥æ‰¾è®°å½•çš„å‰©ä½™åˆ—ï¼Œè¿™æ ·å°±çœå»äº†å›è¡¨æ“ä½œå¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚æˆ‘ä»¬æŠŠè¿™ç§åªéœ€è¦ç”¨åˆ°ç´¢å¼•çš„æŸ¥è¯¢æ–¹å¼ç§°ä¸ºç´¢å¼•è¦†ç›–ã€‚æ’åºæ“ä½œä¹Ÿä¼˜å…ˆä½¿ç”¨è¦†ç›–ç´¢å¼•çš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢ï¼Œæ¯”æ–¹è¯´è¿™ä¸ªæŸ¥è¯¢ï¼š 1SELECT key_part1, key_part2, key_part3 FROM person_info ORDER BYkey_part1, key_part2, key_part3; è™½ç„¶è¿™ä¸ªæŸ¥è¯¢ä¸­æ²¡æœ‰LIMITå­å¥ï¼Œä½†æ˜¯é‡‡ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œæ‰€ä»¥æŸ¥è¯¢ä¼˜åŒ–å™¨å°±ä¼šç›´æ¥ä½¿ç”¨idx_key_partç´¢å¼•è¿›è¡Œæ’åºè€Œä¸éœ€è¦å›è¡¨æ“ä½œäº†ã€‚ å½“ç„¶ï¼Œå¦‚æœä¸šåŠ¡éœ€è¦æŸ¥è¯¢å‡ºç´¢å¼•ä»¥å¤–çš„åˆ—ï¼Œé‚£è¿˜æ˜¯ä»¥ä¿è¯ä¸šåŠ¡éœ€æ±‚ä¸ºé‡ã€‚ä½†æ˜¯å°½é‡ä¸è¦ç”¨ç”¨*å·ä½œä¸ºæŸ¥è¯¢åˆ—è¡¨ï¼Œæœ€å¥½æŠŠéœ€è¦æŸ¥è¯¢çš„åˆ—ä¾æ¬¡æ ‡æ˜ã€‚ 6.ä¸è¦ä¹±åŠ¨åˆ—åå‡è®¾è¡¨ä¸­æœ‰ä¸€ä¸ªæ•´æ•°åˆ—my_colï¼Œæˆ‘ä»¬ä¸ºè¿™ä¸ªåˆ—å»ºç«‹äº†ç´¢å¼•ã€‚ä¸‹è¾¹çš„ä¸¤ä¸ªWHEREå­å¥è™½ç„¶è¯­ä¹‰æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯åœ¨æ•ˆç‡ä¸Šå´æœ‰å·®åˆ«ï¼š WHERE my_col * 2 &lt; 4 WHERE my_col &lt; 4/2 ç¬¬1ä¸ªWHEREå­å¥ä¸­my_colåˆ—å¹¶ä¸æ˜¯ä»¥å•ç‹¬åˆ—çš„å½¢å¼å‡ºç°çš„ï¼Œè€Œæ˜¯ä»¥my_col * 2è¿™æ ·çš„è¡¨è¾¾å¼çš„å½¢å¼å‡ºç°çš„ï¼Œå­˜å‚¨å¼•æ“ä¼šä¾æ¬¡éå†æ‰€æœ‰çš„è®°å½•ï¼Œè®¡ç®—è¿™ä¸ªè¡¨è¾¾å¼çš„å€¼æ˜¯ä¸æ˜¯å°äº4ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸‹æ˜¯ä½¿ç”¨ä¸åˆ°ä¸ºmy_colåˆ—å»ºç«‹çš„B+æ ‘ç´¢å¼•çš„ã€‚è€Œç¬¬2ä¸ªWHEREå­å¥ä¸­my_colåˆ—å¹¶æ˜¯ä»¥å•ç‹¬åˆ—çš„å½¢å¼å‡ºç°çš„ï¼Œè¿™æ ·çš„æƒ…å†µå¯ä»¥ç›´æ¥ä½¿ç”¨B+æ ‘ç´¢å¼•ã€‚ æ‰€ä»¥ç»“è®ºå°±æ˜¯ï¼šå¦‚æœç´¢å¼•åˆ—åœ¨æ¯”è¾ƒè¡¨è¾¾å¼ä¸­ä¸æ˜¯ä»¥å•ç‹¬åˆ—çš„å½¢å¼å‡ºç°ï¼Œè€Œæ˜¯ä»¥æŸä¸ªè¡¨è¾¾å¼ï¼Œæˆ–è€…å‡½æ•°è°ƒç”¨å½¢å¼å‡ºç°çš„è¯ï¼Œæ˜¯ç”¨ä¸åˆ°ç´¢å¼•çš„ã€‚ 7. å°½é‡ç»´æŒæœ‰åºæ’å…¥å¯¹äºä¸€ä¸ªä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼Œåœ¨æˆ‘ä»¬æ²¡æœ‰æ˜¾å¼çš„åˆ›å»ºç´¢å¼•æ—¶ï¼Œè¡¨ä¸­çš„æ•°æ®å®é™…ä¸Šéƒ½æ˜¯å­˜å‚¨åœ¨èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹çš„ã€‚è€Œè®°å½•åˆæ˜¯å­˜å‚¨åœ¨æ•°æ®é¡µä¸­çš„ï¼Œæ•°æ®é¡µå’Œè®°å½•åˆæ˜¯æŒ‰ç…§è®°å½•ä¸»é”®å€¼ä»å°åˆ°å¤§çš„é¡ºåºè¿›è¡Œæ’åºï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æ’å…¥çš„è®°å½•çš„ä¸»é”®å€¼æ˜¯ä¾æ¬¡å¢å¤§çš„è¯ï¼Œé‚£æˆ‘ä»¬æ¯æ’æ»¡ä¸€ä¸ªæ•°æ®é¡µå°±æ¢åˆ°ä¸‹ä¸€ä¸ªæ•°æ®é¡µç»§ç»­æ’ï¼Œè€Œå¦‚æœæˆ‘ä»¬æ’å…¥çš„ä¸»é”®å€¼å¿½å¤§å¿½å°çš„è¯ï¼Œè¿™å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œå‡è®¾æŸä¸ªæ•°æ®é¡µå­˜å‚¨çš„è®°å½•å·²ç»æ»¡äº†ï¼Œå®ƒå­˜å‚¨çš„ä¸»é”®å€¼åœ¨1~100ä¹‹é—´ï¼š å¦‚æœæ­¤æ—¶å†æ’å…¥ä¸€æ¡ä¸»é”®å€¼ä¸º9çš„è®°å½•ï¼Œé‚£å®ƒæ’å…¥çš„ä½ç½®å°±å¦‚ä¸‹å›¾ï¼š å¯è¿™ä¸ªæ•°æ®é¡µå·²ç»æ»¡äº†ï¼Œå†æ’è¿›æ¥å’‹åŠå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦æŠŠå½“å‰é¡µé¢åˆ†è£‚æˆä¸¤ä¸ªé¡µé¢ï¼ŒæŠŠæœ¬é¡µä¸­çš„ä¸€äº›è®°å½•ç§»åŠ¨åˆ°æ–°åˆ›å»ºçš„è¿™ä¸ªé¡µä¸­ã€‚é¡µé¢åˆ†è£‚å’Œè®°å½•ç§»ä½æ„å‘³ç€ä»€ä¹ˆï¼Ÿæ„å‘³ç€ï¼šæ€§èƒ½æŸè€—ï¼æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³å°½é‡é¿å…è¿™æ ·æ— è°“çš„æ€§èƒ½æŸè€—ï¼Œæœ€å¥½è®©æ’å…¥çš„è®°å½•çš„ä¸»é”®å€¼ä¾æ¬¡é€’å¢ï¼Œè¿™æ ·å°±ä¸ä¼šå‘ç”Ÿè¿™æ ·çš„æ€§èƒ½æŸè€—äº†ã€‚æ‰€ä»¥æˆ‘ä»¬å»ºè®®ï¼šè®©ä¸»é”®å…·æœ‰**AUTO_INCREMENT**ï¼Œè®©å­˜å‚¨å¼•æ“è‡ªå·±ä¸ºè¡¨ç”Ÿæˆä¸»é”®ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æ‰‹åŠ¨æ’å…¥ ã€‚ 8.å†—ä½™å’Œé‡å¤ç´¢å¼•æˆ‘ä»¬çŸ¥é“ï¼Œé€šè¿‡idx_key_partç´¢å¼•å°±å¯ä»¥å¯¹key_part1åˆ—è¿›è¡Œå¿«é€Ÿæœç´¢ï¼Œå†åˆ›å»ºä¸€ä¸ªä¸“é—¨é’ˆå¯¹key_part1åˆ—çš„ç´¢å¼•å°±ç®—æ˜¯ä¸€ä¸ªå†—ä½™ç´¢å¼•ï¼Œç»´æŠ¤è¿™ä¸ªç´¢å¼•åªä¼šå¢åŠ ç»´æŠ¤çš„æˆæœ¬ï¼Œå¹¶ä¸ä¼šå¯¹æœç´¢æœ‰ä»€ä¹ˆå¥½å¤„ã€‚ è‡³æ­¤ï¼Œç´¢å¼•å‘½ä¸­çš„åŸç†å’Œæˆ‘ä»¬åœ¨å»ºç«‹ç´¢å¼•çš„æ—¶å€™åº”è¯¥æ³¨æ„ä»€ä¹ˆå°±åˆ†æå®Œäº†ï¼Œå¥½å®¶ä¼™ï¼Œåˆæ˜¯ä¸€ä¸ªé€šå®µã€‚","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[ä¸‰]InnoDBç´¢å¼•ç»“æ„","slug":"MySQL/MySQL[ä¸‰]InnoDBç´¢å¼•ç»“æ„","date":"2022-01-11T03:08:18.570Z","updated":"2022-01-11T03:14:40.784Z","comments":true,"path":"2022/01/11/MySQL/MySQL[ä¸‰]InnoDBç´¢å¼•ç»“æ„/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E4%B8%89]InnoDB%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84/","excerpt":"","text":"ç´¢å¼•å…¶å®å°±æ˜¯å¯¹æ•°æ®æŒ‰ç…§æŸç§æ ¼å¼è¿›è¡Œå­˜å‚¨çš„æ–‡ä»¶ã€‚å°±InnoDBæ¥è®²ï¼Œç´¢å¼•æ–‡ä»¶é‡Œé¢ä¼šæœ‰å¾ˆå¤šçš„åŸºæœ¬å•å…ƒã€é¡µã€‘ã€‚â€‹ ä¸ºä»€ä¹ˆæœ‰é¡µçš„æ¦‚å¿µï¼Ÿâ€‹ æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ç›´æ¥äº¤äº’ç£ç›˜ï¼Œæ•ˆç‡æ˜¾ç„¶åˆä¼šå¾ˆæ…¢ï¼Œæ‰€ä»¥çœŸæ­£å¤„ç†æ•°æ®çš„è¿‡ç¨‹å…¶å®æ˜¯åœ¨å†…å­˜ä¸­ï¼Œè¿™æ ·å°±éœ€è¦æŠŠç£ç›˜çš„æ•°æ®åŠ è½½åˆ°å†…å­˜ï¼Œå¦‚æœæ˜¯å†™æ“ä½œï¼Œå¯èƒ½è¿˜è¦å°†å†…å­˜çš„æ•°æ®å†æ¬¡åˆ·æ–°åˆ°ç£ç›˜ã€‚å¦‚æœå†…å­˜ä¸ç£ç›˜çš„æ•°æ®äº¤äº’è¿‡ç¨‹æ˜¯åŸºäºä¸€æ¡æ¡è®°å½•æ¥è¿›è¡Œçš„ï¼Œæ˜¾ç„¶åˆä¼šå¾ˆæ…¢ï¼Œæ‰€ä»¥InnoDBé‡‡å–çš„æ–¹å¼æ˜¯å°†æ•°æ®åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªé¡µï¼Œä»¥é¡µæ¥ä½œä¸ºå†…å­˜å’Œç£ç›˜äº¤äº’çš„åŸºæœ¬å•ä½ï¼Œé»˜è®¤å¤§å°ä¸º16KBã€‚ â€‹ æ•°æ®æˆ–è€…å«è®°å½•ï¼Œå…¶å®æ˜¯ä»¥ã€è¡Œã€‘çš„æ ¼å¼å­˜å‚¨åœ¨é¡µé‡Œé¢çš„ï¼Œå¯ä»¥ç®€å•çš„ç†è§£æˆé¡µé‡Œé¢çš„ä¸€è¡Œå¯¹åº”ä¸€æ¡è®°å½•ã€‚â€‹ å½“ç„¶ç´¢å¼•æ–‡ä»¶é‡Œé¢è‚¯å®šä¸å…‰åªæœ‰é¡µï¼Œè¿˜ä¼šæœ‰å…¶ä½™çš„ä¸œè¥¿ï¼Œé¡µé‡Œé¢ä¹Ÿä¸å…‰åªæœ‰è¡Œæ ¼å¼ï¼Œä¹Ÿä¼šæœ‰é¢å¤–çš„ä¿¡æ¯ï¼Œè¿™ä¸ªä¸‹é¢æˆ‘ä»¬ä¼šè¯¦ç»†åˆ†æï¼Œè‡³æ­¤æˆ‘ä»¬ä»…ä»…éœ€è¦æ˜ç¡®ä¸€ä¸‹ç´¢å¼•çš„æ¦‚å¿µå’Œå±‚çº§å…³ç³»ã€‚ æ˜ç¡®äº†è¿™ä¸ªå±‚çº§å…³ç³»ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä»æœ€åŸºç¡€çš„è¡Œæ ¼å¼æ¥è¿›è¡Œåˆ†æã€‚ ä¸€ï¼Œè¡Œæ ¼å¼æˆ‘ä»¬å¹³æ—¶éƒ½æ˜¯ä»¥è®°å½•ä¸ºå•ä½å‘è¡¨ä¸­æ’å…¥æ•°æ®çš„ï¼Œè¿™äº›è®°å½•åœ¨ç£ç›˜ä¸Šçš„å­˜å‚¨å½¢å¼è¢«ç§°ä¸ºè¡Œæ ¼å¼æˆ–è€…è®°å½•æ ¼å¼ï¼Œæˆªè‡³ç›®å‰ï¼Œä¸€å…±æœ‰4ç§è¡Œæ ¼å¼ã€‚åˆ†åˆ«æ˜¯ compact redundant dynamic compressedï¼ŒMySQL5.7é»˜è®¤çš„è¡Œæ ¼å¼ä¸ºdynamicã€‚ 1. å¦‚ä½•æŒ‡å®šè¡Œæ ¼å¼123CREATE TABLE è¡¨å (åˆ—çš„ä¿¡æ¯) ROW_FORMAT=è¡Œæ ¼å¼åç§° ALTER TABLE è¡¨å ROW_FORMAT=è¡Œæ ¼å¼åç§° æ¯”å¦‚æˆ‘ä»¬åˆ›å»ºä¸€å¼ è¡¨æ¥æŒ‡å®šè¡Œæ ¼å¼ï¼š 12345678create table record_format( c1 varchar(10), c2 varchar(10) not null, c3 char(10), c4 varchar(10))charset=ascii row_format=compact;INSERT INTO record_format_demo(c1, c2, c3, c4) VALUES(&#x27;aaaa&#x27;, &#x27;bbb&#x27;, &#x27;cc&#x27;, &#x27;d&#x27;), (&#x27;eeee&#x27;, &#x27;fff&#x27;, NULL, NULL); 2.compact è¡Œæ ¼å¼é¦–å…ˆæˆ‘ä»¬æ¥çœ‹Compactè¡Œæ ¼å¼ã€‚ ä¸€æ¡å®Œæ•´çš„è¡Œæ ¼å¼å¯ä»¥è¢«åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šè®°å½•é¢å¤–ä¿¡æ¯çš„éƒ¨åˆ†&amp;è®°å½•çœŸå®æ•°æ®çš„éƒ¨åˆ†ã€‚ 2.1 é¢å¤–çš„ä¿¡æ¯é¢å¤–çš„ä¿¡æ¯å®åŒ…å«ä¸‰éƒ¨åˆ†ï¼šå˜é•¿å­—æ®µçš„é•¿åº¦åˆ—è¡¨ï¼ŒNULLå€¼åˆ—è¡¨å’Œè®°å½•å¤´ä¿¡æ¯ã€‚ 2.1.1 å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨MySQLæ”¯æŒå¾ˆå¤šçš„å˜é•¿å­—æ®µï¼Œæˆ‘ä»¬å°±ä»¥æœ€ç»å…¸çš„varcharæ¥è¿›è¡Œä¸¾ä¾‹ï¼Œå˜é•¿å­—æ®µçš„æ•°æ®å­˜å‚¨å¤šå°‘å­—èŠ‚å…¶å®æ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€ä»¥åœ¨å­˜å‚¨çœŸå®çš„æ•°æ®çš„æ—¶å€™ï¼Œè¦è®°å½•ä¸€ä¸‹çœŸå®æ•°æ®çš„å­—èŠ‚æ•°ï¼Œè¿™æ ·çš„è¯ï¼Œä¸€ä¸ªå˜é•¿å­—æ®µåˆ—å®é™…ä¸Šå°±å ç”¨äº†ä¸¤éƒ¨åˆ†çš„ç©ºé—´æ¥å­˜å‚¨ï¼šã€çœŸå®æ•°æ®ã€‘&amp;ã€çœŸå®æ•°æ®å ç”¨å­—èŠ‚æ•°ã€‘ã€‚ æ³¨æ„ï¼šå¯¹äºä¸€ä¸ªåˆ—varchar(100)ï¼Œæˆ‘ä»¬å®é™…ä¸Šå­˜å‚¨ä¸€ä¸ª10å­—èŠ‚çš„æ•°æ®ï¼Œå½“åœ¨å†…å­˜ä¸­ä¸ºè¿™ä¸ªåˆ—çš„æ•°æ®åˆ†é…å†…å­˜ç©ºé—´çš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼šåˆ†é…100å­—èŠ‚ï¼Œä½†æ˜¯è¿™ä¸ªåˆ—çš„æ•°æ®åœ¨ç£ç›˜ä¸Šï¼Œå®é™…ä¸Šåªä¼šåˆ†é…10å­—èŠ‚ã€‚ åœ¨Compactè¡Œæ ¼å¼ä¸­ï¼Œä¼šæŠŠæ‰€æœ‰çš„å˜é•¿å­—æ®µå ç”¨çš„çœŸå®é•¿åº¦å…¨éƒ¨é€†åºå­˜å‚¨åœ¨è®°å½•çš„å¼€å¤´ä½ç½®ï¼Œå½¢æˆä¸€ä¸ªå˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ã€‚ æ¯”å¦‚æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„é‚£å¼ è¡¨ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š c1,c2,c4ä¸‰ä¸ªåˆ—éƒ½æ˜¯å˜é•¿å­—æ®µï¼Œæ‰€ä»¥è¿™ä¸‰ä¸ªåˆ—çš„å€¼çš„é•¿åº¦å…¶å®éƒ½éœ€è¦ä¿å­˜åˆ°å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œå› ä¸ºè¿™å¼ è¡¨çš„å­—ç¬¦é›†çš„ASCIIï¼Œæ‰€ä»¥æ¯ä¸ªå­—ç¬¦å®é™…åªå ç”¨1å­—èŠ‚æ¥è¿›è¡Œç¼–ç ï¼š åˆ—å å‚¨å­˜å†…å®¹ å†…å®¹é•¿åº¦(åè¿›åˆ¶è¡¨ç¤º) å†…å®¹é•¿åº¦(åå…­è¿›åˆ¶è¡¨ç¤º) C1 â€˜aaaaâ€™ 4 0x04 C2 â€˜bbbâ€™ 3 0x03 C4 â€˜dâ€™ 1 0x01 å› ä¸ºè¿™äº›é•¿åº¦æ˜¯æŒ‰ç…§é€†åºæ¥å­˜æ”¾çš„ï¼Œæ‰€ä»¥æœ€ç»ˆå˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨çš„å­—èŠ‚ä¸²ç”¨åå…­è¿›åˆ¶è¡¨ç¤ºçš„æ•ˆæœå°±æ˜¯ã€010304ã€‘ã€‚ å› ä¸ºæˆ‘ä»¬æ¼”ç¤ºçš„è¿™æ¡è®°å½•ä¸­ï¼Œc1,c2,c4åˆ—ä¸­çš„å­—ç¬¦ä¸²éƒ½æ¯”è¾ƒçŸ­ï¼Œæ‰€ä»¥çœŸå®çš„æ•°æ®å ç”¨çš„å­—èŠ‚æ•°å°±æ¯”è¾ƒå°ï¼ŒçœŸå®æ•°æ®çš„é•¿åº¦ç”¨ä¸€ä¸ªå­—èŠ‚å°±å¯ä»¥è¡¨ç¤ºï¼Œä½†æ˜¯å¦‚æœå˜é•¿åˆ—çš„å†…å®¹å ç”¨å­—èŠ‚æ•°æ¯”è¾ƒå¤šï¼Œå¯èƒ½å°±éœ€è¦ç”¨2ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚å¯¹æ­¤InnoDBçš„è§„å®šæ˜¯ï¼š ã€Wã€‘ï¼šæŸä¸ªå­—ç¬¦é›†ä¸­è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦ä½¿ç”¨çš„å­—èŠ‚æ•° ã€Mã€‘ï¼šå½“å‰åˆ—ç±»å‹æœ€å¤šèƒ½å­˜å‚¨çš„å­—ç¬¦æ•°(æ¯”å¦‚varchar(100),M=100),å¦‚æœæ¢ç®—æˆå­—èŠ‚æ•°å°±æ˜¯W*M ã€Lã€‘ï¼šçœŸå®å ç”¨çš„å­—èŠ‚æ•° å¦‚æœM*W&lt;=255,é‚£ä¹ˆä½¿ç”¨1å­—èŠ‚æ¥è¡¨ç¤ºå­—ç¬¦ä¸²å®é™…ç”¨åˆ°çš„å­—èŠ‚æ•°ã€‚ InnoDBåœ¨è¯»è®°å½•çš„å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨çš„æ—¶å€™ä¼šå…ˆå»æŸ¥çœ‹è¡¨ç»“æ„ï¼Œåˆ¤æ–­ç”¨å‡ ä¸ªå­—èŠ‚å»å­˜å‚¨çš„ã€‚ å¦‚æœM*W&gt;=255,è¿™ä¸ªæ—¶å€™å†æ¬¡åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š å¦‚æœL&lt;=127ï¼Œé‚£å°±ç”¨1ä¸ªå­—èŠ‚è¡¨ç¤º å¦åˆ™å°±ç”¨2ä¸ªå­—èŠ‚è¡¨ç¤º å¦‚æœæŸä¸ªå˜é•¿å­—æ®µå…è®¸å­˜å‚¨çš„æœ€å¤§å­—èŠ‚æ•°å¤§äº255çš„æ—¶å€™ï¼Œæ€ä¹ˆåŒºåˆ†ä»–æ­£åœ¨è¯»å–çš„å­—èŠ‚æ˜¯ä¸€ä¸ªå•ç‹¬çš„å­—æ®µé•¿åº¦è¿˜æ˜¯åŠä¸ªå­—æ®µé•¿åº¦å‘¢ï¼Ÿ InnoDBç”¨è¯¥å­—èŠ‚çš„ç¬¬ä¸€ä¸ªäºŒè¿›åˆ¶ä¸ºä½œä¸ºæ ‡å¿—ä½ï¼Œ0ï¼šå•ç‹¬çš„å­—æ®µé•¿åº¦ï¼Œ1ï¼šåŠä¸ªå­—æ®µé•¿åº¦ã€‚ å¯¹äºä¸€äº›å ç”¨å­—èŠ‚æ•°ç‰¹åˆ«å¤šçš„å­—æ®µï¼Œå•ä¸ªé¡µéƒ½æ— æ³•å­˜å‚¨çš„æ—¶å€™ï¼ŒInnoDBä¼šæŠŠä¸€éƒ¨åˆ†æ•°æ®æ”¾åˆ°æ‰€è°“çš„æº¢å‡ºé¡µï¼Œåœ¨å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ä¸­åªä¼šè®°å½•å½“å‰é¡µçš„å­—æ®µé•¿åº¦ï¼Œæ‰€ä»¥ç”¨ä¸¤ä¸ªå­—èŠ‚ä¹Ÿå¯ä»¥å­˜çš„ä¸‹ã€‚ æ­¤å¤–ï¼Œå˜é•¿å­—æ®µçš„é•¿åº¦åˆ—è¡¨ä¸­åªå­˜å‚¨çœŸå®æ•°æ®å€¼ä¸ºéNULLçš„åˆ—å ç”¨çš„é•¿åº¦ï¼ŒçœŸå®æ•°æ®ä¸ºNULLçš„åˆ—çš„é•¿åº¦æ˜¯ä¸å­˜å‚¨çš„ã€‚ ä¹Ÿå¹¶ä¸æ˜¯æ‰€æœ‰çš„è®°å½•éƒ½ä¼šæœ‰å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œå‡å¦‚è¡¨ä¸­çš„åˆ—è¦æ˜¯æ²¡æœ‰å˜é•¿å­—æ®µï¼Œæˆ–è€…è®°å½•ä¸­çš„å˜é•¿å­—æ®µå€¼éƒ½æ˜¯NULLï¼Œé‚£å°±æ²¡æœ‰å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨äº†ã€‚ 2.1.2 NULLå€¼åˆ—è¡¨å¦‚æœä¸€æ¡è®°å½•æœ‰å¤šä¸ªå­—æ®µçš„çœŸå®å€¼ä¸ºNULLï¼Œä¸ç»Ÿä¸€ç®¡ç†çš„è¯å°±ä¼šæ¯”è¾ƒå ç”¨ç©ºé—´ï¼Œæ‰€ä»¥æŠ½å–å‡ºæ¥äº†NULLå€¼åˆ—è¡¨ã€‚ å½“ç„¶å¦‚æœè¿™ä¸ªè¡¨çš„æ‰€æœ‰å­—æ®µéƒ½æ˜¯NOT NULLçº¦æŸçš„ï¼Œå°±ä¸ä¼šæœ‰NULLå€¼åˆ—è¡¨ã€‚ çœ‹ä¸€ä¸‹å¤„ç†è¿‡ç¨‹ï¼š é¦–å…ˆç»Ÿè®¡å‡ºè¡¨ä¸­å…è®¸å­˜å‚¨NULLçš„å­—æ®µ å¦‚æœè¡¨ä¸­æ²¡æœ‰NULLå­—æ®µçš„åˆ—ï¼Œé‚£å°±æ²¡å¿…è¦å†å¾€ä¸‹äº†ï¼Œå¦åˆ™å°†æ¯ä¸ªå…è®¸å­˜å‚¨NULLçš„åˆ—å¯¹åº”çš„ä¸€ä¸ªäºŒè¿›åˆ¶ä½æŒ‰ç…§åˆ—çš„é¡ºåºé€†åºæ’åˆ—ã€‚1ï¼šNULLï¼Œ0ï¼šä¸æ˜¯NULLã€‚ MySQLè§„å®šNULLå€¼å¿…é¡»ç”¨æ•´æ•°ä¸ªå­—èŠ‚çš„ä½è¡¨ç¤ºï¼Œå¦‚æœä½¿ç”¨çš„äºŒè¿›åˆ¶ä½ä¸ªæ•°ä¸æ˜¯æ•´æ•°ä¸ªå­—èŠ‚ï¼Œåˆ™åœ¨å­—èŠ‚çš„é«˜ä½è¡¥0ã€‚ ä»¥æ­¤ç±»æ¨ï¼Œå¦‚æœä¸€ä¸ªè¡¨ä¸­æœ‰9ä¸ªå­—æ®µå…è®¸ä¸ºNULLï¼Œé‚£ä¹ˆè¿™ä¸ªè®°å½•çš„NULLå€¼åˆ—è¡¨éƒ¨åˆ†å°±éœ€è¦2ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚ è¿™ä¸ªæ—¶å€™å†æ¥çœ‹æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„è¡¨ä¸­çš„è®°å½•ã€‚ 2.1.3 è®°å½•å¤´ä¿¡æ¯ç”±äº”ä¸ªå›ºå®šçš„å­—èŠ‚ç»„æˆï¼Œæ¢ç®—æˆäºŒè¿›åˆ¶å°±æ˜¯40ä½ï¼Œæ¯ä¸€éƒ¨åˆ†ä»£è¡¨ä¸åŒçš„ä¿¡æ¯ã€‚ åç§° å¤§å°(bit) æè¿° é¢„ç•™ä½1 1 æ²¡æœ‰ä½¿ç”¨ é¢„ç•™ä½2 1 æ²¡æœ‰ä½¿ç”¨ delete_mask 1 æ ‡è®°è¯¥è®°å½•æ˜¯å¦è¢«åˆ é™¤ min_rec_mask 1 B+æ ‘çš„æ¯å±‚éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•éƒ½ä¼šæ·»åŠ è¯¥æ ‡è®° n_owned 4 è¡¨ç¤ºå½“å‰è®°å½•æ‹¥æœ‰çš„è®°å½•æ•° heap_no 13 è¡¨ç¤ºå½“å‰è®°å½•åœ¨è®°å½•å †çš„ä½ç½®ä¿¡æ¯ record_type 3 è¡¨ç¤ºå½“å‰è®°å½•çš„ç±»å‹ 0 ï¼šæ™®é€šè®°å½•ï¼Œ1ï¼šB+æ ‘éé¡µèŠ‚ç‚¹è®°å½•ï¼Œ2ï¼šæœ€å°è®°å½•ï¼Œ3ï¼šæœ€å¤§è®°å½• next_record 16 ä¸‹ä¸€æ¡è®°å½•çš„ç›¸å¯¹ä½ç½® æ¥ä¸‹æ¥æ¥çœ‹è®°å½•çš„çœŸå®æ•°æ®ã€‚ 2.2 çœŸå®æ•°æ®é™¤äº†è¡¨ä¸­æ˜¾å¼å®šä¹‰çš„åˆ—ï¼ŒMySQLä¼šå¾€æˆ‘ä»¬çš„è¡¨ä¸­æ”¾ä¸€äº›éšè—åˆ—ã€‚ åˆ—å æ˜¯å¦å¿…é¡» å ç”¨ç©ºé—´ æè¿° row_id å¦ 6å­—èŠ‚ è¡ŒIDï¼Œå”¯ä¸€æ ‡è¯†ä¸€æ¡è®°å½• transaction_id æ˜¯ 6å­—èŠ‚ äº‹åŠ¡ID roll_pointer æ˜¯ 7å­—èŠ‚ å›æ»šæŒ‡é’ˆ ã€row_idã€‘ï¼šè¿™ä¸ªç©æ„ï¼Œè·Ÿä¸»é”®çš„é€‰æ‹©æœ‰å…³ï¼Œå¦‚æœæˆ‘ä»¬æ˜¾å¼å®šä¹‰äº†è¡¨çš„ä¸»é”®ï¼Œå°±ä¸ä¼šæœ‰å®ƒï¼Œå¦‚æœæˆ‘ä»¬æ²¡æ˜¾å¼å®šä¹‰ä¸»é”®ï¼Œé‚£ä¹ˆä¼šå»é€‰æ‹©ä¸€ä¸ªuniqueçš„åˆ—ä½œä¸ºä¸»é”®ï¼Œå¦‚æœuniqueçš„åˆ—ä¹Ÿæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±ä¼šç”Ÿæˆä¸€ä¸ªrow_idåˆ—ä½œä¸ºéšè—çš„ä¸»é”®ã€‚ ã€transaction_idã€‘&amp;ã€roll_pointerã€‘å’Œä¸€è‡´æ€§éé”è¯»(MVCC)æœ‰å…³,åé¢é‡åˆ°çš„æ—¶å€™æˆ‘ä¼šåœ¨åˆ†æä»‹ç»ã€‚ åœ¨å®Œå–„ä¸‹æˆ‘ä»¬å¼€å¤´åˆ›å»ºçš„é‚£å¼ è¡¨çš„è®°å½•å½¢è±¡ã€‚ è‡³æ­¤ï¼Œå…¶å®å°±å‰©ä¸‹æˆ‘ä»¬æ˜¾å¼æ’å…¥æ•°æ®åº“çš„çœŸå®è®°å½•äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç±»å‹éœ€è¦è¯´æ˜ä¸€ä¸‹ã€‚ 2.2.1 CHAR ä¹Ÿæ˜¯å˜é•¿çš„ï¼Ÿåœ¨Compactè¡Œæ ¼å¼ä¸‹åªä¼šæŠŠå˜é•¿ç±»å‹çš„åˆ—çš„é•¿åº¦é€†åºè®°å½•åˆ°å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œä½†æ˜¯è¿™å…¶å®å’Œæˆ‘ä»¬çš„å­—ç¬¦é›†æœ‰å…³ç³»ï¼Œä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„è¡¨æ˜¾å¼æŒ‡å®šä¸ºASCIIå­—ç¬¦é›†ï¼Œè¿™ä¸ªæ—¶å€™ä¸€ä¸ªå­—ç¬¦åªä¼šç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œä½†æ˜¯å‡å¦‚æˆ‘ä»¬æŒ‡å®šçš„æ˜¯å…¶å®ƒå­—ç¬¦é›†ï¼Œæ¯”å¦‚utf8ï¼Œè¿™ä¸ªæ—¶å€™ä¸€ä¸ªå­—ç¬¦ç”¨å‡ ä¸ªå­—èŠ‚è¡¨ç¤ºå°±ä¸ç¡®å®šäº†ï¼Œæ‰€ä»¥CHARåˆ—çš„çœŸå®å­—èŠ‚é•¿åº¦ä¹Ÿä¼šè¢«è®°å½•åˆ°å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ã€‚ å¦å¤–ï¼Œå˜é•¿å­—ç¬¦é›†çš„CHAR(M)ç±»å‹çš„åˆ—è¦æ±‚è‡³å°‘å ç”¨Mä¸ªå­—èŠ‚ï¼Œè€ŒVARCHAR(M)å°±æ²¡æœ‰è¿™ä¸ªè¦æ±‚ã€‚ å¯¹äºä½¿ç”¨utf8å­—ç¬¦é›†çš„CHAR(10)çš„åˆ—æ¥è¯´ï¼Œè¯¥åˆ—å­˜å‚¨çš„æ•°æ®å­—èŠ‚é•¿åº¦çš„èŒƒå›´æ˜¯10ï½30ä¸ªå­—èŠ‚ã€‚å³ä½¿æˆ‘ä»¬å‘è¯¥åˆ—ä¸­å­˜å‚¨ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ä¹Ÿä¼šå ç”¨10ä¸ªå­—èŠ‚ï¼Œè¿™æ˜¯æ€•å°†æ¥æ›´æ–°è¯¥åˆ—çš„å€¼çš„å­—èŠ‚é•¿åº¦å¤§äºåŸæœ‰å€¼çš„å­—èŠ‚é•¿åº¦è€Œå°äº10ä¸ªå­—èŠ‚æ—¶ï¼Œå¯ä»¥åœ¨è¯¥è®°å½•å¤„ç›´æ¥æ›´æ–°ï¼Œè€Œä¸æ˜¯åœ¨å­˜å‚¨ç©ºé—´ä¸­é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„è®°å½•ç©ºé—´ï¼Œå¯¼è‡´åŸæœ‰çš„è®°å½•ç©ºé—´æˆä¸ºæ‰€è°“çš„ç¢ç‰‡ã€‚ 3. è¡Œæº¢å‡ºä¸Šé¢æåˆ°äº†ï¼Œå¦‚æœä¸€æ¡è®°å½•çš„çœŸå®å­—èŠ‚æ•°å¤ªå¤§ï¼Œå°±ä¼šå¯¼è‡´è¡Œæº¢å‡ºï¼ŒæŠŠè¶…å‡ºçš„ä¸€éƒ¨åˆ†æ•°æ®å­˜å‚¨åˆ°å…¶ä»–è¡Œæˆ–è€…é¡µã€‚ 3.1 varchar(M)æœ€å¤šèƒ½å­˜å‚¨çš„æ•°æ®varchar(M)çš„åˆ—æœ€å¤šå¯ä»¥å ç”¨65535ä¸ªå­—èŠ‚ã€‚å…¶ä¸­Mä»£è¡¨è¯¥ç±»å‹æœ€å¤šå­˜å‚¨çš„å­—ç¬¦æ•°é‡ã€‚ å®é™…ä¸Šï¼ŒMySQLå¯¹ä¸€æ¡è®°å½•å ç”¨çš„æœ€å¤§å­˜å‚¨ç©ºé—´æ˜¯æœ‰é™åˆ¶çš„ï¼Œé™¤äº†BLOBï¼ŒTEXTç±»å‹çš„åˆ—ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰çš„åˆ—(ä¸åŒ…å«éšè—åˆ—å’Œè®°å½•å¤´ä¿¡æ¯)å ç”¨çš„å­—èŠ‚é•¿åº¦åŠ èµ·æ¥ä¸èƒ½è¶…è¿‡65535ä¸ªå­—èŠ‚ã€‚è¿™ä¸ª65535ä¸ªå­—èŠ‚é™¤äº†åˆ—æœ¬èº«çš„æ•°æ®ä¹‹å¤–ï¼Œè¿˜åŒ…æ‹¬ä¸€äº›å…¶ä»–çš„æ•°æ®ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ä¸ºäº†å­˜å‚¨ä¸€ä¸ªvarcharåˆ—ï¼Œå…¶å®è¿˜éœ€è¦å ç”¨3éƒ¨åˆ†ç©ºé—´ã€‚ çœŸå®æ•°æ® çœŸå®æ•°æ®å ç”¨çš„å­—èŠ‚é•¿åº¦ NULLå€¼æ ‡è¯†ï¼Œå¦‚æœè¯¥åˆ—æœ‰NOT_NULLå±æ€§åˆ™å¯ä»¥æ²¡æœ‰è¿™éƒ¨åˆ†å­˜å‚¨ç©ºé—´ å¦‚æœè¯¥varcharç±»å‹çš„åˆ—æ²¡æœ‰NOT NULLå±æ€§é‚£æœ€å¤šåªèƒ½å­˜å‚¨65532ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå› ä¸ºçœŸå®æ•°æ®çš„é•¿åº¦å¯èƒ½å ç”¨2ä¸ªå­—èŠ‚ï¼ŒNULLå€¼æ ‡è¯†éœ€è¦å ç”¨1ä¸ªå­—èŠ‚ã€‚ å¦‚æœVARCHARç±»å‹çš„åˆ—æœ‰NOT NULLå±æ€§ï¼Œé‚£æœ€å¤šåªèƒ½å­˜å‚¨65533ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå› ä¸ºçœŸå®æ•°æ®çš„é•¿åº¦å¯èƒ½å ç”¨2ä¸ªå­—èŠ‚ï¼Œä¸éœ€è¦NULLå€¼æ ‡è¯†ã€‚ å¦‚æœVARCHAR(M)ç±»å‹çš„åˆ—ä½¿ç”¨çš„ä¸æ˜¯asciiå­—ç¬¦é›†ï¼Œé‚£ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ å¦‚æœVARCHAR(M)ç±»å‹çš„åˆ—ä½¿ç”¨çš„ä¸æ˜¯asciiå­—ç¬¦é›†ï¼Œé‚£Mçš„æœ€å¤§å–å€¼å–å†³äºè¯¥å­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦çš„å­—èŠ‚æ•°ã€‚åœ¨åˆ—çš„å€¼å…è®¸ä¸ºNULLçš„æƒ…å†µä¸‹ï¼Œgbkå­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦2ä¸ªå­—èŠ‚ï¼Œé‚£åœ¨è¯¥å­—ç¬¦é›†ä¸‹ï¼ŒMçš„æœ€å¤§å–å€¼å°±æ˜¯32766ï¼ˆä¹Ÿå°±æ˜¯ï¼š65532/2ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å¤šèƒ½å­˜å‚¨32766ä¸ªå­—ç¬¦ï¼›utf8å­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦3ä¸ªå­—èŠ‚ï¼Œé‚£åœ¨è¯¥å­—ç¬¦é›†ä¸‹ï¼ŒMçš„æœ€å¤§å–å€¼å°±æ˜¯21844ï¼Œå°±æ˜¯è¯´æœ€å¤šèƒ½å­˜å‚¨21844ï¼ˆä¹Ÿå°±æ˜¯ï¼š65532/3ï¼‰ä¸ªå­—ç¬¦ã€‚ ä¸Šè¿°æ‰€è¨€åœ¨åˆ—çš„å€¼å…è®¸ä¸ºNULLçš„æƒ…å†µä¸‹ï¼Œgbkå­—ç¬¦é›†ä¸‹Mçš„æœ€å¤§å–å€¼å°±æ˜¯32766ï¼Œutf8å­—ç¬¦é›†ä¸‹Mçš„æœ€å¤§å–å€¼å°±æ˜¯21844ï¼Œè¿™éƒ½æ˜¯åœ¨è¡¨ä¸­åªæœ‰ä¸€ä¸ªå­—æ®µçš„æƒ…å†µä¸‹è¯´çš„ï¼Œä¸€å®šè¦è®°ä½ä¸€ä¸ªè¡Œä¸­çš„æ‰€æœ‰åˆ—ï¼ˆä¸åŒ…æ‹¬éšè—åˆ—å’Œè®°å½•å¤´ä¿¡æ¯ï¼‰å ç”¨çš„å­—èŠ‚é•¿åº¦åŠ èµ·æ¥ä¸èƒ½è¶…è¿‡65535ä¸ªå­—èŠ‚ï¼ 3.2 è®°å½•ä¸­çš„æ•°æ®å¤ªå¤šäº§ç”Ÿæº¢å‡ºMySQLä¸­ç£ç›˜å’Œå†…å­˜äº¤äº’çš„åŸºæœ¬å•ä½æ˜¯é¡µï¼Œä¹Ÿå°±æ˜¯è¯´MySQLæ˜¯ä»¥é¡µä¸ºåŸºæœ¬å•ä½æ¥ç®¡ç†å­˜å‚¨ç©ºé—´çš„ï¼Œæˆ‘ä»¬çš„è®°å½•éƒ½ä¼šè¢«åˆ†é…åˆ°æŸä¸ªé¡µä¸­å­˜å‚¨ã€‚è€Œä¸€ä¸ªé¡µçš„å¤§å°ä¸€èˆ¬æ˜¯16KBï¼Œä¹Ÿå°±æ˜¯16384å­—èŠ‚ï¼Œè€Œä¸€ä¸ªVARCHAR(M)ç±»å‹çš„åˆ—å°±æœ€å¤šå¯ä»¥å­˜å‚¨65532ä¸ªå­—èŠ‚ï¼Œè¿™æ ·å°±å¯èƒ½é€ æˆä¸€ä¸ªé¡µå­˜æ”¾ä¸äº†ä¸€æ¡è®°å½•çš„å°´å°¬æƒ…å†µã€‚ åœ¨Compactå’ŒRedundantè¡Œæ ¼å¼ä¸­ï¼Œå¯¹äºå ç”¨å­˜å‚¨ç©ºé—´éå¸¸å¤§çš„åˆ—ï¼Œåœ¨è®°å½•çš„çœŸå®æ•°æ®å¤„åªä¼šå­˜å‚¨è¯¥åˆ—çš„ä¸€éƒ¨åˆ†æ•°æ®ï¼ŒæŠŠå‰©ä½™çš„æ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å‡ ä¸ªå…¶ä»–çš„é¡µä¸­ï¼Œç„¶åè®°å½•çš„çœŸå®æ•°æ®å¤„ç”¨20ä¸ªå­—èŠ‚å­˜å‚¨æŒ‡å‘è¿™äº›é¡µçš„åœ°å€ï¼ˆå½“ç„¶è¿™20ä¸ªå­—èŠ‚ä¸­è¿˜åŒ…æ‹¬è¿™äº›åˆ†æ•£åœ¨å…¶ä»–é¡µé¢ä¸­çš„æ•°æ®çš„å ç”¨çš„å­—èŠ‚æ•°ï¼‰ï¼Œä»è€Œå¯ä»¥æ‰¾åˆ°å‰©ä½™æ•°æ®æ‰€åœ¨çš„é¡µã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œå¯¹äºCompactå’ŒRedundantè¡Œæ ¼å¼æ¥è¯´ï¼Œå¦‚æœæŸä¸€åˆ—ä¸­çš„æ•°æ®éå¸¸å¤šçš„è¯ï¼Œåœ¨æœ¬è®°å½•çš„çœŸå®æ•°æ®å¤„åªä¼šå­˜å‚¨è¯¥åˆ—çš„å‰768ä¸ªå­—èŠ‚çš„æ•°æ®å’Œä¸€ä¸ªæŒ‡å‘å…¶ä»–é¡µçš„åœ°å€ï¼Œç„¶åæŠŠå‰©ä¸‹çš„æ•°æ®å­˜æ”¾åˆ°å…¶ä»–é¡µä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿå«åšè¡Œæº¢å‡ºï¼Œå­˜å‚¨è¶…å‡º768å­—èŠ‚çš„é‚£äº›é¡µé¢ä¹Ÿè¢«ç§°ä¸ºæº¢å‡ºé¡µã€‚ç”»ä¸€ä¸ªç®€å›¾å°±æ˜¯è¿™æ ·ï¼š ä¸åªæ˜¯ VARCHAR(M)ç±»å‹çš„åˆ—ï¼Œå…¶ä»–çš„ TEXTã€BLOB ç±»å‹çš„åˆ—åœ¨å­˜å‚¨æ•°æ®éå¸¸å¤šçš„æ—¶å€™ä¹Ÿä¼šå‘ç”Ÿè¡Œæº¢å‡ºã€‚ 3.3 è¡Œæº¢å‡ºçš„ä¸´ç•Œç‚¹å‘ç”Ÿè¡Œæº¢å‡ºçš„ä¸´ç•Œç‚¹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¹Ÿå°±æ˜¯è¯´åœ¨åˆ—å­˜å‚¨å¤šå°‘å­—èŠ‚çš„æ•°æ®æ—¶å°±ä¼šå‘ç”Ÿè¡Œæº¢å‡ºï¼Ÿ MySQLä¸­è§„å®šä¸€ä¸ªé¡µä¸­è‡³å°‘å­˜æ”¾ä¸¤è¡Œè®°å½•ï¼Œè‡³äºä¸ºä»€ä¹ˆè¿™ä¹ˆè§„å®šæˆ‘ä»¬ä¹‹åå†è¯´ï¼Œç°åœ¨çœ‹ä¸€ä¸‹è¿™ä¸ªè§„å®šé€ æˆçš„å½±å“ã€‚æˆ‘ä»¬å¾€è¡¨ä¸­æ’å…¥äº®æ¡è®°å½•ï¼Œæ¯æ¡è®°å½•æœ€å°‘æ’å…¥å¤šå°‘å­—èŠ‚çš„æ•°æ®æ‰ä¼šè¡Œæº¢å‡ºå‘¢ï¼Ÿ åˆ†æä¸€ä¸‹é¡µç©ºé—´æ˜¯å¦‚ä½•åˆ©ç”¨çš„ æ¯ä¸ªé¡µé™¤äº†å­˜æ”¾æˆ‘ä»¬çš„è®°å½•ä»¥å¤–ï¼Œä¹Ÿéœ€è¦å­˜å‚¨ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œä¹±ä¸ƒå…«ç³Ÿçš„é¢å¤–ä¿¡æ¯åŠ èµ·æ¥éœ€è¦132ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼ˆç°åœ¨åªè¦çŸ¥é“è¿™ä¸ªæ•°å­—å°±å¥½äº†ï¼‰ï¼Œå…¶ä»–çš„ç©ºé—´éƒ½å¯ä»¥è¢«ç”¨æ¥å­˜å‚¨è®°å½•ã€‚ æ¯ä¸ªè®°å½•éœ€è¦çš„é¢å¤–ä¿¡æ¯æ˜¯27å­—èŠ‚ã€‚è¿™27ä¸ªå­—èŠ‚åŒ…æ‹¬ä¸‹è¾¹è¿™äº›éƒ¨åˆ†ï¼š å†…å®¹ å¤§å°(å­—èŠ‚) çœŸå®æ•°æ®çš„é•¿åº¦ 2 åˆ—æ˜¯å¦æ˜¯NULLå€¼ 1 å¤´ä¿¡æ¯ 5 row_id 6 transaction_id 6 roll_pointer 7 å› ä¸ºè¡¨ä¸­å…·ä½“æœ‰å¤šå°‘åˆ—ä¸ç¡®å®šï¼Œæ‰€ä»¥æ²¡æ³•ç¡®å®šå…·ä½“çš„ä¸´ç•Œç‚¹ï¼Œåªéœ€è¦çŸ¥é“æ’å…¥çš„å­—æ®µæ•°æ®é•¿åº¦å¾ˆå¤§å°±ä¼šå¯¼è‡´è¡Œæº¢å‡ºçš„ç°è±¡ã€‚ 4.Dynamic &amp; Compressed è¡Œæ ¼å¼è¿™ä¿©è¡Œæ ¼å¼å’ŒCompactè¡Œæ ¼å¼æŒºåƒï¼Œåªä¸è¿‡åœ¨å¤„ç†è¡Œæº¢å‡ºæ•°æ®æ—¶æœ‰ç‚¹å„¿åˆ†æ­§ï¼Œå®ƒä»¬ä¸ä¼šåœ¨è®°å½•çš„çœŸå®æ•°æ®å¤„å­˜å‚¨å­—æ®µçœŸå®æ•°æ®çš„å‰768ä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯æŠŠæ‰€æœ‰çš„å­—èŠ‚éƒ½å­˜å‚¨åˆ°å…¶ä»–é¡µé¢ä¸­ï¼Œåªåœ¨è®°å½•çš„çœŸå®æ•°æ®å¤„å­˜å‚¨å…¶ä»–é¡µé¢çš„åœ°å€ï¼Œå°±åƒè¿™æ ·ï¼š Compressedè¡Œæ ¼å¼å’ŒDynamicä¸åŒçš„ä¸€ç‚¹æ˜¯ï¼ŒCompressedè¡Œæ ¼å¼ä¼šé‡‡ç”¨å‹ç¼©ç®—æ³•å¯¹é¡µé¢è¿›è¡Œå‹ç¼©ï¼Œä»¥èŠ‚çœç©ºé—´ã€‚ è‡³æ­¤ï¼Œè¡Œæ ¼å¼å°±åˆ†æçš„å·®ä¸å¤šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹é¡µçš„å­˜å‚¨ç»“æ„ã€‚ äºŒï¼Œé¡µçš„å­˜å‚¨ç»“æ„InnoDBä¸ºäº†ä¸åŒçš„ç›®çš„è®¾è®¡äº†è®¸å¤šç§é¡µï¼Œæ¯”å¦‚å­˜æ”¾è¡¨ç©ºé—´å¤´éƒ¨ä¿¡æ¯çš„é¡µï¼Œå­˜æ”¾ Insert Bufferä¿¡æ¯çš„é¡µï¼Œå­˜æ”¾Innodeä¿¡æ¯çš„é¡µï¼Œå­˜æ”¾undoæ—¥å¿—ä¿¡æ¯çš„é¡µç­‰ç­‰ã€‚ æœ¬èŠ‚åˆ†æå­˜æ”¾è¡¨ä¸­è®°å½•çš„é¡µï¼Œå®˜æ–¹æˆä¸ºç´¢å¼•é¡µï¼Œä¸ºäº†åˆ†ææ–¹ä¾¿ï¼Œæˆ‘ä»¬æš‚ä¸”å«åšæ•°æ®é¡µã€‚ ç³»ç»Ÿå˜é‡innodb_page_sizeè¡¨æ˜äº†InnoDBå­˜å‚¨å¼•æ“ä¸­çš„é¡µå¤§å°ï¼Œé»˜è®¤å€¼æ˜¯16384å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯16kbã€‚ è¯¥å˜é‡åªèƒ½åœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–MySQLæ•°æ®ç›®å½•æ—¶æŒ‡å®šï¼Œä¹‹åå°±å†ä¹Ÿä¸èƒ½æ›´æ”¹äº†ã€‚ æ•°æ®é¡µä»£è¡¨çš„è¿™å—16kbçš„å­˜å‚¨ç©ºé—´è¢«åˆ’åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†ï¼Œä¸åŒéƒ¨åˆ†æœ‰ä¸åŒçš„åŠŸèƒ½ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ªInnoDBæ•°æ®é¡µçš„å­˜å‚¨ç©ºé—´å¤§è‡´è¢«åˆ’åˆ†ä¸ºäº†7ä¸ªéƒ¨åˆ†ï¼Œæœ‰çš„éƒ¨åˆ†å ç”¨çš„å­—èŠ‚æ•°æ˜¯ç¡®å®šçš„ï¼Œæœ‰çš„å ç”¨çš„å­—èŠ‚æ•°ä¸æ˜¯ç¡®å®šçš„ã€‚ åç§° ä¸­æ–‡å å ç”¨ç©ºé—´å¤§å°ï¼ˆå­—èŠ‚ï¼‰ ç®€å•æè¿° File Header æ–‡ä»¶å¤´éƒ¨ 38 é¡µçš„ä¸€äº›é€šç”¨ä¿¡æ¯ Page Header é¡µé¢å¤´éƒ¨ 56 æ•°æ®é¡µä¸“æœ‰çš„ä¸€äº›ä¿¡æ¯ Infifmum + Supremum æœ€å°è®°å½•å’Œæœ€å¤§è®°å½• 26 ä¸¤ä¸ªè™šæ‹Ÿçš„è¡Œè®°å½• User Records ç”¨æˆ·è®°å½• ä¸ç¡®å®š å®é™…å­˜å‚¨çš„è¡Œè®°å½•å†…å®¹ Free Space ç©ºé—²ç©ºé—´ ä¸ç¡®å®š é¡µä¸­å°šæœªä½¿ç”¨çš„ç©ºé—´ Page Directory é¡µé¢ç›®å½• ä¸ç¡®å®š é¡µä¸­æŸäº›è®°å½•çš„ç›¸å¯¹ä½ç½® File Trailer æ–‡ä»¶å°¾éƒ¨ 8 æ ¡éªŒé¡µæ˜¯å¦å®Œæ•´ 1. è®°å½•åœ¨é¡µä¸­çš„å­˜å‚¨æˆ‘ä»¬å…ˆæ¥åˆ›å»ºä¸€å¼ è¡¨ 1234567mysql&gt; create table page_demo( -&gt; c1 int , -&gt; c2 int , -&gt; c3 varchar(10000), -&gt; primary key(c1) -&gt; ) charset=ascii row_format=Compact;Query OK, 0 rows affected (0.03 sec) å› ä¸ºæˆ‘ä»¬æŒ‡å®šäº†ä¸»é”®ï¼Œæ‰€ä»¥å­˜å‚¨å®é™…æ•°æ®çš„åˆ—é‡Œé¢ä¸ä¼šæœ‰éšè—çš„row_id,æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–çš„è¡Œæ ¼å¼ã€‚ å†æ¬¡å›é¡¾ä¸‹è®°å½•å¤´ä¸­5ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ•°æ®ã€‚ åç§° å¤§å°(bit) æè¿° é¢„ç•™ä½1 1 æ²¡æœ‰ä½¿ç”¨ é¢„ç•™ä½2 1 æ²¡æœ‰ä½¿ç”¨ delete_mask 1 æ ‡è®°è¯¥è®°å½•æ˜¯å¦è¢«åˆ é™¤ min_rec_mask 1 B+æ ‘çš„æ¯å±‚éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•éƒ½ä¼šæ·»åŠ è¯¥æ ‡è®° n_owned 4 è¡¨ç¤ºå½“å‰è®°å½•æ‹¥æœ‰çš„è®°å½•æ•° heap_no 13 è¡¨ç¤ºå½“å‰è®°å½•åœ¨è®°å½•å †çš„ä½ç½®ä¿¡æ¯ record_type 3 è¡¨ç¤ºå½“å‰è®°å½•çš„ç±»å‹ 0 ï¼šæ™®é€šè®°å½•ï¼Œ1ï¼šB+æ ‘éé¡µèŠ‚ç‚¹è®°å½•ï¼Œ2ï¼šæœ€å°è®°å½•ï¼Œ3ï¼šæœ€å¤§è®°å½• next_record 16 ä¸‹ä¸€æ¡è®°å½•çš„ç›¸å¯¹ä½ç½® é’ˆå¯¹å½“å‰è¿™ä¸ªè¡¨çš„è¡Œæ ¼å¼ç®€åŒ–å›¾ï¼š æ¥ä¸‹æ¥æˆ‘ä»¬å¾€è¡¨ä¸­æ’å…¥å‡ æ¡æ•°æ®ï¼š 1INSERT INTO page_demo VALUES(1, 100, &#x27;aaaa&#x27;), (2, 200, &#x27;bbbb&#x27;), (3, 300, &#x27;cccc&#x27;), (4, 400, &#x27;dddd&#x27;); ä¸ºäº†åˆ†æè¿™äº›è®°å½•åœ¨é¡µçš„User Records éƒ¨åˆ†ä¸­æ˜¯æ€ä¹ˆè¡¨ç¤ºçš„ï¼ŒæŠŠè®°å½•å¤´ä¿¡æ¯å’Œå®é™…çš„åˆ—æ•°æ®éƒ½ç”¨åè¿›åˆ¶è¡¨ç¤ºå‡ºæ¥äº†ï¼ˆå…¶å®æ˜¯ä¸€å †äºŒè¿›åˆ¶ä½ï¼‰ï¼Œæ‰€ä»¥è¿™äº›è®°å½•çš„ç¤ºæ„å›¾å°±æ˜¯ï¼š åˆ†æä¸€ä¸‹å¤´ä¿¡æ¯ä¸­çš„æ¯ä¸ªå±æ€§æ˜¯ä»€ä¹ˆæ„æ€ã€‚ 1.1 delete_maskæ ‡è®°å½“å‰è®°å½•æ˜¯å¦è¢«åˆ é™¤ï¼Œå ç”¨1ä¸ªäºŒè¿›åˆ¶ä½ï¼Œ0ï¼šæœªåˆ é™¤ï¼Œ1ï¼šåˆ é™¤ã€‚ è¢«åˆ é™¤çš„è®°å½•ä¸ä¼šç«‹å³ä»ç£ç›˜ä¸Šåˆ é™¤ï¼Œå› ä¸ºåˆ é™¤ä»–ä»¬ä¹‹åå§å…¶ä»–çš„è®°å½•åœ¨ç£ç›˜ä¸Šé‡æ–°æ’åˆ—éœ€è¦æ€§èƒ½æ¶ˆè€—ï¼Œæ‰€ä»¥åªæ˜¯æ‰“ä¸€ä¸ªåˆ é™¤æ ‡è®°ï¼Œæ‰€æœ‰è¢«åˆ æ‰çš„æ•°æ®ä¼šç»„æˆä¸€ä¸ªåƒåœ¾é“¾è¡¨ï¼Œåœ¨è¿™ä¸ªé“¾è¡¨ä¸­çš„è®°å½•å ç”¨çš„ç©ºé—´æˆä¸ºå¯é‡ç”¨ç©ºé—´ï¼Œä¹‹åå¦‚æœæœ‰æ–°çš„è®°å½•æ’å…¥åˆ°è¡¨ä¸­ï¼Œå¯èƒ½ä¼šæŠŠè¿™äº›åˆ é™¤çš„è®°å½•è¦†ç›–æ‰ã€‚ å°†delete_mask è®¾ç½®ä¸º1 å’Œ å°†è¢«åˆ é™¤çš„è®°å½•åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­å…¶å®æ˜¯ä¸¤ä¸ªé˜¶æ®µã€‚ 1.2 min_rec_maskB+æ ‘çš„æ¯å±‚éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•éƒ½ä¼šæ·»åŠ è¯¥æ ‡è®°ï¼Œå¦‚æœè¿™ä¸ªå­—æ®µçš„å€¼æ˜¯0ï¼Œæ„å‘³ç€ä¸æ˜¯B+æ ‘çš„éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•ã€‚ 1.3 n_owned1.4 heap_noè¿™ä¸ªå±æ€§è¡¨ç¤ºå½“å‰è®°å½•åœ¨æœ¬é¡µä¸­çš„ä½ç½®ï¼Œæˆ‘ä»¬æ’å…¥çš„å››æ¡è®°å½•åœ¨æœ¬é¡µä¸­çš„ä½ç½®åˆ†åˆ«æ˜¯ 2ï¼Œ3ï¼Œ4 ï¼Œ5 ã€‚ä¸ºä»€ä¹ˆä¸è§ 0 å’Œ 1 çš„è®°å½•å‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºInnoDBè‡ªåŠ¨ç»™æ¯ä¸ªé¡µé‡Œè¾¹åŠ äº†ä¸¤ä¸ªè®°å½•ï¼Œç”±äºè¿™ä¸¤ä¸ªè®°å½•å¹¶ä¸æ˜¯æˆ‘ä»¬è‡ªå·±æ’å…¥çš„ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¹Ÿç§°ä¸ºè™šæ‹Ÿè®°å½•ã€‚è¿™ä¸¤ä¸ªä¼ªè®°å½•ä¸€ä¸ªä»£è¡¨æœ€å°è®°å½•ï¼Œä¸€ä¸ªä»£è¡¨æœ€å¤§è®°å½•ã€‚ è®°å½•æ˜¯å¦‚ä½•æ¯”è¾ƒå¤§å°çš„ï¼Ÿå¯¹äºä¸€æ¡å®Œæ•´çš„è®°å½•æ¥è¯´ï¼Œæ¯”è¾ƒè®°å½•å¤§å°å°±æ˜¯æ¯”è¾ƒä¸»é”®çš„å¤§å°ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æ’å…¥çš„4è¡Œè®°å½•çš„ä¸»é”®å€¼åˆ†åˆ«ä¸º1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€è¿™å››æ¡è®°å½•çš„å¤§å°ä»å¤§åˆ°å°é€’å¢ã€‚ ä½†æ˜¯ä¸ç®¡æˆ‘ä»¬å¾€é¡µä¸­æ’å…¥äº†å¤šå°‘è‡ªå·±çš„è®°å½•ï¼ŒInnoDBéƒ½è§„å®šä»–ä»¬å®šä¹‰çš„ä¸¤æ¡ä¼ªè®°å½•åˆ†åˆ«ä¸ºæœ€å°è®°å½•å’Œæœ€å¤§è®°å½•ã€‚è¿™ä¸¤æ¡è®°å½•çš„æ„é€ ååˆ†ç®€å•ï¼Œéƒ½æ˜¯ç”±5å­—èŠ‚å¤§å°çš„è®°å½•å¤´ä¿¡æ¯å’Œ8å­—èŠ‚å¤§å°çš„ä¸€ä¸ªå›ºå®šçš„éƒ¨åˆ†ç»„æˆçš„ã€‚ ç”±äºè¿™ä¸¤æ¡è®°å½•ä¸æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„è®°å½•ï¼Œæ‰€ä»¥ä»–ä»¬å¹¶ä¸å­˜æ”¾åœ¨é¡µçš„User Recordséƒ¨åˆ†ï¼Œä»–ä»¬è¢«å•ç‹¬æ”¾åœ¨ä¸€ä¸ªç§°ä¸ºInfimum+Supremumçš„éƒ¨åˆ†ã€‚ ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œæœ€å°è®°å½•å’Œæœ€å¤§è®°å½•çš„heap_noå€¼åˆ†åˆ«æ˜¯0 å’Œ 1 ï¼Œ ä¹Ÿå°±æ˜¯è¯´ä»–ä»¬çš„ä½ç½®æœ€é å‰ã€‚ 1.5 record_typeè¿™ä¸ªå±æ€§è¡¨ç¤ºå½“å‰è®°å½•çš„ç±»å‹ã€‚0ï¼šæ™®é€šè®°å½•ï¼Œ1ï¼šB+æ ‘éå¶å­èŠ‚ç‚¹è®°å½•ï¼Œ2ï¼šæœ€å°è®°å½•ï¼Œ3ï¼šæœ€å¤§è®°å½•ã€‚ æˆ‘ä»¬è‡ªå·±æ’å…¥çš„è®°å½•æ˜¯æ™®é€šè®°å½• 0 ï¼Œ è€Œæœ€å¤§è®°å½•å’Œæœ€å°è®°å½•record_type åˆ†åˆ«ä¸º 2 å’Œ 3ã€‚ 1.6 next_recordè¡¨ç¤ºä»å½“å‰è®°å½•çš„çœŸå®æ•°æ®åˆ°ä¸‹ä¸€æ¡è®°å½•çš„çœŸå®æ•°æ®çš„åœ°å€åç§»é‡ã€‚è¿™å…¶å®æ˜¯ä¸€æ¡é“¾è¡¨ï¼Œå¯ä»¥é€šè¿‡ä¸€æ¡è®°å½•æ‰¾åˆ°ä»–çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œä½†æ˜¯ä¸‹ä¸€æ¡è®°å½•æŒ‡çš„å¹¶ä¸æ˜¯æŒ‰ç…§æˆ‘ä»¬æ’å…¥é¡ºåºçš„ä¸‹ä¸€æ¡è®°å½•ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸»é”®å€¼ç”±å°åˆ°å¤§çš„é¡ºåºçš„ä¸‹ä¸€æ¡è®°å½•ã€‚è€Œä¸”è§„å®š infimumè®°å½• çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯æœ¬é¡µä¸»é”®å€¼æœ€å°çš„ç”¨æˆ·è®°å½•ï¼Œè€Œæœ¬é¡µä¸­ä¸»é”®æœ€å¤§çš„ç”¨æˆ·è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯supremumè®°å½•ã€‚ å¦‚æœä»ä¸­åˆ é™¤ä¸€æ¡è®°å½•ï¼Œè¿™ä¸ªé“¾è¡¨ä¹Ÿæ˜¯ä¼šè·Ÿç€å˜åŒ–çš„ï¼Œå‡å¦‚ç°åœ¨åˆ é™¤ç¬¬äºŒæ¡è®°å½• 1delete from page_demo where c1 =2 ; åˆ é™¤ç¬¬äºŒæ¡è®°å½•ä»¥åï¼š å‘ç”Ÿçš„å˜åŒ–ï¼š ç¬¬äºŒæ¡è®°å½•å¹¶æ²¡æœ‰ä»å­˜å‚¨ç©ºé—´ä¸­ç§»é™¤ï¼Œè€Œæ˜¯æŠŠè¯¥è®°å½•çš„delete_maskè®¾ç½®ä¸º1 ç¬¬äºŒæ¡è®°å½•çš„next_recordså€¼å˜æˆäº†0ï¼Œæ„å‘³ç€è¯¥è®°å½•æ²¡æœ‰ä¸‹ä¸€æ¡è®°å½•äº† ç¬¬ä¸€æ¡è®°å½•çš„next recordæŒ‡å‘äº†ç¬¬ä¸‰æ¡è®°å½• æœ€å¤§è®°å½•çš„ n_owned å€¼ä»5 å˜æˆäº†4 æ‰€ä»¥ï¼Œä¸è®ºæˆ‘ä»¬æ€ä¹ˆå¯¹é¡µä¸­çš„è®°å½•åšå¢åˆ æ”¹æŸ¥æ“ä½œï¼ŒInnoDBå§‹ç»ˆä¼šç»´æŠ¤ä¸€æ¡è®°å½•çš„å•é“¾è¡¨ï¼Œé“¾è¡¨ä¸­å„ä¸ªèŠ‚ç‚¹æ˜¯æŒ‰ç…§ä¸»é”®å€¼ç”±å°åˆ°å¤§çš„é¡ºåºè¿æ¥èµ·æ¥çš„ã€‚ next_records ä¸ºå•¥è¦æŒ‡å‘è®°å½•å¤´ä¿¡æ¯å’ŒçœŸå®æ•°æ®ä¹‹é—´çš„ä½ç½®å‘¢ï¼Ÿä¸ºå•¥ä¸å¹²è„†æŒ‡å‘æ•´æ¡è®°å½•çš„å¼€å¤´ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è®°å½•çš„é¢å¤–ä¿¡æ¯å¼€å¤´çš„ä½ç½®å‘¢ï¼Ÿ å› ä¸ºè¿™ä¸ªä½ç½®åˆšåˆšå¥½ï¼Œå‘å·¦è¯»å–å°±æ˜¯è®°å½•å¤´ä¿¡æ¯ï¼Œå‘å³è¯»å–å°±æ˜¯çœŸå®æ•°æ®ã€‚æˆ‘ä»¬å‰è¾¹è¿˜è¯´è¿‡å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œnullå€¼åˆ—è¡¨ä¸­çš„ä¿¡æ¯éƒ½æ˜¯é€†åºå­˜æ”¾çš„ï¼Œè¿™æ ·å¯ä»¥ä½¿è®°å½•ä¸­ä½ç½®é å‰çš„å­—æ®µå’Œä»–ä»¬å¯¹åº”çš„å­—æ®µé•¿åº¦ä¿¡æ¯åœ¨å†…å­˜ä¸­çš„è·ç¦»æ›´è¿‘ï¼Œå¯èƒ½ä¼šæé«˜é«˜é€Ÿç¼“å­˜çš„å‘½ä¸­ç‡ã€‚ å› ä¸ºä¸»é”®å€¼ä¸º2çš„è®°å½•å·²ç»è¢«æˆ‘ä»¬åˆ é™¤äº†ï¼Œä½†æ˜¯å­˜å‚¨ç©ºé—´å¹¶æ²¡æœ‰å›æ”¶ï¼Œå¦‚æœå†æ¬¡æŠŠè¿™æ¡è®°å½•æ’å…¥åˆ°è¡¨ä¸­ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ 1INSERT INTO page_demo VALUES(2, 200, &#x27;bbbb&#x27;); ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒInnoDBå¹¶æ²¡æœ‰å› ä¸ºæ–°è®°å½•çš„æ’å…¥è€Œä¸ºä»–ç”³è¯·æ–°çš„å­˜å‚¨ç©ºé—´ï¼Œè€Œæ˜¯ç›´æ¥å¤ç”¨äº†åŸæ¥åˆ é™¤çš„è®°å½•çš„å­˜å‚¨ç©ºé—´ã€‚ 2. Page Directoryï¼ˆé¡µç›®å½•ï¼‰å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®ä¸»é”®å€¼æŸ¥æ‰¾é¡µä¸­æŸæ¡è®°å½•è¯¥å’‹åŠï¼Ÿ 1select * from page_demo where c1 = 3; å°†æ‰€æœ‰æ­£å¸¸çš„è®°å½•(åŒ…æ‹¬ä¸¤æ¡éšè—è®°å½•ä½†æ˜¯ä¸åŒ…æ‹¬å·²ç»æ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•)åˆ’åˆ†ä¸ºå‡ ç»„ æ¯ä¸ªç»„çš„æœ€åä¸€æ¡è®°å½•ï¼ˆä¹Ÿå°±æ˜¯ç»„å†…æœ€å¤§çš„é‚£æ¡è®°å½•ï¼‰çš„å¤´ä¿¡æ¯ä¸­çš„n_ownedå±æ€§è¡¨ç¤ºè¯¥ç»„æ‹¥æœ‰å¤šå°‘æ¡è®°å½• å°†æ¯ä¸ªç»„çš„æœ€åä¸€æ¡è®°å½•çš„åœ°å€åç§»é‡å•ç‹¬æå–å‡ºæ¥æŒ‰ç…§é¡ºåºå­˜å‚¨åˆ°é è¿‘é¡µçš„å°¾éƒ¨çš„åœ°æ–¹ï¼Œè¿™ä¸ªåœ°æ–¹å°±æ˜¯æ‰€è°“çš„ã€Page Directoryã€‘,ä¹Ÿå°±æ˜¯é¡µç›®å½•ã€‚é¡µç›®å½•ä¸­çš„è¿™äº›åœ°å€åç§»é‡è¢«ç§°ä¸ºæ§½ï¼Œæ‰€ä»¥é¡µç›®å½•å°±æ˜¯ç”±æ§½ç»„æˆçš„ æ¯”æ–¹è¯´åˆšæ‰åˆ›å»ºçš„è¡¨ä¸­æ­£å¸¸çš„è®°å½•ç”±6æ¡ï¼ŒInnoDBä¼šæŠŠä»–ä»¬åˆ†æˆä¸¤ç»„ï¼Œç¬¬ä¸€ç»„ä¸­åªæœ‰ä¸€æ¡æœ€å°è®°å½•ï¼Œç¬¬äºŒç»„ä¸­æ˜¯å‰©ä½™çš„5æ¡è®°å½•ã€‚ ç°åœ¨é¡µç›®å½•éƒ¨åˆ†ä¸­æœ‰ä¸¤ä¸ªæ§½ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬çš„è®°å½•è¢«åˆ†æˆäº†ä¸¤ä¸ªç»„ï¼Œæ§½1ä¸­çš„å€¼ä¸º112ï¼Œä»£è¡¨æœ€å¤§è®°å½•çš„åœ°å€åç§»é‡ï¼›æ§½0çš„å€¼ä¸º99ï¼Œä»£è¡¨æœ€å°è®°å½•çš„åœ°å€åç§»é‡ã€‚ æ³¨æ„æœ€å¤§å’Œæœ€å°è®°å½•çš„å¤´ä¿¡æ¯çš„n_ownedå±æ€§ï¼š æœ€å°è®°å½•ä¸­çš„n_ownedå€¼ä¸º1ï¼Œè¿™å°±ä»£è¡¨ç€ä»¥æœ€å°è®°å½•ç»“å°¾çš„è¿™ä¸ªåˆ†ç»„ä¸­åªæœ‰1æ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯æœ€å°è®°å½•æœ¬èº« æœ€å¤§è®°å½•ä¸­çš„n_ownedå€¼ä¸º5ï¼Œè¿™å°±ä»£è¡¨ç€ä»¥æœ€å¤§è®°å½•ç»“å°¾çš„è¿™ä¸ªåˆ†ç»„ä¸­åªæœ‰5æ¡è®°å½•ï¼ŒåŒ…æ‹¬æœ€å¤§è®°å½•æœ¬èº«è¿˜æœ‰æˆ‘ä»¬è‡ªå·±æ’å…¥çš„4æ¡è®°å½• ã€99ã€‘&amp;ã€112ã€‘è¿™æ ·çš„åœ°å€åç§»é‡å¾ˆä¸ç›´è§‚ï¼Œæˆ‘ä»¬ç”¨ç®­å¤´æŒ‡å‘çš„æ–¹å¼æ›¿ä»£æ•°å­—ã€‚ InnoDBå¯¹æ¯ä¸ªåˆ†ç»„ä¸­çš„è®°å½•æ¡æ•°æ˜¯æœ‰è§„å®šçš„ï¼šå¯¹äºæœ€å°è®°å½•æ‰€åœ¨çš„åˆ†ç»„åªèƒ½æœ‰ 1 æ¡è®°å½•ï¼Œæœ€å¤§è®°å½•æ‰€åœ¨çš„åˆ†ç»„æ‹¥æœ‰çš„è®°å½•æ¡æ•°åªèƒ½åœ¨ 1~8 æ¡ä¹‹é—´ï¼Œå‰©ä¸‹çš„åˆ†ç»„ä¸­è®°å½•çš„æ¡æ•°èŒƒå›´åªèƒ½åœ¨æ˜¯ 4~8 æ¡ä¹‹é—´ã€‚æ‰€ä»¥åˆ†ç»„æ˜¯æŒ‰ç…§ä¸‹è¾¹çš„æ­¥éª¤è¿›è¡Œçš„ï¼š åˆå§‹æƒ…å†µä¸‹ä¸€ä¸ªæ•°æ®é¡µé‡Œåªæœ‰æœ€å°è®°å½•å’Œæœ€å¤§è®°å½•ä¸¤æ¡è®°å½•ï¼Œå®ƒä»¬åˆ†å±äºä¸¤ä¸ªåˆ†ç»„ã€‚ ä¹‹åæ¯æ’å…¥ä¸€æ¡è®°å½•ï¼Œéƒ½ä¼šä»é¡µç›®å½•ä¸­æ‰¾åˆ°ä¸»é”®å€¼æ¯”æœ¬è®°å½•çš„ä¸»é”®å€¼å¤§å¹¶ä¸”å·®å€¼æœ€å°çš„æ§½ï¼Œç„¶åæŠŠè¯¥æ§½å¯¹åº”çš„è®°å½•çš„n_ownedå€¼åŠ 1ï¼Œè¡¨ç¤ºæœ¬ç»„å†…åˆæ·»åŠ äº†ä¸€æ¡è®°å½•ï¼Œç›´åˆ°è¯¥ç»„ä¸­çš„è®°å½•æ•°ç­‰äº8ä¸ªã€‚ åœ¨ä¸€ä¸ªç»„ä¸­çš„è®°å½•æ•°ç­‰äº8ä¸ªåå†æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œä¼šå°†ç»„ä¸­çš„è®°å½•æ‹†åˆ†æˆä¸¤ä¸ªç»„ï¼Œä¸€ä¸ªç»„ä¸­4æ¡è®°å½•ï¼Œå¦ä¸€ä¸ª5æ¡è®°å½•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šåœ¨é¡µç›®å½•ä¸­æ–°å¢ä¸€ä¸ªæ§½æ¥è®°å½•è¿™ä¸ªæ–°å¢åˆ†ç»„ä¸­æœ€å¤§çš„é‚£æ¡è®°å½•çš„åç§»é‡ã€‚ ç”±äºç°åœ¨page_demoè¡¨ä¸­çš„è®°å½•å¤ªå°‘ï¼Œæ— æ³•æ¼”ç¤ºæ·»åŠ äº†é¡µç›®å½•ä¹‹ååŠ å¿«æŸ¥æ‰¾é€Ÿåº¦çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥å†å¾€page_demoè¡¨ä¸­æ·»åŠ ä¸€äº›è®°å½•ï¼š 1INSERT INTO page_demo VALUES(5, 500, &#x27;eeee&#x27;), (6, 600, &#x27;ffff&#x27;), (7, 700, &#x27;gggg&#x27;), (8, 800, &#x27;hhhh&#x27;), (9, 900, &#x27;iiii&#x27;), (10, 1000, &#x27;jjjj&#x27;), (11, 1100, &#x27;kkkk&#x27;), (12, 1200, &#x27;llll&#x27;), (13, 1300, &#x27;mmmm&#x27;), (14, 1400, &#x27;nnnn&#x27;), (15, 1500, &#x27;oooo&#x27;), (16, 1600, &#x27;pppp&#x27;); ç°åœ¨çœ‹æ€ä¹ˆä»è¿™ä¸ªé¡µç›®å½•ä¸­æŸ¥æ‰¾è®°å½•ã€‚å› ä¸ºå„ä¸ªæ§½ä»£è¡¨çš„è®°å½•çš„ä¸»é”®å€¼éƒ½æ˜¯ä»å°åˆ°å¤§æ’åºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‰€è°“çš„äºŒåˆ†æ³•æ¥è¿›è¡Œå¿«é€ŸæŸ¥æ‰¾ã€‚5ä¸ªæ§½çš„ç¼–å·åˆ†åˆ«æ˜¯ï¼š0ã€1ã€2ã€3ã€4ï¼Œæ‰€ä»¥åˆå§‹æƒ…å†µä¸‹æœ€ä½çš„æ§½å°±æ˜¯low=0ï¼Œæœ€é«˜çš„æ§½å°±æ˜¯high=4ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æƒ³æ‰¾ä¸»é”®å€¼ä¸º6çš„è®°å½•ï¼Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š è®¡ç®—ä¸­é—´æ§½çš„ä½ç½®ï¼š(0+4)/2=2ï¼Œæ‰€ä»¥æŸ¥çœ‹æ§½2å¯¹åº”è®°å½•çš„ä¸»é”®å€¼ä¸º8ï¼Œåˆå› ä¸º8 &gt; 6ï¼Œæ‰€ä»¥è®¾ç½®high=2ï¼Œlowä¿æŒä¸å˜ã€‚ é‡æ–°è®¡ç®—ä¸­é—´æ§½çš„ä½ç½®ï¼š(0+2)/2=1ï¼Œæ‰€ä»¥æŸ¥çœ‹æ§½1å¯¹åº”çš„ä¸»é”®å€¼ä¸º4ï¼Œåˆå› ä¸º4 &lt; 6ï¼Œæ‰€ä»¥è®¾ç½®low=1ï¼Œhighä¿æŒä¸å˜ã€‚ å› ä¸ºhigh - lowçš„å€¼ä¸º1ï¼Œæ‰€ä»¥ç¡®å®šä¸»é”®å€¼ä¸º6çš„è®°å½•åœ¨æ§½2å¯¹åº”çš„ç»„ä¸­ã€‚æ­¤åˆ»æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ§½2ä¸­ä¸»é”®å€¼æœ€å°çš„é‚£æ¡è®°å½•ï¼Œç„¶åæ²¿ç€å•å‘é“¾è¡¨éå†æ§½2ä¸­çš„è®°å½•ã€‚ä½†æ˜¯æˆ‘ä»¬å‰è¾¹åˆè¯´è¿‡ï¼Œæ¯ä¸ªæ§½å¯¹åº”çš„è®°å½•éƒ½æ˜¯è¯¥ç»„ä¸­ä¸»é”®å€¼æœ€å¤§çš„è®°å½•ï¼Œè¿™é‡Œæ§½2å¯¹åº”çš„è®°å½•æ˜¯ä¸»é”®å€¼ä¸º8çš„è®°å½•ï¼Œæ€ä¹ˆå®šä½ä¸€ä¸ªç»„ä¸­æœ€å°çš„è®°å½•å‘¢ï¼Ÿåˆ«å¿˜äº†å„ä¸ªæ§½éƒ½æ˜¯æŒ¨ç€çš„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“çš„æ‹¿åˆ°æ§½1å¯¹åº”çš„è®°å½•ï¼ˆä¸»é”®å€¼ä¸º4ï¼‰ï¼Œè¯¥æ¡è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯æ§½2ä¸­ä¸»é”®å€¼æœ€å°çš„è®°å½•ï¼Œè¯¥è®°å½•çš„ä¸»é”®å€¼ä¸º5ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»è¿™æ¡ä¸»é”®å€¼ä¸º5çš„è®°å½•å‡ºå‘ï¼Œéå†æ§½2ä¸­çš„å„æ¡è®°å½•ï¼Œç›´åˆ°æ‰¾åˆ°ä¸»é”®å€¼ä¸º6çš„é‚£æ¡è®°å½•å³å¯ã€‚ç”±äºä¸€ä¸ªç»„ä¸­åŒ…å«çš„è®°å½•æ¡æ•°åªèƒ½æ˜¯1~8æ¡ï¼Œæ‰€ä»¥éå†ä¸€ä¸ªç»„ä¸­çš„è®°å½•çš„ä»£ä»·æ˜¯å¾ˆå°çš„ã€‚ æ‰€ä»¥åœ¨ä¸€ä¸ªæ•°æ®é¡µä¸­æŸ¥æ‰¾æŒ‡å®šä¸»é”®å€¼çš„è®°å½•çš„è¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥ï¼š é€šè¿‡äºŒåˆ†æ³•ç¡®å®šè¯¥è®°å½•æ‰€åœ¨çš„æ§½ï¼Œå¹¶æ‰¾åˆ°è¯¥æ§½æ‰€åœ¨åˆ†ç»„ä¸­ä¸»é”®å€¼æœ€å°çš„é‚£æ¡è®°å½•ã€‚ é€šè¿‡è®°å½•çš„next_recordå±æ€§éå†è¯¥æ§½æ‰€åœ¨çš„ç»„ä¸­çš„å„ä¸ªè®°å½•ã€‚ 3.Page Headerï¼ˆé¡µé¢å¤´éƒ¨ï¼‰ä¸ºäº†èƒ½å¾—åˆ°ä¸€ä¸ªæ•°æ®é¡µä¸­å­˜å‚¨çš„è®°å½•çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ¯”å¦‚æœ¬é¡µä¸­å·²ç»å­˜å‚¨äº†å¤šå°‘æ¡è®°å½•ï¼Œç¬¬ä¸€æ¡è®°å½•çš„åœ°å€æ˜¯ä»€ä¹ˆï¼Œé¡µç›®å½•ä¸­å­˜å‚¨äº†å¤šå°‘ä¸ªæ§½ç­‰ç­‰ï¼Œç‰¹æ„åœ¨é¡µä¸­å®šä¹‰äº†ä¸€ä¸ªå«Page Headerçš„éƒ¨åˆ†ï¼Œå®ƒæ˜¯é¡µç»“æ„çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†å ç”¨å›ºå®šçš„56ä¸ªå­—èŠ‚ï¼Œä¸“é—¨å­˜å‚¨å„ç§çŠ¶æ€ä¿¡æ¯ã€‚ åç§° å ç”¨ç©ºé—´å¤§å°ï¼ˆå­—èŠ‚ï¼‰ æè¿° PAGE_N_DIR_SLOTS 2 åœ¨é¡µç›®å½•ä¸­çš„æ§½æ•°é‡ PAGE_HEAP_TOP 2 è¿˜æœªä½¿ç”¨çš„ç©ºé—´æœ€å°åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´ä»è¯¥åœ°å€ä¹‹åå°±æ˜¯Free Space PAGE_N_HEAP 2 æœ¬é¡µä¸­çš„è®°å½•çš„æ•°é‡ï¼ˆåŒ…æ‹¬æœ€å°å’Œæœ€å¤§è®°å½•ä»¥åŠæ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•ï¼‰ PAGE_FREE 2 ç¬¬ä¸€ä¸ªå·²ç»æ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•åœ°å€ï¼ˆå„ä¸ªå·²åˆ é™¤çš„è®°å½•é€šè¿‡next_recordä¹Ÿä¼šç»„æˆä¸€ä¸ªå•é“¾è¡¨ï¼Œè¿™ä¸ªå•é“¾è¡¨ä¸­çš„è®°å½•å¯ä»¥è¢«é‡æ–°åˆ©ç”¨ï¼‰ PAGE_GARBAGE 2 å·²åˆ é™¤è®°å½•å ç”¨çš„å­—èŠ‚æ•° PAGE_LAST_INSERT 2 æœ€åæ’å…¥è®°å½•çš„ä½ç½® PAGE_DIRECTION 2 è®°å½•æ’å…¥çš„æ–¹å‘ PAGE_N_DIRECTION 2 ä¸€ä¸ªæ–¹å‘è¿ç»­æ’å…¥çš„è®°å½•æ•°é‡ PAGE_N_RECS 2 è¯¥é¡µä¸­è®°å½•çš„æ•°é‡ï¼ˆä¸åŒ…æ‹¬æœ€å°å’Œæœ€å¤§è®°å½•ä»¥åŠè¢«æ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•ï¼‰ PAGE_MAX_TRX_ID 8 ä¿®æ”¹å½“å‰é¡µçš„æœ€å¤§äº‹åŠ¡IDï¼Œè¯¥å€¼ä»…åœ¨äºŒçº§ç´¢å¼•ä¸­å®šä¹‰ PAGE_LEVEL 2 å½“å‰é¡µåœ¨B+æ ‘ä¸­æ‰€å¤„çš„å±‚çº§ PAGE_INDEX_ID 8 ç´¢å¼•IDï¼Œè¡¨ç¤ºå½“å‰é¡µå±äºå“ªä¸ªç´¢å¼• PAGE_BTR_SEG_LEAF 10 B+æ ‘å¶å­æ®µçš„å¤´éƒ¨ä¿¡æ¯ï¼Œä»…åœ¨B+æ ‘çš„Rooté¡µå®šä¹‰ PAGE_BTR_SEG_TOP 10 B+æ ‘éå¶å­æ®µçš„å¤´éƒ¨ä¿¡æ¯ï¼Œä»…åœ¨B+æ ‘çš„Rooté¡µå®šä¹‰ 4.File Headerï¼ˆæ–‡ä»¶å¤´éƒ¨ï¼‰File Headeré’ˆå¯¹å„ç§ç±»å‹çš„é¡µéƒ½é€šç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒç±»å‹çš„é¡µéƒ½ä¼šä»¥File Headerä½œä¸ºç¬¬ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå®ƒæè¿°äº†ä¸€äº›é’ˆå¯¹å„ç§é¡µéƒ½é€šç”¨çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”æ–¹è¯´è¿™ä¸ªé¡µçš„ç¼–å·æ˜¯å¤šå°‘ï¼Œå®ƒçš„ä¸Šä¸€ä¸ªé¡µã€ä¸‹ä¸€ä¸ªé¡µæ˜¯è°ï¼Œè¿™ä¸ªéƒ¨åˆ†å ç”¨å›ºå®šçš„38ä¸ªå­—èŠ‚ã€‚ åç§° å ç”¨ç©ºé—´å¤§å°ï¼ˆå­—èŠ‚ï¼‰ æè¿° FIL_PAGE_SPACE_OR_CHKSUM 4 é¡µçš„æ ¡éªŒå’Œï¼ˆchecksumå€¼ï¼‰ FIL_PAGE_OFFSET 4 é¡µå· FIL_PAGE_PREV 4 ä¸Šä¸€ä¸ªé¡µçš„é¡µå· FIL_PAGE_NEXT 4 ä¸‹ä¸€ä¸ªé¡µçš„é¡µå· FIL_PAGE_LSN 8 é¡µé¢è¢«æœ€åä¿®æ”¹æ—¶å¯¹åº”çš„æ—¥å¿—åºåˆ—ä½ç½®ï¼ˆè‹±æ–‡åæ˜¯ï¼šLog Sequence Numberï¼‰ FIL_PAGE_TYPE 2 è¯¥é¡µçš„ç±»å‹ FIL_PAGE_FILE_FLUSH_LSN 8 ä»…åœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„ä¸€ä¸ªé¡µä¸­å®šä¹‰ï¼Œä»£è¡¨æ–‡ä»¶è‡³å°‘è¢«åˆ·æ–°åˆ°äº†å¯¹åº”çš„LSNå€¼ FIL_PAGE_ARCH_LOG_NO_OR_SPACE_ID 4 é¡µå±äºå“ªä¸ªè¡¨ç©ºé—´ InnoDBä¸ºäº†ä¸åŒçš„ç›®çš„è€ŒæŠŠé¡µåˆ†ä¸ºä¸åŒçš„ç±»å‹ï¼Œæˆ‘ä»¬ä¸Šè¾¹ä»‹ç»çš„å…¶å®éƒ½æ˜¯å­˜å‚¨è®°å½•çš„æ•°æ®é¡µï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šåˆ«çš„ç±»å‹çš„é¡µï¼Œå…·ä½“å¦‚ä¸‹è¡¨ï¼š ç±»å‹åç§° åå…­è¿›åˆ¶ æè¿° FIL_PAGE_TYPE_ALLOCATED 0x0000 æœ€æ–°åˆ†é…ï¼Œè¿˜æ²¡ä½¿ç”¨ FIL_PAGE_UNDO_LOG 0x0002 Undoæ—¥å¿—é¡µ FIL_PAGE_INODE 0x0003 æ®µä¿¡æ¯èŠ‚ç‚¹ FIL_PAGE_IBUF_FREE_LIST 0x0004 Insert Bufferç©ºé—²åˆ—è¡¨ FIL_PAGE_IBUF_BITMAP 0x0005 Insert Bufferä½å›¾ FIL_PAGE_TYPE_SYS 0x0006 ç³»ç»Ÿé¡µ FIL_PAGE_TYPE_TRX_SYS 0x0007 äº‹åŠ¡ç³»ç»Ÿæ•°æ® FIL_PAGE_TYPE_FSP_HDR 0x0008 è¡¨ç©ºé—´å¤´éƒ¨ä¿¡æ¯ FIL_PAGE_TYPE_XDES 0x0009 æ‰©å±•æè¿°é¡µ FIL_PAGE_TYPE_BLOB 0x000A æº¢å‡ºé¡µ FIL_PAGE_INDEX 0x45BF ç´¢å¼•é¡µï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æ•°æ®é¡µ æˆ‘ä»¬å­˜æ”¾è®°å½•çš„æ•°æ®é¡µçš„ç±»å‹å…¶å®æ˜¯FIL_PAGE_INDEXï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ç´¢å¼•é¡µã€‚ æœ‰æ—¶å€™æˆ‘ä»¬å­˜æ”¾æŸç§ç±»å‹çš„æ•°æ®å ç”¨çš„ç©ºé—´éå¸¸å¤§ï¼ˆæ¯”æ–¹è¯´ä¸€å¼ è¡¨ä¸­å¯ä»¥æœ‰æˆåƒä¸Šä¸‡æ¡è®°å½•ï¼‰ï¼ŒInnoDBå¯èƒ½ä¸å¯ä»¥ä¸€æ¬¡æ€§ä¸ºè¿™ä¹ˆå¤šæ•°æ®åˆ†é…ä¸€ä¸ªéå¸¸å¤§çš„å­˜å‚¨ç©ºé—´ï¼Œå¦‚æœåˆ†æ•£åˆ°å¤šä¸ªä¸è¿ç»­çš„é¡µä¸­å­˜å‚¨çš„è¯éœ€è¦æŠŠè¿™äº›é¡µå…³è”èµ·æ¥ï¼ŒFIL_PAGE_PREVå’ŒFIL_PAGE_NEXTå°±åˆ†åˆ«ä»£è¡¨æœ¬é¡µçš„ä¸Šä¸€ä¸ªå’Œä¸‹ä¸€ä¸ªé¡µçš„é¡µå·ã€‚è¿™æ ·é€šè¿‡å»ºç«‹ä¸€ä¸ªåŒå‘é“¾è¡¨æŠŠè®¸è®¸å¤šå¤šçš„é¡µå°±éƒ½ä¸²è”èµ·æ¥äº†ï¼Œè€Œæ— éœ€è¿™äº›é¡µåœ¨ç‰©ç†ä¸ŠçœŸæ­£è¿ç€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰ç±»å‹çš„é¡µéƒ½æœ‰ä¸Šä¸€ä¸ªå’Œä¸‹ä¸€ä¸ªé¡µçš„å±æ€§ï¼Œä¸è¿‡æˆ‘ä»¬ç°åœ¨åˆ†æçš„æ•°æ®é¡µï¼ˆä¹Ÿå°±æ˜¯ç±»å‹ä¸ºFIL_PAGE_INDEXçš„é¡µï¼‰æ˜¯æœ‰è¿™ä¸¤ä¸ªå±æ€§çš„ï¼Œæ‰€ä»¥æ‰€æœ‰çš„æ•°æ®é¡µå…¶å®æ˜¯ä¸€ä¸ªåŒé“¾è¡¨ã€‚ 5.File Trailer(æ–‡ä»¶å°¾éƒ¨)å¦‚æœé¡µä¸­çš„æ•°æ®åœ¨å†…å­˜ä¸­è¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆåœ¨ä¿®æ”¹åçš„æŸä¸ªæ—¶é—´éœ€è¦æŠŠæ•°æ®åŒæ­¥åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯åœ¨åŒæ­¥äº†ä¸€åŠçš„æ—¶å€™ä¸­æ–­ç”µäº†å’‹åŠï¼Ÿ ä¸ºäº†æ£€æµ‹ä¸€ä¸ªé¡µæ˜¯å¦å®Œæ•´ï¼Œåœ¨æ¯ä¸ªé¡µçš„å°¾éƒ¨éƒ½åŠ äº†ä¸€ä¸ªFile Traileréƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†ç”±8ä¸ªå­—èŠ‚ç»„æˆï¼Œå¯ä»¥åˆ†æˆ2ä¸ªå°éƒ¨åˆ†ï¼š å‰å››ä¸ªå­—èŠ‚ä»£è¡¨æ ¡éªŒå’Œ åå››ä¸ªå­—èŠ‚ä»£è¡¨é¡µé¢è¢«æœ€åä¿®æ”¹æ—¶å¯¹åº”çš„æ—¥å¿—åºåˆ—ä½ç½® è¿™ä¸ªFile Trailer &amp; File Header ç±»ä¼¼ï¼Œéƒ½æ˜¯æ‰€æœ‰ç±»å‹çš„é¡µé€šç”¨çš„ã€‚ è‡³æ­¤ï¼Œæ•´ä¸ªæ•°æ®é¡µçš„ç»“æ„æˆ‘ä»¬ä¹ŸåŸºæœ¬ä¸Šåˆ†æå®Œäº†ï¼Œç°åœ¨åœ¨å›å¤´çœ‹ä¸€ä¸‹å¼€å¤´æˆ‘ä»¬é‚£å¼ ææ€–çš„å›¾ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰æ¸…æ™°å¾ˆå¤šäº†å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åˆ†æç´¢å¼•çš„ç»“æ„ã€‚ ä¸‰ï¼Œç´¢å¼•1.å‡å¦‚æ²¡æœ‰ç´¢å¼•æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ²¡æœ‰ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿›è¡Œæ•°æ®çš„æŸ¥æ‰¾(æ¯•ç«Ÿæ²¡æœ‰å¯¹æ¯”å°±æ²¡æœ‰ä¼¤å®³)ã€‚ 1.1 åœ¨ä¸€ä¸ªé¡µä¸­æŸ¥æ‰¾å‡è®¾è¡¨ä¸­çš„è®°å½•å¾ˆå°‘ï¼Œæ‰€æœ‰çš„è®°å½•ä»…ä»…ç”¨ä¸€ä¸ªé¡µå°±å­˜æ”¾ä¸‹äº†ï¼Œè¿™ä¸ªæ—¶å€™æŒ‰ç…§ä¸åŒçš„æœç´¢æ¡ä»¶å…¶å®å¯ä»¥åˆ†ä¸ºä¸¤ç§æƒ…å†µè®¨è®ºï¼š ã€ä»¥ä¸»é”®ä¸ºæœç´¢çš„æ¡ä»¶ã€‘ï¼šå¯ä»¥å†é¡µç›®å½•ä¸­æ ¹æ®äºŒåˆ†æŸ¥æ‰¾å¿«é€Ÿå®šä½åˆ°æ§½ï¼Œåœ¨æ ¹æ®æ§½å®šä½åˆ°è¯¥ç»„çš„æœ€å°ç´¢å¼•è®°å½•ï¼Œç„¶åè¿›è¡Œéå†åŒ¹é…æŸ¥æ‰¾ã€‚ ã€ä»¥å…¶ä»–åˆ—ä½œä¸ºæœç´¢æ¡ä»¶ã€‘ï¼šåœ¨æ•°æ®é¡µä¸­å¹¶æ²¡æœ‰ä¸ºéä¸»é”®åˆ—å»ºç«‹æ‰€è°“çš„é¡µç›®å½•ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡äºŒåˆ†æ³•å¿«é€Ÿå®šä½ç›¸åº”çš„æ§½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªèƒ½ä»æœ€å°è®°å½•å¼€å§‹ä¾æ¬¡å¾€åéå†å•é“¾è¡¨ä¸­çš„æ¯æ¡è®°å½•ï¼Œç„¶åå¯¹æ¯”æ¯æ¡è®°å½•æ˜¯å¦ç¬¦åˆæœç´¢æ¡ä»¶ï¼Œæ˜¾ç„¶ï¼Œæ•ˆç‡å¾ˆä½ã€‚ 1.2 åœ¨å¾ˆå¤šé¡µä¸­æŸ¥æ‰¾å¾ˆå¤šæ—¶å€™ï¼Œè¡¨çš„è®°å½•ä¸€ä¸ªé¡µéƒ½æ˜¯å­˜å‚¨ä¸ä¸‹çš„ï¼Œè¿™ä¸ªæ—¶å€™çš„æŸ¥æ‰¾å…¶å®åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š ã€å®šä½åˆ°è®°å½•æ‰€åœ¨çš„é¡µã€‘ ã€ä»æ‰€åœ¨çš„é¡µå†…æŸ¥æ‰¾ç›¸åº”çš„è®°å½•ã€‘ å› ä¸ºæˆ‘ä»¬ä¸èƒ½å¿«é€Ÿçš„å®šä½åˆ°æ‰€åœ¨çš„é¡µï¼Œæ‰€ä»¥åªèƒ½ä»ç¬¬ä¸€é¡µå¼€å§‹æ²¿ç€åŒé“¾è¡¨å¾€åéå†å®šä½é¡µï¼Œå®šä½åˆ°é¡µä»¥ååœ¨æ ¹æ®åœ¨ä¸€ä¸ªé¡µä¸­çš„æŸ¥æ‰¾æ–¹å¼è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ï¼Œæ˜¾è€Œæ˜“è§ï¼Œè¿™ä¸ªæ—¶å€™æ•ˆç‡ä½çš„å¯æ€•ã€‚ æœ‰äº†ç—›ç‚¹ï¼Œå°±ä¼šæœ‰å¤§ç‰›å»æ€è€ƒæ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå®Œå–„é€»è¾‘å’Œèµ„æºå€¾æ–œï¼Œå½¢æˆä¸€å¥—è‡ªå·±çš„æ–¹æ³•è®ºï¼Œæƒ³åŠæ³•ä¸ºå¿«é€ŸæŸ¥æ‰¾èµ‹èƒ½ã€‚ 2. ç´¢å¼•æˆ‘ä»¬å…ˆåˆ›å»ºä¸€å¼ è¡¨ï¼š 1234567mysql&gt; CREATE TABLE index_demo( -&gt; c1 INT, -&gt; c2 INT, -&gt; c3 CHAR(1), -&gt; PRIMARY KEY(c1) -&gt; ) ROW_FORMAT = Compact;Query OK, 0 rows affected (0.03 sec) 2.1 ä¸€ä¸ªç®€å•çš„ç´¢å¼•æ–¹æ¡ˆæˆ‘ä»¬åœ¨æ ¹æ®æŸä¸ªæœç´¢æ¡ä»¶æŸ¥æ‰¾ä¸€äº›è®°å½•æ—¶ä¸ºä»€ä¹ˆè¦éå†æ‰€æœ‰çš„æ•°æ®é¡µå‘¢ï¼Ÿ å› ä¸ºå„ä¸ªé¡µä¸­çš„è®°å½•å¹¶æ²¡æœ‰è§„å¾‹ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“æˆ‘ä»¬çš„æœç´¢æ¡ä»¶åŒ¹é…å“ªäº›é¡µä¸­çš„è®°å½•ï¼Œæ‰€ä»¥ ä¸å¾—ä¸ ä¾æ¬¡éå†æ‰€æœ‰çš„æ•°æ®é¡µã€‚ å¦‚æœæˆ‘ä»¬æƒ³å¿«é€Ÿçš„å®šä½åˆ°éœ€è¦æŸ¥æ‰¾çš„è®°å½•åœ¨å“ªäº›æ•°æ®é¡µä¸­è¯¥å’‹åŠï¼Ÿ å¯¹æ¯”æ ¹æ®ä¸»é”®å€¼å¿«é€Ÿå®šä½ä¸€æ¡è®°å½•ä»è€Œåœ¨é¡µä¸­çš„ä½ç½®å»ºç«‹é¡µç›®å½•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æƒ³åŠæ³•ä¸ºå¿«é€Ÿå®šä½è®°å½•æ‰€åœ¨çš„æ•°æ®é¡µè€Œå»ºç«‹ä¸€ä¸ªåˆ«çš„ç›®å½•ã€‚ ã€ä¸‹ä¸€ä¸ªæ•°æ®é¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼å¿…é¡»å¤§äºä¸Šä¸€ä¸ªé¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼ã€‚ã€‘ å‡è®¾æˆ‘ä»¬ç°åœ¨æ¯ä¸€é¡µåªèƒ½æ”¾ä¸‰æ¡è®°å½•ï¼Œç°åœ¨å·²ç»æ”¾äº†ä¸»é”®ä¸º1,3,5çš„ä¸‰æ¡è®°å½•ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ·»åŠ ä¸€æ¡ä¸»é”®ä¸º4çš„è®°å½•ï¼Œæˆ‘ä»¬ä¸å¾—ä¸ä¸ºä»–åˆ†é…ä¸€ä¸ªæ–°çš„é¡µã€‚ æ³¨æ„ï¼šæ–°åˆ†é…çš„æ•°æ®é¡µç¼–å·å¯èƒ½å’ŒåŸæ¥å¹¶ä¸æ˜¯è¿ç»­çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä½¿ç”¨çš„è¿™äº›é¡µåœ¨å­˜å‚¨ç©ºé—´é‡Œå¯èƒ½å¹¶ä¸æŒ¨ç€ã€‚ä»–ä»¬åªæ˜¯é€šè¿‡ç»´æŠ¤ç€ä¸Šä¸€é¡µå’Œä¸‹ä¸€é¡µçš„ç¼–å·è€Œå»ºç«‹äº†é“¾è¡¨å…³ç³»ã€‚ åŸæ¥é¡µä¸­ä¸»é”®æœ€å¤§çš„å€¼ä¸º5ï¼Œç°åœ¨æˆ‘ä»¬æ–°æ’å…¥ä¸€æ¡è®°å½•ï¼Œå¦‚æœç›´æ¥æ”¾åœ¨æ–°é¡µé‡Œé¢ï¼Œé‚£å°±ä¼šæœ‰é—®é¢˜ï¼Œè¿™ä¸ç¬¦åˆä¸‹ä¸€ä¸ªæ•°æ®é¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼å¿…é¡»å¤§äºä¸Šä¸€ä¸ªé¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼å¾—è¦æ±‚ï¼Œæ‰€ä»¥åœ¨æ’å…¥ä¸»é”®å€¼ä¸º4 çš„è®°å½•çš„æ—¶å€™éœ€è¦ä¼´éšä¸€æ¬¡è®°å½•çš„ç§»åŠ¨ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸»é”®å€¼ä¸º5 çš„è®°å½•ç§»åŠ¨åˆ°æ–°åˆ†é…çš„é¡µä¸­ï¼Œç„¶åæŠŠä¸»é”®å€¼ä¸º4 çš„è®°å½•æ’å…¥åˆ°åŸæ¥çš„é¡µä¸­ã€‚ è¿™ä¸ªè¿‡ç¨‹è¡¨æ˜äº†åœ¨å¯¹é¡µä¸­çš„è®°å½•è¿›è¡Œå¢åˆ æ”¹æ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡ä¸€äº›è¯¸å¦‚è®°å½•ç§»åŠ¨çš„æ“ä½œæ¥å§‹ç»ˆä¿è¯è¿™ä¸ªçŠ¶æ€ä¸€ç›´æˆç«‹ï¼šä¸‹ä¸€ä¸ªæ•°æ®é¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼å¿…é¡»å¤§äºä¸Šä¸€ä¸ªé¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼ã€‚è¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬ä¹Ÿå¯ä»¥ç§°ä¸ºé¡µåˆ†è£‚ã€‚ ã€ç»™æ‰€æœ‰çš„é¡µå»ºç«‹ä¸€ä¸ªç›®å½•é¡¹ã€‚ã€‘ ç”±äºæ•°æ®é¡µçš„ç¼–å·å¯èƒ½å¹¶ä¸æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥åœ¨å‘index_demoè¡¨ä¸­æ’å…¥è®¸å¤šæ¡è®°å½•åï¼Œå¯èƒ½æ˜¯è¿™æ ·çš„æ•ˆæœï¼š å› ä¸ºè¿™äº›16KBçš„é¡µåœ¨ç‰©ç†å­˜å‚¨ä¸Šå¯èƒ½å¹¶ä¸æŒ¨ç€ï¼Œæ‰€ä»¥å¦‚æœæƒ³ä»è¿™ä¹ˆå¤šé¡µä¸­æ ¹æ®ä¸»é”®å€¼å¿«é€Ÿå®šä½æŸäº›è®°å½•æ‰€åœ¨çš„é¡µï¼Œæˆ‘ä»¬éœ€è¦ç»™å®ƒä»¬åšä¸ªç›®å½•ï¼Œæ¯ä¸ªé¡µå¯¹åº”ä¸€ä¸ªç›®å½•é¡¹ï¼Œæ¯ä¸ªç›®å½•é¡¹åŒ…æ‹¬ä¸‹è¾¹ä¸¤ä¸ªéƒ¨åˆ†ï¼š é¡µçš„ç”¨æˆ·è®°å½•ä¸­æœ€å°çš„ä¸»é”®å€¼ï¼Œæˆ‘ä»¬ç”¨keyæ¥è¡¨ç¤ºã€‚ é¡µå·ï¼Œæˆ‘ä»¬ç”¨page_noè¡¨ç¤ºã€‚ ä»¥é¡µ28ä¸ºä¾‹ï¼Œå®ƒå¯¹åº”ç›®å½•é¡¹2ï¼Œè¿™ä¸ªç›®å½•é¡¹ä¸­åŒ…å«ç€è¯¥é¡µçš„é¡µå·28ä»¥åŠè¯¥é¡µä¸­ç”¨æˆ·è®°å½•çš„æœ€å°ä¸»é”®å€¼5ã€‚æˆ‘ä»¬åªéœ€è¦æŠŠå‡ ä¸ªç›®å½•é¡¹åœ¨ç‰©ç†å­˜å‚¨å™¨ä¸Šè¿ç»­å­˜å‚¨ï¼Œæ¯”å¦‚æŠŠä»–ä»¬æ”¾åˆ°ä¸€ä¸ªæ•°ç»„é‡Œï¼Œå°±å¯ä»¥å®ç°æ ¹æ®ä¸»é”®å€¼å¿«é€ŸæŸ¥æ‰¾æŸæ¡è®°å½•çš„åŠŸèƒ½äº†ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æƒ³æ‰¾ä¸»é”®å€¼ä¸º20çš„è®°å½•ï¼Œå…·ä½“æŸ¥æ‰¾è¿‡ç¨‹åˆ†ä¸¤æ­¥ï¼š å…ˆä»ç›®å½•é¡¹ä¸­æ ¹æ®äºŒåˆ†æ³•å¿«é€Ÿç¡®å®šå‡ºä¸»é”®å€¼ä¸º20çš„è®°å½•åœ¨ç›®å½•é¡¹3ä¸­ï¼ˆå› ä¸º 12 &lt; 20 &lt; 209ï¼‰ï¼Œå®ƒå¯¹åº”çš„é¡µæ˜¯é¡µ9ã€‚ å†æ ¹æ®å‰è¾¹è¯´çš„åœ¨é¡µä¸­æŸ¥æ‰¾è®°å½•çš„æ–¹å¼å»é¡µ9ä¸­å®šä½å…·ä½“çš„è®°å½•ã€‚ è‡³æ­¤ï¼Œé’ˆå¯¹æ•°æ®é¡µåšçš„ç®€æ˜“ç›®å½•å°±æå®šäº†ã€‚è¿™ä¸ªç›®å½•å…¶å®å°±æ˜¯ã€ç´¢å¼•ã€‘ã€‚ 2.2 InnoDBä¸­çš„ç´¢å¼•æ–¹æ¡ˆä¸Šé¢çš„æ–¹æ¡ˆå­˜åœ¨ä»€ä¹ˆæ ·çš„é—®é¢˜ï¼Ÿ InnoDBæ˜¯ä½¿ç”¨é¡µæ¥ä½œä¸ºç®¡ç†å­˜å‚¨ç©ºé—´çš„åŸºæœ¬å•ä½ï¼Œä¹Ÿå°±æ˜¯æœ€å¤šèƒ½ä¿è¯16KBçš„è¿ç»­å­˜å‚¨ç©ºé—´ï¼Œè€Œéšç€è¡¨ä¸­è®°å½•æ•°é‡çš„å¢å¤šï¼Œéœ€è¦éå¸¸å¤§çš„è¿ç»­çš„å­˜å‚¨ç©ºé—´æ‰èƒ½æŠŠæ‰€æœ‰çš„ç›®å½•é¡¹éƒ½æ”¾ä¸‹ï¼Œè¿™å¯¹è®°å½•æ•°é‡éå¸¸å¤šçš„è¡¨æ˜¯ä¸ç°å®çš„ã€‚ æˆ‘ä»¬æ—¶å¸¸ä¼šå¯¹è®°å½•è¿›è¡Œå¢åˆ ï¼Œå‡è®¾æˆ‘ä»¬æŠŠé¡µ28ä¸­çš„è®°å½•éƒ½åˆ é™¤äº†ï¼Œé¡µ28ä¹Ÿå°±æ²¡æœ‰å­˜åœ¨çš„å¿…è¦äº†ï¼Œé‚£æ„å‘³ç€ç›®å½•é¡¹2ä¹Ÿå°±æ²¡æœ‰å­˜åœ¨çš„å¿…è¦äº†ï¼Œè¿™å°±éœ€è¦æŠŠç›®å½•é¡¹2åçš„ç›®å½•é¡¹éƒ½å‘å‰ç§»åŠ¨ä¸€ä¸‹ã€‚ InnoDBå¤ç”¨äº†ä¹‹å‰å­˜å‚¨ç”¨æˆ·è®°å½•çš„æ•°æ®é¡µæ¥å­˜å‚¨ç›®å½•é¡¹ï¼Œä¸ºäº†å’Œç”¨æˆ·è®°å½•åšä¸€ä¸‹åŒºåˆ†ï¼Œæˆ‘ä»¬æŠŠè¿™äº›ç”¨æ¥è¡¨ç¤ºç›®å½•é¡¹çš„è®°å½•ç§°ä¸ºç›®å½•é¡¹è®°å½•ã€‚ é‚£InnoDBæ€ä¹ˆåŒºåˆ†ä¸€æ¡è®°å½•æ˜¯æ™®é€šçš„ç”¨æˆ·è®°å½•è¿˜æ˜¯ç›®å½•é¡¹è®°å½•å‘¢ï¼Ÿé€šè¿‡è®°å½•å¤´ä¿¡æ¯é‡Œçš„record_typeå±æ€§ï¼Œå®ƒçš„å„ä¸ªå–å€¼ä»£è¡¨çš„æ„æ€å¦‚ä¸‹ï¼š 0ï¼šæ™®é€šçš„ç”¨æˆ·è®°å½• **1**ï¼šç›®å½•é¡¹è®°å½• 2ï¼šæœ€å°è®°å½• 3ï¼šæœ€å¤§è®°å½• æŠŠå‰è¾¹ä½¿ç”¨åˆ°çš„ç›®å½•é¡¹æ”¾åˆ°æ•°æ®é¡µä¸­çš„æ ·å­å°±æ˜¯è¿™æ ·ï¼š ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæˆ‘ä»¬æ–°åˆ†é…äº†ä¸€ä¸ªç¼–å·ä¸º30çš„é¡µæ¥ä¸“é—¨å­˜å‚¨ç›®å½•é¡¹è®°å½•ã€‚è¿™é‡Œå†æ¬¡å¼ºè°ƒä¸€éç›®å½•é¡¹è®°å½•å’Œæ™®é€šçš„ç”¨æˆ·è®°å½•çš„ä¸åŒç‚¹ï¼š ç›®å½•é¡¹è®°å½•çš„record_typeå€¼æ˜¯1ï¼Œè€Œæ™®é€šç”¨æˆ·è®°å½•çš„record_typeå€¼æ˜¯0ã€‚ ç›®å½•é¡¹è®°å½•åªæœ‰ä¸»é”®å€¼å’Œé¡µçš„ç¼–å·ä¸¤ä¸ªåˆ—ï¼Œè€Œæ™®é€šçš„ç”¨æˆ·è®°å½•çš„åˆ—æ˜¯ç”¨æˆ·è‡ªå·±å®šä¹‰çš„ï¼Œå¯èƒ½åŒ…å«å¾ˆå¤šåˆ—ï¼Œå¦å¤–è¿˜æœ‰InnoDBè‡ªå·±æ·»åŠ çš„éšè—åˆ—ã€‚ å¤´ä¿¡æ¯é‡Œé¢æœ‰ä¸€ä¸ªå«min_rec_maskçš„å±æ€§ï¼Œåªæœ‰åœ¨å­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µä¸­çš„ä¸»é”®å€¼æœ€å°çš„ç›®å½•é¡¹è®°å½•çš„min_rec_maskå€¼ä¸º1ï¼Œå…¶ä»–åˆ«çš„è®°å½•çš„min_rec_maskå€¼éƒ½æ˜¯0ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œä¸¤è€…å°±æ²¡æœ‰åŒºåˆ«äº†ï¼Œé¡µçš„ç»„æˆç»“æ„ä¹Ÿæ˜¯ä¸€æ ·ä¸€æ ·çš„ï¼ˆå°±æ˜¯æˆ‘ä»¬å‰è¾¹ä»‹ç»è¿‡çš„7ä¸ªéƒ¨åˆ†ï¼‰ï¼Œéƒ½ä¼šä¸ºä¸»é”®å€¼ç”ŸæˆPage Directoryï¼ˆé¡µç›®å½•ï¼‰ï¼Œä»è€Œåœ¨æŒ‰ç…§ä¸»é”®å€¼è¿›è¡ŒæŸ¥æ‰¾æ—¶å¯ä»¥ä½¿ç”¨äºŒåˆ†æ³•æ¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚ ç°åœ¨ä»¥æŸ¥æ‰¾ä¸»é”®ä¸º20çš„è®°å½•ä¸ºä¾‹ï¼Œæ ¹æ®æŸä¸ªä¸»é”®å€¼å»æŸ¥æ‰¾è®°å½•çš„æ­¥éª¤å°±å¯ä»¥å¤§è‡´æ‹†åˆ†æˆä¸‹è¾¹ä¸¤æ­¥ï¼š å…ˆåˆ°å­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µï¼Œä¹Ÿå°±æ˜¯é¡µ30ä¸­é€šè¿‡äºŒåˆ†æ³•å¿«é€Ÿå®šä½åˆ°å¯¹åº”ç›®å½•é¡¹ï¼Œå› ä¸º12 &lt; 20 &lt; 209ï¼Œæ‰€ä»¥å®šä½åˆ°å¯¹åº”çš„è®°å½•æ‰€åœ¨çš„é¡µå°±æ˜¯é¡µ9ã€‚ å†åˆ°å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µ9ä¸­æ ¹æ®äºŒåˆ†æ³•å¿«é€Ÿå®šä½åˆ°ä¸»é”®å€¼ä¸º20çš„ç”¨æˆ·è®°å½•ã€‚ è™½ç„¶è¯´ç›®å½•é¡¹è®°å½•ä¸­åªå­˜å‚¨ä¸»é”®å€¼å’Œå¯¹åº”çš„é¡µå·ï¼Œæ¯”ç”¨æˆ·è®°å½•éœ€è¦çš„å­˜å‚¨ç©ºé—´å°å¤šäº†ï¼Œä½†æ˜¯ä¸è®ºæ€ä¹ˆè¯´ä¸€ä¸ªé¡µåªæœ‰16KBå¤§å°ï¼Œèƒ½å­˜æ”¾çš„ç›®å½•é¡¹è®°å½•ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œé‚£å¦‚æœè¡¨ä¸­çš„æ•°æ®å¤ªå¤šï¼Œä»¥è‡³äºä¸€ä¸ªæ•°æ®é¡µä¸è¶³ä»¥å­˜æ”¾æ‰€æœ‰çš„ç›®å½•é¡¹è®°å½•ï¼Œè¯¥å’‹åŠå‘¢ï¼Ÿ å½“ç„¶æ˜¯å†å¤šæ•´ä¸€ä¸ªå­˜å‚¨**ç›®å½•é¡¹è®°å½•**çš„é¡µã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬æ’å…¥äº†ä¸€æ¡ä¸»é”®å€¼ä¸º320çš„ç”¨æˆ·è®°å½•ä¹‹åéœ€è¦ä¸¤ä¸ªæ–°çš„æ•°æ®é¡µï¼š ä¸ºå­˜å‚¨è¯¥ç”¨æˆ·è®°å½•è€Œæ–°ç”Ÿæˆäº†é¡µ31ã€‚ å› ä¸ºåŸå…ˆå­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µ30çš„å®¹é‡å·²æ»¡ï¼ˆæˆ‘ä»¬å‰è¾¹å‡è®¾åªèƒ½å­˜å‚¨4æ¡ç›®å½•é¡¹è®°å½•ï¼‰ï¼Œæ‰€ä»¥ä¸å¾—ä¸éœ€è¦ä¸€ä¸ªæ–°çš„é¡µ32æ¥å­˜æ”¾é¡µ31å¯¹åº”çš„ç›®å½•é¡¹ã€‚ ç°åœ¨å› ä¸ºå­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µä¸æ­¢ä¸€ä¸ªï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®ä¸»é”®å€¼æŸ¥æ‰¾ä¸€æ¡ç”¨æˆ·è®°å½•å¤§è‡´éœ€è¦3ä¸ªæ­¥éª¤ï¼Œä»¥æŸ¥æ‰¾ä¸»é”®å€¼ä¸º20çš„è®°å½•ä¸ºä¾‹ï¼š ç¡®å®šç›®å½•é¡¹è®°å½•é¡µ æˆ‘ä»¬ç°åœ¨çš„å­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µæœ‰ä¸¤ä¸ªï¼Œå³é¡µ30å’Œé¡µ32ï¼Œåˆå› ä¸ºé¡µ30è¡¨ç¤ºçš„ç›®å½•é¡¹çš„ä¸»é”®å€¼çš„èŒƒå›´æ˜¯[1, 320)ï¼Œé¡µ32è¡¨ç¤ºçš„ç›®å½•é¡¹çš„ä¸»é”®å€¼ä¸å°äº320ï¼Œæ‰€ä»¥ä¸»é”®å€¼ä¸º20çš„è®°å½•å¯¹åº”çš„ç›®å½•é¡¹è®°å½•åœ¨é¡µ30ä¸­ã€‚ é€šè¿‡ç›®å½•é¡¹è®°å½•é¡µç¡®å®šç”¨æˆ·è®°å½•çœŸå®æ‰€åœ¨çš„é¡µã€‚ åœ¨çœŸå®å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µä¸­å®šä½åˆ°å…·ä½“çš„è®°å½•ã€‚ é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œåœ¨è¿™ä¸ªæŸ¥è¯¢æ­¥éª¤çš„ç¬¬1æ­¥ä¸­æˆ‘ä»¬éœ€è¦å®šä½å­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µï¼Œä½†æ˜¯è¿™äº›é¡µåœ¨å­˜å‚¨ç©ºé—´ä¸­ä¹Ÿå¯èƒ½ä¸æŒ¨ç€ï¼Œå¦‚æœæˆ‘ä»¬è¡¨ä¸­çš„æ•°æ®éå¸¸å¤šåˆ™ä¼šäº§ç”Ÿå¾ˆå¤šå­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆæ ¹æ®ä¸»é”®å€¼å¿«é€Ÿå®šä½ä¸€ä¸ªå­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µå‘¢ï¼Ÿ ä¸ºè¿™äº›å­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µå†ç”Ÿæˆä¸€ä¸ªæ›´é«˜çº§çš„ç›®å½•ï¼Œå°±åƒæ˜¯ä¸€ä¸ªå¤šçº§ç›®å½•ä¸€æ ·ï¼Œå¤§ç›®å½•é‡ŒåµŒå¥—å°ç›®å½•ï¼Œå°ç›®å½•é‡Œæ‰æ˜¯å®é™…çš„æ•°æ®ï¼Œæ‰€ä»¥ç°åœ¨å„ä¸ªé¡µçš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·å­ï¼š éšç€è¡¨ä¸­è®°å½•çš„å¢åŠ ï¼Œè¿™ä¸ªç›®å½•çš„å±‚çº§ä¼šç»§ç»­å¢åŠ ï¼Œå¦‚æœç®€åŒ–ä¸€ä¸‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹è¾¹è¿™ä¸ªå›¾æ¥æè¿°å®ƒï¼š å…¶å®è¿™æ˜¯ä¸€ç§ç»„ç»‡æ•°æ®çš„å½¢å¼ï¼Œæˆ–è€…è¯´æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒçš„åç§°æ˜¯B+æ ‘ã€‚ ä¸è®ºæ˜¯å­˜æ”¾ç”¨æˆ·è®°å½•çš„æ•°æ®é¡µï¼Œè¿˜æ˜¯å­˜æ”¾ç›®å½•é¡¹è®°å½•çš„æ•°æ®é¡µï¼Œæˆ‘ä»¬éƒ½æŠŠå®ƒä»¬å­˜æ”¾åˆ°B+æ ‘è¿™ä¸ªæ•°æ®ç»“æ„ä¸­äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿç§°è¿™äº›æ•°æ®é¡µä¸ºèŠ‚ç‚¹ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæˆ‘ä»¬çš„å®é™…ç”¨æˆ·è®°å½•å…¶å®éƒ½å­˜æ”¾åœ¨B+æ ‘çš„æœ€åº•å±‚çš„èŠ‚ç‚¹ä¸Šï¼Œè¿™äº›èŠ‚ç‚¹ä¹Ÿè¢«ç§°ä¸ºå¶å­èŠ‚ç‚¹æˆ–å¶èŠ‚ç‚¹ï¼Œå…¶ä½™ç”¨æ¥å­˜æ”¾ç›®å½•é¡¹çš„èŠ‚ç‚¹ç§°ä¸ºéå¶å­èŠ‚ç‚¹æˆ–è€…å†…èŠ‚ç‚¹ï¼Œå…¶ä¸­B+æ ‘æœ€ä¸Šè¾¹çš„é‚£ä¸ªèŠ‚ç‚¹ä¹Ÿç§°ä¸ºæ ¹èŠ‚ç‚¹ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸€ä¸ªB+æ ‘çš„èŠ‚ç‚¹å…¶å®å¯ä»¥åˆ†æˆå¥½å¤šå±‚ï¼ŒInnoDBè§„å®šæœ€ä¸‹è¾¹çš„é‚£å±‚ï¼Œä¹Ÿå°±æ˜¯å­˜æ”¾æˆ‘ä»¬ç”¨æˆ·è®°å½•çš„é‚£å±‚ä¸ºç¬¬0å±‚ï¼Œä¹‹åä¾æ¬¡å¾€ä¸ŠåŠ ã€‚ä¹‹å‰çš„åˆ†ææˆ‘ä»¬åšäº†ä¸€ä¸ªéå¸¸æç«¯çš„å‡è®¾ï¼šå­˜æ”¾ç”¨æˆ·è®°å½•çš„é¡µæœ€å¤šå­˜æ”¾3æ¡è®°å½•ï¼Œå­˜æ”¾ç›®å½•é¡¹è®°å½•çš„é¡µæœ€å¤šå­˜æ”¾4æ¡è®°å½•ã€‚å…¶å®çœŸå®ç¯å¢ƒä¸­ä¸€ä¸ªé¡µå­˜æ”¾çš„è®°å½•æ•°é‡æ˜¯éå¸¸å¤§çš„ï¼Œå‡è®¾æ‰€æœ‰å­˜æ”¾ç”¨æˆ·è®°å½•çš„å¶å­èŠ‚ç‚¹ä»£è¡¨çš„æ•°æ®é¡µå¯ä»¥å­˜æ”¾100æ¡ç”¨æˆ·è®°å½•ï¼Œæ‰€æœ‰å­˜æ”¾ç›®å½•é¡¹è®°å½•çš„å†…èŠ‚ç‚¹ä»£è¡¨çš„æ•°æ®é¡µå¯ä»¥å­˜æ”¾1000æ¡ç›®å½•é¡¹è®°å½•ï¼Œé‚£ä¹ˆï¼š å¦‚æœB+æ ‘åªæœ‰1å±‚ï¼Œä¹Ÿå°±æ˜¯åªæœ‰1ä¸ªç”¨äºå­˜æ”¾ç”¨æˆ·è®°å½•çš„èŠ‚ç‚¹ï¼Œæœ€å¤šèƒ½å­˜æ”¾100æ¡è®°å½•ã€‚ å¦‚æœB+æ ‘æœ‰2å±‚ï¼Œæœ€å¤šèƒ½å­˜æ”¾1000Ã—100=100000æ¡è®°å½•ã€‚ å¦‚æœB+æ ‘æœ‰3å±‚ï¼Œæœ€å¤šèƒ½å­˜æ”¾1000Ã—1000Ã—100=100000000æ¡è®°å½•ã€‚ å¦‚æœB+æ ‘æœ‰4å±‚ï¼Œæœ€å¤šèƒ½å­˜æ”¾1000Ã—1000Ã—1000Ã—100=100000000000æ¡è®°å½•ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨åˆ°çš„B+æ ‘éƒ½ä¸ä¼šè¶…è¿‡4å±‚ï¼Œé‚£æˆ‘ä»¬é€šè¿‡ä¸»é”®å€¼å»æŸ¥æ‰¾æŸæ¡è®°å½•æœ€å¤šåªéœ€è¦åš4ä¸ªé¡µé¢å†…çš„æŸ¥æ‰¾ï¼ˆæŸ¥æ‰¾3ä¸ªç›®å½•é¡¹é¡µå’Œä¸€ä¸ªç”¨æˆ·è®°å½•é¡µï¼‰ï¼Œåˆå› ä¸ºåœ¨æ¯ä¸ªé¡µé¢å†…æœ‰æ‰€è°“çš„Page Directoryï¼ˆé¡µç›®å½•ï¼‰ï¼Œæ‰€ä»¥åœ¨é¡µé¢å†…ä¹Ÿå¯ä»¥é€šè¿‡äºŒåˆ†æ³•å®ç°å¿«é€Ÿå®šä½è®°å½•ã€‚ 2.3 èšç°‡ç´¢å¼•ä¸Šè¾¹ä»‹ç»çš„B+æ ‘æœ¬èº«å°±æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæˆ–è€…è¯´æœ¬èº«å°±æ˜¯ä¸€ä¸ªç´¢å¼•ã€‚å®ƒæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š ä½¿ç”¨è®°å½•ä¸»é”®å€¼çš„å¤§å°è¿›è¡Œè®°å½•å’Œé¡µçš„æ’åºï¼Œè¿™åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢çš„å«ä¹‰ï¼š é¡µå†…çš„è®°å½•æ˜¯æŒ‰ç…§ä¸»é”®çš„å¤§å°é¡ºåºæ’æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚ å„ä¸ªå­˜æ”¾ç”¨æˆ·è®°å½•çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ å­˜æ”¾ç›®å½•é¡¹è®°å½•çš„é¡µåˆ†ä¸ºä¸åŒçš„å±‚æ¬¡ï¼Œåœ¨åŒä¸€å±‚æ¬¡ä¸­çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­ç›®å½•é¡¹è®°å½•çš„ä¸»é”®å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ B+æ ‘çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯å®Œæ•´çš„ç”¨æˆ·è®°å½•ã€‚æ‰€è°“å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œå°±æ˜¯æŒ‡è¿™ä¸ªè®°å½•ä¸­å­˜å‚¨äº†æ‰€æœ‰åˆ—çš„å€¼ï¼ˆåŒ…æ‹¬éšè—åˆ—ï¼‰ã€‚ æˆ‘ä»¬æŠŠå…·æœ‰è¿™ä¸¤ç§ç‰¹æ€§çš„B+æ ‘ç§°ä¸ºèšç°‡ç´¢å¼•ï¼Œæ‰€æœ‰å®Œæ•´çš„ç”¨æˆ·è®°å½•éƒ½å­˜æ”¾åœ¨è¿™ä¸ªèšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å¤„ã€‚è¿™ç§èšç°‡ç´¢å¼•å¹¶ä¸éœ€è¦æˆ‘ä»¬åœ¨MySQLè¯­å¥ä¸­æ˜¾å¼çš„ä½¿ç”¨INDEXè¯­å¥å»åˆ›å»ºï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šè‡ªåŠ¨çš„ä¸ºæˆ‘ä»¬åˆ›å»ºèšç°‡ç´¢å¼•ã€‚å¦å¤–ï¼Œåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œèšç°‡ç´¢å¼•å°±æ˜¯æ•°æ®çš„å­˜å‚¨æ–¹å¼ï¼ˆæ‰€æœ‰çš„ç”¨æˆ·è®°å½•éƒ½å­˜å‚¨åœ¨äº†å¶å­èŠ‚ç‚¹ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ç´¢å¼•å³æ•°æ®ï¼Œæ•°æ®å³ç´¢å¼•ã€‚ 2.4 äºŒçº§ç´¢å¼•èšç°‡ç´¢å¼•åªèƒ½åœ¨æœç´¢æ¡ä»¶æ˜¯ä¸»é”®å€¼æ—¶æ‰èƒ½å‘æŒ¥ä½œç”¨ï¼Œå› ä¸ºB+æ ‘ä¸­çš„æ•°æ®éƒ½æ˜¯æŒ‰ç…§ä¸»é”®è¿›è¡Œæ’åºçš„ã€‚é‚£å¦‚æœæˆ‘ä»¬æƒ³ä»¥åˆ«çš„åˆ—ä½œä¸ºæœç´¢æ¡ä»¶æ€ä¹ˆåŠï¼Ÿ æˆ‘ä»¬å¯ä»¥å¤šå»ºå‡ æ£µB+æ ‘ï¼Œä¸åŒçš„B+æ ‘ä¸­çš„æ•°æ®é‡‡ç”¨ä¸åŒçš„æ’åºè§„åˆ™ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬ç”¨c2åˆ—çš„å¤§å°ä½œä¸ºæ•°æ®é¡µã€é¡µä¸­è®°å½•çš„æ’åºè§„åˆ™ï¼Œå†å»ºä¸€æ£µB+æ ‘ï¼Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™ä¸ªB+æ ‘ä¸ä¸Šè¾¹ä»‹ç»çš„èšç°‡ç´¢å¼•æœ‰å‡ å¤„ä¸åŒï¼š ä½¿ç”¨è®°å½•c2åˆ—çš„å¤§å°è¿›è¡Œè®°å½•å’Œé¡µçš„æ’åºï¼Œè¿™åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢çš„å«ä¹‰ï¼š é¡µå†…çš„è®°å½•æ˜¯æŒ‰ç…§c2åˆ—çš„å¤§å°é¡ºåºæ’æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚ å„ä¸ªå­˜æ”¾ç”¨æˆ·è®°å½•çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­è®°å½•çš„c2åˆ—å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ å­˜æ”¾ç›®å½•é¡¹è®°å½•çš„é¡µåˆ†ä¸ºä¸åŒçš„å±‚æ¬¡ï¼Œåœ¨åŒä¸€å±‚æ¬¡ä¸­çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­ç›®å½•é¡¹è®°å½•çš„c2åˆ—å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ B+æ ‘çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„å¹¶ä¸æ˜¯å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œè€Œåªæ˜¯c2åˆ—+ä¸»é”®è¿™ä¸¤ä¸ªåˆ—çš„å€¼ã€‚ ç›®å½•é¡¹è®°å½•ä¸­ä¸å†æ˜¯ä¸»é”®+é¡µå·çš„æ­é…ï¼Œè€Œå˜æˆäº†c2åˆ—+é¡µå·çš„æ­é…ã€‚ æ‰€ä»¥å¦‚æœæˆ‘ä»¬ç°åœ¨æƒ³é€šè¿‡c2åˆ—çš„å€¼æŸ¥æ‰¾æŸäº›è®°å½•çš„è¯å°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬åˆšåˆšå»ºå¥½çš„è¿™ä¸ªB+æ ‘äº†ã€‚ä»¥æŸ¥æ‰¾c2åˆ—çš„å€¼ä¸º4çš„è®°å½•ä¸ºä¾‹ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹å¦‚ä¸‹ï¼š ç¡®å®šç›®å½•é¡¹è®°å½•é¡µ æ ¹æ®æ ¹é¡µé¢ï¼Œä¹Ÿå°±æ˜¯é¡µ44ï¼Œå¯ä»¥å¿«é€Ÿå®šä½åˆ°ç›®å½•é¡¹è®°å½•æ‰€åœ¨çš„é¡µä¸ºé¡µ42ï¼ˆå› ä¸º2 &lt; 4 &lt; 9ï¼‰ã€‚ é€šè¿‡ç›®å½•é¡¹è®°å½•é¡µç¡®å®šç”¨æˆ·è®°å½•çœŸå®æ‰€åœ¨çš„é¡µã€‚ åœ¨é¡µ42ä¸­å¯ä»¥å¿«é€Ÿå®šä½åˆ°å®é™…å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µï¼Œä½†æ˜¯ç”±äºc2åˆ—å¹¶æ²¡æœ‰å”¯ä¸€æ€§çº¦æŸï¼Œæ‰€ä»¥c2åˆ—å€¼ä¸º4çš„è®°å½•å¯èƒ½åˆ†å¸ƒåœ¨å¤šä¸ªæ•°æ®é¡µä¸­ï¼Œåˆå› ä¸º2 &lt; 4 â‰¤ 4ï¼Œæ‰€ä»¥ç¡®å®šå®é™…å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µåœ¨é¡µ34å’Œé¡µ35ä¸­ã€‚ åœ¨çœŸå®å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µä¸­å®šä½åˆ°å…·ä½“çš„è®°å½•. åˆ°é¡µ34å’Œé¡µ35ä¸­å®šä½åˆ°å…·ä½“çš„è®°å½•ã€‚ ä½†æ˜¯è¿™ä¸ªB+æ ‘çš„å¶å­èŠ‚ç‚¹ä¸­çš„è®°å½•åªå­˜å‚¨äº†c2å’Œc1ï¼ˆä¹Ÿå°±æ˜¯ä¸»é”®ï¼‰ä¸¤ä¸ªåˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»å†æ ¹æ®ä¸»é”®å€¼å»èšç°‡ç´¢å¼•ä¸­å†æŸ¥æ‰¾ä¸€éå®Œæ•´çš„ç”¨æˆ·è®°å½•ã€‚ æˆ‘ä»¬æ ¹æ®è¿™ä¸ªä»¥**c2**åˆ—å¤§å°æ’åºçš„**B+**æ ‘åªèƒ½ç¡®å®šæˆ‘ä»¬è¦æŸ¥æ‰¾è®°å½•çš„ä¸»é”®å€¼ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®**c2**åˆ—çš„å€¼æŸ¥æ‰¾åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•çš„è¯ï¼Œä»ç„¶éœ€è¦åˆ°**èšç°‡ç´¢å¼•**ä¸­å†æŸ¥ä¸€éï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿè¢«ç§°ä¸º**å›è¡¨**ã€‚ä¹Ÿå°±æ˜¯æ ¹æ®c2åˆ—çš„å€¼æŸ¥è¯¢ä¸€æ¡å®Œæ•´çš„ç”¨æˆ·è®°å½•éœ€è¦ä½¿ç”¨åˆ°2æ£µB+æ ‘ï¼ï¼ï¼ ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦ä¸€æ¬¡å›è¡¨æ“ä½œå‘¢ï¼Ÿç›´æ¥æŠŠå®Œæ•´çš„ç”¨æˆ·è®°å½•æ”¾åˆ°å¶å­èŠ‚ç‚¹ä¸å°±å¥½äº†ä¹ˆï¼Ÿ å¦‚æœæŠŠå®Œæ•´çš„ç”¨æˆ·è®°å½•æ”¾åˆ°å¶å­èŠ‚ç‚¹æ˜¯å¯ä»¥ä¸ç”¨å›è¡¨ï¼Œç›¸å½“äºæ¯å»ºç«‹ä¸€æ£µB+æ ‘éƒ½éœ€è¦æŠŠæ‰€æœ‰çš„ç”¨æˆ·è®°å½•å†éƒ½æ‹·è´ä¸€éï¼Œè¿™å°±æœ‰ç‚¹å¤ªæµªè´¹å­˜å‚¨ç©ºé—´äº†ã€‚å› ä¸ºè¿™ç§æŒ‰ç…§éä¸»é”®åˆ—å»ºç«‹çš„B+æ ‘éœ€è¦ä¸€æ¬¡å›è¡¨æ“ä½œæ‰å¯ä»¥å®šä½åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œæ‰€ä»¥è¿™ç§B+æ ‘ä¹Ÿè¢«ç§°ä¸ºäºŒçº§ç´¢å¼•ï¼ˆè‹±æ–‡åsecondary indexï¼‰ï¼Œæˆ–è€…è¾…åŠ©ç´¢å¼•ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯c2åˆ—çš„å¤§å°ä½œä¸ºB+æ ‘çš„æ’åºè§„åˆ™ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿç§°è¿™ä¸ªB+æ ‘ä¸ºä¸ºc2åˆ—å»ºç«‹çš„ç´¢å¼•ã€‚ å‡è®¾æˆ‘ä»¬çš„æŸ¥è¯¢ç»“æœæ˜¯åæ¡ï¼Œé‚£å°±æ˜¯è¦è¿›è¡Œ10æ¬¡å›è¡¨ï¼Œé‚£è¿™æ ·çš„è¯ï¼Œæ•ˆç‡ä¸æ˜¯åˆæ…¢äº†ï¼Ÿ åœ¨MySQL5.6å¯¹è¿™ç§æƒ…å†µè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¦‚æœå‘ç°æŸ¥è¯¢ç»“æœä¼šå¯¼è‡´å¤šæ¬¡å›è¡¨ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡ŒIOåˆå¹¶ï¼Œæ‹¿åˆ°æ‰€æœ‰çš„ä¸»é”®å†å»è¿›è¡Œå›è¡¨ã€‚ 2.5 è”åˆç´¢å¼•æˆ‘ä»¬ä¹Ÿå¯ä»¥åŒæ—¶ä»¥å¤šä¸ªåˆ—çš„å¤§å°ä½œä¸ºæ’åºè§„åˆ™ï¼Œä¹Ÿå°±æ˜¯åŒæ—¶ä¸ºå¤šä¸ªåˆ—å»ºç«‹ç´¢å¼•ï¼Œæ¯”æ–¹è¯´æˆ‘ä»¬æƒ³è®©B+æ ‘æŒ‰ç…§c2å’Œc3åˆ—çš„å¤§å°è¿›è¡Œæ’åºï¼Œè¿™ä¸ªåŒ…å«ä¸¤å±‚å«ä¹‰ï¼š å…ˆæŠŠå„ä¸ªè®°å½•å’Œé¡µæŒ‰ç…§c2åˆ—è¿›è¡Œæ’åºã€‚ åœ¨è®°å½•çš„c2åˆ—ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨c3åˆ—è¿›è¡Œæ’åº ä¸ºc2å’Œc3åˆ—å»ºç«‹çš„ç´¢å¼•çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š 3. InnoDBçš„B+æ ‘ç´¢å¼•çš„æ³¨æ„äº‹é¡¹3.1 è·Ÿé¡µé¢æ°¸è¿œå›ºå®šä¸åŠ¨å‰è¾¹ä»‹ç»B+æ ‘ç´¢å¼•çš„æ—¶å€™ï¼Œä¸ºäº†ç†è§£ä¸Šçš„æ–¹ä¾¿ï¼Œå…ˆæŠŠå­˜å‚¨ç”¨æˆ·è®°å½•çš„å¶å­èŠ‚ç‚¹éƒ½ç”»å‡ºæ¥ï¼Œç„¶åæ¥ç€ç”»å­˜å‚¨ç›®å½•é¡¹è®°å½•çš„å†…èŠ‚ç‚¹ï¼Œå®é™…ä¸ŠB+æ ‘çš„å½¢æˆè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š æ¯å½“ä¸ºæŸä¸ªè¡¨åˆ›å»ºä¸€ä¸ªB+æ ‘ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ä¸æ˜¯äººä¸ºåˆ›å»ºçš„ï¼Œé»˜è®¤å°±æœ‰ï¼‰çš„æ—¶å€™ï¼Œéƒ½ä¼šä¸ºè¿™ä¸ªç´¢å¼•åˆ›å»ºä¸€ä¸ªæ ¹èŠ‚ç‚¹é¡µé¢ã€‚æœ€å¼€å§‹è¡¨ä¸­æ²¡æœ‰æ•°æ®çš„æ—¶å€™ï¼Œæ¯ä¸ªB+æ ‘ç´¢å¼•å¯¹åº”çš„æ ¹èŠ‚ç‚¹ä¸­æ—¢æ²¡æœ‰ç”¨æˆ·è®°å½•ï¼Œä¹Ÿæ²¡æœ‰ç›®å½•é¡¹è®°å½•ã€‚ éšåå‘è¡¨ä¸­æ’å…¥ç”¨æˆ·è®°å½•æ—¶ï¼Œå…ˆæŠŠç”¨æˆ·è®°å½•å­˜å‚¨åˆ°è¿™ä¸ªæ ¹èŠ‚ç‚¹ä¸­ã€‚ å½“æ ¹èŠ‚ç‚¹ä¸­çš„å¯ç”¨ç©ºé—´ç”¨å®Œæ—¶ç»§ç»­æ’å…¥è®°å½•ï¼Œæ­¤æ—¶ä¼šå°†æ ¹èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰è®°å½•å¤åˆ¶åˆ°ä¸€ä¸ªæ–°åˆ†é…çš„é¡µï¼Œæ¯”å¦‚é¡µaä¸­ï¼Œç„¶åå¯¹è¿™ä¸ªæ–°é¡µè¿›è¡Œé¡µåˆ†è£‚çš„æ“ä½œï¼Œå¾—åˆ°å¦ä¸€ä¸ªæ–°é¡µï¼Œæ¯”å¦‚é¡µbã€‚è¿™æ—¶æ–°æ’å…¥çš„è®°å½•æ ¹æ®é”®å€¼ï¼ˆä¹Ÿå°±æ˜¯èšç°‡ç´¢å¼•ä¸­çš„ä¸»é”®å€¼ï¼ŒäºŒçº§ç´¢å¼•ä¸­å¯¹åº”çš„ç´¢å¼•åˆ—çš„å€¼ï¼‰çš„å¤§å°å°±ä¼šè¢«åˆ†é…åˆ°é¡µaæˆ–è€…é¡µbä¸­ï¼Œè€Œæ ¹èŠ‚ç‚¹ä¾¿å‡çº§ä¸ºå­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µã€‚ è¿™ä¸ªè¿‡ç¨‹éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼šä¸€ä¸ªB+æ ‘ç´¢å¼•çš„æ ¹èŠ‚ç‚¹è‡ªè¯ç”Ÿä¹‹æ—¥èµ·ï¼Œä¾¿ä¸ä¼šå†ç§»åŠ¨ã€‚è¿™æ ·åªè¦æˆ‘ä»¬å¯¹æŸä¸ªè¡¨å»ºç«‹ä¸€ä¸ªç´¢å¼•ï¼Œé‚£ä¹ˆå®ƒçš„æ ¹èŠ‚ç‚¹çš„é¡µå·ä¾¿ä¼šè¢«è®°å½•åˆ°æŸä¸ªåœ°æ–¹ï¼Œç„¶åå‡¡æ˜¯InnoDBå­˜å‚¨å¼•æ“éœ€è¦ç”¨åˆ°è¿™ä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œéƒ½ä¼šä»é‚£ä¸ªå›ºå®šçš„åœ°æ–¹å–å‡ºæ ¹èŠ‚ç‚¹çš„é¡µå·ï¼Œä»è€Œæ¥è®¿é—®è¿™ä¸ªç´¢å¼•ã€‚ 3.2 å†…èŠ‚ç‚¹ä¸­ç›®å½•é¡¹è®°å½•çš„å”¯ä¸€æ€§æˆ‘ä»¬çŸ¥é“B+æ ‘ç´¢å¼•çš„å†…èŠ‚ç‚¹ä¸­ç›®å½•é¡¹è®°å½•çš„å†…å®¹æ˜¯ç´¢å¼•åˆ— + é¡µå·çš„æ­é…ï¼Œä½†æ˜¯è¿™ä¸ªæ­é…å¯¹äºäºŒçº§ç´¢å¼•æ¥è¯´æœ‰ç‚¹å„¿ä¸ä¸¥è°¨ã€‚å‡è®¾è¡¨ä¸­çš„æ•°æ®æ˜¯è¿™æ ·çš„ï¼š c1 c2 c3 1 1 â€˜uâ€™ 3 1 â€˜dâ€™ 5 1 â€˜yâ€™ 7 1 â€˜aâ€™ å¦‚æœäºŒçº§ç´¢å¼•ä¸­ç›®å½•é¡¹è®°å½•çš„å†…å®¹åªæ˜¯ç´¢å¼•åˆ— + é¡µå·çš„æ­é…çš„è¯ï¼Œé‚£ä¹ˆä¸ºc2åˆ—å»ºç«‹ç´¢å¼•åçš„B+æ ‘åº”è¯¥é•¿è¿™æ ·ï¼š å¦‚æœæˆ‘ä»¬æƒ³æ–°æ’å…¥ä¸€è¡Œè®°å½•ï¼Œå…¶ä¸­c1ã€c2ã€c3çš„å€¼åˆ†åˆ«æ˜¯ï¼š9ã€1ã€&#39;c&#39;ï¼Œé‚£ä¹ˆåœ¨ä¿®æ”¹è¿™ä¸ªä¸ºc2åˆ—å»ºç«‹çš„äºŒçº§ç´¢å¼•å¯¹åº”çš„B+æ ‘æ—¶ä¾¿ç¢°åˆ°äº†ä¸ªå¤§é—®é¢˜ï¼šç”±äºé¡µ3ä¸­å­˜å‚¨çš„ç›®å½•é¡¹è®°å½•æ˜¯ç”±c2åˆ— + é¡µå·çš„å€¼æ„æˆçš„ï¼Œé¡µ3ä¸­çš„ä¸¤æ¡ç›®å½•é¡¹è®°å½•å¯¹åº”çš„c2åˆ—çš„å€¼éƒ½æ˜¯1ï¼Œè€Œæˆ‘ä»¬æ–°æ’å…¥çš„è¿™æ¡è®°å½•çš„c2åˆ—çš„å€¼ä¹Ÿæ˜¯1ï¼Œé‚£æˆ‘ä»¬è¿™æ¡æ–°æ’å…¥çš„è®°å½•åˆ°åº•åº”è¯¥æ”¾åˆ°é¡µ4ä¸­ï¼Œè¿˜æ˜¯åº”è¯¥æ”¾åˆ°é¡µ5ä¸­? ä¸ºäº†è®©æ–°æ’å…¥è®°å½•èƒ½æ‰¾åˆ°è‡ªå·±åœ¨é‚£ä¸ªé¡µé‡Œï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯åœ¨B+æ ‘çš„åŒä¸€å±‚å†…èŠ‚ç‚¹çš„ç›®å½•é¡¹è®°å½•é™¤é¡µå·è¿™ä¸ªå­—æ®µä»¥å¤–æ˜¯å”¯ä¸€çš„ã€‚æ‰€ä»¥å¯¹äºäºŒçº§ç´¢å¼•çš„å†…èŠ‚ç‚¹çš„ç›®å½•é¡¹è®°å½•çš„å†…å®¹å®é™…ä¸Šæ˜¯ç”±ä¸‰ä¸ªéƒ¨åˆ†æ„æˆçš„ï¼š ç´¢å¼•åˆ—çš„å€¼ ä¸»é”®å€¼ é¡µå· ä¹Ÿå°±æ˜¯æˆ‘ä»¬æŠŠä¸»é”®å€¼ä¹Ÿæ·»åŠ åˆ°äºŒçº§ç´¢å¼•å†…èŠ‚ç‚¹ä¸­çš„ç›®å½•é¡¹è®°å½•äº†ï¼Œè¿™æ ·å°±èƒ½ä¿è¯B+æ ‘æ¯ä¸€å±‚èŠ‚ç‚¹ä¸­å„æ¡ç›®å½•é¡¹è®°å½•é™¤é¡µå·è¿™ä¸ªå­—æ®µå¤–æ˜¯å”¯ä¸€çš„ã€‚ è¿™æ ·æˆ‘ä»¬å†æ’å…¥è®°å½•(9, 1, &#39;c&#39;)æ—¶ï¼Œç”±äºé¡µ3ä¸­å­˜å‚¨çš„ç›®å½•é¡¹è®°å½•æ˜¯ç”±c2åˆ— + ä¸»é”® + é¡µå·çš„å€¼æ„æˆçš„ï¼Œå¯ä»¥å…ˆæŠŠæ–°è®°å½•çš„c2åˆ—çš„å€¼å’Œé¡µ3ä¸­å„ç›®å½•é¡¹è®°å½•çš„c2åˆ—çš„å€¼ä½œæ¯”è¾ƒï¼Œå¦‚æœc2åˆ—çš„å€¼ç›¸åŒçš„è¯ï¼Œå¯ä»¥æ¥ç€æ¯”è¾ƒä¸»é”®å€¼ï¼Œå› ä¸ºB+æ ‘åŒä¸€å±‚ä¸­ä¸åŒç›®å½•é¡¹è®°å½•çš„c2åˆ— + ä¸»é”®çš„å€¼è‚¯å®šæ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥æœ€åè‚¯å®šèƒ½å®šä½å”¯ä¸€çš„ä¸€æ¡ç›®å½•é¡¹è®°å½•ï¼Œåœ¨æœ¬ä¾‹ä¸­æœ€åç¡®å®šæ–°è®°å½•åº”è¯¥è¢«æ’å…¥åˆ°é¡µ5ä¸­ã€‚ 3.3 ä¸€ä¸ªé¡µé¢æœ€å°‘å­˜å‚¨2æ¡è®°å½•B+æ ‘åªéœ€è¦å¾ˆå°‘çš„å±‚çº§å°±å¯ä»¥è½»æ¾å­˜å‚¨æ•°äº¿æ¡è®°å½•ï¼Œè¿™æ˜¯å› ä¸ºB+æ ‘æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå¤§çš„å¤šå±‚çº§ç›®å½•ï¼Œæ¯ç»è¿‡ä¸€ä¸ªç›®å½•æ—¶éƒ½ä¼šè¿‡æ»¤æ‰è®¸å¤šæ— æ•ˆçš„å­ç›®å½•ï¼Œç›´åˆ°æœ€åè®¿é—®åˆ°å­˜å‚¨çœŸå®æ•°æ®çš„ç›®å½•ã€‚é‚£å¦‚æœä¸€ä¸ªå¤§çš„ç›®å½•ä¸­åªå­˜æ”¾ä¸€ä¸ªå­ç›®å½•ä¼šæ€ä¹ˆæ ·ï¼Ÿé‚£å°±æ˜¯ç›®å½•å±‚çº§éå¸¸å¤šï¼Œè€Œä¸”æœ€åçš„é‚£ä¸ªå­˜æ”¾çœŸå®æ•°æ®çš„ç›®å½•ä¸­åªèƒ½å­˜æ”¾ä¸€æ¡è®°å½•ï¼Œä¼šå¯¼è‡´æ•ˆç‡å¾ˆä½ã€‚ å…¶å®è®©B+æ•°çš„å¶å­ç»“ç‚¹å€¼å­˜å‚¨ä¸€æ¡è®°å½•ï¼Œè®©å†…èŠ‚ç‚¹å­˜å‚¨å¤šæ¡è®°å½•ï¼Œä¹Ÿè¿˜æ˜¯å¯ä»¥å‘æŒ¥B+æ•°çš„ä½œç”¨çš„ã€‚ä½†æ˜¯InnoDBä¸ºäº†é¿å…æ•°çš„å±‚çº§è¿‡é«˜ï¼Œè¦æ±‚æ‰€æœ‰çš„æ•°æ®é¡µéƒ½è‡³å°‘å¯ä»¥å®¹çº³ä¸¤æ¡è®°å½•ã€‚ 4. MyISAMä¸­çš„ç´¢å¼•æ–¹æ¡ˆç®€å•ä»‹ç»MyISAMçš„ç´¢å¼•æ–¹æ¡ˆè™½ç„¶ä¹Ÿä½¿ç”¨æ ‘å½¢ç»“æ„ï¼Œä½†æ˜¯å´å°†ç´¢å¼•å’Œæ•°æ®åˆ†å¼€å­˜å‚¨ï¼š å°†è¡¨ä¸­çš„è®°å½•æŒ‰ç…§è®°å½•çš„æ’å…¥é¡ºåºå•ç‹¬å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç§°ä¹‹ä¸ºæ•°æ®æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶å¹¶ä¸åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªæ•°æ®é¡µï¼Œæœ‰å¤šå°‘è®°å½•å°±å¾€è¿™ä¸ªæ–‡ä»¶ä¸­å¡å¤šå°‘è®°å½•å°±æˆäº†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¡Œå·è€Œå¿«é€Ÿè®¿é—®åˆ°ä¸€æ¡è®°å½•ã€‚ ä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“çš„è¡¨ä¼šæŠŠç´¢å¼•ä¿¡æ¯å¦å¤–å­˜å‚¨åˆ°ä¸€ä¸ªç§°ä¸ºç´¢å¼•æ–‡ä»¶çš„å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚MyISAMä¼šå•ç‹¬ä¸ºè¡¨çš„ä¸»é”®åˆ›å»ºä¸€ä¸ªç´¢å¼•ï¼Œåªä¸è¿‡åœ¨ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸­å­˜å‚¨çš„ä¸æ˜¯å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œè€Œæ˜¯ä¸»é”®å€¼ + è¡Œå·çš„ç»„åˆã€‚ä¹Ÿå°±æ˜¯å…ˆé€šè¿‡ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„è¡Œå·ï¼Œå†é€šè¿‡è¡Œå·å»æ‰¾å¯¹åº”çš„è®°å½•ï¼è¿™ä¸€ç‚¹å’ŒInnoDBæ˜¯å®Œå…¨ä¸ç›¸åŒçš„ï¼Œåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®ä¸»é”®å€¼å¯¹èšç°‡ç´¢å¼•è¿›è¡Œä¸€æ¬¡æŸ¥æ‰¾å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„è®°å½•ï¼Œè€Œåœ¨MyISAMä¸­å´éœ€è¦è¿›è¡Œä¸€æ¬¡å›è¡¨æ“ä½œï¼Œæ„å‘³ç€MyISAMä¸­å»ºç«‹çš„ç´¢å¼•ç›¸å½“äºå…¨éƒ¨éƒ½æ˜¯äºŒçº§ç´¢å¼•ï¼ å¦‚æœæœ‰éœ€è¦çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶å®ƒçš„åˆ—åˆ†åˆ«å»ºç«‹ç´¢å¼•æˆ–è€…å»ºç«‹è”åˆç´¢å¼•ï¼ŒåŸç†å’ŒInnoDBä¸­çš„ç´¢å¼•å·®ä¸å¤šï¼Œä¸è¿‡åœ¨å¶å­èŠ‚ç‚¹å¤„å­˜å‚¨çš„æ˜¯ç›¸åº”çš„åˆ— + è¡Œå·ã€‚è¿™äº›ç´¢å¼•ä¹Ÿå…¨éƒ¨éƒ½æ˜¯äºŒçº§ç´¢å¼•ã€‚ ç”±äºåœ¨æ’å…¥æ•°æ®çš„æ—¶å€™å¹¶æ²¡æœ‰åˆ»æ„æŒ‰ç…§ä¸»é”®å¤§å°æ’åºï¼Œæ‰€ä»¥æˆ‘ä»¬å¹¶ä¸èƒ½åœ¨MyIsaMæ•°æ®ä¸Šä½¿ç”¨äºŒåˆ†æ³•è¿›è¡ŒæŸ¥æ‰¾ã€‚ 5. åˆ›å»ºå’Œåˆ é™¤ç´¢å¼•çš„è¯­å¥InnoDBå’ŒMyISAMä¼šè‡ªåŠ¨ä¸ºä¸»é”®æˆ–è€…å£°æ˜ä¸ºUNIQUEçš„åˆ—å»è‡ªåŠ¨å»ºç«‹B+æ ‘ç´¢å¼•ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³ä¸ºå…¶ä»–çš„åˆ—å»ºç«‹ç´¢å¼•å°±éœ€è¦æˆ‘ä»¬æ˜¾å¼çš„å»æŒ‡æ˜ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™æŒ‡å®šéœ€è¦å»ºç«‹ç´¢å¼•çš„å•ä¸ªåˆ—æˆ–è€…å»ºç«‹è”åˆç´¢å¼•çš„å¤šä¸ªåˆ—ï¼š 1234CREATE TALBE è¡¨å ( å„ç§åˆ—çš„ä¿¡æ¯ Â·Â·Â· , [KEY|INDEX] ç´¢å¼•å (éœ€è¦è¢«ç´¢å¼•çš„å•ä¸ªåˆ—æˆ–å¤šä¸ªåˆ—)) æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ä¿®æ”¹è¡¨ç»“æ„çš„æ—¶å€™æ·»åŠ ç´¢å¼•ï¼š 1ALTER TABLE è¡¨å ADD [INDEX|KEY] ç´¢å¼•å (éœ€è¦è¢«ç´¢å¼•çš„å•ä¸ªåˆ—æˆ–å¤šä¸ªåˆ—); ä¹Ÿå¯ä»¥åœ¨ä¿®æ”¹è¡¨ç»“æ„çš„æ—¶å€™åˆ é™¤ç´¢å¼•ï¼š 1ALTER TABLE è¡¨å DROP [INDEX|KEY] ç´¢å¼•å; è‡³æ­¤ï¼Œæ•´ä¸ªç´¢å¼•ç›¸å…³çš„ç»“æ„æˆ‘ä»¬å°±éƒ½åˆ†æå®Œäº†ã€‚","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[ä¸€]å…¥é—¨","slug":"MySQL/MySQL[ä¸€]å…¥é—¨","date":"2022-01-11T02:49:27.263Z","updated":"2022-01-11T03:14:44.975Z","comments":true,"path":"2022/01/11/MySQL/MySQL[ä¸€]å…¥é—¨/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E4%B8%80]%E5%85%A5%E9%97%A8/","excerpt":"","text":"ä¸€ï¼ŒMYSQLå…¥é—¨1.æ•°æ®åº“ç›¸å…³æ¦‚å¿µ123DBï¼šæ•°æ®åº“ï¼šå­˜å‚¨æ•°æ®çš„ä»“åº“ï¼Œä¿å­˜äº†ä¸€ç³»åˆ—æœ‰ç»„ç»‡çš„æ•°æ®ã€‚DBMSï¼šæ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼šæ•°æ®åº“æ˜¯é€šè¿‡DBMSåˆ›å»ºå’Œæ“ä½œçš„å®¹å™¨ã€‚SQLï¼šç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ï¼šä¸“é—¨ç”¨æ¥ä¸æ•°æ®åº“é€šä¿¡çš„è¯­è¨€ã€‚ 2.æ•°æ®åº“çš„å¥½å¤„121.å¯ä»¥æŒä¹…åŒ–æ•°æ®åˆ°æœ¬åœ°2.å¯ä»¥å®ç°ç»“æ„åŒ–æŸ¥è¯¢ï¼Œæ–¹ä¾¿ç®¡ç† 3.æ•°æ®åº“å­˜å‚¨æ•°æ®ç‰¹ç‚¹12345671.å°†æ•°æ®æ”¾åˆ°è¡¨ä¸­ï¼Œè¡¨æ”¾åˆ°åº“ä¸­ã€‚2.ä¸€ä¸ªæ•°æ®åº“æœ‰å¤šå¼ è¡¨ï¼Œæ¯ä¸ªè¡¨éƒ½æœ‰ä¸€ä¸ªåå­—ï¼Œç”¨æ¥æ ‡è¯†è‡ªå·±ã€‚è¡¨åå…·æœ‰å”¯ä¸€æ€§ã€‚3.è¡¨å…·æœ‰ä¸€äº›ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§å®šä¹‰äº†æ•°æ®åœ¨è¡¨ä¸­å¦‚ä½•å­˜å‚¨ï¼Œç±»ä¼¼Javaä¸­ç±»çš„è®¾è®¡ã€‚4.è¡¨æœ‰åˆ—ç»„æˆï¼Œæˆ‘ä»¬ä¹Ÿç§°ä¸ºå­—æ®µã€‚æ‰€æœ‰è¡¨éƒ½æ˜¯ç”±ä¸€ä¸ªåˆ—æˆ–å¤šä¸ªåˆ—ç»„æˆçš„ï¼Œæ¯ä¸€åˆ—ç±»ä¼¼Javaä¸­çš„å±æ€§ã€‚5.è¡¨ä¸­çš„æ•°æ®æŒ‰ç…§è¡Œæ¥å­˜å‚¨ï¼Œæ¯ä¸€è¡Œç±»ä¼¼äºJavaä¸­çš„å¯¹è±¡ã€‚ 4.mysqlçš„å®‰è£…ä¸ä½¿ç”¨å‚ç…§mysqlå®‰è£…æ–‡æ¡£ 5.Mysqlå¸¸ç”¨å‘½ä»¤12345678910111213141516171819æ˜¾ç¤ºæ•°æ®åº“-----&gt;show Databases;ä½¿ç”¨æ•°æ®åº“-----&gt;use æ•°æ®åº“åï¼›æ˜¾ç¤ºè¡¨----&gt;show tables;æ˜¾å¼æŒ‡å®šæ•°æ®åº“çš„è¡¨----&gt;show tables from æ•°æ®åº“åï¼›æŸ¥çœ‹ä½äºé‚£ä¸ªæ•°æ®åº“----&gt;select database();æ˜¾ç¤ºè¡¨ç»“æ„---&gt;desc è¡¨åï¼›æŸ¥çœ‹æ•°æ®åº“ç‰ˆæœ¬ï¼š---&gt;select version();æŸ¥çœ‹æ•°æ®åº“ç‰ˆæœ¬2:-----&gt;Dos:mysql --version;æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯-----&gt;show CREATE DATABASE mydb1;æŸ¥çœ‹æœåŠ¡å™¨ä¸­çš„æ•°æ®åº“ï¼Œå¹¶æŠŠmydb1çš„å­—ç¬¦é›†ä¿®æ”¹ä¸ºutf-8-----&gt;ALTER DATABASE mydb1character set utf8;åˆ é™¤æ•°æ®åº“-----&gt;drop database mydb1;è¡¨ä¸­å¢åŠ ä¸€æ ä¿¡æ¯-----&gt;alter table student add image blob;åˆ é™¤è¡¨-----&gt;drop table student;ä¿®æ”¹åœ°å€-----&gt;alter table student modify address varchar(100);åˆ é™¤ä¸€ä¸ªå±æ€§-----&gt; alter table student drop image;ä¿®æ”¹è¡¨å-----&gt;rename table student to students;æŸ¥çœ‹è¡¨çš„åˆ›å»ºç»†èŠ‚-----&gt;show create table students;ä¿®æ”¹è¡¨çš„å­—ç¬¦é›†ä¸º gbk-----&gt;alter table students character set gbk;åˆ—ånameä¿®æ”¹ä¸ºstudentname-----&gt;alter table students change name studentname varchar(100); 6.mysqlè¯­æ³•è§„èŒƒ12345671.ä¸åŒºåˆ†å¤§å°å†™ï¼Œå»ºè®®å…³é”®å­—å¤§å†™ï¼Œè¡¨ååˆ—åå°å†™ã€‚2.æ¯æ¡å‘½ä»¤æœ€å¥½ç”¨åˆ†å·ç»“å°¾ã€‚3.æ¯æ¡è¯­å¥å¯ä»¥ç¼©è¿›ï¼Œæ¢è¡Œã€‚4.æ³¨é‡Šå•è¡Œæ³¨é‡Šï¼š#æ³¨é‡Šæ–‡å­— -- æ³¨é‡Šæ–‡å­—å¤šè¡Œæ³¨é‡Šï¼š/* */ äºŒï¼ŒDQLæŸ¥è¯¢è¯­è¨€1.åŸºç¡€æŸ¥è¯¢12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758**è¯­æ³•ï¼š select æŸ¥è¯¢åˆ—è¡¨ from è¡¨å****æŸ¥è¯¢åˆ—è¡¨ï¼šè¡¨ä¸­çš„å­—æ®µï¼Œå¸¸é‡ï¼Œè¡¨è¾¾å¼ï¼Œå‡½æ•°****æŸ¥è¯¢çš„ç»“æœæ˜¯å¼ è™šæ‹Ÿçš„è¡¨æ ¼**1.æŸ¥è¯¢è¡¨ä¸­çš„å•ä¸ªå­—æ®µselect last_name from employee;2.æŸ¥è¯¢è¡¨ä¸­çš„å¤šä¸ªå­—æ®µselect last_name,salary,email from employee;3.æŸ¥è¯¢è¡¨ä¸­çš„æ‰€æœ‰å­—æ®µselect * from employee;4.æŸ¥è¯¢å¸¸é‡å€¼select 100;select &#x27;john&#x27;;5.æŸ¥è¯¢è¡¨è¾¾å¼select 100*98;6.æŸ¥è¯¢å‡½æ•°select version();7.èµ·åˆ«åselect last_name as name from employee;select last_name name from employee;8.å»é‡æŸ¥è¯¢å‘˜å·¥è¡¨ä¸­æ¶‰åŠåˆ°çš„æ‰€æœ‰çš„éƒ¨é—¨ç¼–å·select distinct department_id from employee;9.+çš„ä½œç”¨#è¿ç®—ç¬¦ï¼šä¸¤ä¸ªæ“ä½œæ•°éƒ½ä¸ºæ•°å€¼å‹ï¼Œåˆ™åšåŠ æ³•è¿ç®—ï¼›#å…¶ä¸­ä¸€æ–¹ä¸ºå­—ç¬¦å‹ï¼Œè¯•å›¾å°†å­—ç¬¦å‹æ•°å€¼è½¬æ¢æˆæ•°å€¼å‹ï¼Œ#å¦‚æœè½¬æ¢æˆåŠŸï¼Œç»§ç»­åšåŠ æ³•è¿ç®—ï¼›å¦åˆ™ï¼Œå°†å­—ç¬¦å‹æ•°å€¼#è½¬æ¢ä¸º0ï¼›10.ä½¿ç”¨concatå®ç°è¿æ¥#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥åå’Œæ€§è¿æ¥æˆä¸€ä¸ªå­—æ®µSELECT CONCAT(username,PASSWORD) FROM USER;#ä»»ä½•æ•°ä¸nullåšè¿ç®—ç»“æœéƒ½ä¸ºnull 2.æ¡ä»¶æŸ¥è¯¢è¯­æ³•ï¼š select æŸ¥è¯¢åˆ—è¡¨ from è¡¨å where ç­›é€‰æ¡ä»¶ åˆ†ç±»ï¼š â‘ æŒ‰ç…§æ¡ä»¶è¡¨è¾¾å¼ç­›é€‰æ¡ä»¶è¿ç®—ç¬¦ï¼š&gt;,&lt;,=,!=,&gt;=,&lt;= 123456æŸ¥è¯¢å‘˜å·¥å·¥èµ„&gt;1w2çš„å‘˜å·¥ä¿¡æ¯select * from employee where salary &gt;12000;æŸ¥è¯¢éƒ¨é—¨ç¼–å·ï¼=90å·çš„å‘˜å·¥åå’Œéƒ¨é—¨ç¼–å·select name, dep_id from employee where dep_id 1=90ï¼› â‘¡æŒ‰ç…§é€»è¾‘è¡¨è¾¾å¼ç­›é€‰é€»è¾‘è¿ç®—ç¬¦ï¼š&amp;&amp;,||,!,AND,OR,NOT 1234æŸ¥è¯¢å·¥èµ„åœ¨ä¸€ä¸‡åˆ°ä¸¤ä¸‡ä¹‹è§çš„å‘˜å·¥åï¼Œå·¥èµ„ä»¥åŠå¥–é‡‘ã€‚select name,salary ,jiangjin where salary between 10000 and 20000;æŸ¥è¯¢éƒ¨é—¨ç¼–å·ä¸åœ¨90-110ä¹‹é—´ï¼Œæˆ–è€…å·¥èµ„é«˜äº15000çš„å‘˜å·¥ä¿¡æ¯ã€‚select * from employee where department&lt;90||department&gt;110 ||salary &gt;15000; â‘¢æ¨¡ç³ŠæŸ¥è¯¢likeï¼šä¸€èˆ¬å’Œé€šé…ç¬¦æ­é…ä½¿ç”¨é€šé…ç¬¦ï¼š%ä»»æ„å¤šä¸ªå­—ç¬¦ï¼ŒåŒ…å«0ä¸ªå­—ç¬¦_ä»»æ„å•ä¸ªå­—ç¬¦BETWEEN AND:åŒ…å«ä¸´ç•Œå€¼IN:åˆ¤æ–­æŸä¸ªå­—æ®µçš„å€¼æ˜¯å¦å±äºinåˆ—è¡¨ä¸­çš„æŸä¸€é¡¹IS NULL,IS NOT NULL:=æˆ–è€…ï¼=ä¸èƒ½ç”¨æ¥åˆ¤æ–­nullå®‰å…¨ç­‰äº&lt;=&gt;å¯ä»¥åˆ¤æ–­null 123456789101112131415æŸ¥è¯¢å‘˜å·¥åä¸­åŒ…å«açš„å‘˜å·¥ä¿¡æ¯select * from emp where name like %a%;æŸ¥è¯¢å‘˜å·¥åä¸­ç¬¬ä¸‰ä¸ªå­—ç¬¦ä¸ºeç¬¬äº”ä¸ªå­—ç¬¦ä¸ºaçš„å‘˜å·¥åå’Œå·¥èµ„select name ,salary from emp where name like %__e_a%;å‘˜å·¥åä¸­ç¬¬äºŒä¸ªå­—ç¬¦ä¸º_çš„å‘˜å·¥åselect name from emp where name like %_\\_%;æŸ¥è¯¢å‘˜å·¥ç¼–å·åœ¨100åˆ°120ä¹‹é—´çš„æ‰€æœ‰å‘˜å·¥ä¿¡æ¯select * from emp where id between 100 and 120;æŸ¥è¯¢å‘˜å·¥çš„å·¥ç§ç¼–å·æ˜¯IT_PRIG,AD_PRES,AD_VPä¸­çš„ä¸€ä¸ªå‘˜å·¥åå’Œå·¥ç§ç¼–å·ï¼›select name , id from emp where id in(IT_PRIG,AD_PRES,AD_VP);æŸ¥è¯¢æ²¡æœ‰å¥–é‡‘çš„å‘˜å·¥åå’Œå¥–é‡‘ç‡select salary , jjl from emp where salary is Null;æŸ¥è¯¢æœ‰å¥–é‡‘çš„å‘˜å·¥åå’Œå¥–é‡‘ç‡select salary ,jjl from emp where salary is not null; â‘£IF nullçš„ä½¿ç”¨ï¼š123æŸ¥è¯¢å‘˜å·¥å·ä¸º176çš„å‘˜å·¥çš„å§“åå’Œéƒ¨é—¨å·å’Œå¹´è–ªSELECT last_name ,department_id , salary*(1+IFNULL(commission_pct,0))*12 &#x27;å¹´è–ª&#x27;FROM employees WHERE employee_id =176; 3.æ’åºæŸ¥è¯¢è¯­æ³•ï¼š select æŸ¥è¯¢åˆ—è¡¨ from è¡¨ where ç­›é€‰æ¡ä»¶ order by æ’åºåˆ—è¡¨ asc æˆ–desc ï¼ˆå‡åºæˆ–è€…é™åºï¼Œé»˜è®¤ä¸ºå‡åºï¼‰ 12345678910æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯ï¼Œè¦æ±‚å·¥èµ„ä»é«˜åˆ°ä½æ’åºselect * from emp order by salary desc;æŸ¥è¯¢éƒ¨é—¨ç¼–å·å¤§äºç­‰äº90çš„å‘˜å·¥ä¿¡æ¯ï¼ŒæŒ‰ç…§å…¥èŒæ—¶é—´å…ˆåæ’åºselect * from emp where dep_id &gt;=90 order by createtime asc;æŒ‰ç…§å‘˜å·¥å¹´è–ªçš„é«˜ä½æ˜¾ç¤ºå‘˜å·¥çš„ä¿¡æ¯å’Œå¹´è–ªselect * ,å¹´è–ª from emp order by salary*(1+if null(jjl,0))*12 as å¹´è–ª desc;æŒ‰å§“åé•¿åº¦æ˜¾ç¤ºå‘˜å·¥çš„å§“åå’Œå·¥èµ„select name ,salary from emp order by length(name) asc;æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯ï¼Œå…ˆæŒ‰ç…§å·¥èµ„æ’åºï¼Œå†æŒ‰ç…§å‘˜å·¥ç¼–å·æ’åºselect * from emp order by salary asc,id asc; 4.å¸¸è§å‡½æ•°åŠŸèƒ½ï¼šç±»ä¼¼Javaä¸­çš„æ–¹æ³•åˆ†ç±»ï¼šå•è¡Œå‡½æ•°åˆ†ç»„å‡½æ•° 1.å•è¡Œå‡½æ•°1.å­—ç¬¦å‡½æ•°12345678910111213141516171819202122232425262728293031323334353637381.length è·å–å‚æ•°å€¼çš„å­—èŠ‚ä¸ªæ•°select * from emp order by length(name);2.concat æ‹¼æ¥å­—ç¬¦ä¸²select concat(last_name,first_name) as å§“å from emp;3.upperï¼Œlower å¤§å°å†™è½¬æ¢å‡½æ•°æ¡ˆä¾‹ï¼šå°†å§“å˜å¤§å†™ï¼Œåå­—å˜å°å†™ï¼Œç„¶åæ‹¼æ¥SELECT CONCAT(UPPER(last_name),LOWER(first_name))FROM employees;4.substr,SUBSTRING æˆªå–å­—ç¬¦ä¸²SELECT SUBSTR(&#x27;æè«æ„&#x27;,2);SELECT SUBSTR(&#x27;æè«æ„&#x27;,2,3);æ¡ˆä¾‹ï¼šå§“åä¸­é¦–å­—ç¬¦å¤§å†™ï¼Œå…¶ä»–çš„å°å†™ç„¶åç”¨_æ‹¼æ¥æ˜¾ç¤ºå‡ºæ¥SELECT CONCAT( UPPER(SUBSTR(last_name, 1, 1)), &#x27;_&#x27;, LOWER(SUBSTR(last_name, 2)) ) output FROM employees ;5.instr:è¿”å›å­—ä¸²ç¬¬ä¸€æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœæ‰¾ä¸åˆ°è¿”å›0SELECT INSTR(&#x27;é£æ€¥å¤©é«˜çŒ¿å•¸å“€&#x27;,&#x27;å¤©&#x27;) AS out_put;6.trim :å»æ‰å‰åç©ºæ ¼æˆ–å‰åæŒ‡å®šå­—ç¬¦SELECT LENGTH(TRIM(&#x27; å¼ ä¸‰ä¸° &#x27;)) AS out_put;SELECT TRIM(&#x27;a&#x27; FROM &#x27;aaaa1aa2aaa3aaa&#x27;) AS out_put;7.lpad :ç”¨æŒ‡å®šå­—ç¬¦å¡«æ»¡æŒ‡å®šé•¿åº¦ï¼ˆå·¦å¡«å……ï¼‰SELECT LPAD(&#x27;è‹è€å¸ˆ&#x27;,10,&#x27;*&#x27;);8.rpad:ç”¨æŒ‡å®šå­—ç¬¦å¡«æ»¡æŒ‡å®šé•¿åº¦ï¼ˆå³å¡«å……ï¼‰SELECT RPAD(&#x27;è‹è€å¸ˆ&#x27;,10,&#x27;*&#x27;);9.replace æ›¿æ¢SELECT REPLACE(&#x27;åƒé”‹åŸ¹è®­æœºæ„&#x27;,&#x27;åƒé”‹&#x27;,&#x27;å°šç¡…è°·&#x27;); 2.æ•°å­¦å‡½æ•°12345678910111.round:å››èˆäº”å…¥SELECT ROUND(1.666);SELECT ROUND(1.567,2);2.ceil å‘ä¸Šå–æ•´SELECT CEIL(1.52);3.floor å‘ä¸‹å–æ•´SELECT FLOOR(1.52);4.truncate:æˆªæ–­ï¼ˆå°æ•°ç‚¹åä¿ç•™å‡ ä½ï¼‰SELECT TRUNCATE(1.65,2);5.mod:å–ä½™SELECT MOD(10,3); 3.æ—¥æœŸå‡½æ•°123456789101112131415161718192021222324252627281.now:è¿”å›å½“å‰ç³»ç»Ÿæ—¥æœŸæ—¶é—´SELECT NOW();2.curdate:è¿”å›å½“å‰ç³»ç»Ÿæ—¥æœŸSELECT CURDATE();3.curtime:è¿”å›å½“å‰æ—¶é—´SELECT CURTIME();4.è·å–æŒ‡å®šéƒ¨åˆ†çš„å¹´æœˆæ—¥æ—¶åˆ†ç§’SELECT YEAR(NOW());SELECT YEAR(hiredate) FROM employees;5.str_to_dateå°†å­—ç¬¦é€šè¿‡æŒ‡å®šçš„æ ¼å¼è½¬åŒ–æˆæ—¥æœŸSELECT STR_TO_DATE(&#x27;1998-3-2&#x27;,&#x27;%Y-%c-%d&#x27;) AS out_put;æ¡ˆä¾‹ï¼šæŸ¥è¯¢å…¥èŒæ—¶é—´ä¸º1992-4-3çš„å‘˜å·¥ä¿¡æ¯SELECT * FROM employeesWHERE hiredate=STR_TO_DATE(&#x27;2016-3-3&#x27;,&#x27;%Y-%c-%d&#x27;);6.date_format å°†æ—¥æœŸè½¬æ¢æˆå­—ç¬¦SELECT DATE_FORMAT(NOW(),&#x27;%yå¹´%mæœˆ%dæ—¥&#x27;) AS æ—¥æœŸ;æ¡ˆä¾‹ï¼šæŸ¥è¯¢æœ‰å¥–é‡‘çš„å‘˜å·¥åå’Œå…¥èŒæ—¥æœŸï¼ˆxxæœˆ/xxæ—¥ xxå¹´ï¼‰SELECT last_name, DATE_FORMAT(hiredate, &#x27;%cæœˆ/%dæ—¥ %y&#x27;) FROM employees WHERE commission_pct IS NOT NULL ; 4.å…¶ä»–å‡½æ•°123SELECT VERSION();SELECT DATABASE();SELECT USER(); 5.æµç¨‹æ§åˆ¶å‡½æ•°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465661.if:IF elseæ•ˆæœSELECT IF(10&gt;5,&#x27;true&#x27;,&#x27;false&#x27;);æ¡ˆä¾‹ï¼šæŸ¥è¯¢å¦‚æœæœ‰å¥–é‡‘å°±å¤‡æ³¨æœ‰ï¼Œæ²¡æœ‰å°±å¤‡æ³¨æ²¡æœ‰ã€‚SELECT last_name, commission_pct, IF( commission_pct IS NULL, &#x27;æ²¡å¥–é‡‘&#x27;, &#x27;æœ‰å¥–é‡‘&#x27; ) AS å¤‡æ³¨ FROM employees ;2.caseå‡½æ•°1)switch-CASEè¯­æ³•:CASE è¦åˆ¤æ–­çš„å­—æ®µæˆ–è€…è¡¨è¾¾å¼WHEN å¸¸é‡1 THEN è¦æ˜¾ç¤ºçš„å€¼1æˆ–è€…è¯­å¥1WHEN å¸¸é‡2 THEN è¦æ˜¾ç¤ºçš„å€¼2æˆ–è€…è¯­å¥2...ELSE è¦æ˜¾ç¤ºçš„å€¼næˆ–è€…è¯­å¥nï¼›æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥çš„å·¥èµ„ï¼Œè¦æ±‚éƒ¨é—¨å·==30ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.1å€ï¼Œéƒ¨é—¨å·==40ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.2å€ï¼Œéƒ¨é—¨å·==50ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.3å€ï¼Œå…¶ä»–éƒ¨é—¨ï¼Œæ˜¾ç¤ºåŸæœ‰å·¥èµ„ã€‚SELECT salary AS åŸå§‹å·¥èµ„, department_id , CASE department_id WHEN 30 THEN salary * 1.1 WHEN 40 THEN salary * 1.2 WHEN 50 THEN salary * 1.3 ELSE salary END AS æ–°å·¥èµ„ FROM employees ;2)CASE ä½¿ç”¨2ï¼šè¯­æ³•ï¼šCASE WHEN æ¡ä»¶1 THEN è¦æ˜¾ç¤ºçš„å€¼1æˆ–è¯­å¥1WHEN æ¡ä»¶2 THEN è¦æ˜¾ç¤ºçš„å€¼2æˆ–è¯­å¥2...ELSE è¦æ˜¾ç¤ºçš„å€¼næˆ–è¯­å¥nENDæ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥çš„å·¥èµ„æƒ…å†µå¦‚æœ&gt;2wï¼Œæ˜¾ç¤ºAå¦‚æœ&gt;1.5wï¼Œæ˜¾ç¤ºBå¦‚æœ&gt;1wï¼Œæ˜¾ç¤ºCå¦åˆ™ï¼Œæ˜¾ç¤ºDSELECT salary, CASE WHEN salary &gt; 20000 THEN &#x27;A&#x27; WHEN salary &gt; 15000 THEN &#x27;B&#x27; WHEN salary &gt; 10000 THEN &#x27;C&#x27; ELSE &#x27;D&#x27; END AS å·¥èµ„ç­‰çº§ FROM employees ; 2.åˆ†ç»„å‡½æ•°åŠŸèƒ½ï¼šç”¨ä½œç»Ÿè®¡ä½¿ç”¨ 123456789101112131415161718192021222324251.sum :æ±‚å’ŒSELECT SUM(salary) FROM employees;2.avgï¼šå¹³å‡å€¼SELECT AVG(salary) FROM employees;3.maxï¼šæœ€å¤§å€¼SELECT MAX(salary) FROM employees;4.minï¼šæœ€å°å€¼SELECT MIN(salary) FROM employees;5.countï¼šè®¡ç®—ä¸ªæ•°SELECT COUNT(salary) FROM employees;æ€»ç»“â‘ .sum,avgä¸€èˆ¬ç”¨äºå¤„ç†æ•°å€¼ç±»å‹â‘¡.maxï¼Œminï¼Œcountç”¨æ¥å¤„ç†ä»»ä½•ç±»å‹â‘¢.ä»¥ä¸Šåˆ†ç»„å‡½æ•°éƒ½å¿½ç•¥nullå€¼â‘£.å¯ä»¥å’Œdistinctæ­é…SELECT SUM(DISTINCT salary) çº¯å‡€,SUM(salary) FROM employees;6.countçš„è¯¦ç»†ä»‹ç»â‘ select COUNT(*) FROM employees;â‘¡select COUNT(1) FROM employees;â‘¢å’Œåˆ†ç»„å‡½æ•°ä¸€åŒæŸ¥è¯¢çš„å­—æ®µè¦æ±‚æ˜¯group byåçš„å­—æ®µã€‚ 5.åˆ†ç»„æŸ¥è¯¢GROUP BY å’Œåˆ†ç»„å‡½æ•°å¯¹åº”åˆ†ç»„æŸ¥è¯¢ä¸­åˆ†ç»„æ¡ä»¶åˆ†ä¸ºä¸¤ç±» æ•°æ®æº ä½ç½® å…³é”®å­— åˆ†ç»„å‰ç­›é€‰ åŸå§‹è¡¨ GROUP BY å­å¥çš„å‰é¢ WHERE åˆ†ç»„åç­›é€‰ åˆ†ç»„åçš„ç»“æœé›† GROUP BY å­å¥çš„åé¢ HAVING åˆ†ç»„å‡½æ•°åšæ¡ä»¶è‚¯å®šæ˜¯æ”¾åœ¨havingå­å¥ä¸­ã€‚group BY å­å¥æ”¯æŒå•ä¸ªå­—æ®µåˆ†ç»„ï¼Œå¤šä¸ªå­—æ®µåˆ†ç»„ï¼ˆå¤šä¸ªå­—æ®µä¹‹é—´ç”¨é€—å·éš”å¼€æ²¡æœ‰é¡ºåºè¦æ±‚ï¼‰ï¼Œè¡¨è¾¾å¼æˆ–å‡½æ•°ã€‚ä¹Ÿå¯ä»¥æ·»åŠ æ’åºï¼Œæ”¾åœ¨æ•´ä¸ªåˆ†ç»„æŸ¥è¯¢çš„æœ€åã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ¯ä¸ªå·¥ç§çš„æœ€é«˜å·¥èµ„SELECT MAX(salary), job_id FROM employees GROUP BY job_id ORDER BY MAX(salary) ASC ;æ¡ˆä¾‹ï¼šæŸ¥è¯¢é‚®ç®±ä¸­åŒ…å«aå­—ç¬¦çš„ï¼Œæ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„SELECT AVG(salary), department_id FROM employees WHERE email LIKE &#x27;%a%&#x27; GROUP BY department_id ;#select Avg(salary),dep_id from employee where email like %a% group by dep_id ;æ¡ˆä¾‹ï¼šæŸ¥è¯¢æœ‰å¥–é‡‘çš„æ¯ä¸ªé¢†å¯¼æ‰‹ä¸‹å‘˜å·¥çš„æœ€é«˜å·¥èµ„SELECT MAX(salary), manager_id FROM employees WHERE commission_pct IS NOT NULL GROUP BY manager_id ;#select max(salary) ,manage_id from employees where commission_pct is not null group by manager_id;æ¡ˆä¾‹ï¼šå“ªä¸ªéƒ¨é—¨çš„å‘˜å·¥ä¸ªæ•°å¤§äºäºŒï¼ŸSELECT COUNT(*), department_id FROM employees GROUP BY department_id HAVING COUNT(*) &gt; 2 ;#select dep_id from emp group by dep_id having count(*)&gt;2;æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ¯ä¸ªå·¥ç§æœ‰å¥–é‡‘çš„å‘˜å·¥çš„æœ€é«˜å·¥èµ„&gt;12000çš„å·¥ç§ç¼–å·å’Œæœ€é«˜å·¥èµ„SELECT MAX(salary), job_id FROM employees WHERE commission_pct IS NOT NULL GROUP BY job_id HAVING MAX(salary) &gt; 12000 ;#select job_id ,max(salary) from emp where commission_pct IS NOT NULL group by job_id having max(salary)&gt;12000;æ¡ˆä¾‹ï¼šæŸ¥è¯¢é¢†å¯¼ç¼–å·&gt;102çš„æ¯ä¸ªé¢†å¯¼æ‰‹ä¸‹çš„æœ€ä½å·¥èµ„&gt;5000çš„é¢†å¯¼ç¼–å·æ˜¯å“ªä¸ªï¼ŸSELECT manager_id ,MIN(salary)FROM employeesWHERE manager_id&gt;102GROUP BY manager_idHAVING MIN(salary)&gt;5000;#select manager_id from emp where manager_id&gt;102 group by manager_id having min(salary)&gt;5000;#æŒ‰ç…§å‘˜å·¥å§“åçš„é•¿åº¦åˆ†ç»„ï¼ŒæŸ¥è¯¢æ¯ä¸€ç»„çš„å‘˜å·¥ä¸ªæ•°ï¼Œç­›é€‰å‘˜å·¥ä¸ªæ•°&gt;5çš„æœ‰å“ªäº›ï¼ŸSELECT COUNT(*) AS cFROM employeesGROUP BY LENGTH(last_name) HAVING c&gt;5;# select count(*) from emp group by length(name) having count(*)&gt;5;#æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨æ¯ä¸ªå·¥ç§çš„å‘˜å·¥çš„å¹³å‡å·¥èµ„SELECT AVG(salary),job_idFROM employeesGROUP BY department_id,job_id;#select avg(salary) from emp group by dep_id,job_id;#æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨æ¯ä¸ªå·¥ç§çš„å‘˜å·¥çš„å¹³å‡å·¥èµ„å¹¶ä¸”æŒ‰ç…§å¹³å‡å·¥èµ„çš„é«˜ä½æ˜¾ç¤ºSELECT AVG(salary),job_idFROM employeesGROUP BY department_id,job_idORDER BY AVG(salary) ASC;#select avg(salary) from emp group by dep_id,job_id order by avg(salary) asc; 6.è¿æ¥æŸ¥è¯¢åˆç§°ä¸ºå¤šè¡¨æŸ¥è¯¢ï¼Œå½“æŸ¥è¯¢çš„å­—æ®µæ¥è‡ªå¤šä¸ªè¡¨æ—¶ï¼Œå°±ä¼šç”¨åˆ°è¿æ¥æŸ¥è¯¢ã€‚**ç¬›å¡å°”ä¹˜ç§¯ç°è±¡ï¼šè¡¨1æœ‰mè¡Œï¼Œè¡¨2æœ‰nè¡Œï¼Œç»“æœï¼šm_nè¡Œ_å‘ç”ŸåŸå› ï¼šæ²¡æœ‰æœ‰æ•ˆçš„è¿æ¥æ¡ä»¶ åˆ†ç±» â‘ æŒ‰å¹´ä»£åˆ†ç±»sql92:ä»…ä»…æ”¯æŒå†…è¿æ¥sql99ï¼šä¸æ”¯æŒå…¨å¤–è¿æ¥ â‘¡æŒ‰åŠŸèƒ½åˆ†ç±» å†…è¿æ¥ å¤–è¿æ¥ äº¤å‰è¿æ¥ ç­‰å€¼è¿æ¥ å·¦å¤–è¿æ¥ éç­‰å€¼è¿æ¥ å³å¤–è¿æ¥ è‡ªè¿æ¥ å…¨å¤–è¿æ¥ 1.ç­‰å€¼è¿æ¥â‘ å¤šè¡¨ç­‰å€¼è¿æ¥çš„ç»“æœä¸ºå¤šè¡¨çš„äº¤é›†éƒ¨åˆ†â‘¡nè¡¨è¿æ¥ï¼Œè‡³å°‘éœ€è¦n-1ä¸ªè¿æ¥æ¡ä»¶â‘¢å¤šè¡¨çš„é¡ºåºæ²¡æœ‰è¦æ±‚â‘£ä¸€èˆ¬éœ€è¦ä¸ºè¡¨èµ·åˆ«åâ‘¤å¯ä»¥æ­é…å‰é¢ä»‹ç»çš„æ‰€æœ‰å­å¥ä½¿ç”¨ï¼Œæ¯”å¦‚æ’åºï¼Œåˆ†ç»„ï¼Œç­›é€‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192#æ¡ˆä¾‹ä¸€ï¼šæŸ¥è¯¢å¥³ä¼˜åå¯¹åº”çš„ç”·ä¼˜åSELECT NAME, boyName FROM beauty, boys WHERE beauty.boyfriend_id = boys.`id` ;#select name, boyname from girl ,boy where girl.boyfriend_id=boy.id;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥åå’Œå¯¹åº”çš„éƒ¨é—¨åSELECT last_name, department_name FROM employees, departments WHERE employees.`department_id` = departments.`department_id` ;#select name ,dep_name from emp e,dep d where e.dep.id= d.id;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥åï¼Œå·¥ç§å·ï¼Œå·¥ç§åã€‚SELECT last_name, emp.`job_id`, job_title FROM employees emp, jobs job WHERE emp.`job_id` = job.`job_id` ;#select name , e.job_id,job_title from emp e,job j where e.job_id=j.id;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢æœ‰å¥–é‡‘çš„å‘˜å·¥åå’Œéƒ¨é—¨åSELECT last_name, department_name FROM employees emp, departments dep WHERE commission_pct IS NOT NULL &amp;&amp; emp.`department_id` = dep.`department_id` ;#select name ,dep_name from emp e ,dep d where e.dep_id =d.id &amp;&amp;e.salary_pct is not null;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢åŸå¸‚åç¬¬äºŒä¸ªå­—ç¬¦ä¸ºoçš„éƒ¨é—¨SELECT department_name FROM locations l, departments d WHERE l.`location_id` = d.`location_id` AND l.`city` LIKE &#x27;_o%&#x27; ;#select dep_name from location l , dep d where l.city like %_o% &amp;&amp; l.id =d.location_id;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ¯ä¸ªåŸå¸‚çš„éƒ¨é—¨ä¸ªæ•°SELECT COUNT(*), city FROM locations l, departments d WHERE l.`location_id` = d.`location_id` GROUP BY l.`city` ;#select count(*),city from loca l,dep d where l.loc_id=d.loc_id group by count(*) asc;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢æœ‰å¥–é‡‘çš„æ¯ä¸ªéƒ¨é—¨çš„éƒ¨é—¨åå’Œéƒ¨é—¨çš„é¢†å¯¼ç¼–å·å’Œè¯¥éƒ¨é—¨çš„æœ€ä½å·¥èµ„SELECT d.`department_name`, d.manager_id, MIN(salary) FROM employees e, departments d WHERE e.`department_id` = d.`department_id` AND e.`commission_pct` IS NOT NULL GROUP BY d.`department_id`, d.`department_name` ;#select dep_name ,d.manager_id ,min(salary) from emp e ,dep d where e.`department_id` = d.`department_id` AND e.`commission_pct` IS NOT NULL GROUP BY d.`department_id`,d.`department_name` ;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ¯ä¸ªå·¥ç§çš„å·¥ç§åå’Œå‘˜å·¥çš„ä¸ªæ•°ï¼Œå¹¶ä¸”æŒ‰ç…§å‘˜å·¥ä¸ªæ•°é™åºæ’åºSELECT j.job_title, COUNT(*) FROM jobs j, employees e WHERE j.`job_id` = e.`job_id` GROUP BY e.`job_id`, j.`job_title` ORDER BY COUNT(*) DESC ;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥åï¼Œéƒ¨é—¨åå’Œæ‰€åœ¨åŸå¸‚SELECT last_name, department_name, city FROM employees e, departments d, locations l WHERE e.`department_id` = d.`department_id` AND d.`location_id` = l.`location_id` ; 2.éç­‰å€¼è¿æ¥123456789#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥çš„å·¥èµ„å’Œå·¥èµ„çº§åˆ«SELECT DISTINCT salary, grade_level FROM employees e, job_grades j WHERE e.salary &gt;= j.lowest_sal &amp;&amp; e.salary &lt;= j.highest_sal ORDER BY salary ASC ; 3.è‡ªè¿æ¥12345678#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥åå’Œä¸Šçº§çš„åç§°SELECT e.last_name, m.last_name FROM employees e, employees m WHERE e.manager_id = m.employee_id ; 4.å†…è¿æ¥INNER å¯ä»¥çœç•¥ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475#æŸ¥è¯¢å‘˜å·¥åï¼Œéƒ¨é—¨åSELECT last_name, department_name FROM employees e INNER JOIN departments d ON e.department_id = d.department_id ;#æŸ¥è¯¢åå­—ä¸­åŒ…å«eçš„å‘˜å·¥åå’Œå·¥ç§åSELECT last_name, job_title FROM employees e INNER JOIN jobs j ON e.job_id = j.job_id WHERE last_name LIKE &#x27;%e%&#x27; ;#æŸ¥è¯¢éƒ¨é—¨ä¸ªæ•°&gt;3çš„åŸå¸‚åå’Œéƒ¨é—¨ä¸ªæ•°SELECT city, COUNT(*) FROM departments d INNER JOIN locations l ON d.`location_id` = l.`location_id` GROUP BY cityHAVING COUNT(*) &gt; 3 ;#æŸ¥è¯¢å“ªä¸ªéƒ¨é—¨çš„éƒ¨é—¨å‘˜å·¥ä¸ªæ•°&gt;3çš„éƒ¨é—¨åå’Œå‘˜å·¥ä¸ªæ•°ï¼Œå¹¶æŒ‰ç…§ä¸ªæ•°é™åºæ’åºSELECT department_name, COUNT(*) FROM employees e INNER JOIN departments d ON e.`department_id` = d.`department_id` GROUP BY e.department_id HAVING COUNT(*) &gt; 3 ORDER BY COUNT(*) DESC ;#æŸ¥è¯¢å‘˜å·¥åï¼Œéƒ¨é—¨åï¼Œå·¥ç§åï¼Œå¹¶æŒ‰ç…§éƒ¨é—¨åé™åºæ’åºSELECT last_name, department_name, job_title FROM employees e INNER JOIN departments d ON e.`department_id` = d.`department_id` INNER JOIN jobs j ON e.`job_id` = j.`job_id` ORDER BY department_name DESC ;#æŸ¥è¯¢å‘˜å·¥å·¥èµ„çº§åˆ«SELECT grade_level, salaryFROM job_grades j INNER JOIN employees e ON e.`salary` BETWEEN j.`lowest_sal` AND j.`highest_sal` ;#æŸ¥è¯¢æ¯ä¸ªå·¥èµ„çº§åˆ«çš„ä¸ªæ•°ï¼Œå¹¶ä¸”é™åºæ’åºSELECT grade_level,COUNT(*)FROM employees eINNER JOIN job_grades jON e.`salary` BETWEEN j.`lowest_sal` AND j.`highest_sal` GROUP BY grade_levelORDER BY COUNT(*) DESC;#æŸ¥è¯¢å‘˜å·¥çš„åå­—å’Œä¸Šçº§çš„åå­—SELECT e1.last_name, e2.last_nameFROM employees e1INNER JOIN employees e2ON e1.`employee_id`=e2.`manager_id`; 5.å·¦å¤–è¿æ¥è¯­æ³•ï¼šSELECT æŸ¥è¯¢åˆ—è¡¨FROM è¡¨1 ã€è¿æ¥ç±»å‹ã€‘JOIN è¡¨2ON è¿æ¥æ¡ä»¶WHERE ç­›é€‰æ¡ä»¶GROUP BY åˆ†ç»„HAVING ç­›é€‰æ¡ä»¶ORDER BY æ’åºæ¡ä»¶è¿æ¥ç±»å‹ï¼šå†…è¿æ¥ï¼šinnerå·¦å¤–è¿æ¥ï¼šleftå³å¤–è¿æ¥ï¼šrightå…¨å¤–è¿æ¥ï¼šfulläº¤å‰è¿æ¥ï¼šcrosså¤–è¿æ¥ç”¨äºæŸ¥è¯¢ä¸€ä¸ªè¡¨ä¸­æœ‰ï¼Œå¦ä¸€ä¸ªè¡¨ä¸­æ²¡æœ‰çš„æ•°æ®å·¦å¤–è¿æ¥ï¼Œleftå·¦è¾¹æ˜¯ä¸»è¡¨å³å¤–è¿æ¥ï¼Œrightå³è¾¹æ˜¯ä¸»è¡¨Mysqlä¸æ”¯æŒå…¨å¤–è¿æ¥ 1234567#æ²¡æœ‰ç”·æœ‹å‹çš„å¥³ç”ŸSELECT g.`name`,b.`boyName`FROM beauty gLEFT JOIN boys bON g.`boyfriend_id`=b.`id`WHERE b.`boyName` IS NULL; 6.äº¤å‰è¿æ¥ç¬›å¡å°”ä¹˜ç§¯ 7.å­æŸ¥è¯¢å‡ºç°åœ¨å…¶å®ƒè¯­å¥ä¸­çš„selectè¯­å¥ï¼Œç§°ä¸ºå­æŸ¥è¯¢æˆ–å†…æŸ¥è¯¢å¤–éƒ¨çš„æŸ¥è¯¢è¯­å¥ï¼Œç§°ä¸ºä¸»æŸ¥è¯¢æˆ–å¤–æŸ¥è¯¢åˆ†ç±»ï¼š â‘ æŒ‰ç…§å­æŸ¥è¯¢å‡ºç°çš„ä½ç½®ï¼š selectåé¢ fromåé¢ whereæˆ–havingåé¢ existsåé¢ ä»…ä»…æ”¯æŒæ ‡é‡å­æŸ¥è¯¢ æ”¯æŒè¡¨å­æŸ¥è¯¢ æ ‡é‡å­æŸ¥è¯¢ï¼Œåˆ—å­æŸ¥è¯¢ è¡¨å­æŸ¥è¯¢ â‘¡æŒ‰ç…§ç»“æœé›†çš„è¡Œåˆ—æ•°ä¸åŒï¼š æ ‡é‡å­æŸ¥è¯¢ åˆ—å­æŸ¥è¯¢ è¡Œå­æŸ¥è¯¢ è¡¨å­æŸ¥è¯¢ ç»“æœåªæœ‰ä¸€è¡Œä¸€åˆ— ç»“æœä¸€åˆ—å¤šè¡Œ ä¸€è¡Œå¤šåˆ— å¤šè¡Œå¤šåˆ— 1ï¼‰whereæˆ–havingåé¢ç‰¹ç‚¹ï¼šå­æŸ¥è¯¢ä¸€èˆ¬æ”¾åœ¨å°æ‹¬å·å†…å­æŸ¥è¯¢ä¸€èˆ¬æ”¾åœ¨æ¡ä»¶çš„å³è¾¹æ ‡é‡å­æŸ¥è¯¢ï¼Œä¸€èˆ¬æ­é…ç€å•è¡Œæ“ä½œç¬¦åˆ—å­æŸ¥è¯¢ï¼šä¸€èˆ¬æ­é…å¤šè¡Œæ“ä½œç¬¦ä½¿ç”¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211.æ ‡é‡å­æŸ¥è¯¢#è°çš„å·¥èµ„æ¯”Abelé«˜SELECT last_name FROM employees WHERE salary &gt; (SELECT salary FROM employees WHERE last_name = &#x27;Abel&#x27;) ;#è¿”å›job_idäº141å·å‘˜å·¥ç›¸åŒï¼Œsalaryæ¯”143å·å‘˜å·¥å¤šçš„å‘˜å·¥ å§“åï¼Œjob_idå’Œå·¥èµ„SELECT last_name, job_id, salary FROM employees WHERE job_id = (SELECT job_id FROM employees WHERE employee_id = 141) AND salary &gt; (SELECT salary FROM employees WHERE employee_id = 143)#è¿”å›å…¬å¸å·¥èµ„å·¥èµ„æœ€å°‘çš„å‘˜å·¥çš„å§“åï¼Œjob_id,salarySELECT last_name, job_id, salary FROM employees WHERE salary = (SELECT MIN(salary) FROM employees);#æŸ¥è¯¢æœ€ä½å·¥èµ„å¤§äº50å·éƒ¨é—¨æœ€ä½å·¥èµ„çš„éƒ¨é—¨idå’Œå…¶æœ€ä½å·¥èµ„SELECT department_id, MIN(salary) FROM employees GROUP BY department_id HAVING MIN(salary) &gt; (SELECT MIN(salary) FROM employees WHERE department_id = 50) ;2.åˆ—å­æŸ¥è¯¢å¤šè¡Œæ“ä½œç¬¦ï¼šIN / NOT inï¼šç­‰äºåˆ—è¡¨ä¸­çš„ä»»æ„ä¸€ä¸ªANY / SOME ï¼šå’Œå­æŸ¥è¯¢è¿”å›çš„æŸä¸€ä¸ªå€¼æ¯”è¾ƒALL ï¼šå’Œå­æŸ¥è¯¢è¿”å›çš„æ‰€æœ‰å€¼æ¯”è¾ƒ#è¿”å›location_idæ˜¯1400æˆ–è€…1700çš„éƒ¨é—¨ä¸­çš„æ‰€æœ‰å‘˜å·¥å§“åSELECT last_name FROM employees WHERE department_id IN (SELECT DISTINCT department_id FROM departments WHERE location_id IN (1400, 1700)) ;#è¿”å›å…¶ä»–å·¥ç§ä¸­æ¯”job_idä¸ºIT_PROGéƒ¨é—¨ä»»æ„å·¥èµ„ä½çš„å‘˜å·¥#å·¥å·ï¼Œå§“åï¼Œjob_idä»¥åŠsalarySELECT employee_id, last_name, job_id, salary FROM employees WHERE salary &lt; (SELECT MAX(salary) FROM employees WHERE job_id = &#x27;IT_PROG&#x27;) AND job_id !=&#x27;IT_PROG&#x27;;#è¿”å›å…¶ä»–å·¥ç§ä¸­æ¯”job_idä¸ºIT_PROGéƒ¨é—¨æ‰€æœ‰å·¥èµ„ä½çš„å‘˜å·¥#å·¥å·ï¼Œå§“åï¼Œjob_idä»¥åŠsalarySELECT employee_id, last_name, job_id, salary FROM employees WHERE salary &lt; (SELECT MIN(salary) FROM employees WHERE job_id = &#x27;IT_PROG&#x27;) AND job_id !=&#x27;IT_PROG&#x27;;*********************************3.è¡Œå­æŸ¥è¯¢#æŸ¥è¯¢å‘˜å·¥ç¼–å·æœ€å°å¹¶ä¸”å·¥èµ„æœ€é«˜çš„å‘˜å·¥ä¿¡æ¯SELECT * FROM employees WHERE employee_id = (SELECT MIN(employee_id) FROM employees) AND salary = (SELECT MAX(salary) FROM employees) 2ï¼‰SELECT åé¢123456789101112131415161718192021#æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨çš„å‘˜å·¥ä¸ªæ•°SELECT d.*, (SELECT COUNT(*) FROM employees e WHERE e.department_id = d.department_id) FROM departments d ;#æŸ¥è¯¢å‘˜å·¥å·ç­‰äº102çš„éƒ¨é—¨åSELECT department_name FROM departments WHERE department_id = (SELECT department_id FROM employees WHERE employee_id = 102) ; 3ï¼‰FROM åé¢1234567891011121314#æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨å¹³å‡å·¥èµ„çš„å·¥èµ„ç­‰çº§SELECT grade_level ,aa.department_idFROM (SELECT AVG(salary) ag, department_id FROM employees GROUP BY department_id) aa INNER JOIN job_grades j ON aa.ag BETWEEN lowest_sal AND highest_sal ; 4ï¼‰existsåé¢ï¼ˆç›¸å…³å­æŸ¥è¯¢ï¼‰12345678#æŸ¥è¯¢æœ‰å‘˜å·¥çš„éƒ¨é—¨åSELECT department_name FROM departments dWHERE EXISTS(SELECT * FROM employees e WHERE d.department_id=e.department_id);#æŸ¥è¯¢æ²¡æœ‰å¥³æœ‹å‹çš„ç”·ç”Ÿä¿¡æ¯SELECT bo.* FROM boys bo WHEREbo.`id` NOT IN(SELECT boyfriend_id FROM beauty); 5ï¼‰å­æŸ¥è¯¢ç»å…¸æ¡ˆä¾‹ç¥¥è®²1234567891011121314151617181920212223242526272829303132331.æŸ¥è¯¢å·¥èµ„æœ€ä½çš„å‘˜å·¥ä¿¡æ¯ï¼šlast_name,salarySELECT last_name,salary FROM employeesWHERE salary=(SELECT MIN(salary) FROM employees);2.æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€ä½çš„éƒ¨é—¨ä¿¡æ¯SELECT * FROM departments WHERE department_id=(SELECT department_id FROM employees GROUP BY department_id ORDER BY AVG(salary)LIMIT 1)3.æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€ä½çš„éƒ¨é—¨ä¿¡æ¯å’Œè¯¥éƒ¨é—¨çš„å¹³å‡å·¥èµ„SELECT d.*,a1.ag FROM departments d JOIN (SELECT AVG(salary) ag,department_id FROM employees GROUP BY department_id ORDER BY AVG(salary)LIMIT 1) a1ON d.department_id=a1.department_id4.æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€é«˜çš„jobä¿¡æ¯SELECT j.* FROM jobs j WHERE j.job_id=(SELECT job_id FROM employeesGROUP BY job_id ORDER BY AVG(salary) DESC LIMIT 1)5.æŸ¥è¯¢å¹³å‡å·¥èµ„é«˜äºå…¬å¸å¹³å‡å·¥èµ„çš„éƒ¨é—¨æœ‰å“ªäº›SELECT department_id FROM (SELECT department_id ,AVG(salary) AS avg1 FROM employees GROUP BY department_id) e1WHERE e1.avg1&gt;(SELECT AVG(salary) AS avg2 FROM employees) 6.æŸ¥è¯¢å‡ºå…¬å¸ä¸­æ‰€æœ‰managerçš„è¯¦ç»†ä¿¡æ¯SELECT * FROM employeesWHERE employee_id IN(SELECT DISTINCT manager_id FROM employees);7.å„ä¸ªéƒ¨é—¨ä¸­ï¼Œæœ€é«˜å·¥èµ„ä¸­æœ€ä½çš„é‚£ä¸ªéƒ¨é—¨çš„æœ€ä½å·¥èµ„æ˜¯å¤šå°‘SELECT MIN(salary) FROM employees GROUP BY department_idHAVING department_id=(SELECT department_id FROM employees GROUP BY department_id ORDER BY MAX(salary)LIMIT 1)8.æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€é«˜çš„éƒ¨é—¨çš„managerçš„è¯¦ç»†ä¿¡æ¯ï¼šlast_name,department_id,email,salarySELECT last_name,department_id,email,salary FROM employees WHERE employee_id=(SELECT manager_id FROM departments WHERE department_id=(SELECT department_id FROM employees GROUP BY department_id ORDER BY AVG(salary)DESC LIMIT 1)) 8.åˆ†é¡µæŸ¥è¯¢**è¯­æ³•ï¼šlimit(currentPage-1)size,size 123456789#æŸ¥è¯¢å‰äº”æ¡å‘˜å·¥ä¿¡æ¯SELECT * FROM employees LIMIT 0,5;#æŸ¥è¯¢ç¬¬11-25æ¡å‘˜å·¥ä¿¡æ¯SELECT * FROM employees LIMIT 10,15;#æŸ¥è¯¢æœ‰å¥–é‡‘çš„å‘˜å·¥ï¼Œå¹¶ä¸”å·¥èµ„æœ€é«˜çš„å‰ååæ˜¾ç¤ºå‡ºæ¥SELECT * FROM employeesWHERE commission_pct IS NOT NULLORDER BY salary DESC LIMIT 0 ,10; 9.è”åˆæŸ¥è¯¢è¦æŸ¥è¯¢çš„ç»“æœæ¥è‡ªäºå¤šä¸ªè¡¨ï¼Œä¸”å¤šä¸ªè¡¨æ²¡æœ‰ç›´æ¥çš„è¿æ¥å…³ç³»ï¼Œå•æŸ¥è¯¢çš„ä¿¡æ¯ä¸€è‡´æ—¶ç‰¹ç‚¹ï¼š1.è¦æ±‚å¤šæ¡æŸ¥è¯¢è¯­å¥çš„æŸ¥è¯¢åˆ—æ•°æ˜¯ä¸€è‡´çš„2.è¦æ±‚å¤šæ¡æŸ¥è¯¢è¯­å¥çš„æŸ¥è¯¢çš„æ¯ä¸€åˆ—çš„ç±»å‹å’Œé¡ºåºæœ€å¥½ä¸€è‡´3.unionå…³é”®å­—é»˜è®¤å»é‡ï¼Œå¦‚æœä½¿ç”¨union all å¯ä»¥ä¸å»é™¤é‡å¤é¡¹ 1234æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥éƒ¨é—¨ç¼–å·å¤§äº90æˆ–é‚®ç®±åŒ…å«açš„å‘˜å·¥ä¿¡æ¯SELECT * FROM employees WHERE department_id&gt;90UNIONSELECT * FROM employees WHERE email LIKE &#x27;%a%&#x27;; ä¸‰ï¼ŒDMLæ•°æ®æ“ä½œè¯­è¨€æ’å…¥insert 1234567891011121314151617ä¸€ï¼šæ’å…¥è¯­å¥#æ’å…¥beautyä¸€è¡Œæ•°æ®INSERT INTO beauty(NAME,sex,borndate,phone,photo,boyfriend_id)VALUES(&#x27;æ³¢å¤šé‡å‰ä¾&#x27;,&#x27;å¥³&#x27;,&#x27;1998-11-11&#x27;,&#x27;13342969497&#x27;,NULL,10)#å¯ä»¥ä¸ºnullçš„åˆ—å¦‚ä½•ä¸æ’å…¥å€¼ç›´æ¥å†™nullï¼Œæˆ–åˆ—åå°‘å†™ä¸€åˆ—INSERT INTO beauty(NAME,sex,borndate,phone,photo,boyfriend_id)VALUES(&#x27;å°æ³½ç›åˆ©äºš&#x27;,&#x27;å¥³&#x27;,&#x27;1999-11-11&#x27;,&#x27;13342456497&#x27;,NULL,11)INSERT INTO beauty VALUES(15,&#x27;é©¬è“‰&#x27;,&#x27;å¥³&#x27;,&#x27;1989-11-11&#x27;,&#x27;13342456123&#x27;,NULL,12);INSERT INTO beauty SET id=16,NAME=&#x27;åˆ˜äº¦è²&#x27;, sex=&#x27;å¥³&#x27;,borndate=&#x27;1989-10-01&#x27;,phone=&#x27;15945231056&#x27;,boyfriend_id=16;#insert åµŒå¥—å­æŸ¥è¯¢ï¼Œå°†ä¸€ä¸ªè¡¨çš„æ•°æ®æ’å…¥å¦ä¸€å¼ è¡¨INSERT INTO beauty (NAME,sex,borndate,phone,boyfriend_id)SELECT &#x27;å¦²å·±&#x27;,&#x27;å¥³&#x27;,&#x27;1111-11-11&#x27;,&#x27;13146587954&#x27;,0; ä¿®æ”¹update 1234567891011121314151617181920äºŒï¼Œä¿®æ”¹ UPDATE beauty SET phone=&#x27;110&#x27; WHERE id=16;å¤šè¡¨ä¿®æ”¹ï¼šsql99UPDATE è¡¨1 åˆ«åINNER|LEFT|RIGHT JOIN è¡¨2 åˆ«åON è¿æ¥æ¡ä»¶SET åˆ—=å€¼WHERE ç­›é€‰æ¡ä»¶#ä¿®æ”¹å¼ æ— å¿Œçš„å¥³æœ‹å‹æ‰‹æœºå·ä¸º114UPDATE beauty gINNER JOIN boys bON g.boyfriend_id=b.idSET g.phone=&#x27;114&#x27;WHERE b.boyName=&#x27;å¼ æ— å¿Œ&#x27;;#ä¿®æ”¹æ²¡æœ‰ç”·æœ‹å‹çš„å¥³ç”Ÿçš„ç”·æœ‹å‹ç¼–å·éƒ½ä¸º4å·UPDATE beauty gLEFT JOIN boys bON g.`boyfriend_id`=b.idSET g.`boyfriend_id`=4WHERE b.id=NULL; åˆ é™¤delete 1234567891011121314151617181920212223ä¸‰ï¼Œåˆ é™¤DELETE å’Œ TRUNCATE çš„åŒºåˆ«ï¼š1.deleteå¯ä»¥åŠ whereæ¡ä»¶ï¼Œtruncateä¸è¡Œ2.truncateåˆ é™¤æ•ˆç‡é«˜3.åŠ å…¥è¦åˆ é™¤çš„è¡¨ä¸­æœ‰è‡ªå¢åˆ—ï¼Œç”¨deleteåˆ é™¤æ•´ä¸ªè¡¨ååœ¨æ’å…¥æ•°æ®ï¼Œä»æ–­ç‚¹å¤„å¼€å§‹æ’å…¥ç”¨truncateåˆ é™¤ååœ¨æ’å…¥æ•°æ®ï¼Œä»1å¼€å§‹ã€‚4.truncateåˆ é™¤æ²¡æœ‰è¿”å›å€¼ï¼Œdeleteæœ‰è¿”å›å€¼5.truncateåˆ é™¤ä¸èƒ½å›æ»šï¼Œdeleteåˆ é™¤å¯ä»¥å›æ»šDELETE FROM beauty WHERE id=17;è¯­æ³•ï¼štruncate TABLE è¡¨å;#åˆ é™¤å¼ æ— å¿Œçš„å¥³æœ‹å‹çš„ä¿¡æ¯DELETE g FROM beauty gINNER JOIN boys bON g.boyfriend_id=b.idWHERE b.id=1;#åˆ é™¤é»„æ™“æ˜ä»¥åŠä»–å¥³æœ‹å‹çš„ä¿¡æ¯DELETE b,g FROM beauty gINNER JOIN boys bON b.`id`=g.`boyfriend_id`WHERE b.`boyName`=&#x27;é»„æ™“æ˜&#x27;;å¤šè¡¨åˆ é™¤ :TRUNCATETRUNCATE TABLE boys å››ï¼ŒDDLæ•°æ®å®šä¹‰è¯­è¨€1.åº“å’Œè¡¨çš„ç®¡ç†12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849ä¸€ï¼Œåº“çš„ç®¡ç†åˆ›å»º CREATECREATE DATABASE IF NOT EXISTS mydb1 ;ä¿®æ”¹ ALTER1.æ›´æ”¹å­—ç¬¦é›†ALTER DATABASE mydb1 CHARACTER SET utf8;åˆ é™¤ DROPDROP DATABASE IF EXISTS school;äºŒï¼Œè¡¨çš„ç®¡ç†åˆ›å»º CREATECREATE TABLE book(id INT PRIMARY KEY,b_name VARCHAR(30),price DOUBLE,author_id INT ,publishDate DATE);DESC book ;CREATE TABLE author(id INT PRIMARY KEY ,au_name VARCHAR(20),nation VARCHAR(10));DESC author;ä¿®æ”¹ ALTER1.ä¿®æ”¹åˆ—åALTER TABLE book CHANGE COLUMN publishDate pub_date DATETIME;2.ä¿®æ”¹åˆ—çš„ç±»å‹æˆ–çº¦æŸALTER TABLE book MODIFY COLUMN pub_date DATE;3.æ·»åŠ æ–°åˆ—ALTER TABLE author ADD COLUMN annual DOUBLE;4.åˆ é™¤æ–°åˆ—ALTER TABLE author DROP COLUMN annual;5.ä¿®æ”¹è¡¨åALTER TABLE author RENAME TO book_author;åˆ é™¤ DROPDROP TABLE IF EXISTS my_employee;SHOW TABLES;å¤åˆ¶1.ä»…ä»…å¤åˆ¶è¡¨çš„ç»“æ„CREATE TABLE copy LIKE book_author;2.å¤åˆ¶è¡¨çš„ç»“æ„åŠ æ•°æ®CREATE TABLE copy2SELECT * FROM book_author;3.å¤åˆ¶éƒ¨åˆ†ç»“æ„CREATE TABLE copy3 SELECT id,au_nameFROM book_authorWHERE id=0; 2.æ•°æ®ç±»å‹æ•°å€¼å‹1.æ•´å‹ TINYINT SMALLINT MEDIUMINT INT/INTEGER BIGINT 1 2 3 4 8 12345å¦‚ä½•è®¾ç½®æ— ç¬¦å·å’Œæœ‰ç¬¦å·(é»˜è®¤æœ‰ç¬¦å·)DROP TABLE tab_int;CREATE TABLE tab_int(t1 INT,t2 INT UNSIGNED);INSERT INTO tab_int(t1,t2) VALUES(-1,1);DESC tab_int; 1ï¼‰å¦‚æœæ’å…¥çš„æ•°å€¼è¶…å‡ºäº†æ•´å½¢çš„èŒƒå›´ï¼Œä¼šæŠ¥out of rangeå¼‚å¸¸ï¼Œå¹¶ä¸”æ’å…¥ä¸´ç•Œå€¼ã€‚2ï¼‰å¦‚æœä¸è®¾ç½®é•¿åº¦ï¼Œä¼šæœ‰é»˜è®¤çš„é•¿åº¦ã€‚é•¿åº¦ä»£è¡¨äº†æ˜¾ç¤ºçš„æœ€å¤§å®½åº¦ï¼Œå¦‚æœä¸å¤Ÿä¼šç”¨0åœ¨å·¦è¾¹å¡«å……ï¼Œä½†å¿…é¡»æ­é…zerofillä½¿ç”¨ã€‚2.å°æ•°â‘ å®šç‚¹æ•°decï¼ˆM,Dï¼‰â‘¡æµ®ç‚¹æ•°floatï¼ˆ4ï¼‰ ï¼Œdoubleï¼ˆ8ï¼‰Mï¼ŒDçš„æ„æ€ï¼šMæŒ‡å®šä¸€å…±å¤šå°‘ä½ï¼ŒDæŒ‡å®šå°æ•°å‡ ä½ï¼Œè¶…å‡ºä¼šå››èˆäº”å…¥ã€‚MDéƒ½å¯ä»¥çœç•¥ï¼Œå¦‚æœæ˜¯decï¼Œåˆ™Mé»˜è®¤ä¸º10ï¼ŒDé»˜è®¤ä¸º0å¦‚æœæ˜¯æµ®ç‚¹æ•°ï¼Œåˆ™ä¼šæ ¹æ®æ’å…¥æ•°å€¼çš„ç²¾åº¦æ”¹å˜ç²¾åº¦å®šç‚¹å‹ç²¾åº¦ç›¸å¯¹è¾ƒé«˜ã€‚3.å­—ç¬¦å‹â‘ è¾ƒçŸ­çš„æ–‡æœ¬CHAR(M)é»˜è®¤ä¸º1,VARCHAR(M)M:å­—ç¬¦æ•°charï¼šå›ºå®šé•¿åº¦å­—ç¬¦ï¼Œæ¯”è¾ƒè€—è´¹ç©ºé—´ï¼Œä½†æ˜¯æ•ˆç‡é«˜ã€‚varcharï¼šå¯å˜é•¿åº¦å­—ç¬¦ 123456789ENUM æšä¸¾ç±»CREATE TABLE tab_char( t1 ENUM(&#x27;a&#x27;,&#x27;c&#x27;,&#x27;b&#x27;));SET é›†åˆCREATE TABLE tab_set(s1 SET(&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;,&#x27;d&#x27;));INSERT INTO tab_set(s1) VALUES(&#x27;a,b&#x27;); BINARY:ä¿å­˜è¾ƒçŸ­çš„äºŒè¿›åˆ¶ã€‚â‘¡è¾ƒé•¿çš„æ–‡æœ¬textï¼ˆæ–‡æœ¬ï¼‰,BLOB(è¾ƒå¤§çš„äºŒè¿›åˆ¶)4.æ—¥æœŸå‹DATE:æ—¥æœŸDATETIME:æ—¥æœŸåŠ æ—¶é—´ï¼Œ8å­—èŠ‚timestampï¼šè·Ÿæ—¶åŒºæœ‰å…³ç³»ï¼Œå»ºè®®ä½¿ç”¨ï¼Œ4å­—èŠ‚timeï¼šæ—¶é—´yearï¼šå¹´ 123456789CREATE TABLE tab_date(t1 DATETIME,t2 TIMESTAMP);INSERT INTO tab_date(t1,t2)VALUES(NOW(),NOW());SELECT * FROM tab_date;SET time_zone=&#x27;+9:00&#x27;;#è®¾ç½®æ—¶åŒºä¸ºä¸œ9åŒº 3.å¸¸è§çº¦æŸå«ä¹‰ï¼šä¸€ç§é™åˆ¶ï¼Œç”¨äºé™åˆ¶è¡¨ä¸­çš„æ•°æ®ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚ NOT NULL DEFAULT PRIMARY KEY å”¯ä¸€ï¼Œä¸”ä¸ä¸ºç©º UNIQUE å”¯ä¸€ï¼Œå¯ä»¥ä¸ºç©º CHECK Mysqlä¸æ”¯æŒ FOREIGN KEY å¤–é”®çº¦æŸï¼Œç”¨äºé™åˆ¶ä¸¤ä¸ªè¡¨çš„å…³ç³»ï¼Œç”¨äºä¿è¯è¯¥å­—æ®µçš„å€¼å¿…é¡»æ¥è‡ªäºä¸»è¡¨çš„å…³è”åˆ—çš„å€¼ã€‚çº¦æŸçš„åˆ†ç±»ï¼šåˆ—çº§çº¦æŸï¼šé™¤å¤–é”®çº¦æŸè¡¨çº§çº¦æŸï¼šé™¤äº†éç©ºï¼Œé»˜è®¤ã€‚CREATE TABLE è¡¨å(å­—æ®µ1 å­—æ®µç±»å‹ åˆ—çº§çº¦æŸ,å­—æ®µ2 å­—æ®µç±»å‹ åˆ—çº§çº¦æŸ,è¡¨çº§çº¦æŸ); 1234567891011121314151617181920212223242526#åˆ›å»ºè¡¨æ—¶æ·»åŠ åˆ—çº§çº¦æŸDROP TABLE tab_test;CREATE TABLE tab_test(id INT PRIMARY KEY,stu_name VARCHAR(20) NOT NULL,gender CHAR DEFAULT &#x27;ç”·&#x27;,seat_id INT UNIQUE, major_id INT REFERENCES tab_major(id) );CREATE TABLE tab_major(id INT PRIMARY KEY ,major_name VARCHAR(20) NOT NULL);DESC tab_test;SHOW INDEX FROM tab_test;#æŸ¥çœ‹ç´¢å¼•ä¿¡æ¯#æ·»åŠ è¡¨çº§çº¦æŸCREATE TABLE tab_test(id INT PRIMARY KEY AUTO_INCREMENT,stu_name VARCHAR(20) NOT NULL,gender CHAR DEFAULT &#x27;ç”·&#x27;,seat_id INT UNIQUE, major_id INT ,CONSTRAINT m_id FOREIGN KEY(major_id) REFERENCES tab_major(id) );CONSTRAINT m_id å¯ä»¥çœç•¥ é¢è¯•é¢˜ï¼šä¸»é”®çº¦æŸå’Œå”¯ä¸€çº¦æŸçš„åŒºåˆ«ï¼šéƒ½å¯ä»¥ä¿è¯å”¯ä¸€æ€§ï¼Œä¸»é”®ä¸èƒ½ä¸ºç©º ï¼Œunique èƒ½ä¸ºç©ºï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªnullã€‚ä¸»é”®åªèƒ½æœ‰1ä¸ªï¼Œuniqueå¯ä»¥æœ‰å¤šä¸ªã€‚éƒ½å…è®¸ä¸¤ä¸ªåˆ—ç»„åˆæˆä¸€ä¸ªçº¦æŸã€‚é¢è¯•é¢˜ï¼šå¤–é”®ï¼šè¦æ±‚åœ¨ä»è¡¨è®¾ç½®å¤–é”®å…³ç³»ä»è¡¨çš„å¤–é”®åˆ—ç±»å‹å’Œä¸»è¡¨çš„å…³è”åˆ—ç±»å‹ä¸€è‡´ï¼Œåç§°æ— è¦æ±‚è¦æ±‚ä¸»è¡¨çš„å…³è”åˆ—å¿…é¡»æ˜¯ä¸»é”®æˆ–è€…å”¯ä¸€é”®æ’å…¥æ•°æ®åº”è¯¥å…ˆæ’å…¥ä¸»è¡¨å†æ’å…¥ä»è¡¨åˆ é™¤æ•°æ®åº”è¯¥å…ˆåˆ é™¤ä»è¡¨ï¼Œåœ¨åˆ é™¤ä¸»è¡¨äºŒï¼Œä¿®æ”¹è¡¨æ—¶æ·»åŠ çº¦æŸ 1234567891011CREATE TABLE tab_test2(id INT ,stu_name VARCHAR(20) ,gender CHAR ,seat_id INT , major_id INT );ALTER TABLE tab_test2 MODIFY COLUMN stu_name VARCHAR(20) NOT NULL ;ALTER TABLE tab_test2 MODIFY COLUMN id INT PRIMARY KEY AUTO_INCREMENT;#æ·»åŠ å¤–é”®ALTER TABLE tab_test2 ADD FOREIGN KEY(major_id) REFERENCES tab_major(id); 4.æ ‡è¯†åˆ—è‡ªå¢é•¿åˆ— AUTO_INCREMENTç‰¹ç‚¹ï¼š1.è¡¨ç¤ºå¿…é¡»å’Œä¸€ä¸ªkeyæ­é…2.ä¸€ä¸ªè¡¨æœ€å¤šä¸€ä¸ªæ ‡è¯†åˆ—3.æ ‡è¯†åˆ—ç±»å‹åªèƒ½æ˜¯æ•°å€¼å‹4.æ ‡è¯†åˆ—å¯ä»¥é€šè¿‡set auto_increment_increment=3;è®¾ç½®æ­¥é•¿ 1234CREATE tab_auto(id INT PRIMARY KEY AUTO_INCREMENT,NAME VARCHAR(20) NOT NULL); äº”ï¼ŒTCLè¯­è¨€ï¼šäº‹åŠ¡æ§åˆ¶è¯­è¨€äº‹åŠ¡ï¼šä¸€ä¸ªæˆ–ä¸€ç»„sqlè¯­å¥ç»„æˆçš„æ‰§è¡Œå•å…ƒï¼Œ è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œ,è¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚å­˜å‚¨å¼•æ“:åœ¨MySQLä¸­çš„æ•°æ®ç”¨å„ç§ä¸åŒçš„æŠ€æœ¯å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ã€‚é€šè¿‡show ENGINES;æ¥æŸ¥çœ‹mysqlæ”¯æŒçš„å­˜å‚¨å¼•æ“ã€‚innodbå¼•æ“æ”¯æŒäº‹åŠ¡ã€‚äº‹åŠ¡çš„ACIDå±æ€§ï¼š1.åŸå­æ€§:äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œè¦ä¹ˆéƒ½å‘ç”Ÿï¼Œè¦ä¹ˆéƒ½ä¸å‘ç”Ÿã€‚2.ä¸€è‡´æ€§ï¼šäº‹åŠ¡å¿…é¡»ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€å˜ä¸ºå¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚3.éš”ç¦»æ€§ï¼šä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½è¢«å¦ä¸€ä¸ªäº‹åŠ¡å¹²æ‰°ã€‚4.æŒä¹…æ€§ï¼šäº‹åŠ¡ä¸€æ—¦è¢«æäº¤ï¼Œå¯¹æ•°æ®åº“äº‹åŠ¡çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ã€‚ DELETE å’Œ TRUNCATE åœ¨äº‹åŠ¡ä¸­çš„åŒºåˆ«ï¼š 1234567891011æ¼”ç¤ºdeleteSET autocommit=0;START TRANSACTION;DELETE FROM tab_teacher;ROLLBACK;æ¼”ç¤º TRUNCATESET autocommit=0;START TRANSACTION;TRUNCATE TABLE tab_teacher;ROLLBACK;DELETE æ˜¯ç›´æ¥åˆ é™¤è¡¨ä¸­æ•°æ®ï¼Œtruncateæ˜¯æ±Ÿè¡¨åˆ é™¤ï¼Œåˆ›å»ºä¸€å¼ ä¸åŸæ¥ä¸€æ ·çš„ç©ºè¡¨ã€‚ å…­ï¼Œè§†å›¾å«ä¹‰ï¼šè™šæ‹Ÿè¡¨ï¼Œå’Œæ™®é€šè¡¨æ ¼ä¸€æ ·ä½¿ç”¨é€šè¿‡è¡¨åŠ¨æ€ç”Ÿæˆçš„æ•°æ® 1.åˆ›å»ºè§†å›¾è¯­æ³•ï¼šCREATE VIEW è§†å›¾åASæŸ¥è¯¢è¯­å¥ ; 12345678910111213141516171819202122# æ¡ˆä¾‹ï¼šæŸ¥è¯¢å§“åä¸­åŒ…å«aå­—ç¬¦çš„å‘˜å·¥åï¼Œéƒ¨é—¨åå’Œå·¥ç§ä¿¡æ¯create view view1 as select e.last_name,d.department_name ,j.job_title from employees einner join departments d on e.department_id = d.department_id inner join jobs j on e.job_id = j.job_idwhere e.last_name like &#x27;%a%&#x27;;select * from view1;# æ¡ˆä¾‹ï¼šæŸ¥è¯¢å„ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„çº§åˆ«create view view2 asselect j.grade_level ,aa.department_id from job_grades jinner join (select avg(salary) avg_s,department_id from employees group by department_id) aa on aa.avg_s between j.lowest_sal and j.highest_sal;select * from view2;# æ¡ˆä¾‹ï¼šæŸ¥è¯¢å¹³å‡å·¥èµ„æœ€ä½çš„éƒ¨é—¨ä¿¡æ¯create view view3 asselect avg(salary) avg_s ,department_idfrom employeesgroup by department_idorder by avg_s asclimit 1;select * from view3; 2.è§†å›¾ä¿®æ”¹â‘ create OR REPLACE VIEW è§†å›¾å AS æŸ¥è¯¢è¯­å¥;â‘¡alter VIEW è§†å›¾å AS æŸ¥è¯¢è¯­å¥; 3.åˆ é™¤è§†å›¾DROP VIEW v1,v2; 4.æŸ¥çœ‹è§†å›¾DESC v1; 12345678910#åˆ›å»ºè§†å›¾emp_v1ï¼Œè¦æ±‚æŸ¥è¯¢ç”µè¯å·ç ä»¥011å¼€å¤´çš„å‘˜å·¥å§“åå’Œå·¥èµ„ï¼Œé‚®ç®±CREATE VIEW emp_v1 ASSELECT last_name ,salary,email FROM employees WHEREphone_number LIKE &#x27;%011&#x27;;#åˆ›å»ºè§†å›¾emp_v2,è¦æ±‚æŸ¥è¯¢éƒ¨é—¨çš„æœ€é«˜å·¥èµ„é«˜äº12000çš„éƒ¨é—¨ä¿¡æ¯CREATE VIEW v4 ASSELECT department_id FROM employees GROUP BY department_idHAVING MAX(salary)&gt; 12000;CREATE VIEW emp_v2 ASSELECT * FROM departments WHERE department_id IN(SELECT * FROM v4); 5.è§†å›¾çš„æ›´æ–°è§†å›¾çš„å¯æ›´æ–°æ€§å’Œè§†å›¾ä¸­æŸ¥è¯¢çš„å®šä¹‰æœ‰å…³ï¼Œä»¥ä¸‹ç±»å‹çš„è§†å›¾æ˜¯ä¸èƒ½æ›´æ–°çš„ã€‚1.åŒ…å«ä»¥ä¸‹å…³é”®å­—çš„sqlè¯­å¥ï¼šåˆ†ç»„å‡½æ•°ï¼Œdistinctï¼Œgroup byï¼Œhavingï¼Œunion2.å¸¸é‡è§†å›¾3.selectä¸­åŒ…å«å­æŸ¥è¯¢çš„4.join5.from ä¸€ä¸ªä¸èƒ½æ›´æ–°çš„è§†å›¾6.whereå­å¥çš„å­æŸ¥è¯¢å¼•ç”¨äº†fromå­å¥çš„è¡¨ 6.è§†å›¾å’Œè¡¨çš„å¯¹æ¯”ï¼š åˆ›å»ºè¯­æ³•çš„å…³é”®å­— æ˜¯å¦å®é™…å ç”¨ç‰©ç†ç©ºé—´ ä½¿ç”¨ è§†å›¾ CREATE VIEW åªæ˜¯ä¿å­˜äº†sqlé€»è¾‘ å¢åˆ æ”¹æŸ¥ï¼Œä¸€èˆ¬ä¸èƒ½å¢åˆ æ”¹ è¡¨ CREATE TABLE å ç”¨ å¢åˆ æ”¹æŸ¥ ä¸ƒï¼Œå˜é‡ç³»ç»Ÿå˜é‡ ï¼šå˜é‡ç”±ç³»ç»Ÿæä¾›ï¼Œä¸æ˜¯ç”¨æˆ·è‡ªå®šä¹‰ï¼Œå±äºæœåŠ¡å™¨å±‚é¢ã€‚æŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰å˜é‡ï¼šshow GLOBAL VARIABLES;æŸ¥çœ‹æ»¡è¶³æ¡ä»¶çš„éƒ¨åˆ†ç³»ç»Ÿå˜é‡ï¼š SHOW GLOBAL VARIABLES LIKE â€˜%char%â€™;æŸ¥çœ‹æŒ‡å®šçš„æŸä¸ªç³»ç»Ÿå˜é‡çš„å€¼ï¼š SELECT @@global.autocommit;ä¸ºæŸä¸ªç³»ç»Ÿå˜é‡èµ‹å€¼ï¼šset @@global.ç³»ç»Ÿå˜é‡å=å€¼;å…¨å±€å˜é‡:GLOBALä½œç”¨åŸŸï¼šæœåŠ¡å™¨æ¯æ¬¡å¯åŠ¨å°†ä¸ºæ‰€æœ‰çš„å…¨å±€å˜é‡èµ‹åˆå§‹å€¼ï¼Œé’ˆå¯¹äºæ‰€æœ‰çš„ä¼šè¯æœ‰æ•ˆï¼Œä½†ä¸èƒ½è·¨é‡å¯ã€‚ä¼šè¯å˜é‡:SESSIONä½œç”¨åŸŸï¼šé’ˆå¯¹å½“å‰çš„ä¼šè¯æœ‰æ•ˆã€‚ç”¨æˆ·è‡ªå®šä¹‰å˜é‡ç”¨æˆ·å˜é‡å£°æ˜ï¼š SET/SELECT @ç”¨æˆ·å˜é‡å :=å€¼;èµ‹å€¼ï¼šé€šè¿‡ SELECT å­—æ®µ INTO å˜é‡å;æˆ– SET/SELECT @ç”¨æˆ·å˜é‡å :=å€¼;ä½¿ç”¨ï¼šselect @ç”¨æˆ·å˜é‡å;åº”ç”¨åœ¨ä»»ä½•åœ°æ–¹ã€‚ä½œç”¨åŸŸï¼šé’ˆå¯¹å½“å‰ä¼šè¯å’Œè¿æ¥æœ‰æ•ˆã€‚å±€éƒ¨å˜é‡ä½œç”¨åŸŸï¼šä½œç”¨åœ¨å®šä¹‰å®ƒçš„begin END å—ä¸­ã€‚å£°æ˜ï¼š DECLARE å˜é‡å ç±»å‹ ï¼ˆdefault å€¼ï¼‰;èµ‹å€¼ï¼šé€šè¿‡ SELECT å­—æ®µ INTO å˜é‡å;æˆ– SET/SELECT @å˜é‡å :=å€¼;ä½¿ç”¨ï¼šselect @å˜é‡å;åªèƒ½æ”¾åœ¨begin END ä¸­çš„ç¬¬ä¸€å¥è¯ å…«ï¼Œå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°å­˜å‚¨è¿‡ç¨‹ï¼šä¸€ç»„é¢„å…ˆå®šä¹‰å¥½çš„sqlè¯­å¥é›†åˆï¼Œç†è§£æˆæ‰¹å¤„ç†è¯­å¥ã€‚1.æé«˜ä»£ç çš„é‡ç”¨æ€§2.ç®€åŒ–æ“ä½œ3.å‡å°‘äº†ç¼–è¯‘æ¬¡æ•°å¹¶ä¸”å‡å°‘äº†å’Œæ•°æ®åº“æœåŠ¡å™¨çš„è¿æ¥æ¬¡æ•°ï¼Œæé«˜äº†æ•ˆç‡ã€‚ 1.åˆ›å»ºè¯­æ³•ï¼šCREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹åï¼ˆå‚æ•°åˆ—è¡¨ï¼‰BEGINä¸€ç»„åˆæ³•çš„sqlè¯­å¥;ENDå‚æ•°åˆ—è¡¨ï¼šå‚æ•°æ¨¡å¼ å‚æ•°å å‚æ•°ç±»å‹ å‚æ•°æ¨¡å¼ï¼šinï¼šè¯¥å‚æ•°å¯ä»¥ä½œä¸ºè¾“å…¥ï¼Œä¹Ÿå°±æ˜¯è¯¥å‚æ•°éœ€è¦è°ƒç”¨æ–¹ä¼ å…¥å€¼OUT ï¼šè¯¥å‚æ•°å¯ä»¥ä½œä¸ºè¾“å‡ºï¼Œä¹Ÿå°±æ˜¯è¯¥å‚æ•°å¯ä»¥ä½œä¸ºè¿”å›å€¼inoutï¼šè¯¥å‚æ•°æ—¢å¯ä»¥ä½œä¸ºè¾“å…¥åˆå¯ä»¥ä½œä¸ºè¾“å‡º å¦‚æœå­˜å‚¨è¿‡ç¨‹åªæœ‰ä¸€å¥è¯ï¼Œbegin END å¯ä»¥çœç•¥ å­˜å‚¨è¿‡ç¨‹ä½“ä¸­çš„æ¯æ¡sqlè¯­å¥çš„ç»“å°¾éœ€è¦å¿…é¡»åŠ åˆ†å·ï¼Œå­˜å‚¨è¿‡ç¨‹çš„ç»“å°¾å¯ä»¥ä½¿ç”¨ DELIMITER é‡æ–°è®¾ç½®ã€‚ 2.è°ƒç”¨CALL å­˜å‚¨è¿‡ç¨‹åï¼ˆå®å‚åˆ—è¡¨ï¼‰; 3.æ¡ˆä¾‹1234567891011121314151617181920212223242526272829303132333435363738394041424344#æ’å…¥åˆ°adminè¡¨ä¸­äº”æ¡è®°å½•DELIMITER $CREATE PROCEDURE my_a()BEGININSERT INTO admin(username,PASSWORD) VALUES(&#x27;yin&#x27;,&#x27;666&#x27;);INSERT INTO admin(username,PASSWORD) VALUES(&#x27;aa&#x27;,&#x27;123&#x27;);INSERT INTO admin(username,PASSWORD) VALUES(&#x27;bb&#x27;,&#x27;666&#x27;);INSERT INTO admin(username,PASSWORD) VALUES(&#x27;cc&#x27;,&#x27;123&#x27;);INSERT INTO admin(username,PASSWORD) VALUES(&#x27;dd&#x27;,&#x27;666&#x27;);END $#åˆ›å»ºå­˜å‚¨è¿‡ç¨‹å®ç° æ ¹æ®å¥³ç”ŸåæŸ¥è¯¢å¯¹åº”çš„ç”·ç”Ÿä¿¡æ¯DELIMITER $CREATE PROCEDURE my_b(IN beauty_name VARCHAR(20))BEGIN SELECT bo.* FROM boys bo RIGHT JOIN beauty b ON bo.id=b.boyfriend_id WHERE b.name=beauty_name;END $CALL my_b(&#x27;çƒ­å·´&#x27;);#æ ¹æ®å¥³ç”Ÿåè¿”å›ä»–çš„ç”·æœ‹å‹åDELIMITER $CREATE PROCEDURE my_d(IN beautyName VARCHAR(20),OUT boyName VARCHAR(20))BEGIN SELECT bo.boyName INTO boyName FROM boys bo INNER JOIN beauty b ON bo.id=b.boyfriend_id WHERE b.name=beautyName;END $CALL my_d(&#x27;å°æ˜­&#x27;,@b_name);SELECT @b_name;#ä¼ å…¥ä¸¤ä¸ªå€¼aï¼Œbï¼Œæœ€ç»ˆç¿»å€è¿”å›aå’ŒbDELIMITER $CREATE PROCEDURE my_e(INOUT a INT ,INOUT b INT )BEGIN SET a=a*2; SET b=b*2;END $SET @m=10;SET @n=20;CALL my_e(@m,@n);SELECT @m,@n; 4.åˆ é™¤å­˜å‚¨è¿‡ç¨‹12DROP PROCEDURE å­˜å‚¨è¿‡ç¨‹åDROP PROCEDURE my_a; 5.æŸ¥çœ‹å­˜å‚¨è¿‡ç¨‹çš„ä¿¡æ¯1SHOW CREATE PROCEDURE my_b; å‡½æ•°å­˜å‚¨è¿‡ç¨‹å¯ä»¥æœ‰0/nä¸ªè¿”å›å€¼ï¼šé€‚åˆæ‰¹é‡å¢åˆ æ”¹å‡½æ•°æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªè¿”å›å€¼ï¼šé€‚åˆæŸ¥è¯¢ 1.åˆ›å»º12345DELIMITER $CREATE FUNCTION å‡½æ•°å(å‚æ•°åˆ—è¡¨) RETURNS è¿”å›ç±»å‹BEGINEND æ³¨æ„ï¼šå‚æ•°åˆ—è¡¨ï¼šå‚æ•°åï¼Œå‚æ•°ç±»å‹ä¸€å®šä¼šæœ‰returnè¯­å¥ 2.ä½¿ç”¨SELECT å‡½æ•°å(å‚æ•°åˆ—è¡¨) 12345678910111213141516171819#è¿”å›å…¬å¸å‘˜å·¥ä¸ªæ•°DELIMITER $CREATE FUNCTION my_f1() RETURNS INTBEGINDECLARE c INT DEFAULT 0 ; SELECT COUNT(*) INTO c FROM employees; RETURN c;END $SELECT my_f1();#æ ¹æ®å‘˜å·¥åè¿”å›ä»–çš„å·¥èµ„DELIMITER $CREATE FUNCTION my_f2(NAME VARCHAR(20)) RETURNS DOUBLEBEGIN DECLARE c DOUBLE; SELECT salary INTO c FROM employees WHERE last_name=NAME; RETURN c;END $SET @a=&#x27;Hunold&#x27;;SELECT my_f2(@a); 3.æŸ¥çœ‹1SHOW CREATE FUNCTION my_f2; 4.åˆ é™¤1DROP FUNCTION my_f2; ä¹ï¼Œæµç¨‹æ§åˆ¶åˆ†æ”¯ç»“æ„1.if ï¼ˆè¡¨è¾¾å¼1ï¼Œè¡¨è¾¾å¼2ï¼Œè¡¨è¾¾å¼3ï¼‰å¦‚æœè¡¨è¾¾å¼1æˆç«‹ï¼Œå°±è¿”å›è¡¨è¾¾å¼2çš„å€¼ï¼Œå¦åˆ™è¿”å›è¡¨è¾¾å¼3çš„å€¼ã€‚åº”ç”¨åœ¨ä»»ä½•åœ°æ–¹ 2.case1)switch-CASEè¯­æ³•:CASE è¦åˆ¤æ–­çš„å­—æ®µæˆ–è€…è¡¨è¾¾å¼WHEN å¸¸é‡1 THEN è¦æ˜¾ç¤ºçš„å€¼1æˆ–è€…è¯­å¥1WHEN å¸¸é‡2 THEN è¦æ˜¾ç¤ºçš„å€¼2æˆ–è€…è¯­å¥2â€¦ELSE è¦æ˜¾ç¤ºçš„å€¼næˆ–è€…è¯­å¥nï¼› 1234567891011121314151617181920æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥çš„å·¥èµ„ï¼Œè¦æ±‚éƒ¨é—¨å·==30ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.1å€ï¼Œéƒ¨é—¨å·==40ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.2å€ï¼Œéƒ¨é—¨å·==50ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.3å€ï¼Œå…¶ä»–éƒ¨é—¨ï¼Œæ˜¾ç¤ºåŸæœ‰å·¥èµ„ã€‚SELECT salary AS åŸå§‹å·¥èµ„, department_id , CASE department_id WHEN 30 THEN salary * 1.1 WHEN 40 THEN salary * 1.2 WHEN 50 THEN salary * 1.3 ELSE salary END AS æ–°å·¥èµ„ FROM employees ; 2)CASE ä½¿ç”¨2ï¼šè¯­æ³•ï¼šCASEWHEN æ¡ä»¶1 THEN è¦æ˜¾ç¤ºçš„å€¼1æˆ–è¯­å¥1WHEN æ¡ä»¶2 THEN è¦æ˜¾ç¤ºçš„å€¼2æˆ–è¯­å¥2â€¦ELSE è¦æ˜¾ç¤ºçš„å€¼næˆ–è¯­å¥nEND 12345678910111213141516171819202122232425262728293031323334æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥çš„å·¥èµ„æƒ…å†µå¦‚æœ&gt;2wï¼Œæ˜¾ç¤ºAå¦‚æœ&gt;1.5wï¼Œæ˜¾ç¤ºBå¦‚æœ&gt;1wï¼Œæ˜¾ç¤ºCå¦åˆ™ï¼Œæ˜¾ç¤ºDSELECT salary, CASE WHEN salary &gt; 20000 THEN &#x27;A&#x27; WHEN salary &gt; 15000 THEN &#x27;B&#x27; WHEN salary &gt; 10000 THEN &#x27;C&#x27; ELSE &#x27;D&#x27; END AS å·¥èµ„ç­‰çº§ FROM employees å¯ä»¥æ”¾åœ¨ä»»ä½•åœ°æ–¹ #åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ï¼Œæ ¹æ®ä¼ å…¥çš„æˆç»©ï¼Œæ˜¾ç¤ºç­‰çº§ï¼Œ90A,80Bï¼Œ70Cï¼Œ60D ï¼ŒF DELIMITER $ CREATE PROCEDURE my_1(IN score INT) BEGIN CASE WHEN score BETWEEN 90 AND 100 THEN SELECT &#x27;A&#x27;; WHEN score BETWEEN 80 AND 90 THEN SELECT &#x27;B&#x27;; WHEN score BETWEEN 70 AND 80 THEN SELECT &#x27;C&#x27;; WHEN score BETWEEN 70 AND 60 THEN SELECT &#x27;D&#x27;; ELSE SELECT &#x27;E&#x27;; END CASE; END $CALL my_1(95); 3.ifè¯­æ³•ï¼šIF æ¡ä»¶1 THEN è¯­å¥1;ELSEIF æ¡ä»¶2 THEN è¯­å¥2;â€¦ELSE è¯­å¥n;END IF;åªèƒ½ç”¨åœ¨begin endä¸­ 12345678910111213#åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ï¼Œæ ¹æ®ä¼ å…¥çš„æˆç»©ï¼Œè¿”å›ç­‰çº§ï¼Œ90A,80Bï¼Œ70Cï¼Œ60D ï¼ŒFDELIMITER $ CREATE FUNCTION my_2( score INT) RETURNS CHAR BEGIN IF score &gt;=90 THEN RETURN&#x27;A&#x27;; ELSEIF score &gt;=80 THEN RETURN&#x27;B&#x27;; ELSEIF score &gt;=70 THEN RETURN&#x27;C&#x27;; ELSEIF score &gt;=60 THEN RETURN&#x27;D&#x27;; ELSE RETURN&#x27;E&#x27;; END IF; END $ SELECT my_2(85); å¾ªç¯ç»“æ„åœ¨å­˜å‚¨è¿‡ç¨‹æˆ–å‡½æ•°é‡Œé¢ä½¿ç”¨ 1.whileè¯­æ³•ï¼šæ ‡ç­¾:WHILE å¾ªç¯æ¡ä»¶ DOå¾ªç¯ä½“;END WHILE æ ‡ç­¾;å¾ªç¯æ§åˆ¶å’Œæ ‡ç­¾æ­é…ä½¿ç”¨ 2.loopè¯­æ³•ï¼šæ ‡ç­¾ï¼š LOOPå¾ªç¯ä½“;END LOOP æ ‡ç­¾; 3.repeatè¯­æ³•ï¼šæ ‡ç­¾ï¼š REPEATå¾ªç¯ä½“;UNTIL ç»“æŸå¾ªç¯çš„æ¡ä»¶END REPEAT æ ‡ç­¾; å¾ªç¯æ§åˆ¶ITERATE ç±»ä¼¼continueLEAVE ç±»ä¼¼break left join==left outer join a left join b å°±æ˜¯å–aå’Œbçš„äº¤é›†åŠ aå‰©ä¸‹çš„éƒ¨åˆ† inner join a inner join bå°±æ˜¯å–äº¤é›†","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[äºŒ]æ¦‚è¿°","slug":"MySQL/MySQL[äºŒ]æ¦‚è¿°","date":"2022-01-10T13:58:17.078Z","updated":"2022-01-11T03:14:31.883Z","comments":true,"path":"2022/01/10/MySQL/MySQL[äºŒ]æ¦‚è¿°/","link":"","permalink":"https://yinhuidong.github.io/2022/01/10/MySQL/MySQL[%E4%BA%8C]%E6%A6%82%E8%BF%B0/","excerpt":"","text":"ä¸€ï¼Œä¸€æ¡SQLçš„æŸ¥è¯¢æµç¨‹ å»è¿æ¥æ± è·å–è¿æ¥ æŸ¥è¯¢ç¼“å­˜ï¼Œå‘½ä¸­è¿”å›ï¼Œå¦åˆ™ç»§ç»­å‘ä¸‹ è¯æ³•è§£æ&amp;é¢„å¤„ç† è¯æ³•è§£ææ‹†åˆ†SQLï¼Œè¯­æ³•åˆ†ææ£€æŸ¥SQLçš„æ­£ç¡®æ€§ç”Ÿæˆä¸€é¢—è§£ææ ‘ï¼Œé¢„å¤„ç†æ£€æŸ¥è¡¨åï¼Œåˆ—åï¼Œç”Ÿæˆä¸€é¢—è§£ææ ‘ã€‚ ä¼˜åŒ–å™¨ä¼˜åŒ–ï¼Œä¼˜åŒ–è®¡åˆ’ï¼ŒæŸ¥è¯¢è®¡åˆ’ æ‰§è¡Œå¼•æ“ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ å­˜å‚¨å¼•æ“æŸ¥è¯¢SQLï¼ŒåŠ å…¥ç¼“å­˜ï¼Œè¿”å›ç»“æœã€‚ 1.è·å–è¿æ¥MySQLæ”¯æŒå¤šç§é€šä¿¡åè®®ï¼Œå¯ä»¥ä½¿ç”¨åŒæ­¥/å¼‚æ­¥çš„æ–¹å¼ï¼Œæ”¯æŒé•¿è¿æ¥ï¼ŒçŸ­è¿æ¥ã€‚â€‹ 1.1 é€šä¿¡ç±»å‹â€‹ ä¸€èˆ¬æ¥è¯´ï¼Œè¿æ¥æ•°æ®åº“éƒ½æ˜¯åŒæ­¥è¿æ¥ã€‚â€‹ åŒæ­¥è¿æ¥ï¼šä¾èµ–äºè¢«è°ƒç”¨æ–¹ï¼Œå—é™åˆ¶äºè¢«è°ƒç”¨æ–¹çš„æ€§èƒ½ï¼›ä¸€èˆ¬åªèƒ½ä¸€å¯¹ä¸€ã€‚ å¼‚æ­¥è¿æ¥ï¼šé¿å…é˜»å¡ï¼Œä½†ä¸èƒ½èŠ‚çœSQLçš„æ‰§è¡Œæ—¶é—´ï¼Œå¹¶å‘æƒ…å†µä¸‹ï¼Œæ¯ä¸ªSQLçš„æ‰§è¡Œéƒ½è¦å•ç‹¬å»ºç«‹è¿æ¥ï¼Œå ç”¨å¤§é‡CPUèµ„æºï¼›å¼‚æ­¥è¿æ¥å¿…é¡»ä½¿ç”¨è¿æ¥æ± å‡å°‘çº¿ç¨‹åˆ›å»ºé”€æ¯çš„å¼€é”€ã€‚ 1.2 è¿æ¥æ–¹å¼MySQLé•¿çŸ­è¿æ¥éƒ½æ”¯æŒï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šåœ¨è¿æ¥æ± ä¸­ä½¿ç”¨é•¿è¿æ¥ã€‚ä¿æŒé•¿è¿æ¥ä¼šæ¶ˆè€—å†…å­˜ï¼Œé•¿æ—¶é—´ä¸æ´»åŠ¨çš„è¿æ¥ï¼ŒMySQLæœåŠ¡å™¨ä¼šæ–­å¼€ã€‚â€‹ 12show global variables like &#x27;wait_timeout&#x27;; -- éäº¤äº’å¼è¶…æ—¶æ—¶é—´ï¼Œå¦‚ JDBC ç¨‹åºshow global variables like &#x27;interactive_timeout&#x27;; -- äº¤äº’å¼è¶…æ—¶æ—¶é—´ï¼Œå¦‚æ•°æ®åº“å·¥å…· é»˜è®¤é•¿è¿æ¥æ–­å¼€æ—¶é—´æ˜¯8å°æ—¶ã€‚ å¯ä»¥ä½¿ç”¨ show status;æŸ¥çœ‹å½“å‰MySQLæœ‰å¤šå°‘ä¸ªè¿æ¥ã€‚ 1show global status like &#x27;Thread%&#x27;; Threads_cached ç¼“å­˜ä¸­çš„çº¿ç¨‹è¿æ¥æ•° Threads_connected å½“å‰æ‰“å¼€çš„è¿æ¥æ•° Threads_created ä¸ºå¤„ç†è¿æ¥åˆ›å»ºçš„çº¿ç¨‹æ•° Threads_running éç¡çœ çŠ¶æ€çš„è¿æ¥æ•°ï¼Œé€šå¸¸æŒ‡å¹¶å‘è¿æ¥æ•° æ¯äº§ç”Ÿä¸€ä¸ªè¿æ¥æˆ–è€…ä¼šè¯ï¼ŒæœåŠ¡ç«¯å°±ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚æ€æ­»ä¼šè¯æœ¬è´¨å°±æ˜¯kill çº¿ç¨‹ã€‚â€‹ å¯ä»¥ä½¿ç”¨SHOW PROCESSLIST; ï¼ˆroot ç”¨æˆ·ï¼‰æŸ¥çœ‹ SQL çš„æ‰§è¡ŒçŠ¶æ€ã€‚â€‹ +â€”-+â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”â€”+â€”â€”+â€”â€”â€”-+| Id | User | Host | db | Command | Time | State | Info |+â€”-+â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”â€”+â€”â€”+â€”â€”â€”-+| 11 | root | localhost | NULL | Query | 0 | starting | show processlist |+â€”-+â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”â€”+â€”â€”+â€”â€”â€”-+ çŠ¶æ€ å«ä¹‰ Sleep çº¿ç¨‹æ­£åœ¨ç­‰å¾…å®¢æˆ·ç«¯ï¼Œä»¥å‘å®ƒå‘é€ä¸€ä¸ªæ–°è¯­å¥ Query çº¿ç¨‹æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢æˆ–å¾€å®¢æˆ·ç«¯å‘é€æ•°æ® Locked è¯¥æŸ¥è¯¢è¢«å…¶å®ƒæŸ¥è¯¢é”å®š Copying to tmp table on disk ä¸´æ—¶ç»“æœé›†åˆå¤§äº tmp_table_sizeã€‚çº¿ç¨‹æŠŠä¸´æ—¶è¡¨ä»å­˜å‚¨å™¨å†…éƒ¨æ ¼å¼æ”¹å˜ä¸ºç£ç›˜æ¨¡å¼ï¼Œä»¥èŠ‚çº¦å­˜å‚¨å™¨ Sending data çº¿ç¨‹æ­£åœ¨ä¸º SELECT è¯­å¥å¤„ç†è¡Œï¼ŒåŒæ—¶æ­£åœ¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ® Sorting for group çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆ†ç±»ï¼Œä»¥æ»¡è¶³ GROUP BY è¦æ±‚ Sorting for order çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆ†ç±»ï¼Œä»¥æ»¡è¶³ ORDER BY è¦æ±‚ åœ¨5.7ç‰ˆæœ¬ï¼ŒMySQLçš„é»˜è®¤è¿æ¥æ•°æ˜¯151ä¸ªï¼Œæˆ‘ä»¬æœ€å¤§å¯ä»¥ä¿®æ”¹ä¸º16384ä¸ª ï¼ˆ214ï¼‰ã€‚â€‹ 123show variables like &#x27;max_connections&#x27;;set [global | session] max_connections =10000; 1.3 é€šä¿¡åè®®â€‹ ç¼–ç¨‹è¯­è¨€çš„è¿æ¥æ¨¡å—éƒ½æ˜¯ç”¨ TCP åè®®è¿æ¥åˆ° MySQL æœåŠ¡å™¨çš„ï¼Œæ¯”å¦‚mysql-connector-java-x.x.xx.jarã€‚ ç±»unixç³»ç»Ÿä¸Šï¼Œæ”¯æŒ Socketå¥—æ¥å­—æ–‡ä»¶è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ã€‚/tmp/mysql.sock windowsç³»ç»Ÿä¸Šè¿˜æ”¯æŒå‘½åç®¡é“å’Œå…±äº«å†…å­˜ã€‚ â€‹ 1.4 é€šä¿¡æ–¹å¼MySQLä½¿ç”¨äº†åŠåŒå·¥é€šä¿¡ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯å‘é€SQLè¯­å¥ç»™æœåŠ¡ç«¯çš„æ—¶å€™ï¼Œä¸ç®¡SQLæœ‰å¤šå¤§ï¼Œéƒ½æ˜¯ä¸€æ¬¡å‘è¿‡å»çš„ã€‚â€‹ æ¯”å¦‚æˆ‘ä»¬ç”¨MyBatisåŠ¨æ€SQLç”Ÿæˆäº†ä¸€ä¸ªæ‰¹é‡æ’å…¥çš„è¯­å¥ï¼Œæ’å…¥10ä¸‡æ¡æ•°æ®ï¼Œvaluesåé¢è·Ÿäº†ä¸€é•¿ä¸²çš„å†…å®¹ï¼Œæˆ–è€… where æ¡ä»¶ in é‡Œé¢çš„å€¼å¤ªå¤šï¼Œä¼šå‡ºç°é—®é¢˜ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¿…é¡»è¦è°ƒæ•´ MySQL æœåŠ¡å™¨é…ç½® max_allowed_packet å‚æ•°çš„å€¼ï¼ˆé»˜è®¤æ˜¯ 4Mï¼‰ï¼ŒæŠŠå®ƒè°ƒå¤§ï¼Œå¦åˆ™å°±ä¼šæŠ¥é”™ã€‚ å¯¹äºæœåŠ¡ç«¯æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€æ¬¡æ€§å‘é€æ‰€æœ‰çš„æ•°æ®ï¼Œä¸èƒ½å› ä¸ºä½ å·²ç»å–åˆ°äº†æƒ³è¦çš„æ•°æ®å°±ä¸­æ–­æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™ä¼šå¯¹ç½‘ç»œå’Œå†…å­˜äº§ç”Ÿå¤§é‡æ¶ˆè€—ã€‚åœ¨ç¨‹åºé‡Œé¢é¿å…ä¸å¸¦ limit çš„è¿™ç§æ“ä½œï¼Œæ¯”å¦‚ä¸€æ¬¡æŠŠæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„æ•°æ®å…¨éƒ¨æŸ¥å‡ºæ¥ï¼Œä¸€å®šè¦å…ˆ count ä¸€ä¸‹ã€‚å¦‚æœæ•°æ®é‡çš„è¯ï¼Œå¯ä»¥åˆ†æ‰¹æŸ¥è¯¢ã€‚ 2.æŸ¥è¯¢ç¼“å­˜MySQL çš„ç¼“å­˜é»˜è®¤æ˜¯å…³é—­çš„ã€‚â€‹ 1show variables like &#x27;query_cache%&#x27;; MySQLä¸æ¨èä½¿ç”¨è‡ªå¸¦çš„ç¼“å­˜ï¼Œå‘½ä¸­æ¡ä»¶è¿‡äºè‹›åˆ»ã€‚ä¸”è¡¨é‡Œæ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ•´å¼ è¡¨çš„ç¼“å­˜å…¨éƒ¨å¤±æ•ˆï¼ŒMySQL8ç§»é™¤æ‰äº†ç¼“å­˜ã€‚ 3.è¯­æ³•è§£æ&amp;é¢„å¤„ç†3.1 è¯æ³•è§£æè¯æ³•åˆ†æå°±æ˜¯æŠŠä¸€ä¸ªå®Œæ•´çš„ SQL è¯­å¥æ‰“ç¢æˆä¸€ä¸ªä¸ªçš„å•è¯ã€‚â€‹ 1select name from user where id =1; å®ƒä¼šæ‰“ç¢æˆ 8 ä¸ªç¬¦å·ï¼Œæ¯ä¸ªç¬¦å·æ˜¯ä»€ä¹ˆç±»å‹ï¼Œä»å“ªé‡Œå¼€å§‹åˆ°å“ªé‡Œç»“æŸã€‚â€‹ 3.2 è¯­æ³•è§£æè¯­æ³•åˆ†æä¼šå¯¹ SQL åšä¸€äº›è¯­æ³•æ£€æŸ¥ï¼Œæ¯”å¦‚å•å¼•å·æœ‰æ²¡æœ‰é—­åˆï¼Œç„¶åæ ¹æ® MySQL å®šä¹‰çš„è¯­æ³•è§„åˆ™ï¼Œæ ¹æ® SQL è¯­å¥ç”Ÿæˆä¸€ä¸ªæ•°æ®ç»“æ„ã€‚è¿™ä¸ªæ•°æ®ç»“æ„æˆ‘ä»¬æŠŠå®ƒå«åšè§£ææ ‘ï¼ˆselect_lexï¼‰ã€‚â€‹ ä»»ä½•æ•°æ®åº“çš„ä¸­é—´ä»¶ï¼Œæ¯”å¦‚ Mycatï¼ŒSharding-JDBCï¼ˆç”¨åˆ°äº† Druid Parserï¼‰ï¼Œéƒ½å¿…é¡»è¦æœ‰è¯æ³•å’Œè¯­æ³•åˆ†æåŠŸèƒ½ã€‚ 3.3 é¢„å¤„ç†â€‹ å¦‚æœå†™äº†ä¸€ä¸ªè¯æ³•å’Œè¯­æ³•éƒ½æ­£ç¡®çš„ SQLï¼Œä½†æ˜¯è¡¨åæˆ–è€…å­—æ®µä¸å­˜åœ¨ï¼Œä¼šåœ¨å“ªé‡ŒæŠ¥é”™ï¼Ÿæ˜¯åœ¨æ•°æ®åº“çš„æ‰§è¡Œå±‚è¿˜æ˜¯è§£æå™¨ï¼Ÿâ€‹ å®é™…ä¸Šè¿˜æ˜¯åœ¨è§£æçš„æ—¶å€™æŠ¥é”™ï¼Œè§£æ SQL çš„ç¯èŠ‚é‡Œé¢æœ‰ä¸ªé¢„å¤„ç†å™¨ã€‚å®ƒä¼šæ£€æŸ¥ç”Ÿæˆçš„è§£ææ ‘ï¼Œè§£å†³è§£æå™¨æ— æ³•è§£æçš„è¯­ä¹‰ã€‚æ¯”å¦‚ï¼Œå®ƒä¼šæ£€æŸ¥è¡¨å’Œåˆ—åæ˜¯å¦å­˜åœ¨ï¼Œæ£€æŸ¥åå­—å’Œåˆ«åï¼Œä¿è¯æ²¡æœ‰æ­§ä¹‰ã€‚é¢„å¤„ç†ä¹‹åå¾—åˆ°ä¸€ä¸ªæ–°çš„è§£ææ ‘ã€‚â€‹ 4.æŸ¥è¯¢ä¼˜åŒ–&amp;æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ä¸€æ¡SQLè¯­å¥çš„æ‰§è¡Œæ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä½†æ˜¯æœ€ç»ˆè¿”å›çš„ç»“æœéƒ½æ˜¯ç›¸åŒçš„ã€‚æŸ¥è¯¢ä¼˜åŒ–å™¨çš„ç›®çš„å°±æ˜¯æ ¹æ®è§£ææ ‘ç”Ÿæˆä¸åŒçš„æ‰§è¡Œè®¡åˆ’ï¼ˆExecution Planï¼‰ï¼Œç„¶åé€‰æ‹©ä¸€ç§æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ï¼ŒMySQL é‡Œé¢ä½¿ç”¨çš„æ˜¯åŸºäºå¼€é”€ï¼ˆcostï¼‰çš„ä¼˜åŒ–å™¨ï¼Œé‚£ç§æ‰§è¡Œè®¡åˆ’å¼€é”€æœ€å°ï¼Œå°±ç”¨å“ªç§ã€‚ 12# æŸ¥çœ‹æŸ¥è¯¢çš„å¼€é”€show status like &#x27;Last_query_cost&#x27;; 4.1 ä¼˜åŒ–å™¨çš„ä½œç”¨ å¤šè¡¨è”æŸ¥ï¼Œä»¥å“ªå¼ è¡¨ä¸ºåŸºå‡†è¡¨ ç”¨ä¸ç”¨ç´¢å¼•ï¼Œç”¨å“ªä¸ªç´¢å¼• ã€‚ã€‚ã€‚ã€‚ â€‹ 4.2 ä¼˜åŒ–å™¨æ˜¯æ€ä¹ˆå¾—åˆ°æ‰§è¡Œè®¡åˆ’çš„ é¦–å…ˆæˆ‘ä»¬è¦å¯ç”¨ä¼˜åŒ–å™¨çš„è¿½è¸ªï¼ˆé»˜è®¤æ˜¯å…³é—­çš„ï¼‰ã€‚ å¼€å¯è¿™å¼€å…³æ˜¯ä¼šæ¶ˆè€—æ€§èƒ½çš„ï¼Œå› ä¸ºå®ƒè¦æŠŠä¼˜åŒ–åˆ†æçš„ç»“æœå†™åˆ°è¡¨é‡Œé¢ï¼Œæ‰€ä»¥ä¸è¦è½»æ˜“å¼€å¯ï¼Œæˆ–è€…æŸ¥çœ‹å®Œä¹‹åå…³é—­å®ƒï¼ˆæ”¹æˆ offï¼‰ã€‚ æ¥ç€æ‰§è¡Œä¸€ä¸ª SQL è¯­å¥ï¼Œä¼˜åŒ–å™¨ä¼šç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼š è¿™ä¸ªæ—¶å€™ä¼˜åŒ–å™¨åˆ†æçš„è¿‡ç¨‹å·²ç»è®°å½•åˆ°ç³»ç»Ÿè¡¨é‡Œé¢äº†ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥è¯¢ï¼š å®ƒæ˜¯ä¸€ä¸ª JSON ç±»å‹çš„æ•°æ®ï¼Œä¸»è¦åˆ†æˆä¸‰éƒ¨åˆ†ï¼Œå‡†å¤‡é˜¶æ®µã€ä¼˜åŒ–é˜¶æ®µå’Œæ‰§è¡Œé˜¶æ®µã€‚ expanded_query æ˜¯ä¼˜åŒ–åçš„ SQL è¯­å¥ã€‚ considered_execution_plans é‡Œé¢åˆ—å‡ºäº†æ‰€æœ‰çš„æ‰§è¡Œè®¡åˆ’ã€‚ åˆ†æå®Œè®°å¾—å…³æ‰å®ƒ é€šè¿‡è¿½è¸ªä¼˜åŒ–å™¨ï¼Œå¯ä»¥çœ‹åˆ°ä¼˜åŒ–å™¨å¯¹sqlçš„åˆå§‹ä¼˜åŒ–ï¼Œè¡¨çš„è¯»å–é¡ºåºï¼Œä¸ºä»€ä¹ˆé‡‡ç”¨äº†è¿™ç§è¯»å–é¡ºåºã€‚ä¸ºä»€ä¹ˆé‡‡ç”¨äº†æŸä¸ªç´¢å¼•æˆ–è€…é‡‡ç”¨äº†å…¨è¡¨æŸ¥è¯¢ã€‚ 4.3 ä¼˜åŒ–å™¨å¾—åˆ°çš„ç»“æœâ€‹ ä¼˜åŒ–å™¨æœ€ç»ˆä¼šæŠŠè§£ææ ‘å˜æˆä¸€ä¸ªæŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼ŒæŸ¥è¯¢æ‰§è¡Œè®¡åˆ’æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚ å½“ç„¶ï¼Œè¿™ä¸ªæ‰§è¡Œè®¡åˆ’æ˜¯ä¸æ˜¯ä¸€å®šæ˜¯æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’å‘¢ï¼Ÿä¸ä¸€å®šï¼Œå› ä¸º MySQL ä¹Ÿæœ‰å¯èƒ½è¦†ç›–ä¸åˆ°æ‰€æœ‰çš„æ‰§è¡Œè®¡åˆ’ã€‚â€‹ MySQL æä¾›äº†ä¸€ä¸ªæ‰§è¡Œè®¡åˆ’çš„å·¥å…·ã€‚æˆ‘ä»¬åœ¨ SQL è¯­å¥å‰é¢åŠ ä¸Š EXPLAINï¼Œå°±å¯ä»¥çœ‹åˆ°æ‰§è¡Œè®¡åˆ’çš„ä¿¡æ¯ã€‚â€‹ Explain çš„ç»“æœä¹Ÿä¸ä¸€å®šæœ€ç»ˆæ‰§è¡Œçš„æ–¹å¼ã€‚â€‹ 4.4 é€‰é”™ç´¢å¼•è¿™é‡Œé”™è¯¯å†³å®šåˆ†ä¸¤ç±»ï¼Œç¬¬ä¸€ï¼Œå½»åº•é”™è¯¯ã€‚ç¬¬äºŒï¼ŒåŸºäºæˆæœ¬æœ€ä½ï¼Œä½†æ‰§è¡Œé€Ÿåº¦ä¸æ˜¯æœ€å¿«ã€‚ ç”±äºInnoDBçš„ MVCC åŠŸèƒ½å’Œéšæœºé‡‡æ ·æ–¹å¼ï¼Œé»˜è®¤éšæœºé‡‡å–å‡ ä¸ªæ•°æ®é¡µï¼Œå½“åšæ€»ä½“æ•°æ®ã€‚ä»¥éƒ¨åˆ†ä»£è¡¨æ•´ä½“ï¼Œæœ¬æ¥å°±æœ‰é”™è¯¯çš„é£é™©ã€‚åŠ ä¸Šæ•°æ®ä¸æ–­åœ°æ·»åŠ è¿‡ç¨‹ä¸­ï¼Œç´¢å¼•æ ‘å¯èƒ½ä¼šåˆ†è£‚ï¼Œç»“æœæ›´åŠ ä¸å‡†ç¡®ã€‚ æ‰§è¡Œ ANALYZE TABLE ,å¯ä»¥é‡æ–°æ„å»ºç´¢å¼•ï¼Œä½¿ç´¢å¼•æ ‘ä¸è¿‡äºåˆ†è£‚ã€‚ è°ƒæ•´å‚æ•°ï¼ŒåŠ å¤§InnoDBé‡‡æ ·çš„é¡µæ•°ï¼Œé¡µæ•°è¶Šå¤§è¶Šç²¾ç¡®ï¼Œä½†æ€§èƒ½æ¶ˆè€—æ›´é«˜ã€‚ä¸€èˆ¬ä¸å»ºè®®è¿™ä¹ˆå¹²ã€‚ åœ¨ä¼˜åŒ–é˜¶æ®µï¼Œä¼šå¯¹è¡¨ä¸­æ‰€æœ‰ç´¢å¼•è¿›è¡Œå¯¹æ¯”ï¼Œä¼˜åŒ–å™¨åŸºäºæˆæœ¬çš„åŸå› ï¼Œé€‰æ‹©æˆæœ¬æœ€ä½çš„ç´¢å¼•ï¼Œæ‰€ä»¥ä¼šé”™è¿‡æœ€ä½³ç´¢å¼•ã€‚å¸¦æ¥çš„é—®é¢˜ä¾¿æ˜¯ï¼Œæ‰§è¡Œé€Ÿåº¦å¾ˆæ…¢ã€‚ é€šè¿‡explainæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œç»“åˆsqlæ¡ä»¶æŸ¥çœ‹å¯ä»¥åˆ©ç”¨å“ªäº›ç´¢å¼•ã€‚ ä½¿ç”¨ force index(indexName)å¼ºåˆ¶èµ°æŒ‡å®šç´¢å¼•ã€‚å¼Šç«¯å°±æ˜¯åæœŸè‹¥ç´¢å¼•åå‘ç”Ÿæ”¹å˜ï¼Œæˆ–ç´¢å¼•è¢«åˆ é™¤ï¼Œè¯¥sqlè¯­å¥éœ€è¦è°ƒæ•´ã€‚ 5. å­˜å‚¨å¼•æ“å¾—åˆ°æ‰§è¡Œè®¡åˆ’ä»¥åï¼ŒSQL è¯­å¥æ˜¯ä¸æ˜¯ç»ˆäºå¯ä»¥æ‰§è¡Œäº†ï¼Ÿ ä»é€»è¾‘çš„è§’åº¦æ¥è¯´ï¼Œæˆ‘ä»¬çš„æ•°æ®æ˜¯æ”¾åœ¨å“ªé‡Œçš„ï¼Œæˆ–è€…è¯´æ”¾åœ¨ä¸€ä¸ªä»€ä¹ˆç»“æ„é‡Œé¢ï¼Ÿ æ‰§è¡Œè®¡åˆ’åœ¨å“ªé‡Œæ‰§è¡Œï¼Ÿæ˜¯è°å»æ‰§è¡Œï¼Ÿ è¡¨åœ¨å­˜å‚¨æ•°æ®çš„åŒæ—¶ï¼Œè¿˜è¦ç»„ç»‡æ•°æ®çš„å­˜å‚¨ç»“æ„ï¼Œè¿™ä¸ªå­˜å‚¨ç»“æ„å°±æ˜¯ç”±å­˜å‚¨å¼•æ“å†³å®šçš„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥æŠŠå­˜å‚¨å¼•æ“å«åšè¡¨ç±»å‹ã€‚ åœ¨ MySQL é‡Œé¢ï¼Œæ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œä»–ä»¬æ˜¯å¯ä»¥æ›¿æ¢çš„ï¼Œæ‰€ä»¥å«åšæ’ä»¶å¼çš„å­˜å‚¨å¼•æ“ã€‚â€‹ 5.1 æŸ¥çœ‹å­˜å‚¨å¼•æ“æˆ‘ä»¬æ•°æ®åº“é‡Œé¢å·²ç»å­˜åœ¨çš„è¡¨ï¼Œæˆ‘ä»¬æ€ä¹ˆæŸ¥çœ‹å®ƒä»¬çš„å­˜å‚¨å¼•æ“å‘¢ï¼Ÿâ€‹ 1show table status from `æ•°æ®åº“å`; æˆ–è€…é€šè¿‡ DDL å»ºè¡¨è¯­å¥æ¥æŸ¥çœ‹ã€‚â€‹ åœ¨ MySQL é‡Œé¢ï¼Œæˆ‘ä»¬åˆ›å»ºçš„æ¯ä¸€å¼ è¡¨éƒ½å¯ä»¥æŒ‡å®šå®ƒçš„å­˜å‚¨å¼•æ“ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ•°æ®åº“åªèƒ½ä½¿ç”¨ä¸€ä¸ªå­˜å‚¨å¼•æ“ã€‚å­˜å‚¨å¼•æ“çš„ä½¿ç”¨æ˜¯ä»¥è¡¨ä¸ºå•ä½çš„ã€‚è€Œä¸”ï¼Œåˆ›å»ºè¡¨ä¹‹åè¿˜å¯ä»¥ä¿®æ”¹å­˜å‚¨å¼•æ“ã€‚â€‹ ä¸€å¼ è¡¨ä½¿ç”¨çš„å­˜å‚¨å¼•æ“å†³å®šå­˜å‚¨æ•°æ®çš„ç»“æ„ï¼Œé‚£åœ¨æœåŠ¡å™¨ä¸Šå®ƒä»¬æ˜¯æ€ä¹ˆå­˜å‚¨çš„å‘¢ï¼Ÿå…ˆè¦æ‰¾åˆ°æ•°æ®åº“å­˜æ”¾æ•°æ®çš„è·¯å¾„ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ•°æ®åº“æœ‰ä¸€ä¸ªè‡ªå·±æ–‡ä»¶å¤¹ï¼Œä»¥ yhdæ•°æ®åº“ä¸ºä¾‹ã€‚ä»»ä½•ä¸€ä¸ªå­˜å‚¨å¼•æ“éƒ½æœ‰ä¸€ä¸ª frm æ–‡ä»¶ï¼Œè¿™ä¸ªæ˜¯è¡¨ç»“æ„å®šä¹‰æ–‡ä»¶ã€‚ä¸åŒçš„å­˜å‚¨å¼•æ“å­˜æ”¾æ•°æ®çš„æ–¹å¼ä¸ä¸€æ ·ï¼Œäº§ç”Ÿçš„æ–‡ä»¶ä¹Ÿä¸ä¸€æ ·ï¼Œinnodb æ˜¯ 1 ä¸ªï¼Œmemory æ²¡æœ‰ï¼Œmyisam æ˜¯ä¸¤ä¸ªã€‚ 5.2 å­˜å‚¨å¼•æ“æ¯”è¾ƒâ‘ å¸¸è§å­˜å‚¨å¼•æ“MyISAM å’Œ InnoDB æ˜¯æˆ‘ä»¬ç”¨å¾—æœ€å¤šçš„ä¸¤ä¸ªå­˜å‚¨å¼•æ“ï¼Œåœ¨ MySQL 5.5 ç‰ˆæœ¬ä¹‹å‰ï¼Œé»˜è®¤çš„å­˜å‚¨å¼•æ“æ˜¯ MyISAMï¼Œå®ƒæ˜¯ MySQL è‡ªå¸¦çš„ã€‚ 5.5 ç‰ˆæœ¬ä¹‹åé»˜è®¤çš„å­˜å‚¨å¼•æ“æ”¹æˆäº† InnoDBï¼Œæœ€ä¸»è¦çš„åŸå› è¿˜æ˜¯ InnoDB æ”¯æŒäº‹åŠ¡ï¼Œæ”¯æŒè¡Œçº§åˆ«çš„é”ï¼Œå¯¹äºä¸šåŠ¡ä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯æ¥è¯´æ›´é€‚åˆã€‚ â‘¡æ•°æ®åº“æ”¯æŒçš„å­˜å‚¨å¼•æ“å¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤æŸ¥çœ‹æ•°æ®åº“å¯¹å­˜å‚¨å¼•æ“çš„æ”¯æŒæƒ…å†µï¼š 1show engines ; å…¶ä¸­æœ‰å­˜å‚¨å¼•æ“çš„æè¿°å’Œå¯¹äº‹åŠ¡ã€XA åè®®å’Œ Savepoints çš„æ”¯æŒã€‚ XA åè®®ç”¨æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆåˆ†ä¸ºæœ¬åœ°èµ„æºç®¡ç†å™¨ï¼Œäº‹åŠ¡ç®¡ç†å™¨ï¼‰ã€‚ Savepoints ç”¨æ¥å®ç°å­äº‹åŠ¡ï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰ã€‚åˆ›å»ºäº†ä¸€ä¸ª Savepoints ä¹‹åï¼Œäº‹åŠ¡å°±å¯ä»¥å›æ»šåˆ°è¿™ä¸ªç‚¹ï¼Œä¸ä¼šå½±å“åˆ°åˆ›å»º Savepoints ä¹‹å‰çš„æ“ä½œã€‚ â‘¢MyISAMï¼ˆ3 ä¸ªæ–‡ä»¶ï¼‰åº”ç”¨èŒƒå›´æ¯”è¾ƒå°ã€‚è¡¨çº§é”å®šé™åˆ¶äº†è¯»/å†™çš„æ€§èƒ½ï¼Œå› æ­¤åœ¨ Web å’Œæ•°æ®ä»“åº“é…ç½®ä¸­ï¼Œå®ƒé€šå¸¸ç”¨äºåªè¯»æˆ–ä»¥è¯»ä¸ºä¸»çš„å·¥ä½œã€‚ ç‰¹ç‚¹ æ”¯æŒè¡¨çº§åˆ«çš„é”ï¼ˆæ’å…¥å’Œæ›´æ–°ä¼šé”è¡¨ï¼‰ã€‚ä¸æ”¯æŒäº‹åŠ¡ã€‚ æ‹¥æœ‰è¾ƒé«˜çš„æ’å…¥ï¼ˆinsertï¼‰å’ŒæŸ¥è¯¢ï¼ˆselectï¼‰é€Ÿåº¦ã€‚ å­˜å‚¨äº†è¡¨çš„è¡Œæ•°ï¼ˆcount é€Ÿåº¦æ›´å¿«ï¼‰ã€‚ é€‚åˆï¼šåªè¯»ä¹‹ç±»çš„æ•°æ®åˆ†æçš„é¡¹ç›®ã€‚ â‘£InnoDBï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰mysql 5.7 ä¸­çš„é»˜è®¤å­˜å‚¨å¼•æ“ã€‚InnoDB æ˜¯ä¸€ä¸ªäº‹åŠ¡å®‰å…¨ï¼ˆä¸ ACID å…¼å®¹ï¼‰çš„ MySQLå­˜å‚¨å¼•æ“ï¼Œå®ƒå…·æœ‰æäº¤ã€å›æ»šå’Œå´©æºƒæ¢å¤åŠŸèƒ½æ¥ä¿æŠ¤ç”¨æˆ·æ•°æ®ã€‚InnoDB è¡Œçº§é”ï¼ˆä¸å‡çº§ä¸ºæ›´ç²—ç²’åº¦çš„é”ï¼‰å’Œ Oracle é£æ ¼çš„ä¸€è‡´éé”è¯»æé«˜äº†å¤šç”¨æˆ·å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚InnoDB å°†ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨èšé›†ç´¢å¼•ä¸­ï¼Œä»¥å‡å°‘åŸºäºä¸»é”®çš„å¸¸è§æŸ¥è¯¢çš„ I/Oã€‚ä¸ºäº†ä¿æŒæ•°æ®å®Œæ•´æ€§ï¼ŒInnoDB è¿˜æ”¯æŒå¤–é”®å¼•ç”¨å®Œæ•´æ€§çº¦æŸã€‚ ç‰¹ç‚¹ æ”¯æŒäº‹åŠ¡ï¼Œæ”¯æŒå¤–é”®ï¼Œå› æ­¤æ•°æ®çš„å®Œæ•´æ€§ã€ä¸€è‡´æ€§æ›´é«˜ã€‚ æ”¯æŒè¡Œçº§åˆ«çš„é”å’Œè¡¨çº§åˆ«çš„é”ã€‚ æ”¯æŒè¯»å†™å¹¶å‘ï¼Œå†™ä¸é˜»å¡è¯»ï¼ˆMVCCï¼‰ã€‚ ç‰¹æ®Šçš„ç´¢å¼•å­˜æ”¾æ–¹å¼ï¼Œå¯ä»¥å‡å°‘ IOï¼Œæå‡æŸ¥è¯¢æ•ˆç‡ã€‚ é€‚åˆï¼šç»å¸¸æ›´æ–°çš„è¡¨ï¼Œå­˜åœ¨å¹¶å‘è¯»å†™æˆ–è€…æœ‰äº‹åŠ¡å¤„ç†çš„ä¸šåŠ¡ç³»ç»Ÿã€‚ â‘¤Memory(1ä¸ªæ–‡ä»¶)åŸºäºå†…å­˜çš„å­˜å‚¨å¼•æ“ã€‚ ç‰¹å¾ï¼š åŸºäºå†…å­˜çš„è¡¨ï¼ŒæœåŠ¡å™¨é‡å¯åï¼Œè¡¨ç»“æ„ä¼šè¢«ä¿ç•™ï¼Œä½†è¡¨ä¸­çš„æ•°æ®ä¼šè¢«æ¸…ç©ºã€‚ ä¸éœ€è¦è¿›è¡Œç£ç›˜IOï¼Œæ¯” MYISAM å¿«äº†ä¸€ä¸ªæ•°é‡çº§ã€‚ è¡¨çº§é”ï¼Œæ•…å¹¶å‘æ’å…¥æ€§èƒ½è¾ƒä½ã€‚ æ¯ä¸€è¡Œæ˜¯å›ºå®šçš„ï¼ŒVARCHAR åˆ—åœ¨ memory å­˜å‚¨å¼•æ“ä¸­ä¼šå˜æˆ CHARï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æµªè´¹ã€‚ ä¸æ”¯æŒ BLOB æˆ– TEXT åˆ—ï¼Œå¦‚æœsqlè¿”å›çš„ç»“æœåˆ—ä¸­åŒ…å« BLOB æˆ– TEXTï¼Œå°±ç›´æ¥é‡‡ç”¨ MYISAM å­˜å‚¨å¼•æ“ï¼Œåœ¨ç£ç›˜ä¸Šå»ºä¸´æ—¶è¡¨ æ”¯æŒå“ˆå¸Œç´¢å¼•ï¼ŒB+æ ‘ç´¢å¼• MEMORY å­˜å‚¨å¼•æ“åœ¨å¾ˆå¤šåœ°æ–¹å¯ä»¥å‘æŒ¥å¾ˆå¥½çš„ä½œç”¨ï¼š ç”¨äºæŸ¥æ‰¾æˆ–æ˜ å°„è¡¨ï¼Œä¾‹å¦‚é‚®ç¼–å’Œå·åçš„æ˜ å°„è¡¨ ç”¨äºç¼“å­˜å‘¨æœŸæ€§èšåˆæ•°æ®çš„ç»“æœ ç”¨äºä¿å­˜æ•°æ®åˆ†æä¸­äº§ç”Ÿçš„ä¸­é—´ç»“æœã€‚å³SQLæ‰§è¡Œè¿‡ç¨‹ä¸­ç”¨åˆ°çš„ä¸´æ—¶è¡¨ ç›‘æ§MySQLå†…å­˜ä¸­çš„æ‰§è¡Œæƒ…å†µï¼Œä¾‹å¦‚ï¼šinformation_schema åº“ä¸‹çš„è¡¨åŸºæœ¬éƒ½æ˜¯ memory å­˜å‚¨å¼•æ“ï¼Œç›‘æ§InnoDBç¼“å†²æ± ä¸­page(INNODB_BUFFER_PAGEè¡¨)ï¼ŒInnoDBç¼“å†²æ± çŠ¶æ€(INNODB_BUFFER_POOL_STATSè¡¨)ã€InnoDBç¼“å­˜é¡µæ·˜æ±°è®°å½•(INNODB_BUFFER_PAGE_LRUè¡¨)ã€InnoDBé”ç­‰å¾…(INNODB_LOCK_WAITSè¡¨)ã€InnoDBé”ä¿¡æ¯(INNODB_LOCKSè¡¨)ã€InnoDBä¸­æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡(INNODB_TRXè¡¨)ç­‰ã€‚ MEMORY å­˜å‚¨å¼•æ“é»˜è®¤ hash ç´¢å¼•ï¼Œæ•…ç­‰å€¼æŸ¥è¯¢ç‰¹åˆ«å¿«ã€‚åŒæ—¶ä¹Ÿæ”¯æŒB+æ ‘ç´¢å¼•ã€‚è™½ç„¶æŸ¥è¯¢é€Ÿåº¦ç‰¹åˆ«å¿«ï¼Œä½†ä¾æ—§æ— æ³•å–ä»£ä¼ ç»Ÿçš„ç£ç›˜å»ºè¡¨ã€‚ â‘¥CSV(3ä¸ªæ–‡ä»¶)å®ƒçš„è¡¨å®é™…ä¸Šæ˜¯å¸¦æœ‰é€—å·åˆ†éš”å€¼çš„æ–‡æœ¬æ–‡ä»¶ã€‚csvè¡¨å…è®¸ä»¥csvæ ¼å¼å¯¼å…¥æˆ–è½¬å‚¨æ•°æ®ï¼Œä»¥ä¾¿ä¸è¯»å†™ç›¸åŒæ ¼å¼çš„è„šæœ¬å’Œåº”ç”¨ç¨‹åºäº¤æ¢æ•°æ®ã€‚å› ä¸º csv è¡¨æ²¡æœ‰ç´¢å¼•ï¼Œæ‰€ä»¥é€šå¸¸åœ¨æ­£å¸¸æ“ä½œæœŸé—´å°†æ•°æ®ä¿å­˜åœ¨ innodb è¡¨ä¸­ï¼Œå¹¶ä¸”åªåœ¨å¯¼å…¥æˆ–å¯¼å‡ºé˜¶æ®µä½¿ç”¨ csv è¡¨ã€‚ ç‰¹ç‚¹ ä¸å…è®¸ç©ºè¡Œï¼Œä¸æ”¯æŒç´¢å¼•ã€‚æ ¼å¼é€šç”¨ï¼Œå¯ä»¥ç›´æ¥ç¼–è¾‘ï¼Œé€‚åˆåœ¨ä¸åŒæ•°æ®åº“ä¹‹é—´å¯¼å…¥å¯¼å‡ºã€‚â€‹ 5.3 å¦‚ä½•é€‰æ‹©å­˜å‚¨å¼•æ“ å¦‚æœå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æ¯”è¾ƒé«˜ï¼Œéœ€è¦äº‹åŠ¡æ”¯æŒï¼Œå¯ä»¥é€‰æ‹© InnoDBã€‚ å¦‚æœæ•°æ®æŸ¥è¯¢å¤šæ›´æ–°å°‘ï¼Œå¯¹æŸ¥è¯¢æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¯ä»¥é€‰æ‹© MyISAMã€‚ å¦‚æœéœ€è¦ä¸€ä¸ªç”¨äºæŸ¥è¯¢çš„ä¸´æ—¶è¡¨ï¼Œå¯ä»¥é€‰æ‹© Memoryã€‚ â€‹ 6.æ‰§è¡Œå¼•æ“æ‰§è¡Œå¼•æ“ï¼Œå®ƒåˆ©ç”¨å­˜å‚¨å¼•æ“æä¾›çš„ç›¸åº”çš„ API æ¥å®Œæˆæ“ä½œã€‚ ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¿®æ”¹äº†è¡¨çš„å­˜å‚¨å¼•æ“ï¼Œæ“ä½œæ–¹å¼ä¸éœ€è¦åšä»»ä½•æ”¹å˜ï¼Ÿå› ä¸ºä¸åŒåŠŸèƒ½çš„å­˜å‚¨å¼•æ“å®ç°çš„ API æ˜¯ç›¸åŒçš„ã€‚ æœ€åæŠŠæ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå³ä½¿æ²¡æœ‰ç»“æœä¹Ÿè¦è¿”å›ã€‚â€‹ äºŒï¼Œä¸€æ¡SQLçš„æ›´æ–°æµç¨‹æ›´æ–°å’ŒæŸ¥è¯¢å¾ˆå¤šåœ°æ–¹å¹¶æ²¡æœ‰åŒºåˆ«ï¼Œä»…ä»…åœ¨äºæ‹¿åˆ°æ•°æ®ä¹‹åçš„æ“ä½œã€‚ 1.å†…å­˜ç»“æ„InnnoDB çš„æ•°æ®éƒ½æ˜¯æ”¾åœ¨ç£ç›˜ä¸Šçš„ï¼ŒInnoDB æ“ä½œæ•°æ®æœ‰ä¸€ä¸ªæœ€å°çš„é€»è¾‘å•ä½ï¼Œå«åšé¡µï¼ˆç´¢å¼•é¡µå’Œæ•°æ®é¡µï¼‰ã€‚æˆ‘ä»¬å¯¹äºæ•°æ®çš„æ“ä½œï¼Œä¸æ˜¯æ¯æ¬¡éƒ½ç›´æ¥æ“ä½œç£ç›˜ï¼Œå› ä¸ºç£ç›˜çš„é€Ÿåº¦å¤ªæ…¢äº†ã€‚InnoDB ä½¿ç”¨äº†ä¸€ç§ç¼“å†²æ± çš„æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯æŠŠç£ç›˜è¯»åˆ°çš„é¡µæ”¾åˆ°ä¸€å—å†…å­˜åŒºåŸŸé‡Œé¢ã€‚è¿™ä¸ªå†…å­˜åŒºåŸŸå°±å« Buffer Poolã€‚â€‹ ä¸‹ä¸€æ¬¡è¯»å–ç›¸åŒçš„é¡µï¼Œå…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯åœ¨ç¼“å†²æ± é‡Œé¢ï¼Œå¦‚æœæ˜¯ï¼Œå°±ç›´æ¥è¯»å–ï¼Œä¸ç”¨å†æ¬¡è®¿é—®ç£ç›˜ã€‚ ä¿®æ”¹æ•°æ®çš„æ—¶å€™ï¼Œå…ˆä¿®æ”¹ç¼“å†²æ± é‡Œé¢çš„é¡µã€‚å†…å­˜çš„æ•°æ®é¡µå’Œç£ç›˜æ•°æ®ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŠŠå®ƒå«åšè„é¡µã€‚InnoDB é‡Œé¢æœ‰ä¸“é—¨çš„åå°çº¿ç¨‹æŠŠ Buffer Pool çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±ä¸€æ¬¡æ€§åœ°æŠŠå¤šä¸ªä¿®æ”¹å†™å…¥ç£ç›˜ï¼Œè¿™ä¸ªåŠ¨ä½œå°±å«åšåˆ·è„ã€‚ Buffer Pool æ˜¯ InnoDB é‡Œé¢éå¸¸é‡è¦çš„ä¸€ä¸ªç»“æ„ï¼Œä¸»è¦åˆ†ä¸º 3 ä¸ªéƒ¨åˆ†ï¼š Buffer Poolã€Change Bufferã€Adaptive HashIndexï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ªï¼ˆredoï¼‰log bufferã€‚â€‹ 1.1 buffer poolBuffer Pool ç¼“å­˜çš„æ˜¯é¡µä¿¡æ¯ï¼ŒåŒ…æ‹¬æ•°æ®é¡µã€ç´¢å¼•é¡µï¼Œé»˜è®¤å¤§å°æ˜¯ 128Mï¼ˆ134217728 å­—èŠ‚ï¼‰ï¼Œå¯ä»¥è°ƒæ•´ã€‚ æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€ï¼Œé‡Œé¢æœ‰å¾ˆå¤šè·Ÿ Buffer Pool ç›¸å…³çš„ä¿¡æ¯ï¼š 1SHOW STATUS LIKE &#x27;%innodb_buffer_pool%&#x27;; æŸ¥çœ‹å‚æ•°ï¼ˆç³»ç»Ÿå˜é‡ï¼‰ï¼š 1SHOW VARIABLES like &#x27;%innodb_buffer_pool%&#x27;; å†…å­˜çš„ç¼“å†²æ± å†™æ»¡äº†æ€ä¹ˆåŠï¼Ÿï¼ˆRedis è®¾ç½®çš„å†…å­˜æ»¡äº†æ€ä¹ˆåŠï¼Ÿï¼‰InnoDB ç”¨ LRUç®—æ³•æ¥ç®¡ç†ç¼“å†²æ± ï¼ˆé“¾è¡¨å®ç°ï¼Œä¸æ˜¯ä¼ ç»Ÿçš„ LRUï¼Œåˆ†æˆäº† young å’Œ oldï¼‰ï¼Œç»è¿‡æ·˜æ±°çš„æ•°æ®å°±æ˜¯çƒ­ç‚¹æ•°æ®ã€‚ å†…å­˜ç¼“å†²åŒºå¯¹äºæå‡è¯»å†™æ€§èƒ½æœ‰å¾ˆå¤§çš„ä½œç”¨ã€‚å½“éœ€è¦æ›´æ–°ä¸€ä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœæ•°æ®é¡µåœ¨ Buffer Pool ä¸­å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ç›´æ¥æ›´æ–°å¥½äº†ã€‚å¦åˆ™çš„è¯å°±éœ€è¦ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ï¼Œå†å¯¹å†…å­˜çš„æ•°æ®é¡µè¿›è¡Œæ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­ç¼“å†²æ± ï¼Œè‡³å°‘è¦äº§ç”Ÿä¸€æ¬¡ç£ç›˜ IOã€‚â€‹ 1.2 ChangeBufferå†™ç¼“å†²å¦‚æœè¿™ä¸ªæ•°æ®é¡µä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä¸å­˜åœ¨æ•°æ®é‡å¤çš„æƒ…å†µï¼Œä¹Ÿå°±ä¸éœ€è¦ä»ç£ç›˜åŠ è½½ç´¢å¼•é¡µåˆ¤æ–­æ•°æ®æ˜¯ä¸æ˜¯é‡å¤ï¼ˆå”¯ä¸€æ€§æ£€æŸ¥ï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹å¯ä»¥å…ˆæŠŠä¿®æ”¹è®°å½•åœ¨å†…å­˜çš„ç¼“å†²æ± ä¸­ï¼Œä»è€Œæå‡æ›´æ–°è¯­å¥ï¼ˆInsertã€Deleteã€Updateï¼‰çš„æ‰§è¡Œé€Ÿåº¦ã€‚ è¿™ä¸€å—åŒºåŸŸå°±æ˜¯ Change Bufferã€‚5.5 ä¹‹å‰å« Insert Buffer æ’å…¥ç¼“å†²ï¼Œç°åœ¨ä¹Ÿèƒ½æ”¯æŒ delete å’Œ updateã€‚ æœ€åæŠŠ Change Buffer è®°å½•åˆ°æ•°æ®é¡µçš„æ“ä½œå«åš mergeã€‚ä»€ä¹ˆæ—¶å€™å‘ç”Ÿ mergeï¼Ÿæœ‰å‡ ç§æƒ…å†µï¼šåœ¨è®¿é—®è¿™ä¸ªæ•°æ®é¡µçš„æ—¶å€™ï¼Œæˆ–è€…é€šè¿‡åå°çº¿ç¨‹ã€æˆ–è€…æ•°æ®åº“ shut downã€redo log å†™æ»¡æ—¶è§¦å‘ã€‚ å¦‚æœæ•°æ®åº“å¤§éƒ¨åˆ†ç´¢å¼•éƒ½æ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œå¹¶ä¸”ä¸šåŠ¡æ˜¯å†™å¤šè¯»å°‘ï¼Œä¸ä¼šåœ¨å†™æ•°æ®åç«‹åˆ»è¯»å–ï¼Œå°±å¯ä»¥ä½¿ç”¨ Change Bufferï¼ˆå†™ç¼“å†²ï¼‰ã€‚å†™å¤šè¯»å°‘çš„ä¸šåŠ¡ï¼Œè°ƒå¤§è¿™ä¸ªå€¼ï¼š 1SHOW VARIABLES LIKE &#x27;innodb_change_buffer_max_size&#x27;; ä»£è¡¨ Change Buffer å  Buffer Pool çš„æ¯”ä¾‹ï¼Œé»˜è®¤ 25%ã€‚â€‹ 1.3 Adaptive Hash Indexå½“æˆ‘ä»¬éœ€è¦è®¿é—®æŸä¸ªé¡µä¸­çš„æ•°æ®æ—¶ï¼Œå°±ä¼šæŠŠè¯¥é¡µä»ç£ç›˜åŠ è½½åˆ°Buffer Poolä¸­ï¼Œå¦‚æœè¯¥é¡µå·²ç»åœ¨Buffer Poolä¸­çš„è¯ç›´æ¥ä½¿ç”¨å°±å¯ä»¥äº†ã€‚é‚£ä¹ˆé—®é¢˜ä¹Ÿå°±æ¥äº†ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¯¥é¡µåœ¨ä¸åœ¨Buffer Poolä¸­å‘¢ï¼Ÿ æˆ‘ä»¬å…¶å®æ˜¯æ ¹æ®è¡¨ç©ºé—´å· + é¡µå·æ¥å®šä½ä¸€ä¸ªé¡µçš„ï¼Œä¹Ÿå°±ç›¸å½“äºè¡¨ç©ºé—´å· + é¡µå·æ˜¯ä¸€ä¸ªkeyï¼Œç¼“å­˜é¡µå°±æ˜¯å¯¹åº”çš„valueï¼Œæ€ä¹ˆé€šè¿‡ä¸€ä¸ªkeyæ¥å¿«é€Ÿæ‰¾ç€ä¸€ä¸ªvalueå‘¢ï¼Ÿé‚£è‚¯å®šæ˜¯å“ˆå¸Œè¡¨ã€‚ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨è¡¨ç©ºé—´å· + é¡µå·ä½œä¸ºkeyï¼Œç¼“å­˜é¡µä½œä¸ºvalueåˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œåœ¨éœ€è¦è®¿é—®æŸä¸ªé¡µçš„æ•°æ®æ—¶ï¼Œå…ˆä»å“ˆå¸Œè¡¨ä¸­æ ¹æ®è¡¨ç©ºé—´å· + é¡µå·çœ‹çœ‹æœ‰æ²¡æœ‰å¯¹åº”çš„ç¼“å­˜é¡µï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥ä½¿ç”¨è¯¥ç¼“å­˜é¡µå°±å¥½ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£å°±ä»freeé“¾è¡¨ä¸­é€‰ä¸€ä¸ªç©ºé—²çš„ç¼“å­˜é¡µï¼Œç„¶åæŠŠç£ç›˜ä¸­å¯¹åº”çš„é¡µåŠ è½½åˆ°è¯¥ç¼“å­˜é¡µçš„ä½ç½®ã€‚â€‹ 1.4 ï¼ˆredoï¼‰Log Bufferâ€‹ å¦‚æœ Buffer Pool é‡Œé¢çš„è„é¡µè¿˜æ²¡æœ‰åˆ·å…¥ç£ç›˜æ—¶ï¼Œæ•°æ®åº“å®•æœºæˆ–è€…é‡å¯ï¼Œè¿™äº›æ•°æ®ä¸¢å¤±ã€‚å¦‚æœå†™æ“ä½œå†™åˆ°ä¸€åŠï¼Œç”šè‡³å¯èƒ½ä¼šç ´åæ•°æ®æ–‡ä»¶å¯¼è‡´æ•°æ®åº“ä¸å¯ç”¨ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼ŒInnoDB æŠŠæ‰€æœ‰å¯¹é¡µé¢çš„ä¿®æ”¹æ“ä½œä¸“é—¨å†™å…¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨æ•°æ®åº“å¯åŠ¨æ—¶ä»è¿™ä¸ªæ–‡ä»¶è¿›è¡Œæ¢å¤æ“ä½œï¼ˆå®ç° crash-safeï¼‰â€”â€”ç”¨å®ƒæ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§ã€‚â€‹ è¿™ä¸ªæ–‡ä»¶å°±æ˜¯ç£ç›˜çš„ redo logï¼ˆå«åšé‡åšæ—¥å¿—ï¼‰ï¼Œå¯¹åº”äº/var/lib/mysql/ç›®å½•ä¸‹çš„ib_logfile0 å’Œ ib_logfile1ï¼Œæ¯ä¸ª 48Mã€‚è¿™ ç§ æ—¥ å¿— å’Œ ç£ ç›˜ é… åˆ çš„ æ•´ ä¸ª è¿‡ ç¨‹ ï¼Œ å…¶ å® å°± æ˜¯ MySQL é‡Œ çš„ WAL æŠ€ æœ¯ï¼ˆWrite-Ahead Loggingï¼‰ï¼Œå®ƒçš„å…³é”®ç‚¹å°±æ˜¯å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜ã€‚ 1show variables like &#x27;innodb_log%&#x27;; å€¼ å«ä¹‰ innodb_log_file_size æŒ‡å®šæ¯ä¸ªæ–‡ä»¶çš„å¤§å°ï¼Œé»˜è®¤ 48M innodb_log_files_in_group æŒ‡å®šæ–‡ä»¶çš„æ•°é‡ï¼Œé»˜è®¤ä¸º 2 innodb_log_group_home_dir æŒ‡å®šæ–‡ä»¶æ‰€åœ¨è·¯å¾„ï¼Œç›¸å¯¹æˆ–ç»å¯¹ã€‚å¦‚æœä¸æŒ‡å®šï¼Œåˆ™ä¸ºdatadir è·¯å¾„ã€‚ åŒæ ·æ˜¯å†™ç£ç›˜ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥å†™åˆ° db file é‡Œé¢å»ï¼Ÿä¸ºä»€ä¹ˆå…ˆå†™æ—¥å¿—å†å†™ç£ç›˜ï¼Ÿ ç£ç›˜çš„æœ€å°ç»„æˆå•å…ƒæ˜¯æ‰‡åŒºï¼Œé€šå¸¸æ˜¯ 512 ä¸ªå­—èŠ‚ã€‚æ“ä½œç³»ç»Ÿå’Œå†…å­˜æ‰“äº¤é“ï¼Œæœ€å°çš„å•ä½æ˜¯é¡µ Pageã€‚æ“ä½œç³»ç»Ÿå’Œç£ç›˜æ‰“äº¤é“ï¼Œè¯»å†™ç£ç›˜ï¼Œæœ€å°çš„å•ä½æ˜¯å— Blockã€‚â€‹ å¦‚æœæˆ‘ä»¬æ‰€éœ€è¦çš„æ•°æ®æ˜¯éšæœºåˆ†æ•£åœ¨ä¸åŒé¡µçš„ä¸åŒæ‰‡åŒºä¸­ï¼Œé‚£ä¹ˆæ‰¾åˆ°ç›¸åº”çš„æ•°æ®éœ€è¦ç­‰åˆ°ç£è‡‚æ—‹è½¬åˆ°æŒ‡å®šçš„é¡µï¼Œç„¶åç›˜ç‰‡å¯»æ‰¾åˆ°å¯¹åº”çš„æ‰‡åŒºï¼Œæ‰èƒ½æ‰¾åˆ°æˆ‘ä»¬æ‰€éœ€è¦çš„ä¸€å—æ•°æ®ï¼Œä¾æ¬¡è¿›è¡Œæ­¤è¿‡ç¨‹ç›´åˆ°æ‰¾å®Œæ‰€æœ‰æ•°æ®ï¼Œè¿™ä¸ªå°±æ˜¯éšæœº IOï¼Œè¯»å–æ•°æ®é€Ÿåº¦è¾ƒæ…¢ã€‚ å‡è®¾æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†ç¬¬ä¸€å—æ•°æ®ï¼Œå¹¶ä¸”å…¶ä»–æ‰€éœ€çš„æ•°æ®å°±åœ¨è¿™ä¸€å—æ•°æ®åè¾¹ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦é‡æ–°å¯»å€ï¼Œå¯ä»¥ä¾æ¬¡æ‹¿åˆ°æˆ‘ä»¬æ‰€éœ€çš„æ•°æ®ï¼Œè¿™ä¸ªå°±å«é¡ºåº IOã€‚ åˆ·ç›˜æ˜¯éšæœº I/Oï¼Œè€Œè®°å½•æ—¥å¿—æ˜¯é¡ºåº I/Oï¼Œé¡ºåº I/O æ•ˆç‡æ›´é«˜ã€‚å› æ­¤å…ˆæŠŠä¿®æ”¹å†™å…¥æ—¥å¿—ï¼Œå¯ä»¥å»¶è¿Ÿåˆ·ç›˜æ—¶æœºï¼Œè¿›è€Œæå‡ç³»ç»Ÿååã€‚ å½“ç„¶ redo log ä¹Ÿä¸æ˜¯æ¯ä¸€æ¬¡éƒ½ç›´æ¥å†™å…¥ç£ç›˜ï¼Œåœ¨ Buffer Pool é‡Œé¢æœ‰ä¸€å—å†…å­˜åŒºåŸŸï¼ˆLog Bufferï¼‰ä¸“é—¨ç”¨æ¥ä¿å­˜å³å°†è¦å†™å…¥æ—¥å¿—æ–‡ä»¶çš„æ•°æ®ï¼Œé»˜è®¤ 16Mï¼Œå®ƒä¸€æ ·å¯ä»¥èŠ‚çœç£ç›˜ IOã€‚â€‹ 1SHOW VARIABLES LIKE &#x27;innodb_log_buffer_size&#x27;; redo log çš„å†…å®¹ä¸»è¦æ˜¯ç”¨äºå´©æºƒæ¢å¤ã€‚ç£ç›˜çš„æ•°æ®æ–‡ä»¶ï¼Œæ•°æ®æ¥è‡ª buffer poolã€‚redo log å†™å…¥ç£ç›˜ï¼Œä¸æ˜¯å†™å…¥æ•°æ®æ–‡ä»¶ã€‚ é‚£ä¹ˆï¼ŒLog Buffer ä»€ä¹ˆæ—¶å€™å†™å…¥ log fileï¼Ÿ åœ¨æˆ‘ä»¬å†™å…¥æ•°æ®åˆ°ç£ç›˜çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿæœ¬èº«æ˜¯æœ‰ç¼“å­˜çš„ã€‚flush å°±æ˜¯æŠŠæ“ä½œç³»ç»Ÿç¼“å†²åŒºå†™å…¥åˆ°ç£ç›˜ã€‚ log buffer å†™å…¥ç£ç›˜çš„æ—¶æœºï¼Œç”±ä¸€ä¸ªå‚æ•°æ§åˆ¶ï¼Œé»˜è®¤æ˜¯ 1ã€‚ 1SHOW VARIABLES LIKE &#x27;innodb_flush_log_at_trx_commit&#x27;; å€¼ å«ä¹‰ 0ï¼ˆå»¶è¿Ÿå†™ï¼‰ log buffer å°†æ¯ç§’ä¸€æ¬¡åœ°å†™å…¥ log file ä¸­ï¼Œå¹¶ä¸” log file çš„ flush æ“ä½œåŒæ—¶è¿›è¡Œã€‚è¯¥æ¨¡å¼ä¸‹ï¼Œåœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œä¸ä¼šä¸»åŠ¨è§¦å‘å†™å…¥ç£ç›˜çš„æ“ä½œã€‚ 1ï¼ˆé»˜è®¤ï¼Œå®æ—¶å†™ï¼Œå®æ—¶åˆ·ï¼‰ æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ MySQL éƒ½ä¼šæŠŠ log buffer çš„æ•°æ®å†™å…¥ log fileï¼Œå¹¶ä¸”åˆ·åˆ°ç£ç›˜ä¸­å»ã€‚ 2ï¼ˆå®æ—¶å†™ï¼Œå»¶è¿Ÿåˆ·ï¼‰ æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ MySQL éƒ½ä¼šæŠŠ log buffer çš„æ•°æ®å†™å…¥ log fileã€‚ä½†æ˜¯ flush æ“ä½œå¹¶ä¸ä¼šåŒæ—¶è¿›è¡Œã€‚è¯¥æ¨¡å¼ä¸‹ï¼ŒMySQL ä¼šæ¯ç§’æ‰§è¡Œä¸€æ¬¡ flush æ“ä½œã€‚ redo logï¼Œå®ƒåˆåˆ†æˆå†…å­˜å’Œç£ç›˜ä¸¤éƒ¨åˆ†ã€‚redo log æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ redo log æ˜¯ InnoDB å­˜å‚¨å¼•æ“å®ç°çš„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰å­˜å‚¨å¼•æ“éƒ½æœ‰ã€‚ ä¸æ˜¯è®°å½•æ•°æ®é¡µæ›´æ–°ä¹‹åçš„çŠ¶æ€ï¼Œè€Œæ˜¯è®°å½•è¿™ä¸ªé¡µåšäº†ä»€ä¹ˆæ”¹åŠ¨ï¼Œå±äºç‰©ç†æ—¥å¿—ã€‚ï¼ˆredo log è®°å½•çš„æ˜¯æ‰§è¡Œçš„ç»“æœï¼‰ redo log çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå‰é¢çš„å†…å®¹ä¼šè¢«è¦†ç›–ã€‚ check point æ˜¯å½“å‰è¦è¦†ç›–çš„ä½ç½®ã€‚å¦‚æœ write pos è·Ÿ check point é‡å ï¼Œè¯´æ˜ redolog å·²ç»å†™æ»¡ï¼Œè¿™æ—¶å€™éœ€è¦åŒæ­¥ redo log åˆ°ç£ç›˜ä¸­ã€‚ è¿™æ˜¯ MySQL çš„å†…å­˜ç»“æ„ï¼Œæ€»ç»“ä¸€ä¸‹ï¼Œåˆ†ä¸ºï¼šBuffer poolã€change bufferã€Adaptive Hash Indexã€ log bufferã€‚ ç£ç›˜ç»“æ„é‡Œé¢ä¸»è¦æ˜¯å„ç§å„æ ·çš„è¡¨ç©ºé—´ï¼Œå«åš Table spaceã€‚ 1.5 ç¼“å­˜çš„ç–‘é—®ç¼“å­˜ï¼ˆcacheï¼‰æ˜¯åœ¨è¯»å–ç¡¬ç›˜ä¸­çš„æ•°æ®æ—¶ï¼ŒæŠŠæœ€å¸¸ç”¨çš„æ•°æ®ä¿å­˜åœ¨å†…å­˜çš„ç¼“å­˜åŒºä¸­ï¼Œå†æ¬¡è¯»å–è¯¥æ•°æ®æ—¶ï¼Œå°±ä¸å»ç¡¬ç›˜ä¸­è¯»å–äº†ï¼Œè€Œåœ¨ç¼“å­˜ä¸­è¯»å–ã€‚ç¼“å†²ï¼ˆbufferï¼‰æ˜¯åœ¨å‘ç¡¬ç›˜å†™å…¥æ•°æ®æ—¶ï¼Œå…ˆæŠŠæ•°æ®æ”¾å…¥ç¼“å†²åŒº,ç„¶åå†ä¸€èµ·å‘ç¡¬ç›˜å†™å…¥ï¼ŒæŠŠåˆ†æ•£çš„å†™æ“ä½œé›†ä¸­è¿›è¡Œï¼Œå‡å°‘ç£ç›˜ç¢ç‰‡å’Œç¡¬ç›˜çš„åå¤å¯»é“ï¼Œä»è€Œæé«˜ç³»ç»Ÿæ€§èƒ½ã€‚ ç„¶åï¼ŒInnoDBæ¶æ„ä¸­ï¼Œæœ‰éå¸¸é‡è¦çš„ä¸€ä¸ªéƒ¨åˆ†â€”â€”ç¼“å†²æ± ã€‚è¯¥ç¼“å†²æ± éœ€è¦å ç”¨æœåŠ¡å™¨å†…å­˜ï¼Œä¸”ä¸“ç”¨äºMySQLçš„æœåŠ¡å™¨ï¼Œå»ºè®®æŠŠ80%çš„å†…å­˜äº¤ç»™MySQLã€‚ ç¼“å†²æ± æœ‰ä¸€ä¸ªç¼“å­˜çš„åŠŸèƒ½ã€‚è¿™ä¸ªç¼“å­˜ï¼Œæ˜¯InnoDBè‡ªå¸¦çš„ï¼Œè€Œä¸”ç»å¸¸ä¼šç”¨åˆ°ã€‚è¯¥ç¼“å­˜åŠŸèƒ½å¹¶ä¸æ˜¯MySQLæ¶æ„ä¸­çš„ç¼“å­˜ç»„ä»¶ã€‚è¿™æ˜¯ä¸¤è€…æœ€å¤§çš„åŒºåˆ«ã€‚ MySQLç»„ä»¶ä¸­çš„ç¼“å­˜ æ‰€å¤„ä½ç½®ï¼šMySQLæ¶æ„ä¸­çš„ç¼“å­˜ç»„ä»¶ ç¼“å­˜å†…å®¹ï¼šç¼“å­˜çš„æ˜¯SQL å’Œ è¯¥SQLçš„æŸ¥è¯¢ç»“æœã€‚å¦‚æœSQLçš„å¤§å°å†™ï¼Œæ ¼å¼ï¼Œæ³¨é‡Šä¸ä¸€è‡´ï¼Œåˆ™è¢«è®¤ä¸ºæ˜¯ä¸åŒçš„SQLï¼Œé‡æ–°æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶ç¼“å­˜ä¸€ä»½æ•°æ®ã€‚ å¯å¦å…³é—­ï¼šæ˜¯å¯ä»¥æ‰‹åŠ¨å…³é—­ï¼Œå¹¶å¸è½½è¯¥ç»„ä»¶çš„ã€‚ InnoDBä¸­çš„ç¼“å­˜ æ‰€å¤„ä½ç½®ï¼šInnoDBæ¶æ„ä¸­çš„ç¼“å†²æ±  ç¼“å­˜å†…å®¹ï¼šç¼“å­˜çš„æ˜¯æ‰€æœ‰éœ€è¦æŸ¥æ‰¾çš„æ•°æ®ï¼Œæ‰€åœ¨çš„æ•°æ®é¡µã€‚ å¯å¦å…³é—­ï¼šæ˜¯InnoDBç¼“å†²æ± è‡ªå¸¦çš„åŠŸèƒ½ï¼Œæ— æ³•å…³é—­ï¼Œæ— æ³•å¸è½½ã€‚å¦‚æœInnoDBçš„ç¼“å†²æ± è¢«å…³é—­æˆ–å¸è½½ï¼Œåˆ™InnoDBç›´æ¥ç˜«ç—ªã€‚æ‰€ä»¥è¯´ç¼“å†²æ± æ˜¯InnoDBçš„æœ€é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚ ä¸å»ºè®®ä½¿ç”¨MySQLçš„ç¼“å­˜æ˜¯æŒ‡ï¼Œä¸å»ºè®®ä½¿ç”¨MySQLæ¶æ„ä¸­çš„ç¼“å­˜ç»„ä»¶ï¼Œå¹¶ä¸æ˜¯åŒæ—¶å¦å®šäº†InnoDBä¸­çš„ç¼“å­˜åŠŸèƒ½ã€‚â€‹ 2.ç£ç›˜ç»“æ„è¡¨ç©ºé—´å¯ä»¥çœ‹åšæ˜¯ InnoDB å­˜å‚¨å¼•æ“é€»è¾‘ç»“æ„çš„æœ€é«˜å±‚ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½å­˜æ”¾åœ¨è¡¨ç©ºé—´ä¸­ã€‚InnoDB çš„è¡¨ç©ºé—´åˆ†ä¸º 5 å¤§ç±»ã€‚â€‹ 2.1 ç³»ç»Ÿè¡¨ç©ºé—´åœ¨é»˜è®¤æƒ…å†µä¸‹ InnoDB å­˜å‚¨å¼•æ“æœ‰ä¸€ä¸ªå…±äº«è¡¨ç©ºé—´ï¼ˆå¯¹åº”æ–‡ä»¶/var/lib/mysql/ibdata1ï¼‰ï¼Œä¹Ÿå«ç³»ç»Ÿè¡¨ç©ºé—´ã€‚ InnoDB ç³»ç»Ÿè¡¨ç©ºé—´åŒ…å« InnoDB æ•°æ®å­—å…¸å’ŒåŒå†™ç¼“å†²åŒºï¼Œï¼ˆChange Buffer å’Œ UndoLogsï¼‰ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š file-per-tableï¼Œä¹ŸåŒ…å«ç”¨æˆ·åˆ›å»ºçš„è¡¨å’Œç´¢å¼•æ•°æ®ã€‚ undo åœ¨åé¢ä»‹ç»ï¼Œå› ä¸ºæœ‰ç‹¬ç«‹çš„è¡¨ç©ºé—´ã€‚ æ•°æ®å­—å…¸ï¼šç”±å†…éƒ¨ç³»ç»Ÿè¡¨ç»„æˆï¼Œå­˜å‚¨è¡¨å’Œç´¢å¼•çš„å…ƒæ•°æ®ï¼ˆå®šä¹‰ä¿¡æ¯ï¼‰ã€‚ åŒå†™ç¼“å†²ï¼ˆInnoDB çš„ä¸€å¤§ç‰¹æ€§ï¼‰ InnoDB çš„é¡µå’Œæ“ä½œç³»ç»Ÿçš„é¡µå¤§å°ä¸ä¸€è‡´ï¼ŒInnoDB é¡µå¤§å°ä¸€èˆ¬ä¸º 16Kï¼Œæ“ä½œç³»ç»Ÿé¡µå¤§å°ä¸º 4Kï¼ŒInnoDB çš„é¡µå†™å…¥åˆ°ç£ç›˜æ—¶ï¼Œä¸€ä¸ªé¡µéœ€è¦åˆ† 4 æ¬¡å†™ã€‚ å¦‚æœå­˜å‚¨å¼•æ“æ­£åœ¨å†™å…¥é¡µçš„æ•°æ®åˆ°ç£ç›˜æ—¶å‘ç”Ÿäº†å®•æœºï¼Œå¯èƒ½å‡ºç°é¡µåªå†™äº†ä¸€éƒ¨åˆ†çš„æƒ…å†µï¼Œæ¯”å¦‚åªå†™äº† 4Kï¼Œå°±å®•æœºäº†ï¼Œè¿™ç§æƒ…å†µå«åšéƒ¨åˆ†å†™å¤±æ•ˆï¼ˆpartial page writeï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ 1show variables like &#x27;innodb_doublewrite&#x27;; å¦‚æœè¿™ä¸ªé¡µæœ¬èº«å·²ç»æŸåäº†ï¼Œç”¨å®ƒæ¥åšå´©æºƒæ¢å¤æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚æ‰€ä»¥åœ¨å¯¹äºåº”ç”¨ redo log ä¹‹å‰ï¼Œéœ€è¦ä¸€ä¸ªé¡µçš„å‰¯æœ¬ã€‚å¦‚æœå‡ºç°äº†å†™å…¥å¤±æ•ˆï¼Œå°±ç”¨é¡µçš„å‰¯æœ¬æ¥è¿˜åŸè¿™ä¸ªé¡µï¼Œç„¶åå†åº”ç”¨ redo logã€‚è¿™ä¸ªé¡µçš„å‰¯æœ¬å°±æ˜¯ double writeï¼ŒInnoDB çš„åŒå†™æŠ€æœ¯ã€‚é€šè¿‡å®ƒå®ç°äº†æ•°æ®é¡µçš„å¯é æ€§ã€‚ è·Ÿ redo log ä¸€æ ·ï¼Œdouble write ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯å†…å­˜çš„ double writeï¼Œä¸€ä¸ªéƒ¨åˆ†æ˜¯ç£ç›˜ä¸Šçš„ double writeã€‚å› ä¸º double write æ˜¯é¡ºåºå†™å…¥çš„ï¼Œä¸ä¼šå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ã€‚ åœ¨MySQL5.7ä¹‹å‰ï¼Œæ‰€æœ‰çš„è¡¨å…±äº«ä¸€ä¸ªç³»ç»Ÿè¡¨ç©ºé—´ï¼Œè¿™ä¸ªæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ï¼Œè€Œä¸”å®ƒçš„ç©ºé—´ä¸ä¼šæ”¶ç¼©ã€‚â€‹ 2.2 ç‹¬å è¡¨ç©ºé—´æˆ‘ä»¬å¯ä»¥è®©æ¯å¼ è¡¨ç‹¬å ä¸€ä¸ªè¡¨ç©ºé—´ã€‚è¿™ä¸ªå¼€å…³é€šè¿‡ innodb_file_per_table è®¾ç½®ï¼Œé»˜è®¤å¼€å¯ã€‚ 1SHOW VARIABLES LIKE &#x27;innodb_file_per_table&#x27;; å¼€å¯åï¼Œåˆ™æ¯å¼ è¡¨ä¼šå¼€è¾Ÿä¸€ä¸ªè¡¨ç©ºé—´ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯æ•°æ®ç›®å½•ä¸‹çš„ ibd æ–‡ä»¶ï¼Œå­˜æ”¾è¡¨çš„ç´¢å¼•å’Œæ•°æ®ã€‚ä½†æ˜¯å…¶ä»–ç±»çš„æ•°æ®ï¼Œå¦‚å›æ»šï¼ˆundoï¼‰ä¿¡æ¯ï¼Œæ’å…¥ç¼“å†²ç´¢å¼•é¡µã€ç³»ç»Ÿäº‹åŠ¡ä¿¡æ¯ï¼ŒäºŒæ¬¡å†™ç¼“å†²ï¼ˆDouble write bufferï¼‰ç­‰è¿˜æ˜¯å­˜æ”¾åœ¨åŸæ¥çš„å…±äº«è¡¨ç©ºé—´å†…ã€‚â€‹ 2.3 é€šç”¨è¡¨ç©ºé—´é€šç”¨è¡¨ç©ºé—´ä¹Ÿæ˜¯ä¸€ç§å…±äº«çš„è¡¨ç©ºé—´ï¼Œè·Ÿ ibdata1 ç±»ä¼¼ã€‚ å¯ä»¥åˆ›å»ºä¸€ä¸ªé€šç”¨çš„è¡¨ç©ºé—´ï¼Œç”¨æ¥å­˜å‚¨ä¸åŒæ•°æ®åº“çš„è¡¨ï¼Œæ•°æ®è·¯å¾„å’Œæ–‡ä»¶å¯ä»¥è‡ªå®šä¹‰ã€‚è¯­æ³•ï¼š 1create tablespace ts2673 add datafile &#x27;/var/lib/mysql/ts2673.ibd&#x27; file_block_size=16K engine=innodb; åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™å¯ä»¥æŒ‡å®šè¡¨ç©ºé—´ï¼Œç”¨ ALTER ä¿®æ”¹è¡¨ç©ºé—´å¯ä»¥è½¬ç§»è¡¨ç©ºé—´ã€‚ 1create table t2673(id integer) tablespace ts2673; ä¸åŒè¡¨ç©ºé—´çš„æ•°æ®æ˜¯å¯ä»¥ç§»åŠ¨çš„ã€‚åˆ é™¤è¡¨ç©ºé—´éœ€è¦å…ˆåˆ é™¤é‡Œé¢çš„æ‰€æœ‰è¡¨ï¼š 12drop table t2673;drop tablespace ts2673; 2.4 ä¸´æ—¶è¡¨ç©ºé—´å­˜å‚¨ä¸´æ—¶è¡¨çš„æ•°æ®ï¼ŒåŒ…æ‹¬ç”¨æˆ·åˆ›å»ºçš„ä¸´æ—¶è¡¨ï¼Œå’Œç£ç›˜çš„å†…éƒ¨ä¸´æ—¶è¡¨ã€‚å¯¹åº”æ•°æ®ç›®å½•ä¸‹çš„ ibtmp1 æ–‡ä»¶ã€‚å½“æ•°æ®æœåŠ¡å™¨æ­£å¸¸å…³é—­æ—¶ï¼Œè¯¥è¡¨ç©ºé—´è¢«åˆ é™¤ï¼Œä¸‹æ¬¡é‡æ–°äº§ç”Ÿã€‚ memoryå‘templateçš„è¿‡æ¸¡ï¼Œè¿˜æœ‰ç£ç›˜ä¸Šç®€å†ä¸´æ—¶è¡¨ç”¨çš„ä»€ä¹ˆå­˜å‚¨å¼•æ“ï¼Ÿ 8.0ä¹‹å‰ï¼Œå†…å­˜ä¸´æ—¶è¡¨ç”¨Memoryå¼•æ“åˆ›å»ºï¼Œä½†å‡å¦‚å­—æ®µä¸­æœ‰BLOBæˆ–TEXT,æˆ–ç»“æœå¤ªå¤§ï¼Œå°±ä¼šè½¬ç”¨MYISMåœ¨ç£ç›˜ä¸Šå»ºè¡¨ï¼Œ8.0ä¹‹åå†…å­˜ä¸´æ—¶è¡¨ç”±MEMORYå¼•æ“æ›´æ”¹ä¸ºTempTableå¼•æ“ï¼Œç›¸æ¯”äºå‰è€…ï¼Œåè€…æ”¯æŒä»¥å˜é•¿æ–¹å¼å­˜å‚¨VARCHARï¼ŒVARBINARYç­‰å˜é•¿å­—æ®µã€‚ä»MySQL 8.0.13å¼€å§‹ï¼ŒTempTableå¼•æ“æ”¯æŒBLOBå­—æ®µã€‚å¦‚æœè¶…è¿‡å†…å­˜è¡¨å¤§å°ï¼Œåˆ™ç”¨InnoDBå»ºè¡¨ã€‚ 2.5 redo log2.6 undo log è¡¨ç©ºé—´undo logï¼ˆæ’¤é”€æ—¥å¿—æˆ–å›æ»šæ—¥å¿—ï¼‰è®°å½•äº†äº‹åŠ¡å‘ç”Ÿä¹‹å‰çš„æ•°æ®çŠ¶æ€ï¼ˆä¸åŒ…æ‹¬ selectï¼‰ã€‚ å¦‚æœä¿®æ”¹æ•°æ®æ—¶å‡ºç°å¼‚å¸¸ï¼Œå¯ä»¥ç”¨ undo log æ¥å®ç°å›æ»šæ“ä½œï¼ˆä¿æŒåŸå­æ€§ï¼‰ã€‚ åœ¨æ‰§è¡Œ undo çš„æ—¶å€™ï¼Œä»…ä»…æ˜¯å°†æ•°æ®ä»é€»è¾‘ä¸Šæ¢å¤è‡³äº‹åŠ¡ä¹‹å‰çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä»ç‰©ç†é¡µé¢ä¸Šæ“ä½œå®ç°çš„ï¼Œå±äºé€»è¾‘æ ¼å¼çš„æ—¥å¿—(è®°å½•æ“ä½œ)ã€‚ redo Log å’Œ undo Log ä¸äº‹åŠ¡å¯†åˆ‡ç›¸å…³ï¼Œç»Ÿç§°ä¸ºäº‹åŠ¡æ—¥å¿—ã€‚ undo Log çš„æ•°æ®é»˜è®¤åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ ibdata1 æ–‡ä»¶ä¸­ï¼Œå› ä¸ºå…±äº«è¡¨ç©ºé—´ä¸ä¼šè‡ªåŠ¨æ”¶ç¼©ï¼Œä¹Ÿå¯ä»¥å•ç‹¬åˆ›å»ºä¸€ä¸ª undo è¡¨ç©ºé—´ã€‚ 1show global variables like &#x27;%undo%&#x27;; 2.7 ä¸€æ¡SQLçš„æ›´æ–°æµç¨‹12# id =1 çš„è®°å½•åŸ name = &#x27;yhd&#x27;update user set name = &#x27;äºŒå&#x27; where id=1; äº‹åŠ¡å¼€å§‹ï¼Œä»å†…å­˜æˆ–è€…ç£ç›˜å–åˆ°è¿™æ¡æ•°æ®ï¼Œè¿”å›ç»™serverçš„æ‰§è¡Œå™¨ æ‰§è¡Œå™¨ä¿®æ”¹è¿™ä¸€è¡Œæ•°æ®çš„å€¼ä¸ºäºŒå è®°å½•name =yhd åˆ°undo log è®°å½•name = äºŒå åˆ°redo log è°ƒç”¨å­˜å‚¨å¼•æ“æ¥å£ï¼Œåœ¨buffer pool ä¸­ä¿®æ”¹ name =äºŒå äº‹åŠ¡æäº¤ â€‹ å†…å­˜å’Œç£ç›˜ä¹‹é—´ï¼Œå·¥ä½œç€å¾ˆå¤šåå°çº¿ç¨‹ã€‚ 3.åå°çº¿ç¨‹åå°çº¿ç¨‹çš„ä¸»è¦ä½œç”¨æ˜¯è´Ÿè´£åˆ·æ–°å†…å­˜æ± ä¸­çš„æ•°æ®å’ŒæŠŠä¿®æ”¹çš„æ•°æ®é¡µåˆ·æ–°åˆ°ç£ç›˜ã€‚åå°çº¿ç¨‹åˆ†ä¸ºï¼šmasterçº¿ç¨‹ï¼ŒIO çº¿ç¨‹ï¼Œpurge çº¿ç¨‹ï¼Œpage cleaner çº¿ç¨‹ã€‚â€‹ 3.1 Master çº¿ç¨‹Master Threadæ˜¯InnoDBå­˜å‚¨å¼•æ“éå¸¸æ ¸å¿ƒçš„ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¸»è¦è´Ÿè´£å°†ç¼“å†²æ± ä¸­çš„æ•°æ®å¼‚æ­¥åˆ·æ–°åˆ°ç£ç›˜ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŒåŒ…æ‹¬è„é¡µçš„åˆ·æ–°ã€åˆå¹¶æ’å…¥ç¼“å†²ã€UNDOé¡µçš„å›æ”¶ç­‰ã€‚â€‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546void master_thread()&#123; loop: for(int i = 0; i &lt; 10; ++i)&#123; thread_sleep(1); // sleep 1ç§’ do log buffer flush to disk; if(last_one_second_ios &lt; 5) do merge at most 5 insert buffer; if(buf_get_modified_ratio_pct &gt; innodb_max_dirty_pages_pct) // å¦‚æœç¼“å†²æ± ä¸­çš„è„é¡µæ¯”ä¾‹å¤§äºinnodb_max_dirty_pages_pct(é»˜è®¤æ˜¯75æ—¶) do buffer pool flush 100 dirty page; // åˆ·æ–°100è„é¡µåˆ°ç£ç›˜ if(no user activity) goto backgroud loop; &#125; if(last_ten_second_ios &lt; 200) // å¦‚æœè¿‡å»10å†…ç£ç›˜IOæ¬¡æ•°å°äºè®¾ç½®çš„innodb_io_capacityçš„å€¼ï¼ˆé»˜è®¤æ˜¯200ï¼‰ do buffer pool flush 100 dirty page; do merge at most 5 insert buffer; // åˆå¹¶æ’å…¥ç¼“å†²æ˜¯innodb_io_capacityçš„5%ï¼ˆ10ï¼‰ï¼ˆæ€»æ˜¯ï¼‰ do log buffer flush to disk; do full purge; if(buf_get_modified_ratio_pct &gt; 70%) do buffer pool flush 100 dirty page; else buffer pool flush 10 dirty page; backgroud loopï¼š // åå°å¾ªç¯ do full purge // åˆ é™¤æ— ç”¨çš„undoé¡µ ï¼ˆæ€»æ˜¯ï¼‰ do merge 20 insert buffer; // åˆå¹¶æ’å…¥ç¼“å†²æ˜¯innodb_io_capacityçš„5%ï¼ˆ10ï¼‰ï¼ˆæ€»æ˜¯ï¼‰ if not idle // å¦‚æœä¸ç©ºé—²ï¼Œå°±è·³å›ä¸»å¾ªç¯ï¼Œå¦‚æœç©ºé—²å°±è·³å…¥flush loop goto loop: // è·³åˆ°ä¸»å¾ªç¯ else goto flush loop flush loop: // åˆ·æ–°å¾ªç¯ do buffer pool flush 100 dirty page; if(buf_get_modified_ratio_pct &gt; innodb_max_dirty_pages_pct) // å¦‚æœç¼“å†²æ± ä¸­çš„è„é¡µæ¯”ä¾‹å¤§äºinnodb_max_dirty_pages_pctçš„å€¼ï¼ˆé»˜è®¤75%ï¼‰ goto flush loop; // è·³åˆ°åˆ·æ–°å¾ªç¯ï¼Œä¸æ–­åˆ·æ–°è„é¡µï¼Œç›´åˆ°ç¬¦åˆæ¡ä»¶ goto suspend loop; // å®Œæˆåˆ·æ–°è„é¡µçš„ä»»åŠ¡åï¼Œè·³å…¥suspend loop suspend loop: suspend_thread(); //masterçº¿ç¨‹æŒ‚èµ·ï¼Œç­‰å¾…äº‹ä»¶å‘ç”Ÿ waiting event; goto loop;&#125; Master Threadå…·æœ‰æœ€é«˜çš„çº¿ç¨‹ä¼˜å…ˆçº§åˆ«ã€‚å†…éƒ¨ç”±å¤šä¸ªå¾ªç¯ç»„æˆï¼šä¸»å¾ªç¯ï¼ˆloopï¼‰ã€åå°å¾ªç¯ï¼ˆbackgroup loopï¼‰ã€åˆ·æ–°å¾ªç¯ï¼ˆflush loopï¼‰ã€æš‚åœå¾ªç¯ï¼ˆsuspend loopï¼‰ã€‚Master Threadä¼šæ ¹æ®æ•°æ®åº“è¿è¡Œçš„çŠ¶æ€åœ¨loopã€backgroup loopã€flush loopå’Œsuspend loopä¸­è¿›è¡Œåˆ‡æ¢ã€‚loopæ˜¯ä¸»å¾ªç¯ï¼Œå¤§å¤šæ•°çš„æ“ä½œéƒ½åœ¨è¿™ä¸ªå¾ªç¯ä¸­ï¼Œä¸»è¦æœ‰ä¸¤å¤§éƒ¨åˆ†çš„æ“ä½œâ€”â€”æ¯ç§’é’Ÿçš„æ“ä½œå’Œæ¯10ç§’é’Ÿçš„æ“ä½œã€‚â€‹ â‘ æ¯ç§’é’Ÿçš„æ“ä½œâ€‹ â€‹æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°ç£ç›˜ï¼Œå³ä½¿è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼ˆæ€»æ˜¯ï¼‰ï¼›å³ä½¿æŸä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä»ç„¶æ¯ç§’ä¼šå°†é‡åšæ—¥å¿—ç¼“å†²ä¸­çš„å†…å®¹åˆ·æ–°åˆ°é‡åšæ—¥å¿—æ–‡ä»¶ã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆå†å¤§çš„äº‹åŠ¡æäº¤çš„æ—¶é—´ä¹Ÿæ˜¯å¾ˆçŸ­çš„ã€‚ åˆå¹¶æ’å…¥ç¼“å†²ï¼ˆå¯èƒ½ï¼‰ï¼›åˆå¹¶æ’å…¥ç¼“å†²å¹¶ä¸æ˜¯æ¯ç§’éƒ½ä¼šå‘ç”Ÿçš„ã€‚InnoDBå­˜å‚¨å¼•æ“ä¼šåˆ¤æ–­å½“å‰ä¸€ç§’å†…å‘ç”Ÿçš„IOæ¬¡æ•°æ˜¯å¦å°äº5æ¬¡ï¼Œå¦‚æœå°äº5æ¬¡ï¼ŒInnoDBå­˜å‚¨å¼•æ“è®¤ä¸ºå½“å‰çš„IOå‹åŠ›å¾ˆå°ï¼Œå¯ä»¥æ‰§è¡Œåˆå¹¶æ’å…¥ç¼“å†²çš„æ“ä½œï¼› è‡³å¤šåˆ·æ–°100ä¸ªInnoDBçš„ç¼“å†²æ± ä¸­çš„è„é¡µåˆ°ç£ç›˜ï¼ˆå¯èƒ½ï¼‰ï¼› åˆ·æ–°100ä¸ªè„é¡µä¹Ÿä¸æ˜¯æ¯ç§’éƒ½ä¼šå‘ç”Ÿçš„ï¼ŒInnoDBå­˜å‚¨å¼•æ“é€šè¿‡åˆ¤æ–­å½“å‰ç¼“å†²æ± ä¸­è„é¡µçš„æ¯”ä¾‹(buf_get_modified_ratio_pct)æ˜¯å¦è¶…è¿‡äº†é…ç½®æ–‡ä»¶ä¸­ innodb_max_dirty_pages_pctè¿™ä¸ªå‚æ•°ï¼ˆé»˜è®¤æ˜¯75ï¼Œä»£è¡¨75%ï¼‰ï¼Œå¦‚æœè¶…è¿‡äº†è¿™ä¸ªå€¼ï¼ŒInnoDBå­˜å‚¨å¼•æ“åˆ™è®¤ä¸ºéœ€è¦åšç£ç›˜åŒæ­¥çš„æ“ä½œï¼Œå°†100ä¸ªè„é¡µå†™å…¥ç£ç›˜ä¸­ã€‚ å¦‚æœå½“å‰æ²¡æœ‰ç”¨æˆ·æ´»åŠ¨ï¼Œåˆ™åˆ‡æ¢åˆ°background loop(å¯èƒ½)ã€‚ â€‹ â‘¡æ¯åç§’çš„æ“ä½œ åˆ·æ–°100ä¸ªè„é¡µåˆ°ç£ç›˜ï¼ˆå¯èƒ½ï¼‰ InnoDBå­˜å‚¨å¼•æ“ä¼šå…ˆåˆ¤æ–­è¿‡å»10ç§’ä¹‹å†…ç£ç›˜çš„IOæ“ä½œæ˜¯å¦å°äº200æ¬¡ï¼Œå¦‚æœæ˜¯ï¼ŒInnoDBå­˜å‚¨å¼•æ“è®¤ä¸ºå½“å‰æœ‰è¶³å¤Ÿçš„ç£ç›˜IOèƒ½åŠ›ï¼Œå› æ­¤å°†100ä¸ªè„é¡µåˆ·æ–°åˆ°ç£ç›˜ã€‚ åˆå¹¶è‡³å¤š5ä¸ªæ’å…¥ç¼“å†²ï¼ˆæ€»æ˜¯ï¼‰ å°†æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°ç£ç›˜ï¼ˆæ€»æ˜¯ï¼‰ åˆ é™¤æ— ç”¨çš„Undoé¡µï¼ˆæ€»æ˜¯ï¼‰ åˆ·æ–°100ä¸ªæˆ–è€…10ä¸ªè„é¡µåˆ°ç£ç›˜ï¼ˆæ€»æ˜¯ï¼‰ InnoDBå­˜å‚¨å¼•æ“ä¼šæ‰§è¡Œfull purgeæ“ä½œï¼Œå³åˆ é™¤æ— ç”¨çš„Undoé¡µã€‚å¯¹è¡¨è¿›è¡Œupdateï¼Œdeleteè¿™ç±»çš„æ“ä½œæ—¶ï¼ŒåŸå…ˆçš„è¡Œè¢«æ ‡è®°ä¸ºåˆ é™¤ï¼Œä½†æ˜¯å› ä¸ºä¸€è‡´æ€§è¯»çš„å…³ç³»ï¼Œéœ€è¦ä¿ç•™è¿™äº›è¡Œç‰ˆæœ¬çš„ä¿¡æ¯ã€‚ä½†æ˜¯åœ¨full purgeè¿‡ç¨‹ä¸­ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šåˆ¤æ–­å½“å‰äº‹åŠ¡ç³»ç»Ÿä¸­å·²è¢«åˆ é™¤çš„è¡Œæ˜¯å¦å¯ä»¥åˆ é™¤ï¼Œæ¯”å¦‚æœ‰æ—¶å€™å¯èƒ½è¿˜æœ‰æŸ¥è¯¢æ“ä½œéœ€è¦è¯»å–ä¹‹å‰ç‰ˆæœ¬çš„undoä¿¡æ¯ï¼Œå¦‚æœå¯ä»¥åˆ é™¤ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šç«‹å³å°†å…¶åˆ é™¤ã€‚ä»æºä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼ŒInnoDBå­˜å‚¨å¼•æ“åœ¨æ‰§è¡Œfull purge æ“ä½œæ—¶ï¼Œæ¯æ¬¡æœ€å¤šå°è¯•å›æ”¶20ä¸ªundoé¡µã€‚ç„¶åï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šåˆ¤æ–­ç¼“å†²æ± ä¸­è„é¡µçš„æ¯”ä¾‹ï¼ˆbuf_get_modified_ratio_pctï¼‰,å¦‚æœæœ‰è¶…è¿‡70%çš„è„é¡µï¼Œåˆ™åˆ·æ–°100ä¸ªè„é¡µåˆ°ç£ç›˜ï¼Œå¦‚æœè„é¡µçš„æ¯”ä¾‹å°äº70%,åˆ™åªéœ€åˆ·æ–°10%çš„è„é¡µåˆ°ç£ç›˜ã€‚ â€‹ å¦‚æœå½“å‰æ²¡æœ‰ç”¨æˆ·æ´»åŠ¨ï¼ˆæ•°æ®åº“ç©ºé—²ï¼‰æˆ–è€…æ•°æ®åº“å…³ç³»ï¼Œå°±ä¼šåˆ‡æ¢åˆ°backgroud loopè¿™ä¸ªå¾ªç¯ã€‚ backgroud loopä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š åˆ é™¤æ— ç”¨çš„Undoé¡µï¼ˆæ€»æ˜¯ï¼‰ åˆå¹¶20ä¸ªæ’å…¥ç¼“å†²ï¼ˆæ€»æ˜¯ï¼‰ è·³å›åˆ°ä¸»å¾ªç¯ï¼ˆæ€»æ˜¯ï¼‰ ä¸æ–­åˆ·æ–°100ä¸ªé¡µç›´åˆ°ç¬¦åˆæ¡ä»¶ï¼ˆå¯èƒ½ï¼Œéœ€è¦è·³è½¬åˆ°flush loopä¸­å®Œæˆï¼‰ å¦‚æœflush loopä¸­ä¹Ÿæ²¡æœ‰ä»€ä¹ˆäº‹æƒ…å¯ä»¥åšäº†ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šåˆ‡æ¢åˆ°suspend_loopï¼Œå°†Master ThreadæŒ‚èµ·ï¼Œç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿã€‚è‹¥ç”¨æˆ·å¯ç”¨äº†InnoDBå­˜å‚¨å¼•æ“ï¼Œå´æ²¡æœ‰ä½¿ç”¨ä»»ä½•InnoDBå­˜å‚¨å¼•æ“çš„è¡¨ï¼Œé‚£ä¹ˆMaster Threadæ€»æ˜¯å¤„äºæŒ‚èµ·çš„çŠ¶æ€ã€‚â€‹ 1.0.xç‰ˆæœ¬ä¸­ï¼ŒInnoDBå­˜å‚¨å¼•æ“æœ€å¤šåªä¼šåˆ·æ–°100ä¸ªè„é¡µåˆ°ç£ç›˜ï¼Œåˆå¹¶20ä¸ªæ’å…¥ç¼“å†²ã€‚å¦‚æœæ˜¯åœ¨å†™å…¥å¯†é›†çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ¯ç§’å¯èƒ½ä¼šäº§ç”Ÿå¤§äº100ä¸ªçš„è„é¡µï¼Œå¦‚æœæ˜¯äº§ç”Ÿå¤§äº20ä¸ªæ’å…¥ç¼“å†²çš„æƒ…å†µï¼Œé‚£ä¹ˆå¯èƒ½ä¼šæ¥ä¸åŠåˆ·æ–°æ‰€æœ‰çš„è„é¡µä»¥åŠåˆå¹¶æ’å…¥ç¼“å†²ã€‚åæ¥ï¼ŒInnoDBå­˜å‚¨å¼•æ“æä¾›äº†å‚æ•°innodb_io_capacityï¼Œç”¨æ¥è¡¨ç¤ºç£ç›˜IOçš„ååé‡ï¼Œé»˜è®¤å€¼ä¸º200ã€‚â€‹ å¯¹äºåˆ·æ–°åˆ°ç£ç›˜çš„é¡µçš„æ•°é‡ï¼Œä¼šæŒ‰ç…§innodb_io_capacityçš„ç™¾åˆ†æ¯”æ¥è¿›è¡Œæ§åˆ¶ã€‚è§„åˆ™å¦‚ä¸‹ï¼š åœ¨åˆå¹¶æ’å…¥ç¼“å†²æ—¶ï¼Œåˆå¹¶æ’å…¥ç¼“å†²çš„æ•°é‡ä¸ºinnodb_io_capacityå€¼çš„5%; åœ¨ä»ç¼“å†²åŒºåˆ·æ–°è„é¡µæ—¶ï¼Œåˆ·æ–°è„é¡µçš„æ•°é‡ä¸ºinnodb_io_capacity; å¦‚æœç”¨æˆ·ä½¿ç”¨çš„æ˜¯SSDç±»çš„ç£ç›˜ï¼Œå¯ä»¥å°†innodb_io_capacityçš„å€¼è°ƒé«˜ï¼Œç›´åˆ°ç¬¦åˆç£ç›˜IOçš„ååé‡ä¸ºæ­¢ï¼› å¦ä¸€ä¸ªé—®é¢˜æ˜¯å‚æ•°innodb_max_dirty_pages_pctçš„é»˜è®¤å€¼ï¼Œåœ¨1.0.xç‰ˆæœ¬ä¹‹å‰ï¼Œè¯¥å€¼çš„é»˜è®¤å€¼æ˜¯90ï¼Œæ„å‘³ç€è„é¡µå ç¼“å†²æ± çš„90%ã€‚InnoDBå­˜å‚¨å¼•æ“åœ¨æ¯ç§’åˆ·æ–°ç¼“å†²æ± å’Œflush loopæ—¶ä¼šåˆ¤æ–­è¿™ä¸ªå€¼ï¼Œå¦‚æœè¯¥å€¼å¤§äºinnodb_max_dirty_pages_pct,æ‰ä¼šåˆ·æ–°100ä¸ªè„é¡µï¼Œå¦‚æœæœ‰å¾ˆå¤§çš„å†…å­˜ï¼Œæˆ–è€…æ•°æ®åº“æœåŠ¡å™¨çš„å‹åŠ›å¾ˆå¤§ï¼Œè¿™æ—¶åˆ·æ–°è„é¡µçš„é€Ÿåº¦åè€Œä¼šé™ä½ã€‚ åæ¥å°†innodb_max_dirty_pages_pctçš„é»˜è®¤å€¼æ”¹ä¸ºäº†75ã€‚è¿™æ ·æ—¢å¯ä»¥åŠ å¿«åˆ·æ–°è„é¡µçš„é¢‘ç‡ï¼Œåˆèƒ½å¤Ÿä¿è¯ç£ç›˜IOçš„è´Ÿè½½ã€‚â€‹ è¿˜æœ‰ä¸€ä¸ªæ–°çš„å‚æ•°æ˜¯innodb_adaptive_flushing(è‡ªé€‚åº”åœ°åˆ·æ–°)ï¼Œè¯¥å€¼å½±å“æ¯ç§’åˆ·æ–°è„é¡µçš„æ•°é‡ã€‚åŸæ¥çš„åˆ·æ–°è§„åˆ™æ˜¯ï¼šè„é¡µåœ¨ç¼“å†²æ± æ‰€å çš„æ¯”ä¾‹å°äºinnodb_max_dirty_pages_pctæ—¶ï¼Œä¸åˆ·æ–°è„é¡µï¼›å¤§äºinnodb_max_dirty_pages_pctæ—¶ï¼Œåˆ·æ–°100ä¸ªè„é¡µã€‚éšç€innodb_adaptive_flushingå‚æ•°çš„å¼•å…¥ï¼ŒInnoDBé€šè¿‡ä¸€ä¸ªåä¸ºbuf_flush_get_desired_flush_rateçš„å‡½æ•°æ¥åˆ¤æ–­éœ€è¦åˆ·æ–°è„é¡µæœ€åˆé€‚çš„æ•°é‡ã€‚buf_flush_get_desired_flush_rateå‡½æ•°é€šè¿‡åˆ¤æ–­äº§ç”Ÿé‡åšæ—¥å¿—çš„é€Ÿç‡æ¥å†³å®šæœ€åˆé€‚çš„åˆ·æ–°è„é¡µæ•°é‡ã€‚ ä¹‹å‰æ¯æ¬¡è¿›è¡Œfull purge æ“ä½œæ—¶ï¼Œæœ€å¤šå›æ”¶20ä¸ªUndoé¡µï¼Œä»InnoDB 1.0.xç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†å‚æ•°innodb_purge_batch_size,è¯¥å‚æ•°å¯ä»¥æ§åˆ¶æ¯æ¬¡full purgeå›æ”¶çš„Undoé¡µçš„æ•°é‡ã€‚è¯¥å‚æ•°çš„é»˜è®¤å€¼ä¸º20ï¼Œå¹¶å¯ä»¥åŠ¨æ€åœ°å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚â€‹ 1.2.xç‰ˆæœ¬ä¸­å†æ¬¡å¯¹Master Threadè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¯¹äºåˆ·æ–°è„é¡µçš„æ“ä½œï¼Œä»Master Threadçº¿ç¨‹åˆ†ç¦»åˆ°ä¸€ä¸ªå•ç‹¬çš„Page Cleaner Threadï¼Œä»è€Œå‡è½»äº†Master Threadçš„å·¥ä½œï¼ŒåŒæ—¶è¿›ä¸€æ­¥æé«˜äº†ç³»ç»Ÿçš„å¹¶å‘æ€§ã€‚â€‹ 3.2 IO çº¿ç¨‹InnoDBä¸­å¤§é‡ä½¿ç”¨AIO (Async IO) æ¥å¤„ç†IOè¯·æ±‚ã€‚IO Threadçš„ä½œç”¨ï¼Œæ˜¯è´Ÿè´£è¿™äº› IO è¯·æ±‚çš„å›è°ƒï¼ˆcall backï¼‰ã€‚â€‹ 3.3 Purge çº¿ç¨‹äº‹åŠ¡è¢«æäº¤åï¼Œå…¶æ‰€ä½¿ç”¨çš„undo logå¯èƒ½ä¸åœ¨éœ€è¦ã€‚å› æ­¤ï¼Œéœ€è¦purge threadæ¥å›æ”¶å·²ç»ä½¿ç”¨å¹¶åˆ†é…çš„undoé¡µã€‚ä»¥å‰Master Threadæ¥å®Œæˆé‡Šæ”¾undo logï¼ŒInnoDB1.1ç‹¬ç«‹å‡ºæ¥ï¼Œåˆ†æ‹…ä¸»çº¿ç¨‹å‹åŠ›ã€‚â€‹ 3.4 Page Cleaner çº¿ç¨‹â€‹ è´Ÿè´£å°†è„é¡µåˆ·æ–°åˆ°ç£ç›˜ã€‚ä»¥å‰Master Threadæ¥åˆ·æ–°è„é¡µï¼ŒInnoDB1.2ç‹¬ç«‹å‡ºæ¥ï¼Œåˆ†æ‹…ä¸»çº¿ç¨‹å‹åŠ›ã€‚â€‹ é™¤äº† InnoDB æ¶æ„ä¸­çš„æ—¥å¿—æ–‡ä»¶ï¼ŒMySQL çš„ Server å±‚ä¹Ÿæœ‰ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå«åšbinlogï¼Œå®ƒå¯ä»¥è¢«æ‰€æœ‰çš„å­˜å‚¨å¼•æ“ä½¿ç”¨ã€‚ 4.binlogbinlog ä»¥äº‹ä»¶çš„å½¢å¼è®°å½•äº†æ‰€æœ‰çš„DDL å’ŒDML è¯­å¥ï¼ˆå› ä¸ºå®ƒè®°å½•çš„æ˜¯æ“ä½œè€Œä¸æ˜¯æ•°æ®å€¼ï¼Œå±äºé€»è¾‘æ—¥å¿—ï¼‰ï¼Œå¯ä»¥ç”¨æ¥åšä¸»ä»å¤åˆ¶å’Œæ•°æ®æ¢å¤ã€‚è·Ÿredo logä¸ä¸€æ ·ï¼Œå®ƒçš„æ–‡ä»¶å†…å®¹æ˜¯å¯ä»¥è¿½åŠ çš„ï¼Œæ²¡æœ‰å›ºå®šå¤§å°é™åˆ¶ã€‚åœ¨å¼€å¯äº† binlog åŠŸèƒ½çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ binlog å¯¼å‡ºæˆ SQL è¯­å¥ï¼ŒæŠŠæ‰€æœ‰çš„æ“ä½œé‡æ”¾ä¸€éï¼Œæ¥å®ç°æ•°æ®çš„æ¢å¤ã€‚binlog çš„å¦ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯ç”¨æ¥å®ç°ä¸»ä»å¤åˆ¶ï¼Œå®ƒçš„åŸç†å°±æ˜¯ä»æœåŠ¡å™¨è¯»å–ä¸»æœåŠ¡å™¨çš„ binlogï¼Œç„¶åæ‰§è¡Œä¸€éã€‚â€‹ æœ‰äº†è¿™ä¸¤ä¸ªæ—¥å¿—ä¹‹åï¼Œæ¥çœ‹ä¸€ä¸‹ä¸€æ¡æ›´æ–°è¯­å¥æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼šâ€‹ 12# id =1 çš„è®°å½•åŸ name = &#x27;yhd&#x27;update user set name = &#x27;äºŒå&#x27; where id=1; â€‹ äº‹åŠ¡å¼€å§‹ï¼Œä»å†…å­˜æˆ–è€…ç£ç›˜å–åˆ°è¿™æ¡æ•°æ®æ‰€åœ¨çš„æ•°æ®é¡µï¼Œè¿”å›ç»™serverçš„æ‰§è¡Œå™¨ æ‰§è¡Œå™¨ä¿®æ”¹è¿™ä¸€è¡Œæ•°æ®çš„å€¼ä¸ºäºŒå è®°å½•name =yhd åˆ°undo log åœ¨buffer pool ä¸­ä¿®æ”¹ name =äºŒåï¼Œæ­¤æ—¶è¯¥é¡µå˜æˆè„é¡µ è®°å½•name = äºŒå åˆ°redo log bufferï¼Œredo log bufferæ¯ç§’åˆ·ç›˜ã€‚ redo log è¿›å…¥prepareçŠ¶æ€ï¼Œç„¶åå‘Šè¯‰æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œå®Œæˆäº†ï¼Œå¯ä»¥éšæ—¶æäº¤ å†™å…¥binlog äº‹åŠ¡æäº¤ï¼Œå¹¶å›å†™æœ€ç»ˆçŠ¶æ€åˆ°redo logé‡Œï¼Œä»£è¡¨è¯¥äº‹åŠ¡å·²ç»æäº¤ â€‹ äº‹åŠ¡å¼€å§‹ä¹‹åå°±äº§ç”Ÿredo logï¼Œredo logçš„è½ç›˜å¹¶ä¸æ˜¯éšç€äº‹åŠ¡çš„æäº¤æ‰å†™å…¥çš„ï¼Œè€Œæ˜¯åœ¨äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¾¿ä¸æ–­å†™å…¥redo logæ–‡ä»¶ä¸­ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯æ¬¡äº‹åŠ¡commitæ—¶ï¼Œå¿…é¡»è°ƒç”¨ fsync æ“ä½œï¼Œå°†redoæ—¥å¿—ç¼“å†²åŒæ­¥å†™åˆ°ç£ç›˜ã€‚å¦å¤–ï¼Œæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶åŒæ­¥å†™åˆ°ç£ç›˜bin logä¸­ã€‚ é‚£ä¹ˆå°±æœ‰äº†ä¸€ä¸ªè°å…ˆè°åçš„é—®é¢˜ï¼šredo log å…ˆï¼Œbin log åã€‚ ä¸¤é˜¶æ®µæäº¤çš„å†…å®¹ï¼š**äº‹åŠ¡æäº¤æ—¶ï¼Œredo logå¤„äº preçŠ¶æ€ -&gt; å†™å…¥bin log -&gt; äº‹åŠ¡çœŸæ­£æäº¤ã€‚ ** å½“å‘ç”Ÿå´©æºƒæ¢å¤æ—¶ï¼ŒæŸ¥çœ‹çš„æ˜¯bin logæ˜¯å¦å®Œæ•´ï¼Œå¦‚æœbin logå®Œæ•´ï¼Œåˆ™ä»£è¡¨äº‹åŠ¡å·²ç»æäº¤ã€‚ å¦‚æœåœ¨ä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹ä¸­ï¼Œbin logå†™å…¥å¤±è´¥ï¼Œåˆ™äº‹åŠ¡æ— æ³•ç»ˆæ­¢æäº¤ï¼Œå´©æºƒæ¢å¤æ—¶å°±ä¸éœ€è¦é‡åšã€‚å¦‚æœbin logå†™å®Œçš„ä¸€ç¬é—´ï¼ŒæœåŠ¡å™¨å®•æœºäº†ï¼Œäº‹åŠ¡éƒ½æ¥ä¸åŠæäº¤ï¼Œæ­¤æ—¶bin logå¹¶ä¸æ˜¯å®Œæ•´çš„ï¼Œç¼ºå°‘äº†æœ€ç»ˆçš„commitæ ‡è®°ã€‚å› æ­¤ä¹Ÿæ˜¯æäº¤å¤±è´¥ã€‚ ç®€å•è¯´ï¼Œredo logå’Œbin logéƒ½å¯ä»¥ç”¨äºè¡¨ç¤ºäº‹åŠ¡çš„æäº¤çŠ¶æ€ï¼Œè€Œä¸¤é˜¶æ®µæäº¤å°±æ˜¯è®©è¿™ä¸¤ä¸ªçŠ¶æ€ä¿æŒé€»è¾‘ä¸Šçš„ä¸€è‡´ã€‚ ä¸‰ï¼ŒMySQLä¸­æ”¯æŒçš„å­—ç¬¦é›†å’Œæ’åºè§„åˆ™1.MySQLä¸­çš„utf8å’Œutf8mb4utf8å­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦éœ€è¦ä½¿ç”¨1ï½4ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€äº›å­—ç¬¦ä½¿ç”¨1ï½3ä¸ªå­—èŠ‚å°±å¯ä»¥è¡¨ç¤ºäº†ã€‚è€Œåœ¨MySQLä¸­å­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æ‰€ç”¨æœ€å¤§å­—èŠ‚é•¿åº¦åœ¨æŸäº›æ–¹é¢ä¼šå½±å“ç³»ç»Ÿçš„å­˜å‚¨å’Œæ€§èƒ½ï¼Œæ‰€ä»¥è®¾è®¡MySQLçš„å¤§å”å·å·çš„å®šä¹‰äº†ä¸¤ä¸ªæ¦‚å¿µï¼š utf8mb3ï¼šé˜‰å‰²è¿‡çš„utf8å­—ç¬¦é›†ï¼Œåªä½¿ç”¨1ï½3ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ã€‚ utf8mb4ï¼šæ­£å®—çš„utf8å­—ç¬¦é›†ï¼Œä½¿ç”¨1ï½4ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ã€‚ åœ¨MySQLä¸­utf8æ˜¯utf8mb3çš„åˆ«åï¼Œæ‰€ä»¥ä¹‹ååœ¨MySQLä¸­æåˆ°utf8å°±æ„å‘³ç€ä½¿ç”¨1~3ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœæœ‰ä½¿ç”¨4å­—èŠ‚ç¼–ç ä¸€ä¸ªå­—ç¬¦çš„æƒ…å†µï¼Œæ¯”å¦‚å­˜å‚¨ä¸€äº›emojiè¡¨æƒ…å•¥çš„ï¼Œé‚£è¯·ä½¿ç”¨utf8mb4ã€‚ æŸ¥çœ‹å­—ç¬¦é›†ï¼šSHOW (CHARACTER SET|CHARSET)ã€‚ 2.å­—ç¬¦é›†&amp;æ¯”è¾ƒè§„åˆ™çš„åº”ç”¨2.1 å„çº§åˆ«çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™MySQLæœ‰4ä¸ªçº§åˆ«çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œåˆ†åˆ«æ˜¯ï¼š æœåŠ¡å™¨çº§åˆ« æ•°æ®åº“çº§åˆ« è¡¨çº§åˆ« åˆ—çº§åˆ« æ¥ä¸‹æ¥ä»”ç»†çœ‹ä¸€ä¸‹æ€ä¹ˆè®¾ç½®å’ŒæŸ¥çœ‹è¿™å‡ ä¸ªçº§åˆ«çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ã€‚ æœåŠ¡å™¨çº§åˆ«123456789101112131415mysql&gt; SHOW VARIABLES LIKE &#x27;character_set_server&#x27;;+----------------------+-------+| Variable_name | Value |+----------------------+-------+| character_set_server | utf8 |+----------------------+-------+1 row in set (0.00 sec)mysql&gt; SHOW VARIABLES LIKE &#x27;collation_server&#x27;;+------------------+-----------------+| Variable_name | Value |+------------------+-----------------+| collation_server | utf8_general_ci |+------------------+-----------------+1 row in set (0.00 sec) å¯ä»¥åœ¨å¯åŠ¨æœåŠ¡å™¨ç¨‹åºæ—¶é€šè¿‡å¯åŠ¨é€‰é¡¹æˆ–è€…åœ¨æœåŠ¡å™¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨SETè¯­å¥ä¿®æ”¹è¿™ä¸¤ä¸ªå˜é‡çš„å€¼ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è¿™æ ·å†™ï¼š 123[server]character_set_server=gbkcollation_server=gbk_chinese_ci å½“æœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™è¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶åè¿™ä¸¤ä¸ªç³»ç»Ÿå˜é‡çš„å€¼ä¾¿ä¿®æ”¹äº†ã€‚ æ•°æ®åº“çº§åˆ«æˆ‘ä»¬åœ¨åˆ›å»ºå’Œä¿®æ”¹æ•°æ®åº“çš„æ—¶å€™å¯ä»¥æŒ‡å®šè¯¥æ•°æ®åº“çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œå…·ä½“è¯­æ³•å¦‚ä¸‹ï¼š 1234567CREATE DATABASE æ•°æ®åº“å [[DEFAULT] CHARACTER SET å­—ç¬¦é›†åç§°] [[DEFAULT] COLLATE æ¯”è¾ƒè§„åˆ™åç§°];ALTER DATABASE æ•°æ®åº“å [[DEFAULT] CHARACTER SET å­—ç¬¦é›†åç§°] [[DEFAULT] COLLATE æ¯”è¾ƒè§„åˆ™åç§°]; å…¶ä¸­çš„DEFAULTå¯ä»¥çœç•¥ï¼Œå¹¶ä¸å½±å“è¯­å¥çš„è¯­ä¹‰ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æ–°åˆ›å»ºä¸€ä¸ªåå«charset_demo_dbçš„æ•°æ®åº“ï¼Œåœ¨åˆ›å»ºçš„æ—¶å€™æŒ‡å®šå®ƒä½¿ç”¨çš„å­—ç¬¦é›†ä¸ºgb2312ï¼Œæ¯”è¾ƒè§„åˆ™ä¸ºgb2312_chinese_ciï¼š 1234mysql&gt; CREATE DATABASE charset_demo_db -&gt; CHARACTER SET gb2312 -&gt; COLLATE gb2312_chinese_ci;Query OK, 1 row affected (0.01 sec) æŸ¥çœ‹ 1234567891011121314151617181920mysql&gt; USE charset_demo_db;Database changedmysql&gt; SHOW VARIABLES LIKE &#x27;character_set_database&#x27;;+------------------------+--------+| Variable_name | Value |+------------------------+--------+| character_set_database | gb2312 |+------------------------+--------+1 row in set (0.00 sec)mysql&gt; SHOW VARIABLES LIKE &#x27;collation_database&#x27;;+--------------------+-------------------+| Variable_name | Value |+--------------------+-------------------+| collation_database | gb2312_chinese_ci |+--------------------+-------------------+1 row in set (0.00 sec)mysql&gt; å¯ä»¥çœ‹åˆ°è¿™ä¸ªcharset_demo_dbæ•°æ®åº“çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™å°±æ˜¯æˆ‘ä»¬åœ¨åˆ›å»ºè¯­å¥ä¸­æŒ‡å®šçš„ã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼š character_set_database å’Œ _collation_database_ è¿™ä¸¤ä¸ªç³»ç»Ÿå˜é‡æ˜¯åªè¯»çš„ï¼Œæˆ‘ä»¬ä¸èƒ½é€šè¿‡ä¿®æ”¹è¿™ä¸¤ä¸ªå˜é‡çš„å€¼è€Œæ”¹å˜å½“å‰æ•°æ®åº“çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ã€‚ è¡¨çº§åˆ«æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºå’Œä¿®æ”¹è¡¨çš„æ—¶å€™æŒ‡å®šè¡¨çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š 1234567CREATE TABLE è¡¨å (åˆ—çš„ä¿¡æ¯) [[DEFAULT] CHARACTER SET å­—ç¬¦é›†åç§°] [COLLATE æ¯”è¾ƒè§„åˆ™åç§°]]ALTER TABLE è¡¨å [[DEFAULT] CHARACTER SET å­—ç¬¦é›†åç§°] [COLLATE æ¯”è¾ƒè§„åˆ™åç§°] æ¯”æ–¹è¯´æˆ‘ä»¬åœ¨åˆšåˆšåˆ›å»ºçš„charset_demo_dbæ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºtçš„è¡¨ï¼Œå¹¶æŒ‡å®šè¿™ä¸ªè¡¨çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼š 1234mysql&gt; CREATE TABLE t( -&gt; col VARCHAR(10) -&gt; ) CHARACTER SET utf8 COLLATE utf8_general_ci;Query OK, 0 rows affected (0.03 sec) å¦‚æœåˆ›å»ºå’Œä¿®æ”¹è¡¨çš„è¯­å¥ä¸­æ²¡æœ‰æŒ‡æ˜å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œå°†ä½¿ç”¨è¯¥è¡¨æ‰€åœ¨æ•°æ®åº“çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ä½œä¸ºè¯¥è¡¨çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ã€‚ åˆ—çº§åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºå­˜å‚¨å­—ç¬¦ä¸²çš„åˆ—ï¼ŒåŒä¸€ä¸ªè¡¨ä¸­çš„ä¸åŒçš„åˆ—ä¹Ÿå¯ä»¥æœ‰ä¸åŒçš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ã€‚æˆ‘ä»¬åœ¨åˆ›å»ºå’Œä¿®æ”¹åˆ—å®šä¹‰çš„æ—¶å€™å¯ä»¥æŒ‡å®šè¯¥åˆ—çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š 123456CREATE TABLE è¡¨å( åˆ—å å­—ç¬¦ä¸²ç±»å‹ [CHARACTER SET å­—ç¬¦é›†åç§°] [COLLATE æ¯”è¾ƒè§„åˆ™åç§°], å…¶ä»–åˆ—...);ALTER TABLE è¡¨å MODIFY åˆ—å å­—ç¬¦ä¸²ç±»å‹ [CHARACTER SET å­—ç¬¦é›†åç§°] [COLLATE æ¯”è¾ƒè§„åˆ™åç§°]; æ¯”å¦‚æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹è¡¨tä¸­åˆ—colçš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™å¯ä»¥è¿™ä¹ˆå†™ï¼š 12345mysql&gt; ALTER TABLE t MODIFY col VARCHAR(10) CHARACTER SET gbk COLLATE gbk_chinese_ci;Query OK, 0 rows affected (0.04 sec)Records: 0 Duplicates: 0 Warnings: 0mysql&gt; å¯¹äºæŸä¸ªåˆ—æ¥è¯´ï¼Œå¦‚æœåœ¨åˆ›å»ºå’Œä¿®æ”¹çš„è¯­å¥ä¸­æ²¡æœ‰æŒ‡æ˜å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œå°†ä½¿ç”¨è¯¥åˆ—æ‰€åœ¨è¡¨çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ä½œä¸ºè¯¥åˆ—çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ã€‚ åœ¨è½¬æ¢åˆ—çš„å­—ç¬¦é›†æ—¶éœ€è¦æ³¨æ„ï¼Œå¦‚æœè½¬æ¢å‰åˆ—ä¸­å­˜å‚¨çš„æ•°æ®ä¸èƒ½ç”¨è½¬æ¢åçš„å­—ç¬¦é›†è¿›è¡Œè¡¨ç¤ºä¼šå‘ç”Ÿé”™è¯¯ã€‚æ¯”æ–¹è¯´åŸå…ˆåˆ—ä½¿ç”¨çš„å­—ç¬¦é›†æ˜¯utf8ï¼Œåˆ—ä¸­å­˜å‚¨äº†ä¸€äº›æ±‰å­—ï¼Œç°åœ¨æŠŠåˆ—çš„å­—ç¬¦é›†è½¬æ¢ä¸ºasciiçš„è¯å°±ä¼šå‡ºé”™ï¼Œå› ä¸ºasciiå­—ç¬¦é›†å¹¶ä¸èƒ½è¡¨ç¤ºæ±‰å­—å­—ç¬¦ã€‚ 2.2 å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šä¿¡ä¸­çš„å­—ç¬¦é›†ç¼–ç å’Œè§£ç ä½¿ç”¨çš„å­—ç¬¦é›†ä¸ä¸€è‡´çš„åæœå¦‚æœå¯¹äºåŒä¸€ä¸ªå­—ç¬¦ä¸²ç¼–ç å’Œè§£ç ä½¿ç”¨çš„å­—ç¬¦é›†ä¸ä¸€æ ·ï¼Œä¼šäº§ç”Ÿæ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œä½œä¸ºäººç±»çš„æˆ‘ä»¬çœ‹ä¸Šå»å°±åƒæ˜¯äº§ç”Ÿäº†ä¹±ç ä¸€æ ·ã€‚ ä»å‘é€è¯·æ±‚åˆ°æ¥æ”¶ç»“æœè¿‡ç¨‹ä¸­å‘ç”Ÿçš„å­—ç¬¦é›†è½¬æ¢ å®¢æˆ·ç«¯ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å­—ç¬¦é›†ç¼–ç è¯·æ±‚å­—ç¬¦ä¸²ï¼Œå‘æœåŠ¡å™¨å‘é€çš„æ˜¯ç»è¿‡ç¼–ç çš„ä¸€ä¸ªå­—èŠ‚ä¸²ã€‚ æœåŠ¡å™¨å°†å®¢æˆ·ç«¯å‘é€æ¥çš„å­—èŠ‚ä¸²é‡‡ç”¨character_set_clientä»£è¡¨çš„å­—ç¬¦é›†è¿›è¡Œè§£ç ï¼Œå°†è§£ç åçš„å­—ç¬¦ä¸²å†æŒ‰ç…§character_set_connectionä»£è¡¨çš„å­—ç¬¦é›†è¿›è¡Œç¼–ç ã€‚ å¦‚æœcharacter_set_connectionä»£è¡¨çš„å­—ç¬¦é›†å’Œå…·ä½“æ“ä½œçš„åˆ—ä½¿ç”¨çš„å­—ç¬¦é›†ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿›è¡Œç›¸åº”æ“ä½œï¼Œå¦åˆ™çš„è¯éœ€è¦å°†è¯·æ±‚ä¸­çš„å­—ç¬¦ä¸²ä»character_set_connectionä»£è¡¨çš„å­—ç¬¦é›†è½¬æ¢ä¸ºå…·ä½“æ“ä½œçš„åˆ—ä½¿ç”¨çš„å­—ç¬¦é›†ä¹‹åå†è¿›è¡Œæ“ä½œã€‚ å°†ä»æŸä¸ªåˆ—è·å–åˆ°çš„å­—èŠ‚ä¸²ä»è¯¥åˆ—ä½¿ç”¨çš„å­—ç¬¦é›†è½¬æ¢ä¸ºcharacter_set_resultsä»£è¡¨çš„å­—ç¬¦é›†åå‘é€åˆ°å®¢æˆ·ç«¯ã€‚ å®¢æˆ·ç«¯ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å­—ç¬¦é›†è§£ææ”¶åˆ°çš„ç»“æœé›†å­—èŠ‚ä¸²ã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å„ä¸ªç³»ç»Ÿå˜é‡çš„å«ä¹‰å¦‚ä¸‹ï¼š ç³»ç»Ÿå˜é‡ æè¿° character_set_client æœåŠ¡å™¨è§£ç è¯·æ±‚æ—¶ä½¿ç”¨çš„å­—ç¬¦é›† character_set_connection æœåŠ¡å™¨å¤„ç†è¯·æ±‚æ—¶ä¼šæŠŠè¯·æ±‚å­—ç¬¦ä¸²ä»character_set_clientè½¬ä¸ºcharacter_set_connection character_set_results æœåŠ¡å™¨å‘å®¢æˆ·ç«¯è¿”å›æ•°æ®æ—¶ä½¿ç”¨çš„å­—ç¬¦é›† ä¸€èˆ¬æƒ…å†µä¸‹è¦ä½¿ç”¨ä¿æŒè¿™ä¸‰ä¸ªå˜é‡çš„å€¼å’Œå®¢æˆ·ç«¯ä½¿ç”¨çš„å­—ç¬¦é›†ç›¸åŒã€‚ æ¯”è¾ƒè§„åˆ™çš„ä½œç”¨é€šå¸¸ä½“ç°æ¯”è¾ƒå­—ç¬¦ä¸²å¤§å°çš„è¡¨è¾¾å¼ä»¥åŠå¯¹æŸä¸ªå­—ç¬¦ä¸²åˆ—è¿›è¡Œæ’åºä¸­ã€‚â€‹","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"ConcurrentHashMapæºç è§£è¯»","slug":"1.åŸºç¡€çŸ¥è¯†/ConcurrentHashMap","date":"2022-01-05T12:23:06.000Z","updated":"2022-01-05T12:23:06.000Z","comments":true,"path":"2022/01/05/1.åŸºç¡€çŸ¥è¯†/ConcurrentHashMap/","link":"","permalink":"https://yinhuidong.github.io/2022/01/05/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ConcurrentHashMap/","excerpt":"","text":"#1.æˆå‘˜å˜é‡ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147//æ•£åˆ—è¡¨æ•°ç»„çš„æœ€å¤§é™åˆ¶private static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;//æ•£åˆ—è¡¨é»˜è®¤å€¼private static final int DEFAULT_CAPACITY = 16;static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;//å¹¶å‘çº§åˆ«ï¼šjdk7å†å²é—ç•™é—®é¢˜ï¼Œä»…ä»…åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨åˆ°ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„ä»£è¡¨å¹¶å‘çº§åˆ«private static final int DEFAULT_CONCURRENCY_LEVEL = 16;//è´Ÿè½½å› å­ï¼ŒJDK1.8ä¸­ ConcurrentHashMap æ˜¯å›ºå®šå€¼private static final float LOAD_FACTOR = 0.75f;//æ ‘åŒ–é˜ˆå€¼ï¼ŒæŒ‡å®šæ¡¶ä½ é“¾è¡¨é•¿åº¦è¾¾åˆ°8çš„è¯ï¼Œæœ‰å¯èƒ½å‘ç”Ÿæ ‘åŒ–æ“ä½œã€‚static final int TREEIFY_THRESHOLD = 8;//çº¢é»‘æ ‘è½¬åŒ–ä¸ºé“¾è¡¨çš„é˜ˆå€¼static final int UNTREEIFY_THRESHOLD = 6;//è”åˆTREEIFY_THRESHOLDæ§åˆ¶æ¡¶ä½æ˜¯å¦æ ‘åŒ–ï¼Œåªæœ‰å½“tableæ•°ç»„é•¿åº¦è¾¾åˆ°64ä¸” æŸä¸ªæ¡¶ä½ ä¸­çš„é“¾è¡¨é•¿åº¦è¾¾åˆ°8ï¼Œæ‰ä¼šçœŸæ­£æ ‘åŒ–static final int MIN_TREEIFY_CAPACITY = 64;//çº¿ç¨‹è¿ç§»æ•°æ®æœ€å°æ­¥é•¿ï¼Œæ§åˆ¶çº¿ç¨‹è¿ç§»ä»»åŠ¡æœ€å°åŒºé—´ä¸€ä¸ªå€¼private static final int MIN_TRANSFER_STRIDE = 16;//è®¡ç®—æ‰©å®¹æ—¶å€™ç”Ÿæˆçš„ä¸€ä¸ª æ ‡è¯†æˆ³private static int RESIZE_STAMP_BITS = 16;//ç»“æœæ˜¯65535 è¡¨ç¤ºå¹¶å‘æ‰©å®¹æœ€å¤šçº¿ç¨‹æ•°private static final int MAX_RESIZERS = (1 &lt;&lt; (32 - RESIZE_STAMP_BITS)) - 1;//æ‰©å®¹ç›¸å…³private static final int RESIZE_STAMP_SHIFT = 32 - RESIZE_STAMP_BITS;//å½“nodeèŠ‚ç‚¹hash=-1 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»è¢«è¿ç§»äº† ï¼ŒfwdèŠ‚ç‚¹static final int MOVED = -1; // hash for forwarding nodes//node hash=-2 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»æ ‘åŒ– ä¸” å½“å‰èŠ‚ç‚¹ä¸ºtreebinå¯¹è±¡ ï¼Œä»£ç†æ“ä½œçº¢é»‘æ ‘static final int TREEBIN = -2; // hash for roots of treesstatic final int RESERVED = -3; // hash for transient reservations//è½¬åŒ–æˆäºŒè¿›åˆ¶å®é™…ä¸Šæ˜¯ 31ä¸ª 1 å¯ä»¥å°†ä¸€ä¸ªè´Ÿæ•°é€šè¿‡ä½ç§»è¿ç®—å¾—åˆ°ä¸€ä¸ªæ­£æ•°static final int HASH_BITS = 0x7fffffff; // usable bits of normal node hash//å½“å‰ç³»ç»Ÿçš„cpuæ•°é‡static final int NCPU = Runtime.getRuntime().availableProcessors();//ä¸ºäº†å…¼å®¹7ç‰ˆæœ¬çš„chpä¿å­˜çš„ï¼Œæ ¸å¿ƒä»£ç å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°private static final ObjectStreamField[] serialPersistentFields = &#123; new ObjectStreamField(&quot;segments&quot;, Segment[].class), new ObjectStreamField(&quot;segmentMask&quot;, Integer.TYPE), new ObjectStreamField(&quot;segmentShift&quot;, Integer.TYPE) &#125;;//æ•£åˆ—è¡¨ï¼Œé•¿åº¦ä¸€å®šæ˜¯2æ¬¡æ–¹æ•°transient volatile Node&lt;K,V&gt;[] table;//æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œä¼šå°†æ‰©å®¹ä¸­çš„æ–°table èµ‹å€¼ç»™nextTable ä¿æŒå¼•ç”¨ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œè¿™é‡Œä¼šè¢«è®¾ç½®ä¸ºNullprivate transient volatile Node&lt;K,V&gt;[] nextTable;//LongAdder ä¸­çš„ baseCount æœªå‘ç”Ÿç«äº‰æ—¶ æˆ–è€… å½“å‰LongAdderå¤„äºåŠ é”çŠ¶æ€æ—¶ï¼Œå¢é‡ç´¯åˆ°åˆ°baseCountä¸­private transient volatile long baseCount;/** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private transient volatile int sizeCtl;/** * * æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œè®°å½•å½“å‰è¿›åº¦ã€‚æ‰€æœ‰çº¿ç¨‹éƒ½éœ€è¦ä»transferIndexä¸­åˆ†é…åŒºé—´ä»»åŠ¡ï¼Œå»æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ã€‚ */private transient volatile int transferIndex;/** * LongAdderä¸­çš„cellsBuzy 0è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡æ— é”çŠ¶æ€ï¼Œ1è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡åŠ é”çŠ¶æ€ */private transient volatile int cellsBusy;/** * LongAdderä¸­çš„cellsæ•°ç»„ï¼Œå½“baseCountå‘ç”Ÿç«äº‰åï¼Œä¼šåˆ›å»ºcellsæ•°ç»„ï¼Œ * çº¿ç¨‹ä¼šé€šè¿‡è®¡ç®—hashå€¼ å–åˆ° è‡ªå·±çš„cell ï¼Œå°†å¢é‡ç´¯åŠ åˆ°æŒ‡å®šcellä¸­ * æ€»æ•° = sum(cells) + baseCount */private transient volatile CounterCell[] counterCells;// Unsafe mechanicsprivate static final sun.misc.Unsafe U;/**è¡¨ç¤ºsizeCtlå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long SIZECTL;/**è¡¨ç¤ºtransferIndexå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long TRANSFERINDEX;/**è¡¨ç¤ºbaseCountå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long BASECOUNT;/**è¡¨ç¤ºcellsBusyå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLSBUSY;/**è¡¨ç¤ºcellValueå±æ€§åœ¨CounterCellä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLVALUE;/**è¡¨ç¤ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€*/private static final long ABASE;private static final int ASHIFT;static &#123; try &#123; U = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = ConcurrentHashMap.class; SIZECTL = U.objectFieldOffset (k.getDeclaredField(&quot;sizeCtl&quot;)); TRANSFERINDEX = U.objectFieldOffset (k.getDeclaredField(&quot;transferIndex&quot;)); BASECOUNT = U.objectFieldOffset (k.getDeclaredField(&quot;baseCount&quot;)); CELLSBUSY = U.objectFieldOffset (k.getDeclaredField(&quot;cellsBusy&quot;)); Class&lt;?&gt; ck = CounterCell.class; CELLVALUE = U.objectFieldOffset (ck.getDeclaredField(&quot;value&quot;)); Class&lt;?&gt; ak = Node[].class; ABASE = U.arrayBaseOffset(ak); //è¡¨ç¤ºæ•°ç»„å•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°,scale è¡¨ç¤ºNode[]æ•°ç»„ä¸­æ¯ä¸€ä¸ªå•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å° int scale = U.arrayIndexScale(ak); //1 0000 &amp; 0 1111 = 0 if ((scale &amp; (scale - 1)) != 0) throw new Error(&quot;data type scale not a power of two&quot;); //numberOfLeadingZeros() è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›å½“å‰æ•°å€¼è½¬æ¢ä¸ºäºŒè¿›åˆ¶åï¼Œä»é«˜ä½åˆ°ä½ä½å¼€å§‹ç»Ÿè®¡ï¼Œçœ‹æœ‰å¤šå°‘ä¸ª0è¿ç»­åœ¨ä¸€å—ã€‚ //8 =&gt; 1000 numberOfLeadingZeros(8) = 28 //4 =&gt; 100 numberOfLeadingZeros(4) = 29 //ASHIFT = 31 - 29 = 2 ï¼Ÿï¼Ÿ //ABASE + ï¼ˆ5 &lt;&lt; ASHIFTï¼‰ ASHIFT = 31 - Integer.numberOfLeadingZeros(scale); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125; #2.åŸºç¡€æ–¹æ³•##2.1 spreadé«˜ä½è¿ç®— 123static final int spread(int h) &#123; return (h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS;&#125; ##2.2 tabAtè¯¥æ–¹æ³•è·å–å¯¹è±¡ä¸­offsetåç§»åœ°å€å¯¹åº”çš„å¯¹è±¡fieldçš„å€¼ã€‚å®é™…ä¸Šè¿™æ®µä»£ç çš„å«ä¹‰ç­‰ä»·äºtab[i],ä½†æ˜¯ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ tab[i]æ¥è®¡ç®—å‘¢ï¼Ÿ getObjectVolatileï¼Œä¸€æ—¦çœ‹åˆ° volatile å…³é”®å­—ï¼Œå°±è¡¨ç¤ºå¯è§æ€§ã€‚å› ä¸ºå¯¹ volatile å†™æ“ä½œ happen-before äº volatile è¯»æ“ä½œï¼Œå› æ­¤å…¶ä»–çº¿ç¨‹å¯¹ table çš„ä¿®æ”¹å‡å¯¹ get è¯»å–å¯è§ï¼› è™½ç„¶ table æ•°ç»„æœ¬èº«æ˜¯å¢åŠ äº† volatile å±æ€§ï¼Œä½†æ˜¯â€œvolatile çš„æ•°ç»„åªé’ˆå¯¹æ•°ç»„çš„å¼•ç”¨å…·æœ‰volatile çš„è¯­ä¹‰ï¼Œè€Œä¸æ˜¯å®ƒçš„å…ƒç´ â€ã€‚ æ‰€ä»¥å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å¯¹è¿™ä¸ªæ•°ç»„çš„å…ƒç´ è¿›è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æ¥è¯»çš„æ—¶å€™ä¸ä¸€å®šèƒ½è¯»åˆ°æœ€æ–°çš„å€¼ã€‚å‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒDoug Lea ç›´æ¥é€šè¿‡ Unsafe ç±»æ¥å¯¹ table è¿›è¡Œæ“ä½œã€‚ 123static final &lt;K,V&gt; Node&lt;K,V&gt; tabAt(Node&lt;K,V&gt;[] tab, int i) &#123; return (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE);&#125; ##2.3 casTabAtcasè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºæ¡¶ä½çš„å¤´èŠ‚ç‚¹ 1234static final &lt;K,V&gt; boolean casTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v) &#123; return U.compareAndSwapObject(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, c, v);&#125; ##2.4 setTabAt 123static final &lt;K,V&gt; void setTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; v) &#123; U.putObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, v);&#125; ##2.5 resizeStampresizeStamp ç”¨æ¥ç”Ÿæˆä¸€ä¸ªå’Œæ‰©å®¹æœ‰å…³çš„æ‰©å®¹æˆ³ï¼Œå…·ä½“æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ 123static final int resizeStamp(int n) &#123; return Integer.numberOfLeadingZeros(n) | (1 &lt;&lt; (RESIZE_STAMP_BITS - 1));&#125; Integer.numberOfLeadingZeros è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›æ— ç¬¦å·æ•´æ•° n æœ€é«˜ä½é 0 ä½å‰é¢çš„ 0 çš„ä¸ªæ•°ã€‚ æ¯”å¦‚ 10 çš„äºŒè¿›åˆ¶æ˜¯ 0000 0000 0000 0000 0000 0000 0000 1010ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•è¿”å›çš„å€¼å°±æ˜¯ 28ã€‚ æ ¹æ® resizeStamp çš„è¿ç®—é€»è¾‘ï¼Œæˆ‘ä»¬æ¥æ¨æ¼”ä¸€ä¸‹ï¼Œå‡å¦‚ n=16ï¼Œé‚£ä¹ˆ resizeStamp(16)=32796è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ˜¯[0000 0000 0000 0000 1000 0000 0001 1100] æ¥ç€å†æ¥çœ‹,å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸‹é¢è¿™æ®µä»£ç ï¼š U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)rs å·¦ç§» 16 ä½ï¼Œç›¸å½“äºåŸæœ¬çš„äºŒè¿›åˆ¶ä½ä½å˜æˆäº†é«˜ä½ 1000 0000 0001 1100 0000 0000 00000000 ç„¶åå†+2 =1000 0000 0001 1100 0000 0000 0000 0000+10=1000 0000 0001 1100 0000 00000000 0010 é«˜ 16 ä½ä»£è¡¨æ‰©å®¹çš„æ ‡è®°ã€ä½ 16 ä½ä»£è¡¨å¹¶è¡Œæ‰©å®¹çš„çº¿ç¨‹æ•° è¿™æ ·æ¥å­˜å‚¨æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ 1ï¼Œé¦–å…ˆåœ¨ CHM ä¸­æ˜¯æ”¯æŒå¹¶å‘æ‰©å®¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå½“å‰çš„æ•°ç»„éœ€è¦è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹æ¥å…±åŒè´Ÿè´£ 2ï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡æ‰©å®¹éƒ½ç”Ÿæˆå”¯ä¸€çš„ç”Ÿæˆæˆ³ï¼Œæ¯æ¬¡æ–°çš„æ‰©å®¹ï¼Œéƒ½æœ‰ä¸€ä¸ªä¸åŒçš„ nï¼Œè¿™ä¸ªç”Ÿæˆæˆ³å°±æ˜¯æ ¹æ® n æ¥è®¡ç®—å‡ºæ¥çš„ä¸€ä¸ªæ•°å­—ï¼Œn ä¸åŒï¼Œè¿™ä¸ªæ•°å­—ä¹Ÿä¸åŒ ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•æ‰©å®¹çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆæ˜¯+2 å› ä¸º 1 è¡¨ç¤ºåˆå§‹åŒ–ï¼Œ2 è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹ï¼Œè€Œä¸”å¯¹ sizeCtl çš„æ“ä½œéƒ½æ˜¯åŸºäºä½è¿ç®—çš„ï¼Œæ‰€ä»¥ä¸ä¼šå…³å¿ƒå®ƒæœ¬èº«çš„æ•°å€¼æ˜¯å¤šå°‘ï¼Œåªå…³å¿ƒå®ƒåœ¨äºŒè¿›åˆ¶ä¸Šçš„æ•°å€¼ï¼Œè€Œ sc + 1 ä¼šåœ¨ä½ 16 ä½ä¸ŠåŠ  1ã€‚##2.6 tableSizeForç»è¿‡å¤šæ¬¡ä½ç§»è¿”å›å¤§äºç­‰äºcçš„æœ€å°çš„äºŒæ¬¡æ–¹æ•° 1234567891011121314151617181920 /** * Returns a power of two table size for the given desired capacity. * See Hackers Delight, sec 3.2 * è¿”å›&gt;=cçš„æœ€å°çš„2çš„æ¬¡æ–¹æ•° * c=28 * n=27 =&gt; 0b 11011 * 11011 | 01101 =&gt; 11111 * 11111 | 00111 =&gt; 11111 * .... * =&gt; 11111 + 1 =100000 = 32 */private static final int tableSizeFor(int c) &#123; int n = c - 1; n |= n &gt;&gt;&gt; 1; n |= n &gt;&gt;&gt; 2; n |= n &gt;&gt;&gt; 4; n |= n &gt;&gt;&gt; 8; n |= n &gt;&gt;&gt; 16; return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;&#125; #3. æ„é€ æ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public ConcurrentHashMap() &#123;&#125;public ConcurrentHashMap(int initialCapacity) &#123; if (initialCapacity &lt; 0) throw new IllegalArgumentException(); //å¦‚æœæŒ‡å®šçš„å®¹é‡è¶…è¿‡å…è®¸çš„æœ€å¤§å€¼ï¼Œè®¾ç½®ä¸ºæœ€å¤§å€¼ int cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ? MAXIMUM_CAPACITY : tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; 1) + 1)); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125;public ConcurrentHashMap(Map&lt;? extends K, ? extends V&gt; m) &#123; this.sizeCtl = DEFAULT_CAPACITY; putAll(m);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor) &#123; this(initialCapacity, loadFactor, 1);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) &#123; //å‚æ•°æ ¡éªŒ if (!(loadFactor &gt; 0.0f) || initialCapacity &lt; 0 || concurrencyLevel &lt;= 0) throw new IllegalArgumentException(); //å¦‚æœåˆå§‹å®¹é‡å°äºå¹¶å‘çº§åˆ«ï¼Œé‚£å°±è®¾ç½®åˆå§‹å®¹é‡ä¸ºå¹¶å‘çº§åˆ« if (initialCapacity &lt; concurrencyLevel) initialCapacity = concurrencyLevel; //16/0.75 +1 = 22 long size = (long)(1.0 + (long)initialCapacity / loadFactor); // 22 - &gt; 32 int cap = (size &gt;= (long)MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : tableSizeFor((int)size); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125; #4.put 1234public V put(K key, V value) &#123; //å¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Œé»˜è®¤æ˜¯false return putVal(key, value, false);&#125; #5 putVal 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129final V putVal(K key, V value, boolean onlyIfAbsent) &#123; //æ§åˆ¶k å’Œ v ä¸èƒ½ä¸ºnull if (key == null || value == null) throw new NullPointerException(); //é€šè¿‡spreadæ–¹æ³•ï¼Œå¯ä»¥è®©é«˜ä½ä¹Ÿèƒ½å‚ä¸è¿›å¯»å€è¿ç®—ã€‚ int hash = spread(key.hashCode()); //binCountè¡¨ç¤ºå½“å‰k-v å°è£…æˆnodeåæ’å…¥åˆ°æŒ‡å®šæ¡¶ä½åï¼Œåœ¨æ¡¶ä½ä¸­çš„æ‰€å±é“¾è¡¨çš„ä¸‹æ ‡ä½ç½® //0 è¡¨ç¤ºå½“å‰æ¡¶ä½ä¸ºnullï¼Œnodeå¯ä»¥ç›´æ¥æ”¾ç€ //2 è¡¨ç¤ºå½“å‰æ¡¶ä½å·²ç»å¯èƒ½æ˜¯çº¢é»‘æ ‘ int binCount = 0; //tab å¼•ç”¨mapå¯¹è±¡çš„table //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //f è¡¨ç¤ºæ¡¶ä½çš„å¤´ç»“ç‚¹ //n è¡¨ç¤ºæ•£åˆ—è¡¨æ•°ç»„çš„é•¿åº¦ //i è¡¨ç¤ºkeyé€šè¿‡å¯»å€è®¡ç®—åï¼Œå¾—åˆ°çš„æ¡¶ä½ä¸‹æ ‡ //fh è¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹çš„hashå€¼ Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼šæˆç«‹ï¼Œè¡¨ç¤ºå½“å‰mapä¸­çš„tableå°šæœªåˆå§‹åŒ–.. if (tab == null || (n = tab.length) == 0) //æœ€ç»ˆå½“å‰çº¿ç¨‹éƒ½ä¼šè·å–åˆ°æœ€æ–°çš„map.tableå¼•ç”¨ã€‚ tab = initTable(); //CASE2ï¼ši è¡¨ç¤ºkeyä½¿ç”¨è·¯ç”±å¯»å€ç®—æ³•å¾—åˆ° keyå¯¹åº” tableæ•°ç»„çš„ä¸‹æ ‡ä½ç½®ï¼ŒtabAt è·å–æŒ‡å®šæ¡¶ä½çš„å¤´ç»“ç‚¹ f else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) &#123; //è¿›å…¥åˆ°CASE2ä»£ç å— å‰ç½®æ¡ä»¶ å½“å‰tableæ•°ç»„iæ¡¶ä½æ˜¯Nullæ—¶ã€‚ //ä½¿ç”¨CASæ–¹å¼ è®¾ç½® æŒ‡å®šæ•°ç»„iæ¡¶ä½ ä¸º new Node&lt;K,V&gt;(hash, key, value, null),å¹¶ä¸”æœŸæœ›å€¼æ˜¯null //casæ“ä½œæˆåŠŸ è¡¨ç¤ºokï¼Œç›´æ¥break forå¾ªç¯å³å¯ //casæ“ä½œå¤±è´¥ï¼Œè¡¨ç¤ºåœ¨å½“å‰çº¿ç¨‹ä¹‹å‰ï¼Œæœ‰å…¶å®ƒçº¿ç¨‹å…ˆä½ ä¸€æ­¥å‘æŒ‡å®šiæ¡¶ä½è®¾ç½®å€¼äº†ã€‚ //å½“å‰çº¿ç¨‹åªèƒ½å†æ¬¡è‡ªæ—‹ï¼Œå»èµ°å…¶å®ƒé€»è¾‘ã€‚ if (casTabAt(tab, i, null, new Node&lt;K,V&gt;(hash, key, value, null))) break; // no lock when adding to empty bin &#125; //CASE3ï¼šå‰ç½®æ¡ä»¶ï¼Œæ¡¶ä½çš„å¤´ç»“ç‚¹ä¸€å®šä¸æ˜¯nullã€‚ //æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ ä¸º FWDç»“ç‚¹ï¼Œè¡¨ç¤ºç›®å‰mapæ­£å¤„äºæ‰©å®¹è¿‡ç¨‹ä¸­.. else if ((fh = f.hash) == MOVED) //çœ‹åˆ°fwdèŠ‚ç‚¹åï¼Œå½“å‰èŠ‚ç‚¹æœ‰ä¹‰åŠ¡å¸®åŠ©å½“å‰mapå¯¹è±¡å®Œæˆè¿ç§»æ•°æ®çš„å·¥ä½œ //å¸®åŠ©æ‰©å®¹ tab = helpTransfer(tab, f); //CASE4ï¼šå½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ é“¾è¡¨ ä¹Ÿå¯èƒ½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else &#123; //å½“æ’å…¥keyå­˜åœ¨æ—¶ï¼Œä¼šå°†æ—§å€¼èµ‹å€¼ç»™oldValï¼Œè¿”å›ç»™putæ–¹æ³•è°ƒç”¨å¤„.. V oldVal = null; //ä½¿ç”¨sync åŠ é”â€œå¤´èŠ‚ç‚¹â€ï¼Œç†è®ºä¸Šæ˜¯â€œå¤´ç»“ç‚¹â€ synchronized (f) &#123; //ä¸ºä»€ä¹ˆåˆè¦å¯¹æ¯”ä¸€ä¸‹ï¼Œçœ‹çœ‹å½“å‰æ¡¶ä½çš„å¤´èŠ‚ç‚¹ æ˜¯å¦ä¸º ä¹‹å‰è·å–çš„å¤´ç»“ç‚¹ï¼Ÿ //ä¸ºäº†é¿å…å…¶å®ƒçº¿ç¨‹å°†è¯¥æ¡¶ä½çš„å¤´ç»“ç‚¹ä¿®æ”¹æ‰ï¼Œå¯¼è‡´å½“å‰çº¿ç¨‹ä»sync åŠ é” å°±æœ‰é—®é¢˜äº†ã€‚ä¹‹åæ‰€æœ‰æ“ä½œéƒ½ä¸ç”¨åœ¨åšäº†ã€‚ if (tabAt(tab, i) == f) &#123;//æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å’±ä»¬ åŠ é” çš„å¯¹è±¡æ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥è¿›æ¥é€ äº†ï¼ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰æ¡¶ä½å°±æ˜¯æ™®é€šé“¾è¡¨æ¡¶ä½ã€‚ if (fh &gt;= 0) &#123; //1.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­æ‰€æœ‰å…ƒç´ çš„keyéƒ½ä¸ä¸€è‡´æ—¶ï¼Œå½“å‰çš„æ’å…¥æ“ä½œæ˜¯è¿½åŠ åˆ°é“¾è¡¨çš„æœ«å°¾ï¼ŒbinCountè¡¨ç¤ºé“¾è¡¨é•¿åº¦ //2.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­çš„æŸä¸ªå…ƒç´ çš„keyä¸€è‡´æ—¶ï¼Œå½“å‰æ’å…¥æ“ä½œå¯èƒ½å°±æ˜¯æ›¿æ¢äº†ã€‚binCountè¡¨ç¤ºå†²çªä½ç½®ï¼ˆbinCount - 1ï¼‰ binCount = 1; //è¿­ä»£å¾ªç¯å½“å‰æ¡¶ä½çš„é“¾è¡¨ï¼Œeæ˜¯æ¯æ¬¡å¾ªç¯å¤„ç†èŠ‚ç‚¹ã€‚ for (Node&lt;K,V&gt; e = f;; ++binCount) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹ key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash æˆç«‹ è¡¨ç¤ºå¾ªç¯çš„å½“å‰å…ƒç´ çš„hashå€¼ä¸æ’å…¥èŠ‚ç‚¹çš„hashå€¼ä¸€è‡´ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­ //æ¡ä»¶äºŒï¼š((ek = e.key) == key ||(ek != null &amp;&amp; key.equals(ek))) // æˆç«‹ï¼šè¯´æ˜å¾ªç¯çš„å½“å‰èŠ‚ç‚¹ä¸æ’å…¥èŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå‘ç”Ÿå†²çªäº† if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å°†å½“å‰å¾ªç¯çš„å…ƒç´ çš„ å€¼ èµ‹å€¼ç»™oldVal oldVal = e.val; if (!onlyIfAbsent) e.val = value; break; &#125; //å½“å‰å…ƒç´  ä¸ æ’å…¥å…ƒç´ çš„keyä¸ä¸€è‡´ æ—¶ï¼Œä¼šèµ°ä¸‹é¢ç¨‹åºã€‚ //1.æ›´æ–°å¾ªç¯å¤„ç†èŠ‚ç‚¹ä¸º å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ //2.åˆ¤æ–­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯nullï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»æ˜¯é˜Ÿå°¾äº†ï¼Œæ’å…¥æ•°æ®éœ€è¦è¿½åŠ åˆ°é˜Ÿå°¾èŠ‚ç‚¹çš„åé¢ã€‚ Node&lt;K,V&gt; pred = e; if ((e = e.next) == null) &#123; pred.next = new Node&lt;K,V&gt;(hash, key, value, null); break; &#125; &#125; &#125; //å‰ç½®æ¡ä»¶ï¼Œè¯¥æ¡¶ä½ä¸€å®šä¸æ˜¯é“¾è¡¨ //æ¡ä»¶æˆç«‹ï¼Œè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //p è¡¨ç¤ºçº¢é»‘æ ‘ä¸­å¦‚æœä¸ä½ æ’å…¥èŠ‚ç‚¹çš„key æœ‰å†²çªèŠ‚ç‚¹çš„è¯ ï¼Œåˆ™putTreeVal æ–¹æ³• ä¼šè¿”å›å†²çªèŠ‚ç‚¹çš„å¼•ç”¨ã€‚ Node&lt;K,V&gt; p; //å¼ºåˆ¶è®¾ç½®binCountä¸º2ï¼Œå› ä¸ºbinCount &lt;= 1 æ—¶æœ‰å…¶å®ƒå«ä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸ºäº†2 binCount = 2; //æ¡ä»¶ä¸€ï¼šæˆç«‹ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„keyä¸çº¢é»‘æ ‘ä¸­çš„æŸä¸ªèŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå†²çªäº† if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key, value)) != null) &#123; //å°†å†²çªèŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal oldVal = p.val; if (!onlyIfAbsent) p.val = value; &#125; &#125; &#125; &#125; //è¯´æ˜å½“å‰æ¡¶ä½ä¸ä¸ºnullï¼Œå¯èƒ½æ˜¯çº¢é»‘æ ‘ ä¹Ÿå¯èƒ½æ˜¯é“¾è¡¨ if (binCount != 0) &#123; //å¦‚æœbinCount&gt;=8 è¡¨ç¤ºå¤„ç†çš„æ¡¶ä½ä¸€å®šæ˜¯é“¾è¡¨ if (binCount &gt;= TREEIFY_THRESHOLD) //è°ƒç”¨è½¬åŒ–é“¾è¡¨ä¸ºçº¢é»‘æ ‘çš„æ–¹æ³• treeifyBin(tab, i); //è¯´æ˜å½“å‰çº¿ç¨‹æ’å…¥çš„æ•°æ®keyï¼Œä¸åŸæœ‰k-vå‘ç”Ÿå†²çªï¼Œéœ€è¦å°†åŸæ•°æ®vè¿”å›ç»™è°ƒç”¨è€…ã€‚ if (oldVal != null) return oldVal; break; &#125; &#125; &#125; //1.ç»Ÿè®¡å½“å‰tableä¸€å…±æœ‰å¤šå°‘æ•°æ® //2.åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æ‰©å®¹é˜ˆå€¼æ ‡å‡†ï¼Œè§¦å‘æ‰©å®¹ã€‚ addCount(1L, binCount); return null;&#125; #6 initTableæ•°ç»„åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªåˆé€‚å¤§å°çš„æ•°ç»„ã€‚ sizeCtl ï¼šè¿™ä¸ªæ ‡å¿—æ˜¯åœ¨ Node æ•°ç»„åˆå§‹åŒ–æˆ–è€…æ‰©å®¹çš„æ—¶å€™çš„ä¸€ä¸ªæ§åˆ¶ä½æ ‡è¯†ï¼Œè´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–è€…æ‰©å®¹æ“ä½œã€‚ -1 ä»£è¡¨æ­£åœ¨åˆå§‹åŒ– -N ä»£è¡¨æœ‰ N-1 ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè¿™é‡Œä¸æ˜¯ç®€å•çš„ç†è§£æˆ n ä¸ªçº¿ç¨‹ï¼ŒsizeCtl å°±æ˜¯-N 0 æ ‡è¯† Node æ•°ç»„è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œæ­£æ•°ä»£è¡¨åˆå§‹åŒ–æˆ–è€…ä¸‹ä¸€æ¬¡æ‰©å®¹çš„å¤§å° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455/** * Initializes table, using the size recorded in sizeCtl. * * sizeCtl &lt; 0 * * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * * * sizeCtl &gt; 0 * * * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private final Node&lt;K,V&gt;[] initTable() &#123; //tab å¼•ç”¨map.table //sc sizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab; int sc; //è‡ªæ—‹ æ¡ä»¶ï¼šmap.table å°šæœªåˆå§‹åŒ– while ((tab = table) == null || tab.length == 0) &#123; if ((sc = sizeCtl) &lt; 0) //å¤§æ¦‚ç‡å°±æ˜¯-1ï¼Œè¡¨ç¤ºå…¶å®ƒçº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆ›å»ºtableçš„è¿‡ç¨‹ï¼Œå½“å‰çº¿ç¨‹æ²¡æœ‰ç«äº‰åˆ°åˆå§‹åŒ–tableçš„é”ã€‚ Thread.yield(); // lost initialization race; just spin //1.sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° //2.å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° //3.å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123; try &#123; //è¿™é‡Œä¸ºä»€ä¹ˆåˆè¦åˆ¤æ–­å‘¢ï¼Ÿ é˜²æ­¢å…¶å®ƒçº¿ç¨‹å·²ç»åˆå§‹åŒ–å®Œæ¯•äº†ï¼Œç„¶åå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–..å¯¼è‡´ä¸¢å¤±æ•°æ®ã€‚ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å…¶å®ƒçº¿ç¨‹éƒ½æ²¡æœ‰è¿›å…¥è¿‡è¿™ä¸ªifå—ï¼Œå½“å‰çº¿ç¨‹å°±æ˜¯å…·å¤‡åˆå§‹åŒ–tableæƒåˆ©äº†ã€‚ if ((tab = table) == null || tab.length == 0) &#123; //scå¤§äº0 åˆ›å»ºtableæ—¶ ä½¿ç”¨ scä¸ºæŒ‡å®šå¤§å°ï¼Œå¦åˆ™ä½¿ç”¨ 16 é»˜è®¤å€¼. int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY; @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n]; //æœ€ç»ˆèµ‹å€¼ç»™ map.table table = tab = nt; //n &gt;&gt;&gt; 2 =&gt; ç­‰äº 1/4 n n - (1/4)n = 3/4 n =&gt; 0.75 * n //sc 0.75 n è¡¨ç¤ºä¸‹ä¸€æ¬¡æ‰©å®¹æ—¶çš„è§¦å‘æ¡ä»¶ã€‚ sc = n - (n &gt;&gt;&gt; 2); &#125; &#125; finally &#123; //1.å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹è¯ï¼Œscè¡¨ç¤ºçš„æ˜¯ ä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼ //2.è¡¨ç¤ºå½“å‰çº¿ç¨‹ å¹¶ä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥åˆ°else if å— æ—¶ï¼Œå°† //sizeCtl è®¾ç½®ä¸ºäº†-1 ï¼Œé‚£ä¹ˆè¿™æ—¶éœ€è¦å°†å…¶ä¿®æ”¹ä¸º è¿›å…¥æ—¶çš„å€¼ã€‚ sizeCtl = sc; &#125; break; &#125; &#125; return tab;&#125; #7 addCount 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124private final void addCount(long x, int check) &#123; //as è¡¨ç¤º LongAdder.cells //b è¡¨ç¤ºLongAdder.base //s è¡¨ç¤ºå½“å‰map.tableä¸­å…ƒç´ çš„æ•°é‡ CounterCell[] as; long b, s; //æ¡ä»¶ä¸€ï¼štrue-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®ç´¯åŠ åˆ° base //æ¡ä»¶äºŒï¼šfalse-&gt;è¡¨ç¤ºå†™baseæˆåŠŸï¼Œæ•°æ®ç´¯åŠ åˆ°baseä¸­äº†ï¼Œå½“å‰ç«äº‰ä¸æ¿€çƒˆï¼Œä¸éœ€è¦åˆ›å»ºcells // true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ if ((as = counterCells) != null || !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) &#123; //æœ‰å‡ ç§æƒ…å†µè¿›å…¥åˆ°ifå—ä¸­ï¼Ÿ //1.true-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® //2.true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ //a è¡¨ç¤ºå½“å‰çº¿ç¨‹hashå¯»å€å‘½ä¸­çš„cell CounterCell a; //v è¡¨ç¤ºå½“å‰çº¿ç¨‹å†™cellæ—¶çš„æœŸæœ›å€¼ long v; //m è¡¨ç¤ºå½“å‰cellsæ•°ç»„çš„é•¿åº¦ int m; //true -&gt; æœªç«äº‰ false-&gt;å‘ç”Ÿç«äº‰ boolean uncontended = true; //æ¡ä»¶ä¸€ï¼šas == null || (m = as.length - 1) &lt; 0 //true-&gt; è¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯é€šè¿‡ å†™baseç«äº‰å¤±è´¥ ç„¶åè¿›å…¥çš„ifå—ï¼Œå°±éœ€è¦è°ƒç”¨fullAddCountæ–¹æ³•å»æ‰©å®¹ æˆ–è€… é‡è¯•.. LongAdder.longAccumulate //æ¡ä»¶äºŒï¼ša = as[ThreadLocalRandom.getProbe() &amp; m]) == null å‰ç½®æ¡ä»¶ï¼šcellså·²ç»åˆå§‹åŒ–äº† //true-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„cellè¡¨æ ¼æ˜¯ä¸ªç©ºï¼Œéœ€è¦å½“å‰çº¿ç¨‹è¿›å…¥fullAddCountæ–¹æ³•å»åˆå§‹åŒ– cellï¼Œæ”¾å…¥å½“å‰ä½ç½®. //æ¡ä»¶ä¸‰ï¼š!(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x) // false-&gt;å–åå¾—åˆ°falseï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellæˆåŠŸ // true-&gt;å–åå¾—åˆ°true,è¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellå¤±è´¥ï¼Œéœ€è¦è¿›å…¥fullAddCountè¿›è¡Œé‡è¯• æˆ–è€… æ‰©å®¹ cellsã€‚ if (as == null || (m = as.length - 1) &lt; 0 || (a = as[ThreadLocalRandom.getProbe() &amp; m]) == null || !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x)) ) &#123; fullAddCount(x, uncontended); //è€ƒè™‘åˆ°fullAddCounté‡Œé¢çš„äº‹æƒ…æ¯”è¾ƒç´¯ï¼Œå°±è®©å½“å‰çº¿ç¨‹ ä¸å‚ä¸åˆ° æ‰©å®¹ç›¸å…³çš„é€»è¾‘äº†ï¼Œç›´æ¥è¿”å›åˆ°è°ƒç”¨ç‚¹ã€‚ return; &#125; if (check &lt;= 1) return; //è·å–å½“å‰æ•£åˆ—è¡¨å…ƒç´ ä¸ªæ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæœŸæœ›å€¼ s = sumCount(); &#125; //è¡¨ç¤ºä¸€å®šæ˜¯ä¸€ä¸ªputæ“ä½œè°ƒç”¨çš„addCount if (check &gt;= 0) &#123; //tab è¡¨ç¤ºmap.table //nt è¡¨ç¤ºmap.nextTable //n è¡¨ç¤ºmap.tableæ•°ç»„çš„é•¿åº¦ //sc è¡¨ç¤ºsizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab, nt; int n, sc; /** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */ //è‡ªæ—‹ //æ¡ä»¶ä¸€ï¼šs &gt;= (long)(sc = sizeCtl) // true-&gt; 1.å½“å‰sizeCtlä¸ºä¸€ä¸ªè´Ÿæ•° è¡¨ç¤ºæ­£åœ¨æ‰©å®¹ä¸­.. // 2.å½“å‰sizeCtlæ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œè¡¨ç¤ºæ‰©å®¹é˜ˆå€¼ // false-&gt; è¡¨ç¤ºå½“å‰tableå°šæœªè¾¾åˆ°æ‰©å®¹æ¡ä»¶ //æ¡ä»¶äºŒï¼š(tab = table) != null // æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š(n = tab.length) &lt; MAXIMUM_CAPACITY // true-&gt;å½“å‰tableé•¿åº¦å°äºæœ€å¤§å€¼é™åˆ¶ï¼Œåˆ™å¯ä»¥è¿›è¡Œæ‰©å®¹ã€‚ while (s &gt;= (long)(sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp; (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123; //æ‰©å®¹æ‰¹æ¬¡å”¯ä¸€æ ‡è¯†æˆ³ //16 -&gt; 32 æ‰©å®¹ æ ‡è¯†ä¸ºï¼š1000 0000 0001 1011 int rs = resizeStamp(n); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰tableæ­£åœ¨æ‰©å®¹ // å½“å‰çº¿ç¨‹ç†è®ºä¸Šåº”è¯¥ååŠ©tableå®Œæˆæ‰©å®¹ if (sc &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼š(nt = nextTable) == null // true-&gt;è¡¨ç¤ºæœ¬æ¬¡æ‰©å®¹ç»“æŸ // false-&gt;æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || (nt = nextTable) == null || transferIndex &lt;= 0) break; //å‰ç½®æ¡ä»¶ï¼šå½“å‰tableæ­£åœ¨æ‰§è¡Œæ‰©å®¹ä¸­.. å½“å‰çº¿ç¨‹æœ‰æœºä¼šå‚ä¸è¿›æ‰©å®¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹æˆåŠŸå‚ä¸åˆ°æ‰©å®¹ä»»åŠ¡ä¸­ï¼Œå¹¶ä¸”å°†scä½16ä½å€¼åŠ 1ï¼Œè¡¨ç¤ºå¤šäº†ä¸€ä¸ªçº¿ç¨‹å‚ä¸å·¥ä½œ //æ¡ä»¶å¤±è´¥ï¼š1.å½“å‰æœ‰å¾ˆå¤šçº¿ç¨‹éƒ½åœ¨æ­¤å¤„å°è¯•ä¿®æ”¹sizeCtlï¼Œæœ‰å…¶å®ƒä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æˆåŠŸäº†ï¼Œå¯¼è‡´ä½ çš„scæœŸæœ›å€¼ä¸å†…å­˜ä¸­çš„å€¼ä¸ä¸€è‡´ ä¿®æ”¹å¤±è´¥ // 2.transfer ä»»åŠ¡å†…éƒ¨çš„çº¿ç¨‹ä¹Ÿä¿®æ”¹äº†sizeCtlã€‚ if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) //ååŠ©æ‰©å®¹çº¿ç¨‹ï¼ŒæŒæœ‰nextTableå‚æ•° transfer(tab, nt); &#125; //1000 0000 0001 1011 0000 0000 0000 0000 +2 =&gt; 1000 0000 0001 1011 0000 0000 0000 0010 //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯è§¦å‘æ‰©å®¹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨transferæ–¹æ³•éœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ else if (U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)) //è§¦å‘æ‰©å®¹æ¡ä»¶çš„çº¿ç¨‹ ä¸æŒæœ‰nextTable transfer(tab, null); s = sumCount(); &#125; &#125;&#125; #8. transferConcurrentHashMap æ”¯æŒå¹¶å‘æ‰©å®¹ï¼Œå®ç°æ–¹å¼æ˜¯ï¼ŒæŠŠ Node æ•°ç»„è¿›è¡Œæ‹†åˆ†ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å¤„ç†è‡ªå·±çš„åŒºåŸŸï¼Œå‡è®¾ table æ•°ç»„æ€»é•¿åº¦æ˜¯ 64ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹å¯ä»¥åˆ†åˆ° 16 ä¸ª bucketã€‚ç„¶åæ¯ä¸ªçº¿ç¨‹å¤„ç†çš„èŒƒå›´ï¼ŒæŒ‰ç…§å€’åºæ¥åšè¿ç§»ã€‚ é€šè¿‡ for è‡ªå¾ªç¯å¤„ç†æ¯ä¸ªæ§½ä½ä¸­çš„é“¾è¡¨å…ƒç´ ï¼Œé»˜è®¤ advace ä¸ºçœŸï¼Œé€šè¿‡ CAS è®¾ç½® transferIndexå±æ€§å€¼ï¼Œå¹¶åˆå§‹åŒ– i å’Œ bound å€¼ï¼Œi æŒ‡å½“å‰å¤„ç†çš„æ§½ä½åºå·ï¼Œbound æŒ‡éœ€è¦å¤„ç†çš„æ§½ä½è¾¹ç•Œï¼Œå…ˆå¤„ç†æ§½ä½ 31 çš„èŠ‚ç‚¹ï¼› ï¼ˆbound,iï¼‰ =(16,31) ä» 31 çš„ä½ç½®å¾€å‰æ¨åŠ¨ã€‚ æ¯å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ‰©å®¹æ“ä½œï¼Œå°±é€šè¿‡ cas æ‰§è¡Œ sc-1ã€‚ æ¥ç€åˆ¤æ–­(sc-2) !=resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT ; å¦‚æœç›¸ç­‰ï¼Œè¡¨ç¤ºå½“å‰ä¸ºæ•´ä¸ªæ‰©å®¹æ“ä½œçš„ æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæ„å‘³ç€æ•´ä¸ªæ‰©å®¹æ“ä½œå°±ç»“æŸäº†ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜è¿˜å¾—ç»§ç»­ã€‚ è¿™ä¹ˆåšçš„ç›®çš„ï¼Œä¸€æ–¹é¢æ˜¯é˜²æ­¢ä¸åŒæ‰©å®¹ä¹‹é—´å‡ºç°ç›¸åŒçš„ sizeCtlï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œè¿˜å¯ä»¥é¿å…sizeCtl çš„ ABA é—®é¢˜å¯¼è‡´çš„æ‰©å®¹é‡å çš„æƒ…å†µã€‚ æ‰©å®¹å›¾è§£åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å½“æ›´æ–°åçš„é”®å€¼å¯¹æ€»æ•° baseCount &gt;= é˜ˆå€¼ sizeCtl æ—¶ï¼Œè¿›è¡Œrehashï¼Œè¿™é‡Œé¢ä¼šæœ‰ä¸¤ä¸ªé€»è¾‘ã€‚ å¦‚æœå½“å‰æ­£åœ¨å¤„äºæ‰©å®¹é˜¶æ®µï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šåŠ å…¥å¹¶ä¸”ååŠ©æ‰©å®¹ã€‚ å¦‚æœå½“å‰æ²¡æœ‰åœ¨æ‰©å®¹ï¼Œåˆ™ç›´æ¥è§¦å‘æ‰©å®¹æ“ä½œã€‚ æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹æ•°æ®çš„è½¬ç§»å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯æŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ä½†æ˜¯è¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåœ¨æ‰©å®¹çš„æ—¶å€™å…¶ä»–çº¿ç¨‹ä¹Ÿå¯èƒ½æ­£åœ¨æ·»åŠ å…ƒç´ ï¼Œè¿™æ—¶åˆè§¦å‘äº†æ‰©å®¹æ€ä¹ˆåŠï¼Ÿå¯èƒ½å¤§å®¶æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯åŠ äº’æ–¥é”ï¼ŒæŠŠè½¬ç§»è¿‡ç¨‹é”ä½ï¼Œè™½ç„¶æ˜¯å¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ä¼šå¸¦æ¥è¾ƒå¤§çš„æ€§èƒ½å¼€é”€ã€‚å› ä¸ºäº’æ–¥é”ä¼šå¯¼è‡´æ‰€æœ‰è®¿é—®ä¸´ç•ŒåŒºçš„çº¿ç¨‹é™·å…¥åˆ°é˜»å¡çŠ¶æ€ï¼ŒæŒæœ‰é”çš„çº¿ç¨‹è€—æ—¶è¶Šé•¿ï¼Œå…¶ä»–ç«äº‰çº¿ç¨‹å°±ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œå¯¼è‡´ååé‡è¾ƒä½ã€‚è€Œä¸”è¿˜å¯èƒ½å¯¼è‡´æ­»é”ã€‚ è€Œ ConcurrentHashMap å¹¶æ²¡æœ‰ç›´æ¥åŠ é”ï¼Œè€Œæ˜¯é‡‡ç”¨ CAS å®ç°æ— é”çš„å¹¶å‘åŒæ­¥ç­–ç•¥ï¼Œæœ€ç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ã€‚ å®ƒæŠŠ Node æ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹é”è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingNodeèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹å®ƒçš„æºç å®ç°ã€‚ fwd:è¿™ä¸ªç±»æ˜¯ä¸ªæ ‡è¯†ç±»ï¼Œç”¨äºæŒ‡å‘æ–°è¡¨ç”¨çš„ï¼Œå…¶ä»–çº¿ç¨‹é‡åˆ°è¿™ä¸ªç±»ä¼šä¸»åŠ¨è·³è¿‡è¿™ä¸ªç±»ï¼Œå› ä¸ºè¿™ä¸ªç±»è¦ä¹ˆå°±æ˜¯æ‰©å®¹è¿ç§»æ­£åœ¨è¿›è¡Œï¼Œè¦ä¹ˆå°±æ˜¯å·²ç»å®Œæˆæ‰©å®¹è¿ç§»ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªç±»è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå†è¿›è¡Œæ“ä½œã€‚ advance:è¿™ä¸ªå˜é‡æ˜¯ç”¨äºæç¤ºä»£ç æ˜¯å¦è¿›è¡Œæ¨è¿›å¤„ç†ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ¡¶å¤„ç†å®Œï¼Œå¤„ç†ä¸‹ä¸€ä¸ªæ¡¶çš„æ ‡è¯†ã€‚ finishing:è¿™ä¸ªå˜é‡ç”¨äºæç¤ºæ‰©å®¹æ˜¯å¦ç»“æŸç”¨çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237private final void transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab) &#123; //n è¡¨ç¤ºæ‰©å®¹ä¹‹å‰tableæ•°ç»„çš„é•¿åº¦ //stride è¡¨ç¤ºåˆ†é…ç»™çº¿ç¨‹ä»»åŠ¡çš„æ­¥é•¿ int n = tab.length, stride; // stride å›ºå®šä¸º 16 if ((stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE) stride = MIN_TRANSFER_STRIDE; // subdivide range //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä¸ºè§¦å‘æœ¬æ¬¡æ‰©å®¹çš„çº¿ç¨‹ï¼Œéœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯ååŠ©æ‰©å®¹çš„çº¿ç¨‹.. if (nextTab == null) &#123; // initiating try &#123; //åˆ›å»ºäº†ä¸€ä¸ªæ¯”æ‰©å®¹ä¹‹å‰å¤§ä¸€å€çš„table @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n &lt;&lt; 1]; nextTab = nt; &#125; catch (Throwable ex) &#123; // try to cope with OOME sizeCtl = Integer.MAX_VALUE; return; &#125; //èµ‹å€¼ç»™å¯¹è±¡å±æ€§ nextTable ï¼Œæ–¹ä¾¿ååŠ©æ‰©å®¹çº¿ç¨‹ æ‹¿åˆ°æ–°è¡¨ nextTable = nextTab; //è®°å½•è¿ç§»æ•°æ®æ•´ä½“ä½ç½®çš„ä¸€ä¸ªæ ‡è®°ã€‚indexè®¡æ•°æ˜¯ä»1å¼€å§‹è®¡ç®—çš„ã€‚ transferIndex = n; &#125; //è¡¨ç¤ºæ–°æ•°ç»„çš„é•¿åº¦ int nextn = nextTab.length; //fwd èŠ‚ç‚¹ï¼Œå½“æŸä¸ªæ¡¶ä½æ•°æ®å¤„ç†å®Œæ¯•åï¼Œå°†æ­¤æ¡¶ä½è®¾ç½®ä¸ºfwdèŠ‚ç‚¹ï¼Œå…¶å®ƒå†™çº¿ç¨‹ æˆ–è¯»çº¿ç¨‹çœ‹åˆ°åï¼Œä¼šæœ‰ä¸åŒé€»è¾‘ã€‚ ForwardingNode&lt;K,V&gt; fwd = new ForwardingNode&lt;K,V&gt;(nextTab); //æ¨è¿›æ ‡è®° boolean advance = true; //å®Œæˆæ ‡è®° boolean finishing = false; // to ensure sweep before committing nextTab //i è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡ï¼Œæ‰§è¡Œåˆ°çš„æ¡¶ä½ //bound è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡çš„ä¸‹ç•Œé™åˆ¶ int i = 0, bound = 0; //è‡ªæ—‹ for (;;) &#123; //f æ¡¶ä½çš„å¤´ç»“ç‚¹ //fh å¤´ç»“ç‚¹çš„hash Node&lt;K,V&gt; f; int fh; /** * 1.ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡åŒºé—´ * 2.ç»´æŠ¤å½“å‰çº¿ç¨‹ä»»åŠ¡è¿›åº¦ï¼ˆi è¡¨ç¤ºå½“å‰å¤„ç†çš„æ¡¶ä½ï¼‰ * 3.ç»´æŠ¤mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„è¿›åº¦ */ while (advance) &#123; //åˆ†é…ä»»åŠ¡çš„å¼€å§‹ä¸‹æ ‡ //åˆ†é…ä»»åŠ¡çš„ç»“æŸä¸‹æ ‡ int nextIndex, nextBound; //CASE1: //æ¡ä»¶ä¸€ï¼š--i &gt;= bound //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œè¿˜æœ‰ç›¸åº”çš„åŒºé—´çš„æ¡¶ä½è¦å¤„ç†ï¼Œ--i å°±è®©å½“å‰çº¿ç¨‹å¤„ç†ä¸‹ä¸€ä¸ª æ¡¶ä½. //ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… if (--i &gt;= bound || finishing) advance = false; //CASE2: //å‰ç½®æ¡ä»¶ï¼šå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½éƒ½åˆ†é…å®Œæ¯•äº†ï¼Œæ²¡æœ‰åŒºé—´å¯åˆ†é…äº†ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹çš„iå˜é‡ä¸º-1 è·³å‡ºå¾ªç¯åï¼Œæ‰§è¡Œé€€å‡ºè¿ç§»ä»»åŠ¡ç›¸å…³çš„ç¨‹åº //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½å°šæœªåˆ†é…å®Œæ¯•ï¼Œè¿˜æœ‰åŒºé—´å¯åˆ†é… else if ((nextIndex = transferIndex) &lt;= 0) &#123; i = -1; advance = false; &#125; //CASE3: //å‰ç½®æ¡ä»¶ï¼š1ã€å½“å‰çº¿ç¨‹éœ€è¦åˆ†é…ä»»åŠ¡åŒºé—´ 2.å…¨å±€èŒƒå›´å†…è¿˜æœ‰æ¡¶ä½å°šæœªè¿ç§» //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡æˆåŠŸ //æ¡ä»¶å¤±è´¥ï¼šè¯´æ˜åˆ†é…ç»™å½“å‰çº¿ç¨‹å¤±è´¥ï¼Œåº”è¯¥æ˜¯å’Œå…¶å®ƒçº¿ç¨‹å‘ç”Ÿäº†ç«äº‰å§ else if (U.compareAndSwapInt (this, TRANSFERINDEX, nextIndex, nextBound = (nextIndex &gt; stride ? nextIndex - stride : 0))) &#123; bound = nextBound; i = nextIndex - 1; advance = false; &#125; &#125; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼ši &lt; 0 //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æœªåˆ†é…åˆ°ä»»åŠ¡ if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) &#123; //ä¿å­˜sizeCtl çš„å˜é‡ int sc; if (finishing) &#123; nextTable = null; table = nextTab; sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1); return; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜è®¾ç½®sizeCtl ä½16ä½ -1 æˆåŠŸï¼Œå½“å‰çº¿ç¨‹å¯ä»¥æ­£å¸¸é€€å‡º if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) &#123; //1000 0000 0001 1011 0000 0000 0000 0000 //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹ä¸æ˜¯æœ€åä¸€ä¸ªé€€å‡ºtransferä»»åŠ¡çš„çº¿ç¨‹ if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT) //æ­£å¸¸é€€å‡º return; finishing = advance = true; i = n; // recheck before commit &#125; &#125; //å‰ç½®æ¡ä»¶ï¼šã€CASE2~CASE4ã€‘ å½“å‰çº¿ç¨‹ä»»åŠ¡å°šæœªå¤„ç†å®Œï¼Œæ­£åœ¨è¿›è¡Œä¸­ //CASE2: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½æœªå­˜æ”¾æ•°æ®ï¼Œåªéœ€è¦å°†æ­¤å¤„è®¾ç½®ä¸ºfwdèŠ‚ç‚¹å³å¯ã€‚ else if ((f = tabAt(tab, i)) == null) advance = casTabAt(tab, i, null, fwd); //CASE3: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½å·²ç»è¿ç§»è¿‡äº†ï¼Œå½“å‰çº¿ç¨‹ä¸ç”¨å†å¤„ç†äº†ï¼Œç›´æ¥å†æ¬¡æ›´æ–°å½“å‰çº¿ç¨‹ä»»åŠ¡ç´¢å¼•ï¼Œå†æ¬¡å¤„ç†ä¸‹ä¸€ä¸ªæ¡¶ä½ æˆ–è€… å…¶å®ƒæ“ä½œ else if ((fh = f.hash) == MOVED) advance = true; // already processed //CASE4: //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œè€Œä¸”nodeèŠ‚ç‚¹ ä¸æ˜¯ fwdèŠ‚ç‚¹ï¼Œè¯´æ˜è¿™äº›æ•°æ®éœ€è¦è¿ç§»ã€‚ else &#123; //sync åŠ é”å½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ synchronized (f) &#123; //é˜²æ­¢åœ¨ä½ åŠ é”å¤´å¯¹è±¡ä¹‹å‰ï¼Œå½“å‰æ¡¶ä½çš„å¤´å¯¹è±¡è¢«å…¶å®ƒå†™çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œå¯¼è‡´ä½ ç›®å‰åŠ é”å¯¹è±¡é”™è¯¯... if (tabAt(tab, i) == f) &#123; //ln è¡¨ç¤ºä½ä½é“¾è¡¨å¼•ç”¨ //hn è¡¨ç¤ºé«˜ä½é“¾è¡¨å¼•ç”¨ Node&lt;K,V&gt; ln, hn; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯é“¾è¡¨æ¡¶ä½ if (fh &gt;= 0) &#123; //lastRun //å¯ä»¥è·å–å‡º å½“å‰é“¾è¡¨ æœ«å°¾è¿ç»­é«˜ä½ä¸å˜çš„ node int runBit = fh &amp; n; Node&lt;K,V&gt; lastRun = f; for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º ä½ä½é“¾è¡¨ï¼Œé‚£ä¹ˆå°±è®© ln æŒ‡å‘ ä½ä½é“¾è¡¨ if (runBit == 0) &#123; ln = lastRun; hn = null; &#125; //å¦åˆ™ï¼Œè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º é«˜ä½é“¾è¡¨ï¼Œå°±è®© hn æŒ‡å‘ é«˜ä½é“¾è¡¨ else &#123; hn = lastRun; ln = null; &#125; for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn); &#125; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //è½¬æ¢å¤´ç»“ç‚¹ä¸º treeBinå¼•ç”¨ t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //ä½ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘ä½ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘ä½ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; lo = null, loTail = null; //é«˜ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘é«˜ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘é«˜ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; hi = null, hiTail = null; //lc è¡¨ç¤ºä½ä½é“¾è¡¨å…ƒç´ æ•°é‡ //hc è¡¨ç¤ºé«˜ä½é“¾è¡¨å…ƒç´ æ•°é‡ int lc = 0, hc = 0; //è¿­ä»£TreeBinä¸­çš„åŒå‘é“¾è¡¨ï¼Œä»å¤´ç»“ç‚¹ è‡³ å°¾èŠ‚ç‚¹ for (Node&lt;K,V&gt; e = t.first; e != null; e = e.next) &#123; // h è¡¨ç¤ºå¾ªç¯å¤„ç†å½“å‰å…ƒç´ çš„ hash int h = e.hash; //ä½¿ç”¨å½“å‰èŠ‚ç‚¹ æ„å»ºå‡ºæ¥çš„ æ–°çš„ TreeNode TreeNode&lt;K,V&gt; p = new TreeNode&lt;K,V&gt; (h, e.key, e.val, null, null); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹ å±äºä½ä½é“¾ èŠ‚ç‚¹ if ((h &amp; n) == 0) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰ä½ä½é“¾è¡¨ è¿˜æ²¡æœ‰æ•°æ® if ((p.prev = loTail) == null) lo = p; //è¯´æ˜ ä½ä½é“¾è¡¨å·²ç»æœ‰æ•°æ®äº†ï¼Œæ­¤æ—¶å½“å‰å…ƒç´  è¿½åŠ åˆ° ä½ä½é“¾è¡¨çš„æœ«å°¾å°±è¡Œäº† else loTail.next = p; //å°†ä½ä½é“¾è¡¨å°¾æŒ‡é’ˆæŒ‡å‘ p èŠ‚ç‚¹ loTail = p; ++lc; &#125; //å½“å‰èŠ‚ç‚¹ å±äº é«˜ä½é“¾ èŠ‚ç‚¹ else &#123; if ((p.prev = hiTail) == null) hi = p; else hiTail.next = p; hiTail = p; ++hc; &#125; &#125; ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) : (hc != 0) ? new TreeBin&lt;K,V&gt;(lo) : t; hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) : (lc != 0) ? new TreeBin&lt;K,V&gt;(hi) : t; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; &#125; &#125; &#125; &#125;&#125; é“¾è¡¨è¿ç§»åŸç† 1ï¼‰é«˜ä½ä½åŸç†åˆ†æ ConcurrentHashMap åœ¨åšé“¾è¡¨è¿ç§»æ—¶ï¼Œä¼šç”¨é«˜ä½ä½æ¥å®ç°ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜è¦åˆ†æä¸€ä¸‹ 1ï¼Œå¦‚ä½•å®ç°é«˜ä½ä½é“¾è¡¨çš„åŒºåˆ† å‡å¦‚æœ‰è¿™æ ·ä¸€ä¸ªé˜Ÿåˆ—ç¬¬ 14 ä¸ªæ§½ä½æ’å…¥æ–°èŠ‚ç‚¹ä¹‹åï¼Œé“¾è¡¨å…ƒç´ ä¸ªæ•°å·²ç»è¾¾åˆ°äº† 8ï¼Œä¸”æ•°ç»„é•¿åº¦ä¸º 16ï¼Œä¼˜å…ˆé€šè¿‡æ‰©å®¹æ¥ç¼“è§£é“¾è¡¨è¿‡é•¿çš„é—®é¢˜ å‡å¦‚å½“å‰çº¿ç¨‹æ­£åœ¨å¤„ç†æ§½ä½ä¸º 14 çš„èŠ‚ç‚¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œåœ¨ä»£ç ä¸­ï¼Œé¦–å…ˆå®šä¹‰ä¸¤ä¸ªå˜é‡èŠ‚ç‚¹ ln å’Œ hnï¼Œå®é™…å°±æ˜¯ lowNode å’Œ HighNodeï¼Œåˆ†åˆ«ä¿å­˜ hash å€¼çš„ç¬¬ x ä½ä¸º 0 å’Œä¸ç­‰äº0 çš„èŠ‚ç‚¹ é€šè¿‡ fn&amp;n å¯ä»¥æŠŠè¿™ä¸ªé“¾è¡¨ä¸­çš„å…ƒç´ åˆ†ä¸ºä¸¤ç±»ï¼ŒA ç±»æ˜¯ hash å€¼çš„ç¬¬ X ä½ä¸º 0ï¼ŒB ç±»æ˜¯ hash å€¼çš„ç¬¬ x ä½ä¸ºä¸ç­‰äº 0ï¼ˆè‡³äºä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåŒºåˆ†ï¼Œç¨ååˆ†æï¼‰ï¼Œå¹¶ä¸”é€šè¿‡ lastRun è®°å½•æœ€åè¦å¤„ç†çš„èŠ‚ç‚¹ã€‚æœ€ç»ˆè¦è¾¾åˆ°çš„ç›®çš„æ˜¯ï¼ŒA ç±»çš„é“¾è¡¨ä¿æŒä½ç½®ä¸åŠ¨ï¼ŒB ç±»çš„é“¾è¡¨ä¸º 14+16(æ‰©å®¹å¢åŠ çš„é•¿åº¦)=30 æŠŠ 14 æ§½ä½çš„é“¾è¡¨å•ç‹¬ä¼¶å‡ºæ¥ï¼Œç”¨è“è‰²è¡¨ç¤º fn&amp;n=0 çš„èŠ‚ç‚¹ï¼Œå‡å¦‚é“¾è¡¨çš„åˆ†ç±»æ˜¯è¿™æ · 1234567for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125;&#125; é€šè¿‡ä¸Šé¢è¿™æ®µä»£ç éå†ï¼Œä¼šè®°å½• runBit ä»¥åŠ lastRunï¼ŒæŒ‰ç…§ä¸Šé¢è¿™ä¸ªç»“æ„ï¼Œé‚£ä¹ˆ runBit åº”è¯¥æ˜¯è“è‰²èŠ‚ç‚¹ï¼ŒlastRun åº”è¯¥æ˜¯ç¬¬ 6 ä¸ªèŠ‚ç‚¹æ¥ç€ï¼Œå†é€šè¿‡è¿™æ®µä»£ç è¿›è¡Œéå†ï¼Œç”Ÿæˆ ln é“¾ä»¥åŠ hn é“¾ 1234567for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn);&#125; æ¥ç€ï¼Œé€šè¿‡ CAS æ“ä½œï¼ŒæŠŠ hn é“¾æ”¾åœ¨ i+n ä¹Ÿå°±æ˜¯ 14+16 çš„ä½ç½®ï¼Œln é“¾ä¿æŒåŸæ¥çš„ä½ç½®ä¸åŠ¨ã€‚å¹¶ä¸”è®¾ç½®å½“å‰èŠ‚ç‚¹ä¸º fwdï¼Œè¡¨ç¤ºå·²ç»è¢«å½“å‰çº¿ç¨‹è¿ç§»å®Œäº†ã€‚ 123setTabAt(nextTab, i, ln);setTabAt(nextTab, i + n, hn);setTabAt(tab, i, fwd); è¿ç§»å®Œæˆä»¥åçš„æ•°æ®åˆ†å¸ƒå¦‚ä¸‹ 2ï¼‰ä¸ºä»€ä¹ˆè¦åšé«˜ä½ä½çš„åˆ’åˆ† è¦æƒ³äº†è§£è¿™ä¹ˆè®¾è®¡çš„ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦ä» ConcurrentHashMap çš„æ ¹æ®ä¸‹æ ‡è·å–å¯¹è±¡çš„ç®—æ³•æ¥çœ‹ï¼Œåœ¨ putVal æ–¹æ³•ä¸­ 1018 è¡Œï¼š (f = tabAt(tab, i = (n - 1) &amp; hash)) == null é€šè¿‡(n-1) &amp; hash æ¥è·å¾—åœ¨ table ä¸­çš„æ•°ç»„ä¸‹æ ‡æ¥è·å–èŠ‚ç‚¹æ•°æ®ï¼Œã€&amp;è¿ç®—æ˜¯äºŒè¿›åˆ¶è¿ç®—ç¬¦ï¼Œ1&amp; 1=1ï¼Œå…¶ä»–éƒ½ä¸º 0ã€‘ã€‚ #9.helpTransferå¦‚æœå¯¹åº”çš„èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹çš„ hash æ˜¯ä¸æ˜¯ç­‰äº MOVED(-1)ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ForwardingNode èŠ‚ç‚¹ï¼Œæ„å‘³ç€æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œé‚£ä¹ˆå½“å‰ç°åœ¨ç›´æ¥å¸®åŠ©å®ƒè¿›è¡Œæ‰©å®¹ï¼Œå› æ­¤è°ƒç”¨ helpTransferæ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455final Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123; //nextTab å¼•ç”¨çš„æ˜¯ fwd.nextTable == map.nextTable ç†è®ºä¸Šæ˜¯è¿™æ ·ã€‚ //sc ä¿å­˜map.sizeCtl Node&lt;K,V&gt;[] nextTab; int sc; //æ¡ä»¶ä¸€ï¼štab != null æ’æˆç«‹ true //æ¡ä»¶äºŒï¼š(f instanceof ForwardingNode) æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š((ForwardingNode&lt;K,V&gt;)f).nextTable) != null æ’æˆç«‹ true if (tab != null &amp;&amp; (f instanceof ForwardingNode) &amp;&amp; (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != null) &#123; //æ‹¿å½“å‰æ ‡çš„é•¿åº¦ è·å– æ‰©å®¹æ ‡è¯†æˆ³ å‡è®¾ 16 -&gt; 32 æ‰©å®¹ï¼š1000 0000 0001 1011 int rs = resizeStamp(tab.length); //æ¡ä»¶ä¸€ï¼šnextTab == nextTable //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼š1.nextTableè¢«è®¾ç½®ä¸ºNull äº†ï¼Œæ‰©å®¹å®Œæ¯•åï¼Œä¼šè¢«è®¾ä¸ºNull // 2.å†æ¬¡å‡ºå‘æ‰©å®¹äº†...å’±ä»¬æ‹¿åˆ°çš„nextTab ä¹Ÿå·²ç»è¿‡æœŸäº†... //æ¡ä»¶äºŒï¼štable == tab //æˆç«‹ï¼šè¯´æ˜ æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¿˜æœªå®Œæˆ //ä¸æˆç«‹ï¼šè¯´æ˜æ‰©å®¹å·²ç»ç»“æŸäº†ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œæœ€åé€€å‡ºçš„çº¿ç¨‹ ä¼šè®¾ç½® nextTable ä¸º table //æ¡ä»¶ä¸‰ï¼š(sc = sizeCtl) &lt; 0 //æˆç«‹ï¼šè¯´æ˜æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼šè¯´æ˜sizeCtlå½“å‰æ˜¯ä¸€ä¸ªå¤§äº0çš„æ•°ï¼Œæ­¤æ—¶ä»£è¡¨ä¸‹æ¬¡æ‰©å®¹çš„é˜ˆå€¼ï¼Œå½“å‰æ‰©å®¹å·²ç»ç»“æŸã€‚ while (nextTab == nextTable &amp;&amp; table == tab &amp;&amp; (sc = sizeCtl) &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼štransferIndex &lt;= 0 // true-&gt;è¯´æ˜mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„ä»»åŠ¡å·²ç»åˆ†é…å®Œäº†ï¼Œå½“å‰çº¿ç¨‹è¿›å»ä¹Ÿæ²¡æ´»å¹².. // false-&gt;è¿˜æœ‰ä»»åŠ¡å¯ä»¥åˆ†é…ã€‚ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || transferIndex &lt;= 0) break; if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) &#123; transfer(tab, nextTab); break; &#125; &#125; return nextTab; &#125; return table;&#125; #10.get 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public V get(Object key) &#123; //tab å¼•ç”¨map.table //e å½“å‰å…ƒç´  //p ç›®æ ‡èŠ‚ç‚¹ //n tableæ•°ç»„é•¿åº¦ //eh å½“å‰å…ƒç´ hash //ek å½“å‰å…ƒç´ key Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; int n, eh; K ek; //æ‰°åŠ¨è¿ç®—åå¾—åˆ° æ›´æ•£åˆ—çš„hashå€¼ int h = spread(key.hashCode()); //æ¡ä»¶ä¸€ï¼š(tab = table) != null //true-&gt;è¡¨ç¤ºå·²ç»putè¿‡æ•°æ®ï¼Œå¹¶ä¸”mapå†…éƒ¨çš„tableä¹Ÿå·²ç»åˆå§‹åŒ–å®Œæ¯• //false-&gt;è¡¨ç¤ºåˆ›å»ºå®Œmapåï¼Œå¹¶æ²¡æœ‰putè¿‡æ•°æ®ï¼Œmapå†…éƒ¨çš„tableæ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å†™æ•°æ®æ—¶ä¼šè§¦å‘åˆ›å»ºé€»è¾‘ã€‚ //æ¡ä»¶äºŒï¼š(n = tab.length) &gt; 0 true-&gt;è¡¨ç¤ºtableå·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(e = tabAt(tab, (n - 1) &amp; h)) != null //true-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ æœ‰å€¼ //false-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ä¸­æ˜¯nullï¼Œæ˜¯nullç›´æ¥è¿”å›null if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (e = tabAt(tab, (n - 1) &amp; h)) != null) &#123; //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ® //å¯¹æ¯”å¤´ç»“ç‚¹hashä¸æŸ¥è¯¢keyçš„hashæ˜¯å¦ä¸€è‡´ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹ä¸æŸ¥è¯¢Keyçš„hashå€¼ å®Œå…¨ä¸€è‡´ if ((eh = e.hash) == h) &#123; //å®Œå…¨æ¯”å¯¹ æŸ¥è¯¢key å’Œ å¤´ç»“ç‚¹çš„key //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹å°±æ˜¯æŸ¥è¯¢æ•°æ® if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) return e.val; &#125; //æ¡ä»¶æˆç«‹ï¼š //1.-1 fwd è¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ï¼Œä¸”å½“å‰æŸ¥è¯¢çš„è¿™ä¸ªæ¡¶ä½çš„æ•°æ® å·²ç»è¢«è¿ç§»èµ°äº† //2.-2 TreeBinèŠ‚ç‚¹ï¼Œéœ€è¦ä½¿ç”¨TreeBin æä¾›çš„find æ–¹æ³•æŸ¥è¯¢ã€‚ else if (eh &lt; 0) return (p = e.find(h, key)) != null ? p.val : null; //å½“å‰æ¡¶ä½å·²ç»å½¢æˆé“¾è¡¨çš„è¿™ç§æƒ…å†µ while ((e = e.next) != null) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) return e.val; &#125; &#125; return null;&#125; #11.remove 123public V remove(Object key) &#123; return replaceNode(key, null, null);&#125; #12.replaceNode 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143final V replaceNode(Object key, V value, Object cv) &#123; //è®¡ç®—keyç»è¿‡æ‰°åŠ¨è¿ç®—åçš„hash int hash = spread(key.hashCode()); //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //fè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ //nè¡¨ç¤ºå½“å‰tableæ•°ç»„é•¿åº¦ //iè¡¨ç¤ºhashå‘½ä¸­æ¡¶ä½ä¸‹æ ‡ //fhè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ hash Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼štab == null true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶äºŒï¼š(n = tab.length) == 0 true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(f = tabAt(tab, i = (n - 1) &amp; hash)) == null true -&gt; è¡¨ç¤ºå‘½ä¸­æ¡¶ä½ä¸­ä¸ºnullï¼Œç›´æ¥breakï¼Œ ä¼šè¿”å› if (tab == null || (n = tab.length) == 0 || (f = tabAt(tab, i = (n - 1) &amp; hash)) == null) break; //CASE2ï¼š //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ä¸­ï¼Œå½“å‰æ˜¯ä¸ªå†™æ“ä½œï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹éœ€è¦ååŠ©tableå®Œæˆæ‰©å®¹ã€‚ else if ((fh = f.hash) == MOVED) tab = helpTransfer(tab, f); //CASE3: //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //å½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ &quot;é“¾è¡¨&quot; ä¹Ÿå¯èƒ½ æ˜¯ &quot;çº¢é»‘æ ‘&quot; TreeBin else &#123; //ä¿ç•™æ›¿æ¢ä¹‹å‰çš„æ•°æ®å¼•ç”¨ V oldVal = null; //æ ¡éªŒæ ‡è®° boolean validated = false; //åŠ é”å½“å‰æ¡¶ä½ å¤´ç»“ç‚¹ï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šè¿›å…¥ ä»£ç å—ã€‚ synchronized (f) &#123; //åˆ¤æ–­syncåŠ é”æ˜¯å¦ä¸ºå½“å‰æ¡¶ä½ å¤´èŠ‚ç‚¹ï¼Œé˜²æ­¢å…¶å®ƒçº¿ç¨‹ï¼Œåœ¨å½“å‰çº¿ç¨‹åŠ é”æˆåŠŸä¹‹å‰ï¼Œä¿®æ”¹è¿‡ æ¡¶ä½ çš„å¤´ç»“ç‚¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šå½“å‰æ¡¶ä½å¤´ç»“ç‚¹ ä»ç„¶ä¸ºfï¼Œå…¶å®ƒçº¿ç¨‹æ²¡ä¿®æ”¹è¿‡ã€‚ if (tabAt(tab, i) == f) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ¡¶ä½ ä¸º é“¾è¡¨ æˆ–è€… å•ä¸ª node if (fh &gt;= 0) &#123; validated = true; //e è¡¨ç¤ºå½“å‰å¾ªç¯å¤„ç†å…ƒç´  //pred è¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ Node&lt;K,V&gt; e = f, pred = null; for (;;) &#123; //å½“å‰èŠ‚ç‚¹key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash true-&gt;è¯´æ˜å½“å‰èŠ‚ç‚¹çš„hashä¸æŸ¥æ‰¾èŠ‚ç‚¹hashä¸€è‡´ //æ¡ä»¶äºŒï¼š((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) //if æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜key ä¸æŸ¥è¯¢çš„keyå®Œå…¨ä¸€è‡´ã€‚ if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å½“å‰èŠ‚ç‚¹çš„value V ev = e.val; //æ¡ä»¶ä¸€ï¼šcv == null true-&gt;æ›¿æ¢çš„å€¼ä¸ºnull é‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªåˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == ev || (ev != null &amp;&amp; cv.equals(ev)) é‚£ä¹ˆæ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (cv == null || cv == ev || (ev != null &amp;&amp; cv.equals(ev))) &#123; //åˆ é™¤ æˆ–è€… æ›¿æ¢ //å°†å½“å‰èŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal åç»­è¿”å›ä¼šç”¨åˆ° oldVal = ev; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (value != null) //ç›´æ¥æ›¿æ¢ e.val = value; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰èŠ‚ç‚¹éå¤´ç»“ç‚¹ else if (pred != null) //å½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ pred.next = e.next; else //è¯´æ˜å½“å‰èŠ‚ç‚¹å³ä¸º å¤´ç»“ç‚¹ï¼Œåªéœ€è¦å°† æ¡¶ä½è®¾ç½®ä¸ºå¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ setTabAt(tab, i, e.next); &#125; break; &#125; pred = e; if ((e = e.next) == null) break; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šTreeBinèŠ‚ç‚¹ã€‚ else if (f instanceof TreeBin) &#123; validated = true; //è½¬æ¢ä¸ºå®é™…ç±»å‹ TreeBin t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //r è¡¨ç¤º çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ //p è¡¨ç¤º çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾åˆ°å¯¹åº”key ä¸€è‡´çš„node TreeNode&lt;K,V&gt; r, p; //æ¡ä»¶ä¸€ï¼š(r = t.root) != null ç†è®ºä¸Šæ˜¯æˆç«‹ //æ¡ä»¶äºŒï¼šTreeNode.findTreeNode ä»¥å½“å‰èŠ‚ç‚¹ä¸ºå…¥å£ï¼Œå‘ä¸‹æŸ¥æ‰¾keyï¼ˆåŒ…æ‹¬æœ¬èº«èŠ‚ç‚¹ï¼‰ // true-&gt;è¯´æ˜æŸ¥æ‰¾åˆ°ç›¸åº”key å¯¹åº”çš„nodeèŠ‚ç‚¹ã€‚ä¼šèµ‹å€¼ç»™p if ((r = t.root) != null &amp;&amp; (p = r.findTreeNode(hash, key, null)) != null) &#123; //ä¿å­˜p.val åˆ°pv V pv = p.val; //æ¡ä»¶ä¸€ï¼šcv == null æˆç«‹ï¼šä¸å¿…å¯¹valueï¼Œå°±åšæ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == pv ||(pv != null &amp;&amp; cv.equals(pv)) æˆç«‹ï¼šè¯´æ˜â€œå¯¹æ¯”å€¼â€ä¸å½“å‰pèŠ‚ç‚¹çš„å€¼ ä¸€è‡´ if (cv == null || cv == pv || (pv != null &amp;&amp; cv.equals(pv))) &#123; //æ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ oldVal = pv; //æ¡ä»¶æˆç«‹ï¼šæ›¿æ¢æ“ä½œ if (value != null) p.val = value; //åˆ é™¤æ“ä½œ else if (t.removeTreeNode(p)) //è¿™é‡Œæ²¡åšåˆ¤æ–­ï¼Œç›´æ¥æäº†...å¾ˆç–‘æƒ‘ setTabAt(tab, i, untreeify(t.first)); &#125; &#125; &#125; &#125; &#125; //å½“å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡æ¡¶ä½ å¤´ç»“ç‚¹æ—¶ï¼Œå½“å‰çº¿ç¨‹ sync å¤´ç»“ç‚¹ é”é”™å¯¹è±¡æ—¶ï¼Œvalidated ä¸ºfalseï¼Œä¼šè¿›å…¥ä¸‹æ¬¡for è‡ªæ—‹ if (validated) &#123; if (oldVal != null) &#123; //æ›¿æ¢çš„å€¼ ä¸ºnullï¼Œè¯´æ˜å½“å‰æ˜¯ä¸€æ¬¡åˆ é™¤æ“ä½œï¼ŒoldVal ï¼=null æˆç«‹ï¼Œè¯´æ˜åˆ é™¤æˆåŠŸï¼Œæ›´æ–°å½“å‰å…ƒç´ ä¸ªæ•°è®¡æ•°å™¨ã€‚ if (value == null) addCount(-1L, -1); return oldVal; &#125; break; &#125; &#125; &#125; return null;&#125; #13.TreeBin##13.1 å±æ€§ 1234567891011121314151617//çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ TreeNode&lt;K,V&gt; root;//é“¾è¡¨çš„å¤´èŠ‚ç‚¹volatile TreeNode&lt;K,V&gt; first;//ç­‰å¾…è€…çº¿ç¨‹ï¼ˆå½“å‰lockStateæ˜¯è¯»é”çŠ¶æ€ï¼‰volatile Thread waiter;/** * 1.å†™é”çŠ¶æ€ å†™æ˜¯ç‹¬å çŠ¶æ€ï¼Œä»¥æ•£åˆ—è¡¨æ¥çœ‹ï¼ŒçœŸæ­£è¿›å…¥åˆ°TreeBinä¸­çš„å†™çº¿ç¨‹ åŒä¸€æ—¶åˆ» åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚ 1 * 2.è¯»é”çŠ¶æ€ è¯»é”æ˜¯å…±äº«ï¼ŒåŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¿›å…¥åˆ° TreeBinå¯¹è±¡ä¸­è·å–æ•°æ®ã€‚ æ¯ä¸€ä¸ªçº¿ç¨‹ éƒ½ä¼šç»™ lockStat + 4 * 3.ç­‰å¾…è€…çŠ¶æ€ï¼ˆå†™çº¿ç¨‹åœ¨ç­‰å¾…ï¼‰ï¼Œå½“TreeBinä¸­æœ‰è¯»çº¿ç¨‹ç›®å‰æ­£åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå†™çº¿ç¨‹æ— æ³•ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆå°±å°†lockStateçš„æœ€ä½2ä½ è®¾ç½®ä¸º 0b 10 */volatile int lockState;// values for lockStatestatic final int WRITER = 1; // set while holding write lockstatic final int WAITER = 2; // set when waiting for write lockstatic final int READER = 4; // increment value for setting read lock ##13.2 æ„é€ å™¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586TreeBin(TreeNode&lt;K,V&gt; b) &#123; //è®¾ç½®èŠ‚ç‚¹hashä¸º-2 è¡¨ç¤ºæ­¤èŠ‚ç‚¹æ˜¯TreeBinèŠ‚ç‚¹ super(TREEBIN, null, null, null); //ä½¿ç”¨first å¼•ç”¨ treeNodeé“¾è¡¨ this.first = b; //r çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹å¼•ç”¨ TreeNode&lt;K,V&gt; r = null; //xè¡¨ç¤ºéå†çš„å½“å‰èŠ‚ç‚¹ for (TreeNode&lt;K,V&gt; x = b, next; x != null; x = next) &#123; next = (TreeNode&lt;K,V&gt;)x.next; //å¼ºåˆ¶è®¾ç½®å½“å‰æ’å…¥èŠ‚ç‚¹çš„å·¦å³å­æ ‘ä¸ºnull x.left = x.right = null; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¢é»‘æ ‘ æ˜¯ä¸€ä¸ªç©ºæ ‘ï¼Œé‚£ä¹ˆè®¾ç½®æ’å…¥å…ƒç´  ä¸ºæ ¹èŠ‚ç‚¹ if (r == null) &#123; //æ ¹èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸€å®šä¸º null x.parent = null; //é¢œè‰²æ”¹ä¸ºé»‘è‰² x.red = false; //è®©rå¼•ç”¨xæ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚ r = x; &#125; else &#123; //éç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œéƒ½ä¼šæ¥å¸¦elseåˆ†æ”¯ï¼Œæ­¤æ—¶çº¢é»‘æ ‘å·²ç»æœ‰æ•°æ®äº† //k è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„key K k = x.key; //h è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„hash int h = x.hash; //kc è¡¨ç¤º æ’å…¥èŠ‚ç‚¹keyçš„classç±»å‹ Class&lt;?&gt; kc = null; //p è¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; p = r; for (;;) &#123; //dir (-1, 1) //-1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼å¤§äº å½“å‰pèŠ‚ç‚¹çš„hash //1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰pèŠ‚ç‚¹çš„hash //ph pè¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹çš„hash int dir, ph; //ä¸´æ—¶èŠ‚ç‚¹ key K pk = p.key; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰èŠ‚ç‚¹ if ((ph = p.hash) &gt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å·¦å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = -1; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å¤§äº å½“å‰èŠ‚ç‚¹ else if (ph &lt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å³å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = 1; //å¦‚æœæ‰§è¡Œåˆ° CASE3ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„hash ä¸ å½“å‰èŠ‚ç‚¹çš„hashä¸€è‡´ï¼Œä¼šåœ¨case3 åšå‡ºæœ€ç»ˆæ’åºã€‚æœ€ç»ˆ //æ‹¿åˆ°çš„dir ä¸€å®šä¸æ˜¯0ï¼Œï¼ˆ-1ï¼Œ 1ï¼‰ else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) dir = tieBreakOrder(k, pk); //xp æƒ³è¦è¡¨ç¤ºçš„æ˜¯ æ’å…¥èŠ‚ç‚¹çš„ çˆ¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; xp = p; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰pèŠ‚ç‚¹ å³ä¸ºæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ //æ¡ä»¶ä¸æˆç«‹ï¼šè¯´æ˜pèŠ‚ç‚¹ åº•ä¸‹è¿˜æœ‰å±‚æ¬¡ï¼Œéœ€è¦å°†pæŒ‡å‘ pçš„å·¦å­èŠ‚ç‚¹ æˆ–è€… å³å­èŠ‚ç‚¹ï¼Œè¡¨ç¤ºç»§ç»­å‘ä¸‹æœç´¢ã€‚ if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //è®¾ç½®æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸º å½“å‰èŠ‚ç‚¹ x.parent = xp; //å°äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ if (dir &lt;= 0) xp.left = x; //å¤§äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ else xp.right = x; //æ’å…¥èŠ‚ç‚¹åï¼Œçº¢é»‘æ ‘æ€§è´¨ å¯èƒ½ä¼šè¢«ç ´åï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨ å¹³è¡¡æ–¹æ³• r = balanceInsertion(r, x); break; &#125; &#125; &#125; &#125; //å°†r èµ‹å€¼ç»™ TreeBinå¯¹è±¡çš„ rootå¼•ç”¨ã€‚ this.root = r; assert checkInvariants(root);&#125; ##13.3 putTreeVal 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970final TreeNode&lt;K,V&gt; putTreeVal(int h, K k, V v) &#123; Class&lt;?&gt; kc = null; boolean searched = false; for (TreeNode&lt;K,V&gt; p = root;;) &#123; int dir, ph; K pk; if (p == null) &#123; first = root = new TreeNode&lt;K,V&gt;(h, k, v, null, null); break; &#125; else if ((ph = p.hash) &gt; h) dir = -1; else if (ph &lt; h) dir = 1; else if ((pk = p.key) == k || (pk != null &amp;&amp; k.equals(pk))) return p; else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) &#123; if (!searched) &#123; TreeNode&lt;K,V&gt; q, ch; searched = true; if (((ch = p.left) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null) || ((ch = p.right) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null)) return q; &#125; dir = tieBreakOrder(k, pk); &#125; TreeNode&lt;K,V&gt; xp = p; if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹xp å³ä¸º x èŠ‚ç‚¹çš„çˆ¸çˆ¸ //x è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹ //f è€çš„å¤´ç»“ç‚¹ TreeNode&lt;K,V&gt; x, f = first; first = x = new TreeNode&lt;K,V&gt;(h, k, v, f, xp); //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜é“¾è¡¨æœ‰æ•°æ® if (f != null) //è®¾ç½®è€çš„å¤´ç»“ç‚¹çš„å‰ç½®å¼•ç”¨ä¸º å½“å‰çš„å¤´ç»“ç‚¹ã€‚ f.prev = x; if (dir &lt;= 0) xp.left = x; else xp.right = x; if (!xp.red) x.red = true; else &#123; //è¡¨ç¤º å½“å‰æ–°æ’å…¥èŠ‚ç‚¹åï¼Œæ–°æ’å…¥èŠ‚ç‚¹ ä¸ çˆ¶èŠ‚ç‚¹ å½¢æˆ â€œçº¢çº¢ç›¸è¿â€ lockRoot(); try &#123; //å¹³è¡¡çº¢é»‘æ ‘ï¼Œä½¿å…¶å†æ¬¡ç¬¦åˆè§„èŒƒã€‚ root = balanceInsertion(root, x); &#125; finally &#123; unlockRoot(); &#125; &#125; break; &#125; &#125; assert checkInvariants(root); return null;&#125; ##13.4 find 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748final Node&lt;K,V&gt; find(int h, Object k) &#123; if (k != null) &#123; //e è¡¨ç¤ºå¾ªç¯è¿­ä»£çš„å½“å‰èŠ‚ç‚¹ è¿­ä»£çš„æ˜¯firstå¼•ç”¨çš„é“¾è¡¨ for (Node&lt;K,V&gt; e = first; e != null; ) &#123; //s ä¿å­˜çš„æ˜¯lockä¸´æ—¶çŠ¶æ€ //ek é“¾è¡¨å½“å‰èŠ‚ç‚¹ çš„key int s; K ek; //(WAITER|WRITER) =&gt; 0010 | 0001 =&gt; 0011 //lockState &amp; 0011 != 0 æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰TreeBin æœ‰ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… ç›®å‰æœ‰å†™æ“ä½œçº¿ç¨‹æ­£åœ¨åŠ é” if (((s = lockState) &amp; (WAITER|WRITER)) != 0) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek)))) return e; e = e.next; &#125; //å‰ç½®æ¡ä»¶ï¼šå½“å‰TreeBinä¸­ ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… å†™çº¿ç¨‹ éƒ½æ²¡æœ‰ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ·»åŠ è¯»é”æˆåŠŸ else if (U.compareAndSwapInt(this, LOCKSTATE, s, s + READER)) &#123; TreeNode&lt;K,V&gt; r, p; try &#123; //æŸ¥è¯¢æ“ä½œ p = ((r = root) == null ? null : r.findTreeNode(h, k, null)); &#125; finally &#123; //w è¡¨ç¤ºç­‰å¾…è€…çº¿ç¨‹ Thread w; //U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) //1.å½“å‰çº¿ç¨‹æŸ¥è¯¢çº¢é»‘æ ‘ç»“æŸï¼Œé‡Šæ”¾å½“å‰çº¿ç¨‹çš„è¯»é” å°±æ˜¯è®© lockstate å€¼ - 4 //(READER|WAITER) = 0110 =&gt; è¡¨ç¤ºå½“å‰åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»ï¼Œä¸”â€œæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…â€ //å½“å‰è¯»çº¿ç¨‹ä¸º TreeBinä¸­çš„æœ€åä¸€ä¸ªè¯»çº¿ç¨‹ã€‚ //2.(w = waiter) != null è¯´æ˜æœ‰ä¸€ä¸ªå†™çº¿ç¨‹åœ¨ç­‰å¾…è¯»æ“ä½œå…¨éƒ¨ç»“æŸã€‚ if (U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) &amp;&amp; (w = waiter) != null) //ä½¿ç”¨unpark è®© å†™çº¿ç¨‹ æ¢å¤è¿è¡ŒçŠ¶æ€ã€‚ LockSupport.unpark(w); &#125; return p; &#125; &#125; &#125; return null;&#125; #æ€»ç»“åœ¨java8ä¸­ï¼ŒConcurrentHashMapä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„ç»„åˆæ–¹å¼ï¼Œåˆ©ç”¨caså’Œsynchronizedä¿è¯å¹¶å‘å†™çš„å®‰å…¨ã€‚ å¼•å…¥çº¢é»‘æ ‘çš„åŸå› ï¼šé“¾è¡¨æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸ºOnï¼Œä½†æ˜¯çº¢é»‘æ ‘çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸ºO(log(n)),æ‰€ä»¥åœ¨èŠ‚ç‚¹æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¢é»‘æ ‘å¯ä»¥å¤§å¤§æå‡æ€§èƒ½ã€‚ é“¾å¼æ¡¶æ˜¯ä¸€ä¸ªç”±nodeèŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨ã€‚æ ‘çŠ¶æ¡¶æ˜¯ä¸€é¢—ç”±TreeNodeèŠ‚ç‚¹ç»„æˆçš„çº¢é»‘æ ‘ã€‚è¾“çš„æ ¹èŠ‚ç‚¹ä¸ºTreeBinç±»å‹ã€‚ å½“é“¾è¡¨é•¿åº¦å¤§äº8æ•´ä¸ªhashè¡¨é•¿åº¦å¤§äº64çš„æ—¶å€™ï¼Œå°±ä¼šè½¬åŒ–ä¸ºTreeBinã€‚TreeBinä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œå…¶å®å°±æ˜¯çº¢é»‘æ ‘å¯¹è±¡ã€‚åœ¨ConcurrentHashMapçš„tableæ•°ç»„ä¸­ï¼Œå­˜æ”¾çš„å°±æ˜¯TreeBinå¯¹è±¡ï¼Œè€Œä¸æ˜¯TreeNoeå¯¹è±¡ã€‚ æ•°ç»„tableæ˜¯æ‡’åŠ è½½çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ï¼Œæ‰€ä»¥initTable()å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ é‡è¦çš„å±æ€§å°±æ˜¯sizeCtlï¼Œç”¨æ¥æ§åˆ¶tableçš„åˆå§‹åŒ–å’Œæ‰©å®¹æ“ä½œçš„è¿‡ç¨‹ï¼š â— -1ä»£è¡¨tableæ­£åœ¨åˆå§‹åŒ–ï¼Œå…¶ä»–çº¿ç¨‹ç›´æ¥joinç­‰å¾…ã€‚ â— -Nä»£è¡¨æœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œä¸¥æ ¼æ¥è¯´ï¼Œå½“å…¶ä¸ºè´Ÿæ•°çš„æ—¶å€™ï¼Œåªç”¨åˆ°äº†ä½16ä½ï¼Œå¦‚æœä½16ä½ä¸ºMï¼Œæ­¤æ—¶æœ‰M-1ä¸ªçº¿ç¨‹è¿›è¡Œæ‰©å®¹ã€‚ â— å¤§äº0æœ‰ä¸¤ç§æƒ…å†µï¼šå¦‚æœtableæ²¡æœ‰åˆå§‹åŒ–ï¼Œå¥¹å°±è¡¨ç¤ºtableåˆå§‹åŒ–çš„å¤§å°ï¼Œå¦‚æœtableåˆå§‹åŒ–å®Œäº†ï¼Œå°±è¡¨ç¤ºtableçš„å®¹é‡ï¼Œé»˜è®¤æ˜¯tableå¤§å°çš„å››åˆ†ä¹‹ä¸‰ã€‚ Transfer()æ‰©å®¹ tableæ•°æ®è½¬ç§»åˆ°nextTableã€‚æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼ŒæŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ConcurrentHashMapç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒæŠŠtableæ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹æ‰€è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„ Bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰Bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚ helpTransfer()å¸®åŠ©æ‰©å®¹ ConcurrentHashMapå¹¶å‘æ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœæ­£åœ¨æ‰©å®¹ï¼Œå…¶ä»–çº¿ç¨‹ä¼šå¸®åŠ©æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å¤šçº¿ç¨‹æ‰©å®¹ã€‚ ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œé»˜è®¤åˆå§‹é•¿åº¦ä¸º16ï¼Œå½“å¾€tableä¸­ç»§ç»­æ·»åŠ å…ƒç´ æ—¶ï¼Œé€šè¿‡Hashå€¼è·Ÿæ•°ç»„é•¿åº¦å–ä½™æ¥å†³å®šæ”¾åœ¨æ•°ç»„çš„å“ªä¸ªBucketä½ç½®ï¼Œå¦‚æœå‡ºç°æ”¾åœ¨åŒä¸€ä¸ªä½ç½®ï¼Œå°±ä¼˜å…ˆä»¥é“¾è¡¨çš„å½¢å¼å­˜æ”¾ï¼Œåœ¨åŒä¸€ä¸ªä½ç½®çš„ä¸ªæ•°è¾¾åˆ°äº†8ä¸ªä»¥ä¸Šï¼Œå¦‚æœæ•°ç»„çš„é•¿åº¦è¿˜å°äº64ï¼Œå°±ä¼šæ‰©å®¹æ•°ç»„ã€‚å¦‚æœæ•°ç»„çš„é•¿åº¦å¤§äºç­‰äº64ï¼Œå°±ä¼šå°†è¯¥èŠ‚ç‚¹çš„é“¾è¡¨è½¬æ¢æˆæ ‘ã€‚ é€šè¿‡æ‰©å®¹æ•°ç»„çš„æ–¹å¼æ¥æŠŠè¿™äº›èŠ‚ç‚¹åˆ†æ•£å¼€ã€‚ç„¶åå°†è¿™äº›å…ƒç´ å¤åˆ¶åˆ°æ‰©å®¹åçš„æ–°æ•°ç»„ä¸­ï¼ŒåŒä¸€ä¸ªBucketä¸­çš„å…ƒç´ é€šè¿‡Hashå€¼çš„æ•°ç»„é•¿åº¦ä½æ¥é‡æ–°ç¡®å®šä½ç½®ï¼Œå¯èƒ½è¿˜æ˜¯æ”¾åœ¨åŸæ¥çš„ä½ç½®ï¼Œä¹Ÿå¯èƒ½æ”¾åˆ°æ–°çš„ä½ç½®ã€‚è€Œä¸”ï¼Œåœ¨æ‰©å®¹å®Œæˆä¹‹åï¼Œå¦‚æœä¹‹å‰æŸä¸ªèŠ‚ç‚¹æ˜¯æ ‘ï¼Œä½†æ˜¯ç°åœ¨è¯¥èŠ‚ç‚¹çš„â€œKey-Valueå¯¹â€æ•°åˆå°äºç­‰äº6ä¸ªï¼Œå°±ä¼šå°†è¯¥æ ‘è½¬ä¸ºé“¾è¡¨ã€‚ put() JDK1.8åœ¨ä½¿ç”¨CASè‡ªæ—‹å®Œæˆæ¡¶çš„è®¾ç½®æ—¶ï¼Œä½¿ç”¨synchronizedå†…ç½®é”ä¿è¯æ¡¶å†…å¹¶å‘æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚å°½ç®¡å¯¹åŒä¸€ä¸ªMapæ“ä½œçš„çº¿ç¨‹äº‰ç”¨ä¼šéå¸¸æ¿€çƒˆï¼Œä½†æ˜¯åœ¨åŒä¸€ä¸ªæ¡¶å†…çš„çº¿ç¨‹äº‰ç”¨é€šå¸¸ä¸ä¼šå¾ˆæ¿€çƒˆï¼Œæ‰€ä»¥ä½¿ç”¨CASè‡ªæ—‹ã€synchronizedä¸ä¼šé™ä½ConcurrentHashMapçš„æ€§èƒ½ã€‚ä¸ºä»€ä¹ˆä¸ç”¨ReentrantLockæ˜¾å¼é”å‘¢?å¦‚æœä¸ºæ¯ ä¸ªæ¡¶éƒ½åˆ›å»ºä¸€ä¸ªReentrantLockå® ä¾‹ï¼Œå°±ä¼šå¸¦æ¥å¤§é‡çš„å†…å­˜æ¶ˆè€—ï¼Œåè¿‡æ¥ï¼Œä½¿ç”¨CASè‡ªæ—‹ã€synchronizedï¼Œå†…å­˜æ¶ˆè€—çš„å¢åŠ æ›´å°ã€‚ get() get()é€šè¿‡UnSafeçš„getObjectVolatile()æ¥è¯»å–æ•°ç»„ä¸­çš„å…ƒç´ ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·åš?è™½ç„¶HashEntryæ•°ç»„çš„å¼•ç”¨æ˜¯volatileç±»å‹ï¼Œä½†æ˜¯æ•°ç»„å†…å…ƒç´ çš„ ç”¨ä¸æ˜¯volatileç±»å‹ï¼Œå› æ­¤å¤šçº¿ç¨‹å¯¹ æ•°ç»„å…ƒç´ çš„ä¿®æ”¹æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šåœ¨æ•°ç»„ä¸­è¯»å–åˆ°å°šæœªæ„é€ å®Œæˆçš„å…ƒç´ å¯¹è±¡ã€‚get()æ–¹æ³•é€šè¿‡UnSafeçš„getObjectVolatileæ–¹æ³•æ¥ä¿è¯å…ƒç´ çš„è¯»å–å®‰å…¨ï¼Œè°ƒç”¨getObjectVolatile()å»è¯»å–æ•°ç»„å…ƒç´ éœ€è¦å…ˆè·å¾—å…ƒç´ åœ¨æ•°ç»„ä¸­çš„åç§»é‡ï¼Œåœ¨è¿™é‡Œï¼Œget()æ–¹æ³•æ ¹æ®å“ˆå¸Œç è®¡ç®—å‡ºåç§»é‡ä¸ºuï¼Œç„¶åé€šè¿‡åç§»é‡uæ¥å°è¯•è¯»å–æ•°å€¼ã€‚","categories":[{"name":"1.åŸºç¡€çŸ¥è¯†","slug":"1-åŸºç¡€çŸ¥è¯†","permalink":"https://yinhuidong.github.io/categories/1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"é›†åˆæºç åˆ†æ","slug":"é›†åˆæºç åˆ†æ","permalink":"https://yinhuidong.github.io/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"}]}],"categories":[{"name":"JUC","slug":"JUC","permalink":"https://yinhuidong.github.io/categories/JUC/"},{"name":"æ¶ˆæ¯é˜Ÿåˆ—","slug":"æ¶ˆæ¯é˜Ÿåˆ—","permalink":"https://yinhuidong.github.io/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"},{"name":"MyBatis","slug":"MyBatis","permalink":"https://yinhuidong.github.io/categories/MyBatis/"},{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/categories/Spring/"},{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"},{"name":"1.åŸºç¡€çŸ¥è¯†","slug":"1-åŸºç¡€çŸ¥è¯†","permalink":"https://yinhuidong.github.io/categories/1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://yinhuidong.github.io/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"},{"name":"RabbitMQ","slug":"RabbitMQ","permalink":"https://yinhuidong.github.io/tags/RabbitMQ/"},{"name":"MyBatis","slug":"MyBatis","permalink":"https://yinhuidong.github.io/tags/MyBatis/"},{"name":"Spring","slug":"Spring","permalink":"https://yinhuidong.github.io/tags/Spring/"},{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"},{"name":"é›†åˆæºç åˆ†æ","slug":"é›†åˆæºç åˆ†æ","permalink":"https://yinhuidong.github.io/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"}]}