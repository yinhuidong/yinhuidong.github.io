{"meta":{"title":"äºŒå","subtitle":"å·å°±å®Œäº†","description":"æ¬¢è¿æ¥å·","author":"äºŒå","url":"https://yinhuidong.github.io","root":"/"},"pages":[{"title":"åˆ†ç±»","date":"2022-01-10T12:46:21.418Z","updated":"2021-12-27T12:21:34.000Z","comments":true,"path":"categories/index.html","permalink":"https://yinhuidong.github.io/categories/index.html","excerpt":"","text":""},{"title":"","date":"2022-01-10T12:46:21.415Z","updated":"2021-12-27T12:21:34.000Z","comments":true,"path":"css/custom.css","permalink":"https://yinhuidong.github.io/css/custom.css","excerpt":"","text":"/* æ–‡ç« é¡µH1-H6å›¾æ ‡æ ·å¼æ•ˆæœ */ h1::before, h2::before, h3::before, h4::before, h5::before, h6::before { -webkit-animation: ccc 1.6s linear infinite ; animation: ccc 1.6s linear infinite ; } @-webkit-keyframes ccc { 0% { -webkit-transform: rotate(0deg); transform: rotate(0deg) } to { -webkit-transform: rotate(-1turn); transform: rotate(-1turn) } } @keyframes ccc { 0% { -webkit-transform: rotate(0deg); transform: rotate(0deg) } to { -webkit-transform: rotate(-1turn); transform: rotate(-1turn) } } #content-inner.layout h1::before { color: #ef50a8 ; margin-left: -1.55rem; font-size: 1.3rem; margin-top: -0.23rem; } #content-inner.layout h2::before { color: #fb7061 ; margin-left: -1.35rem; font-size: 1.1rem; margin-top: -0.12rem; } #content-inner.layout h3::before { color: #ffbf00 ; margin-left: -1.22rem; font-size: 0.95rem; margin-top: -0.09rem; } #content-inner.layout h4::before { color: #a9e000 ; margin-left: -1.05rem; font-size: 0.8rem; margin-top: -0.09rem; } #content-inner.layout h5::before { color: #57c850 ; margin-left: -0.9rem; font-size: 0.7rem; margin-top: 0.0rem; } #content-inner.layout h6::before { color: #5ec1e0 ; margin-left: -0.9rem; font-size: 0.66rem; margin-top: 0.0rem; } #content-inner.layout h1:hover, #content-inner.layout h2:hover, #content-inner.layout h3:hover, #content-inner.layout h4:hover, #content-inner.layout h5:hover, #content-inner.layout h6:hover { color: #49b1f5 ; } #content-inner.layout h1:hover::before, #content-inner.layout h2:hover::before, #content-inner.layout h3:hover::before, #content-inner.layout h4:hover::before, #content-inner.layout h5:hover::before, #content-inner.layout h6:hover::before { color: #49b1f5 ; -webkit-animation: ccc 3.2s linear infinite ; animation: ccc 3.2s linear infinite ; } /* é¡µé¢è®¾ç½®iconè½¬åŠ¨é€Ÿåº¦è°ƒæ•´ */ #rightside_config i.fas.fa-cog.fa-spin { animation: fa-spin 5s linear infinite ; } /*--------æ›´æ¢å­—ä½“------------*/ @font-face { font-family: 'tzy'; /* å­—ä½“åè‡ªå®šä¹‰å³å¯ */ src: url('https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/font/ZhuZiAWan.woff2'); /* å­—ä½“æ–‡ä»¶è·¯å¾„ */ font-display: swap; } body, .gitcalendar { font-family: tzy !important; } .categoryBar-list { max-height: 400px; } .clock-row { overflow: hidden; text-overflow: ellipsis; } /*3sä¸ºåŠ è½½åŠ¨ç”»çš„æ—¶é—´ï¼Œ1ä¸ºåŠ è½½åŠ¨ç”»çš„æ¬¡æ•°ï¼Œease-in-outä¸ºåŠ¨ç”»æ•ˆæœ*/ #page-header, #web_bg { -webkit-animation: imgblur 2s 1 ease-in-out; animation: imgblur 2s 1 ease-in-out; } @keyframes imgblur { 0% { filter: blur(5px); } 100% { filter: blur(0px); } } /*é€‚é…ä½¿ç”¨-webkitå†…æ ¸çš„æµè§ˆå™¨ */ @-webkit-keyframes imgblur { 0% { -webkit-filter: blur(5px); } 100% { -webkit-filter: blur(0px); } } .table-wrap img { margin: .6rem auto .1rem !important; } /* æ ‡ç­¾å¤–æŒ‚ ç½‘ç«™å¡ç‰‡ start */ .site-card-group img { margin: 0 auto .1rem !important; } .site-card-group .info a img { margin-right: 10px !important; } [data-theme='dark'] .site-card-group .site-card .info .title { color: #f0f0f0 !important; } [data-theme='dark'] .site-card-group .site-card .info .desc { color: rgba(255, 255, 255, .7) !important; } .site-card-group .info .desc { margin-top: 4px !important; } /* ä»£ç å—é¢œè‰² */ figure.highlight pre .addition { color: #00bf03 !important; }"},{"title":"ç•™è¨€æ¿","date":"2022-01-10T12:46:21.418Z","updated":"2021-12-27T12:21:35.000Z","comments":true,"path":"message/index.html","permalink":"https://yinhuidong.github.io/message/index.html","excerpt":"","text":"æœ¬é¡µé¢è¿˜åœ¨å¼€å‘ä¸­â€¦â€¦"},{"title":"æ ‡ç­¾","date":"2022-01-10T12:46:21.418Z","updated":"2021-12-27T12:21:35.000Z","comments":true,"path":"tags/index.html","permalink":"https://yinhuidong.github.io/tags/index.html","excerpt":"","text":""},{"title":"å…³äºæˆ‘","date":"2022-01-11T02:40:01.624Z","updated":"2022-01-11T02:40:01.624Z","comments":true,"path":"å…³äºæˆ‘/index.html","permalink":"https://yinhuidong.github.io/%E5%85%B3%E4%BA%8E%E6%88%91/index.html","excerpt":"","text":"å…³äºæˆ‘åå¹´ç”Ÿæ­»ä¸¤èŒ«èŒ«,å†™ç¨‹åºï¼Œåˆ°å¤©äº®ã€‚åƒè¡Œä»£ç ï¼ŒBugä½•å¤„è—ã€‚çºµä½¿ä¸Šçº¿åˆæ€æ ·ï¼Œæœä»¤æ”¹ï¼Œå¤•æ–­è‚ ã€‚é¢†å¯¼æ¯å¤©æ–°æƒ³æ³•ï¼Œå¤©å¤©æ”¹ï¼Œæ—¥æ—¥å¿™ã€‚ ç›¸é¡¾æ— è¨€ï¼ŒæƒŸæœ‰æ³ªåƒè¡Œã€‚æ¯æ™šç¯ç«é˜‘çŠå¤„ï¼Œç¨‹åºå‘˜ï¼ŒåˆåŠ ç­ï¼Œå·¥ä½œç‹‚~ ğŸ¤£ğŸ¤£ğŸ¤£ åŸºæœ¬ä¿¡æ¯ ç±»åˆ« ä¿¡æ¯ å‡ºç”Ÿå¹´æœˆ 1998å¹´11æœˆ ç°å±…åœ° åŒ—äº¬å¸‚ ç±è´¯ å¤§åº†å¸‚ é‚®ç®± &#x31;&#x39;&#55;&#x32;&#48;&#51;&#57;&#x37;&#x37;&#51;&#64;&#x71;&#113;&#46;&#x63;&#111;&#x6d; æ•™è‚²ç»å† æ—¶é—´ å­¦æ ¡ ä¸“ä¸š å¤‡æ³¨ 2017.09~2021.07 é½é½å“ˆå°”å¤§å­¦ è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ ç»Ÿæ‹›æœ¬ç§‘ å·¥ä½œç»å† æ—¶é—´ å…¬å¸ èŒä½ 2021.06~è‡³ä»Š mi Java å¼€å‘å·¥ç¨‹å¸ˆ ä¸“ä¸šæŠ€èƒ½ Java åŸºç¡€æ‰å®ã€æŒæ¡ JVM åŸç†ã€å¤šçº¿ç¨‹ã€ç½‘ç»œåŸç†ã€è®¾è®¡æ¨¡å¼ã€å¸¸ç”¨çš„æ•°æ®ç»“æ„å’Œç®—æ³• ç†Ÿæ‚‰ Windowsã€Macã€Linux æ“ä½œç³»ç»Ÿï¼Œç†Ÿç»ƒä½¿ç”¨ linux å¸¸ç”¨æ“ä½œæŒ‡ä»¤ ç†Ÿç»ƒä½¿ç”¨ IntelliJ IDEA å¼€å‘å·¥å…·(åŠå„ç§æ’ä»¶)ã€ç†Ÿç»ƒä½¿ç”¨ Git ç‰ˆæœ¬åŒæ­¥å·¥å…· é˜…è¯»è¿‡ Springã€SpringMVCã€ç­‰å¼€æºæ¡†æ¶æºç ï¼Œç†è§£å…¶è®¾è®¡åŸç†åŠåº•å±‚æ¶æ„ï¼Œå…·å¤‡æ¡†æ¶å®šåˆ¶å¼€å‘èƒ½åŠ› ç†è§£ Redis çº¿ç¨‹æ¨¡å‹ï¼ŒNetty çº¿ç¨‹æ¨¡å‹ï¼ŒæŒæ¡åŸºäºå“åº”å¼çš„å¼‚æ­¥éé˜»å¡æ¨¡å‹çš„åŸºæœ¬åŸç†ï¼Œäº†è§£ Webflux ç†Ÿç»ƒæŒæ¡åˆ†å¸ƒå¼ç¼“å­˜ Redisã€Elaticsearchï¼Œå¯¹åˆ†å¸ƒå¼é”ï¼Œå¹‚ç­‰ç­‰å¸¸è§é—®é¢˜æœ‰æ·±å…¥ç ”ç©¶åŠå¤šå¹´å®æˆ˜ç»éªŒ ç†Ÿæ‚‰å¸¸è§æ¶ˆæ¯ä¸­é—´ä»¶çš„ä½¿ç”¨ï¼Œæœ‰å¤šå¹´ RabbitMQ çš„å®æˆ˜å¼€å‘ç»éªŒï¼Œå¯¹é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—æœ‰æ·±å…¥ç†è§£ ç†Ÿç»ƒæŒæ¡ Mysql äº‹åŠ¡ï¼Œç´¢å¼•ï¼Œé”ï¼ŒSQL ä¼˜åŒ–ç›¸å…³çŸ¥è¯†ï¼Œå¯æ ¹æ®ä¸šåŠ¡åœºæ™¯ç»™å‡ºè¯¦ç»†åŠé«˜æ€§èƒ½è®¾è®¡æ–¹æ¡ˆ ç†Ÿç»ƒä½¿ç”¨æ•°æ®åº“æ“ä½œæ¡†æ¶ Mybatisã€Mybatsi-plus è¿›è¡Œé«˜æ•ˆä¸šåŠ¡åŠŸèƒ½å¼€å‘ æŒæ¡ springCloud ç›¸å…³æ¡†æ¶ï¼Œå¯¹ SpringBootã€SpringCloud åŸç†æœ‰ä¸€å®šäº†è§£ï¼Œæœ‰æˆç†Ÿé¡¹ç›®ç»éªŒ ç†Ÿæ‚‰å®šæ—¶ä»»åŠ¡åŠå»¶è¿Ÿä»»åŠ¡ç­‰ä¸šåŠ¡ç›¸å…³è®¾è®¡ï¼Œå¦‚ xxl-jobï¼Œå»¶è¿Ÿæ¶ˆæ¯ç­‰ç›¸å…³æŠ€æœ¯æœ‰å¤šå¹´å¼€å‘ç»éªŒ ç†Ÿæ‚‰å¾®æœåŠ¡æ€æƒ³ï¼ŒMVC åˆ†å±‚ï¼ŒDDD ç†è®ºï¼ŒæœåŠ¡æ‹†åˆ†ï¼Œæ²»ç†ï¼Œç›‘æ§ï¼ŒæœåŠ¡ç†”æ–­ï¼Œé™çº§ç­‰ç›¸å…³èƒ½åŠ› ç†Ÿæ‚‰ jvm åŸç†ï¼Œç†Ÿæ‚‰åƒåœ¾å›æ”¶ä»¥ jvm æ€§èƒ½è°ƒä¼˜æŠ€æœ¯ï¼Œæœ‰è¿‡çº¿ä¸ŠæœåŠ¡å™¨æ€§èƒ½ç›‘æµ‹åŠè°ƒä¼˜ç»éªŒ ç†Ÿæ‚‰å¤šçº¿ç¨‹åŠçº¿ç¨‹æ± ä½¿ç”¨ï¼Œæœ‰å¤šå¹´å¤šçº¿ç¨‹ä¸šåŠ¡å¤„ç†ç»éªŒï¼Œå°è£…è¿‡å¤šçº¿ç¨‹æ‰¹å¤„ç†å·¥å…·ç±»ç­‰å…¬ç”¨ç»„å»º äº†è§£ Mysql åˆ†åº“åˆ†è¡¨ç›¸å…³åŸç†ï¼Œå¦‚ Sardingsphereã€Mycat ç­‰æ¡†æ¶æœ‰ç›¸å…³ä½¿ç”¨ç»éªŒ äº†è§£æ“ä½œç³»ç»Ÿåº•å±‚åŸç†ä»¥åŠ Cã€C++ç¨‹åºå¼€å‘ï¼Œå¯¹è®¡ç®—æœºåº•å±‚åŸç†æœ‰åˆæ­¥äº†è§£ äº†è§£å‰ç«¯å¼€å‘ï¼Œäº†è§£ htmlï¼Œcssï¼Œjsï¼Œvue ç­‰å‰ç«¯æŠ€æœ¯ï¼Œå¯¹å‰ç«¯å¼€å‘æœ‰ä¸€å®šçš„äº†è§£ ç ”ç©¶è¿‡å•ç‰‡æœºç­‰ç¡¬ä»¶å¼€å‘ï¼Œå–œæ¬¢ç§‘æŠ€äº§å“ï¼Œå–œæ¬¢è½¯ä»¶ï¼Œå–œæ¬¢æŠ˜è…¾å„ç§ç”µå­äº§å“ä»¥åŠè½¯ä»¶ é¡¹ç›®ç»éªŒâ€‹ è‡ªæˆ‘è¯„ä»·NBã€‚"},{"title":"æŠ€æœ¯ç¬”è®°","date":"2022-01-10T12:46:21.418Z","updated":"2021-12-27T12:21:35.000Z","comments":true,"path":"æŠ€æœ¯ç¬”è®°/index.html","permalink":"https://yinhuidong.github.io/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/index.html","excerpt":"","text":"æˆ‘æ˜¯æŠ€æœ¯ç¬”è®°"},{"title":"","date":"2022-01-10T12:46:21.418Z","updated":"2021-12-27T12:21:35.000Z","comments":true,"path":"js/chocolate.js","permalink":"https://yinhuidong.github.io/js/chocolate.js","excerpt":"","text":"/* * @Author: tzy1997 * @Date: 2020-12-15 20:55:25 * @LastEditors: tzy1997 * @LastEditTime: 2021-01-12 19:02:25 */ // å‹æƒ…é“¾æ¥é¡µé¢ å¤´åƒæ‰¾ä¸åˆ°æ—¶ æ›¿æ¢å›¾ç‰‡ if (location.href.indexOf(\"link\") !== -1) { var imgObj = document.getElementsByTagName(\"img\"); for (i = 0; i < imgObj.length; i++) { imgObj[i].onerror = function() { this.src = \"https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/theme_f/friend_404.gif\" } } } $(function() { // æ°”æ³¡ function bubble() { $('#page-header').circleMagic({ radius: 10, density: .2, color: 'rgba(255,255,255,.4)', clearOffset: 0.99 }); }! function(p) { p.fn.circleMagic = function(t) { var o, a, n, r, e = !0, i = [], d = p.extend({ color: \"rgba(255,0,0,.5)\", radius: 10, density: .3, clearOffset: .2 }, t), l = this[0]; function c() { e = !(document.body.scrollTop > a) } function s() { o = l.clientWidth, a = l.clientHeight, l.height = a + \"px\", n.width = o, n.height = a } function h() { if (e) for (var t in r.clearRect(0, 0, o, a), i) i[t].draw(); requestAnimationFrame(h) } function f() { var t = this; function e() { t.pos.x = Math.random() * o, t.pos.y = a + 100 * Math.random(), t.alpha = .1 + Math.random() * d.clearOffset, t.scale = .1 + .3 * Math.random(), t.speed = Math.random(), \"random\" === d.color ? t.color = \"rgba(\" + Math.floor(255 * Math.random()) + \", \" + Math.floor(0 * Math.random()) + \", \" + Math.floor(0 * Math.random()) + \", \" + Math.random().toPrecision(2) + \")\" : t.color = d.color } t.pos = {}, e(), this.draw = function() { t.alpha"}],"posts":[{"title":"MySQL[ä¸€]å…¥é—¨","slug":"MySQL/MySQL[ä¸€]å…¥é—¨","date":"2022-01-11T02:49:27.263Z","updated":"2022-01-11T03:00:18.028Z","comments":true,"path":"2022/01/11/MySQL/MySQL[ä¸€]å…¥é—¨/","link":"","permalink":"https://yinhuidong.github.io/2022/01/11/MySQL/MySQL[%E4%B8%80]%E5%85%A5%E9%97%A8/","excerpt":"","text":"ä¸€ï¼ŒMYSQLå…¥é—¨1.æ•°æ®åº“ç›¸å…³æ¦‚å¿µ123DBï¼šæ•°æ®åº“ï¼šå­˜å‚¨æ•°æ®çš„ä»“åº“ï¼Œä¿å­˜äº†ä¸€ç³»åˆ—æœ‰ç»„ç»‡çš„æ•°æ®ã€‚DBMSï¼šæ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼šæ•°æ®åº“æ˜¯é€šè¿‡DBMSåˆ›å»ºå’Œæ“ä½œçš„å®¹å™¨ã€‚SQLï¼šç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ï¼šä¸“é—¨ç”¨æ¥ä¸æ•°æ®åº“é€šä¿¡çš„è¯­è¨€ã€‚ 2.æ•°æ®åº“çš„å¥½å¤„121.å¯ä»¥æŒä¹…åŒ–æ•°æ®åˆ°æœ¬åœ°2.å¯ä»¥å®ç°ç»“æ„åŒ–æŸ¥è¯¢ï¼Œæ–¹ä¾¿ç®¡ç† 3.æ•°æ®åº“å­˜å‚¨æ•°æ®ç‰¹ç‚¹12345671.å°†æ•°æ®æ”¾åˆ°è¡¨ä¸­ï¼Œè¡¨æ”¾åˆ°åº“ä¸­ã€‚2.ä¸€ä¸ªæ•°æ®åº“æœ‰å¤šå¼ è¡¨ï¼Œæ¯ä¸ªè¡¨éƒ½æœ‰ä¸€ä¸ªåå­—ï¼Œç”¨æ¥æ ‡è¯†è‡ªå·±ã€‚è¡¨åå…·æœ‰å”¯ä¸€æ€§ã€‚3.è¡¨å…·æœ‰ä¸€äº›ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§å®šä¹‰äº†æ•°æ®åœ¨è¡¨ä¸­å¦‚ä½•å­˜å‚¨ï¼Œç±»ä¼¼Javaä¸­ç±»çš„è®¾è®¡ã€‚4.è¡¨æœ‰åˆ—ç»„æˆï¼Œæˆ‘ä»¬ä¹Ÿç§°ä¸ºå­—æ®µã€‚æ‰€æœ‰è¡¨éƒ½æ˜¯ç”±ä¸€ä¸ªåˆ—æˆ–å¤šä¸ªåˆ—ç»„æˆçš„ï¼Œæ¯ä¸€åˆ—ç±»ä¼¼Javaä¸­çš„å±æ€§ã€‚5.è¡¨ä¸­çš„æ•°æ®æŒ‰ç…§è¡Œæ¥å­˜å‚¨ï¼Œæ¯ä¸€è¡Œç±»ä¼¼äºJavaä¸­çš„å¯¹è±¡ã€‚ 4.mysqlçš„å®‰è£…ä¸ä½¿ç”¨å‚ç…§mysqlå®‰è£…æ–‡æ¡£ 5.Mysqlå¸¸ç”¨å‘½ä»¤12345678910111213141516171819æ˜¾ç¤ºæ•°æ®åº“-----&gt;show Databases;ä½¿ç”¨æ•°æ®åº“-----&gt;use æ•°æ®åº“åï¼›æ˜¾ç¤ºè¡¨----&gt;show tables;æ˜¾å¼æŒ‡å®šæ•°æ®åº“çš„è¡¨----&gt;show tables from æ•°æ®åº“åï¼›æŸ¥çœ‹ä½äºé‚£ä¸ªæ•°æ®åº“----&gt;select database();æ˜¾ç¤ºè¡¨ç»“æ„---&gt;desc è¡¨åï¼›æŸ¥çœ‹æ•°æ®åº“ç‰ˆæœ¬ï¼š---&gt;select version();æŸ¥çœ‹æ•°æ®åº“ç‰ˆæœ¬2:-----&gt;Dos:mysql --version;æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯-----&gt;show CREATE DATABASE mydb1;æŸ¥çœ‹æœåŠ¡å™¨ä¸­çš„æ•°æ®åº“ï¼Œå¹¶æŠŠmydb1çš„å­—ç¬¦é›†ä¿®æ”¹ä¸ºutf-8-----&gt;ALTER DATABASE mydb1character set utf8;åˆ é™¤æ•°æ®åº“-----&gt;drop database mydb1;è¡¨ä¸­å¢åŠ ä¸€æ ä¿¡æ¯-----&gt;alter table student add image blob;åˆ é™¤è¡¨-----&gt;drop table student;ä¿®æ”¹åœ°å€-----&gt;alter table student modify address varchar(100);åˆ é™¤ä¸€ä¸ªå±æ€§-----&gt; alter table student drop image;ä¿®æ”¹è¡¨å-----&gt;rename table student to students;æŸ¥çœ‹è¡¨çš„åˆ›å»ºç»†èŠ‚-----&gt;show create table students;ä¿®æ”¹è¡¨çš„å­—ç¬¦é›†ä¸º gbk-----&gt;alter table students character set gbk;åˆ—ånameä¿®æ”¹ä¸ºstudentname-----&gt;alter table students change name studentname varchar(100); 6.mysqlè¯­æ³•è§„èŒƒ12345671.ä¸åŒºåˆ†å¤§å°å†™ï¼Œå»ºè®®å…³é”®å­—å¤§å†™ï¼Œè¡¨ååˆ—åå°å†™ã€‚2.æ¯æ¡å‘½ä»¤æœ€å¥½ç”¨åˆ†å·ç»“å°¾ã€‚3.æ¯æ¡è¯­å¥å¯ä»¥ç¼©è¿›ï¼Œæ¢è¡Œã€‚4.æ³¨é‡Šå•è¡Œæ³¨é‡Šï¼š#æ³¨é‡Šæ–‡å­— -- æ³¨é‡Šæ–‡å­—å¤šè¡Œæ³¨é‡Šï¼š/* */ äºŒï¼ŒDQLæŸ¥è¯¢è¯­è¨€1.åŸºç¡€æŸ¥è¯¢12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758**è¯­æ³•ï¼š select æŸ¥è¯¢åˆ—è¡¨ from è¡¨å****æŸ¥è¯¢åˆ—è¡¨ï¼šè¡¨ä¸­çš„å­—æ®µï¼Œå¸¸é‡ï¼Œè¡¨è¾¾å¼ï¼Œå‡½æ•°****æŸ¥è¯¢çš„ç»“æœæ˜¯å¼ è™šæ‹Ÿçš„è¡¨æ ¼**1.æŸ¥è¯¢è¡¨ä¸­çš„å•ä¸ªå­—æ®µselect last_name from employee;2.æŸ¥è¯¢è¡¨ä¸­çš„å¤šä¸ªå­—æ®µselect last_name,salary,email from employee;3.æŸ¥è¯¢è¡¨ä¸­çš„æ‰€æœ‰å­—æ®µselect * from employee;4.æŸ¥è¯¢å¸¸é‡å€¼select 100;select &#x27;john&#x27;;5.æŸ¥è¯¢è¡¨è¾¾å¼select 100*98;6.æŸ¥è¯¢å‡½æ•°select version();7.èµ·åˆ«åselect last_name as name from employee;select last_name name from employee;8.å»é‡æŸ¥è¯¢å‘˜å·¥è¡¨ä¸­æ¶‰åŠåˆ°çš„æ‰€æœ‰çš„éƒ¨é—¨ç¼–å·select distinct department_id from employee;9.+çš„ä½œç”¨#è¿ç®—ç¬¦ï¼šä¸¤ä¸ªæ“ä½œæ•°éƒ½ä¸ºæ•°å€¼å‹ï¼Œåˆ™åšåŠ æ³•è¿ç®—ï¼›#å…¶ä¸­ä¸€æ–¹ä¸ºå­—ç¬¦å‹ï¼Œè¯•å›¾å°†å­—ç¬¦å‹æ•°å€¼è½¬æ¢æˆæ•°å€¼å‹ï¼Œ#å¦‚æœè½¬æ¢æˆåŠŸï¼Œç»§ç»­åšåŠ æ³•è¿ç®—ï¼›å¦åˆ™ï¼Œå°†å­—ç¬¦å‹æ•°å€¼#è½¬æ¢ä¸º0ï¼›10.ä½¿ç”¨concatå®ç°è¿æ¥#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥åå’Œæ€§è¿æ¥æˆä¸€ä¸ªå­—æ®µSELECT CONCAT(username,PASSWORD) FROM USER;#ä»»ä½•æ•°ä¸nullåšè¿ç®—ç»“æœéƒ½ä¸ºnull 2.æ¡ä»¶æŸ¥è¯¢è¯­æ³•ï¼š select æŸ¥è¯¢åˆ—è¡¨ from è¡¨å where ç­›é€‰æ¡ä»¶ åˆ†ç±»ï¼š â‘ æŒ‰ç…§æ¡ä»¶è¡¨è¾¾å¼ç­›é€‰æ¡ä»¶è¿ç®—ç¬¦ï¼š&gt;,&lt;,=,!=,&gt;=,&lt;= 123456æŸ¥è¯¢å‘˜å·¥å·¥èµ„&gt;1w2çš„å‘˜å·¥ä¿¡æ¯select * from employee where salary &gt;12000;æŸ¥è¯¢éƒ¨é—¨ç¼–å·ï¼=90å·çš„å‘˜å·¥åå’Œéƒ¨é—¨ç¼–å·select name, dep_id from employee where dep_id 1=90ï¼› â‘¡æŒ‰ç…§é€»è¾‘è¡¨è¾¾å¼ç­›é€‰é€»è¾‘è¿ç®—ç¬¦ï¼š&amp;&amp;,||,!,AND,OR,NOT 1234æŸ¥è¯¢å·¥èµ„åœ¨ä¸€ä¸‡åˆ°ä¸¤ä¸‡ä¹‹è§çš„å‘˜å·¥åï¼Œå·¥èµ„ä»¥åŠå¥–é‡‘ã€‚select name,salary ,jiangjin where salary between 10000 and 20000;æŸ¥è¯¢éƒ¨é—¨ç¼–å·ä¸åœ¨90-110ä¹‹é—´ï¼Œæˆ–è€…å·¥èµ„é«˜äº15000çš„å‘˜å·¥ä¿¡æ¯ã€‚select * from employee where department&lt;90||department&gt;110 ||salary &gt;15000; â‘¢æ¨¡ç³ŠæŸ¥è¯¢likeï¼šä¸€èˆ¬å’Œé€šé…ç¬¦æ­é…ä½¿ç”¨é€šé…ç¬¦ï¼š%ä»»æ„å¤šä¸ªå­—ç¬¦ï¼ŒåŒ…å«0ä¸ªå­—ç¬¦_ä»»æ„å•ä¸ªå­—ç¬¦BETWEEN AND:åŒ…å«ä¸´ç•Œå€¼IN:åˆ¤æ–­æŸä¸ªå­—æ®µçš„å€¼æ˜¯å¦å±äºinåˆ—è¡¨ä¸­çš„æŸä¸€é¡¹IS NULL,IS NOT NULL:=æˆ–è€…ï¼=ä¸èƒ½ç”¨æ¥åˆ¤æ–­nullå®‰å…¨ç­‰äº&lt;=&gt;å¯ä»¥åˆ¤æ–­null 123456789101112131415æŸ¥è¯¢å‘˜å·¥åä¸­åŒ…å«açš„å‘˜å·¥ä¿¡æ¯select * from emp where name like %a%;æŸ¥è¯¢å‘˜å·¥åä¸­ç¬¬ä¸‰ä¸ªå­—ç¬¦ä¸ºeç¬¬äº”ä¸ªå­—ç¬¦ä¸ºaçš„å‘˜å·¥åå’Œå·¥èµ„select name ,salary from emp where name like %__e_a%;å‘˜å·¥åä¸­ç¬¬äºŒä¸ªå­—ç¬¦ä¸º_çš„å‘˜å·¥åselect name from emp where name like %_\\_%;æŸ¥è¯¢å‘˜å·¥ç¼–å·åœ¨100åˆ°120ä¹‹é—´çš„æ‰€æœ‰å‘˜å·¥ä¿¡æ¯select * from emp where id between 100 and 120;æŸ¥è¯¢å‘˜å·¥çš„å·¥ç§ç¼–å·æ˜¯IT_PRIG,AD_PRES,AD_VPä¸­çš„ä¸€ä¸ªå‘˜å·¥åå’Œå·¥ç§ç¼–å·ï¼›select name , id from emp where id in(IT_PRIG,AD_PRES,AD_VP);æŸ¥è¯¢æ²¡æœ‰å¥–é‡‘çš„å‘˜å·¥åå’Œå¥–é‡‘ç‡select salary , jjl from emp where salary is Null;æŸ¥è¯¢æœ‰å¥–é‡‘çš„å‘˜å·¥åå’Œå¥–é‡‘ç‡select salary ,jjl from emp where salary is not null; â‘£IF nullçš„ä½¿ç”¨ï¼š123æŸ¥è¯¢å‘˜å·¥å·ä¸º176çš„å‘˜å·¥çš„å§“åå’Œéƒ¨é—¨å·å’Œå¹´è–ªSELECT last_name ,department_id , salary*(1+IFNULL(commission_pct,0))*12 &#x27;å¹´è–ª&#x27;FROM employees WHERE employee_id =176; 3.æ’åºæŸ¥è¯¢è¯­æ³•ï¼š select æŸ¥è¯¢åˆ—è¡¨ from è¡¨ where ç­›é€‰æ¡ä»¶ order by æ’åºåˆ—è¡¨ asc æˆ–desc ï¼ˆå‡åºæˆ–è€…é™åºï¼Œé»˜è®¤ä¸ºå‡åºï¼‰ 12345678910æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯ï¼Œè¦æ±‚å·¥èµ„ä»é«˜åˆ°ä½æ’åºselect * from emp order by salary desc;æŸ¥è¯¢éƒ¨é—¨ç¼–å·å¤§äºç­‰äº90çš„å‘˜å·¥ä¿¡æ¯ï¼ŒæŒ‰ç…§å…¥èŒæ—¶é—´å…ˆåæ’åºselect * from emp where dep_id &gt;=90 order by createtime asc;æŒ‰ç…§å‘˜å·¥å¹´è–ªçš„é«˜ä½æ˜¾ç¤ºå‘˜å·¥çš„ä¿¡æ¯å’Œå¹´è–ªselect * ,å¹´è–ª from emp order by salary*(1+if null(jjl,0))*12 as å¹´è–ª desc;æŒ‰å§“åé•¿åº¦æ˜¾ç¤ºå‘˜å·¥çš„å§“åå’Œå·¥èµ„select name ,salary from emp order by length(name) asc;æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯ï¼Œå…ˆæŒ‰ç…§å·¥èµ„æ’åºï¼Œå†æŒ‰ç…§å‘˜å·¥ç¼–å·æ’åºselect * from emp order by salary asc,id asc; 4.å¸¸è§å‡½æ•°åŠŸèƒ½ï¼šç±»ä¼¼Javaä¸­çš„æ–¹æ³•åˆ†ç±»ï¼šå•è¡Œå‡½æ•°åˆ†ç»„å‡½æ•° 1.å•è¡Œå‡½æ•°1.å­—ç¬¦å‡½æ•°12345678910111213141516171819202122232425262728293031323334353637381.length è·å–å‚æ•°å€¼çš„å­—èŠ‚ä¸ªæ•°select * from emp order by length(name);2.concat æ‹¼æ¥å­—ç¬¦ä¸²select concat(last_name,first_name) as å§“å from emp;3.upperï¼Œlower å¤§å°å†™è½¬æ¢å‡½æ•°æ¡ˆä¾‹ï¼šå°†å§“å˜å¤§å†™ï¼Œåå­—å˜å°å†™ï¼Œç„¶åæ‹¼æ¥SELECT CONCAT(UPPER(last_name),LOWER(first_name))FROM employees;4.substr,SUBSTRING æˆªå–å­—ç¬¦ä¸²SELECT SUBSTR(&#x27;æè«æ„&#x27;,2);SELECT SUBSTR(&#x27;æè«æ„&#x27;,2,3);æ¡ˆä¾‹ï¼šå§“åä¸­é¦–å­—ç¬¦å¤§å†™ï¼Œå…¶ä»–çš„å°å†™ç„¶åç”¨_æ‹¼æ¥æ˜¾ç¤ºå‡ºæ¥SELECT CONCAT( UPPER(SUBSTR(last_name, 1, 1)), &#x27;_&#x27;, LOWER(SUBSTR(last_name, 2)) ) output FROM employees ;5.instr:è¿”å›å­—ä¸²ç¬¬ä¸€æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœæ‰¾ä¸åˆ°è¿”å›0SELECT INSTR(&#x27;é£æ€¥å¤©é«˜çŒ¿å•¸å“€&#x27;,&#x27;å¤©&#x27;) AS out_put;6.trim :å»æ‰å‰åç©ºæ ¼æˆ–å‰åæŒ‡å®šå­—ç¬¦SELECT LENGTH(TRIM(&#x27; å¼ ä¸‰ä¸° &#x27;)) AS out_put;SELECT TRIM(&#x27;a&#x27; FROM &#x27;aaaa1aa2aaa3aaa&#x27;) AS out_put;7.lpad :ç”¨æŒ‡å®šå­—ç¬¦å¡«æ»¡æŒ‡å®šé•¿åº¦ï¼ˆå·¦å¡«å……ï¼‰SELECT LPAD(&#x27;è‹è€å¸ˆ&#x27;,10,&#x27;*&#x27;);8.rpad:ç”¨æŒ‡å®šå­—ç¬¦å¡«æ»¡æŒ‡å®šé•¿åº¦ï¼ˆå³å¡«å……ï¼‰SELECT RPAD(&#x27;è‹è€å¸ˆ&#x27;,10,&#x27;*&#x27;);9.replace æ›¿æ¢SELECT REPLACE(&#x27;åƒé”‹åŸ¹è®­æœºæ„&#x27;,&#x27;åƒé”‹&#x27;,&#x27;å°šç¡…è°·&#x27;); 2.æ•°å­¦å‡½æ•°12345678910111.round:å››èˆäº”å…¥SELECT ROUND(1.666);SELECT ROUND(1.567,2);2.ceil å‘ä¸Šå–æ•´SELECT CEIL(1.52);3.floor å‘ä¸‹å–æ•´SELECT FLOOR(1.52);4.truncate:æˆªæ–­ï¼ˆå°æ•°ç‚¹åä¿ç•™å‡ ä½ï¼‰SELECT TRUNCATE(1.65,2);5.mod:å–ä½™SELECT MOD(10,3); 3.æ—¥æœŸå‡½æ•°123456789101112131415161718192021222324252627281.now:è¿”å›å½“å‰ç³»ç»Ÿæ—¥æœŸæ—¶é—´SELECT NOW();2.curdate:è¿”å›å½“å‰ç³»ç»Ÿæ—¥æœŸSELECT CURDATE();3.curtime:è¿”å›å½“å‰æ—¶é—´SELECT CURTIME();4.è·å–æŒ‡å®šéƒ¨åˆ†çš„å¹´æœˆæ—¥æ—¶åˆ†ç§’SELECT YEAR(NOW());SELECT YEAR(hiredate) FROM employees;5.str_to_dateå°†å­—ç¬¦é€šè¿‡æŒ‡å®šçš„æ ¼å¼è½¬åŒ–æˆæ—¥æœŸSELECT STR_TO_DATE(&#x27;1998-3-2&#x27;,&#x27;%Y-%c-%d&#x27;) AS out_put;æ¡ˆä¾‹ï¼šæŸ¥è¯¢å…¥èŒæ—¶é—´ä¸º1992-4-3çš„å‘˜å·¥ä¿¡æ¯SELECT * FROM employeesWHERE hiredate=STR_TO_DATE(&#x27;2016-3-3&#x27;,&#x27;%Y-%c-%d&#x27;);6.date_format å°†æ—¥æœŸè½¬æ¢æˆå­—ç¬¦SELECT DATE_FORMAT(NOW(),&#x27;%yå¹´%mæœˆ%dæ—¥&#x27;) AS æ—¥æœŸ;æ¡ˆä¾‹ï¼šæŸ¥è¯¢æœ‰å¥–é‡‘çš„å‘˜å·¥åå’Œå…¥èŒæ—¥æœŸï¼ˆxxæœˆ/xxæ—¥ xxå¹´ï¼‰SELECT last_name, DATE_FORMAT(hiredate, &#x27;%cæœˆ/%dæ—¥ %y&#x27;) FROM employees WHERE commission_pct IS NOT NULL ; 4.å…¶ä»–å‡½æ•°123SELECT VERSION();SELECT DATABASE();SELECT USER(); 5.æµç¨‹æ§åˆ¶å‡½æ•°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465661.if:IF elseæ•ˆæœSELECT IF(10&gt;5,&#x27;true&#x27;,&#x27;false&#x27;);æ¡ˆä¾‹ï¼šæŸ¥è¯¢å¦‚æœæœ‰å¥–é‡‘å°±å¤‡æ³¨æœ‰ï¼Œæ²¡æœ‰å°±å¤‡æ³¨æ²¡æœ‰ã€‚SELECT last_name, commission_pct, IF( commission_pct IS NULL, &#x27;æ²¡å¥–é‡‘&#x27;, &#x27;æœ‰å¥–é‡‘&#x27; ) AS å¤‡æ³¨ FROM employees ;2.caseå‡½æ•°1)switch-CASEè¯­æ³•:CASE è¦åˆ¤æ–­çš„å­—æ®µæˆ–è€…è¡¨è¾¾å¼WHEN å¸¸é‡1 THEN è¦æ˜¾ç¤ºçš„å€¼1æˆ–è€…è¯­å¥1WHEN å¸¸é‡2 THEN è¦æ˜¾ç¤ºçš„å€¼2æˆ–è€…è¯­å¥2...ELSE è¦æ˜¾ç¤ºçš„å€¼næˆ–è€…è¯­å¥nï¼›æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥çš„å·¥èµ„ï¼Œè¦æ±‚éƒ¨é—¨å·==30ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.1å€ï¼Œéƒ¨é—¨å·==40ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.2å€ï¼Œéƒ¨é—¨å·==50ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.3å€ï¼Œå…¶ä»–éƒ¨é—¨ï¼Œæ˜¾ç¤ºåŸæœ‰å·¥èµ„ã€‚SELECT salary AS åŸå§‹å·¥èµ„, department_id , CASE department_id WHEN 30 THEN salary * 1.1 WHEN 40 THEN salary * 1.2 WHEN 50 THEN salary * 1.3 ELSE salary END AS æ–°å·¥èµ„ FROM employees ;2)CASE ä½¿ç”¨2ï¼šè¯­æ³•ï¼šCASE WHEN æ¡ä»¶1 THEN è¦æ˜¾ç¤ºçš„å€¼1æˆ–è¯­å¥1WHEN æ¡ä»¶2 THEN è¦æ˜¾ç¤ºçš„å€¼2æˆ–è¯­å¥2...ELSE è¦æ˜¾ç¤ºçš„å€¼næˆ–è¯­å¥nENDæ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥çš„å·¥èµ„æƒ…å†µå¦‚æœ&gt;2wï¼Œæ˜¾ç¤ºAå¦‚æœ&gt;1.5wï¼Œæ˜¾ç¤ºBå¦‚æœ&gt;1wï¼Œæ˜¾ç¤ºCå¦åˆ™ï¼Œæ˜¾ç¤ºDSELECT salary, CASE WHEN salary &gt; 20000 THEN &#x27;A&#x27; WHEN salary &gt; 15000 THEN &#x27;B&#x27; WHEN salary &gt; 10000 THEN &#x27;C&#x27; ELSE &#x27;D&#x27; END AS å·¥èµ„ç­‰çº§ FROM employees ; 2.åˆ†ç»„å‡½æ•°åŠŸèƒ½ï¼šç”¨ä½œç»Ÿè®¡ä½¿ç”¨ 123456789101112131415161718192021222324251.sum :æ±‚å’ŒSELECT SUM(salary) FROM employees;2.avgï¼šå¹³å‡å€¼SELECT AVG(salary) FROM employees;3.maxï¼šæœ€å¤§å€¼SELECT MAX(salary) FROM employees;4.minï¼šæœ€å°å€¼SELECT MIN(salary) FROM employees;5.countï¼šè®¡ç®—ä¸ªæ•°SELECT COUNT(salary) FROM employees;æ€»ç»“â‘ .sum,avgä¸€èˆ¬ç”¨äºå¤„ç†æ•°å€¼ç±»å‹â‘¡.maxï¼Œminï¼Œcountç”¨æ¥å¤„ç†ä»»ä½•ç±»å‹â‘¢.ä»¥ä¸Šåˆ†ç»„å‡½æ•°éƒ½å¿½ç•¥nullå€¼â‘£.å¯ä»¥å’Œdistinctæ­é…SELECT SUM(DISTINCT salary) çº¯å‡€,SUM(salary) FROM employees;6.countçš„è¯¦ç»†ä»‹ç»â‘ select COUNT(*) FROM employees;â‘¡select COUNT(1) FROM employees;â‘¢å’Œåˆ†ç»„å‡½æ•°ä¸€åŒæŸ¥è¯¢çš„å­—æ®µè¦æ±‚æ˜¯group byåçš„å­—æ®µã€‚ 5.åˆ†ç»„æŸ¥è¯¢GROUP BY å’Œåˆ†ç»„å‡½æ•°å¯¹åº”åˆ†ç»„æŸ¥è¯¢ä¸­åˆ†ç»„æ¡ä»¶åˆ†ä¸ºä¸¤ç±» æ•°æ®æº ä½ç½® å…³é”®å­— åˆ†ç»„å‰ç­›é€‰ åŸå§‹è¡¨ GROUP BY å­å¥çš„å‰é¢ WHERE åˆ†ç»„åç­›é€‰ åˆ†ç»„åçš„ç»“æœé›† GROUP BY å­å¥çš„åé¢ HAVING åˆ†ç»„å‡½æ•°åšæ¡ä»¶è‚¯å®šæ˜¯æ”¾åœ¨havingå­å¥ä¸­ã€‚group BY å­å¥æ”¯æŒå•ä¸ªå­—æ®µåˆ†ç»„ï¼Œå¤šä¸ªå­—æ®µåˆ†ç»„ï¼ˆå¤šä¸ªå­—æ®µä¹‹é—´ç”¨é€—å·éš”å¼€æ²¡æœ‰é¡ºåºè¦æ±‚ï¼‰ï¼Œè¡¨è¾¾å¼æˆ–å‡½æ•°ã€‚ä¹Ÿå¯ä»¥æ·»åŠ æ’åºï¼Œæ”¾åœ¨æ•´ä¸ªåˆ†ç»„æŸ¥è¯¢çš„æœ€åã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ¯ä¸ªå·¥ç§çš„æœ€é«˜å·¥èµ„SELECT MAX(salary), job_id FROM employees GROUP BY job_id ORDER BY MAX(salary) ASC ;æ¡ˆä¾‹ï¼šæŸ¥è¯¢é‚®ç®±ä¸­åŒ…å«aå­—ç¬¦çš„ï¼Œæ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„SELECT AVG(salary), department_id FROM employees WHERE email LIKE &#x27;%a%&#x27; GROUP BY department_id ;#select Avg(salary),dep_id from employee where email like %a% group by dep_id ;æ¡ˆä¾‹ï¼šæŸ¥è¯¢æœ‰å¥–é‡‘çš„æ¯ä¸ªé¢†å¯¼æ‰‹ä¸‹å‘˜å·¥çš„æœ€é«˜å·¥èµ„SELECT MAX(salary), manager_id FROM employees WHERE commission_pct IS NOT NULL GROUP BY manager_id ;#select max(salary) ,manage_id from employees where commission_pct is not null group by manager_id;æ¡ˆä¾‹ï¼šå“ªä¸ªéƒ¨é—¨çš„å‘˜å·¥ä¸ªæ•°å¤§äºäºŒï¼ŸSELECT COUNT(*), department_id FROM employees GROUP BY department_id HAVING COUNT(*) &gt; 2 ;#select dep_id from emp group by dep_id having count(*)&gt;2;æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ¯ä¸ªå·¥ç§æœ‰å¥–é‡‘çš„å‘˜å·¥çš„æœ€é«˜å·¥èµ„&gt;12000çš„å·¥ç§ç¼–å·å’Œæœ€é«˜å·¥èµ„SELECT MAX(salary), job_id FROM employees WHERE commission_pct IS NOT NULL GROUP BY job_id HAVING MAX(salary) &gt; 12000 ;#select job_id ,max(salary) from emp where commission_pct IS NOT NULL group by job_id having max(salary)&gt;12000;æ¡ˆä¾‹ï¼šæŸ¥è¯¢é¢†å¯¼ç¼–å·&gt;102çš„æ¯ä¸ªé¢†å¯¼æ‰‹ä¸‹çš„æœ€ä½å·¥èµ„&gt;5000çš„é¢†å¯¼ç¼–å·æ˜¯å“ªä¸ªï¼ŸSELECT manager_id ,MIN(salary)FROM employeesWHERE manager_id&gt;102GROUP BY manager_idHAVING MIN(salary)&gt;5000;#select manager_id from emp where manager_id&gt;102 group by manager_id having min(salary)&gt;5000;#æŒ‰ç…§å‘˜å·¥å§“åçš„é•¿åº¦åˆ†ç»„ï¼ŒæŸ¥è¯¢æ¯ä¸€ç»„çš„å‘˜å·¥ä¸ªæ•°ï¼Œç­›é€‰å‘˜å·¥ä¸ªæ•°&gt;5çš„æœ‰å“ªäº›ï¼ŸSELECT COUNT(*) AS cFROM employeesGROUP BY LENGTH(last_name) HAVING c&gt;5;# select count(*) from emp group by length(name) having count(*)&gt;5;#æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨æ¯ä¸ªå·¥ç§çš„å‘˜å·¥çš„å¹³å‡å·¥èµ„SELECT AVG(salary),job_idFROM employeesGROUP BY department_id,job_id;#select avg(salary) from emp group by dep_id,job_id;#æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨æ¯ä¸ªå·¥ç§çš„å‘˜å·¥çš„å¹³å‡å·¥èµ„å¹¶ä¸”æŒ‰ç…§å¹³å‡å·¥èµ„çš„é«˜ä½æ˜¾ç¤ºSELECT AVG(salary),job_idFROM employeesGROUP BY department_id,job_idORDER BY AVG(salary) ASC;#select avg(salary) from emp group by dep_id,job_id order by avg(salary) asc; 6.è¿æ¥æŸ¥è¯¢åˆç§°ä¸ºå¤šè¡¨æŸ¥è¯¢ï¼Œå½“æŸ¥è¯¢çš„å­—æ®µæ¥è‡ªå¤šä¸ªè¡¨æ—¶ï¼Œå°±ä¼šç”¨åˆ°è¿æ¥æŸ¥è¯¢ã€‚**ç¬›å¡å°”ä¹˜ç§¯ç°è±¡ï¼šè¡¨1æœ‰mè¡Œï¼Œè¡¨2æœ‰nè¡Œï¼Œç»“æœï¼šm_nè¡Œ_å‘ç”ŸåŸå› ï¼šæ²¡æœ‰æœ‰æ•ˆçš„è¿æ¥æ¡ä»¶ åˆ†ç±» â‘ æŒ‰å¹´ä»£åˆ†ç±»sql92:ä»…ä»…æ”¯æŒå†…è¿æ¥sql99ï¼šä¸æ”¯æŒå…¨å¤–è¿æ¥ â‘¡æŒ‰åŠŸèƒ½åˆ†ç±» å†…è¿æ¥ å¤–è¿æ¥ äº¤å‰è¿æ¥ ç­‰å€¼è¿æ¥ å·¦å¤–è¿æ¥ éç­‰å€¼è¿æ¥ å³å¤–è¿æ¥ è‡ªè¿æ¥ å…¨å¤–è¿æ¥ 1.ç­‰å€¼è¿æ¥â‘ å¤šè¡¨ç­‰å€¼è¿æ¥çš„ç»“æœä¸ºå¤šè¡¨çš„äº¤é›†éƒ¨åˆ†â‘¡nè¡¨è¿æ¥ï¼Œè‡³å°‘éœ€è¦n-1ä¸ªè¿æ¥æ¡ä»¶â‘¢å¤šè¡¨çš„é¡ºåºæ²¡æœ‰è¦æ±‚â‘£ä¸€èˆ¬éœ€è¦ä¸ºè¡¨èµ·åˆ«åâ‘¤å¯ä»¥æ­é…å‰é¢ä»‹ç»çš„æ‰€æœ‰å­å¥ä½¿ç”¨ï¼Œæ¯”å¦‚æ’åºï¼Œåˆ†ç»„ï¼Œç­›é€‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192#æ¡ˆä¾‹ä¸€ï¼šæŸ¥è¯¢å¥³ä¼˜åå¯¹åº”çš„ç”·ä¼˜åSELECT NAME, boyName FROM beauty, boys WHERE beauty.boyfriend_id = boys.`id` ;#select name, boyname from girl ,boy where girl.boyfriend_id=boy.id;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥åå’Œå¯¹åº”çš„éƒ¨é—¨åSELECT last_name, department_name FROM employees, departments WHERE employees.`department_id` = departments.`department_id` ;#select name ,dep_name from emp e,dep d where e.dep.id= d.id;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥åï¼Œå·¥ç§å·ï¼Œå·¥ç§åã€‚SELECT last_name, emp.`job_id`, job_title FROM employees emp, jobs job WHERE emp.`job_id` = job.`job_id` ;#select name , e.job_id,job_title from emp e,job j where e.job_id=j.id;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢æœ‰å¥–é‡‘çš„å‘˜å·¥åå’Œéƒ¨é—¨åSELECT last_name, department_name FROM employees emp, departments dep WHERE commission_pct IS NOT NULL &amp;&amp; emp.`department_id` = dep.`department_id` ;#select name ,dep_name from emp e ,dep d where e.dep_id =d.id &amp;&amp;e.salary_pct is not null;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢åŸå¸‚åç¬¬äºŒä¸ªå­—ç¬¦ä¸ºoçš„éƒ¨é—¨SELECT department_name FROM locations l, departments d WHERE l.`location_id` = d.`location_id` AND l.`city` LIKE &#x27;_o%&#x27; ;#select dep_name from location l , dep d where l.city like %_o% &amp;&amp; l.id =d.location_id;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ¯ä¸ªåŸå¸‚çš„éƒ¨é—¨ä¸ªæ•°SELECT COUNT(*), city FROM locations l, departments d WHERE l.`location_id` = d.`location_id` GROUP BY l.`city` ;#select count(*),city from loca l,dep d where l.loc_id=d.loc_id group by count(*) asc;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢æœ‰å¥–é‡‘çš„æ¯ä¸ªéƒ¨é—¨çš„éƒ¨é—¨åå’Œéƒ¨é—¨çš„é¢†å¯¼ç¼–å·å’Œè¯¥éƒ¨é—¨çš„æœ€ä½å·¥èµ„SELECT d.`department_name`, d.manager_id, MIN(salary) FROM employees e, departments d WHERE e.`department_id` = d.`department_id` AND e.`commission_pct` IS NOT NULL GROUP BY d.`department_id`, d.`department_name` ;#select dep_name ,d.manager_id ,min(salary) from emp e ,dep d where e.`department_id` = d.`department_id` AND e.`commission_pct` IS NOT NULL GROUP BY d.`department_id`,d.`department_name` ;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢æ¯ä¸ªå·¥ç§çš„å·¥ç§åå’Œå‘˜å·¥çš„ä¸ªæ•°ï¼Œå¹¶ä¸”æŒ‰ç…§å‘˜å·¥ä¸ªæ•°é™åºæ’åºSELECT j.job_title, COUNT(*) FROM jobs j, employees e WHERE j.`job_id` = e.`job_id` GROUP BY e.`job_id`, j.`job_title` ORDER BY COUNT(*) DESC ;#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥åï¼Œéƒ¨é—¨åå’Œæ‰€åœ¨åŸå¸‚SELECT last_name, department_name, city FROM employees e, departments d, locations l WHERE e.`department_id` = d.`department_id` AND d.`location_id` = l.`location_id` ; 2.éç­‰å€¼è¿æ¥123456789#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥çš„å·¥èµ„å’Œå·¥èµ„çº§åˆ«SELECT DISTINCT salary, grade_level FROM employees e, job_grades j WHERE e.salary &gt;= j.lowest_sal &amp;&amp; e.salary &lt;= j.highest_sal ORDER BY salary ASC ; 3.è‡ªè¿æ¥12345678#æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥åå’Œä¸Šçº§çš„åç§°SELECT e.last_name, m.last_name FROM employees e, employees m WHERE e.manager_id = m.employee_id ; 4.å†…è¿æ¥INNER å¯ä»¥çœç•¥ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475#æŸ¥è¯¢å‘˜å·¥åï¼Œéƒ¨é—¨åSELECT last_name, department_name FROM employees e INNER JOIN departments d ON e.department_id = d.department_id ;#æŸ¥è¯¢åå­—ä¸­åŒ…å«eçš„å‘˜å·¥åå’Œå·¥ç§åSELECT last_name, job_title FROM employees e INNER JOIN jobs j ON e.job_id = j.job_id WHERE last_name LIKE &#x27;%e%&#x27; ;#æŸ¥è¯¢éƒ¨é—¨ä¸ªæ•°&gt;3çš„åŸå¸‚åå’Œéƒ¨é—¨ä¸ªæ•°SELECT city, COUNT(*) FROM departments d INNER JOIN locations l ON d.`location_id` = l.`location_id` GROUP BY cityHAVING COUNT(*) &gt; 3 ;#æŸ¥è¯¢å“ªä¸ªéƒ¨é—¨çš„éƒ¨é—¨å‘˜å·¥ä¸ªæ•°&gt;3çš„éƒ¨é—¨åå’Œå‘˜å·¥ä¸ªæ•°ï¼Œå¹¶æŒ‰ç…§ä¸ªæ•°é™åºæ’åºSELECT department_name, COUNT(*) FROM employees e INNER JOIN departments d ON e.`department_id` = d.`department_id` GROUP BY e.department_id HAVING COUNT(*) &gt; 3 ORDER BY COUNT(*) DESC ;#æŸ¥è¯¢å‘˜å·¥åï¼Œéƒ¨é—¨åï¼Œå·¥ç§åï¼Œå¹¶æŒ‰ç…§éƒ¨é—¨åé™åºæ’åºSELECT last_name, department_name, job_title FROM employees e INNER JOIN departments d ON e.`department_id` = d.`department_id` INNER JOIN jobs j ON e.`job_id` = j.`job_id` ORDER BY department_name DESC ;#æŸ¥è¯¢å‘˜å·¥å·¥èµ„çº§åˆ«SELECT grade_level, salaryFROM job_grades j INNER JOIN employees e ON e.`salary` BETWEEN j.`lowest_sal` AND j.`highest_sal` ;#æŸ¥è¯¢æ¯ä¸ªå·¥èµ„çº§åˆ«çš„ä¸ªæ•°ï¼Œå¹¶ä¸”é™åºæ’åºSELECT grade_level,COUNT(*)FROM employees eINNER JOIN job_grades jON e.`salary` BETWEEN j.`lowest_sal` AND j.`highest_sal` GROUP BY grade_levelORDER BY COUNT(*) DESC;#æŸ¥è¯¢å‘˜å·¥çš„åå­—å’Œä¸Šçº§çš„åå­—SELECT e1.last_name, e2.last_nameFROM employees e1INNER JOIN employees e2ON e1.`employee_id`=e2.`manager_id`; 5.å·¦å¤–è¿æ¥è¯­æ³•ï¼šSELECT æŸ¥è¯¢åˆ—è¡¨FROM è¡¨1 ã€è¿æ¥ç±»å‹ã€‘JOIN è¡¨2ON è¿æ¥æ¡ä»¶WHERE ç­›é€‰æ¡ä»¶GROUP BY åˆ†ç»„HAVING ç­›é€‰æ¡ä»¶ORDER BY æ’åºæ¡ä»¶è¿æ¥ç±»å‹ï¼šå†…è¿æ¥ï¼šinnerå·¦å¤–è¿æ¥ï¼šleftå³å¤–è¿æ¥ï¼šrightå…¨å¤–è¿æ¥ï¼šfulläº¤å‰è¿æ¥ï¼šcrosså¤–è¿æ¥ç”¨äºæŸ¥è¯¢ä¸€ä¸ªè¡¨ä¸­æœ‰ï¼Œå¦ä¸€ä¸ªè¡¨ä¸­æ²¡æœ‰çš„æ•°æ®å·¦å¤–è¿æ¥ï¼Œleftå·¦è¾¹æ˜¯ä¸»è¡¨å³å¤–è¿æ¥ï¼Œrightå³è¾¹æ˜¯ä¸»è¡¨Mysqlä¸æ”¯æŒå…¨å¤–è¿æ¥ 1234567#æ²¡æœ‰ç”·æœ‹å‹çš„å¥³ç”ŸSELECT g.`name`,b.`boyName`FROM beauty gLEFT JOIN boys bON g.`boyfriend_id`=b.`id`WHERE b.`boyName` IS NULL; 6.äº¤å‰è¿æ¥ç¬›å¡å°”ä¹˜ç§¯ 7.å­æŸ¥è¯¢å‡ºç°åœ¨å…¶å®ƒè¯­å¥ä¸­çš„selectè¯­å¥ï¼Œç§°ä¸ºå­æŸ¥è¯¢æˆ–å†…æŸ¥è¯¢å¤–éƒ¨çš„æŸ¥è¯¢è¯­å¥ï¼Œç§°ä¸ºä¸»æŸ¥è¯¢æˆ–å¤–æŸ¥è¯¢åˆ†ç±»ï¼š â‘ æŒ‰ç…§å­æŸ¥è¯¢å‡ºç°çš„ä½ç½®ï¼š selectåé¢ fromåé¢ whereæˆ–havingåé¢ existsåé¢ ä»…ä»…æ”¯æŒæ ‡é‡å­æŸ¥è¯¢ æ”¯æŒè¡¨å­æŸ¥è¯¢ æ ‡é‡å­æŸ¥è¯¢ï¼Œåˆ—å­æŸ¥è¯¢ è¡¨å­æŸ¥è¯¢ â‘¡æŒ‰ç…§ç»“æœé›†çš„è¡Œåˆ—æ•°ä¸åŒï¼š æ ‡é‡å­æŸ¥è¯¢ åˆ—å­æŸ¥è¯¢ è¡Œå­æŸ¥è¯¢ è¡¨å­æŸ¥è¯¢ ç»“æœåªæœ‰ä¸€è¡Œä¸€åˆ— ç»“æœä¸€åˆ—å¤šè¡Œ ä¸€è¡Œå¤šåˆ— å¤šè¡Œå¤šåˆ— 1ï¼‰whereæˆ–havingåé¢ç‰¹ç‚¹ï¼šå­æŸ¥è¯¢ä¸€èˆ¬æ”¾åœ¨å°æ‹¬å·å†…å­æŸ¥è¯¢ä¸€èˆ¬æ”¾åœ¨æ¡ä»¶çš„å³è¾¹æ ‡é‡å­æŸ¥è¯¢ï¼Œä¸€èˆ¬æ­é…ç€å•è¡Œæ“ä½œç¬¦åˆ—å­æŸ¥è¯¢ï¼šä¸€èˆ¬æ­é…å¤šè¡Œæ“ä½œç¬¦ä½¿ç”¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211.æ ‡é‡å­æŸ¥è¯¢#è°çš„å·¥èµ„æ¯”Abelé«˜SELECT last_name FROM employees WHERE salary &gt; (SELECT salary FROM employees WHERE last_name = &#x27;Abel&#x27;) ;#è¿”å›job_idäº141å·å‘˜å·¥ç›¸åŒï¼Œsalaryæ¯”143å·å‘˜å·¥å¤šçš„å‘˜å·¥ å§“åï¼Œjob_idå’Œå·¥èµ„SELECT last_name, job_id, salary FROM employees WHERE job_id = (SELECT job_id FROM employees WHERE employee_id = 141) AND salary &gt; (SELECT salary FROM employees WHERE employee_id = 143)#è¿”å›å…¬å¸å·¥èµ„å·¥èµ„æœ€å°‘çš„å‘˜å·¥çš„å§“åï¼Œjob_id,salarySELECT last_name, job_id, salary FROM employees WHERE salary = (SELECT MIN(salary) FROM employees);#æŸ¥è¯¢æœ€ä½å·¥èµ„å¤§äº50å·éƒ¨é—¨æœ€ä½å·¥èµ„çš„éƒ¨é—¨idå’Œå…¶æœ€ä½å·¥èµ„SELECT department_id, MIN(salary) FROM employees GROUP BY department_id HAVING MIN(salary) &gt; (SELECT MIN(salary) FROM employees WHERE department_id = 50) ;2.åˆ—å­æŸ¥è¯¢å¤šè¡Œæ“ä½œç¬¦ï¼šIN / NOT inï¼šç­‰äºåˆ—è¡¨ä¸­çš„ä»»æ„ä¸€ä¸ªANY / SOME ï¼šå’Œå­æŸ¥è¯¢è¿”å›çš„æŸä¸€ä¸ªå€¼æ¯”è¾ƒALL ï¼šå’Œå­æŸ¥è¯¢è¿”å›çš„æ‰€æœ‰å€¼æ¯”è¾ƒ#è¿”å›location_idæ˜¯1400æˆ–è€…1700çš„éƒ¨é—¨ä¸­çš„æ‰€æœ‰å‘˜å·¥å§“åSELECT last_name FROM employees WHERE department_id IN (SELECT DISTINCT department_id FROM departments WHERE location_id IN (1400, 1700)) ;#è¿”å›å…¶ä»–å·¥ç§ä¸­æ¯”job_idä¸ºIT_PROGéƒ¨é—¨ä»»æ„å·¥èµ„ä½çš„å‘˜å·¥#å·¥å·ï¼Œå§“åï¼Œjob_idä»¥åŠsalarySELECT employee_id, last_name, job_id, salary FROM employees WHERE salary &lt; (SELECT MAX(salary) FROM employees WHERE job_id = &#x27;IT_PROG&#x27;) AND job_id !=&#x27;IT_PROG&#x27;;#è¿”å›å…¶ä»–å·¥ç§ä¸­æ¯”job_idä¸ºIT_PROGéƒ¨é—¨æ‰€æœ‰å·¥èµ„ä½çš„å‘˜å·¥#å·¥å·ï¼Œå§“åï¼Œjob_idä»¥åŠsalarySELECT employee_id, last_name, job_id, salary FROM employees WHERE salary &lt; (SELECT MIN(salary) FROM employees WHERE job_id = &#x27;IT_PROG&#x27;) AND job_id !=&#x27;IT_PROG&#x27;;*********************************3.è¡Œå­æŸ¥è¯¢#æŸ¥è¯¢å‘˜å·¥ç¼–å·æœ€å°å¹¶ä¸”å·¥èµ„æœ€é«˜çš„å‘˜å·¥ä¿¡æ¯SELECT * FROM employees WHERE employee_id = (SELECT MIN(employee_id) FROM employees) AND salary = (SELECT MAX(salary) FROM employees) 2ï¼‰SELECT åé¢123456789101112131415161718192021#æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨çš„å‘˜å·¥ä¸ªæ•°SELECT d.*, (SELECT COUNT(*) FROM employees e WHERE e.department_id = d.department_id) FROM departments d ;#æŸ¥è¯¢å‘˜å·¥å·ç­‰äº102çš„éƒ¨é—¨åSELECT department_name FROM departments WHERE department_id = (SELECT department_id FROM employees WHERE employee_id = 102) ; 3ï¼‰FROM åé¢1234567891011121314#æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨å¹³å‡å·¥èµ„çš„å·¥èµ„ç­‰çº§SELECT grade_level ,aa.department_idFROM (SELECT AVG(salary) ag, department_id FROM employees GROUP BY department_id) aa INNER JOIN job_grades j ON aa.ag BETWEEN lowest_sal AND highest_sal ; 4ï¼‰existsåé¢ï¼ˆç›¸å…³å­æŸ¥è¯¢ï¼‰12345678#æŸ¥è¯¢æœ‰å‘˜å·¥çš„éƒ¨é—¨åSELECT department_name FROM departments dWHERE EXISTS(SELECT * FROM employees e WHERE d.department_id=e.department_id);#æŸ¥è¯¢æ²¡æœ‰å¥³æœ‹å‹çš„ç”·ç”Ÿä¿¡æ¯SELECT bo.* FROM boys bo WHEREbo.`id` NOT IN(SELECT boyfriend_id FROM beauty); 5ï¼‰å­æŸ¥è¯¢ç»å…¸æ¡ˆä¾‹ç¥¥è®²1234567891011121314151617181920212223242526272829303132331.æŸ¥è¯¢å·¥èµ„æœ€ä½çš„å‘˜å·¥ä¿¡æ¯ï¼šlast_name,salarySELECT last_name,salary FROM employeesWHERE salary=(SELECT MIN(salary) FROM employees);2.æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€ä½çš„éƒ¨é—¨ä¿¡æ¯SELECT * FROM departments WHERE department_id=(SELECT department_id FROM employees GROUP BY department_id ORDER BY AVG(salary)LIMIT 1)3.æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€ä½çš„éƒ¨é—¨ä¿¡æ¯å’Œè¯¥éƒ¨é—¨çš„å¹³å‡å·¥èµ„SELECT d.*,a1.ag FROM departments d JOIN (SELECT AVG(salary) ag,department_id FROM employees GROUP BY department_id ORDER BY AVG(salary)LIMIT 1) a1ON d.department_id=a1.department_id4.æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€é«˜çš„jobä¿¡æ¯SELECT j.* FROM jobs j WHERE j.job_id=(SELECT job_id FROM employeesGROUP BY job_id ORDER BY AVG(salary) DESC LIMIT 1)5.æŸ¥è¯¢å¹³å‡å·¥èµ„é«˜äºå…¬å¸å¹³å‡å·¥èµ„çš„éƒ¨é—¨æœ‰å“ªäº›SELECT department_id FROM (SELECT department_id ,AVG(salary) AS avg1 FROM employees GROUP BY department_id) e1WHERE e1.avg1&gt;(SELECT AVG(salary) AS avg2 FROM employees) 6.æŸ¥è¯¢å‡ºå…¬å¸ä¸­æ‰€æœ‰managerçš„è¯¦ç»†ä¿¡æ¯SELECT * FROM employeesWHERE employee_id IN(SELECT DISTINCT manager_id FROM employees);7.å„ä¸ªéƒ¨é—¨ä¸­ï¼Œæœ€é«˜å·¥èµ„ä¸­æœ€ä½çš„é‚£ä¸ªéƒ¨é—¨çš„æœ€ä½å·¥èµ„æ˜¯å¤šå°‘SELECT MIN(salary) FROM employees GROUP BY department_idHAVING department_id=(SELECT department_id FROM employees GROUP BY department_id ORDER BY MAX(salary)LIMIT 1)8.æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€é«˜çš„éƒ¨é—¨çš„managerçš„è¯¦ç»†ä¿¡æ¯ï¼šlast_name,department_id,email,salarySELECT last_name,department_id,email,salary FROM employees WHERE employee_id=(SELECT manager_id FROM departments WHERE department_id=(SELECT department_id FROM employees GROUP BY department_id ORDER BY AVG(salary)DESC LIMIT 1)) 8.åˆ†é¡µæŸ¥è¯¢**è¯­æ³•ï¼šlimit(currentPage-1)size,size 123456789#æŸ¥è¯¢å‰äº”æ¡å‘˜å·¥ä¿¡æ¯SELECT * FROM employees LIMIT 0,5;#æŸ¥è¯¢ç¬¬11-25æ¡å‘˜å·¥ä¿¡æ¯SELECT * FROM employees LIMIT 10,15;#æŸ¥è¯¢æœ‰å¥–é‡‘çš„å‘˜å·¥ï¼Œå¹¶ä¸”å·¥èµ„æœ€é«˜çš„å‰ååæ˜¾ç¤ºå‡ºæ¥SELECT * FROM employeesWHERE commission_pct IS NOT NULLORDER BY salary DESC LIMIT 0 ,10; 9.è”åˆæŸ¥è¯¢è¦æŸ¥è¯¢çš„ç»“æœæ¥è‡ªäºå¤šä¸ªè¡¨ï¼Œä¸”å¤šä¸ªè¡¨æ²¡æœ‰ç›´æ¥çš„è¿æ¥å…³ç³»ï¼Œå•æŸ¥è¯¢çš„ä¿¡æ¯ä¸€è‡´æ—¶ç‰¹ç‚¹ï¼š1.è¦æ±‚å¤šæ¡æŸ¥è¯¢è¯­å¥çš„æŸ¥è¯¢åˆ—æ•°æ˜¯ä¸€è‡´çš„2.è¦æ±‚å¤šæ¡æŸ¥è¯¢è¯­å¥çš„æŸ¥è¯¢çš„æ¯ä¸€åˆ—çš„ç±»å‹å’Œé¡ºåºæœ€å¥½ä¸€è‡´3.unionå…³é”®å­—é»˜è®¤å»é‡ï¼Œå¦‚æœä½¿ç”¨union all å¯ä»¥ä¸å»é™¤é‡å¤é¡¹ 1234æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥éƒ¨é—¨ç¼–å·å¤§äº90æˆ–é‚®ç®±åŒ…å«açš„å‘˜å·¥ä¿¡æ¯SELECT * FROM employees WHERE department_id&gt;90UNIONSELECT * FROM employees WHERE email LIKE &#x27;%a%&#x27;; ä¸‰ï¼ŒDMLæ•°æ®æ“ä½œè¯­è¨€æ’å…¥insert 1234567891011121314151617ä¸€ï¼šæ’å…¥è¯­å¥#æ’å…¥beautyä¸€è¡Œæ•°æ®INSERT INTO beauty(NAME,sex,borndate,phone,photo,boyfriend_id)VALUES(&#x27;æ³¢å¤šé‡å‰ä¾&#x27;,&#x27;å¥³&#x27;,&#x27;1998-11-11&#x27;,&#x27;13342969497&#x27;,NULL,10)#å¯ä»¥ä¸ºnullçš„åˆ—å¦‚ä½•ä¸æ’å…¥å€¼ç›´æ¥å†™nullï¼Œæˆ–åˆ—åå°‘å†™ä¸€åˆ—INSERT INTO beauty(NAME,sex,borndate,phone,photo,boyfriend_id)VALUES(&#x27;å°æ³½ç›åˆ©äºš&#x27;,&#x27;å¥³&#x27;,&#x27;1999-11-11&#x27;,&#x27;13342456497&#x27;,NULL,11)INSERT INTO beauty VALUES(15,&#x27;é©¬è“‰&#x27;,&#x27;å¥³&#x27;,&#x27;1989-11-11&#x27;,&#x27;13342456123&#x27;,NULL,12);INSERT INTO beauty SET id=16,NAME=&#x27;åˆ˜äº¦è²&#x27;, sex=&#x27;å¥³&#x27;,borndate=&#x27;1989-10-01&#x27;,phone=&#x27;15945231056&#x27;,boyfriend_id=16;#insert åµŒå¥—å­æŸ¥è¯¢ï¼Œå°†ä¸€ä¸ªè¡¨çš„æ•°æ®æ’å…¥å¦ä¸€å¼ è¡¨INSERT INTO beauty (NAME,sex,borndate,phone,boyfriend_id)SELECT &#x27;å¦²å·±&#x27;,&#x27;å¥³&#x27;,&#x27;1111-11-11&#x27;,&#x27;13146587954&#x27;,0; ä¿®æ”¹update 1234567891011121314151617181920äºŒï¼Œä¿®æ”¹ UPDATE beauty SET phone=&#x27;110&#x27; WHERE id=16;å¤šè¡¨ä¿®æ”¹ï¼šsql99UPDATE è¡¨1 åˆ«åINNER|LEFT|RIGHT JOIN è¡¨2 åˆ«åON è¿æ¥æ¡ä»¶SET åˆ—=å€¼WHERE ç­›é€‰æ¡ä»¶#ä¿®æ”¹å¼ æ— å¿Œçš„å¥³æœ‹å‹æ‰‹æœºå·ä¸º114UPDATE beauty gINNER JOIN boys bON g.boyfriend_id=b.idSET g.phone=&#x27;114&#x27;WHERE b.boyName=&#x27;å¼ æ— å¿Œ&#x27;;#ä¿®æ”¹æ²¡æœ‰ç”·æœ‹å‹çš„å¥³ç”Ÿçš„ç”·æœ‹å‹ç¼–å·éƒ½ä¸º4å·UPDATE beauty gLEFT JOIN boys bON g.`boyfriend_id`=b.idSET g.`boyfriend_id`=4WHERE b.id=NULL; åˆ é™¤delete 1234567891011121314151617181920212223ä¸‰ï¼Œåˆ é™¤DELETE å’Œ TRUNCATE çš„åŒºåˆ«ï¼š1.deleteå¯ä»¥åŠ whereæ¡ä»¶ï¼Œtruncateä¸è¡Œ2.truncateåˆ é™¤æ•ˆç‡é«˜3.åŠ å…¥è¦åˆ é™¤çš„è¡¨ä¸­æœ‰è‡ªå¢åˆ—ï¼Œç”¨deleteåˆ é™¤æ•´ä¸ªè¡¨ååœ¨æ’å…¥æ•°æ®ï¼Œä»æ–­ç‚¹å¤„å¼€å§‹æ’å…¥ç”¨truncateåˆ é™¤ååœ¨æ’å…¥æ•°æ®ï¼Œä»1å¼€å§‹ã€‚4.truncateåˆ é™¤æ²¡æœ‰è¿”å›å€¼ï¼Œdeleteæœ‰è¿”å›å€¼5.truncateåˆ é™¤ä¸èƒ½å›æ»šï¼Œdeleteåˆ é™¤å¯ä»¥å›æ»šDELETE FROM beauty WHERE id=17;è¯­æ³•ï¼štruncate TABLE è¡¨å;#åˆ é™¤å¼ æ— å¿Œçš„å¥³æœ‹å‹çš„ä¿¡æ¯DELETE g FROM beauty gINNER JOIN boys bON g.boyfriend_id=b.idWHERE b.id=1;#åˆ é™¤é»„æ™“æ˜ä»¥åŠä»–å¥³æœ‹å‹çš„ä¿¡æ¯DELETE b,g FROM beauty gINNER JOIN boys bON b.`id`=g.`boyfriend_id`WHERE b.`boyName`=&#x27;é»„æ™“æ˜&#x27;;å¤šè¡¨åˆ é™¤ :TRUNCATETRUNCATE TABLE boys å››ï¼ŒDDLæ•°æ®å®šä¹‰è¯­è¨€1.åº“å’Œè¡¨çš„ç®¡ç†12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849ä¸€ï¼Œåº“çš„ç®¡ç†åˆ›å»º CREATECREATE DATABASE IF NOT EXISTS mydb1 ;ä¿®æ”¹ ALTER1.æ›´æ”¹å­—ç¬¦é›†ALTER DATABASE mydb1 CHARACTER SET utf8;åˆ é™¤ DROPDROP DATABASE IF EXISTS school;äºŒï¼Œè¡¨çš„ç®¡ç†åˆ›å»º CREATECREATE TABLE book(id INT PRIMARY KEY,b_name VARCHAR(30),price DOUBLE,author_id INT ,publishDate DATE);DESC book ;CREATE TABLE author(id INT PRIMARY KEY ,au_name VARCHAR(20),nation VARCHAR(10));DESC author;ä¿®æ”¹ ALTER1.ä¿®æ”¹åˆ—åALTER TABLE book CHANGE COLUMN publishDate pub_date DATETIME;2.ä¿®æ”¹åˆ—çš„ç±»å‹æˆ–çº¦æŸALTER TABLE book MODIFY COLUMN pub_date DATE;3.æ·»åŠ æ–°åˆ—ALTER TABLE author ADD COLUMN annual DOUBLE;4.åˆ é™¤æ–°åˆ—ALTER TABLE author DROP COLUMN annual;5.ä¿®æ”¹è¡¨åALTER TABLE author RENAME TO book_author;åˆ é™¤ DROPDROP TABLE IF EXISTS my_employee;SHOW TABLES;å¤åˆ¶1.ä»…ä»…å¤åˆ¶è¡¨çš„ç»“æ„CREATE TABLE copy LIKE book_author;2.å¤åˆ¶è¡¨çš„ç»“æ„åŠ æ•°æ®CREATE TABLE copy2SELECT * FROM book_author;3.å¤åˆ¶éƒ¨åˆ†ç»“æ„CREATE TABLE copy3 SELECT id,au_nameFROM book_authorWHERE id=0; 2.æ•°æ®ç±»å‹æ•°å€¼å‹1.æ•´å‹ TINYINT SMALLINT MEDIUMINT INT/INTEGER BIGINT 1 2 3 4 8 12345å¦‚ä½•è®¾ç½®æ— ç¬¦å·å’Œæœ‰ç¬¦å·(é»˜è®¤æœ‰ç¬¦å·)DROP TABLE tab_int;CREATE TABLE tab_int(t1 INT,t2 INT UNSIGNED);INSERT INTO tab_int(t1,t2) VALUES(-1,1);DESC tab_int; 1ï¼‰å¦‚æœæ’å…¥çš„æ•°å€¼è¶…å‡ºäº†æ•´å½¢çš„èŒƒå›´ï¼Œä¼šæŠ¥out of rangeå¼‚å¸¸ï¼Œå¹¶ä¸”æ’å…¥ä¸´ç•Œå€¼ã€‚2ï¼‰å¦‚æœä¸è®¾ç½®é•¿åº¦ï¼Œä¼šæœ‰é»˜è®¤çš„é•¿åº¦ã€‚é•¿åº¦ä»£è¡¨äº†æ˜¾ç¤ºçš„æœ€å¤§å®½åº¦ï¼Œå¦‚æœä¸å¤Ÿä¼šç”¨0åœ¨å·¦è¾¹å¡«å……ï¼Œä½†å¿…é¡»æ­é…zerofillä½¿ç”¨ã€‚2.å°æ•°â‘ å®šç‚¹æ•°decï¼ˆM,Dï¼‰â‘¡æµ®ç‚¹æ•°floatï¼ˆ4ï¼‰ ï¼Œdoubleï¼ˆ8ï¼‰Mï¼ŒDçš„æ„æ€ï¼šMæŒ‡å®šä¸€å…±å¤šå°‘ä½ï¼ŒDæŒ‡å®šå°æ•°å‡ ä½ï¼Œè¶…å‡ºä¼šå››èˆäº”å…¥ã€‚MDéƒ½å¯ä»¥çœç•¥ï¼Œå¦‚æœæ˜¯decï¼Œåˆ™Mé»˜è®¤ä¸º10ï¼ŒDé»˜è®¤ä¸º0å¦‚æœæ˜¯æµ®ç‚¹æ•°ï¼Œåˆ™ä¼šæ ¹æ®æ’å…¥æ•°å€¼çš„ç²¾åº¦æ”¹å˜ç²¾åº¦å®šç‚¹å‹ç²¾åº¦ç›¸å¯¹è¾ƒé«˜ã€‚3.å­—ç¬¦å‹â‘ è¾ƒçŸ­çš„æ–‡æœ¬CHAR(M)é»˜è®¤ä¸º1,VARCHAR(M)M:å­—ç¬¦æ•°charï¼šå›ºå®šé•¿åº¦å­—ç¬¦ï¼Œæ¯”è¾ƒè€—è´¹ç©ºé—´ï¼Œä½†æ˜¯æ•ˆç‡é«˜ã€‚varcharï¼šå¯å˜é•¿åº¦å­—ç¬¦ 123456789ENUM æšä¸¾ç±»CREATE TABLE tab_char( t1 ENUM(&#x27;a&#x27;,&#x27;c&#x27;,&#x27;b&#x27;));SET é›†åˆCREATE TABLE tab_set(s1 SET(&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;,&#x27;d&#x27;));INSERT INTO tab_set(s1) VALUES(&#x27;a,b&#x27;); BINARY:ä¿å­˜è¾ƒçŸ­çš„äºŒè¿›åˆ¶ã€‚â‘¡è¾ƒé•¿çš„æ–‡æœ¬textï¼ˆæ–‡æœ¬ï¼‰,BLOB(è¾ƒå¤§çš„äºŒè¿›åˆ¶)4.æ—¥æœŸå‹DATE:æ—¥æœŸDATETIME:æ—¥æœŸåŠ æ—¶é—´ï¼Œ8å­—èŠ‚timestampï¼šè·Ÿæ—¶åŒºæœ‰å…³ç³»ï¼Œå»ºè®®ä½¿ç”¨ï¼Œ4å­—èŠ‚timeï¼šæ—¶é—´yearï¼šå¹´ 123456789CREATE TABLE tab_date(t1 DATETIME,t2 TIMESTAMP);INSERT INTO tab_date(t1,t2)VALUES(NOW(),NOW());SELECT * FROM tab_date;SET time_zone=&#x27;+9:00&#x27;;#è®¾ç½®æ—¶åŒºä¸ºä¸œ9åŒº 3.å¸¸è§çº¦æŸå«ä¹‰ï¼šä¸€ç§é™åˆ¶ï¼Œç”¨äºé™åˆ¶è¡¨ä¸­çš„æ•°æ®ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚ NOT NULL DEFAULT PRIMARY KEY å”¯ä¸€ï¼Œä¸”ä¸ä¸ºç©º UNIQUE å”¯ä¸€ï¼Œå¯ä»¥ä¸ºç©º CHECK Mysqlä¸æ”¯æŒ FOREIGN KEY å¤–é”®çº¦æŸï¼Œç”¨äºé™åˆ¶ä¸¤ä¸ªè¡¨çš„å…³ç³»ï¼Œç”¨äºä¿è¯è¯¥å­—æ®µçš„å€¼å¿…é¡»æ¥è‡ªäºä¸»è¡¨çš„å…³è”åˆ—çš„å€¼ã€‚çº¦æŸçš„åˆ†ç±»ï¼šåˆ—çº§çº¦æŸï¼šé™¤å¤–é”®çº¦æŸè¡¨çº§çº¦æŸï¼šé™¤äº†éç©ºï¼Œé»˜è®¤ã€‚CREATE TABLE è¡¨å(å­—æ®µ1 å­—æ®µç±»å‹ åˆ—çº§çº¦æŸ,å­—æ®µ2 å­—æ®µç±»å‹ åˆ—çº§çº¦æŸ,è¡¨çº§çº¦æŸ); 1234567891011121314151617181920212223242526#åˆ›å»ºè¡¨æ—¶æ·»åŠ åˆ—çº§çº¦æŸDROP TABLE tab_test;CREATE TABLE tab_test(id INT PRIMARY KEY,stu_name VARCHAR(20) NOT NULL,gender CHAR DEFAULT &#x27;ç”·&#x27;,seat_id INT UNIQUE, major_id INT REFERENCES tab_major(id) );CREATE TABLE tab_major(id INT PRIMARY KEY ,major_name VARCHAR(20) NOT NULL);DESC tab_test;SHOW INDEX FROM tab_test;#æŸ¥çœ‹ç´¢å¼•ä¿¡æ¯#æ·»åŠ è¡¨çº§çº¦æŸCREATE TABLE tab_test(id INT PRIMARY KEY AUTO_INCREMENT,stu_name VARCHAR(20) NOT NULL,gender CHAR DEFAULT &#x27;ç”·&#x27;,seat_id INT UNIQUE, major_id INT ,CONSTRAINT m_id FOREIGN KEY(major_id) REFERENCES tab_major(id) );CONSTRAINT m_id å¯ä»¥çœç•¥ é¢è¯•é¢˜ï¼šä¸»é”®çº¦æŸå’Œå”¯ä¸€çº¦æŸçš„åŒºåˆ«ï¼šéƒ½å¯ä»¥ä¿è¯å”¯ä¸€æ€§ï¼Œä¸»é”®ä¸èƒ½ä¸ºç©º ï¼Œunique èƒ½ä¸ºç©ºï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªnullã€‚ä¸»é”®åªèƒ½æœ‰1ä¸ªï¼Œuniqueå¯ä»¥æœ‰å¤šä¸ªã€‚éƒ½å…è®¸ä¸¤ä¸ªåˆ—ç»„åˆæˆä¸€ä¸ªçº¦æŸã€‚é¢è¯•é¢˜ï¼šå¤–é”®ï¼šè¦æ±‚åœ¨ä»è¡¨è®¾ç½®å¤–é”®å…³ç³»ä»è¡¨çš„å¤–é”®åˆ—ç±»å‹å’Œä¸»è¡¨çš„å…³è”åˆ—ç±»å‹ä¸€è‡´ï¼Œåç§°æ— è¦æ±‚è¦æ±‚ä¸»è¡¨çš„å…³è”åˆ—å¿…é¡»æ˜¯ä¸»é”®æˆ–è€…å”¯ä¸€é”®æ’å…¥æ•°æ®åº”è¯¥å…ˆæ’å…¥ä¸»è¡¨å†æ’å…¥ä»è¡¨åˆ é™¤æ•°æ®åº”è¯¥å…ˆåˆ é™¤ä»è¡¨ï¼Œåœ¨åˆ é™¤ä¸»è¡¨äºŒï¼Œä¿®æ”¹è¡¨æ—¶æ·»åŠ çº¦æŸ 1234567891011CREATE TABLE tab_test2(id INT ,stu_name VARCHAR(20) ,gender CHAR ,seat_id INT , major_id INT );ALTER TABLE tab_test2 MODIFY COLUMN stu_name VARCHAR(20) NOT NULL ;ALTER TABLE tab_test2 MODIFY COLUMN id INT PRIMARY KEY AUTO_INCREMENT;#æ·»åŠ å¤–é”®ALTER TABLE tab_test2 ADD FOREIGN KEY(major_id) REFERENCES tab_major(id); 4.æ ‡è¯†åˆ—è‡ªå¢é•¿åˆ— AUTO_INCREMENTç‰¹ç‚¹ï¼š1.è¡¨ç¤ºå¿…é¡»å’Œä¸€ä¸ªkeyæ­é…2.ä¸€ä¸ªè¡¨æœ€å¤šä¸€ä¸ªæ ‡è¯†åˆ—3.æ ‡è¯†åˆ—ç±»å‹åªèƒ½æ˜¯æ•°å€¼å‹4.æ ‡è¯†åˆ—å¯ä»¥é€šè¿‡set auto_increment_increment=3;è®¾ç½®æ­¥é•¿ 1234CREATE tab_auto(id INT PRIMARY KEY AUTO_INCREMENT,NAME VARCHAR(20) NOT NULL); äº”ï¼ŒTCLè¯­è¨€ï¼šäº‹åŠ¡æ§åˆ¶è¯­è¨€äº‹åŠ¡ï¼šä¸€ä¸ªæˆ–ä¸€ç»„sqlè¯­å¥ç»„æˆçš„æ‰§è¡Œå•å…ƒï¼Œ è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œ,è¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚å­˜å‚¨å¼•æ“:åœ¨MySQLä¸­çš„æ•°æ®ç”¨å„ç§ä¸åŒçš„æŠ€æœ¯å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ã€‚é€šè¿‡show ENGINES;æ¥æŸ¥çœ‹mysqlæ”¯æŒçš„å­˜å‚¨å¼•æ“ã€‚innodbå¼•æ“æ”¯æŒäº‹åŠ¡ã€‚äº‹åŠ¡çš„ACIDå±æ€§ï¼š1.åŸå­æ€§:äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œè¦ä¹ˆéƒ½å‘ç”Ÿï¼Œè¦ä¹ˆéƒ½ä¸å‘ç”Ÿã€‚2.ä¸€è‡´æ€§ï¼šäº‹åŠ¡å¿…é¡»ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€å˜ä¸ºå¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚3.éš”ç¦»æ€§ï¼šä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½è¢«å¦ä¸€ä¸ªäº‹åŠ¡å¹²æ‰°ã€‚4.æŒä¹…æ€§ï¼šäº‹åŠ¡ä¸€æ—¦è¢«æäº¤ï¼Œå¯¹æ•°æ®åº“äº‹åŠ¡çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ã€‚ DELETE å’Œ TRUNCATE åœ¨äº‹åŠ¡ä¸­çš„åŒºåˆ«ï¼š 1234567891011æ¼”ç¤ºdeleteSET autocommit=0;START TRANSACTION;DELETE FROM tab_teacher;ROLLBACK;æ¼”ç¤º TRUNCATESET autocommit=0;START TRANSACTION;TRUNCATE TABLE tab_teacher;ROLLBACK;DELETE æ˜¯ç›´æ¥åˆ é™¤è¡¨ä¸­æ•°æ®ï¼Œtruncateæ˜¯æ±Ÿè¡¨åˆ é™¤ï¼Œåˆ›å»ºä¸€å¼ ä¸åŸæ¥ä¸€æ ·çš„ç©ºè¡¨ã€‚ å…­ï¼Œè§†å›¾å«ä¹‰ï¼šè™šæ‹Ÿè¡¨ï¼Œå’Œæ™®é€šè¡¨æ ¼ä¸€æ ·ä½¿ç”¨é€šè¿‡è¡¨åŠ¨æ€ç”Ÿæˆçš„æ•°æ® 1.åˆ›å»ºè§†å›¾è¯­æ³•ï¼šCREATE VIEW è§†å›¾åASæŸ¥è¯¢è¯­å¥ ; 12345678910111213141516171819202122# æ¡ˆä¾‹ï¼šæŸ¥è¯¢å§“åä¸­åŒ…å«aå­—ç¬¦çš„å‘˜å·¥åï¼Œéƒ¨é—¨åå’Œå·¥ç§ä¿¡æ¯create view view1 as select e.last_name,d.department_name ,j.job_title from employees einner join departments d on e.department_id = d.department_id inner join jobs j on e.job_id = j.job_idwhere e.last_name like &#x27;%a%&#x27;;select * from view1;# æ¡ˆä¾‹ï¼šæŸ¥è¯¢å„ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„çº§åˆ«create view view2 asselect j.grade_level ,aa.department_id from job_grades jinner join (select avg(salary) avg_s,department_id from employees group by department_id) aa on aa.avg_s between j.lowest_sal and j.highest_sal;select * from view2;# æ¡ˆä¾‹ï¼šæŸ¥è¯¢å¹³å‡å·¥èµ„æœ€ä½çš„éƒ¨é—¨ä¿¡æ¯create view view3 asselect avg(salary) avg_s ,department_idfrom employeesgroup by department_idorder by avg_s asclimit 1;select * from view3; 2.è§†å›¾ä¿®æ”¹â‘ create OR REPLACE VIEW è§†å›¾å AS æŸ¥è¯¢è¯­å¥;â‘¡alter VIEW è§†å›¾å AS æŸ¥è¯¢è¯­å¥; 3.åˆ é™¤è§†å›¾DROP VIEW v1,v2; 4.æŸ¥çœ‹è§†å›¾DESC v1; 12345678910#åˆ›å»ºè§†å›¾emp_v1ï¼Œè¦æ±‚æŸ¥è¯¢ç”µè¯å·ç ä»¥011å¼€å¤´çš„å‘˜å·¥å§“åå’Œå·¥èµ„ï¼Œé‚®ç®±CREATE VIEW emp_v1 ASSELECT last_name ,salary,email FROM employees WHEREphone_number LIKE &#x27;%011&#x27;;#åˆ›å»ºè§†å›¾emp_v2,è¦æ±‚æŸ¥è¯¢éƒ¨é—¨çš„æœ€é«˜å·¥èµ„é«˜äº12000çš„éƒ¨é—¨ä¿¡æ¯CREATE VIEW v4 ASSELECT department_id FROM employees GROUP BY department_idHAVING MAX(salary)&gt; 12000;CREATE VIEW emp_v2 ASSELECT * FROM departments WHERE department_id IN(SELECT * FROM v4); 5.è§†å›¾çš„æ›´æ–°è§†å›¾çš„å¯æ›´æ–°æ€§å’Œè§†å›¾ä¸­æŸ¥è¯¢çš„å®šä¹‰æœ‰å…³ï¼Œä»¥ä¸‹ç±»å‹çš„è§†å›¾æ˜¯ä¸èƒ½æ›´æ–°çš„ã€‚1.åŒ…å«ä»¥ä¸‹å…³é”®å­—çš„sqlè¯­å¥ï¼šåˆ†ç»„å‡½æ•°ï¼Œdistinctï¼Œgroup byï¼Œhavingï¼Œunion2.å¸¸é‡è§†å›¾3.selectä¸­åŒ…å«å­æŸ¥è¯¢çš„4.join5.from ä¸€ä¸ªä¸èƒ½æ›´æ–°çš„è§†å›¾6.whereå­å¥çš„å­æŸ¥è¯¢å¼•ç”¨äº†fromå­å¥çš„è¡¨ 6.è§†å›¾å’Œè¡¨çš„å¯¹æ¯”ï¼š åˆ›å»ºè¯­æ³•çš„å…³é”®å­— æ˜¯å¦å®é™…å ç”¨ç‰©ç†ç©ºé—´ ä½¿ç”¨ è§†å›¾ CREATE VIEW åªæ˜¯ä¿å­˜äº†sqlé€»è¾‘ å¢åˆ æ”¹æŸ¥ï¼Œä¸€èˆ¬ä¸èƒ½å¢åˆ æ”¹ è¡¨ CREATE TABLE å ç”¨ å¢åˆ æ”¹æŸ¥ ä¸ƒï¼Œå˜é‡ç³»ç»Ÿå˜é‡ ï¼šå˜é‡ç”±ç³»ç»Ÿæä¾›ï¼Œä¸æ˜¯ç”¨æˆ·è‡ªå®šä¹‰ï¼Œå±äºæœåŠ¡å™¨å±‚é¢ã€‚æŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰å˜é‡ï¼šshow GLOBAL VARIABLES;æŸ¥çœ‹æ»¡è¶³æ¡ä»¶çš„éƒ¨åˆ†ç³»ç»Ÿå˜é‡ï¼š SHOW GLOBAL VARIABLES LIKE â€˜%char%â€™;æŸ¥çœ‹æŒ‡å®šçš„æŸä¸ªç³»ç»Ÿå˜é‡çš„å€¼ï¼š SELECT @@global.autocommit;ä¸ºæŸä¸ªç³»ç»Ÿå˜é‡èµ‹å€¼ï¼šset @@global.ç³»ç»Ÿå˜é‡å=å€¼;å…¨å±€å˜é‡:GLOBALä½œç”¨åŸŸï¼šæœåŠ¡å™¨æ¯æ¬¡å¯åŠ¨å°†ä¸ºæ‰€æœ‰çš„å…¨å±€å˜é‡èµ‹åˆå§‹å€¼ï¼Œé’ˆå¯¹äºæ‰€æœ‰çš„ä¼šè¯æœ‰æ•ˆï¼Œä½†ä¸èƒ½è·¨é‡å¯ã€‚ä¼šè¯å˜é‡:SESSIONä½œç”¨åŸŸï¼šé’ˆå¯¹å½“å‰çš„ä¼šè¯æœ‰æ•ˆã€‚ç”¨æˆ·è‡ªå®šä¹‰å˜é‡ç”¨æˆ·å˜é‡å£°æ˜ï¼š SET/SELECT @ç”¨æˆ·å˜é‡å :=å€¼;èµ‹å€¼ï¼šé€šè¿‡ SELECT å­—æ®µ INTO å˜é‡å;æˆ– SET/SELECT @ç”¨æˆ·å˜é‡å :=å€¼;ä½¿ç”¨ï¼šselect @ç”¨æˆ·å˜é‡å;åº”ç”¨åœ¨ä»»ä½•åœ°æ–¹ã€‚ä½œç”¨åŸŸï¼šé’ˆå¯¹å½“å‰ä¼šè¯å’Œè¿æ¥æœ‰æ•ˆã€‚å±€éƒ¨å˜é‡ä½œç”¨åŸŸï¼šä½œç”¨åœ¨å®šä¹‰å®ƒçš„begin END å—ä¸­ã€‚å£°æ˜ï¼š DECLARE å˜é‡å ç±»å‹ ï¼ˆdefault å€¼ï¼‰;èµ‹å€¼ï¼šé€šè¿‡ SELECT å­—æ®µ INTO å˜é‡å;æˆ– SET/SELECT @å˜é‡å :=å€¼;ä½¿ç”¨ï¼šselect @å˜é‡å;åªèƒ½æ”¾åœ¨begin END ä¸­çš„ç¬¬ä¸€å¥è¯ å…«ï¼Œå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°å­˜å‚¨è¿‡ç¨‹ï¼šä¸€ç»„é¢„å…ˆå®šä¹‰å¥½çš„sqlè¯­å¥é›†åˆï¼Œç†è§£æˆæ‰¹å¤„ç†è¯­å¥ã€‚1.æé«˜ä»£ç çš„é‡ç”¨æ€§2.ç®€åŒ–æ“ä½œ3.å‡å°‘äº†ç¼–è¯‘æ¬¡æ•°å¹¶ä¸”å‡å°‘äº†å’Œæ•°æ®åº“æœåŠ¡å™¨çš„è¿æ¥æ¬¡æ•°ï¼Œæé«˜äº†æ•ˆç‡ã€‚ 1.åˆ›å»ºè¯­æ³•ï¼šCREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹åï¼ˆå‚æ•°åˆ—è¡¨ï¼‰BEGINä¸€ç»„åˆæ³•çš„sqlè¯­å¥;ENDå‚æ•°åˆ—è¡¨ï¼šå‚æ•°æ¨¡å¼ å‚æ•°å å‚æ•°ç±»å‹ å‚æ•°æ¨¡å¼ï¼šinï¼šè¯¥å‚æ•°å¯ä»¥ä½œä¸ºè¾“å…¥ï¼Œä¹Ÿå°±æ˜¯è¯¥å‚æ•°éœ€è¦è°ƒç”¨æ–¹ä¼ å…¥å€¼OUT ï¼šè¯¥å‚æ•°å¯ä»¥ä½œä¸ºè¾“å‡ºï¼Œä¹Ÿå°±æ˜¯è¯¥å‚æ•°å¯ä»¥ä½œä¸ºè¿”å›å€¼inoutï¼šè¯¥å‚æ•°æ—¢å¯ä»¥ä½œä¸ºè¾“å…¥åˆå¯ä»¥ä½œä¸ºè¾“å‡º å¦‚æœå­˜å‚¨è¿‡ç¨‹åªæœ‰ä¸€å¥è¯ï¼Œbegin END å¯ä»¥çœç•¥ å­˜å‚¨è¿‡ç¨‹ä½“ä¸­çš„æ¯æ¡sqlè¯­å¥çš„ç»“å°¾éœ€è¦å¿…é¡»åŠ åˆ†å·ï¼Œå­˜å‚¨è¿‡ç¨‹çš„ç»“å°¾å¯ä»¥ä½¿ç”¨ DELIMITER é‡æ–°è®¾ç½®ã€‚ 2.è°ƒç”¨CALL å­˜å‚¨è¿‡ç¨‹åï¼ˆå®å‚åˆ—è¡¨ï¼‰; 3.æ¡ˆä¾‹1234567891011121314151617181920212223242526272829303132333435363738394041424344#æ’å…¥åˆ°adminè¡¨ä¸­äº”æ¡è®°å½•DELIMITER $CREATE PROCEDURE my_a()BEGININSERT INTO admin(username,PASSWORD) VALUES(&#x27;yin&#x27;,&#x27;666&#x27;);INSERT INTO admin(username,PASSWORD) VALUES(&#x27;aa&#x27;,&#x27;123&#x27;);INSERT INTO admin(username,PASSWORD) VALUES(&#x27;bb&#x27;,&#x27;666&#x27;);INSERT INTO admin(username,PASSWORD) VALUES(&#x27;cc&#x27;,&#x27;123&#x27;);INSERT INTO admin(username,PASSWORD) VALUES(&#x27;dd&#x27;,&#x27;666&#x27;);END $#åˆ›å»ºå­˜å‚¨è¿‡ç¨‹å®ç° æ ¹æ®å¥³ç”ŸåæŸ¥è¯¢å¯¹åº”çš„ç”·ç”Ÿä¿¡æ¯DELIMITER $CREATE PROCEDURE my_b(IN beauty_name VARCHAR(20))BEGIN SELECT bo.* FROM boys bo RIGHT JOIN beauty b ON bo.id=b.boyfriend_id WHERE b.name=beauty_name;END $CALL my_b(&#x27;çƒ­å·´&#x27;);#æ ¹æ®å¥³ç”Ÿåè¿”å›ä»–çš„ç”·æœ‹å‹åDELIMITER $CREATE PROCEDURE my_d(IN beautyName VARCHAR(20),OUT boyName VARCHAR(20))BEGIN SELECT bo.boyName INTO boyName FROM boys bo INNER JOIN beauty b ON bo.id=b.boyfriend_id WHERE b.name=beautyName;END $CALL my_d(&#x27;å°æ˜­&#x27;,@b_name);SELECT @b_name;#ä¼ å…¥ä¸¤ä¸ªå€¼aï¼Œbï¼Œæœ€ç»ˆç¿»å€è¿”å›aå’ŒbDELIMITER $CREATE PROCEDURE my_e(INOUT a INT ,INOUT b INT )BEGIN SET a=a*2; SET b=b*2;END $SET @m=10;SET @n=20;CALL my_e(@m,@n);SELECT @m,@n; 4.åˆ é™¤å­˜å‚¨è¿‡ç¨‹12DROP PROCEDURE å­˜å‚¨è¿‡ç¨‹åDROP PROCEDURE my_a; 5.æŸ¥çœ‹å­˜å‚¨è¿‡ç¨‹çš„ä¿¡æ¯1SHOW CREATE PROCEDURE my_b; å‡½æ•°å­˜å‚¨è¿‡ç¨‹å¯ä»¥æœ‰0/nä¸ªè¿”å›å€¼ï¼šé€‚åˆæ‰¹é‡å¢åˆ æ”¹å‡½æ•°æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªè¿”å›å€¼ï¼šé€‚åˆæŸ¥è¯¢ 1.åˆ›å»º12345DELIMITER $CREATE FUNCTION å‡½æ•°å(å‚æ•°åˆ—è¡¨) RETURNS è¿”å›ç±»å‹BEGINEND æ³¨æ„ï¼šå‚æ•°åˆ—è¡¨ï¼šå‚æ•°åï¼Œå‚æ•°ç±»å‹ä¸€å®šä¼šæœ‰returnè¯­å¥ 2.ä½¿ç”¨SELECT å‡½æ•°å(å‚æ•°åˆ—è¡¨) 12345678910111213141516171819#è¿”å›å…¬å¸å‘˜å·¥ä¸ªæ•°DELIMITER $CREATE FUNCTION my_f1() RETURNS INTBEGINDECLARE c INT DEFAULT 0 ; SELECT COUNT(*) INTO c FROM employees; RETURN c;END $SELECT my_f1();#æ ¹æ®å‘˜å·¥åè¿”å›ä»–çš„å·¥èµ„DELIMITER $CREATE FUNCTION my_f2(NAME VARCHAR(20)) RETURNS DOUBLEBEGIN DECLARE c DOUBLE; SELECT salary INTO c FROM employees WHERE last_name=NAME; RETURN c;END $SET @a=&#x27;Hunold&#x27;;SELECT my_f2(@a); 3.æŸ¥çœ‹1SHOW CREATE FUNCTION my_f2; 4.åˆ é™¤1DROP FUNCTION my_f2; ä¹ï¼Œæµç¨‹æ§åˆ¶åˆ†æ”¯ç»“æ„1.if ï¼ˆè¡¨è¾¾å¼1ï¼Œè¡¨è¾¾å¼2ï¼Œè¡¨è¾¾å¼3ï¼‰å¦‚æœè¡¨è¾¾å¼1æˆç«‹ï¼Œå°±è¿”å›è¡¨è¾¾å¼2çš„å€¼ï¼Œå¦åˆ™è¿”å›è¡¨è¾¾å¼3çš„å€¼ã€‚åº”ç”¨åœ¨ä»»ä½•åœ°æ–¹ 2.case1)switch-CASEè¯­æ³•:CASE è¦åˆ¤æ–­çš„å­—æ®µæˆ–è€…è¡¨è¾¾å¼WHEN å¸¸é‡1 THEN è¦æ˜¾ç¤ºçš„å€¼1æˆ–è€…è¯­å¥1WHEN å¸¸é‡2 THEN è¦æ˜¾ç¤ºçš„å€¼2æˆ–è€…è¯­å¥2â€¦ELSE è¦æ˜¾ç¤ºçš„å€¼næˆ–è€…è¯­å¥nï¼› 1234567891011121314151617181920æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥çš„å·¥èµ„ï¼Œè¦æ±‚éƒ¨é—¨å·==30ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.1å€ï¼Œéƒ¨é—¨å·==40ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.2å€ï¼Œéƒ¨é—¨å·==50ï¼Œæ˜¾ç¤ºçš„å·¥èµ„ä¸º1.3å€ï¼Œå…¶ä»–éƒ¨é—¨ï¼Œæ˜¾ç¤ºåŸæœ‰å·¥èµ„ã€‚SELECT salary AS åŸå§‹å·¥èµ„, department_id , CASE department_id WHEN 30 THEN salary * 1.1 WHEN 40 THEN salary * 1.2 WHEN 50 THEN salary * 1.3 ELSE salary END AS æ–°å·¥èµ„ FROM employees ; 2)CASE ä½¿ç”¨2ï¼šè¯­æ³•ï¼šCASEWHEN æ¡ä»¶1 THEN è¦æ˜¾ç¤ºçš„å€¼1æˆ–è¯­å¥1WHEN æ¡ä»¶2 THEN è¦æ˜¾ç¤ºçš„å€¼2æˆ–è¯­å¥2â€¦ELSE è¦æ˜¾ç¤ºçš„å€¼næˆ–è¯­å¥nEND 12345678910111213141516171819202122232425262728293031323334æ¡ˆä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥çš„å·¥èµ„æƒ…å†µå¦‚æœ&gt;2wï¼Œæ˜¾ç¤ºAå¦‚æœ&gt;1.5wï¼Œæ˜¾ç¤ºBå¦‚æœ&gt;1wï¼Œæ˜¾ç¤ºCå¦åˆ™ï¼Œæ˜¾ç¤ºDSELECT salary, CASE WHEN salary &gt; 20000 THEN &#x27;A&#x27; WHEN salary &gt; 15000 THEN &#x27;B&#x27; WHEN salary &gt; 10000 THEN &#x27;C&#x27; ELSE &#x27;D&#x27; END AS å·¥èµ„ç­‰çº§ FROM employees å¯ä»¥æ”¾åœ¨ä»»ä½•åœ°æ–¹ #åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ï¼Œæ ¹æ®ä¼ å…¥çš„æˆç»©ï¼Œæ˜¾ç¤ºç­‰çº§ï¼Œ90A,80Bï¼Œ70Cï¼Œ60D ï¼ŒF DELIMITER $ CREATE PROCEDURE my_1(IN score INT) BEGIN CASE WHEN score BETWEEN 90 AND 100 THEN SELECT &#x27;A&#x27;; WHEN score BETWEEN 80 AND 90 THEN SELECT &#x27;B&#x27;; WHEN score BETWEEN 70 AND 80 THEN SELECT &#x27;C&#x27;; WHEN score BETWEEN 70 AND 60 THEN SELECT &#x27;D&#x27;; ELSE SELECT &#x27;E&#x27;; END CASE; END $CALL my_1(95); 3.ifè¯­æ³•ï¼šIF æ¡ä»¶1 THEN è¯­å¥1;ELSEIF æ¡ä»¶2 THEN è¯­å¥2;â€¦ELSE è¯­å¥n;END IF;åªèƒ½ç”¨åœ¨begin endä¸­ 12345678910111213#åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ï¼Œæ ¹æ®ä¼ å…¥çš„æˆç»©ï¼Œè¿”å›ç­‰çº§ï¼Œ90A,80Bï¼Œ70Cï¼Œ60D ï¼ŒFDELIMITER $ CREATE FUNCTION my_2( score INT) RETURNS CHAR BEGIN IF score &gt;=90 THEN RETURN&#x27;A&#x27;; ELSEIF score &gt;=80 THEN RETURN&#x27;B&#x27;; ELSEIF score &gt;=70 THEN RETURN&#x27;C&#x27;; ELSEIF score &gt;=60 THEN RETURN&#x27;D&#x27;; ELSE RETURN&#x27;E&#x27;; END IF; END $ SELECT my_2(85); å¾ªç¯ç»“æ„åœ¨å­˜å‚¨è¿‡ç¨‹æˆ–å‡½æ•°é‡Œé¢ä½¿ç”¨ 1.whileè¯­æ³•ï¼šæ ‡ç­¾:WHILE å¾ªç¯æ¡ä»¶ DOå¾ªç¯ä½“;END WHILE æ ‡ç­¾;å¾ªç¯æ§åˆ¶å’Œæ ‡ç­¾æ­é…ä½¿ç”¨ 2.loopè¯­æ³•ï¼šæ ‡ç­¾ï¼š LOOPå¾ªç¯ä½“;END LOOP æ ‡ç­¾; 3.repeatè¯­æ³•ï¼šæ ‡ç­¾ï¼š REPEATå¾ªç¯ä½“;UNTIL ç»“æŸå¾ªç¯çš„æ¡ä»¶END REPEAT æ ‡ç­¾; å¾ªç¯æ§åˆ¶ITERATE ç±»ä¼¼continueLEAVE ç±»ä¼¼break left join==left outer join a left join b å°±æ˜¯å–aå’Œbçš„äº¤é›†åŠ aå‰©ä¸‹çš„éƒ¨åˆ† inner join a inner join bå°±æ˜¯å–äº¤é›†","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"MySQL[äºŒ]æ¦‚è¿°","slug":"MySQL/MySQL[äºŒ]æ¦‚è¿°","date":"2022-01-10T13:58:17.078Z","updated":"2022-01-11T03:00:13.632Z","comments":true,"path":"2022/01/10/MySQL/MySQL[äºŒ]æ¦‚è¿°/","link":"","permalink":"https://yinhuidong.github.io/2022/01/10/MySQL/MySQL[%E4%BA%8C]%E6%A6%82%E8%BF%B0/","excerpt":"","text":"ä¸€ï¼Œä¸€æ¡SQLçš„æŸ¥è¯¢æµç¨‹ å»è¿æ¥æ± è·å–è¿æ¥ æŸ¥è¯¢ç¼“å­˜ï¼Œå‘½ä¸­è¿”å›ï¼Œå¦åˆ™ç»§ç»­å‘ä¸‹ è¯æ³•è§£æ&amp;é¢„å¤„ç† è¯æ³•è§£ææ‹†åˆ†SQLï¼Œè¯­æ³•åˆ†ææ£€æŸ¥SQLçš„æ­£ç¡®æ€§ç”Ÿæˆä¸€é¢—è§£ææ ‘ï¼Œé¢„å¤„ç†æ£€æŸ¥è¡¨åï¼Œåˆ—åï¼Œç”Ÿæˆä¸€é¢—è§£ææ ‘ã€‚ ä¼˜åŒ–å™¨ä¼˜åŒ–ï¼Œä¼˜åŒ–è®¡åˆ’ï¼ŒæŸ¥è¯¢è®¡åˆ’ æ‰§è¡Œå¼•æ“ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ å­˜å‚¨å¼•æ“æŸ¥è¯¢SQLï¼ŒåŠ å…¥ç¼“å­˜ï¼Œè¿”å›ç»“æœã€‚ 1.è·å–è¿æ¥MySQLæ”¯æŒå¤šç§é€šä¿¡åè®®ï¼Œå¯ä»¥ä½¿ç”¨åŒæ­¥/å¼‚æ­¥çš„æ–¹å¼ï¼Œæ”¯æŒé•¿è¿æ¥ï¼ŒçŸ­è¿æ¥ã€‚â€‹ 1.1 é€šä¿¡ç±»å‹â€‹ ä¸€èˆ¬æ¥è¯´ï¼Œè¿æ¥æ•°æ®åº“éƒ½æ˜¯åŒæ­¥è¿æ¥ã€‚â€‹ åŒæ­¥è¿æ¥ï¼šä¾èµ–äºè¢«è°ƒç”¨æ–¹ï¼Œå—é™åˆ¶äºè¢«è°ƒç”¨æ–¹çš„æ€§èƒ½ï¼›ä¸€èˆ¬åªèƒ½ä¸€å¯¹ä¸€ã€‚ å¼‚æ­¥è¿æ¥ï¼šé¿å…é˜»å¡ï¼Œä½†ä¸èƒ½èŠ‚çœSQLçš„æ‰§è¡Œæ—¶é—´ï¼Œå¹¶å‘æƒ…å†µä¸‹ï¼Œæ¯ä¸ªSQLçš„æ‰§è¡Œéƒ½è¦å•ç‹¬å»ºç«‹è¿æ¥ï¼Œå ç”¨å¤§é‡CPUèµ„æºï¼›å¼‚æ­¥è¿æ¥å¿…é¡»ä½¿ç”¨è¿æ¥æ± å‡å°‘çº¿ç¨‹åˆ›å»ºé”€æ¯çš„å¼€é”€ã€‚ 1.2 è¿æ¥æ–¹å¼MySQLé•¿çŸ­è¿æ¥éƒ½æ”¯æŒï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šåœ¨è¿æ¥æ± ä¸­ä½¿ç”¨é•¿è¿æ¥ã€‚ä¿æŒé•¿è¿æ¥ä¼šæ¶ˆè€—å†…å­˜ï¼Œé•¿æ—¶é—´ä¸æ´»åŠ¨çš„è¿æ¥ï¼ŒMySQLæœåŠ¡å™¨ä¼šæ–­å¼€ã€‚â€‹ 12show global variables like &#x27;wait_timeout&#x27;; -- éäº¤äº’å¼è¶…æ—¶æ—¶é—´ï¼Œå¦‚ JDBC ç¨‹åºshow global variables like &#x27;interactive_timeout&#x27;; -- äº¤äº’å¼è¶…æ—¶æ—¶é—´ï¼Œå¦‚æ•°æ®åº“å·¥å…· é»˜è®¤é•¿è¿æ¥æ–­å¼€æ—¶é—´æ˜¯8å°æ—¶ã€‚ å¯ä»¥ä½¿ç”¨ show status;æŸ¥çœ‹å½“å‰MySQLæœ‰å¤šå°‘ä¸ªè¿æ¥ã€‚ 1show global status like &#x27;Thread%&#x27;; Threads_cached ç¼“å­˜ä¸­çš„çº¿ç¨‹è¿æ¥æ•° Threads_connected å½“å‰æ‰“å¼€çš„è¿æ¥æ•° Threads_created ä¸ºå¤„ç†è¿æ¥åˆ›å»ºçš„çº¿ç¨‹æ•° Threads_running éç¡çœ çŠ¶æ€çš„è¿æ¥æ•°ï¼Œé€šå¸¸æŒ‡å¹¶å‘è¿æ¥æ•° æ¯äº§ç”Ÿä¸€ä¸ªè¿æ¥æˆ–è€…ä¼šè¯ï¼ŒæœåŠ¡ç«¯å°±ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚æ€æ­»ä¼šè¯æœ¬è´¨å°±æ˜¯kill çº¿ç¨‹ã€‚â€‹ å¯ä»¥ä½¿ç”¨SHOW PROCESSLIST; ï¼ˆroot ç”¨æˆ·ï¼‰æŸ¥çœ‹ SQL çš„æ‰§è¡ŒçŠ¶æ€ã€‚â€‹ +â€”-+â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”â€”+â€”â€”+â€”â€”â€”-+| Id | User | Host | db | Command | Time | State | Info |+â€”-+â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”â€”+â€”â€”+â€”â€”â€”-+| 11 | root | localhost | NULL | Query | 0 | starting | show processlist |+â€”-+â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”â€”+â€”â€”+â€”â€”â€”-+ çŠ¶æ€ å«ä¹‰ Sleep çº¿ç¨‹æ­£åœ¨ç­‰å¾…å®¢æˆ·ç«¯ï¼Œä»¥å‘å®ƒå‘é€ä¸€ä¸ªæ–°è¯­å¥ Query çº¿ç¨‹æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢æˆ–å¾€å®¢æˆ·ç«¯å‘é€æ•°æ® Locked è¯¥æŸ¥è¯¢è¢«å…¶å®ƒæŸ¥è¯¢é”å®š Copying to tmp table on disk ä¸´æ—¶ç»“æœé›†åˆå¤§äº tmp_table_sizeã€‚çº¿ç¨‹æŠŠä¸´æ—¶è¡¨ä»å­˜å‚¨å™¨å†…éƒ¨æ ¼å¼æ”¹å˜ä¸ºç£ç›˜æ¨¡å¼ï¼Œä»¥èŠ‚çº¦å­˜å‚¨å™¨ Sending data çº¿ç¨‹æ­£åœ¨ä¸º SELECT è¯­å¥å¤„ç†è¡Œï¼ŒåŒæ—¶æ­£åœ¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ® Sorting for group çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆ†ç±»ï¼Œä»¥æ»¡è¶³ GROUP BY è¦æ±‚ Sorting for order çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆ†ç±»ï¼Œä»¥æ»¡è¶³ ORDER BY è¦æ±‚ åœ¨5.7ç‰ˆæœ¬ï¼ŒMySQLçš„é»˜è®¤è¿æ¥æ•°æ˜¯151ä¸ªï¼Œæˆ‘ä»¬æœ€å¤§å¯ä»¥ä¿®æ”¹ä¸º16384ä¸ª ï¼ˆ214ï¼‰ã€‚â€‹ 123show variables like &#x27;max_connections&#x27;;set [global | session] max_connections =10000; 1.3 é€šä¿¡åè®®â€‹ ç¼–ç¨‹è¯­è¨€çš„è¿æ¥æ¨¡å—éƒ½æ˜¯ç”¨ TCP åè®®è¿æ¥åˆ° MySQL æœåŠ¡å™¨çš„ï¼Œæ¯”å¦‚mysql-connector-java-x.x.xx.jarã€‚ ç±»unixç³»ç»Ÿä¸Šï¼Œæ”¯æŒ Socketå¥—æ¥å­—æ–‡ä»¶è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ã€‚/tmp/mysql.sock windowsç³»ç»Ÿä¸Šè¿˜æ”¯æŒå‘½åç®¡é“å’Œå…±äº«å†…å­˜ã€‚ â€‹ 1.4 é€šä¿¡æ–¹å¼MySQLä½¿ç”¨äº†åŠåŒå·¥é€šä¿¡ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯å‘é€SQLè¯­å¥ç»™æœåŠ¡ç«¯çš„æ—¶å€™ï¼Œä¸ç®¡SQLæœ‰å¤šå¤§ï¼Œéƒ½æ˜¯ä¸€æ¬¡å‘è¿‡å»çš„ã€‚â€‹ æ¯”å¦‚æˆ‘ä»¬ç”¨MyBatisåŠ¨æ€SQLç”Ÿæˆäº†ä¸€ä¸ªæ‰¹é‡æ’å…¥çš„è¯­å¥ï¼Œæ’å…¥10ä¸‡æ¡æ•°æ®ï¼Œvaluesåé¢è·Ÿäº†ä¸€é•¿ä¸²çš„å†…å®¹ï¼Œæˆ–è€… where æ¡ä»¶ in é‡Œé¢çš„å€¼å¤ªå¤šï¼Œä¼šå‡ºç°é—®é¢˜ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¿…é¡»è¦è°ƒæ•´ MySQL æœåŠ¡å™¨é…ç½® max_allowed_packet å‚æ•°çš„å€¼ï¼ˆé»˜è®¤æ˜¯ 4Mï¼‰ï¼ŒæŠŠå®ƒè°ƒå¤§ï¼Œå¦åˆ™å°±ä¼šæŠ¥é”™ã€‚ å¯¹äºæœåŠ¡ç«¯æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€æ¬¡æ€§å‘é€æ‰€æœ‰çš„æ•°æ®ï¼Œä¸èƒ½å› ä¸ºä½ å·²ç»å–åˆ°äº†æƒ³è¦çš„æ•°æ®å°±ä¸­æ–­æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™ä¼šå¯¹ç½‘ç»œå’Œå†…å­˜äº§ç”Ÿå¤§é‡æ¶ˆè€—ã€‚åœ¨ç¨‹åºé‡Œé¢é¿å…ä¸å¸¦ limit çš„è¿™ç§æ“ä½œï¼Œæ¯”å¦‚ä¸€æ¬¡æŠŠæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„æ•°æ®å…¨éƒ¨æŸ¥å‡ºæ¥ï¼Œä¸€å®šè¦å…ˆ count ä¸€ä¸‹ã€‚å¦‚æœæ•°æ®é‡çš„è¯ï¼Œå¯ä»¥åˆ†æ‰¹æŸ¥è¯¢ã€‚ 2.æŸ¥è¯¢ç¼“å­˜MySQL çš„ç¼“å­˜é»˜è®¤æ˜¯å…³é—­çš„ã€‚â€‹ 1show variables like &#x27;query_cache%&#x27;; MySQLä¸æ¨èä½¿ç”¨è‡ªå¸¦çš„ç¼“å­˜ï¼Œå‘½ä¸­æ¡ä»¶è¿‡äºè‹›åˆ»ã€‚ä¸”è¡¨é‡Œæ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ•´å¼ è¡¨çš„ç¼“å­˜å…¨éƒ¨å¤±æ•ˆï¼ŒMySQL8ç§»é™¤æ‰äº†ç¼“å­˜ã€‚ 3.è¯­æ³•è§£æ&amp;é¢„å¤„ç†3.1 è¯æ³•è§£æè¯æ³•åˆ†æå°±æ˜¯æŠŠä¸€ä¸ªå®Œæ•´çš„ SQL è¯­å¥æ‰“ç¢æˆä¸€ä¸ªä¸ªçš„å•è¯ã€‚â€‹ 1select name from user where id =1; å®ƒä¼šæ‰“ç¢æˆ 8 ä¸ªç¬¦å·ï¼Œæ¯ä¸ªç¬¦å·æ˜¯ä»€ä¹ˆç±»å‹ï¼Œä»å“ªé‡Œå¼€å§‹åˆ°å“ªé‡Œç»“æŸã€‚â€‹ 3.2 è¯­æ³•è§£æè¯­æ³•åˆ†æä¼šå¯¹ SQL åšä¸€äº›è¯­æ³•æ£€æŸ¥ï¼Œæ¯”å¦‚å•å¼•å·æœ‰æ²¡æœ‰é—­åˆï¼Œç„¶åæ ¹æ® MySQL å®šä¹‰çš„è¯­æ³•è§„åˆ™ï¼Œæ ¹æ® SQL è¯­å¥ç”Ÿæˆä¸€ä¸ªæ•°æ®ç»“æ„ã€‚è¿™ä¸ªæ•°æ®ç»“æ„æˆ‘ä»¬æŠŠå®ƒå«åšè§£ææ ‘ï¼ˆselect_lexï¼‰ã€‚â€‹ ä»»ä½•æ•°æ®åº“çš„ä¸­é—´ä»¶ï¼Œæ¯”å¦‚ Mycatï¼ŒSharding-JDBCï¼ˆç”¨åˆ°äº† Druid Parserï¼‰ï¼Œéƒ½å¿…é¡»è¦æœ‰è¯æ³•å’Œè¯­æ³•åˆ†æåŠŸèƒ½ã€‚ 3.3 é¢„å¤„ç†â€‹ å¦‚æœå†™äº†ä¸€ä¸ªè¯æ³•å’Œè¯­æ³•éƒ½æ­£ç¡®çš„ SQLï¼Œä½†æ˜¯è¡¨åæˆ–è€…å­—æ®µä¸å­˜åœ¨ï¼Œä¼šåœ¨å“ªé‡ŒæŠ¥é”™ï¼Ÿæ˜¯åœ¨æ•°æ®åº“çš„æ‰§è¡Œå±‚è¿˜æ˜¯è§£æå™¨ï¼Ÿâ€‹ å®é™…ä¸Šè¿˜æ˜¯åœ¨è§£æçš„æ—¶å€™æŠ¥é”™ï¼Œè§£æ SQL çš„ç¯èŠ‚é‡Œé¢æœ‰ä¸ªé¢„å¤„ç†å™¨ã€‚å®ƒä¼šæ£€æŸ¥ç”Ÿæˆçš„è§£ææ ‘ï¼Œè§£å†³è§£æå™¨æ— æ³•è§£æçš„è¯­ä¹‰ã€‚æ¯”å¦‚ï¼Œå®ƒä¼šæ£€æŸ¥è¡¨å’Œåˆ—åæ˜¯å¦å­˜åœ¨ï¼Œæ£€æŸ¥åå­—å’Œåˆ«åï¼Œä¿è¯æ²¡æœ‰æ­§ä¹‰ã€‚é¢„å¤„ç†ä¹‹åå¾—åˆ°ä¸€ä¸ªæ–°çš„è§£ææ ‘ã€‚â€‹ 4.æŸ¥è¯¢ä¼˜åŒ–&amp;æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ä¸€æ¡SQLè¯­å¥çš„æ‰§è¡Œæ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä½†æ˜¯æœ€ç»ˆè¿”å›çš„ç»“æœéƒ½æ˜¯ç›¸åŒçš„ã€‚æŸ¥è¯¢ä¼˜åŒ–å™¨çš„ç›®çš„å°±æ˜¯æ ¹æ®è§£ææ ‘ç”Ÿæˆä¸åŒçš„æ‰§è¡Œè®¡åˆ’ï¼ˆExecution Planï¼‰ï¼Œç„¶åé€‰æ‹©ä¸€ç§æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ï¼ŒMySQL é‡Œé¢ä½¿ç”¨çš„æ˜¯åŸºäºå¼€é”€ï¼ˆcostï¼‰çš„ä¼˜åŒ–å™¨ï¼Œé‚£ç§æ‰§è¡Œè®¡åˆ’å¼€é”€æœ€å°ï¼Œå°±ç”¨å“ªç§ã€‚ 12# æŸ¥çœ‹æŸ¥è¯¢çš„å¼€é”€show status like &#x27;Last_query_cost&#x27;; 4.1 ä¼˜åŒ–å™¨çš„ä½œç”¨ å¤šè¡¨è”æŸ¥ï¼Œä»¥å“ªå¼ è¡¨ä¸ºåŸºå‡†è¡¨ ç”¨ä¸ç”¨ç´¢å¼•ï¼Œç”¨å“ªä¸ªç´¢å¼• ã€‚ã€‚ã€‚ã€‚ â€‹ 4.2 ä¼˜åŒ–å™¨æ˜¯æ€ä¹ˆå¾—åˆ°æ‰§è¡Œè®¡åˆ’çš„ é¦–å…ˆæˆ‘ä»¬è¦å¯ç”¨ä¼˜åŒ–å™¨çš„è¿½è¸ªï¼ˆé»˜è®¤æ˜¯å…³é—­çš„ï¼‰ã€‚ å¼€å¯è¿™å¼€å…³æ˜¯ä¼šæ¶ˆè€—æ€§èƒ½çš„ï¼Œå› ä¸ºå®ƒè¦æŠŠä¼˜åŒ–åˆ†æçš„ç»“æœå†™åˆ°è¡¨é‡Œé¢ï¼Œæ‰€ä»¥ä¸è¦è½»æ˜“å¼€å¯ï¼Œæˆ–è€…æŸ¥çœ‹å®Œä¹‹åå…³é—­å®ƒï¼ˆæ”¹æˆ offï¼‰ã€‚ æ¥ç€æ‰§è¡Œä¸€ä¸ª SQL è¯­å¥ï¼Œä¼˜åŒ–å™¨ä¼šç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼š è¿™ä¸ªæ—¶å€™ä¼˜åŒ–å™¨åˆ†æçš„è¿‡ç¨‹å·²ç»è®°å½•åˆ°ç³»ç»Ÿè¡¨é‡Œé¢äº†ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥è¯¢ï¼š å®ƒæ˜¯ä¸€ä¸ª JSON ç±»å‹çš„æ•°æ®ï¼Œä¸»è¦åˆ†æˆä¸‰éƒ¨åˆ†ï¼Œå‡†å¤‡é˜¶æ®µã€ä¼˜åŒ–é˜¶æ®µå’Œæ‰§è¡Œé˜¶æ®µã€‚ expanded_query æ˜¯ä¼˜åŒ–åçš„ SQL è¯­å¥ã€‚ considered_execution_plans é‡Œé¢åˆ—å‡ºäº†æ‰€æœ‰çš„æ‰§è¡Œè®¡åˆ’ã€‚ åˆ†æå®Œè®°å¾—å…³æ‰å®ƒ é€šè¿‡è¿½è¸ªä¼˜åŒ–å™¨ï¼Œå¯ä»¥çœ‹åˆ°ä¼˜åŒ–å™¨å¯¹sqlçš„åˆå§‹ä¼˜åŒ–ï¼Œè¡¨çš„è¯»å–é¡ºåºï¼Œä¸ºä»€ä¹ˆé‡‡ç”¨äº†è¿™ç§è¯»å–é¡ºåºã€‚ä¸ºä»€ä¹ˆé‡‡ç”¨äº†æŸä¸ªç´¢å¼•æˆ–è€…é‡‡ç”¨äº†å…¨è¡¨æŸ¥è¯¢ã€‚ 4.3 ä¼˜åŒ–å™¨å¾—åˆ°çš„ç»“æœâ€‹ ä¼˜åŒ–å™¨æœ€ç»ˆä¼šæŠŠè§£ææ ‘å˜æˆä¸€ä¸ªæŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼ŒæŸ¥è¯¢æ‰§è¡Œè®¡åˆ’æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚ å½“ç„¶ï¼Œè¿™ä¸ªæ‰§è¡Œè®¡åˆ’æ˜¯ä¸æ˜¯ä¸€å®šæ˜¯æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’å‘¢ï¼Ÿä¸ä¸€å®šï¼Œå› ä¸º MySQL ä¹Ÿæœ‰å¯èƒ½è¦†ç›–ä¸åˆ°æ‰€æœ‰çš„æ‰§è¡Œè®¡åˆ’ã€‚â€‹ MySQL æä¾›äº†ä¸€ä¸ªæ‰§è¡Œè®¡åˆ’çš„å·¥å…·ã€‚æˆ‘ä»¬åœ¨ SQL è¯­å¥å‰é¢åŠ ä¸Š EXPLAINï¼Œå°±å¯ä»¥çœ‹åˆ°æ‰§è¡Œè®¡åˆ’çš„ä¿¡æ¯ã€‚â€‹ Explain çš„ç»“æœä¹Ÿä¸ä¸€å®šæœ€ç»ˆæ‰§è¡Œçš„æ–¹å¼ã€‚â€‹ 4.4 é€‰é”™ç´¢å¼•è¿™é‡Œé”™è¯¯å†³å®šåˆ†ä¸¤ç±»ï¼Œç¬¬ä¸€ï¼Œå½»åº•é”™è¯¯ã€‚ç¬¬äºŒï¼ŒåŸºäºæˆæœ¬æœ€ä½ï¼Œä½†æ‰§è¡Œé€Ÿåº¦ä¸æ˜¯æœ€å¿«ã€‚ ç”±äºInnoDBçš„ MVCC åŠŸèƒ½å’Œéšæœºé‡‡æ ·æ–¹å¼ï¼Œé»˜è®¤éšæœºé‡‡å–å‡ ä¸ªæ•°æ®é¡µï¼Œå½“åšæ€»ä½“æ•°æ®ã€‚ä»¥éƒ¨åˆ†ä»£è¡¨æ•´ä½“ï¼Œæœ¬æ¥å°±æœ‰é”™è¯¯çš„é£é™©ã€‚åŠ ä¸Šæ•°æ®ä¸æ–­åœ°æ·»åŠ è¿‡ç¨‹ä¸­ï¼Œç´¢å¼•æ ‘å¯èƒ½ä¼šåˆ†è£‚ï¼Œç»“æœæ›´åŠ ä¸å‡†ç¡®ã€‚ æ‰§è¡Œ ANALYZE TABLE ,å¯ä»¥é‡æ–°æ„å»ºç´¢å¼•ï¼Œä½¿ç´¢å¼•æ ‘ä¸è¿‡äºåˆ†è£‚ã€‚ è°ƒæ•´å‚æ•°ï¼ŒåŠ å¤§InnoDBé‡‡æ ·çš„é¡µæ•°ï¼Œé¡µæ•°è¶Šå¤§è¶Šç²¾ç¡®ï¼Œä½†æ€§èƒ½æ¶ˆè€—æ›´é«˜ã€‚ä¸€èˆ¬ä¸å»ºè®®è¿™ä¹ˆå¹²ã€‚ åœ¨ä¼˜åŒ–é˜¶æ®µï¼Œä¼šå¯¹è¡¨ä¸­æ‰€æœ‰ç´¢å¼•è¿›è¡Œå¯¹æ¯”ï¼Œä¼˜åŒ–å™¨åŸºäºæˆæœ¬çš„åŸå› ï¼Œé€‰æ‹©æˆæœ¬æœ€ä½çš„ç´¢å¼•ï¼Œæ‰€ä»¥ä¼šé”™è¿‡æœ€ä½³ç´¢å¼•ã€‚å¸¦æ¥çš„é—®é¢˜ä¾¿æ˜¯ï¼Œæ‰§è¡Œé€Ÿåº¦å¾ˆæ…¢ã€‚ é€šè¿‡explainæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œç»“åˆsqlæ¡ä»¶æŸ¥çœ‹å¯ä»¥åˆ©ç”¨å“ªäº›ç´¢å¼•ã€‚ ä½¿ç”¨ force index(indexName)å¼ºåˆ¶èµ°æŒ‡å®šç´¢å¼•ã€‚å¼Šç«¯å°±æ˜¯åæœŸè‹¥ç´¢å¼•åå‘ç”Ÿæ”¹å˜ï¼Œæˆ–ç´¢å¼•è¢«åˆ é™¤ï¼Œè¯¥sqlè¯­å¥éœ€è¦è°ƒæ•´ã€‚ 5. å­˜å‚¨å¼•æ“å¾—åˆ°æ‰§è¡Œè®¡åˆ’ä»¥åï¼ŒSQL è¯­å¥æ˜¯ä¸æ˜¯ç»ˆäºå¯ä»¥æ‰§è¡Œäº†ï¼Ÿ ä»é€»è¾‘çš„è§’åº¦æ¥è¯´ï¼Œæˆ‘ä»¬çš„æ•°æ®æ˜¯æ”¾åœ¨å“ªé‡Œçš„ï¼Œæˆ–è€…è¯´æ”¾åœ¨ä¸€ä¸ªä»€ä¹ˆç»“æ„é‡Œé¢ï¼Ÿ æ‰§è¡Œè®¡åˆ’åœ¨å“ªé‡Œæ‰§è¡Œï¼Ÿæ˜¯è°å»æ‰§è¡Œï¼Ÿ è¡¨åœ¨å­˜å‚¨æ•°æ®çš„åŒæ—¶ï¼Œè¿˜è¦ç»„ç»‡æ•°æ®çš„å­˜å‚¨ç»“æ„ï¼Œè¿™ä¸ªå­˜å‚¨ç»“æ„å°±æ˜¯ç”±å­˜å‚¨å¼•æ“å†³å®šçš„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥æŠŠå­˜å‚¨å¼•æ“å«åšè¡¨ç±»å‹ã€‚ åœ¨ MySQL é‡Œé¢ï¼Œæ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œä»–ä»¬æ˜¯å¯ä»¥æ›¿æ¢çš„ï¼Œæ‰€ä»¥å«åšæ’ä»¶å¼çš„å­˜å‚¨å¼•æ“ã€‚â€‹ 5.1 æŸ¥çœ‹å­˜å‚¨å¼•æ“æˆ‘ä»¬æ•°æ®åº“é‡Œé¢å·²ç»å­˜åœ¨çš„è¡¨ï¼Œæˆ‘ä»¬æ€ä¹ˆæŸ¥çœ‹å®ƒä»¬çš„å­˜å‚¨å¼•æ“å‘¢ï¼Ÿâ€‹ 1show table status from `æ•°æ®åº“å`; æˆ–è€…é€šè¿‡ DDL å»ºè¡¨è¯­å¥æ¥æŸ¥çœ‹ã€‚â€‹ åœ¨ MySQL é‡Œé¢ï¼Œæˆ‘ä»¬åˆ›å»ºçš„æ¯ä¸€å¼ è¡¨éƒ½å¯ä»¥æŒ‡å®šå®ƒçš„å­˜å‚¨å¼•æ“ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ•°æ®åº“åªèƒ½ä½¿ç”¨ä¸€ä¸ªå­˜å‚¨å¼•æ“ã€‚å­˜å‚¨å¼•æ“çš„ä½¿ç”¨æ˜¯ä»¥è¡¨ä¸ºå•ä½çš„ã€‚è€Œä¸”ï¼Œåˆ›å»ºè¡¨ä¹‹åè¿˜å¯ä»¥ä¿®æ”¹å­˜å‚¨å¼•æ“ã€‚â€‹ ä¸€å¼ è¡¨ä½¿ç”¨çš„å­˜å‚¨å¼•æ“å†³å®šå­˜å‚¨æ•°æ®çš„ç»“æ„ï¼Œé‚£åœ¨æœåŠ¡å™¨ä¸Šå®ƒä»¬æ˜¯æ€ä¹ˆå­˜å‚¨çš„å‘¢ï¼Ÿå…ˆè¦æ‰¾åˆ°æ•°æ®åº“å­˜æ”¾æ•°æ®çš„è·¯å¾„ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ•°æ®åº“æœ‰ä¸€ä¸ªè‡ªå·±æ–‡ä»¶å¤¹ï¼Œä»¥ yhdæ•°æ®åº“ä¸ºä¾‹ã€‚ä»»ä½•ä¸€ä¸ªå­˜å‚¨å¼•æ“éƒ½æœ‰ä¸€ä¸ª frm æ–‡ä»¶ï¼Œè¿™ä¸ªæ˜¯è¡¨ç»“æ„å®šä¹‰æ–‡ä»¶ã€‚ä¸åŒçš„å­˜å‚¨å¼•æ“å­˜æ”¾æ•°æ®çš„æ–¹å¼ä¸ä¸€æ ·ï¼Œäº§ç”Ÿçš„æ–‡ä»¶ä¹Ÿä¸ä¸€æ ·ï¼Œinnodb æ˜¯ 1 ä¸ªï¼Œmemory æ²¡æœ‰ï¼Œmyisam æ˜¯ä¸¤ä¸ªã€‚ 5.2 å­˜å‚¨å¼•æ“æ¯”è¾ƒâ‘ å¸¸è§å­˜å‚¨å¼•æ“MyISAM å’Œ InnoDB æ˜¯æˆ‘ä»¬ç”¨å¾—æœ€å¤šçš„ä¸¤ä¸ªå­˜å‚¨å¼•æ“ï¼Œåœ¨ MySQL 5.5 ç‰ˆæœ¬ä¹‹å‰ï¼Œé»˜è®¤çš„å­˜å‚¨å¼•æ“æ˜¯ MyISAMï¼Œå®ƒæ˜¯ MySQL è‡ªå¸¦çš„ã€‚ 5.5 ç‰ˆæœ¬ä¹‹åé»˜è®¤çš„å­˜å‚¨å¼•æ“æ”¹æˆäº† InnoDBï¼Œæœ€ä¸»è¦çš„åŸå› è¿˜æ˜¯ InnoDB æ”¯æŒäº‹åŠ¡ï¼Œæ”¯æŒè¡Œçº§åˆ«çš„é”ï¼Œå¯¹äºä¸šåŠ¡ä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯æ¥è¯´æ›´é€‚åˆã€‚ â‘¡æ•°æ®åº“æ”¯æŒçš„å­˜å‚¨å¼•æ“å¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤æŸ¥çœ‹æ•°æ®åº“å¯¹å­˜å‚¨å¼•æ“çš„æ”¯æŒæƒ…å†µï¼š 1show engines ; å…¶ä¸­æœ‰å­˜å‚¨å¼•æ“çš„æè¿°å’Œå¯¹äº‹åŠ¡ã€XA åè®®å’Œ Savepoints çš„æ”¯æŒã€‚ XA åè®®ç”¨æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆåˆ†ä¸ºæœ¬åœ°èµ„æºç®¡ç†å™¨ï¼Œäº‹åŠ¡ç®¡ç†å™¨ï¼‰ã€‚ Savepoints ç”¨æ¥å®ç°å­äº‹åŠ¡ï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰ã€‚åˆ›å»ºäº†ä¸€ä¸ª Savepoints ä¹‹åï¼Œäº‹åŠ¡å°±å¯ä»¥å›æ»šåˆ°è¿™ä¸ªç‚¹ï¼Œä¸ä¼šå½±å“åˆ°åˆ›å»º Savepoints ä¹‹å‰çš„æ“ä½œã€‚ â‘¢MyISAMï¼ˆ3 ä¸ªæ–‡ä»¶ï¼‰åº”ç”¨èŒƒå›´æ¯”è¾ƒå°ã€‚è¡¨çº§é”å®šé™åˆ¶äº†è¯»/å†™çš„æ€§èƒ½ï¼Œå› æ­¤åœ¨ Web å’Œæ•°æ®ä»“åº“é…ç½®ä¸­ï¼Œå®ƒé€šå¸¸ç”¨äºåªè¯»æˆ–ä»¥è¯»ä¸ºä¸»çš„å·¥ä½œã€‚ ç‰¹ç‚¹ æ”¯æŒè¡¨çº§åˆ«çš„é”ï¼ˆæ’å…¥å’Œæ›´æ–°ä¼šé”è¡¨ï¼‰ã€‚ä¸æ”¯æŒäº‹åŠ¡ã€‚ æ‹¥æœ‰è¾ƒé«˜çš„æ’å…¥ï¼ˆinsertï¼‰å’ŒæŸ¥è¯¢ï¼ˆselectï¼‰é€Ÿåº¦ã€‚ å­˜å‚¨äº†è¡¨çš„è¡Œæ•°ï¼ˆcount é€Ÿåº¦æ›´å¿«ï¼‰ã€‚ é€‚åˆï¼šåªè¯»ä¹‹ç±»çš„æ•°æ®åˆ†æçš„é¡¹ç›®ã€‚ â‘£InnoDBï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰mysql 5.7 ä¸­çš„é»˜è®¤å­˜å‚¨å¼•æ“ã€‚InnoDB æ˜¯ä¸€ä¸ªäº‹åŠ¡å®‰å…¨ï¼ˆä¸ ACID å…¼å®¹ï¼‰çš„ MySQLå­˜å‚¨å¼•æ“ï¼Œå®ƒå…·æœ‰æäº¤ã€å›æ»šå’Œå´©æºƒæ¢å¤åŠŸèƒ½æ¥ä¿æŠ¤ç”¨æˆ·æ•°æ®ã€‚InnoDB è¡Œçº§é”ï¼ˆä¸å‡çº§ä¸ºæ›´ç²—ç²’åº¦çš„é”ï¼‰å’Œ Oracle é£æ ¼çš„ä¸€è‡´éé”è¯»æé«˜äº†å¤šç”¨æˆ·å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚InnoDB å°†ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨èšé›†ç´¢å¼•ä¸­ï¼Œä»¥å‡å°‘åŸºäºä¸»é”®çš„å¸¸è§æŸ¥è¯¢çš„ I/Oã€‚ä¸ºäº†ä¿æŒæ•°æ®å®Œæ•´æ€§ï¼ŒInnoDB è¿˜æ”¯æŒå¤–é”®å¼•ç”¨å®Œæ•´æ€§çº¦æŸã€‚ ç‰¹ç‚¹ æ”¯æŒäº‹åŠ¡ï¼Œæ”¯æŒå¤–é”®ï¼Œå› æ­¤æ•°æ®çš„å®Œæ•´æ€§ã€ä¸€è‡´æ€§æ›´é«˜ã€‚ æ”¯æŒè¡Œçº§åˆ«çš„é”å’Œè¡¨çº§åˆ«çš„é”ã€‚ æ”¯æŒè¯»å†™å¹¶å‘ï¼Œå†™ä¸é˜»å¡è¯»ï¼ˆMVCCï¼‰ã€‚ ç‰¹æ®Šçš„ç´¢å¼•å­˜æ”¾æ–¹å¼ï¼Œå¯ä»¥å‡å°‘ IOï¼Œæå‡æŸ¥è¯¢æ•ˆç‡ã€‚ é€‚åˆï¼šç»å¸¸æ›´æ–°çš„è¡¨ï¼Œå­˜åœ¨å¹¶å‘è¯»å†™æˆ–è€…æœ‰äº‹åŠ¡å¤„ç†çš„ä¸šåŠ¡ç³»ç»Ÿã€‚ â‘¤Memory(1ä¸ªæ–‡ä»¶)åŸºäºå†…å­˜çš„å­˜å‚¨å¼•æ“ã€‚ ç‰¹å¾ï¼š åŸºäºå†…å­˜çš„è¡¨ï¼ŒæœåŠ¡å™¨é‡å¯åï¼Œè¡¨ç»“æ„ä¼šè¢«ä¿ç•™ï¼Œä½†è¡¨ä¸­çš„æ•°æ®ä¼šè¢«æ¸…ç©ºã€‚ ä¸éœ€è¦è¿›è¡Œç£ç›˜IOï¼Œæ¯” MYISAM å¿«äº†ä¸€ä¸ªæ•°é‡çº§ã€‚ è¡¨çº§é”ï¼Œæ•…å¹¶å‘æ’å…¥æ€§èƒ½è¾ƒä½ã€‚ æ¯ä¸€è¡Œæ˜¯å›ºå®šçš„ï¼ŒVARCHAR åˆ—åœ¨ memory å­˜å‚¨å¼•æ“ä¸­ä¼šå˜æˆ CHARï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æµªè´¹ã€‚ ä¸æ”¯æŒ BLOB æˆ– TEXT åˆ—ï¼Œå¦‚æœsqlè¿”å›çš„ç»“æœåˆ—ä¸­åŒ…å« BLOB æˆ– TEXTï¼Œå°±ç›´æ¥é‡‡ç”¨ MYISAM å­˜å‚¨å¼•æ“ï¼Œåœ¨ç£ç›˜ä¸Šå»ºä¸´æ—¶è¡¨ æ”¯æŒå“ˆå¸Œç´¢å¼•ï¼ŒB+æ ‘ç´¢å¼• MEMORY å­˜å‚¨å¼•æ“åœ¨å¾ˆå¤šåœ°æ–¹å¯ä»¥å‘æŒ¥å¾ˆå¥½çš„ä½œç”¨ï¼š ç”¨äºæŸ¥æ‰¾æˆ–æ˜ å°„è¡¨ï¼Œä¾‹å¦‚é‚®ç¼–å’Œå·åçš„æ˜ å°„è¡¨ ç”¨äºç¼“å­˜å‘¨æœŸæ€§èšåˆæ•°æ®çš„ç»“æœ ç”¨äºä¿å­˜æ•°æ®åˆ†æä¸­äº§ç”Ÿçš„ä¸­é—´ç»“æœã€‚å³SQLæ‰§è¡Œè¿‡ç¨‹ä¸­ç”¨åˆ°çš„ä¸´æ—¶è¡¨ ç›‘æ§MySQLå†…å­˜ä¸­çš„æ‰§è¡Œæƒ…å†µï¼Œä¾‹å¦‚ï¼šinformation_schema åº“ä¸‹çš„è¡¨åŸºæœ¬éƒ½æ˜¯ memory å­˜å‚¨å¼•æ“ï¼Œç›‘æ§InnoDBç¼“å†²æ± ä¸­page(INNODB_BUFFER_PAGEè¡¨)ï¼ŒInnoDBç¼“å†²æ± çŠ¶æ€(INNODB_BUFFER_POOL_STATSè¡¨)ã€InnoDBç¼“å­˜é¡µæ·˜æ±°è®°å½•(INNODB_BUFFER_PAGE_LRUè¡¨)ã€InnoDBé”ç­‰å¾…(INNODB_LOCK_WAITSè¡¨)ã€InnoDBé”ä¿¡æ¯(INNODB_LOCKSè¡¨)ã€InnoDBä¸­æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡(INNODB_TRXè¡¨)ç­‰ã€‚ MEMORY å­˜å‚¨å¼•æ“é»˜è®¤ hash ç´¢å¼•ï¼Œæ•…ç­‰å€¼æŸ¥è¯¢ç‰¹åˆ«å¿«ã€‚åŒæ—¶ä¹Ÿæ”¯æŒB+æ ‘ç´¢å¼•ã€‚è™½ç„¶æŸ¥è¯¢é€Ÿåº¦ç‰¹åˆ«å¿«ï¼Œä½†ä¾æ—§æ— æ³•å–ä»£ä¼ ç»Ÿçš„ç£ç›˜å»ºè¡¨ã€‚ â‘¥CSV(3ä¸ªæ–‡ä»¶)å®ƒçš„è¡¨å®é™…ä¸Šæ˜¯å¸¦æœ‰é€—å·åˆ†éš”å€¼çš„æ–‡æœ¬æ–‡ä»¶ã€‚csvè¡¨å…è®¸ä»¥csvæ ¼å¼å¯¼å…¥æˆ–è½¬å‚¨æ•°æ®ï¼Œä»¥ä¾¿ä¸è¯»å†™ç›¸åŒæ ¼å¼çš„è„šæœ¬å’Œåº”ç”¨ç¨‹åºäº¤æ¢æ•°æ®ã€‚å› ä¸º csv è¡¨æ²¡æœ‰ç´¢å¼•ï¼Œæ‰€ä»¥é€šå¸¸åœ¨æ­£å¸¸æ“ä½œæœŸé—´å°†æ•°æ®ä¿å­˜åœ¨ innodb è¡¨ä¸­ï¼Œå¹¶ä¸”åªåœ¨å¯¼å…¥æˆ–å¯¼å‡ºé˜¶æ®µä½¿ç”¨ csv è¡¨ã€‚ ç‰¹ç‚¹ ä¸å…è®¸ç©ºè¡Œï¼Œä¸æ”¯æŒç´¢å¼•ã€‚æ ¼å¼é€šç”¨ï¼Œå¯ä»¥ç›´æ¥ç¼–è¾‘ï¼Œé€‚åˆåœ¨ä¸åŒæ•°æ®åº“ä¹‹é—´å¯¼å…¥å¯¼å‡ºã€‚â€‹ 5.3 å¦‚ä½•é€‰æ‹©å­˜å‚¨å¼•æ“ å¦‚æœå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æ¯”è¾ƒé«˜ï¼Œéœ€è¦äº‹åŠ¡æ”¯æŒï¼Œå¯ä»¥é€‰æ‹© InnoDBã€‚ å¦‚æœæ•°æ®æŸ¥è¯¢å¤šæ›´æ–°å°‘ï¼Œå¯¹æŸ¥è¯¢æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¯ä»¥é€‰æ‹© MyISAMã€‚ å¦‚æœéœ€è¦ä¸€ä¸ªç”¨äºæŸ¥è¯¢çš„ä¸´æ—¶è¡¨ï¼Œå¯ä»¥é€‰æ‹© Memoryã€‚ â€‹ 6.æ‰§è¡Œå¼•æ“æ‰§è¡Œå¼•æ“ï¼Œå®ƒåˆ©ç”¨å­˜å‚¨å¼•æ“æä¾›çš„ç›¸åº”çš„ API æ¥å®Œæˆæ“ä½œã€‚ ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¿®æ”¹äº†è¡¨çš„å­˜å‚¨å¼•æ“ï¼Œæ“ä½œæ–¹å¼ä¸éœ€è¦åšä»»ä½•æ”¹å˜ï¼Ÿå› ä¸ºä¸åŒåŠŸèƒ½çš„å­˜å‚¨å¼•æ“å®ç°çš„ API æ˜¯ç›¸åŒçš„ã€‚ æœ€åæŠŠæ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå³ä½¿æ²¡æœ‰ç»“æœä¹Ÿè¦è¿”å›ã€‚â€‹ äºŒï¼Œä¸€æ¡SQLçš„æ›´æ–°æµç¨‹æ›´æ–°å’ŒæŸ¥è¯¢å¾ˆå¤šåœ°æ–¹å¹¶æ²¡æœ‰åŒºåˆ«ï¼Œä»…ä»…åœ¨äºæ‹¿åˆ°æ•°æ®ä¹‹åçš„æ“ä½œã€‚ 1.å†…å­˜ç»“æ„InnnoDB çš„æ•°æ®éƒ½æ˜¯æ”¾åœ¨ç£ç›˜ä¸Šçš„ï¼ŒInnoDB æ“ä½œæ•°æ®æœ‰ä¸€ä¸ªæœ€å°çš„é€»è¾‘å•ä½ï¼Œå«åšé¡µï¼ˆç´¢å¼•é¡µå’Œæ•°æ®é¡µï¼‰ã€‚æˆ‘ä»¬å¯¹äºæ•°æ®çš„æ“ä½œï¼Œä¸æ˜¯æ¯æ¬¡éƒ½ç›´æ¥æ“ä½œç£ç›˜ï¼Œå› ä¸ºç£ç›˜çš„é€Ÿåº¦å¤ªæ…¢äº†ã€‚InnoDB ä½¿ç”¨äº†ä¸€ç§ç¼“å†²æ± çš„æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯æŠŠç£ç›˜è¯»åˆ°çš„é¡µæ”¾åˆ°ä¸€å—å†…å­˜åŒºåŸŸé‡Œé¢ã€‚è¿™ä¸ªå†…å­˜åŒºåŸŸå°±å« Buffer Poolã€‚â€‹ ä¸‹ä¸€æ¬¡è¯»å–ç›¸åŒçš„é¡µï¼Œå…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯åœ¨ç¼“å†²æ± é‡Œé¢ï¼Œå¦‚æœæ˜¯ï¼Œå°±ç›´æ¥è¯»å–ï¼Œä¸ç”¨å†æ¬¡è®¿é—®ç£ç›˜ã€‚ ä¿®æ”¹æ•°æ®çš„æ—¶å€™ï¼Œå…ˆä¿®æ”¹ç¼“å†²æ± é‡Œé¢çš„é¡µã€‚å†…å­˜çš„æ•°æ®é¡µå’Œç£ç›˜æ•°æ®ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŠŠå®ƒå«åšè„é¡µã€‚InnoDB é‡Œé¢æœ‰ä¸“é—¨çš„åå°çº¿ç¨‹æŠŠ Buffer Pool çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±ä¸€æ¬¡æ€§åœ°æŠŠå¤šä¸ªä¿®æ”¹å†™å…¥ç£ç›˜ï¼Œè¿™ä¸ªåŠ¨ä½œå°±å«åšåˆ·è„ã€‚ Buffer Pool æ˜¯ InnoDB é‡Œé¢éå¸¸é‡è¦çš„ä¸€ä¸ªç»“æ„ï¼Œä¸»è¦åˆ†ä¸º 3 ä¸ªéƒ¨åˆ†ï¼š Buffer Poolã€Change Bufferã€Adaptive HashIndexï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ªï¼ˆredoï¼‰log bufferã€‚â€‹ 1.1 buffer poolBuffer Pool ç¼“å­˜çš„æ˜¯é¡µä¿¡æ¯ï¼ŒåŒ…æ‹¬æ•°æ®é¡µã€ç´¢å¼•é¡µï¼Œé»˜è®¤å¤§å°æ˜¯ 128Mï¼ˆ134217728 å­—èŠ‚ï¼‰ï¼Œå¯ä»¥è°ƒæ•´ã€‚ æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€ï¼Œé‡Œé¢æœ‰å¾ˆå¤šè·Ÿ Buffer Pool ç›¸å…³çš„ä¿¡æ¯ï¼š 1SHOW STATUS LIKE &#x27;%innodb_buffer_pool%&#x27;; æŸ¥çœ‹å‚æ•°ï¼ˆç³»ç»Ÿå˜é‡ï¼‰ï¼š 1SHOW VARIABLES like &#x27;%innodb_buffer_pool%&#x27;; å†…å­˜çš„ç¼“å†²æ± å†™æ»¡äº†æ€ä¹ˆåŠï¼Ÿï¼ˆRedis è®¾ç½®çš„å†…å­˜æ»¡äº†æ€ä¹ˆåŠï¼Ÿï¼‰InnoDB ç”¨ LRUç®—æ³•æ¥ç®¡ç†ç¼“å†²æ± ï¼ˆé“¾è¡¨å®ç°ï¼Œä¸æ˜¯ä¼ ç»Ÿçš„ LRUï¼Œåˆ†æˆäº† young å’Œ oldï¼‰ï¼Œç»è¿‡æ·˜æ±°çš„æ•°æ®å°±æ˜¯çƒ­ç‚¹æ•°æ®ã€‚ å†…å­˜ç¼“å†²åŒºå¯¹äºæå‡è¯»å†™æ€§èƒ½æœ‰å¾ˆå¤§çš„ä½œç”¨ã€‚å½“éœ€è¦æ›´æ–°ä¸€ä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœæ•°æ®é¡µåœ¨ Buffer Pool ä¸­å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ç›´æ¥æ›´æ–°å¥½äº†ã€‚å¦åˆ™çš„è¯å°±éœ€è¦ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ï¼Œå†å¯¹å†…å­˜çš„æ•°æ®é¡µè¿›è¡Œæ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­ç¼“å†²æ± ï¼Œè‡³å°‘è¦äº§ç”Ÿä¸€æ¬¡ç£ç›˜ IOã€‚â€‹ 1.2 ChangeBufferå†™ç¼“å†²å¦‚æœè¿™ä¸ªæ•°æ®é¡µä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä¸å­˜åœ¨æ•°æ®é‡å¤çš„æƒ…å†µï¼Œä¹Ÿå°±ä¸éœ€è¦ä»ç£ç›˜åŠ è½½ç´¢å¼•é¡µåˆ¤æ–­æ•°æ®æ˜¯ä¸æ˜¯é‡å¤ï¼ˆå”¯ä¸€æ€§æ£€æŸ¥ï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹å¯ä»¥å…ˆæŠŠä¿®æ”¹è®°å½•åœ¨å†…å­˜çš„ç¼“å†²æ± ä¸­ï¼Œä»è€Œæå‡æ›´æ–°è¯­å¥ï¼ˆInsertã€Deleteã€Updateï¼‰çš„æ‰§è¡Œé€Ÿåº¦ã€‚ è¿™ä¸€å—åŒºåŸŸå°±æ˜¯ Change Bufferã€‚5.5 ä¹‹å‰å« Insert Buffer æ’å…¥ç¼“å†²ï¼Œç°åœ¨ä¹Ÿèƒ½æ”¯æŒ delete å’Œ updateã€‚ æœ€åæŠŠ Change Buffer è®°å½•åˆ°æ•°æ®é¡µçš„æ“ä½œå«åš mergeã€‚ä»€ä¹ˆæ—¶å€™å‘ç”Ÿ mergeï¼Ÿæœ‰å‡ ç§æƒ…å†µï¼šåœ¨è®¿é—®è¿™ä¸ªæ•°æ®é¡µçš„æ—¶å€™ï¼Œæˆ–è€…é€šè¿‡åå°çº¿ç¨‹ã€æˆ–è€…æ•°æ®åº“ shut downã€redo log å†™æ»¡æ—¶è§¦å‘ã€‚ å¦‚æœæ•°æ®åº“å¤§éƒ¨åˆ†ç´¢å¼•éƒ½æ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œå¹¶ä¸”ä¸šåŠ¡æ˜¯å†™å¤šè¯»å°‘ï¼Œä¸ä¼šåœ¨å†™æ•°æ®åç«‹åˆ»è¯»å–ï¼Œå°±å¯ä»¥ä½¿ç”¨ Change Bufferï¼ˆå†™ç¼“å†²ï¼‰ã€‚å†™å¤šè¯»å°‘çš„ä¸šåŠ¡ï¼Œè°ƒå¤§è¿™ä¸ªå€¼ï¼š 1SHOW VARIABLES LIKE &#x27;innodb_change_buffer_max_size&#x27;; ä»£è¡¨ Change Buffer å  Buffer Pool çš„æ¯”ä¾‹ï¼Œé»˜è®¤ 25%ã€‚â€‹ 1.3 Adaptive Hash Indexå½“æˆ‘ä»¬éœ€è¦è®¿é—®æŸä¸ªé¡µä¸­çš„æ•°æ®æ—¶ï¼Œå°±ä¼šæŠŠè¯¥é¡µä»ç£ç›˜åŠ è½½åˆ°Buffer Poolä¸­ï¼Œå¦‚æœè¯¥é¡µå·²ç»åœ¨Buffer Poolä¸­çš„è¯ç›´æ¥ä½¿ç”¨å°±å¯ä»¥äº†ã€‚é‚£ä¹ˆé—®é¢˜ä¹Ÿå°±æ¥äº†ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¯¥é¡µåœ¨ä¸åœ¨Buffer Poolä¸­å‘¢ï¼Ÿ æˆ‘ä»¬å…¶å®æ˜¯æ ¹æ®è¡¨ç©ºé—´å· + é¡µå·æ¥å®šä½ä¸€ä¸ªé¡µçš„ï¼Œä¹Ÿå°±ç›¸å½“äºè¡¨ç©ºé—´å· + é¡µå·æ˜¯ä¸€ä¸ªkeyï¼Œç¼“å­˜é¡µå°±æ˜¯å¯¹åº”çš„valueï¼Œæ€ä¹ˆé€šè¿‡ä¸€ä¸ªkeyæ¥å¿«é€Ÿæ‰¾ç€ä¸€ä¸ªvalueå‘¢ï¼Ÿé‚£è‚¯å®šæ˜¯å“ˆå¸Œè¡¨ã€‚ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨è¡¨ç©ºé—´å· + é¡µå·ä½œä¸ºkeyï¼Œç¼“å­˜é¡µä½œä¸ºvalueåˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œåœ¨éœ€è¦è®¿é—®æŸä¸ªé¡µçš„æ•°æ®æ—¶ï¼Œå…ˆä»å“ˆå¸Œè¡¨ä¸­æ ¹æ®è¡¨ç©ºé—´å· + é¡µå·çœ‹çœ‹æœ‰æ²¡æœ‰å¯¹åº”çš„ç¼“å­˜é¡µï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥ä½¿ç”¨è¯¥ç¼“å­˜é¡µå°±å¥½ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£å°±ä»freeé“¾è¡¨ä¸­é€‰ä¸€ä¸ªç©ºé—²çš„ç¼“å­˜é¡µï¼Œç„¶åæŠŠç£ç›˜ä¸­å¯¹åº”çš„é¡µåŠ è½½åˆ°è¯¥ç¼“å­˜é¡µçš„ä½ç½®ã€‚â€‹ 1.4 ï¼ˆredoï¼‰Log Bufferâ€‹ å¦‚æœ Buffer Pool é‡Œé¢çš„è„é¡µè¿˜æ²¡æœ‰åˆ·å…¥ç£ç›˜æ—¶ï¼Œæ•°æ®åº“å®•æœºæˆ–è€…é‡å¯ï¼Œè¿™äº›æ•°æ®ä¸¢å¤±ã€‚å¦‚æœå†™æ“ä½œå†™åˆ°ä¸€åŠï¼Œç”šè‡³å¯èƒ½ä¼šç ´åæ•°æ®æ–‡ä»¶å¯¼è‡´æ•°æ®åº“ä¸å¯ç”¨ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼ŒInnoDB æŠŠæ‰€æœ‰å¯¹é¡µé¢çš„ä¿®æ”¹æ“ä½œä¸“é—¨å†™å…¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨æ•°æ®åº“å¯åŠ¨æ—¶ä»è¿™ä¸ªæ–‡ä»¶è¿›è¡Œæ¢å¤æ“ä½œï¼ˆå®ç° crash-safeï¼‰â€”â€”ç”¨å®ƒæ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§ã€‚â€‹ è¿™ä¸ªæ–‡ä»¶å°±æ˜¯ç£ç›˜çš„ redo logï¼ˆå«åšé‡åšæ—¥å¿—ï¼‰ï¼Œå¯¹åº”äº/var/lib/mysql/ç›®å½•ä¸‹çš„ib_logfile0 å’Œ ib_logfile1ï¼Œæ¯ä¸ª 48Mã€‚è¿™ ç§ æ—¥ å¿— å’Œ ç£ ç›˜ é… åˆ çš„ æ•´ ä¸ª è¿‡ ç¨‹ ï¼Œ å…¶ å® å°± æ˜¯ MySQL é‡Œ çš„ WAL æŠ€ æœ¯ï¼ˆWrite-Ahead Loggingï¼‰ï¼Œå®ƒçš„å…³é”®ç‚¹å°±æ˜¯å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜ã€‚ 1show variables like &#x27;innodb_log%&#x27;; å€¼ å«ä¹‰ innodb_log_file_size æŒ‡å®šæ¯ä¸ªæ–‡ä»¶çš„å¤§å°ï¼Œé»˜è®¤ 48M innodb_log_files_in_group æŒ‡å®šæ–‡ä»¶çš„æ•°é‡ï¼Œé»˜è®¤ä¸º 2 innodb_log_group_home_dir æŒ‡å®šæ–‡ä»¶æ‰€åœ¨è·¯å¾„ï¼Œç›¸å¯¹æˆ–ç»å¯¹ã€‚å¦‚æœä¸æŒ‡å®šï¼Œåˆ™ä¸ºdatadir è·¯å¾„ã€‚ åŒæ ·æ˜¯å†™ç£ç›˜ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥å†™åˆ° db file é‡Œé¢å»ï¼Ÿä¸ºä»€ä¹ˆå…ˆå†™æ—¥å¿—å†å†™ç£ç›˜ï¼Ÿ ç£ç›˜çš„æœ€å°ç»„æˆå•å…ƒæ˜¯æ‰‡åŒºï¼Œé€šå¸¸æ˜¯ 512 ä¸ªå­—èŠ‚ã€‚æ“ä½œç³»ç»Ÿå’Œå†…å­˜æ‰“äº¤é“ï¼Œæœ€å°çš„å•ä½æ˜¯é¡µ Pageã€‚æ“ä½œç³»ç»Ÿå’Œç£ç›˜æ‰“äº¤é“ï¼Œè¯»å†™ç£ç›˜ï¼Œæœ€å°çš„å•ä½æ˜¯å— Blockã€‚â€‹ å¦‚æœæˆ‘ä»¬æ‰€éœ€è¦çš„æ•°æ®æ˜¯éšæœºåˆ†æ•£åœ¨ä¸åŒé¡µçš„ä¸åŒæ‰‡åŒºä¸­ï¼Œé‚£ä¹ˆæ‰¾åˆ°ç›¸åº”çš„æ•°æ®éœ€è¦ç­‰åˆ°ç£è‡‚æ—‹è½¬åˆ°æŒ‡å®šçš„é¡µï¼Œç„¶åç›˜ç‰‡å¯»æ‰¾åˆ°å¯¹åº”çš„æ‰‡åŒºï¼Œæ‰èƒ½æ‰¾åˆ°æˆ‘ä»¬æ‰€éœ€è¦çš„ä¸€å—æ•°æ®ï¼Œä¾æ¬¡è¿›è¡Œæ­¤è¿‡ç¨‹ç›´åˆ°æ‰¾å®Œæ‰€æœ‰æ•°æ®ï¼Œè¿™ä¸ªå°±æ˜¯éšæœº IOï¼Œè¯»å–æ•°æ®é€Ÿåº¦è¾ƒæ…¢ã€‚ å‡è®¾æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†ç¬¬ä¸€å—æ•°æ®ï¼Œå¹¶ä¸”å…¶ä»–æ‰€éœ€çš„æ•°æ®å°±åœ¨è¿™ä¸€å—æ•°æ®åè¾¹ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦é‡æ–°å¯»å€ï¼Œå¯ä»¥ä¾æ¬¡æ‹¿åˆ°æˆ‘ä»¬æ‰€éœ€çš„æ•°æ®ï¼Œè¿™ä¸ªå°±å«é¡ºåº IOã€‚ åˆ·ç›˜æ˜¯éšæœº I/Oï¼Œè€Œè®°å½•æ—¥å¿—æ˜¯é¡ºåº I/Oï¼Œé¡ºåº I/O æ•ˆç‡æ›´é«˜ã€‚å› æ­¤å…ˆæŠŠä¿®æ”¹å†™å…¥æ—¥å¿—ï¼Œå¯ä»¥å»¶è¿Ÿåˆ·ç›˜æ—¶æœºï¼Œè¿›è€Œæå‡ç³»ç»Ÿååã€‚ å½“ç„¶ redo log ä¹Ÿä¸æ˜¯æ¯ä¸€æ¬¡éƒ½ç›´æ¥å†™å…¥ç£ç›˜ï¼Œåœ¨ Buffer Pool é‡Œé¢æœ‰ä¸€å—å†…å­˜åŒºåŸŸï¼ˆLog Bufferï¼‰ä¸“é—¨ç”¨æ¥ä¿å­˜å³å°†è¦å†™å…¥æ—¥å¿—æ–‡ä»¶çš„æ•°æ®ï¼Œé»˜è®¤ 16Mï¼Œå®ƒä¸€æ ·å¯ä»¥èŠ‚çœç£ç›˜ IOã€‚â€‹ 1SHOW VARIABLES LIKE &#x27;innodb_log_buffer_size&#x27;; redo log çš„å†…å®¹ä¸»è¦æ˜¯ç”¨äºå´©æºƒæ¢å¤ã€‚ç£ç›˜çš„æ•°æ®æ–‡ä»¶ï¼Œæ•°æ®æ¥è‡ª buffer poolã€‚redo log å†™å…¥ç£ç›˜ï¼Œä¸æ˜¯å†™å…¥æ•°æ®æ–‡ä»¶ã€‚ é‚£ä¹ˆï¼ŒLog Buffer ä»€ä¹ˆæ—¶å€™å†™å…¥ log fileï¼Ÿ åœ¨æˆ‘ä»¬å†™å…¥æ•°æ®åˆ°ç£ç›˜çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿæœ¬èº«æ˜¯æœ‰ç¼“å­˜çš„ã€‚flush å°±æ˜¯æŠŠæ“ä½œç³»ç»Ÿç¼“å†²åŒºå†™å…¥åˆ°ç£ç›˜ã€‚ log buffer å†™å…¥ç£ç›˜çš„æ—¶æœºï¼Œç”±ä¸€ä¸ªå‚æ•°æ§åˆ¶ï¼Œé»˜è®¤æ˜¯ 1ã€‚ 1SHOW VARIABLES LIKE &#x27;innodb_flush_log_at_trx_commit&#x27;; å€¼ å«ä¹‰ 0ï¼ˆå»¶è¿Ÿå†™ï¼‰ log buffer å°†æ¯ç§’ä¸€æ¬¡åœ°å†™å…¥ log file ä¸­ï¼Œå¹¶ä¸” log file çš„ flush æ“ä½œåŒæ—¶è¿›è¡Œã€‚è¯¥æ¨¡å¼ä¸‹ï¼Œåœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œä¸ä¼šä¸»åŠ¨è§¦å‘å†™å…¥ç£ç›˜çš„æ“ä½œã€‚ 1ï¼ˆé»˜è®¤ï¼Œå®æ—¶å†™ï¼Œå®æ—¶åˆ·ï¼‰ æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ MySQL éƒ½ä¼šæŠŠ log buffer çš„æ•°æ®å†™å…¥ log fileï¼Œå¹¶ä¸”åˆ·åˆ°ç£ç›˜ä¸­å»ã€‚ 2ï¼ˆå®æ—¶å†™ï¼Œå»¶è¿Ÿåˆ·ï¼‰ æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ MySQL éƒ½ä¼šæŠŠ log buffer çš„æ•°æ®å†™å…¥ log fileã€‚ä½†æ˜¯ flush æ“ä½œå¹¶ä¸ä¼šåŒæ—¶è¿›è¡Œã€‚è¯¥æ¨¡å¼ä¸‹ï¼ŒMySQL ä¼šæ¯ç§’æ‰§è¡Œä¸€æ¬¡ flush æ“ä½œã€‚ redo logï¼Œå®ƒåˆåˆ†æˆå†…å­˜å’Œç£ç›˜ä¸¤éƒ¨åˆ†ã€‚redo log æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ redo log æ˜¯ InnoDB å­˜å‚¨å¼•æ“å®ç°çš„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰å­˜å‚¨å¼•æ“éƒ½æœ‰ã€‚ ä¸æ˜¯è®°å½•æ•°æ®é¡µæ›´æ–°ä¹‹åçš„çŠ¶æ€ï¼Œè€Œæ˜¯è®°å½•è¿™ä¸ªé¡µåšäº†ä»€ä¹ˆæ”¹åŠ¨ï¼Œå±äºç‰©ç†æ—¥å¿—ã€‚ï¼ˆredo log è®°å½•çš„æ˜¯æ‰§è¡Œçš„ç»“æœï¼‰ redo log çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå‰é¢çš„å†…å®¹ä¼šè¢«è¦†ç›–ã€‚ check point æ˜¯å½“å‰è¦è¦†ç›–çš„ä½ç½®ã€‚å¦‚æœ write pos è·Ÿ check point é‡å ï¼Œè¯´æ˜ redolog å·²ç»å†™æ»¡ï¼Œè¿™æ—¶å€™éœ€è¦åŒæ­¥ redo log åˆ°ç£ç›˜ä¸­ã€‚ è¿™æ˜¯ MySQL çš„å†…å­˜ç»“æ„ï¼Œæ€»ç»“ä¸€ä¸‹ï¼Œåˆ†ä¸ºï¼šBuffer poolã€change bufferã€Adaptive Hash Indexã€ log bufferã€‚ ç£ç›˜ç»“æ„é‡Œé¢ä¸»è¦æ˜¯å„ç§å„æ ·çš„è¡¨ç©ºé—´ï¼Œå«åš Table spaceã€‚ 1.5 ç¼“å­˜çš„ç–‘é—®ç¼“å­˜ï¼ˆcacheï¼‰æ˜¯åœ¨è¯»å–ç¡¬ç›˜ä¸­çš„æ•°æ®æ—¶ï¼ŒæŠŠæœ€å¸¸ç”¨çš„æ•°æ®ä¿å­˜åœ¨å†…å­˜çš„ç¼“å­˜åŒºä¸­ï¼Œå†æ¬¡è¯»å–è¯¥æ•°æ®æ—¶ï¼Œå°±ä¸å»ç¡¬ç›˜ä¸­è¯»å–äº†ï¼Œè€Œåœ¨ç¼“å­˜ä¸­è¯»å–ã€‚ç¼“å†²ï¼ˆbufferï¼‰æ˜¯åœ¨å‘ç¡¬ç›˜å†™å…¥æ•°æ®æ—¶ï¼Œå…ˆæŠŠæ•°æ®æ”¾å…¥ç¼“å†²åŒº,ç„¶åå†ä¸€èµ·å‘ç¡¬ç›˜å†™å…¥ï¼ŒæŠŠåˆ†æ•£çš„å†™æ“ä½œé›†ä¸­è¿›è¡Œï¼Œå‡å°‘ç£ç›˜ç¢ç‰‡å’Œç¡¬ç›˜çš„åå¤å¯»é“ï¼Œä»è€Œæé«˜ç³»ç»Ÿæ€§èƒ½ã€‚ ç„¶åï¼ŒInnoDBæ¶æ„ä¸­ï¼Œæœ‰éå¸¸é‡è¦çš„ä¸€ä¸ªéƒ¨åˆ†â€”â€”ç¼“å†²æ± ã€‚è¯¥ç¼“å†²æ± éœ€è¦å ç”¨æœåŠ¡å™¨å†…å­˜ï¼Œä¸”ä¸“ç”¨äºMySQLçš„æœåŠ¡å™¨ï¼Œå»ºè®®æŠŠ80%çš„å†…å­˜äº¤ç»™MySQLã€‚ ç¼“å†²æ± æœ‰ä¸€ä¸ªç¼“å­˜çš„åŠŸèƒ½ã€‚è¿™ä¸ªç¼“å­˜ï¼Œæ˜¯InnoDBè‡ªå¸¦çš„ï¼Œè€Œä¸”ç»å¸¸ä¼šç”¨åˆ°ã€‚è¯¥ç¼“å­˜åŠŸèƒ½å¹¶ä¸æ˜¯MySQLæ¶æ„ä¸­çš„ç¼“å­˜ç»„ä»¶ã€‚è¿™æ˜¯ä¸¤è€…æœ€å¤§çš„åŒºåˆ«ã€‚ MySQLç»„ä»¶ä¸­çš„ç¼“å­˜ æ‰€å¤„ä½ç½®ï¼šMySQLæ¶æ„ä¸­çš„ç¼“å­˜ç»„ä»¶ ç¼“å­˜å†…å®¹ï¼šç¼“å­˜çš„æ˜¯SQL å’Œ è¯¥SQLçš„æŸ¥è¯¢ç»“æœã€‚å¦‚æœSQLçš„å¤§å°å†™ï¼Œæ ¼å¼ï¼Œæ³¨é‡Šä¸ä¸€è‡´ï¼Œåˆ™è¢«è®¤ä¸ºæ˜¯ä¸åŒçš„SQLï¼Œé‡æ–°æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶ç¼“å­˜ä¸€ä»½æ•°æ®ã€‚ å¯å¦å…³é—­ï¼šæ˜¯å¯ä»¥æ‰‹åŠ¨å…³é—­ï¼Œå¹¶å¸è½½è¯¥ç»„ä»¶çš„ã€‚ InnoDBä¸­çš„ç¼“å­˜ æ‰€å¤„ä½ç½®ï¼šInnoDBæ¶æ„ä¸­çš„ç¼“å†²æ±  ç¼“å­˜å†…å®¹ï¼šç¼“å­˜çš„æ˜¯æ‰€æœ‰éœ€è¦æŸ¥æ‰¾çš„æ•°æ®ï¼Œæ‰€åœ¨çš„æ•°æ®é¡µã€‚ å¯å¦å…³é—­ï¼šæ˜¯InnoDBç¼“å†²æ± è‡ªå¸¦çš„åŠŸèƒ½ï¼Œæ— æ³•å…³é—­ï¼Œæ— æ³•å¸è½½ã€‚å¦‚æœInnoDBçš„ç¼“å†²æ± è¢«å…³é—­æˆ–å¸è½½ï¼Œåˆ™InnoDBç›´æ¥ç˜«ç—ªã€‚æ‰€ä»¥è¯´ç¼“å†²æ± æ˜¯InnoDBçš„æœ€é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚ ä¸å»ºè®®ä½¿ç”¨MySQLçš„ç¼“å­˜æ˜¯æŒ‡ï¼Œä¸å»ºè®®ä½¿ç”¨MySQLæ¶æ„ä¸­çš„ç¼“å­˜ç»„ä»¶ï¼Œå¹¶ä¸æ˜¯åŒæ—¶å¦å®šäº†InnoDBä¸­çš„ç¼“å­˜åŠŸèƒ½ã€‚â€‹ 2.ç£ç›˜ç»“æ„è¡¨ç©ºé—´å¯ä»¥çœ‹åšæ˜¯ InnoDB å­˜å‚¨å¼•æ“é€»è¾‘ç»“æ„çš„æœ€é«˜å±‚ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½å­˜æ”¾åœ¨è¡¨ç©ºé—´ä¸­ã€‚InnoDB çš„è¡¨ç©ºé—´åˆ†ä¸º 5 å¤§ç±»ã€‚â€‹ 2.1 ç³»ç»Ÿè¡¨ç©ºé—´åœ¨é»˜è®¤æƒ…å†µä¸‹ InnoDB å­˜å‚¨å¼•æ“æœ‰ä¸€ä¸ªå…±äº«è¡¨ç©ºé—´ï¼ˆå¯¹åº”æ–‡ä»¶/var/lib/mysql/ibdata1ï¼‰ï¼Œä¹Ÿå«ç³»ç»Ÿè¡¨ç©ºé—´ã€‚ InnoDB ç³»ç»Ÿè¡¨ç©ºé—´åŒ…å« InnoDB æ•°æ®å­—å…¸å’ŒåŒå†™ç¼“å†²åŒºï¼Œï¼ˆChange Buffer å’Œ UndoLogsï¼‰ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š file-per-tableï¼Œä¹ŸåŒ…å«ç”¨æˆ·åˆ›å»ºçš„è¡¨å’Œç´¢å¼•æ•°æ®ã€‚ undo åœ¨åé¢ä»‹ç»ï¼Œå› ä¸ºæœ‰ç‹¬ç«‹çš„è¡¨ç©ºé—´ã€‚ æ•°æ®å­—å…¸ï¼šç”±å†…éƒ¨ç³»ç»Ÿè¡¨ç»„æˆï¼Œå­˜å‚¨è¡¨å’Œç´¢å¼•çš„å…ƒæ•°æ®ï¼ˆå®šä¹‰ä¿¡æ¯ï¼‰ã€‚ åŒå†™ç¼“å†²ï¼ˆInnoDB çš„ä¸€å¤§ç‰¹æ€§ï¼‰ InnoDB çš„é¡µå’Œæ“ä½œç³»ç»Ÿçš„é¡µå¤§å°ä¸ä¸€è‡´ï¼ŒInnoDB é¡µå¤§å°ä¸€èˆ¬ä¸º 16Kï¼Œæ“ä½œç³»ç»Ÿé¡µå¤§å°ä¸º 4Kï¼ŒInnoDB çš„é¡µå†™å…¥åˆ°ç£ç›˜æ—¶ï¼Œä¸€ä¸ªé¡µéœ€è¦åˆ† 4 æ¬¡å†™ã€‚ å¦‚æœå­˜å‚¨å¼•æ“æ­£åœ¨å†™å…¥é¡µçš„æ•°æ®åˆ°ç£ç›˜æ—¶å‘ç”Ÿäº†å®•æœºï¼Œå¯èƒ½å‡ºç°é¡µåªå†™äº†ä¸€éƒ¨åˆ†çš„æƒ…å†µï¼Œæ¯”å¦‚åªå†™äº† 4Kï¼Œå°±å®•æœºäº†ï¼Œè¿™ç§æƒ…å†µå«åšéƒ¨åˆ†å†™å¤±æ•ˆï¼ˆpartial page writeï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ 1show variables like &#x27;innodb_doublewrite&#x27;; å¦‚æœè¿™ä¸ªé¡µæœ¬èº«å·²ç»æŸåäº†ï¼Œç”¨å®ƒæ¥åšå´©æºƒæ¢å¤æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚æ‰€ä»¥åœ¨å¯¹äºåº”ç”¨ redo log ä¹‹å‰ï¼Œéœ€è¦ä¸€ä¸ªé¡µçš„å‰¯æœ¬ã€‚å¦‚æœå‡ºç°äº†å†™å…¥å¤±æ•ˆï¼Œå°±ç”¨é¡µçš„å‰¯æœ¬æ¥è¿˜åŸè¿™ä¸ªé¡µï¼Œç„¶åå†åº”ç”¨ redo logã€‚è¿™ä¸ªé¡µçš„å‰¯æœ¬å°±æ˜¯ double writeï¼ŒInnoDB çš„åŒå†™æŠ€æœ¯ã€‚é€šè¿‡å®ƒå®ç°äº†æ•°æ®é¡µçš„å¯é æ€§ã€‚ è·Ÿ redo log ä¸€æ ·ï¼Œdouble write ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯å†…å­˜çš„ double writeï¼Œä¸€ä¸ªéƒ¨åˆ†æ˜¯ç£ç›˜ä¸Šçš„ double writeã€‚å› ä¸º double write æ˜¯é¡ºåºå†™å…¥çš„ï¼Œä¸ä¼šå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ã€‚ åœ¨MySQL5.7ä¹‹å‰ï¼Œæ‰€æœ‰çš„è¡¨å…±äº«ä¸€ä¸ªç³»ç»Ÿè¡¨ç©ºé—´ï¼Œè¿™ä¸ªæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ï¼Œè€Œä¸”å®ƒçš„ç©ºé—´ä¸ä¼šæ”¶ç¼©ã€‚â€‹ 2.2 ç‹¬å è¡¨ç©ºé—´æˆ‘ä»¬å¯ä»¥è®©æ¯å¼ è¡¨ç‹¬å ä¸€ä¸ªè¡¨ç©ºé—´ã€‚è¿™ä¸ªå¼€å…³é€šè¿‡ innodb_file_per_table è®¾ç½®ï¼Œé»˜è®¤å¼€å¯ã€‚ 1SHOW VARIABLES LIKE &#x27;innodb_file_per_table&#x27;; å¼€å¯åï¼Œåˆ™æ¯å¼ è¡¨ä¼šå¼€è¾Ÿä¸€ä¸ªè¡¨ç©ºé—´ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯æ•°æ®ç›®å½•ä¸‹çš„ ibd æ–‡ä»¶ï¼Œå­˜æ”¾è¡¨çš„ç´¢å¼•å’Œæ•°æ®ã€‚ä½†æ˜¯å…¶ä»–ç±»çš„æ•°æ®ï¼Œå¦‚å›æ»šï¼ˆundoï¼‰ä¿¡æ¯ï¼Œæ’å…¥ç¼“å†²ç´¢å¼•é¡µã€ç³»ç»Ÿäº‹åŠ¡ä¿¡æ¯ï¼ŒäºŒæ¬¡å†™ç¼“å†²ï¼ˆDouble write bufferï¼‰ç­‰è¿˜æ˜¯å­˜æ”¾åœ¨åŸæ¥çš„å…±äº«è¡¨ç©ºé—´å†…ã€‚â€‹ 2.3 é€šç”¨è¡¨ç©ºé—´é€šç”¨è¡¨ç©ºé—´ä¹Ÿæ˜¯ä¸€ç§å…±äº«çš„è¡¨ç©ºé—´ï¼Œè·Ÿ ibdata1 ç±»ä¼¼ã€‚ å¯ä»¥åˆ›å»ºä¸€ä¸ªé€šç”¨çš„è¡¨ç©ºé—´ï¼Œç”¨æ¥å­˜å‚¨ä¸åŒæ•°æ®åº“çš„è¡¨ï¼Œæ•°æ®è·¯å¾„å’Œæ–‡ä»¶å¯ä»¥è‡ªå®šä¹‰ã€‚è¯­æ³•ï¼š 1create tablespace ts2673 add datafile &#x27;/var/lib/mysql/ts2673.ibd&#x27; file_block_size=16K engine=innodb; åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™å¯ä»¥æŒ‡å®šè¡¨ç©ºé—´ï¼Œç”¨ ALTER ä¿®æ”¹è¡¨ç©ºé—´å¯ä»¥è½¬ç§»è¡¨ç©ºé—´ã€‚ 1create table t2673(id integer) tablespace ts2673; ä¸åŒè¡¨ç©ºé—´çš„æ•°æ®æ˜¯å¯ä»¥ç§»åŠ¨çš„ã€‚åˆ é™¤è¡¨ç©ºé—´éœ€è¦å…ˆåˆ é™¤é‡Œé¢çš„æ‰€æœ‰è¡¨ï¼š 12drop table t2673;drop tablespace ts2673; 2.4 ä¸´æ—¶è¡¨ç©ºé—´å­˜å‚¨ä¸´æ—¶è¡¨çš„æ•°æ®ï¼ŒåŒ…æ‹¬ç”¨æˆ·åˆ›å»ºçš„ä¸´æ—¶è¡¨ï¼Œå’Œç£ç›˜çš„å†…éƒ¨ä¸´æ—¶è¡¨ã€‚å¯¹åº”æ•°æ®ç›®å½•ä¸‹çš„ ibtmp1 æ–‡ä»¶ã€‚å½“æ•°æ®æœåŠ¡å™¨æ­£å¸¸å…³é—­æ—¶ï¼Œè¯¥è¡¨ç©ºé—´è¢«åˆ é™¤ï¼Œä¸‹æ¬¡é‡æ–°äº§ç”Ÿã€‚ memoryå‘templateçš„è¿‡æ¸¡ï¼Œè¿˜æœ‰ç£ç›˜ä¸Šç®€å†ä¸´æ—¶è¡¨ç”¨çš„ä»€ä¹ˆå­˜å‚¨å¼•æ“ï¼Ÿ 8.0ä¹‹å‰ï¼Œå†…å­˜ä¸´æ—¶è¡¨ç”¨Memoryå¼•æ“åˆ›å»ºï¼Œä½†å‡å¦‚å­—æ®µä¸­æœ‰BLOBæˆ–TEXT,æˆ–ç»“æœå¤ªå¤§ï¼Œå°±ä¼šè½¬ç”¨MYISMåœ¨ç£ç›˜ä¸Šå»ºè¡¨ï¼Œ8.0ä¹‹åå†…å­˜ä¸´æ—¶è¡¨ç”±MEMORYå¼•æ“æ›´æ”¹ä¸ºTempTableå¼•æ“ï¼Œç›¸æ¯”äºå‰è€…ï¼Œåè€…æ”¯æŒä»¥å˜é•¿æ–¹å¼å­˜å‚¨VARCHARï¼ŒVARBINARYç­‰å˜é•¿å­—æ®µã€‚ä»MySQL 8.0.13å¼€å§‹ï¼ŒTempTableå¼•æ“æ”¯æŒBLOBå­—æ®µã€‚å¦‚æœè¶…è¿‡å†…å­˜è¡¨å¤§å°ï¼Œåˆ™ç”¨InnoDBå»ºè¡¨ã€‚ 2.5 redo log2.6 undo log è¡¨ç©ºé—´undo logï¼ˆæ’¤é”€æ—¥å¿—æˆ–å›æ»šæ—¥å¿—ï¼‰è®°å½•äº†äº‹åŠ¡å‘ç”Ÿä¹‹å‰çš„æ•°æ®çŠ¶æ€ï¼ˆä¸åŒ…æ‹¬ selectï¼‰ã€‚ å¦‚æœä¿®æ”¹æ•°æ®æ—¶å‡ºç°å¼‚å¸¸ï¼Œå¯ä»¥ç”¨ undo log æ¥å®ç°å›æ»šæ“ä½œï¼ˆä¿æŒåŸå­æ€§ï¼‰ã€‚ åœ¨æ‰§è¡Œ undo çš„æ—¶å€™ï¼Œä»…ä»…æ˜¯å°†æ•°æ®ä»é€»è¾‘ä¸Šæ¢å¤è‡³äº‹åŠ¡ä¹‹å‰çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä»ç‰©ç†é¡µé¢ä¸Šæ“ä½œå®ç°çš„ï¼Œå±äºé€»è¾‘æ ¼å¼çš„æ—¥å¿—(è®°å½•æ“ä½œ)ã€‚ redo Log å’Œ undo Log ä¸äº‹åŠ¡å¯†åˆ‡ç›¸å…³ï¼Œç»Ÿç§°ä¸ºäº‹åŠ¡æ—¥å¿—ã€‚ undo Log çš„æ•°æ®é»˜è®¤åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ ibdata1 æ–‡ä»¶ä¸­ï¼Œå› ä¸ºå…±äº«è¡¨ç©ºé—´ä¸ä¼šè‡ªåŠ¨æ”¶ç¼©ï¼Œä¹Ÿå¯ä»¥å•ç‹¬åˆ›å»ºä¸€ä¸ª undo è¡¨ç©ºé—´ã€‚ 1show global variables like &#x27;%undo%&#x27;; 2.7 ä¸€æ¡SQLçš„æ›´æ–°æµç¨‹12# id =1 çš„è®°å½•åŸ name = &#x27;yhd&#x27;update user set name = &#x27;äºŒå&#x27; where id=1; äº‹åŠ¡å¼€å§‹ï¼Œä»å†…å­˜æˆ–è€…ç£ç›˜å–åˆ°è¿™æ¡æ•°æ®ï¼Œè¿”å›ç»™serverçš„æ‰§è¡Œå™¨ æ‰§è¡Œå™¨ä¿®æ”¹è¿™ä¸€è¡Œæ•°æ®çš„å€¼ä¸ºäºŒå è®°å½•name =yhd åˆ°undo log è®°å½•name = äºŒå åˆ°redo log è°ƒç”¨å­˜å‚¨å¼•æ“æ¥å£ï¼Œåœ¨buffer pool ä¸­ä¿®æ”¹ name =äºŒå äº‹åŠ¡æäº¤ â€‹ å†…å­˜å’Œç£ç›˜ä¹‹é—´ï¼Œå·¥ä½œç€å¾ˆå¤šåå°çº¿ç¨‹ã€‚ 3.åå°çº¿ç¨‹åå°çº¿ç¨‹çš„ä¸»è¦ä½œç”¨æ˜¯è´Ÿè´£åˆ·æ–°å†…å­˜æ± ä¸­çš„æ•°æ®å’ŒæŠŠä¿®æ”¹çš„æ•°æ®é¡µåˆ·æ–°åˆ°ç£ç›˜ã€‚åå°çº¿ç¨‹åˆ†ä¸ºï¼šmasterçº¿ç¨‹ï¼ŒIO çº¿ç¨‹ï¼Œpurge çº¿ç¨‹ï¼Œpage cleaner çº¿ç¨‹ã€‚â€‹ 3.1 Master çº¿ç¨‹Master Threadæ˜¯InnoDBå­˜å‚¨å¼•æ“éå¸¸æ ¸å¿ƒçš„ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¸»è¦è´Ÿè´£å°†ç¼“å†²æ± ä¸­çš„æ•°æ®å¼‚æ­¥åˆ·æ–°åˆ°ç£ç›˜ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŒåŒ…æ‹¬è„é¡µçš„åˆ·æ–°ã€åˆå¹¶æ’å…¥ç¼“å†²ã€UNDOé¡µçš„å›æ”¶ç­‰ã€‚â€‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546void master_thread()&#123; loop: for(int i = 0; i &lt; 10; ++i)&#123; thread_sleep(1); // sleep 1ç§’ do log buffer flush to disk; if(last_one_second_ios &lt; 5) do merge at most 5 insert buffer; if(buf_get_modified_ratio_pct &gt; innodb_max_dirty_pages_pct) // å¦‚æœç¼“å†²æ± ä¸­çš„è„é¡µæ¯”ä¾‹å¤§äºinnodb_max_dirty_pages_pct(é»˜è®¤æ˜¯75æ—¶) do buffer pool flush 100 dirty page; // åˆ·æ–°100è„é¡µåˆ°ç£ç›˜ if(no user activity) goto backgroud loop; &#125; if(last_ten_second_ios &lt; 200) // å¦‚æœè¿‡å»10å†…ç£ç›˜IOæ¬¡æ•°å°äºè®¾ç½®çš„innodb_io_capacityçš„å€¼ï¼ˆé»˜è®¤æ˜¯200ï¼‰ do buffer pool flush 100 dirty page; do merge at most 5 insert buffer; // åˆå¹¶æ’å…¥ç¼“å†²æ˜¯innodb_io_capacityçš„5%ï¼ˆ10ï¼‰ï¼ˆæ€»æ˜¯ï¼‰ do log buffer flush to disk; do full purge; if(buf_get_modified_ratio_pct &gt; 70%) do buffer pool flush 100 dirty page; else buffer pool flush 10 dirty page; backgroud loopï¼š // åå°å¾ªç¯ do full purge // åˆ é™¤æ— ç”¨çš„undoé¡µ ï¼ˆæ€»æ˜¯ï¼‰ do merge 20 insert buffer; // åˆå¹¶æ’å…¥ç¼“å†²æ˜¯innodb_io_capacityçš„5%ï¼ˆ10ï¼‰ï¼ˆæ€»æ˜¯ï¼‰ if not idle // å¦‚æœä¸ç©ºé—²ï¼Œå°±è·³å›ä¸»å¾ªç¯ï¼Œå¦‚æœç©ºé—²å°±è·³å…¥flush loop goto loop: // è·³åˆ°ä¸»å¾ªç¯ else goto flush loop flush loop: // åˆ·æ–°å¾ªç¯ do buffer pool flush 100 dirty page; if(buf_get_modified_ratio_pct &gt; innodb_max_dirty_pages_pct) // å¦‚æœç¼“å†²æ± ä¸­çš„è„é¡µæ¯”ä¾‹å¤§äºinnodb_max_dirty_pages_pctçš„å€¼ï¼ˆé»˜è®¤75%ï¼‰ goto flush loop; // è·³åˆ°åˆ·æ–°å¾ªç¯ï¼Œä¸æ–­åˆ·æ–°è„é¡µï¼Œç›´åˆ°ç¬¦åˆæ¡ä»¶ goto suspend loop; // å®Œæˆåˆ·æ–°è„é¡µçš„ä»»åŠ¡åï¼Œè·³å…¥suspend loop suspend loop: suspend_thread(); //masterçº¿ç¨‹æŒ‚èµ·ï¼Œç­‰å¾…äº‹ä»¶å‘ç”Ÿ waiting event; goto loop;&#125; Master Threadå…·æœ‰æœ€é«˜çš„çº¿ç¨‹ä¼˜å…ˆçº§åˆ«ã€‚å†…éƒ¨ç”±å¤šä¸ªå¾ªç¯ç»„æˆï¼šä¸»å¾ªç¯ï¼ˆloopï¼‰ã€åå°å¾ªç¯ï¼ˆbackgroup loopï¼‰ã€åˆ·æ–°å¾ªç¯ï¼ˆflush loopï¼‰ã€æš‚åœå¾ªç¯ï¼ˆsuspend loopï¼‰ã€‚Master Threadä¼šæ ¹æ®æ•°æ®åº“è¿è¡Œçš„çŠ¶æ€åœ¨loopã€backgroup loopã€flush loopå’Œsuspend loopä¸­è¿›è¡Œåˆ‡æ¢ã€‚loopæ˜¯ä¸»å¾ªç¯ï¼Œå¤§å¤šæ•°çš„æ“ä½œéƒ½åœ¨è¿™ä¸ªå¾ªç¯ä¸­ï¼Œä¸»è¦æœ‰ä¸¤å¤§éƒ¨åˆ†çš„æ“ä½œâ€”â€”æ¯ç§’é’Ÿçš„æ“ä½œå’Œæ¯10ç§’é’Ÿçš„æ“ä½œã€‚â€‹ â‘ æ¯ç§’é’Ÿçš„æ“ä½œâ€‹ â€‹æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°ç£ç›˜ï¼Œå³ä½¿è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼ˆæ€»æ˜¯ï¼‰ï¼›å³ä½¿æŸä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä»ç„¶æ¯ç§’ä¼šå°†é‡åšæ—¥å¿—ç¼“å†²ä¸­çš„å†…å®¹åˆ·æ–°åˆ°é‡åšæ—¥å¿—æ–‡ä»¶ã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆå†å¤§çš„äº‹åŠ¡æäº¤çš„æ—¶é—´ä¹Ÿæ˜¯å¾ˆçŸ­çš„ã€‚ åˆå¹¶æ’å…¥ç¼“å†²ï¼ˆå¯èƒ½ï¼‰ï¼›åˆå¹¶æ’å…¥ç¼“å†²å¹¶ä¸æ˜¯æ¯ç§’éƒ½ä¼šå‘ç”Ÿçš„ã€‚InnoDBå­˜å‚¨å¼•æ“ä¼šåˆ¤æ–­å½“å‰ä¸€ç§’å†…å‘ç”Ÿçš„IOæ¬¡æ•°æ˜¯å¦å°äº5æ¬¡ï¼Œå¦‚æœå°äº5æ¬¡ï¼ŒInnoDBå­˜å‚¨å¼•æ“è®¤ä¸ºå½“å‰çš„IOå‹åŠ›å¾ˆå°ï¼Œå¯ä»¥æ‰§è¡Œåˆå¹¶æ’å…¥ç¼“å†²çš„æ“ä½œï¼› è‡³å¤šåˆ·æ–°100ä¸ªInnoDBçš„ç¼“å†²æ± ä¸­çš„è„é¡µåˆ°ç£ç›˜ï¼ˆå¯èƒ½ï¼‰ï¼› åˆ·æ–°100ä¸ªè„é¡µä¹Ÿä¸æ˜¯æ¯ç§’éƒ½ä¼šå‘ç”Ÿçš„ï¼ŒInnoDBå­˜å‚¨å¼•æ“é€šè¿‡åˆ¤æ–­å½“å‰ç¼“å†²æ± ä¸­è„é¡µçš„æ¯”ä¾‹(buf_get_modified_ratio_pct)æ˜¯å¦è¶…è¿‡äº†é…ç½®æ–‡ä»¶ä¸­ innodb_max_dirty_pages_pctè¿™ä¸ªå‚æ•°ï¼ˆé»˜è®¤æ˜¯75ï¼Œä»£è¡¨75%ï¼‰ï¼Œå¦‚æœè¶…è¿‡äº†è¿™ä¸ªå€¼ï¼ŒInnoDBå­˜å‚¨å¼•æ“åˆ™è®¤ä¸ºéœ€è¦åšç£ç›˜åŒæ­¥çš„æ“ä½œï¼Œå°†100ä¸ªè„é¡µå†™å…¥ç£ç›˜ä¸­ã€‚ å¦‚æœå½“å‰æ²¡æœ‰ç”¨æˆ·æ´»åŠ¨ï¼Œåˆ™åˆ‡æ¢åˆ°background loop(å¯èƒ½)ã€‚ â€‹ â‘¡æ¯åç§’çš„æ“ä½œ åˆ·æ–°100ä¸ªè„é¡µåˆ°ç£ç›˜ï¼ˆå¯èƒ½ï¼‰ InnoDBå­˜å‚¨å¼•æ“ä¼šå…ˆåˆ¤æ–­è¿‡å»10ç§’ä¹‹å†…ç£ç›˜çš„IOæ“ä½œæ˜¯å¦å°äº200æ¬¡ï¼Œå¦‚æœæ˜¯ï¼ŒInnoDBå­˜å‚¨å¼•æ“è®¤ä¸ºå½“å‰æœ‰è¶³å¤Ÿçš„ç£ç›˜IOèƒ½åŠ›ï¼Œå› æ­¤å°†100ä¸ªè„é¡µåˆ·æ–°åˆ°ç£ç›˜ã€‚ åˆå¹¶è‡³å¤š5ä¸ªæ’å…¥ç¼“å†²ï¼ˆæ€»æ˜¯ï¼‰ å°†æ—¥å¿—ç¼“å†²åˆ·æ–°åˆ°ç£ç›˜ï¼ˆæ€»æ˜¯ï¼‰ åˆ é™¤æ— ç”¨çš„Undoé¡µï¼ˆæ€»æ˜¯ï¼‰ åˆ·æ–°100ä¸ªæˆ–è€…10ä¸ªè„é¡µåˆ°ç£ç›˜ï¼ˆæ€»æ˜¯ï¼‰ InnoDBå­˜å‚¨å¼•æ“ä¼šæ‰§è¡Œfull purgeæ“ä½œï¼Œå³åˆ é™¤æ— ç”¨çš„Undoé¡µã€‚å¯¹è¡¨è¿›è¡Œupdateï¼Œdeleteè¿™ç±»çš„æ“ä½œæ—¶ï¼ŒåŸå…ˆçš„è¡Œè¢«æ ‡è®°ä¸ºåˆ é™¤ï¼Œä½†æ˜¯å› ä¸ºä¸€è‡´æ€§è¯»çš„å…³ç³»ï¼Œéœ€è¦ä¿ç•™è¿™äº›è¡Œç‰ˆæœ¬çš„ä¿¡æ¯ã€‚ä½†æ˜¯åœ¨full purgeè¿‡ç¨‹ä¸­ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šåˆ¤æ–­å½“å‰äº‹åŠ¡ç³»ç»Ÿä¸­å·²è¢«åˆ é™¤çš„è¡Œæ˜¯å¦å¯ä»¥åˆ é™¤ï¼Œæ¯”å¦‚æœ‰æ—¶å€™å¯èƒ½è¿˜æœ‰æŸ¥è¯¢æ“ä½œéœ€è¦è¯»å–ä¹‹å‰ç‰ˆæœ¬çš„undoä¿¡æ¯ï¼Œå¦‚æœå¯ä»¥åˆ é™¤ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šç«‹å³å°†å…¶åˆ é™¤ã€‚ä»æºä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼ŒInnoDBå­˜å‚¨å¼•æ“åœ¨æ‰§è¡Œfull purge æ“ä½œæ—¶ï¼Œæ¯æ¬¡æœ€å¤šå°è¯•å›æ”¶20ä¸ªundoé¡µã€‚ç„¶åï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šåˆ¤æ–­ç¼“å†²æ± ä¸­è„é¡µçš„æ¯”ä¾‹ï¼ˆbuf_get_modified_ratio_pctï¼‰,å¦‚æœæœ‰è¶…è¿‡70%çš„è„é¡µï¼Œåˆ™åˆ·æ–°100ä¸ªè„é¡µåˆ°ç£ç›˜ï¼Œå¦‚æœè„é¡µçš„æ¯”ä¾‹å°äº70%,åˆ™åªéœ€åˆ·æ–°10%çš„è„é¡µåˆ°ç£ç›˜ã€‚ â€‹ å¦‚æœå½“å‰æ²¡æœ‰ç”¨æˆ·æ´»åŠ¨ï¼ˆæ•°æ®åº“ç©ºé—²ï¼‰æˆ–è€…æ•°æ®åº“å…³ç³»ï¼Œå°±ä¼šåˆ‡æ¢åˆ°backgroud loopè¿™ä¸ªå¾ªç¯ã€‚ backgroud loopä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š åˆ é™¤æ— ç”¨çš„Undoé¡µï¼ˆæ€»æ˜¯ï¼‰ åˆå¹¶20ä¸ªæ’å…¥ç¼“å†²ï¼ˆæ€»æ˜¯ï¼‰ è·³å›åˆ°ä¸»å¾ªç¯ï¼ˆæ€»æ˜¯ï¼‰ ä¸æ–­åˆ·æ–°100ä¸ªé¡µç›´åˆ°ç¬¦åˆæ¡ä»¶ï¼ˆå¯èƒ½ï¼Œéœ€è¦è·³è½¬åˆ°flush loopä¸­å®Œæˆï¼‰ å¦‚æœflush loopä¸­ä¹Ÿæ²¡æœ‰ä»€ä¹ˆäº‹æƒ…å¯ä»¥åšäº†ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šåˆ‡æ¢åˆ°suspend_loopï¼Œå°†Master ThreadæŒ‚èµ·ï¼Œç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿã€‚è‹¥ç”¨æˆ·å¯ç”¨äº†InnoDBå­˜å‚¨å¼•æ“ï¼Œå´æ²¡æœ‰ä½¿ç”¨ä»»ä½•InnoDBå­˜å‚¨å¼•æ“çš„è¡¨ï¼Œé‚£ä¹ˆMaster Threadæ€»æ˜¯å¤„äºæŒ‚èµ·çš„çŠ¶æ€ã€‚â€‹ 1.0.xç‰ˆæœ¬ä¸­ï¼ŒInnoDBå­˜å‚¨å¼•æ“æœ€å¤šåªä¼šåˆ·æ–°100ä¸ªè„é¡µåˆ°ç£ç›˜ï¼Œåˆå¹¶20ä¸ªæ’å…¥ç¼“å†²ã€‚å¦‚æœæ˜¯åœ¨å†™å…¥å¯†é›†çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ¯ç§’å¯èƒ½ä¼šäº§ç”Ÿå¤§äº100ä¸ªçš„è„é¡µï¼Œå¦‚æœæ˜¯äº§ç”Ÿå¤§äº20ä¸ªæ’å…¥ç¼“å†²çš„æƒ…å†µï¼Œé‚£ä¹ˆå¯èƒ½ä¼šæ¥ä¸åŠåˆ·æ–°æ‰€æœ‰çš„è„é¡µä»¥åŠåˆå¹¶æ’å…¥ç¼“å†²ã€‚åæ¥ï¼ŒInnoDBå­˜å‚¨å¼•æ“æä¾›äº†å‚æ•°innodb_io_capacityï¼Œç”¨æ¥è¡¨ç¤ºç£ç›˜IOçš„ååé‡ï¼Œé»˜è®¤å€¼ä¸º200ã€‚â€‹ å¯¹äºåˆ·æ–°åˆ°ç£ç›˜çš„é¡µçš„æ•°é‡ï¼Œä¼šæŒ‰ç…§innodb_io_capacityçš„ç™¾åˆ†æ¯”æ¥è¿›è¡Œæ§åˆ¶ã€‚è§„åˆ™å¦‚ä¸‹ï¼š åœ¨åˆå¹¶æ’å…¥ç¼“å†²æ—¶ï¼Œåˆå¹¶æ’å…¥ç¼“å†²çš„æ•°é‡ä¸ºinnodb_io_capacityå€¼çš„5%; åœ¨ä»ç¼“å†²åŒºåˆ·æ–°è„é¡µæ—¶ï¼Œåˆ·æ–°è„é¡µçš„æ•°é‡ä¸ºinnodb_io_capacity; å¦‚æœç”¨æˆ·ä½¿ç”¨çš„æ˜¯SSDç±»çš„ç£ç›˜ï¼Œå¯ä»¥å°†innodb_io_capacityçš„å€¼è°ƒé«˜ï¼Œç›´åˆ°ç¬¦åˆç£ç›˜IOçš„ååé‡ä¸ºæ­¢ï¼› å¦ä¸€ä¸ªé—®é¢˜æ˜¯å‚æ•°innodb_max_dirty_pages_pctçš„é»˜è®¤å€¼ï¼Œåœ¨1.0.xç‰ˆæœ¬ä¹‹å‰ï¼Œè¯¥å€¼çš„é»˜è®¤å€¼æ˜¯90ï¼Œæ„å‘³ç€è„é¡µå ç¼“å†²æ± çš„90%ã€‚InnoDBå­˜å‚¨å¼•æ“åœ¨æ¯ç§’åˆ·æ–°ç¼“å†²æ± å’Œflush loopæ—¶ä¼šåˆ¤æ–­è¿™ä¸ªå€¼ï¼Œå¦‚æœè¯¥å€¼å¤§äºinnodb_max_dirty_pages_pct,æ‰ä¼šåˆ·æ–°100ä¸ªè„é¡µï¼Œå¦‚æœæœ‰å¾ˆå¤§çš„å†…å­˜ï¼Œæˆ–è€…æ•°æ®åº“æœåŠ¡å™¨çš„å‹åŠ›å¾ˆå¤§ï¼Œè¿™æ—¶åˆ·æ–°è„é¡µçš„é€Ÿåº¦åè€Œä¼šé™ä½ã€‚ åæ¥å°†innodb_max_dirty_pages_pctçš„é»˜è®¤å€¼æ”¹ä¸ºäº†75ã€‚è¿™æ ·æ—¢å¯ä»¥åŠ å¿«åˆ·æ–°è„é¡µçš„é¢‘ç‡ï¼Œåˆèƒ½å¤Ÿä¿è¯ç£ç›˜IOçš„è´Ÿè½½ã€‚â€‹ è¿˜æœ‰ä¸€ä¸ªæ–°çš„å‚æ•°æ˜¯innodb_adaptive_flushing(è‡ªé€‚åº”åœ°åˆ·æ–°)ï¼Œè¯¥å€¼å½±å“æ¯ç§’åˆ·æ–°è„é¡µçš„æ•°é‡ã€‚åŸæ¥çš„åˆ·æ–°è§„åˆ™æ˜¯ï¼šè„é¡µåœ¨ç¼“å†²æ± æ‰€å çš„æ¯”ä¾‹å°äºinnodb_max_dirty_pages_pctæ—¶ï¼Œä¸åˆ·æ–°è„é¡µï¼›å¤§äºinnodb_max_dirty_pages_pctæ—¶ï¼Œåˆ·æ–°100ä¸ªè„é¡µã€‚éšç€innodb_adaptive_flushingå‚æ•°çš„å¼•å…¥ï¼ŒInnoDBé€šè¿‡ä¸€ä¸ªåä¸ºbuf_flush_get_desired_flush_rateçš„å‡½æ•°æ¥åˆ¤æ–­éœ€è¦åˆ·æ–°è„é¡µæœ€åˆé€‚çš„æ•°é‡ã€‚buf_flush_get_desired_flush_rateå‡½æ•°é€šè¿‡åˆ¤æ–­äº§ç”Ÿé‡åšæ—¥å¿—çš„é€Ÿç‡æ¥å†³å®šæœ€åˆé€‚çš„åˆ·æ–°è„é¡µæ•°é‡ã€‚ ä¹‹å‰æ¯æ¬¡è¿›è¡Œfull purge æ“ä½œæ—¶ï¼Œæœ€å¤šå›æ”¶20ä¸ªUndoé¡µï¼Œä»InnoDB 1.0.xç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†å‚æ•°innodb_purge_batch_size,è¯¥å‚æ•°å¯ä»¥æ§åˆ¶æ¯æ¬¡full purgeå›æ”¶çš„Undoé¡µçš„æ•°é‡ã€‚è¯¥å‚æ•°çš„é»˜è®¤å€¼ä¸º20ï¼Œå¹¶å¯ä»¥åŠ¨æ€åœ°å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚â€‹ 1.2.xç‰ˆæœ¬ä¸­å†æ¬¡å¯¹Master Threadè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¯¹äºåˆ·æ–°è„é¡µçš„æ“ä½œï¼Œä»Master Threadçº¿ç¨‹åˆ†ç¦»åˆ°ä¸€ä¸ªå•ç‹¬çš„Page Cleaner Threadï¼Œä»è€Œå‡è½»äº†Master Threadçš„å·¥ä½œï¼ŒåŒæ—¶è¿›ä¸€æ­¥æé«˜äº†ç³»ç»Ÿçš„å¹¶å‘æ€§ã€‚â€‹ 3.2 IO çº¿ç¨‹InnoDBä¸­å¤§é‡ä½¿ç”¨AIO (Async IO) æ¥å¤„ç†IOè¯·æ±‚ã€‚IO Threadçš„ä½œç”¨ï¼Œæ˜¯è´Ÿè´£è¿™äº› IO è¯·æ±‚çš„å›è°ƒï¼ˆcall backï¼‰ã€‚â€‹ 3.3 Purge çº¿ç¨‹äº‹åŠ¡è¢«æäº¤åï¼Œå…¶æ‰€ä½¿ç”¨çš„undo logå¯èƒ½ä¸åœ¨éœ€è¦ã€‚å› æ­¤ï¼Œéœ€è¦purge threadæ¥å›æ”¶å·²ç»ä½¿ç”¨å¹¶åˆ†é…çš„undoé¡µã€‚ä»¥å‰Master Threadæ¥å®Œæˆé‡Šæ”¾undo logï¼ŒInnoDB1.1ç‹¬ç«‹å‡ºæ¥ï¼Œåˆ†æ‹…ä¸»çº¿ç¨‹å‹åŠ›ã€‚â€‹ 3.4 Page Cleaner çº¿ç¨‹â€‹ è´Ÿè´£å°†è„é¡µåˆ·æ–°åˆ°ç£ç›˜ã€‚ä»¥å‰Master Threadæ¥åˆ·æ–°è„é¡µï¼ŒInnoDB1.2ç‹¬ç«‹å‡ºæ¥ï¼Œåˆ†æ‹…ä¸»çº¿ç¨‹å‹åŠ›ã€‚â€‹ é™¤äº† InnoDB æ¶æ„ä¸­çš„æ—¥å¿—æ–‡ä»¶ï¼ŒMySQL çš„ Server å±‚ä¹Ÿæœ‰ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå«åšbinlogï¼Œå®ƒå¯ä»¥è¢«æ‰€æœ‰çš„å­˜å‚¨å¼•æ“ä½¿ç”¨ã€‚ 4.binlogbinlog ä»¥äº‹ä»¶çš„å½¢å¼è®°å½•äº†æ‰€æœ‰çš„DDL å’ŒDML è¯­å¥ï¼ˆå› ä¸ºå®ƒè®°å½•çš„æ˜¯æ“ä½œè€Œä¸æ˜¯æ•°æ®å€¼ï¼Œå±äºé€»è¾‘æ—¥å¿—ï¼‰ï¼Œå¯ä»¥ç”¨æ¥åšä¸»ä»å¤åˆ¶å’Œæ•°æ®æ¢å¤ã€‚è·Ÿredo logä¸ä¸€æ ·ï¼Œå®ƒçš„æ–‡ä»¶å†…å®¹æ˜¯å¯ä»¥è¿½åŠ çš„ï¼Œæ²¡æœ‰å›ºå®šå¤§å°é™åˆ¶ã€‚åœ¨å¼€å¯äº† binlog åŠŸèƒ½çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ binlog å¯¼å‡ºæˆ SQL è¯­å¥ï¼ŒæŠŠæ‰€æœ‰çš„æ“ä½œé‡æ”¾ä¸€éï¼Œæ¥å®ç°æ•°æ®çš„æ¢å¤ã€‚binlog çš„å¦ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯ç”¨æ¥å®ç°ä¸»ä»å¤åˆ¶ï¼Œå®ƒçš„åŸç†å°±æ˜¯ä»æœåŠ¡å™¨è¯»å–ä¸»æœåŠ¡å™¨çš„ binlogï¼Œç„¶åæ‰§è¡Œä¸€éã€‚â€‹ æœ‰äº†è¿™ä¸¤ä¸ªæ—¥å¿—ä¹‹åï¼Œæ¥çœ‹ä¸€ä¸‹ä¸€æ¡æ›´æ–°è¯­å¥æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼šâ€‹ 12# id =1 çš„è®°å½•åŸ name = &#x27;yhd&#x27;update user set name = &#x27;äºŒå&#x27; where id=1; â€‹ äº‹åŠ¡å¼€å§‹ï¼Œä»å†…å­˜æˆ–è€…ç£ç›˜å–åˆ°è¿™æ¡æ•°æ®æ‰€åœ¨çš„æ•°æ®é¡µï¼Œè¿”å›ç»™serverçš„æ‰§è¡Œå™¨ æ‰§è¡Œå™¨ä¿®æ”¹è¿™ä¸€è¡Œæ•°æ®çš„å€¼ä¸ºäºŒå è®°å½•name =yhd åˆ°undo log åœ¨buffer pool ä¸­ä¿®æ”¹ name =äºŒåï¼Œæ­¤æ—¶è¯¥é¡µå˜æˆè„é¡µ è®°å½•name = äºŒå åˆ°redo log bufferï¼Œredo log bufferæ¯ç§’åˆ·ç›˜ã€‚ redo log è¿›å…¥prepareçŠ¶æ€ï¼Œç„¶åå‘Šè¯‰æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œå®Œæˆäº†ï¼Œå¯ä»¥éšæ—¶æäº¤ å†™å…¥binlog äº‹åŠ¡æäº¤ï¼Œå¹¶å›å†™æœ€ç»ˆçŠ¶æ€åˆ°redo logé‡Œï¼Œä»£è¡¨è¯¥äº‹åŠ¡å·²ç»æäº¤ â€‹ äº‹åŠ¡å¼€å§‹ä¹‹åå°±äº§ç”Ÿredo logï¼Œredo logçš„è½ç›˜å¹¶ä¸æ˜¯éšç€äº‹åŠ¡çš„æäº¤æ‰å†™å…¥çš„ï¼Œè€Œæ˜¯åœ¨äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¾¿ä¸æ–­å†™å…¥redo logæ–‡ä»¶ä¸­ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯æ¬¡äº‹åŠ¡commitæ—¶ï¼Œå¿…é¡»è°ƒç”¨ fsync æ“ä½œï¼Œå°†redoæ—¥å¿—ç¼“å†²åŒæ­¥å†™åˆ°ç£ç›˜ã€‚å¦å¤–ï¼Œæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶åŒæ­¥å†™åˆ°ç£ç›˜bin logä¸­ã€‚ é‚£ä¹ˆå°±æœ‰äº†ä¸€ä¸ªè°å…ˆè°åçš„é—®é¢˜ï¼šredo log å…ˆï¼Œbin log åã€‚ ä¸¤é˜¶æ®µæäº¤çš„å†…å®¹ï¼š**äº‹åŠ¡æäº¤æ—¶ï¼Œredo logå¤„äº preçŠ¶æ€ -&gt; å†™å…¥bin log -&gt; äº‹åŠ¡çœŸæ­£æäº¤ã€‚ ** å½“å‘ç”Ÿå´©æºƒæ¢å¤æ—¶ï¼ŒæŸ¥çœ‹çš„æ˜¯bin logæ˜¯å¦å®Œæ•´ï¼Œå¦‚æœbin logå®Œæ•´ï¼Œåˆ™ä»£è¡¨äº‹åŠ¡å·²ç»æäº¤ã€‚ å¦‚æœåœ¨ä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹ä¸­ï¼Œbin logå†™å…¥å¤±è´¥ï¼Œåˆ™äº‹åŠ¡æ— æ³•ç»ˆæ­¢æäº¤ï¼Œå´©æºƒæ¢å¤æ—¶å°±ä¸éœ€è¦é‡åšã€‚å¦‚æœbin logå†™å®Œçš„ä¸€ç¬é—´ï¼ŒæœåŠ¡å™¨å®•æœºäº†ï¼Œäº‹åŠ¡éƒ½æ¥ä¸åŠæäº¤ï¼Œæ­¤æ—¶bin logå¹¶ä¸æ˜¯å®Œæ•´çš„ï¼Œç¼ºå°‘äº†æœ€ç»ˆçš„commitæ ‡è®°ã€‚å› æ­¤ä¹Ÿæ˜¯æäº¤å¤±è´¥ã€‚ ç®€å•è¯´ï¼Œredo logå’Œbin logéƒ½å¯ä»¥ç”¨äºè¡¨ç¤ºäº‹åŠ¡çš„æäº¤çŠ¶æ€ï¼Œè€Œä¸¤é˜¶æ®µæäº¤å°±æ˜¯è®©è¿™ä¸¤ä¸ªçŠ¶æ€ä¿æŒé€»è¾‘ä¸Šçš„ä¸€è‡´ã€‚ ä¸‰ï¼ŒMySQLä¸­æ”¯æŒçš„å­—ç¬¦é›†å’Œæ’åºè§„åˆ™1.MySQLä¸­çš„utf8å’Œutf8mb4utf8å­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦éœ€è¦ä½¿ç”¨1ï½4ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€äº›å­—ç¬¦ä½¿ç”¨1ï½3ä¸ªå­—èŠ‚å°±å¯ä»¥è¡¨ç¤ºäº†ã€‚è€Œåœ¨MySQLä¸­å­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æ‰€ç”¨æœ€å¤§å­—èŠ‚é•¿åº¦åœ¨æŸäº›æ–¹é¢ä¼šå½±å“ç³»ç»Ÿçš„å­˜å‚¨å’Œæ€§èƒ½ï¼Œæ‰€ä»¥è®¾è®¡MySQLçš„å¤§å”å·å·çš„å®šä¹‰äº†ä¸¤ä¸ªæ¦‚å¿µï¼š utf8mb3ï¼šé˜‰å‰²è¿‡çš„utf8å­—ç¬¦é›†ï¼Œåªä½¿ç”¨1ï½3ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ã€‚ utf8mb4ï¼šæ­£å®—çš„utf8å­—ç¬¦é›†ï¼Œä½¿ç”¨1ï½4ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ã€‚ åœ¨MySQLä¸­utf8æ˜¯utf8mb3çš„åˆ«åï¼Œæ‰€ä»¥ä¹‹ååœ¨MySQLä¸­æåˆ°utf8å°±æ„å‘³ç€ä½¿ç”¨1~3ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœæœ‰ä½¿ç”¨4å­—èŠ‚ç¼–ç ä¸€ä¸ªå­—ç¬¦çš„æƒ…å†µï¼Œæ¯”å¦‚å­˜å‚¨ä¸€äº›emojiè¡¨æƒ…å•¥çš„ï¼Œé‚£è¯·ä½¿ç”¨utf8mb4ã€‚ æŸ¥çœ‹å­—ç¬¦é›†ï¼šSHOW (CHARACTER SET|CHARSET)ã€‚ 2.å­—ç¬¦é›†&amp;æ¯”è¾ƒè§„åˆ™çš„åº”ç”¨2.1 å„çº§åˆ«çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™MySQLæœ‰4ä¸ªçº§åˆ«çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œåˆ†åˆ«æ˜¯ï¼š æœåŠ¡å™¨çº§åˆ« æ•°æ®åº“çº§åˆ« è¡¨çº§åˆ« åˆ—çº§åˆ« æ¥ä¸‹æ¥ä»”ç»†çœ‹ä¸€ä¸‹æ€ä¹ˆè®¾ç½®å’ŒæŸ¥çœ‹è¿™å‡ ä¸ªçº§åˆ«çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ã€‚ æœåŠ¡å™¨çº§åˆ«123456789101112131415mysql&gt; SHOW VARIABLES LIKE &#x27;character_set_server&#x27;;+----------------------+-------+| Variable_name | Value |+----------------------+-------+| character_set_server | utf8 |+----------------------+-------+1 row in set (0.00 sec)mysql&gt; SHOW VARIABLES LIKE &#x27;collation_server&#x27;;+------------------+-----------------+| Variable_name | Value |+------------------+-----------------+| collation_server | utf8_general_ci |+------------------+-----------------+1 row in set (0.00 sec) å¯ä»¥åœ¨å¯åŠ¨æœåŠ¡å™¨ç¨‹åºæ—¶é€šè¿‡å¯åŠ¨é€‰é¡¹æˆ–è€…åœ¨æœåŠ¡å™¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨SETè¯­å¥ä¿®æ”¹è¿™ä¸¤ä¸ªå˜é‡çš„å€¼ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è¿™æ ·å†™ï¼š 123[server]character_set_server=gbkcollation_server=gbk_chinese_ci å½“æœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™è¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶åè¿™ä¸¤ä¸ªç³»ç»Ÿå˜é‡çš„å€¼ä¾¿ä¿®æ”¹äº†ã€‚ æ•°æ®åº“çº§åˆ«æˆ‘ä»¬åœ¨åˆ›å»ºå’Œä¿®æ”¹æ•°æ®åº“çš„æ—¶å€™å¯ä»¥æŒ‡å®šè¯¥æ•°æ®åº“çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œå…·ä½“è¯­æ³•å¦‚ä¸‹ï¼š 1234567CREATE DATABASE æ•°æ®åº“å [[DEFAULT] CHARACTER SET å­—ç¬¦é›†åç§°] [[DEFAULT] COLLATE æ¯”è¾ƒè§„åˆ™åç§°];ALTER DATABASE æ•°æ®åº“å [[DEFAULT] CHARACTER SET å­—ç¬¦é›†åç§°] [[DEFAULT] COLLATE æ¯”è¾ƒè§„åˆ™åç§°]; å…¶ä¸­çš„DEFAULTå¯ä»¥çœç•¥ï¼Œå¹¶ä¸å½±å“è¯­å¥çš„è¯­ä¹‰ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æ–°åˆ›å»ºä¸€ä¸ªåå«charset_demo_dbçš„æ•°æ®åº“ï¼Œåœ¨åˆ›å»ºçš„æ—¶å€™æŒ‡å®šå®ƒä½¿ç”¨çš„å­—ç¬¦é›†ä¸ºgb2312ï¼Œæ¯”è¾ƒè§„åˆ™ä¸ºgb2312_chinese_ciï¼š 1234mysql&gt; CREATE DATABASE charset_demo_db -&gt; CHARACTER SET gb2312 -&gt; COLLATE gb2312_chinese_ci;Query OK, 1 row affected (0.01 sec) æŸ¥çœ‹ 1234567891011121314151617181920mysql&gt; USE charset_demo_db;Database changedmysql&gt; SHOW VARIABLES LIKE &#x27;character_set_database&#x27;;+------------------------+--------+| Variable_name | Value |+------------------------+--------+| character_set_database | gb2312 |+------------------------+--------+1 row in set (0.00 sec)mysql&gt; SHOW VARIABLES LIKE &#x27;collation_database&#x27;;+--------------------+-------------------+| Variable_name | Value |+--------------------+-------------------+| collation_database | gb2312_chinese_ci |+--------------------+-------------------+1 row in set (0.00 sec)mysql&gt; å¯ä»¥çœ‹åˆ°è¿™ä¸ªcharset_demo_dbæ•°æ®åº“çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™å°±æ˜¯æˆ‘ä»¬åœ¨åˆ›å»ºè¯­å¥ä¸­æŒ‡å®šçš„ã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼š character_set_database å’Œ _collation_database_ è¿™ä¸¤ä¸ªç³»ç»Ÿå˜é‡æ˜¯åªè¯»çš„ï¼Œæˆ‘ä»¬ä¸èƒ½é€šè¿‡ä¿®æ”¹è¿™ä¸¤ä¸ªå˜é‡çš„å€¼è€Œæ”¹å˜å½“å‰æ•°æ®åº“çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ã€‚ è¡¨çº§åˆ«æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºå’Œä¿®æ”¹è¡¨çš„æ—¶å€™æŒ‡å®šè¡¨çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š 1234567CREATE TABLE è¡¨å (åˆ—çš„ä¿¡æ¯) [[DEFAULT] CHARACTER SET å­—ç¬¦é›†åç§°] [COLLATE æ¯”è¾ƒè§„åˆ™åç§°]]ALTER TABLE è¡¨å [[DEFAULT] CHARACTER SET å­—ç¬¦é›†åç§°] [COLLATE æ¯”è¾ƒè§„åˆ™åç§°] æ¯”æ–¹è¯´æˆ‘ä»¬åœ¨åˆšåˆšåˆ›å»ºçš„charset_demo_dbæ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºtçš„è¡¨ï¼Œå¹¶æŒ‡å®šè¿™ä¸ªè¡¨çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼š 1234mysql&gt; CREATE TABLE t( -&gt; col VARCHAR(10) -&gt; ) CHARACTER SET utf8 COLLATE utf8_general_ci;Query OK, 0 rows affected (0.03 sec) å¦‚æœåˆ›å»ºå’Œä¿®æ”¹è¡¨çš„è¯­å¥ä¸­æ²¡æœ‰æŒ‡æ˜å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œå°†ä½¿ç”¨è¯¥è¡¨æ‰€åœ¨æ•°æ®åº“çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ä½œä¸ºè¯¥è¡¨çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ã€‚ åˆ—çº§åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºå­˜å‚¨å­—ç¬¦ä¸²çš„åˆ—ï¼ŒåŒä¸€ä¸ªè¡¨ä¸­çš„ä¸åŒçš„åˆ—ä¹Ÿå¯ä»¥æœ‰ä¸åŒçš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ã€‚æˆ‘ä»¬åœ¨åˆ›å»ºå’Œä¿®æ”¹åˆ—å®šä¹‰çš„æ—¶å€™å¯ä»¥æŒ‡å®šè¯¥åˆ—çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š 123456CREATE TABLE è¡¨å( åˆ—å å­—ç¬¦ä¸²ç±»å‹ [CHARACTER SET å­—ç¬¦é›†åç§°] [COLLATE æ¯”è¾ƒè§„åˆ™åç§°], å…¶ä»–åˆ—...);ALTER TABLE è¡¨å MODIFY åˆ—å å­—ç¬¦ä¸²ç±»å‹ [CHARACTER SET å­—ç¬¦é›†åç§°] [COLLATE æ¯”è¾ƒè§„åˆ™åç§°]; æ¯”å¦‚æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹è¡¨tä¸­åˆ—colçš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™å¯ä»¥è¿™ä¹ˆå†™ï¼š 12345mysql&gt; ALTER TABLE t MODIFY col VARCHAR(10) CHARACTER SET gbk COLLATE gbk_chinese_ci;Query OK, 0 rows affected (0.04 sec)Records: 0 Duplicates: 0 Warnings: 0mysql&gt; å¯¹äºæŸä¸ªåˆ—æ¥è¯´ï¼Œå¦‚æœåœ¨åˆ›å»ºå’Œä¿®æ”¹çš„è¯­å¥ä¸­æ²¡æœ‰æŒ‡æ˜å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ï¼Œå°†ä½¿ç”¨è¯¥åˆ—æ‰€åœ¨è¡¨çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ä½œä¸ºè¯¥åˆ—çš„å­—ç¬¦é›†å’Œæ¯”è¾ƒè§„åˆ™ã€‚ åœ¨è½¬æ¢åˆ—çš„å­—ç¬¦é›†æ—¶éœ€è¦æ³¨æ„ï¼Œå¦‚æœè½¬æ¢å‰åˆ—ä¸­å­˜å‚¨çš„æ•°æ®ä¸èƒ½ç”¨è½¬æ¢åçš„å­—ç¬¦é›†è¿›è¡Œè¡¨ç¤ºä¼šå‘ç”Ÿé”™è¯¯ã€‚æ¯”æ–¹è¯´åŸå…ˆåˆ—ä½¿ç”¨çš„å­—ç¬¦é›†æ˜¯utf8ï¼Œåˆ—ä¸­å­˜å‚¨äº†ä¸€äº›æ±‰å­—ï¼Œç°åœ¨æŠŠåˆ—çš„å­—ç¬¦é›†è½¬æ¢ä¸ºasciiçš„è¯å°±ä¼šå‡ºé”™ï¼Œå› ä¸ºasciiå­—ç¬¦é›†å¹¶ä¸èƒ½è¡¨ç¤ºæ±‰å­—å­—ç¬¦ã€‚ 2.2 å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šä¿¡ä¸­çš„å­—ç¬¦é›†ç¼–ç å’Œè§£ç ä½¿ç”¨çš„å­—ç¬¦é›†ä¸ä¸€è‡´çš„åæœå¦‚æœå¯¹äºåŒä¸€ä¸ªå­—ç¬¦ä¸²ç¼–ç å’Œè§£ç ä½¿ç”¨çš„å­—ç¬¦é›†ä¸ä¸€æ ·ï¼Œä¼šäº§ç”Ÿæ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œä½œä¸ºäººç±»çš„æˆ‘ä»¬çœ‹ä¸Šå»å°±åƒæ˜¯äº§ç”Ÿäº†ä¹±ç ä¸€æ ·ã€‚ ä»å‘é€è¯·æ±‚åˆ°æ¥æ”¶ç»“æœè¿‡ç¨‹ä¸­å‘ç”Ÿçš„å­—ç¬¦é›†è½¬æ¢ å®¢æˆ·ç«¯ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å­—ç¬¦é›†ç¼–ç è¯·æ±‚å­—ç¬¦ä¸²ï¼Œå‘æœåŠ¡å™¨å‘é€çš„æ˜¯ç»è¿‡ç¼–ç çš„ä¸€ä¸ªå­—èŠ‚ä¸²ã€‚ æœåŠ¡å™¨å°†å®¢æˆ·ç«¯å‘é€æ¥çš„å­—èŠ‚ä¸²é‡‡ç”¨character_set_clientä»£è¡¨çš„å­—ç¬¦é›†è¿›è¡Œè§£ç ï¼Œå°†è§£ç åçš„å­—ç¬¦ä¸²å†æŒ‰ç…§character_set_connectionä»£è¡¨çš„å­—ç¬¦é›†è¿›è¡Œç¼–ç ã€‚ å¦‚æœcharacter_set_connectionä»£è¡¨çš„å­—ç¬¦é›†å’Œå…·ä½“æ“ä½œçš„åˆ—ä½¿ç”¨çš„å­—ç¬¦é›†ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿›è¡Œç›¸åº”æ“ä½œï¼Œå¦åˆ™çš„è¯éœ€è¦å°†è¯·æ±‚ä¸­çš„å­—ç¬¦ä¸²ä»character_set_connectionä»£è¡¨çš„å­—ç¬¦é›†è½¬æ¢ä¸ºå…·ä½“æ“ä½œçš„åˆ—ä½¿ç”¨çš„å­—ç¬¦é›†ä¹‹åå†è¿›è¡Œæ“ä½œã€‚ å°†ä»æŸä¸ªåˆ—è·å–åˆ°çš„å­—èŠ‚ä¸²ä»è¯¥åˆ—ä½¿ç”¨çš„å­—ç¬¦é›†è½¬æ¢ä¸ºcharacter_set_resultsä»£è¡¨çš„å­—ç¬¦é›†åå‘é€åˆ°å®¢æˆ·ç«¯ã€‚ å®¢æˆ·ç«¯ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å­—ç¬¦é›†è§£ææ”¶åˆ°çš„ç»“æœé›†å­—èŠ‚ä¸²ã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å„ä¸ªç³»ç»Ÿå˜é‡çš„å«ä¹‰å¦‚ä¸‹ï¼š ç³»ç»Ÿå˜é‡ æè¿° character_set_client æœåŠ¡å™¨è§£ç è¯·æ±‚æ—¶ä½¿ç”¨çš„å­—ç¬¦é›† character_set_connection æœåŠ¡å™¨å¤„ç†è¯·æ±‚æ—¶ä¼šæŠŠè¯·æ±‚å­—ç¬¦ä¸²ä»character_set_clientè½¬ä¸ºcharacter_set_connection character_set_results æœåŠ¡å™¨å‘å®¢æˆ·ç«¯è¿”å›æ•°æ®æ—¶ä½¿ç”¨çš„å­—ç¬¦é›† ä¸€èˆ¬æƒ…å†µä¸‹è¦ä½¿ç”¨ä¿æŒè¿™ä¸‰ä¸ªå˜é‡çš„å€¼å’Œå®¢æˆ·ç«¯ä½¿ç”¨çš„å­—ç¬¦é›†ç›¸åŒã€‚ æ¯”è¾ƒè§„åˆ™çš„ä½œç”¨é€šå¸¸ä½“ç°æ¯”è¾ƒå­—ç¬¦ä¸²å¤§å°çš„è¡¨è¾¾å¼ä»¥åŠå¯¹æŸä¸ªå­—ç¬¦ä¸²åˆ—è¿›è¡Œæ’åºä¸­ã€‚â€‹","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"}]},{"title":"ConcurrentHashMapæºç è§£è¯»","slug":"1.åŸºç¡€çŸ¥è¯†/ConcurrentHashMap","date":"2022-01-05T12:23:06.000Z","updated":"2022-01-05T12:23:06.000Z","comments":true,"path":"2022/01/05/1.åŸºç¡€çŸ¥è¯†/ConcurrentHashMap/","link":"","permalink":"https://yinhuidong.github.io/2022/01/05/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ConcurrentHashMap/","excerpt":"","text":"#1.æˆå‘˜å˜é‡ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147//æ•£åˆ—è¡¨æ•°ç»„çš„æœ€å¤§é™åˆ¶private static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;//æ•£åˆ—è¡¨é»˜è®¤å€¼private static final int DEFAULT_CAPACITY = 16;static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;//å¹¶å‘çº§åˆ«ï¼šjdk7å†å²é—ç•™é—®é¢˜ï¼Œä»…ä»…åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨åˆ°ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„ä»£è¡¨å¹¶å‘çº§åˆ«private static final int DEFAULT_CONCURRENCY_LEVEL = 16;//è´Ÿè½½å› å­ï¼ŒJDK1.8ä¸­ ConcurrentHashMap æ˜¯å›ºå®šå€¼private static final float LOAD_FACTOR = 0.75f;//æ ‘åŒ–é˜ˆå€¼ï¼ŒæŒ‡å®šæ¡¶ä½ é“¾è¡¨é•¿åº¦è¾¾åˆ°8çš„è¯ï¼Œæœ‰å¯èƒ½å‘ç”Ÿæ ‘åŒ–æ“ä½œã€‚static final int TREEIFY_THRESHOLD = 8;//çº¢é»‘æ ‘è½¬åŒ–ä¸ºé“¾è¡¨çš„é˜ˆå€¼static final int UNTREEIFY_THRESHOLD = 6;//è”åˆTREEIFY_THRESHOLDæ§åˆ¶æ¡¶ä½æ˜¯å¦æ ‘åŒ–ï¼Œåªæœ‰å½“tableæ•°ç»„é•¿åº¦è¾¾åˆ°64ä¸” æŸä¸ªæ¡¶ä½ ä¸­çš„é“¾è¡¨é•¿åº¦è¾¾åˆ°8ï¼Œæ‰ä¼šçœŸæ­£æ ‘åŒ–static final int MIN_TREEIFY_CAPACITY = 64;//çº¿ç¨‹è¿ç§»æ•°æ®æœ€å°æ­¥é•¿ï¼Œæ§åˆ¶çº¿ç¨‹è¿ç§»ä»»åŠ¡æœ€å°åŒºé—´ä¸€ä¸ªå€¼private static final int MIN_TRANSFER_STRIDE = 16;//è®¡ç®—æ‰©å®¹æ—¶å€™ç”Ÿæˆçš„ä¸€ä¸ª æ ‡è¯†æˆ³private static int RESIZE_STAMP_BITS = 16;//ç»“æœæ˜¯65535 è¡¨ç¤ºå¹¶å‘æ‰©å®¹æœ€å¤šçº¿ç¨‹æ•°private static final int MAX_RESIZERS = (1 &lt;&lt; (32 - RESIZE_STAMP_BITS)) - 1;//æ‰©å®¹ç›¸å…³private static final int RESIZE_STAMP_SHIFT = 32 - RESIZE_STAMP_BITS;//å½“nodeèŠ‚ç‚¹hash=-1 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»è¢«è¿ç§»äº† ï¼ŒfwdèŠ‚ç‚¹static final int MOVED = -1; // hash for forwarding nodes//node hash=-2 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»æ ‘åŒ– ä¸” å½“å‰èŠ‚ç‚¹ä¸ºtreebinå¯¹è±¡ ï¼Œä»£ç†æ“ä½œçº¢é»‘æ ‘static final int TREEBIN = -2; // hash for roots of treesstatic final int RESERVED = -3; // hash for transient reservations//è½¬åŒ–æˆäºŒè¿›åˆ¶å®é™…ä¸Šæ˜¯ 31ä¸ª 1 å¯ä»¥å°†ä¸€ä¸ªè´Ÿæ•°é€šè¿‡ä½ç§»è¿ç®—å¾—åˆ°ä¸€ä¸ªæ­£æ•°static final int HASH_BITS = 0x7fffffff; // usable bits of normal node hash//å½“å‰ç³»ç»Ÿçš„cpuæ•°é‡static final int NCPU = Runtime.getRuntime().availableProcessors();//ä¸ºäº†å…¼å®¹7ç‰ˆæœ¬çš„chpä¿å­˜çš„ï¼Œæ ¸å¿ƒä»£ç å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°private static final ObjectStreamField[] serialPersistentFields = &#123; new ObjectStreamField(&quot;segments&quot;, Segment[].class), new ObjectStreamField(&quot;segmentMask&quot;, Integer.TYPE), new ObjectStreamField(&quot;segmentShift&quot;, Integer.TYPE) &#125;;//æ•£åˆ—è¡¨ï¼Œé•¿åº¦ä¸€å®šæ˜¯2æ¬¡æ–¹æ•°transient volatile Node&lt;K,V&gt;[] table;//æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œä¼šå°†æ‰©å®¹ä¸­çš„æ–°table èµ‹å€¼ç»™nextTable ä¿æŒå¼•ç”¨ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œè¿™é‡Œä¼šè¢«è®¾ç½®ä¸ºNullprivate transient volatile Node&lt;K,V&gt;[] nextTable;//LongAdder ä¸­çš„ baseCount æœªå‘ç”Ÿç«äº‰æ—¶ æˆ–è€… å½“å‰LongAdderå¤„äºåŠ é”çŠ¶æ€æ—¶ï¼Œå¢é‡ç´¯åˆ°åˆ°baseCountä¸­private transient volatile long baseCount;/** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private transient volatile int sizeCtl;/** * * æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œè®°å½•å½“å‰è¿›åº¦ã€‚æ‰€æœ‰çº¿ç¨‹éƒ½éœ€è¦ä»transferIndexä¸­åˆ†é…åŒºé—´ä»»åŠ¡ï¼Œå»æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ã€‚ */private transient volatile int transferIndex;/** * LongAdderä¸­çš„cellsBuzy 0è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡æ— é”çŠ¶æ€ï¼Œ1è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡åŠ é”çŠ¶æ€ */private transient volatile int cellsBusy;/** * LongAdderä¸­çš„cellsæ•°ç»„ï¼Œå½“baseCountå‘ç”Ÿç«äº‰åï¼Œä¼šåˆ›å»ºcellsæ•°ç»„ï¼Œ * çº¿ç¨‹ä¼šé€šè¿‡è®¡ç®—hashå€¼ å–åˆ° è‡ªå·±çš„cell ï¼Œå°†å¢é‡ç´¯åŠ åˆ°æŒ‡å®šcellä¸­ * æ€»æ•° = sum(cells) + baseCount */private transient volatile CounterCell[] counterCells;// Unsafe mechanicsprivate static final sun.misc.Unsafe U;/**è¡¨ç¤ºsizeCtlå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long SIZECTL;/**è¡¨ç¤ºtransferIndexå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long TRANSFERINDEX;/**è¡¨ç¤ºbaseCountå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long BASECOUNT;/**è¡¨ç¤ºcellsBusyå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLSBUSY;/**è¡¨ç¤ºcellValueå±æ€§åœ¨CounterCellä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLVALUE;/**è¡¨ç¤ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€*/private static final long ABASE;private static final int ASHIFT;static &#123; try &#123; U = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = ConcurrentHashMap.class; SIZECTL = U.objectFieldOffset (k.getDeclaredField(&quot;sizeCtl&quot;)); TRANSFERINDEX = U.objectFieldOffset (k.getDeclaredField(&quot;transferIndex&quot;)); BASECOUNT = U.objectFieldOffset (k.getDeclaredField(&quot;baseCount&quot;)); CELLSBUSY = U.objectFieldOffset (k.getDeclaredField(&quot;cellsBusy&quot;)); Class&lt;?&gt; ck = CounterCell.class; CELLVALUE = U.objectFieldOffset (ck.getDeclaredField(&quot;value&quot;)); Class&lt;?&gt; ak = Node[].class; ABASE = U.arrayBaseOffset(ak); //è¡¨ç¤ºæ•°ç»„å•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°,scale è¡¨ç¤ºNode[]æ•°ç»„ä¸­æ¯ä¸€ä¸ªå•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å° int scale = U.arrayIndexScale(ak); //1 0000 &amp; 0 1111 = 0 if ((scale &amp; (scale - 1)) != 0) throw new Error(&quot;data type scale not a power of two&quot;); //numberOfLeadingZeros() è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›å½“å‰æ•°å€¼è½¬æ¢ä¸ºäºŒè¿›åˆ¶åï¼Œä»é«˜ä½åˆ°ä½ä½å¼€å§‹ç»Ÿè®¡ï¼Œçœ‹æœ‰å¤šå°‘ä¸ª0è¿ç»­åœ¨ä¸€å—ã€‚ //8 =&gt; 1000 numberOfLeadingZeros(8) = 28 //4 =&gt; 100 numberOfLeadingZeros(4) = 29 //ASHIFT = 31 - 29 = 2 ï¼Ÿï¼Ÿ //ABASE + ï¼ˆ5 &lt;&lt; ASHIFTï¼‰ ASHIFT = 31 - Integer.numberOfLeadingZeros(scale); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125; #2.åŸºç¡€æ–¹æ³•##2.1 spreadé«˜ä½è¿ç®— 123static final int spread(int h) &#123; return (h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS;&#125; ##2.2 tabAtè¯¥æ–¹æ³•è·å–å¯¹è±¡ä¸­offsetåç§»åœ°å€å¯¹åº”çš„å¯¹è±¡fieldçš„å€¼ã€‚å®é™…ä¸Šè¿™æ®µä»£ç çš„å«ä¹‰ç­‰ä»·äºtab[i],ä½†æ˜¯ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ tab[i]æ¥è®¡ç®—å‘¢ï¼Ÿ getObjectVolatileï¼Œä¸€æ—¦çœ‹åˆ° volatile å…³é”®å­—ï¼Œå°±è¡¨ç¤ºå¯è§æ€§ã€‚å› ä¸ºå¯¹ volatile å†™æ“ä½œ happen-before äº volatile è¯»æ“ä½œï¼Œå› æ­¤å…¶ä»–çº¿ç¨‹å¯¹ table çš„ä¿®æ”¹å‡å¯¹ get è¯»å–å¯è§ï¼› è™½ç„¶ table æ•°ç»„æœ¬èº«æ˜¯å¢åŠ äº† volatile å±æ€§ï¼Œä½†æ˜¯â€œvolatile çš„æ•°ç»„åªé’ˆå¯¹æ•°ç»„çš„å¼•ç”¨å…·æœ‰volatile çš„è¯­ä¹‰ï¼Œè€Œä¸æ˜¯å®ƒçš„å…ƒç´ â€ã€‚ æ‰€ä»¥å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å¯¹è¿™ä¸ªæ•°ç»„çš„å…ƒç´ è¿›è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æ¥è¯»çš„æ—¶å€™ä¸ä¸€å®šèƒ½è¯»åˆ°æœ€æ–°çš„å€¼ã€‚å‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒDoug Lea ç›´æ¥é€šè¿‡ Unsafe ç±»æ¥å¯¹ table è¿›è¡Œæ“ä½œã€‚ 123static final &lt;K,V&gt; Node&lt;K,V&gt; tabAt(Node&lt;K,V&gt;[] tab, int i) &#123; return (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE);&#125; ##2.3 casTabAtcasè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºæ¡¶ä½çš„å¤´èŠ‚ç‚¹ 1234static final &lt;K,V&gt; boolean casTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v) &#123; return U.compareAndSwapObject(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, c, v);&#125; ##2.4 setTabAt 123static final &lt;K,V&gt; void setTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; v) &#123; U.putObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, v);&#125; ##2.5 resizeStampresizeStamp ç”¨æ¥ç”Ÿæˆä¸€ä¸ªå’Œæ‰©å®¹æœ‰å…³çš„æ‰©å®¹æˆ³ï¼Œå…·ä½“æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ 123static final int resizeStamp(int n) &#123; return Integer.numberOfLeadingZeros(n) | (1 &lt;&lt; (RESIZE_STAMP_BITS - 1));&#125; Integer.numberOfLeadingZeros è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›æ— ç¬¦å·æ•´æ•° n æœ€é«˜ä½é 0 ä½å‰é¢çš„ 0 çš„ä¸ªæ•°ã€‚ æ¯”å¦‚ 10 çš„äºŒè¿›åˆ¶æ˜¯ 0000 0000 0000 0000 0000 0000 0000 1010ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•è¿”å›çš„å€¼å°±æ˜¯ 28ã€‚ æ ¹æ® resizeStamp çš„è¿ç®—é€»è¾‘ï¼Œæˆ‘ä»¬æ¥æ¨æ¼”ä¸€ä¸‹ï¼Œå‡å¦‚ n=16ï¼Œé‚£ä¹ˆ resizeStamp(16)=32796è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ˜¯[0000 0000 0000 0000 1000 0000 0001 1100] æ¥ç€å†æ¥çœ‹,å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸‹é¢è¿™æ®µä»£ç ï¼š U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)rs å·¦ç§» 16 ä½ï¼Œç›¸å½“äºåŸæœ¬çš„äºŒè¿›åˆ¶ä½ä½å˜æˆäº†é«˜ä½ 1000 0000 0001 1100 0000 0000 00000000 ç„¶åå†+2 =1000 0000 0001 1100 0000 0000 0000 0000+10=1000 0000 0001 1100 0000 00000000 0010 é«˜ 16 ä½ä»£è¡¨æ‰©å®¹çš„æ ‡è®°ã€ä½ 16 ä½ä»£è¡¨å¹¶è¡Œæ‰©å®¹çš„çº¿ç¨‹æ•° è¿™æ ·æ¥å­˜å‚¨æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ 1ï¼Œé¦–å…ˆåœ¨ CHM ä¸­æ˜¯æ”¯æŒå¹¶å‘æ‰©å®¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå½“å‰çš„æ•°ç»„éœ€è¦è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹æ¥å…±åŒè´Ÿè´£ 2ï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡æ‰©å®¹éƒ½ç”Ÿæˆå”¯ä¸€çš„ç”Ÿæˆæˆ³ï¼Œæ¯æ¬¡æ–°çš„æ‰©å®¹ï¼Œéƒ½æœ‰ä¸€ä¸ªä¸åŒçš„ nï¼Œè¿™ä¸ªç”Ÿæˆæˆ³å°±æ˜¯æ ¹æ® n æ¥è®¡ç®—å‡ºæ¥çš„ä¸€ä¸ªæ•°å­—ï¼Œn ä¸åŒï¼Œè¿™ä¸ªæ•°å­—ä¹Ÿä¸åŒ ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•æ‰©å®¹çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆæ˜¯+2 å› ä¸º 1 è¡¨ç¤ºåˆå§‹åŒ–ï¼Œ2 è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹ï¼Œè€Œä¸”å¯¹ sizeCtl çš„æ“ä½œéƒ½æ˜¯åŸºäºä½è¿ç®—çš„ï¼Œæ‰€ä»¥ä¸ä¼šå…³å¿ƒå®ƒæœ¬èº«çš„æ•°å€¼æ˜¯å¤šå°‘ï¼Œåªå…³å¿ƒå®ƒåœ¨äºŒè¿›åˆ¶ä¸Šçš„æ•°å€¼ï¼Œè€Œ sc + 1 ä¼šåœ¨ä½ 16 ä½ä¸ŠåŠ  1ã€‚##2.6 tableSizeForç»è¿‡å¤šæ¬¡ä½ç§»è¿”å›å¤§äºç­‰äºcçš„æœ€å°çš„äºŒæ¬¡æ–¹æ•° 1234567891011121314151617181920 /** * Returns a power of two table size for the given desired capacity. * See Hackers Delight, sec 3.2 * è¿”å›&gt;=cçš„æœ€å°çš„2çš„æ¬¡æ–¹æ•° * c=28 * n=27 =&gt; 0b 11011 * 11011 | 01101 =&gt; 11111 * 11111 | 00111 =&gt; 11111 * .... * =&gt; 11111 + 1 =100000 = 32 */private static final int tableSizeFor(int c) &#123; int n = c - 1; n |= n &gt;&gt;&gt; 1; n |= n &gt;&gt;&gt; 2; n |= n &gt;&gt;&gt; 4; n |= n &gt;&gt;&gt; 8; n |= n &gt;&gt;&gt; 16; return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;&#125; #3. æ„é€ æ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public ConcurrentHashMap() &#123;&#125;public ConcurrentHashMap(int initialCapacity) &#123; if (initialCapacity &lt; 0) throw new IllegalArgumentException(); //å¦‚æœæŒ‡å®šçš„å®¹é‡è¶…è¿‡å…è®¸çš„æœ€å¤§å€¼ï¼Œè®¾ç½®ä¸ºæœ€å¤§å€¼ int cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ? MAXIMUM_CAPACITY : tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; 1) + 1)); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125;public ConcurrentHashMap(Map&lt;? extends K, ? extends V&gt; m) &#123; this.sizeCtl = DEFAULT_CAPACITY; putAll(m);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor) &#123; this(initialCapacity, loadFactor, 1);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) &#123; //å‚æ•°æ ¡éªŒ if (!(loadFactor &gt; 0.0f) || initialCapacity &lt; 0 || concurrencyLevel &lt;= 0) throw new IllegalArgumentException(); //å¦‚æœåˆå§‹å®¹é‡å°äºå¹¶å‘çº§åˆ«ï¼Œé‚£å°±è®¾ç½®åˆå§‹å®¹é‡ä¸ºå¹¶å‘çº§åˆ« if (initialCapacity &lt; concurrencyLevel) initialCapacity = concurrencyLevel; //16/0.75 +1 = 22 long size = (long)(1.0 + (long)initialCapacity / loadFactor); // 22 - &gt; 32 int cap = (size &gt;= (long)MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : tableSizeFor((int)size); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125; #4.put 1234public V put(K key, V value) &#123; //å¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Œé»˜è®¤æ˜¯false return putVal(key, value, false);&#125; #5 putVal 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129final V putVal(K key, V value, boolean onlyIfAbsent) &#123; //æ§åˆ¶k å’Œ v ä¸èƒ½ä¸ºnull if (key == null || value == null) throw new NullPointerException(); //é€šè¿‡spreadæ–¹æ³•ï¼Œå¯ä»¥è®©é«˜ä½ä¹Ÿèƒ½å‚ä¸è¿›å¯»å€è¿ç®—ã€‚ int hash = spread(key.hashCode()); //binCountè¡¨ç¤ºå½“å‰k-v å°è£…æˆnodeåæ’å…¥åˆ°æŒ‡å®šæ¡¶ä½åï¼Œåœ¨æ¡¶ä½ä¸­çš„æ‰€å±é“¾è¡¨çš„ä¸‹æ ‡ä½ç½® //0 è¡¨ç¤ºå½“å‰æ¡¶ä½ä¸ºnullï¼Œnodeå¯ä»¥ç›´æ¥æ”¾ç€ //2 è¡¨ç¤ºå½“å‰æ¡¶ä½å·²ç»å¯èƒ½æ˜¯çº¢é»‘æ ‘ int binCount = 0; //tab å¼•ç”¨mapå¯¹è±¡çš„table //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //f è¡¨ç¤ºæ¡¶ä½çš„å¤´ç»“ç‚¹ //n è¡¨ç¤ºæ•£åˆ—è¡¨æ•°ç»„çš„é•¿åº¦ //i è¡¨ç¤ºkeyé€šè¿‡å¯»å€è®¡ç®—åï¼Œå¾—åˆ°çš„æ¡¶ä½ä¸‹æ ‡ //fh è¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹çš„hashå€¼ Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼šæˆç«‹ï¼Œè¡¨ç¤ºå½“å‰mapä¸­çš„tableå°šæœªåˆå§‹åŒ–.. if (tab == null || (n = tab.length) == 0) //æœ€ç»ˆå½“å‰çº¿ç¨‹éƒ½ä¼šè·å–åˆ°æœ€æ–°çš„map.tableå¼•ç”¨ã€‚ tab = initTable(); //CASE2ï¼ši è¡¨ç¤ºkeyä½¿ç”¨è·¯ç”±å¯»å€ç®—æ³•å¾—åˆ° keyå¯¹åº” tableæ•°ç»„çš„ä¸‹æ ‡ä½ç½®ï¼ŒtabAt è·å–æŒ‡å®šæ¡¶ä½çš„å¤´ç»“ç‚¹ f else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) &#123; //è¿›å…¥åˆ°CASE2ä»£ç å— å‰ç½®æ¡ä»¶ å½“å‰tableæ•°ç»„iæ¡¶ä½æ˜¯Nullæ—¶ã€‚ //ä½¿ç”¨CASæ–¹å¼ è®¾ç½® æŒ‡å®šæ•°ç»„iæ¡¶ä½ ä¸º new Node&lt;K,V&gt;(hash, key, value, null),å¹¶ä¸”æœŸæœ›å€¼æ˜¯null //casæ“ä½œæˆåŠŸ è¡¨ç¤ºokï¼Œç›´æ¥break forå¾ªç¯å³å¯ //casæ“ä½œå¤±è´¥ï¼Œè¡¨ç¤ºåœ¨å½“å‰çº¿ç¨‹ä¹‹å‰ï¼Œæœ‰å…¶å®ƒçº¿ç¨‹å…ˆä½ ä¸€æ­¥å‘æŒ‡å®šiæ¡¶ä½è®¾ç½®å€¼äº†ã€‚ //å½“å‰çº¿ç¨‹åªèƒ½å†æ¬¡è‡ªæ—‹ï¼Œå»èµ°å…¶å®ƒé€»è¾‘ã€‚ if (casTabAt(tab, i, null, new Node&lt;K,V&gt;(hash, key, value, null))) break; // no lock when adding to empty bin &#125; //CASE3ï¼šå‰ç½®æ¡ä»¶ï¼Œæ¡¶ä½çš„å¤´ç»“ç‚¹ä¸€å®šä¸æ˜¯nullã€‚ //æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ ä¸º FWDç»“ç‚¹ï¼Œè¡¨ç¤ºç›®å‰mapæ­£å¤„äºæ‰©å®¹è¿‡ç¨‹ä¸­.. else if ((fh = f.hash) == MOVED) //çœ‹åˆ°fwdèŠ‚ç‚¹åï¼Œå½“å‰èŠ‚ç‚¹æœ‰ä¹‰åŠ¡å¸®åŠ©å½“å‰mapå¯¹è±¡å®Œæˆè¿ç§»æ•°æ®çš„å·¥ä½œ //å¸®åŠ©æ‰©å®¹ tab = helpTransfer(tab, f); //CASE4ï¼šå½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ é“¾è¡¨ ä¹Ÿå¯èƒ½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else &#123; //å½“æ’å…¥keyå­˜åœ¨æ—¶ï¼Œä¼šå°†æ—§å€¼èµ‹å€¼ç»™oldValï¼Œè¿”å›ç»™putæ–¹æ³•è°ƒç”¨å¤„.. V oldVal = null; //ä½¿ç”¨sync åŠ é”â€œå¤´èŠ‚ç‚¹â€ï¼Œç†è®ºä¸Šæ˜¯â€œå¤´ç»“ç‚¹â€ synchronized (f) &#123; //ä¸ºä»€ä¹ˆåˆè¦å¯¹æ¯”ä¸€ä¸‹ï¼Œçœ‹çœ‹å½“å‰æ¡¶ä½çš„å¤´èŠ‚ç‚¹ æ˜¯å¦ä¸º ä¹‹å‰è·å–çš„å¤´ç»“ç‚¹ï¼Ÿ //ä¸ºäº†é¿å…å…¶å®ƒçº¿ç¨‹å°†è¯¥æ¡¶ä½çš„å¤´ç»“ç‚¹ä¿®æ”¹æ‰ï¼Œå¯¼è‡´å½“å‰çº¿ç¨‹ä»sync åŠ é” å°±æœ‰é—®é¢˜äº†ã€‚ä¹‹åæ‰€æœ‰æ“ä½œéƒ½ä¸ç”¨åœ¨åšäº†ã€‚ if (tabAt(tab, i) == f) &#123;//æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å’±ä»¬ åŠ é” çš„å¯¹è±¡æ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥è¿›æ¥é€ äº†ï¼ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰æ¡¶ä½å°±æ˜¯æ™®é€šé“¾è¡¨æ¡¶ä½ã€‚ if (fh &gt;= 0) &#123; //1.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­æ‰€æœ‰å…ƒç´ çš„keyéƒ½ä¸ä¸€è‡´æ—¶ï¼Œå½“å‰çš„æ’å…¥æ“ä½œæ˜¯è¿½åŠ åˆ°é“¾è¡¨çš„æœ«å°¾ï¼ŒbinCountè¡¨ç¤ºé“¾è¡¨é•¿åº¦ //2.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­çš„æŸä¸ªå…ƒç´ çš„keyä¸€è‡´æ—¶ï¼Œå½“å‰æ’å…¥æ“ä½œå¯èƒ½å°±æ˜¯æ›¿æ¢äº†ã€‚binCountè¡¨ç¤ºå†²çªä½ç½®ï¼ˆbinCount - 1ï¼‰ binCount = 1; //è¿­ä»£å¾ªç¯å½“å‰æ¡¶ä½çš„é“¾è¡¨ï¼Œeæ˜¯æ¯æ¬¡å¾ªç¯å¤„ç†èŠ‚ç‚¹ã€‚ for (Node&lt;K,V&gt; e = f;; ++binCount) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹ key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash æˆç«‹ è¡¨ç¤ºå¾ªç¯çš„å½“å‰å…ƒç´ çš„hashå€¼ä¸æ’å…¥èŠ‚ç‚¹çš„hashå€¼ä¸€è‡´ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­ //æ¡ä»¶äºŒï¼š((ek = e.key) == key ||(ek != null &amp;&amp; key.equals(ek))) // æˆç«‹ï¼šè¯´æ˜å¾ªç¯çš„å½“å‰èŠ‚ç‚¹ä¸æ’å…¥èŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå‘ç”Ÿå†²çªäº† if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å°†å½“å‰å¾ªç¯çš„å…ƒç´ çš„ å€¼ èµ‹å€¼ç»™oldVal oldVal = e.val; if (!onlyIfAbsent) e.val = value; break; &#125; //å½“å‰å…ƒç´  ä¸ æ’å…¥å…ƒç´ çš„keyä¸ä¸€è‡´ æ—¶ï¼Œä¼šèµ°ä¸‹é¢ç¨‹åºã€‚ //1.æ›´æ–°å¾ªç¯å¤„ç†èŠ‚ç‚¹ä¸º å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ //2.åˆ¤æ–­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯nullï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»æ˜¯é˜Ÿå°¾äº†ï¼Œæ’å…¥æ•°æ®éœ€è¦è¿½åŠ åˆ°é˜Ÿå°¾èŠ‚ç‚¹çš„åé¢ã€‚ Node&lt;K,V&gt; pred = e; if ((e = e.next) == null) &#123; pred.next = new Node&lt;K,V&gt;(hash, key, value, null); break; &#125; &#125; &#125; //å‰ç½®æ¡ä»¶ï¼Œè¯¥æ¡¶ä½ä¸€å®šä¸æ˜¯é“¾è¡¨ //æ¡ä»¶æˆç«‹ï¼Œè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //p è¡¨ç¤ºçº¢é»‘æ ‘ä¸­å¦‚æœä¸ä½ æ’å…¥èŠ‚ç‚¹çš„key æœ‰å†²çªèŠ‚ç‚¹çš„è¯ ï¼Œåˆ™putTreeVal æ–¹æ³• ä¼šè¿”å›å†²çªèŠ‚ç‚¹çš„å¼•ç”¨ã€‚ Node&lt;K,V&gt; p; //å¼ºåˆ¶è®¾ç½®binCountä¸º2ï¼Œå› ä¸ºbinCount &lt;= 1 æ—¶æœ‰å…¶å®ƒå«ä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸ºäº†2 binCount = 2; //æ¡ä»¶ä¸€ï¼šæˆç«‹ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„keyä¸çº¢é»‘æ ‘ä¸­çš„æŸä¸ªèŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå†²çªäº† if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key, value)) != null) &#123; //å°†å†²çªèŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal oldVal = p.val; if (!onlyIfAbsent) p.val = value; &#125; &#125; &#125; &#125; //è¯´æ˜å½“å‰æ¡¶ä½ä¸ä¸ºnullï¼Œå¯èƒ½æ˜¯çº¢é»‘æ ‘ ä¹Ÿå¯èƒ½æ˜¯é“¾è¡¨ if (binCount != 0) &#123; //å¦‚æœbinCount&gt;=8 è¡¨ç¤ºå¤„ç†çš„æ¡¶ä½ä¸€å®šæ˜¯é“¾è¡¨ if (binCount &gt;= TREEIFY_THRESHOLD) //è°ƒç”¨è½¬åŒ–é“¾è¡¨ä¸ºçº¢é»‘æ ‘çš„æ–¹æ³• treeifyBin(tab, i); //è¯´æ˜å½“å‰çº¿ç¨‹æ’å…¥çš„æ•°æ®keyï¼Œä¸åŸæœ‰k-vå‘ç”Ÿå†²çªï¼Œéœ€è¦å°†åŸæ•°æ®vè¿”å›ç»™è°ƒç”¨è€…ã€‚ if (oldVal != null) return oldVal; break; &#125; &#125; &#125; //1.ç»Ÿè®¡å½“å‰tableä¸€å…±æœ‰å¤šå°‘æ•°æ® //2.åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æ‰©å®¹é˜ˆå€¼æ ‡å‡†ï¼Œè§¦å‘æ‰©å®¹ã€‚ addCount(1L, binCount); return null;&#125; #6 initTableæ•°ç»„åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªåˆé€‚å¤§å°çš„æ•°ç»„ã€‚ sizeCtl ï¼šè¿™ä¸ªæ ‡å¿—æ˜¯åœ¨ Node æ•°ç»„åˆå§‹åŒ–æˆ–è€…æ‰©å®¹çš„æ—¶å€™çš„ä¸€ä¸ªæ§åˆ¶ä½æ ‡è¯†ï¼Œè´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–è€…æ‰©å®¹æ“ä½œã€‚ -1 ä»£è¡¨æ­£åœ¨åˆå§‹åŒ– -N ä»£è¡¨æœ‰ N-1 ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè¿™é‡Œä¸æ˜¯ç®€å•çš„ç†è§£æˆ n ä¸ªçº¿ç¨‹ï¼ŒsizeCtl å°±æ˜¯-N 0 æ ‡è¯† Node æ•°ç»„è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œæ­£æ•°ä»£è¡¨åˆå§‹åŒ–æˆ–è€…ä¸‹ä¸€æ¬¡æ‰©å®¹çš„å¤§å° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455/** * Initializes table, using the size recorded in sizeCtl. * * sizeCtl &lt; 0 * * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * * * sizeCtl &gt; 0 * * * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private final Node&lt;K,V&gt;[] initTable() &#123; //tab å¼•ç”¨map.table //sc sizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab; int sc; //è‡ªæ—‹ æ¡ä»¶ï¼šmap.table å°šæœªåˆå§‹åŒ– while ((tab = table) == null || tab.length == 0) &#123; if ((sc = sizeCtl) &lt; 0) //å¤§æ¦‚ç‡å°±æ˜¯-1ï¼Œè¡¨ç¤ºå…¶å®ƒçº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆ›å»ºtableçš„è¿‡ç¨‹ï¼Œå½“å‰çº¿ç¨‹æ²¡æœ‰ç«äº‰åˆ°åˆå§‹åŒ–tableçš„é”ã€‚ Thread.yield(); // lost initialization race; just spin //1.sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° //2.å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° //3.å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123; try &#123; //è¿™é‡Œä¸ºä»€ä¹ˆåˆè¦åˆ¤æ–­å‘¢ï¼Ÿ é˜²æ­¢å…¶å®ƒçº¿ç¨‹å·²ç»åˆå§‹åŒ–å®Œæ¯•äº†ï¼Œç„¶åå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–..å¯¼è‡´ä¸¢å¤±æ•°æ®ã€‚ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å…¶å®ƒçº¿ç¨‹éƒ½æ²¡æœ‰è¿›å…¥è¿‡è¿™ä¸ªifå—ï¼Œå½“å‰çº¿ç¨‹å°±æ˜¯å…·å¤‡åˆå§‹åŒ–tableæƒåˆ©äº†ã€‚ if ((tab = table) == null || tab.length == 0) &#123; //scå¤§äº0 åˆ›å»ºtableæ—¶ ä½¿ç”¨ scä¸ºæŒ‡å®šå¤§å°ï¼Œå¦åˆ™ä½¿ç”¨ 16 é»˜è®¤å€¼. int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY; @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n]; //æœ€ç»ˆèµ‹å€¼ç»™ map.table table = tab = nt; //n &gt;&gt;&gt; 2 =&gt; ç­‰äº 1/4 n n - (1/4)n = 3/4 n =&gt; 0.75 * n //sc 0.75 n è¡¨ç¤ºä¸‹ä¸€æ¬¡æ‰©å®¹æ—¶çš„è§¦å‘æ¡ä»¶ã€‚ sc = n - (n &gt;&gt;&gt; 2); &#125; &#125; finally &#123; //1.å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹è¯ï¼Œscè¡¨ç¤ºçš„æ˜¯ ä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼ //2.è¡¨ç¤ºå½“å‰çº¿ç¨‹ å¹¶ä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥åˆ°else if å— æ—¶ï¼Œå°† //sizeCtl è®¾ç½®ä¸ºäº†-1 ï¼Œé‚£ä¹ˆè¿™æ—¶éœ€è¦å°†å…¶ä¿®æ”¹ä¸º è¿›å…¥æ—¶çš„å€¼ã€‚ sizeCtl = sc; &#125; break; &#125; &#125; return tab;&#125; #7 addCount 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124private final void addCount(long x, int check) &#123; //as è¡¨ç¤º LongAdder.cells //b è¡¨ç¤ºLongAdder.base //s è¡¨ç¤ºå½“å‰map.tableä¸­å…ƒç´ çš„æ•°é‡ CounterCell[] as; long b, s; //æ¡ä»¶ä¸€ï¼štrue-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®ç´¯åŠ åˆ° base //æ¡ä»¶äºŒï¼šfalse-&gt;è¡¨ç¤ºå†™baseæˆåŠŸï¼Œæ•°æ®ç´¯åŠ åˆ°baseä¸­äº†ï¼Œå½“å‰ç«äº‰ä¸æ¿€çƒˆï¼Œä¸éœ€è¦åˆ›å»ºcells // true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ if ((as = counterCells) != null || !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) &#123; //æœ‰å‡ ç§æƒ…å†µè¿›å…¥åˆ°ifå—ä¸­ï¼Ÿ //1.true-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® //2.true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ //a è¡¨ç¤ºå½“å‰çº¿ç¨‹hashå¯»å€å‘½ä¸­çš„cell CounterCell a; //v è¡¨ç¤ºå½“å‰çº¿ç¨‹å†™cellæ—¶çš„æœŸæœ›å€¼ long v; //m è¡¨ç¤ºå½“å‰cellsæ•°ç»„çš„é•¿åº¦ int m; //true -&gt; æœªç«äº‰ false-&gt;å‘ç”Ÿç«äº‰ boolean uncontended = true; //æ¡ä»¶ä¸€ï¼šas == null || (m = as.length - 1) &lt; 0 //true-&gt; è¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯é€šè¿‡ å†™baseç«äº‰å¤±è´¥ ç„¶åè¿›å…¥çš„ifå—ï¼Œå°±éœ€è¦è°ƒç”¨fullAddCountæ–¹æ³•å»æ‰©å®¹ æˆ–è€… é‡è¯•.. LongAdder.longAccumulate //æ¡ä»¶äºŒï¼ša = as[ThreadLocalRandom.getProbe() &amp; m]) == null å‰ç½®æ¡ä»¶ï¼šcellså·²ç»åˆå§‹åŒ–äº† //true-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„cellè¡¨æ ¼æ˜¯ä¸ªç©ºï¼Œéœ€è¦å½“å‰çº¿ç¨‹è¿›å…¥fullAddCountæ–¹æ³•å»åˆå§‹åŒ– cellï¼Œæ”¾å…¥å½“å‰ä½ç½®. //æ¡ä»¶ä¸‰ï¼š!(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x) // false-&gt;å–åå¾—åˆ°falseï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellæˆåŠŸ // true-&gt;å–åå¾—åˆ°true,è¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellå¤±è´¥ï¼Œéœ€è¦è¿›å…¥fullAddCountè¿›è¡Œé‡è¯• æˆ–è€… æ‰©å®¹ cellsã€‚ if (as == null || (m = as.length - 1) &lt; 0 || (a = as[ThreadLocalRandom.getProbe() &amp; m]) == null || !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x)) ) &#123; fullAddCount(x, uncontended); //è€ƒè™‘åˆ°fullAddCounté‡Œé¢çš„äº‹æƒ…æ¯”è¾ƒç´¯ï¼Œå°±è®©å½“å‰çº¿ç¨‹ ä¸å‚ä¸åˆ° æ‰©å®¹ç›¸å…³çš„é€»è¾‘äº†ï¼Œç›´æ¥è¿”å›åˆ°è°ƒç”¨ç‚¹ã€‚ return; &#125; if (check &lt;= 1) return; //è·å–å½“å‰æ•£åˆ—è¡¨å…ƒç´ ä¸ªæ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæœŸæœ›å€¼ s = sumCount(); &#125; //è¡¨ç¤ºä¸€å®šæ˜¯ä¸€ä¸ªputæ“ä½œè°ƒç”¨çš„addCount if (check &gt;= 0) &#123; //tab è¡¨ç¤ºmap.table //nt è¡¨ç¤ºmap.nextTable //n è¡¨ç¤ºmap.tableæ•°ç»„çš„é•¿åº¦ //sc è¡¨ç¤ºsizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab, nt; int n, sc; /** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */ //è‡ªæ—‹ //æ¡ä»¶ä¸€ï¼šs &gt;= (long)(sc = sizeCtl) // true-&gt; 1.å½“å‰sizeCtlä¸ºä¸€ä¸ªè´Ÿæ•° è¡¨ç¤ºæ­£åœ¨æ‰©å®¹ä¸­.. // 2.å½“å‰sizeCtlæ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œè¡¨ç¤ºæ‰©å®¹é˜ˆå€¼ // false-&gt; è¡¨ç¤ºå½“å‰tableå°šæœªè¾¾åˆ°æ‰©å®¹æ¡ä»¶ //æ¡ä»¶äºŒï¼š(tab = table) != null // æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š(n = tab.length) &lt; MAXIMUM_CAPACITY // true-&gt;å½“å‰tableé•¿åº¦å°äºæœ€å¤§å€¼é™åˆ¶ï¼Œåˆ™å¯ä»¥è¿›è¡Œæ‰©å®¹ã€‚ while (s &gt;= (long)(sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp; (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123; //æ‰©å®¹æ‰¹æ¬¡å”¯ä¸€æ ‡è¯†æˆ³ //16 -&gt; 32 æ‰©å®¹ æ ‡è¯†ä¸ºï¼š1000 0000 0001 1011 int rs = resizeStamp(n); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰tableæ­£åœ¨æ‰©å®¹ // å½“å‰çº¿ç¨‹ç†è®ºä¸Šåº”è¯¥ååŠ©tableå®Œæˆæ‰©å®¹ if (sc &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼š(nt = nextTable) == null // true-&gt;è¡¨ç¤ºæœ¬æ¬¡æ‰©å®¹ç»“æŸ // false-&gt;æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || (nt = nextTable) == null || transferIndex &lt;= 0) break; //å‰ç½®æ¡ä»¶ï¼šå½“å‰tableæ­£åœ¨æ‰§è¡Œæ‰©å®¹ä¸­.. å½“å‰çº¿ç¨‹æœ‰æœºä¼šå‚ä¸è¿›æ‰©å®¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹æˆåŠŸå‚ä¸åˆ°æ‰©å®¹ä»»åŠ¡ä¸­ï¼Œå¹¶ä¸”å°†scä½16ä½å€¼åŠ 1ï¼Œè¡¨ç¤ºå¤šäº†ä¸€ä¸ªçº¿ç¨‹å‚ä¸å·¥ä½œ //æ¡ä»¶å¤±è´¥ï¼š1.å½“å‰æœ‰å¾ˆå¤šçº¿ç¨‹éƒ½åœ¨æ­¤å¤„å°è¯•ä¿®æ”¹sizeCtlï¼Œæœ‰å…¶å®ƒä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æˆåŠŸäº†ï¼Œå¯¼è‡´ä½ çš„scæœŸæœ›å€¼ä¸å†…å­˜ä¸­çš„å€¼ä¸ä¸€è‡´ ä¿®æ”¹å¤±è´¥ // 2.transfer ä»»åŠ¡å†…éƒ¨çš„çº¿ç¨‹ä¹Ÿä¿®æ”¹äº†sizeCtlã€‚ if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) //ååŠ©æ‰©å®¹çº¿ç¨‹ï¼ŒæŒæœ‰nextTableå‚æ•° transfer(tab, nt); &#125; //1000 0000 0001 1011 0000 0000 0000 0000 +2 =&gt; 1000 0000 0001 1011 0000 0000 0000 0010 //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯è§¦å‘æ‰©å®¹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨transferæ–¹æ³•éœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ else if (U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)) //è§¦å‘æ‰©å®¹æ¡ä»¶çš„çº¿ç¨‹ ä¸æŒæœ‰nextTable transfer(tab, null); s = sumCount(); &#125; &#125;&#125; #8. transferConcurrentHashMap æ”¯æŒå¹¶å‘æ‰©å®¹ï¼Œå®ç°æ–¹å¼æ˜¯ï¼ŒæŠŠ Node æ•°ç»„è¿›è¡Œæ‹†åˆ†ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å¤„ç†è‡ªå·±çš„åŒºåŸŸï¼Œå‡è®¾ table æ•°ç»„æ€»é•¿åº¦æ˜¯ 64ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹å¯ä»¥åˆ†åˆ° 16 ä¸ª bucketã€‚ç„¶åæ¯ä¸ªçº¿ç¨‹å¤„ç†çš„èŒƒå›´ï¼ŒæŒ‰ç…§å€’åºæ¥åšè¿ç§»ã€‚ é€šè¿‡ for è‡ªå¾ªç¯å¤„ç†æ¯ä¸ªæ§½ä½ä¸­çš„é“¾è¡¨å…ƒç´ ï¼Œé»˜è®¤ advace ä¸ºçœŸï¼Œé€šè¿‡ CAS è®¾ç½® transferIndexå±æ€§å€¼ï¼Œå¹¶åˆå§‹åŒ– i å’Œ bound å€¼ï¼Œi æŒ‡å½“å‰å¤„ç†çš„æ§½ä½åºå·ï¼Œbound æŒ‡éœ€è¦å¤„ç†çš„æ§½ä½è¾¹ç•Œï¼Œå…ˆå¤„ç†æ§½ä½ 31 çš„èŠ‚ç‚¹ï¼› ï¼ˆbound,iï¼‰ =(16,31) ä» 31 çš„ä½ç½®å¾€å‰æ¨åŠ¨ã€‚ æ¯å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ‰©å®¹æ“ä½œï¼Œå°±é€šè¿‡ cas æ‰§è¡Œ sc-1ã€‚ æ¥ç€åˆ¤æ–­(sc-2) !=resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT ; å¦‚æœç›¸ç­‰ï¼Œè¡¨ç¤ºå½“å‰ä¸ºæ•´ä¸ªæ‰©å®¹æ“ä½œçš„ æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæ„å‘³ç€æ•´ä¸ªæ‰©å®¹æ“ä½œå°±ç»“æŸäº†ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜è¿˜å¾—ç»§ç»­ã€‚ è¿™ä¹ˆåšçš„ç›®çš„ï¼Œä¸€æ–¹é¢æ˜¯é˜²æ­¢ä¸åŒæ‰©å®¹ä¹‹é—´å‡ºç°ç›¸åŒçš„ sizeCtlï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œè¿˜å¯ä»¥é¿å…sizeCtl çš„ ABA é—®é¢˜å¯¼è‡´çš„æ‰©å®¹é‡å çš„æƒ…å†µã€‚ æ‰©å®¹å›¾è§£åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å½“æ›´æ–°åçš„é”®å€¼å¯¹æ€»æ•° baseCount &gt;= é˜ˆå€¼ sizeCtl æ—¶ï¼Œè¿›è¡Œrehashï¼Œè¿™é‡Œé¢ä¼šæœ‰ä¸¤ä¸ªé€»è¾‘ã€‚ å¦‚æœå½“å‰æ­£åœ¨å¤„äºæ‰©å®¹é˜¶æ®µï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šåŠ å…¥å¹¶ä¸”ååŠ©æ‰©å®¹ã€‚ å¦‚æœå½“å‰æ²¡æœ‰åœ¨æ‰©å®¹ï¼Œåˆ™ç›´æ¥è§¦å‘æ‰©å®¹æ“ä½œã€‚ æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹æ•°æ®çš„è½¬ç§»å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯æŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ä½†æ˜¯è¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåœ¨æ‰©å®¹çš„æ—¶å€™å…¶ä»–çº¿ç¨‹ä¹Ÿå¯èƒ½æ­£åœ¨æ·»åŠ å…ƒç´ ï¼Œè¿™æ—¶åˆè§¦å‘äº†æ‰©å®¹æ€ä¹ˆåŠï¼Ÿå¯èƒ½å¤§å®¶æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯åŠ äº’æ–¥é”ï¼ŒæŠŠè½¬ç§»è¿‡ç¨‹é”ä½ï¼Œè™½ç„¶æ˜¯å¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ä¼šå¸¦æ¥è¾ƒå¤§çš„æ€§èƒ½å¼€é”€ã€‚å› ä¸ºäº’æ–¥é”ä¼šå¯¼è‡´æ‰€æœ‰è®¿é—®ä¸´ç•ŒåŒºçš„çº¿ç¨‹é™·å…¥åˆ°é˜»å¡çŠ¶æ€ï¼ŒæŒæœ‰é”çš„çº¿ç¨‹è€—æ—¶è¶Šé•¿ï¼Œå…¶ä»–ç«äº‰çº¿ç¨‹å°±ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œå¯¼è‡´ååé‡è¾ƒä½ã€‚è€Œä¸”è¿˜å¯èƒ½å¯¼è‡´æ­»é”ã€‚ è€Œ ConcurrentHashMap å¹¶æ²¡æœ‰ç›´æ¥åŠ é”ï¼Œè€Œæ˜¯é‡‡ç”¨ CAS å®ç°æ— é”çš„å¹¶å‘åŒæ­¥ç­–ç•¥ï¼Œæœ€ç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ã€‚ å®ƒæŠŠ Node æ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹é”è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingNodeèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹å®ƒçš„æºç å®ç°ã€‚ fwd:è¿™ä¸ªç±»æ˜¯ä¸ªæ ‡è¯†ç±»ï¼Œç”¨äºæŒ‡å‘æ–°è¡¨ç”¨çš„ï¼Œå…¶ä»–çº¿ç¨‹é‡åˆ°è¿™ä¸ªç±»ä¼šä¸»åŠ¨è·³è¿‡è¿™ä¸ªç±»ï¼Œå› ä¸ºè¿™ä¸ªç±»è¦ä¹ˆå°±æ˜¯æ‰©å®¹è¿ç§»æ­£åœ¨è¿›è¡Œï¼Œè¦ä¹ˆå°±æ˜¯å·²ç»å®Œæˆæ‰©å®¹è¿ç§»ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªç±»è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå†è¿›è¡Œæ“ä½œã€‚ advance:è¿™ä¸ªå˜é‡æ˜¯ç”¨äºæç¤ºä»£ç æ˜¯å¦è¿›è¡Œæ¨è¿›å¤„ç†ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ¡¶å¤„ç†å®Œï¼Œå¤„ç†ä¸‹ä¸€ä¸ªæ¡¶çš„æ ‡è¯†ã€‚ finishing:è¿™ä¸ªå˜é‡ç”¨äºæç¤ºæ‰©å®¹æ˜¯å¦ç»“æŸç”¨çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237private final void transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab) &#123; //n è¡¨ç¤ºæ‰©å®¹ä¹‹å‰tableæ•°ç»„çš„é•¿åº¦ //stride è¡¨ç¤ºåˆ†é…ç»™çº¿ç¨‹ä»»åŠ¡çš„æ­¥é•¿ int n = tab.length, stride; // stride å›ºå®šä¸º 16 if ((stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE) stride = MIN_TRANSFER_STRIDE; // subdivide range //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä¸ºè§¦å‘æœ¬æ¬¡æ‰©å®¹çš„çº¿ç¨‹ï¼Œéœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯ååŠ©æ‰©å®¹çš„çº¿ç¨‹.. if (nextTab == null) &#123; // initiating try &#123; //åˆ›å»ºäº†ä¸€ä¸ªæ¯”æ‰©å®¹ä¹‹å‰å¤§ä¸€å€çš„table @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n &lt;&lt; 1]; nextTab = nt; &#125; catch (Throwable ex) &#123; // try to cope with OOME sizeCtl = Integer.MAX_VALUE; return; &#125; //èµ‹å€¼ç»™å¯¹è±¡å±æ€§ nextTable ï¼Œæ–¹ä¾¿ååŠ©æ‰©å®¹çº¿ç¨‹ æ‹¿åˆ°æ–°è¡¨ nextTable = nextTab; //è®°å½•è¿ç§»æ•°æ®æ•´ä½“ä½ç½®çš„ä¸€ä¸ªæ ‡è®°ã€‚indexè®¡æ•°æ˜¯ä»1å¼€å§‹è®¡ç®—çš„ã€‚ transferIndex = n; &#125; //è¡¨ç¤ºæ–°æ•°ç»„çš„é•¿åº¦ int nextn = nextTab.length; //fwd èŠ‚ç‚¹ï¼Œå½“æŸä¸ªæ¡¶ä½æ•°æ®å¤„ç†å®Œæ¯•åï¼Œå°†æ­¤æ¡¶ä½è®¾ç½®ä¸ºfwdèŠ‚ç‚¹ï¼Œå…¶å®ƒå†™çº¿ç¨‹ æˆ–è¯»çº¿ç¨‹çœ‹åˆ°åï¼Œä¼šæœ‰ä¸åŒé€»è¾‘ã€‚ ForwardingNode&lt;K,V&gt; fwd = new ForwardingNode&lt;K,V&gt;(nextTab); //æ¨è¿›æ ‡è®° boolean advance = true; //å®Œæˆæ ‡è®° boolean finishing = false; // to ensure sweep before committing nextTab //i è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡ï¼Œæ‰§è¡Œåˆ°çš„æ¡¶ä½ //bound è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡çš„ä¸‹ç•Œé™åˆ¶ int i = 0, bound = 0; //è‡ªæ—‹ for (;;) &#123; //f æ¡¶ä½çš„å¤´ç»“ç‚¹ //fh å¤´ç»“ç‚¹çš„hash Node&lt;K,V&gt; f; int fh; /** * 1.ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡åŒºé—´ * 2.ç»´æŠ¤å½“å‰çº¿ç¨‹ä»»åŠ¡è¿›åº¦ï¼ˆi è¡¨ç¤ºå½“å‰å¤„ç†çš„æ¡¶ä½ï¼‰ * 3.ç»´æŠ¤mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„è¿›åº¦ */ while (advance) &#123; //åˆ†é…ä»»åŠ¡çš„å¼€å§‹ä¸‹æ ‡ //åˆ†é…ä»»åŠ¡çš„ç»“æŸä¸‹æ ‡ int nextIndex, nextBound; //CASE1: //æ¡ä»¶ä¸€ï¼š--i &gt;= bound //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œè¿˜æœ‰ç›¸åº”çš„åŒºé—´çš„æ¡¶ä½è¦å¤„ç†ï¼Œ--i å°±è®©å½“å‰çº¿ç¨‹å¤„ç†ä¸‹ä¸€ä¸ª æ¡¶ä½. //ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… if (--i &gt;= bound || finishing) advance = false; //CASE2: //å‰ç½®æ¡ä»¶ï¼šå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½éƒ½åˆ†é…å®Œæ¯•äº†ï¼Œæ²¡æœ‰åŒºé—´å¯åˆ†é…äº†ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹çš„iå˜é‡ä¸º-1 è·³å‡ºå¾ªç¯åï¼Œæ‰§è¡Œé€€å‡ºè¿ç§»ä»»åŠ¡ç›¸å…³çš„ç¨‹åº //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½å°šæœªåˆ†é…å®Œæ¯•ï¼Œè¿˜æœ‰åŒºé—´å¯åˆ†é… else if ((nextIndex = transferIndex) &lt;= 0) &#123; i = -1; advance = false; &#125; //CASE3: //å‰ç½®æ¡ä»¶ï¼š1ã€å½“å‰çº¿ç¨‹éœ€è¦åˆ†é…ä»»åŠ¡åŒºé—´ 2.å…¨å±€èŒƒå›´å†…è¿˜æœ‰æ¡¶ä½å°šæœªè¿ç§» //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡æˆåŠŸ //æ¡ä»¶å¤±è´¥ï¼šè¯´æ˜åˆ†é…ç»™å½“å‰çº¿ç¨‹å¤±è´¥ï¼Œåº”è¯¥æ˜¯å’Œå…¶å®ƒçº¿ç¨‹å‘ç”Ÿäº†ç«äº‰å§ else if (U.compareAndSwapInt (this, TRANSFERINDEX, nextIndex, nextBound = (nextIndex &gt; stride ? nextIndex - stride : 0))) &#123; bound = nextBound; i = nextIndex - 1; advance = false; &#125; &#125; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼ši &lt; 0 //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æœªåˆ†é…åˆ°ä»»åŠ¡ if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) &#123; //ä¿å­˜sizeCtl çš„å˜é‡ int sc; if (finishing) &#123; nextTable = null; table = nextTab; sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1); return; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜è®¾ç½®sizeCtl ä½16ä½ -1 æˆåŠŸï¼Œå½“å‰çº¿ç¨‹å¯ä»¥æ­£å¸¸é€€å‡º if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) &#123; //1000 0000 0001 1011 0000 0000 0000 0000 //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹ä¸æ˜¯æœ€åä¸€ä¸ªé€€å‡ºtransferä»»åŠ¡çš„çº¿ç¨‹ if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT) //æ­£å¸¸é€€å‡º return; finishing = advance = true; i = n; // recheck before commit &#125; &#125; //å‰ç½®æ¡ä»¶ï¼šã€CASE2~CASE4ã€‘ å½“å‰çº¿ç¨‹ä»»åŠ¡å°šæœªå¤„ç†å®Œï¼Œæ­£åœ¨è¿›è¡Œä¸­ //CASE2: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½æœªå­˜æ”¾æ•°æ®ï¼Œåªéœ€è¦å°†æ­¤å¤„è®¾ç½®ä¸ºfwdèŠ‚ç‚¹å³å¯ã€‚ else if ((f = tabAt(tab, i)) == null) advance = casTabAt(tab, i, null, fwd); //CASE3: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½å·²ç»è¿ç§»è¿‡äº†ï¼Œå½“å‰çº¿ç¨‹ä¸ç”¨å†å¤„ç†äº†ï¼Œç›´æ¥å†æ¬¡æ›´æ–°å½“å‰çº¿ç¨‹ä»»åŠ¡ç´¢å¼•ï¼Œå†æ¬¡å¤„ç†ä¸‹ä¸€ä¸ªæ¡¶ä½ æˆ–è€… å…¶å®ƒæ“ä½œ else if ((fh = f.hash) == MOVED) advance = true; // already processed //CASE4: //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œè€Œä¸”nodeèŠ‚ç‚¹ ä¸æ˜¯ fwdèŠ‚ç‚¹ï¼Œè¯´æ˜è¿™äº›æ•°æ®éœ€è¦è¿ç§»ã€‚ else &#123; //sync åŠ é”å½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ synchronized (f) &#123; //é˜²æ­¢åœ¨ä½ åŠ é”å¤´å¯¹è±¡ä¹‹å‰ï¼Œå½“å‰æ¡¶ä½çš„å¤´å¯¹è±¡è¢«å…¶å®ƒå†™çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œå¯¼è‡´ä½ ç›®å‰åŠ é”å¯¹è±¡é”™è¯¯... if (tabAt(tab, i) == f) &#123; //ln è¡¨ç¤ºä½ä½é“¾è¡¨å¼•ç”¨ //hn è¡¨ç¤ºé«˜ä½é“¾è¡¨å¼•ç”¨ Node&lt;K,V&gt; ln, hn; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯é“¾è¡¨æ¡¶ä½ if (fh &gt;= 0) &#123; //lastRun //å¯ä»¥è·å–å‡º å½“å‰é“¾è¡¨ æœ«å°¾è¿ç»­é«˜ä½ä¸å˜çš„ node int runBit = fh &amp; n; Node&lt;K,V&gt; lastRun = f; for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º ä½ä½é“¾è¡¨ï¼Œé‚£ä¹ˆå°±è®© ln æŒ‡å‘ ä½ä½é“¾è¡¨ if (runBit == 0) &#123; ln = lastRun; hn = null; &#125; //å¦åˆ™ï¼Œè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º é«˜ä½é“¾è¡¨ï¼Œå°±è®© hn æŒ‡å‘ é«˜ä½é“¾è¡¨ else &#123; hn = lastRun; ln = null; &#125; for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn); &#125; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //è½¬æ¢å¤´ç»“ç‚¹ä¸º treeBinå¼•ç”¨ t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //ä½ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘ä½ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘ä½ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; lo = null, loTail = null; //é«˜ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘é«˜ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘é«˜ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; hi = null, hiTail = null; //lc è¡¨ç¤ºä½ä½é“¾è¡¨å…ƒç´ æ•°é‡ //hc è¡¨ç¤ºé«˜ä½é“¾è¡¨å…ƒç´ æ•°é‡ int lc = 0, hc = 0; //è¿­ä»£TreeBinä¸­çš„åŒå‘é“¾è¡¨ï¼Œä»å¤´ç»“ç‚¹ è‡³ å°¾èŠ‚ç‚¹ for (Node&lt;K,V&gt; e = t.first; e != null; e = e.next) &#123; // h è¡¨ç¤ºå¾ªç¯å¤„ç†å½“å‰å…ƒç´ çš„ hash int h = e.hash; //ä½¿ç”¨å½“å‰èŠ‚ç‚¹ æ„å»ºå‡ºæ¥çš„ æ–°çš„ TreeNode TreeNode&lt;K,V&gt; p = new TreeNode&lt;K,V&gt; (h, e.key, e.val, null, null); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹ å±äºä½ä½é“¾ èŠ‚ç‚¹ if ((h &amp; n) == 0) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰ä½ä½é“¾è¡¨ è¿˜æ²¡æœ‰æ•°æ® if ((p.prev = loTail) == null) lo = p; //è¯´æ˜ ä½ä½é“¾è¡¨å·²ç»æœ‰æ•°æ®äº†ï¼Œæ­¤æ—¶å½“å‰å…ƒç´  è¿½åŠ åˆ° ä½ä½é“¾è¡¨çš„æœ«å°¾å°±è¡Œäº† else loTail.next = p; //å°†ä½ä½é“¾è¡¨å°¾æŒ‡é’ˆæŒ‡å‘ p èŠ‚ç‚¹ loTail = p; ++lc; &#125; //å½“å‰èŠ‚ç‚¹ å±äº é«˜ä½é“¾ èŠ‚ç‚¹ else &#123; if ((p.prev = hiTail) == null) hi = p; else hiTail.next = p; hiTail = p; ++hc; &#125; &#125; ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) : (hc != 0) ? new TreeBin&lt;K,V&gt;(lo) : t; hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) : (lc != 0) ? new TreeBin&lt;K,V&gt;(hi) : t; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; &#125; &#125; &#125; &#125;&#125; é“¾è¡¨è¿ç§»åŸç† 1ï¼‰é«˜ä½ä½åŸç†åˆ†æ ConcurrentHashMap åœ¨åšé“¾è¡¨è¿ç§»æ—¶ï¼Œä¼šç”¨é«˜ä½ä½æ¥å®ç°ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜è¦åˆ†æä¸€ä¸‹ 1ï¼Œå¦‚ä½•å®ç°é«˜ä½ä½é“¾è¡¨çš„åŒºåˆ† å‡å¦‚æœ‰è¿™æ ·ä¸€ä¸ªé˜Ÿåˆ—ç¬¬ 14 ä¸ªæ§½ä½æ’å…¥æ–°èŠ‚ç‚¹ä¹‹åï¼Œé“¾è¡¨å…ƒç´ ä¸ªæ•°å·²ç»è¾¾åˆ°äº† 8ï¼Œä¸”æ•°ç»„é•¿åº¦ä¸º 16ï¼Œä¼˜å…ˆé€šè¿‡æ‰©å®¹æ¥ç¼“è§£é“¾è¡¨è¿‡é•¿çš„é—®é¢˜ å‡å¦‚å½“å‰çº¿ç¨‹æ­£åœ¨å¤„ç†æ§½ä½ä¸º 14 çš„èŠ‚ç‚¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œåœ¨ä»£ç ä¸­ï¼Œé¦–å…ˆå®šä¹‰ä¸¤ä¸ªå˜é‡èŠ‚ç‚¹ ln å’Œ hnï¼Œå®é™…å°±æ˜¯ lowNode å’Œ HighNodeï¼Œåˆ†åˆ«ä¿å­˜ hash å€¼çš„ç¬¬ x ä½ä¸º 0 å’Œä¸ç­‰äº0 çš„èŠ‚ç‚¹ é€šè¿‡ fn&amp;n å¯ä»¥æŠŠè¿™ä¸ªé“¾è¡¨ä¸­çš„å…ƒç´ åˆ†ä¸ºä¸¤ç±»ï¼ŒA ç±»æ˜¯ hash å€¼çš„ç¬¬ X ä½ä¸º 0ï¼ŒB ç±»æ˜¯ hash å€¼çš„ç¬¬ x ä½ä¸ºä¸ç­‰äº 0ï¼ˆè‡³äºä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåŒºåˆ†ï¼Œç¨ååˆ†æï¼‰ï¼Œå¹¶ä¸”é€šè¿‡ lastRun è®°å½•æœ€åè¦å¤„ç†çš„èŠ‚ç‚¹ã€‚æœ€ç»ˆè¦è¾¾åˆ°çš„ç›®çš„æ˜¯ï¼ŒA ç±»çš„é“¾è¡¨ä¿æŒä½ç½®ä¸åŠ¨ï¼ŒB ç±»çš„é“¾è¡¨ä¸º 14+16(æ‰©å®¹å¢åŠ çš„é•¿åº¦)=30 æŠŠ 14 æ§½ä½çš„é“¾è¡¨å•ç‹¬ä¼¶å‡ºæ¥ï¼Œç”¨è“è‰²è¡¨ç¤º fn&amp;n=0 çš„èŠ‚ç‚¹ï¼Œå‡å¦‚é“¾è¡¨çš„åˆ†ç±»æ˜¯è¿™æ · 1234567for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125;&#125; é€šè¿‡ä¸Šé¢è¿™æ®µä»£ç éå†ï¼Œä¼šè®°å½• runBit ä»¥åŠ lastRunï¼ŒæŒ‰ç…§ä¸Šé¢è¿™ä¸ªç»“æ„ï¼Œé‚£ä¹ˆ runBit åº”è¯¥æ˜¯è“è‰²èŠ‚ç‚¹ï¼ŒlastRun åº”è¯¥æ˜¯ç¬¬ 6 ä¸ªèŠ‚ç‚¹æ¥ç€ï¼Œå†é€šè¿‡è¿™æ®µä»£ç è¿›è¡Œéå†ï¼Œç”Ÿæˆ ln é“¾ä»¥åŠ hn é“¾ 1234567for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn);&#125; æ¥ç€ï¼Œé€šè¿‡ CAS æ“ä½œï¼ŒæŠŠ hn é“¾æ”¾åœ¨ i+n ä¹Ÿå°±æ˜¯ 14+16 çš„ä½ç½®ï¼Œln é“¾ä¿æŒåŸæ¥çš„ä½ç½®ä¸åŠ¨ã€‚å¹¶ä¸”è®¾ç½®å½“å‰èŠ‚ç‚¹ä¸º fwdï¼Œè¡¨ç¤ºå·²ç»è¢«å½“å‰çº¿ç¨‹è¿ç§»å®Œäº†ã€‚ 123setTabAt(nextTab, i, ln);setTabAt(nextTab, i + n, hn);setTabAt(tab, i, fwd); è¿ç§»å®Œæˆä»¥åçš„æ•°æ®åˆ†å¸ƒå¦‚ä¸‹ 2ï¼‰ä¸ºä»€ä¹ˆè¦åšé«˜ä½ä½çš„åˆ’åˆ† è¦æƒ³äº†è§£è¿™ä¹ˆè®¾è®¡çš„ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦ä» ConcurrentHashMap çš„æ ¹æ®ä¸‹æ ‡è·å–å¯¹è±¡çš„ç®—æ³•æ¥çœ‹ï¼Œåœ¨ putVal æ–¹æ³•ä¸­ 1018 è¡Œï¼š (f = tabAt(tab, i = (n - 1) &amp; hash)) == null é€šè¿‡(n-1) &amp; hash æ¥è·å¾—åœ¨ table ä¸­çš„æ•°ç»„ä¸‹æ ‡æ¥è·å–èŠ‚ç‚¹æ•°æ®ï¼Œã€&amp;è¿ç®—æ˜¯äºŒè¿›åˆ¶è¿ç®—ç¬¦ï¼Œ1&amp; 1=1ï¼Œå…¶ä»–éƒ½ä¸º 0ã€‘ã€‚ #9.helpTransferå¦‚æœå¯¹åº”çš„èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹çš„ hash æ˜¯ä¸æ˜¯ç­‰äº MOVED(-1)ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ForwardingNode èŠ‚ç‚¹ï¼Œæ„å‘³ç€æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œé‚£ä¹ˆå½“å‰ç°åœ¨ç›´æ¥å¸®åŠ©å®ƒè¿›è¡Œæ‰©å®¹ï¼Œå› æ­¤è°ƒç”¨ helpTransferæ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455final Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123; //nextTab å¼•ç”¨çš„æ˜¯ fwd.nextTable == map.nextTable ç†è®ºä¸Šæ˜¯è¿™æ ·ã€‚ //sc ä¿å­˜map.sizeCtl Node&lt;K,V&gt;[] nextTab; int sc; //æ¡ä»¶ä¸€ï¼štab != null æ’æˆç«‹ true //æ¡ä»¶äºŒï¼š(f instanceof ForwardingNode) æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š((ForwardingNode&lt;K,V&gt;)f).nextTable) != null æ’æˆç«‹ true if (tab != null &amp;&amp; (f instanceof ForwardingNode) &amp;&amp; (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != null) &#123; //æ‹¿å½“å‰æ ‡çš„é•¿åº¦ è·å– æ‰©å®¹æ ‡è¯†æˆ³ å‡è®¾ 16 -&gt; 32 æ‰©å®¹ï¼š1000 0000 0001 1011 int rs = resizeStamp(tab.length); //æ¡ä»¶ä¸€ï¼šnextTab == nextTable //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼š1.nextTableè¢«è®¾ç½®ä¸ºNull äº†ï¼Œæ‰©å®¹å®Œæ¯•åï¼Œä¼šè¢«è®¾ä¸ºNull // 2.å†æ¬¡å‡ºå‘æ‰©å®¹äº†...å’±ä»¬æ‹¿åˆ°çš„nextTab ä¹Ÿå·²ç»è¿‡æœŸäº†... //æ¡ä»¶äºŒï¼štable == tab //æˆç«‹ï¼šè¯´æ˜ æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¿˜æœªå®Œæˆ //ä¸æˆç«‹ï¼šè¯´æ˜æ‰©å®¹å·²ç»ç»“æŸäº†ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œæœ€åé€€å‡ºçš„çº¿ç¨‹ ä¼šè®¾ç½® nextTable ä¸º table //æ¡ä»¶ä¸‰ï¼š(sc = sizeCtl) &lt; 0 //æˆç«‹ï¼šè¯´æ˜æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼šè¯´æ˜sizeCtlå½“å‰æ˜¯ä¸€ä¸ªå¤§äº0çš„æ•°ï¼Œæ­¤æ—¶ä»£è¡¨ä¸‹æ¬¡æ‰©å®¹çš„é˜ˆå€¼ï¼Œå½“å‰æ‰©å®¹å·²ç»ç»“æŸã€‚ while (nextTab == nextTable &amp;&amp; table == tab &amp;&amp; (sc = sizeCtl) &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼štransferIndex &lt;= 0 // true-&gt;è¯´æ˜mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„ä»»åŠ¡å·²ç»åˆ†é…å®Œäº†ï¼Œå½“å‰çº¿ç¨‹è¿›å»ä¹Ÿæ²¡æ´»å¹².. // false-&gt;è¿˜æœ‰ä»»åŠ¡å¯ä»¥åˆ†é…ã€‚ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || transferIndex &lt;= 0) break; if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) &#123; transfer(tab, nextTab); break; &#125; &#125; return nextTab; &#125; return table;&#125; #10.get 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public V get(Object key) &#123; //tab å¼•ç”¨map.table //e å½“å‰å…ƒç´  //p ç›®æ ‡èŠ‚ç‚¹ //n tableæ•°ç»„é•¿åº¦ //eh å½“å‰å…ƒç´ hash //ek å½“å‰å…ƒç´ key Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; int n, eh; K ek; //æ‰°åŠ¨è¿ç®—åå¾—åˆ° æ›´æ•£åˆ—çš„hashå€¼ int h = spread(key.hashCode()); //æ¡ä»¶ä¸€ï¼š(tab = table) != null //true-&gt;è¡¨ç¤ºå·²ç»putè¿‡æ•°æ®ï¼Œå¹¶ä¸”mapå†…éƒ¨çš„tableä¹Ÿå·²ç»åˆå§‹åŒ–å®Œæ¯• //false-&gt;è¡¨ç¤ºåˆ›å»ºå®Œmapåï¼Œå¹¶æ²¡æœ‰putè¿‡æ•°æ®ï¼Œmapå†…éƒ¨çš„tableæ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å†™æ•°æ®æ—¶ä¼šè§¦å‘åˆ›å»ºé€»è¾‘ã€‚ //æ¡ä»¶äºŒï¼š(n = tab.length) &gt; 0 true-&gt;è¡¨ç¤ºtableå·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(e = tabAt(tab, (n - 1) &amp; h)) != null //true-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ æœ‰å€¼ //false-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ä¸­æ˜¯nullï¼Œæ˜¯nullç›´æ¥è¿”å›null if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (e = tabAt(tab, (n - 1) &amp; h)) != null) &#123; //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ® //å¯¹æ¯”å¤´ç»“ç‚¹hashä¸æŸ¥è¯¢keyçš„hashæ˜¯å¦ä¸€è‡´ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹ä¸æŸ¥è¯¢Keyçš„hashå€¼ å®Œå…¨ä¸€è‡´ if ((eh = e.hash) == h) &#123; //å®Œå…¨æ¯”å¯¹ æŸ¥è¯¢key å’Œ å¤´ç»“ç‚¹çš„key //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹å°±æ˜¯æŸ¥è¯¢æ•°æ® if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) return e.val; &#125; //æ¡ä»¶æˆç«‹ï¼š //1.-1 fwd è¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ï¼Œä¸”å½“å‰æŸ¥è¯¢çš„è¿™ä¸ªæ¡¶ä½çš„æ•°æ® å·²ç»è¢«è¿ç§»èµ°äº† //2.-2 TreeBinèŠ‚ç‚¹ï¼Œéœ€è¦ä½¿ç”¨TreeBin æä¾›çš„find æ–¹æ³•æŸ¥è¯¢ã€‚ else if (eh &lt; 0) return (p = e.find(h, key)) != null ? p.val : null; //å½“å‰æ¡¶ä½å·²ç»å½¢æˆé“¾è¡¨çš„è¿™ç§æƒ…å†µ while ((e = e.next) != null) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) return e.val; &#125; &#125; return null;&#125; #11.remove 123public V remove(Object key) &#123; return replaceNode(key, null, null);&#125; #12.replaceNode 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143final V replaceNode(Object key, V value, Object cv) &#123; //è®¡ç®—keyç»è¿‡æ‰°åŠ¨è¿ç®—åçš„hash int hash = spread(key.hashCode()); //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //fè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ //nè¡¨ç¤ºå½“å‰tableæ•°ç»„é•¿åº¦ //iè¡¨ç¤ºhashå‘½ä¸­æ¡¶ä½ä¸‹æ ‡ //fhè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ hash Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼štab == null true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶äºŒï¼š(n = tab.length) == 0 true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(f = tabAt(tab, i = (n - 1) &amp; hash)) == null true -&gt; è¡¨ç¤ºå‘½ä¸­æ¡¶ä½ä¸­ä¸ºnullï¼Œç›´æ¥breakï¼Œ ä¼šè¿”å› if (tab == null || (n = tab.length) == 0 || (f = tabAt(tab, i = (n - 1) &amp; hash)) == null) break; //CASE2ï¼š //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ä¸­ï¼Œå½“å‰æ˜¯ä¸ªå†™æ“ä½œï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹éœ€è¦ååŠ©tableå®Œæˆæ‰©å®¹ã€‚ else if ((fh = f.hash) == MOVED) tab = helpTransfer(tab, f); //CASE3: //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //å½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ &quot;é“¾è¡¨&quot; ä¹Ÿå¯èƒ½ æ˜¯ &quot;çº¢é»‘æ ‘&quot; TreeBin else &#123; //ä¿ç•™æ›¿æ¢ä¹‹å‰çš„æ•°æ®å¼•ç”¨ V oldVal = null; //æ ¡éªŒæ ‡è®° boolean validated = false; //åŠ é”å½“å‰æ¡¶ä½ å¤´ç»“ç‚¹ï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šè¿›å…¥ ä»£ç å—ã€‚ synchronized (f) &#123; //åˆ¤æ–­syncåŠ é”æ˜¯å¦ä¸ºå½“å‰æ¡¶ä½ å¤´èŠ‚ç‚¹ï¼Œé˜²æ­¢å…¶å®ƒçº¿ç¨‹ï¼Œåœ¨å½“å‰çº¿ç¨‹åŠ é”æˆåŠŸä¹‹å‰ï¼Œä¿®æ”¹è¿‡ æ¡¶ä½ çš„å¤´ç»“ç‚¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šå½“å‰æ¡¶ä½å¤´ç»“ç‚¹ ä»ç„¶ä¸ºfï¼Œå…¶å®ƒçº¿ç¨‹æ²¡ä¿®æ”¹è¿‡ã€‚ if (tabAt(tab, i) == f) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ¡¶ä½ ä¸º é“¾è¡¨ æˆ–è€… å•ä¸ª node if (fh &gt;= 0) &#123; validated = true; //e è¡¨ç¤ºå½“å‰å¾ªç¯å¤„ç†å…ƒç´  //pred è¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ Node&lt;K,V&gt; e = f, pred = null; for (;;) &#123; //å½“å‰èŠ‚ç‚¹key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash true-&gt;è¯´æ˜å½“å‰èŠ‚ç‚¹çš„hashä¸æŸ¥æ‰¾èŠ‚ç‚¹hashä¸€è‡´ //æ¡ä»¶äºŒï¼š((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) //if æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜key ä¸æŸ¥è¯¢çš„keyå®Œå…¨ä¸€è‡´ã€‚ if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å½“å‰èŠ‚ç‚¹çš„value V ev = e.val; //æ¡ä»¶ä¸€ï¼šcv == null true-&gt;æ›¿æ¢çš„å€¼ä¸ºnull é‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªåˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == ev || (ev != null &amp;&amp; cv.equals(ev)) é‚£ä¹ˆæ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (cv == null || cv == ev || (ev != null &amp;&amp; cv.equals(ev))) &#123; //åˆ é™¤ æˆ–è€… æ›¿æ¢ //å°†å½“å‰èŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal åç»­è¿”å›ä¼šç”¨åˆ° oldVal = ev; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (value != null) //ç›´æ¥æ›¿æ¢ e.val = value; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰èŠ‚ç‚¹éå¤´ç»“ç‚¹ else if (pred != null) //å½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ pred.next = e.next; else //è¯´æ˜å½“å‰èŠ‚ç‚¹å³ä¸º å¤´ç»“ç‚¹ï¼Œåªéœ€è¦å°† æ¡¶ä½è®¾ç½®ä¸ºå¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ setTabAt(tab, i, e.next); &#125; break; &#125; pred = e; if ((e = e.next) == null) break; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šTreeBinèŠ‚ç‚¹ã€‚ else if (f instanceof TreeBin) &#123; validated = true; //è½¬æ¢ä¸ºå®é™…ç±»å‹ TreeBin t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //r è¡¨ç¤º çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ //p è¡¨ç¤º çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾åˆ°å¯¹åº”key ä¸€è‡´çš„node TreeNode&lt;K,V&gt; r, p; //æ¡ä»¶ä¸€ï¼š(r = t.root) != null ç†è®ºä¸Šæ˜¯æˆç«‹ //æ¡ä»¶äºŒï¼šTreeNode.findTreeNode ä»¥å½“å‰èŠ‚ç‚¹ä¸ºå…¥å£ï¼Œå‘ä¸‹æŸ¥æ‰¾keyï¼ˆåŒ…æ‹¬æœ¬èº«èŠ‚ç‚¹ï¼‰ // true-&gt;è¯´æ˜æŸ¥æ‰¾åˆ°ç›¸åº”key å¯¹åº”çš„nodeèŠ‚ç‚¹ã€‚ä¼šèµ‹å€¼ç»™p if ((r = t.root) != null &amp;&amp; (p = r.findTreeNode(hash, key, null)) != null) &#123; //ä¿å­˜p.val åˆ°pv V pv = p.val; //æ¡ä»¶ä¸€ï¼šcv == null æˆç«‹ï¼šä¸å¿…å¯¹valueï¼Œå°±åšæ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == pv ||(pv != null &amp;&amp; cv.equals(pv)) æˆç«‹ï¼šè¯´æ˜â€œå¯¹æ¯”å€¼â€ä¸å½“å‰pèŠ‚ç‚¹çš„å€¼ ä¸€è‡´ if (cv == null || cv == pv || (pv != null &amp;&amp; cv.equals(pv))) &#123; //æ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ oldVal = pv; //æ¡ä»¶æˆç«‹ï¼šæ›¿æ¢æ“ä½œ if (value != null) p.val = value; //åˆ é™¤æ“ä½œ else if (t.removeTreeNode(p)) //è¿™é‡Œæ²¡åšåˆ¤æ–­ï¼Œç›´æ¥æäº†...å¾ˆç–‘æƒ‘ setTabAt(tab, i, untreeify(t.first)); &#125; &#125; &#125; &#125; &#125; //å½“å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡æ¡¶ä½ å¤´ç»“ç‚¹æ—¶ï¼Œå½“å‰çº¿ç¨‹ sync å¤´ç»“ç‚¹ é”é”™å¯¹è±¡æ—¶ï¼Œvalidated ä¸ºfalseï¼Œä¼šè¿›å…¥ä¸‹æ¬¡for è‡ªæ—‹ if (validated) &#123; if (oldVal != null) &#123; //æ›¿æ¢çš„å€¼ ä¸ºnullï¼Œè¯´æ˜å½“å‰æ˜¯ä¸€æ¬¡åˆ é™¤æ“ä½œï¼ŒoldVal ï¼=null æˆç«‹ï¼Œè¯´æ˜åˆ é™¤æˆåŠŸï¼Œæ›´æ–°å½“å‰å…ƒç´ ä¸ªæ•°è®¡æ•°å™¨ã€‚ if (value == null) addCount(-1L, -1); return oldVal; &#125; break; &#125; &#125; &#125; return null;&#125; #13.TreeBin##13.1 å±æ€§ 1234567891011121314151617//çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ TreeNode&lt;K,V&gt; root;//é“¾è¡¨çš„å¤´èŠ‚ç‚¹volatile TreeNode&lt;K,V&gt; first;//ç­‰å¾…è€…çº¿ç¨‹ï¼ˆå½“å‰lockStateæ˜¯è¯»é”çŠ¶æ€ï¼‰volatile Thread waiter;/** * 1.å†™é”çŠ¶æ€ å†™æ˜¯ç‹¬å çŠ¶æ€ï¼Œä»¥æ•£åˆ—è¡¨æ¥çœ‹ï¼ŒçœŸæ­£è¿›å…¥åˆ°TreeBinä¸­çš„å†™çº¿ç¨‹ åŒä¸€æ—¶åˆ» åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚ 1 * 2.è¯»é”çŠ¶æ€ è¯»é”æ˜¯å…±äº«ï¼ŒåŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¿›å…¥åˆ° TreeBinå¯¹è±¡ä¸­è·å–æ•°æ®ã€‚ æ¯ä¸€ä¸ªçº¿ç¨‹ éƒ½ä¼šç»™ lockStat + 4 * 3.ç­‰å¾…è€…çŠ¶æ€ï¼ˆå†™çº¿ç¨‹åœ¨ç­‰å¾…ï¼‰ï¼Œå½“TreeBinä¸­æœ‰è¯»çº¿ç¨‹ç›®å‰æ­£åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå†™çº¿ç¨‹æ— æ³•ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆå°±å°†lockStateçš„æœ€ä½2ä½ è®¾ç½®ä¸º 0b 10 */volatile int lockState;// values for lockStatestatic final int WRITER = 1; // set while holding write lockstatic final int WAITER = 2; // set when waiting for write lockstatic final int READER = 4; // increment value for setting read lock ##13.2 æ„é€ å™¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586TreeBin(TreeNode&lt;K,V&gt; b) &#123; //è®¾ç½®èŠ‚ç‚¹hashä¸º-2 è¡¨ç¤ºæ­¤èŠ‚ç‚¹æ˜¯TreeBinèŠ‚ç‚¹ super(TREEBIN, null, null, null); //ä½¿ç”¨first å¼•ç”¨ treeNodeé“¾è¡¨ this.first = b; //r çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹å¼•ç”¨ TreeNode&lt;K,V&gt; r = null; //xè¡¨ç¤ºéå†çš„å½“å‰èŠ‚ç‚¹ for (TreeNode&lt;K,V&gt; x = b, next; x != null; x = next) &#123; next = (TreeNode&lt;K,V&gt;)x.next; //å¼ºåˆ¶è®¾ç½®å½“å‰æ’å…¥èŠ‚ç‚¹çš„å·¦å³å­æ ‘ä¸ºnull x.left = x.right = null; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¢é»‘æ ‘ æ˜¯ä¸€ä¸ªç©ºæ ‘ï¼Œé‚£ä¹ˆè®¾ç½®æ’å…¥å…ƒç´  ä¸ºæ ¹èŠ‚ç‚¹ if (r == null) &#123; //æ ¹èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸€å®šä¸º null x.parent = null; //é¢œè‰²æ”¹ä¸ºé»‘è‰² x.red = false; //è®©rå¼•ç”¨xæ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚ r = x; &#125; else &#123; //éç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œéƒ½ä¼šæ¥å¸¦elseåˆ†æ”¯ï¼Œæ­¤æ—¶çº¢é»‘æ ‘å·²ç»æœ‰æ•°æ®äº† //k è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„key K k = x.key; //h è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„hash int h = x.hash; //kc è¡¨ç¤º æ’å…¥èŠ‚ç‚¹keyçš„classç±»å‹ Class&lt;?&gt; kc = null; //p è¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; p = r; for (;;) &#123; //dir (-1, 1) //-1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼å¤§äº å½“å‰pèŠ‚ç‚¹çš„hash //1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰pèŠ‚ç‚¹çš„hash //ph pè¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹çš„hash int dir, ph; //ä¸´æ—¶èŠ‚ç‚¹ key K pk = p.key; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰èŠ‚ç‚¹ if ((ph = p.hash) &gt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å·¦å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = -1; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å¤§äº å½“å‰èŠ‚ç‚¹ else if (ph &lt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å³å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = 1; //å¦‚æœæ‰§è¡Œåˆ° CASE3ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„hash ä¸ å½“å‰èŠ‚ç‚¹çš„hashä¸€è‡´ï¼Œä¼šåœ¨case3 åšå‡ºæœ€ç»ˆæ’åºã€‚æœ€ç»ˆ //æ‹¿åˆ°çš„dir ä¸€å®šä¸æ˜¯0ï¼Œï¼ˆ-1ï¼Œ 1ï¼‰ else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) dir = tieBreakOrder(k, pk); //xp æƒ³è¦è¡¨ç¤ºçš„æ˜¯ æ’å…¥èŠ‚ç‚¹çš„ çˆ¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; xp = p; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰pèŠ‚ç‚¹ å³ä¸ºæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ //æ¡ä»¶ä¸æˆç«‹ï¼šè¯´æ˜pèŠ‚ç‚¹ åº•ä¸‹è¿˜æœ‰å±‚æ¬¡ï¼Œéœ€è¦å°†pæŒ‡å‘ pçš„å·¦å­èŠ‚ç‚¹ æˆ–è€… å³å­èŠ‚ç‚¹ï¼Œè¡¨ç¤ºç»§ç»­å‘ä¸‹æœç´¢ã€‚ if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //è®¾ç½®æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸º å½“å‰èŠ‚ç‚¹ x.parent = xp; //å°äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ if (dir &lt;= 0) xp.left = x; //å¤§äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ else xp.right = x; //æ’å…¥èŠ‚ç‚¹åï¼Œçº¢é»‘æ ‘æ€§è´¨ å¯èƒ½ä¼šè¢«ç ´åï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨ å¹³è¡¡æ–¹æ³• r = balanceInsertion(r, x); break; &#125; &#125; &#125; &#125; //å°†r èµ‹å€¼ç»™ TreeBinå¯¹è±¡çš„ rootå¼•ç”¨ã€‚ this.root = r; assert checkInvariants(root);&#125; ##13.3 putTreeVal 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970final TreeNode&lt;K,V&gt; putTreeVal(int h, K k, V v) &#123; Class&lt;?&gt; kc = null; boolean searched = false; for (TreeNode&lt;K,V&gt; p = root;;) &#123; int dir, ph; K pk; if (p == null) &#123; first = root = new TreeNode&lt;K,V&gt;(h, k, v, null, null); break; &#125; else if ((ph = p.hash) &gt; h) dir = -1; else if (ph &lt; h) dir = 1; else if ((pk = p.key) == k || (pk != null &amp;&amp; k.equals(pk))) return p; else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) &#123; if (!searched) &#123; TreeNode&lt;K,V&gt; q, ch; searched = true; if (((ch = p.left) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null) || ((ch = p.right) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null)) return q; &#125; dir = tieBreakOrder(k, pk); &#125; TreeNode&lt;K,V&gt; xp = p; if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹xp å³ä¸º x èŠ‚ç‚¹çš„çˆ¸çˆ¸ //x è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹ //f è€çš„å¤´ç»“ç‚¹ TreeNode&lt;K,V&gt; x, f = first; first = x = new TreeNode&lt;K,V&gt;(h, k, v, f, xp); //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜é“¾è¡¨æœ‰æ•°æ® if (f != null) //è®¾ç½®è€çš„å¤´ç»“ç‚¹çš„å‰ç½®å¼•ç”¨ä¸º å½“å‰çš„å¤´ç»“ç‚¹ã€‚ f.prev = x; if (dir &lt;= 0) xp.left = x; else xp.right = x; if (!xp.red) x.red = true; else &#123; //è¡¨ç¤º å½“å‰æ–°æ’å…¥èŠ‚ç‚¹åï¼Œæ–°æ’å…¥èŠ‚ç‚¹ ä¸ çˆ¶èŠ‚ç‚¹ å½¢æˆ â€œçº¢çº¢ç›¸è¿â€ lockRoot(); try &#123; //å¹³è¡¡çº¢é»‘æ ‘ï¼Œä½¿å…¶å†æ¬¡ç¬¦åˆè§„èŒƒã€‚ root = balanceInsertion(root, x); &#125; finally &#123; unlockRoot(); &#125; &#125; break; &#125; &#125; assert checkInvariants(root); return null;&#125; ##13.4 find 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748final Node&lt;K,V&gt; find(int h, Object k) &#123; if (k != null) &#123; //e è¡¨ç¤ºå¾ªç¯è¿­ä»£çš„å½“å‰èŠ‚ç‚¹ è¿­ä»£çš„æ˜¯firstå¼•ç”¨çš„é“¾è¡¨ for (Node&lt;K,V&gt; e = first; e != null; ) &#123; //s ä¿å­˜çš„æ˜¯lockä¸´æ—¶çŠ¶æ€ //ek é“¾è¡¨å½“å‰èŠ‚ç‚¹ çš„key int s; K ek; //(WAITER|WRITER) =&gt; 0010 | 0001 =&gt; 0011 //lockState &amp; 0011 != 0 æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰TreeBin æœ‰ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… ç›®å‰æœ‰å†™æ“ä½œçº¿ç¨‹æ­£åœ¨åŠ é” if (((s = lockState) &amp; (WAITER|WRITER)) != 0) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek)))) return e; e = e.next; &#125; //å‰ç½®æ¡ä»¶ï¼šå½“å‰TreeBinä¸­ ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… å†™çº¿ç¨‹ éƒ½æ²¡æœ‰ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ·»åŠ è¯»é”æˆåŠŸ else if (U.compareAndSwapInt(this, LOCKSTATE, s, s + READER)) &#123; TreeNode&lt;K,V&gt; r, p; try &#123; //æŸ¥è¯¢æ“ä½œ p = ((r = root) == null ? null : r.findTreeNode(h, k, null)); &#125; finally &#123; //w è¡¨ç¤ºç­‰å¾…è€…çº¿ç¨‹ Thread w; //U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) //1.å½“å‰çº¿ç¨‹æŸ¥è¯¢çº¢é»‘æ ‘ç»“æŸï¼Œé‡Šæ”¾å½“å‰çº¿ç¨‹çš„è¯»é” å°±æ˜¯è®© lockstate å€¼ - 4 //(READER|WAITER) = 0110 =&gt; è¡¨ç¤ºå½“å‰åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»ï¼Œä¸”â€œæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…â€ //å½“å‰è¯»çº¿ç¨‹ä¸º TreeBinä¸­çš„æœ€åä¸€ä¸ªè¯»çº¿ç¨‹ã€‚ //2.(w = waiter) != null è¯´æ˜æœ‰ä¸€ä¸ªå†™çº¿ç¨‹åœ¨ç­‰å¾…è¯»æ“ä½œå…¨éƒ¨ç»“æŸã€‚ if (U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) &amp;&amp; (w = waiter) != null) //ä½¿ç”¨unpark è®© å†™çº¿ç¨‹ æ¢å¤è¿è¡ŒçŠ¶æ€ã€‚ LockSupport.unpark(w); &#125; return p; &#125; &#125; &#125; return null;&#125; #æ€»ç»“åœ¨java8ä¸­ï¼ŒConcurrentHashMapä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„ç»„åˆæ–¹å¼ï¼Œåˆ©ç”¨caså’Œsynchronizedä¿è¯å¹¶å‘å†™çš„å®‰å…¨ã€‚ å¼•å…¥çº¢é»‘æ ‘çš„åŸå› ï¼šé“¾è¡¨æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸ºOnï¼Œä½†æ˜¯çº¢é»‘æ ‘çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸ºO(log(n)),æ‰€ä»¥åœ¨èŠ‚ç‚¹æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¢é»‘æ ‘å¯ä»¥å¤§å¤§æå‡æ€§èƒ½ã€‚ é“¾å¼æ¡¶æ˜¯ä¸€ä¸ªç”±nodeèŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨ã€‚æ ‘çŠ¶æ¡¶æ˜¯ä¸€é¢—ç”±TreeNodeèŠ‚ç‚¹ç»„æˆçš„çº¢é»‘æ ‘ã€‚è¾“çš„æ ¹èŠ‚ç‚¹ä¸ºTreeBinç±»å‹ã€‚ å½“é“¾è¡¨é•¿åº¦å¤§äº8æ•´ä¸ªhashè¡¨é•¿åº¦å¤§äº64çš„æ—¶å€™ï¼Œå°±ä¼šè½¬åŒ–ä¸ºTreeBinã€‚TreeBinä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œå…¶å®å°±æ˜¯çº¢é»‘æ ‘å¯¹è±¡ã€‚åœ¨ConcurrentHashMapçš„tableæ•°ç»„ä¸­ï¼Œå­˜æ”¾çš„å°±æ˜¯TreeBinå¯¹è±¡ï¼Œè€Œä¸æ˜¯TreeNoeå¯¹è±¡ã€‚ æ•°ç»„tableæ˜¯æ‡’åŠ è½½çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ï¼Œæ‰€ä»¥initTable()å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ é‡è¦çš„å±æ€§å°±æ˜¯sizeCtlï¼Œç”¨æ¥æ§åˆ¶tableçš„åˆå§‹åŒ–å’Œæ‰©å®¹æ“ä½œçš„è¿‡ç¨‹ï¼š â— -1ä»£è¡¨tableæ­£åœ¨åˆå§‹åŒ–ï¼Œå…¶ä»–çº¿ç¨‹ç›´æ¥joinç­‰å¾…ã€‚ â— -Nä»£è¡¨æœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œä¸¥æ ¼æ¥è¯´ï¼Œå½“å…¶ä¸ºè´Ÿæ•°çš„æ—¶å€™ï¼Œåªç”¨åˆ°äº†ä½16ä½ï¼Œå¦‚æœä½16ä½ä¸ºMï¼Œæ­¤æ—¶æœ‰M-1ä¸ªçº¿ç¨‹è¿›è¡Œæ‰©å®¹ã€‚ â— å¤§äº0æœ‰ä¸¤ç§æƒ…å†µï¼šå¦‚æœtableæ²¡æœ‰åˆå§‹åŒ–ï¼Œå¥¹å°±è¡¨ç¤ºtableåˆå§‹åŒ–çš„å¤§å°ï¼Œå¦‚æœtableåˆå§‹åŒ–å®Œäº†ï¼Œå°±è¡¨ç¤ºtableçš„å®¹é‡ï¼Œé»˜è®¤æ˜¯tableå¤§å°çš„å››åˆ†ä¹‹ä¸‰ã€‚ Transfer()æ‰©å®¹ tableæ•°æ®è½¬ç§»åˆ°nextTableã€‚æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼ŒæŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ConcurrentHashMapç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒæŠŠtableæ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹æ‰€è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„ Bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰Bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚ helpTransfer()å¸®åŠ©æ‰©å®¹ ConcurrentHashMapå¹¶å‘æ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœæ­£åœ¨æ‰©å®¹ï¼Œå…¶ä»–çº¿ç¨‹ä¼šå¸®åŠ©æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å¤šçº¿ç¨‹æ‰©å®¹ã€‚ ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œé»˜è®¤åˆå§‹é•¿åº¦ä¸º16ï¼Œå½“å¾€tableä¸­ç»§ç»­æ·»åŠ å…ƒç´ æ—¶ï¼Œé€šè¿‡Hashå€¼è·Ÿæ•°ç»„é•¿åº¦å–ä½™æ¥å†³å®šæ”¾åœ¨æ•°ç»„çš„å“ªä¸ªBucketä½ç½®ï¼Œå¦‚æœå‡ºç°æ”¾åœ¨åŒä¸€ä¸ªä½ç½®ï¼Œå°±ä¼˜å…ˆä»¥é“¾è¡¨çš„å½¢å¼å­˜æ”¾ï¼Œåœ¨åŒä¸€ä¸ªä½ç½®çš„ä¸ªæ•°è¾¾åˆ°äº†8ä¸ªä»¥ä¸Šï¼Œå¦‚æœæ•°ç»„çš„é•¿åº¦è¿˜å°äº64ï¼Œå°±ä¼šæ‰©å®¹æ•°ç»„ã€‚å¦‚æœæ•°ç»„çš„é•¿åº¦å¤§äºç­‰äº64ï¼Œå°±ä¼šå°†è¯¥èŠ‚ç‚¹çš„é“¾è¡¨è½¬æ¢æˆæ ‘ã€‚ é€šè¿‡æ‰©å®¹æ•°ç»„çš„æ–¹å¼æ¥æŠŠè¿™äº›èŠ‚ç‚¹åˆ†æ•£å¼€ã€‚ç„¶åå°†è¿™äº›å…ƒç´ å¤åˆ¶åˆ°æ‰©å®¹åçš„æ–°æ•°ç»„ä¸­ï¼ŒåŒä¸€ä¸ªBucketä¸­çš„å…ƒç´ é€šè¿‡Hashå€¼çš„æ•°ç»„é•¿åº¦ä½æ¥é‡æ–°ç¡®å®šä½ç½®ï¼Œå¯èƒ½è¿˜æ˜¯æ”¾åœ¨åŸæ¥çš„ä½ç½®ï¼Œä¹Ÿå¯èƒ½æ”¾åˆ°æ–°çš„ä½ç½®ã€‚è€Œä¸”ï¼Œåœ¨æ‰©å®¹å®Œæˆä¹‹åï¼Œå¦‚æœä¹‹å‰æŸä¸ªèŠ‚ç‚¹æ˜¯æ ‘ï¼Œä½†æ˜¯ç°åœ¨è¯¥èŠ‚ç‚¹çš„â€œKey-Valueå¯¹â€æ•°åˆå°äºç­‰äº6ä¸ªï¼Œå°±ä¼šå°†è¯¥æ ‘è½¬ä¸ºé“¾è¡¨ã€‚ put() JDK1.8åœ¨ä½¿ç”¨CASè‡ªæ—‹å®Œæˆæ¡¶çš„è®¾ç½®æ—¶ï¼Œä½¿ç”¨synchronizedå†…ç½®é”ä¿è¯æ¡¶å†…å¹¶å‘æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚å°½ç®¡å¯¹åŒä¸€ä¸ªMapæ“ä½œçš„çº¿ç¨‹äº‰ç”¨ä¼šéå¸¸æ¿€çƒˆï¼Œä½†æ˜¯åœ¨åŒä¸€ä¸ªæ¡¶å†…çš„çº¿ç¨‹äº‰ç”¨é€šå¸¸ä¸ä¼šå¾ˆæ¿€çƒˆï¼Œæ‰€ä»¥ä½¿ç”¨CASè‡ªæ—‹ã€synchronizedä¸ä¼šé™ä½ConcurrentHashMapçš„æ€§èƒ½ã€‚ä¸ºä»€ä¹ˆä¸ç”¨ReentrantLockæ˜¾å¼é”å‘¢?å¦‚æœä¸ºæ¯ ä¸ªæ¡¶éƒ½åˆ›å»ºä¸€ä¸ªReentrantLockå® ä¾‹ï¼Œå°±ä¼šå¸¦æ¥å¤§é‡çš„å†…å­˜æ¶ˆè€—ï¼Œåè¿‡æ¥ï¼Œä½¿ç”¨CASè‡ªæ—‹ã€synchronizedï¼Œå†…å­˜æ¶ˆè€—çš„å¢åŠ æ›´å°ã€‚ get() get()é€šè¿‡UnSafeçš„getObjectVolatile()æ¥è¯»å–æ•°ç»„ä¸­çš„å…ƒç´ ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·åš?è™½ç„¶HashEntryæ•°ç»„çš„å¼•ç”¨æ˜¯volatileç±»å‹ï¼Œä½†æ˜¯æ•°ç»„å†…å…ƒç´ çš„ ç”¨ä¸æ˜¯volatileç±»å‹ï¼Œå› æ­¤å¤šçº¿ç¨‹å¯¹ æ•°ç»„å…ƒç´ çš„ä¿®æ”¹æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šåœ¨æ•°ç»„ä¸­è¯»å–åˆ°å°šæœªæ„é€ å®Œæˆçš„å…ƒç´ å¯¹è±¡ã€‚get()æ–¹æ³•é€šè¿‡UnSafeçš„getObjectVolatileæ–¹æ³•æ¥ä¿è¯å…ƒç´ çš„è¯»å–å®‰å…¨ï¼Œè°ƒç”¨getObjectVolatile()å»è¯»å–æ•°ç»„å…ƒç´ éœ€è¦å…ˆè·å¾—å…ƒç´ åœ¨æ•°ç»„ä¸­çš„åç§»é‡ï¼Œåœ¨è¿™é‡Œï¼Œget()æ–¹æ³•æ ¹æ®å“ˆå¸Œç è®¡ç®—å‡ºåç§»é‡ä¸ºuï¼Œç„¶åé€šè¿‡åç§»é‡uæ¥å°è¯•è¯»å–æ•°å€¼ã€‚","categories":[{"name":"1.åŸºç¡€çŸ¥è¯†","slug":"1-åŸºç¡€çŸ¥è¯†","permalink":"https://yinhuidong.github.io/categories/1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"é›†åˆæºç åˆ†æ","slug":"é›†åˆæºç åˆ†æ","permalink":"https://yinhuidong.github.io/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"}]}],"categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/categories/MySQL/"},{"name":"1.åŸºç¡€çŸ¥è¯†","slug":"1-åŸºç¡€çŸ¥è¯†","permalink":"https://yinhuidong.github.io/categories/1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://yinhuidong.github.io/tags/MySQL/"},{"name":"é›†åˆæºç åˆ†æ","slug":"é›†åˆæºç åˆ†æ","permalink":"https://yinhuidong.github.io/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"}]}